---
output:
  md_document:
    variant: markdown_github
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

[![Build Status](https://travis-ci.org/boennecd/dynamichazard.svg?branch=master,osx)](https://travis-ci.org/boennecd/dynamichazard)
# dynamichazard

The goal of dynamichazard is to [TO BE WRITTEN]

## Installation

You can install dynamichazard from github with:

```R
# install.packages("devtools")
devtools::install_github("dynamichazard/boennecd")
```

## Example

This is a basic example which shows you how to solve a common problem: [TO BE WRITTEN]

```{r}
# See https://archive.ics.uci.edu/ml/machine-learning-databases/pima-indians-diabetes

# We download the data
diabetes <-
  read.table("https://archive.ics.uci.edu/ml/machine-learning-databases/pima-indians-diabetes/pima-indians-diabetes.data",
             sep = ",")
colnames(diabetes) <-
  c("times_pregnant", "glucose_cocen", "blood_pres", "skin_fold",
    "insulin", "BMI", "diabetes_pedigree", "age", "has_diabetes")

head(diabetes)
nrow(diabetes) # Number of samples before cleaning

# Remove observations with invalid values
diabetes <- diabetes[diabetes$BMI > 0, ]
diabetes <- diabetes[diabetes$blood_pres > 0, ]
diabetes <- diabetes[diabetes$skin_fold > 0, ]
diabetes$has_diabetes[diabetes$insulin >= 200]

nrow(diabetes) # Number of samples after cleaning



# We load the two libraries we will need
library(survival); library(dynamichazard)
min(diabetes$age)                             # Youngest person in study
max(diabetes$age)                             # Oldest person in study
max(diabetes$age[diabetes$has_diabetes == 1]) # Last person who get diagnosed
                                              # with diabetes

# Notice that we have few cases and control in the end as illustrated below
diabetes$t <- diabetes$age - min(diabetes$age) + 1 # Time scale in study
xtabs(~ has_diabetes + t, diabetes)

# Thus, we set the last time (max_T) slighly lower later
# Fit the model
fit <- ddhazard(
  Surv(t, has_diabetes) ~
    ddFixed(1) +                        # These effects are time invariant
    ddFixed(diabetes_pedigree) +
    glucose_cocen + blood_pres +        # The others are time-varying
    skin_fold + BMI + times_pregnant
    ,
  data = diabetes,
  by = 1,                               # time interval lengths
  max_T = 42,                           # last period we observe
  Q_0 = diag(1e5, 5), Q = diag(1e-4, 5) # Covariances mats for state equation
  )

# Plot the effects estimates with 95% point-wise confidence bounds
plot(fit)

# Print time invariant estimates
fit$fixed_effects

# Bootstrap the estimates
boot_out <- ddhazard_boot(fit, R = 1e2) # R is number of bootstrap samples

# Plot bootstrapped estimates (transparent lines) and 2.5% and 97.5% quantiles
# (dashed-lines)
plot(fit, ddhazard_boot = boot_out)

# Make boxplot for the bootstrap estimate of the fixed effect
boxplot(t(tail(t(boot_out$t), 2)))
```
