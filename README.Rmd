---
output:
  md_document:
    variant: markdown_github
bibliography: README.bib
csl: vignettes/bib_style.csl
---

```{r setup, echo = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-",
  dpi = 124
)
```

[![Build Status on Travis](https://travis-ci.org/boennecd/dynamichazard.svg?branch=master,osx)](https://travis-ci.org/boennecd/dynamichazard)
[![](https://www.r-pkg.org/badges/version/dynamichazard)](https://www.r-pkg.org/badges/version/dynamichazard)		
[![CRAN RStudio mirror downloads](http://cranlogs.r-pkg.org/badges/dynamichazard)](http://cran.rstudio.com/web/packages/dynamichazard/index.html)

# dynamichazard

The goal of dynamichazard is to estimate time-varying effects in survival analysis. The time-varying effects are estimated with state space models where the coefficients follow a given order random walk. The advantageous of using state space models is that you can extrapolate beyond the last observed time period.

The estimation methods are implemented such: 

* They have linear time complexity in both time and the number of observations.
* Computation is done in `c++` using `BLAS` and `LAPACK`.
* Use a `coxph` like formula from the survival package. Therefore, the methods are easily applied to panel datasets.
* Allows for time-varying covariates.

For more details, see the ddhazard vignette at https://cran.r-project.org/web/packages/dynamichazard/vignettes/ddhazard.pdf

## Installation

You can install dynamichazard from github with:

```R
install.packages("devtools")
devtools::install_github("dynamichazard/boennecd")
```

You can also download the package from CRAN by calling:

```R
installed.packages("dynamichazard")
```

## Example - ddhazard
I will use the `aids` data set from the `JMbayes` package. The data set is from a a randomized clinical trial between two drugs for HIV or aids patients. The event is when the patient die. Patient are right censored at the end of the study. The data set is longitudinal/panel format with rows for patient. Though, the only longitudinal variable is the `CD4` count (T-cells count) which is presumably affected by the drug. Thus, I will not use it in the model. The other the other columns of interest are:

* `AZT` is one of the two enrolment criteria. It indicates whether the patient was enrolled due to intolerance to the drug zidovudine or whether the drug failed prior to the study start.
* `prevOI` is the other enrolment criteria. Patients are enrolled either due  AIDS diagnosis or two CD4 counts of 300 or fewer. The variable indicates which is the case.
* `drug` is either `ddC` or `ddI` depending on which of the two drugs the patient is randomly assigned to.
* `gender`.

The analysis is given below with comments:

```{r ddhazard_fit, cache = TRUE}
library(dynamichazard)
library(survival)
library(JMbayes) # Contain the aids data set

# We remove the data we dont neeed
aids <- aids[aids$Time == aids$stop, ]
aids <- aids[, !colnames(aids) %in% c("Time", "death", "obstime", "CD4")]

# A look at head of data
head(aids)
max(aids$stop)                  # Last observation time
max(aids$stop[aids$event == 1]) # Last person with event

# Fit model with extended Kalman filter
fit <- ddhazard(
  Surv(stop, event) ~ AZT + gender + drug + prevOI,
  aids,
  model = "exponential",          # piecewise constant exponentially distributed 
                                  # arrivals times
  by = .5,                        # Length of time intervals in state space 
                                  # model
  max_T = 19,                     # Last period we observe when modeling
  Q = diag(.01, 5),               # Covariance matrix for state equation in 
                                  # first iteration
  Q_0 = diag(10, 5),              # Covariance matrix for the prior
  control = list(
    eps = .001,                   # tolerance for EM-algorithm
    NR_eps = 1e-5,                # Use more iteration of the EKF
    LR = .5,                      # Learning rate
    n_max = 20                    # Max number iterations in EM
    ))

# Plot the estimates. Dashed lines are 95% confidence bounds
plot(fit)

# Bootstrap the estimates
boot_out <- ddhazard_boot(fit, R = 1000) # R is number of bootstrap samples

# Plot bootstrap estimates. Dashed lines are 2.5% and 97.5% quantiles of the 
# bootstrap estimates. Transparent lines are bootstrap estimates
plot(fit, ddhazard_boot = boot_out)
```

Bootstrapping only slightly changes the confidence bounds. It seems that:

* It is hard to tell the difference between the two drugs. The `ddi` may be more effective in the latter period (the estimates is negative) though the point-wise confidence bounds still contains 0. Further, this comment neglect that the confidence bounds are point-wise.
* Having aids rather than being enrolled (only) due to two CD4 counts of 300 or fewer is associated with an increased risk of dying.
* Males seems to be at lower risk in the first period.

An example of a paper analyzing the CD4 count can be found in [@guo2004]. They also fit a static model (time-invariant coefficients) of the survival times with an exponential model. The estimates are comparable with those above as expected.

## Example - particle filter and smoother
A particle filter and smoother is also included in the package. The computational complexity of these methods match those of the extended Kalman filter but with a much larger constant. Below, I fit a model for the `aids` data.

```{r pf_fit, cache=TRUE}
options(ddhazard_max_threads = 7) # I am on a 8 core machine

set.seed(20170907)
pf_fit <- PF_EM(
  Surv(stop, event) ~ AZT + gender + drug + prevOI,
  aids,
  model = "exponential",
  by = .5,  
  max_T = 19,
  Q = diag(.01, 5),
  Q_0 = diag(1, 5),
  control = PF_control(
    # set number of particles
    N_fw_n_bw = 1000, 
    N_first = 10000,
    N_smooth = 1, # Does not matter with Brier_O_N_square
    
    smoother = "Brier_O_N_square", # Select smoother
    
    eps = .001, 
    n_max = 20)
  #, trace = 1 # comment back to get feedback during estimation
  )

# Compare estimates of Q
pf_fit$Q
fit$Q

# Look at coefficients. Crosses are 2.5%, 50% and 97.5% quantiles. The curves
# are mean estimates
par(mfcol = c(2, 3))
for(i in 1:5)
  plot(pf_fit, cov_index = i)
```


For more details, see the "Particle filters in the dynamichazard package" vignette at https://cran.r-project.org/web/packages/dynamichazard/vignettes/Particle_filtering.pdf

# References
