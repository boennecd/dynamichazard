if(interactive()){
  library(dynamichazard); library(testthat); library(survival); source("R/test_utils.R")
}

test_that("UKF on head_neck works with logit model", {
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3,
                   method = "UKF", save_data = F, save_risk_set = F,
                   beta = 0),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "logit"
  ))
  # sink()
  # close(tmp)
  # matplot(result$state_vecs, type = "l")
  # get_expect_equal(result, file = "tmp.txt")

  expect_equal(c(result$state_vecs),
               c(-3.25347027308416026, -3.25348518175704404, -3.07342297817660404, -2.87982776868289525, -2.71347411931766302, -2.50760195207121583, -2.55500433010638028, -2.76551303378312863, -2.91591789772243404, -3.03593361486824076, -3.15363581560333550, -3.29563166961682663, -3.39498160370249646, -3.46082875960332847, -3.44894126638617138, -3.50314447916955096, -3.58489014221007407, -3.65715012061161060, -3.67623578540701290, -3.73929106974020131, -3.76086648729047113, -3.83675699388854863, -3.92950260901732040, -3.99630802914913863, -4.03781317499296399, -4.10386467010477496, -4.14807220495404927, -4.17192273805562674, -4.22527834757904230, -4.26052602151125193, -4.27802923398206314, 0.28314467098939328,  0.28341711307973327, 0.37231662657832926, 0.47912596350538245, 0.51602204998918177,  0.64273401925061979, 0.63026427351929037, 0.52474837435392385, 0.51660691233764056,  0.48497461421975291, 0.44557013767825299, 0.38202020930963870, 0.35860362561966602,  0.37128814204774874, 0.42253124791109881, 0.38636811791189363, 0.33625567805297429,  0.30787397938688410, 0.30322634897375350, 0.27662974349485103, 0.26821424113066467,  0.19384419558199328, 0.12717072340937846, 0.06995745919561791, 0.02200997013820158, -0.02030313271789833, -0.05434553665424643, -0.08041946043353154, -0.10214595586876887, -0.11640223558698601, -0.12343561176512610 ))

  expect_equal(c(result$state_vars),
               c( 0.27890208706433761, -0.05674156087237262, -0.05674156087237259, 0.30832244411997733,  0.22907299456629920, -0.07054986372374671, -0.07054986372374669, 0.27281079366263078,  0.20641927751791855, -0.07481194932541189, -0.07481194932541189, 0.25355941739814719,  0.18621898446389673, -0.07797694223094721, -0.07797694223094723, 0.23403545031696382,  0.16782540488486974, -0.08111400955125457, -0.08111400955125456, 0.21474190508687119,  0.15347409943388154, -0.08040908532391380, -0.08040908532391378, 0.20196408405772731,  0.13887630710897608, -0.08218133993631316, -0.08218133993631313, 0.19022973235333143,  0.13720994008460005, -0.08134139863658270, -0.08134139863658267, 0.19057442838481059,  0.14511195485474510, -0.07927919920623706, -0.07927919920623702, 0.20053080305009252,  0.15492898903389471, -0.07945276548812980, -0.07945276548812974, 0.21318379315542910,  0.16534886594288800, -0.08065363640363740, -0.08065363640363735, 0.22812110198457958,  0.17671794549301001, -0.08207156379098801, -0.08207156379098796, 0.24547295076417719,  0.19001541413007306, -0.08334349853215670, -0.08334349853215665, 0.26517316924176160,  0.20312685844629286, -0.08573171517857962, -0.08573171517857957, 0.28505470966279972,  0.21549765674345600, -0.08948667100691216, -0.08948667100691210, 0.30454815289511317,  0.22445797834457820, -0.09563636483719384, -0.09563636483719379, 0.32217826541330397,  0.23488323874662398, -0.10149027943881546, -0.10149027943881539, 0.34203255134260147,  0.24808539117571130, -0.10685693656866554, -0.10685693656866548, 0.36491936505949918,  0.26334319593569488, -0.11251797532122977, -0.11251797532122970, 0.39006830479438359,  0.27838981854711253, -0.11944922990285778, -0.11944922990285770, 0.41610910024196490,  0.29467115118605319, -0.12699584191360266, -0.12699584191360258, 0.44416036961743827,  0.31053933269322709, -0.13597857163889673, -0.13597857163889665, 0.47321529820671726,  0.33028719138729679, -0.14451877231635799, -0.14451877231635790, 0.50636812571923517,  0.35426420803906411, -0.15247895187164764, -0.15247895187164756, 0.54396888568019186,  0.38164663400653764, -0.16032650243034979, -0.16032650243034971, 0.58528153934548466,  0.41234501120104627, -0.16820885497735891, -0.16820885497735882, 0.62997684651337948,  0.44977788919837536, -0.17531923856312037, -0.17531923856312026, 0.67937378183655850,  0.49349336669744315, -0.18136890512766310, -0.18136890512766299, 0.73334176165057807,  0.54461515495142554, -0.18603072347065033, -0.18603072347065022, 0.79197245887592560,  0.60840476300308555, -0.18777423632839363, -0.18777423632839352, 0.85718857551504468,  0.68686424463453066, -0.18591187992901625, -0.18591187992901614, 0.92918920222214807 ))

  expect_equal(c(result$lag_one_cov),
               c(NULL ))

  expect_equal(c(result$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result$n_iter),
               c(7 ))

  expect_equal(c(result$Q),
               c(0.095369828559475484, 0.007195823231527877, 0.007195823231527877, 0.076434834365142645 ))

  expect_equal(c(result$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result$risk_set),
               c(NULL ))

  expect_equal(c(result$data),
               c(NULL ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$method),
               c("UKF" ))

  expect_equal(c(result$model),
               c("logit" ))

  expect_equal(c(result$est_Q_0),
               c(FALSE ))

  expect_equal(c(result$LR),
               c(1 ))
})


set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$state_vecs, res_old$state_vecs)
  expect_equal(res_new$state_vars, res_old$state_vars)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$state_vecs, res_new_time$state_vecs)
  expect_equal(res$state_vars, res_new_time$state_vars)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2,
                                  save_data = F, save_risk_set = F),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  # matplot(sims$betas, type = "l")
  # matplot(res$state_vecs, add = T, type = "l")
  # get_expect_equal(res, file = "tmp.txt")

  expect_equal(c(res$state_vecs),
               c(-1.82092085034524831, -1.82729795316858490, -1.52843015101533553, -0.91369778530616419, -0.80931154209078215, -0.71970220328478218, -0.82627630867849955, -0.34917207165345704, -0.67073071515865579, -0.35203515774073890, -0.45818136504754303, 1.74685275814275731,  1.70889823546716424, 1.17642034813401453, 1.82522929868875705, 1.08652811518080350,  1.27155083182447659, 1.73397504696440952, 3.80192067969428615, 4.17364636042877990,  3.45275920940089698, 2.10868752410488192, 0.87938631755887708, 0.83568280050013011,  0.16131153751258032, 1.09700488310951050, 0.58265276204107375, 0.55335163311118651,  1.13703759239390223, 2.25264642735934695, 2.06970656973678269, 0.28555646162506110, -1.73614419848997681, 1.49334484101376108, 1.55562608479074105, 1.99478225152721445,  0.15117004282423357, 0.80558935981253699, 0.61614045698793973, 0.04401197711053828, -2.49987472129883948, -2.14632286845168174, -0.75864890044179412, 1.67224250429885668 ))

  expect_equal(c(res$state_vars),
               c( 0.1832550178309723110, 0.0233353149245731743, -0.0320001767098580456, -0.0787052371077972823,  0.0233353149245753531, 0.4932117914625737676, 0.0159274731616371977, -0.2309158724878811464, -0.0320001767098556100, 0.0159274731616370346, 0.4801248604083833138, -0.2584318687087763800, -0.0787052371077913565, -0.2309158724878818680, -0.2584318687087771016, 0.5431939208721094925,  0.1126244723720488672, 0.0908467354812348554, 0.0632669975110951854, -0.1102528799644592050,  0.0908467354812319550, 0.5446703831205768065, 0.1570849847474341809, -0.4605712731706196883,  0.0632669975110922711, 0.1570849847474334038, 0.5273542683750356286, -0.4959500623033006872, -0.1102528799644439672, -0.4605712731706230745, -0.4959500623033057942, 0.8923506826483633692,  0.0807222400054121159, 0.0805044205153931242, 0.0632506595770789271, -0.0743888091748181601,  0.0805044205153901959, 0.5099085783511227987, 0.1964886306379626246, -0.4537069299955319157,  0.0632506595770759433, 0.1964886306379620973, 0.5320714519024762890, -0.5150586661646207043, -0.0743888091748029362, -0.4537069299955351909, -0.5150586661646255893, 0.8470892472010426166,  0.0676680561508966050, 0.0713761983950712831, 0.0695742415170743228, -0.0633478628472181615,  0.0713761983950687295, 0.4087051402737104655, 0.1509155122555868589, -0.3508339597055954440,  0.0695742415170721024, 0.1509155122555937423, 0.3833102531908965660, -0.3824096333028234040, -0.0633478628472038813, -0.3508339597056047698, -0.3824096333028238481, 0.6662247605496338654,  0.0498098359721213940, 0.0303732275708384972, 0.0257716857988383660, 0.0161476111946547499,  0.0303732275708270966, 0.2276928026644160219, 0.0494913924497374161, -0.1294635098705269882,  0.0257716857988291512, 0.0494913924497486710, 0.2307632867646948749, -0.1637715595456765982,  0.0161476111946780784, -0.1294635098705529952, -0.1637715595456846751, 0.2760548490654503029,  0.0519462181903844258, 0.0394756518556704725, 0.0347384498062630401, 0.0025222790318358140,  0.0394756518556586694, 0.2223777584850486766, 0.0560728717256625958, -0.1456977455083329209,  0.0347384498062530342, 0.0560728717256684522, 0.2117365773154165076, -0.1612191636065007927,  0.0025222790318596734, -0.1456977455083553752, -0.1612191636065128386, 0.2926798455607076965,  0.0516588570101625122, 0.0418979783122658683, 0.0346933262266429371, 0.0003691802354863771,  0.0418979783122543914, 0.2425010144281349311, 0.0634897041535592704, -0.1652257252397389686,  0.0346933262266334239, 0.0634897041535678330, 0.2140101105353587330, -0.1674096251083421749,  0.0003691802355100856, -0.1652257252397623666, -0.1674096251083521669, 0.3143530896703636834,  0.0562048010134722428, 0.0475073169624853284, 0.0313282880118159746, -0.0030194223283249860,  0.0475073169624740249, 0.2852846299142142716, 0.0869177069669883895, -0.2053339288549395070,  0.0313282880118069471, 0.0869177069669993252, 0.2758212277191780526, -0.2169507699767647124, -0.0030194223283018327, -0.2053339288549649311, -0.2169507699767733999, 0.3741481110974585467,  0.0591158733559115773, 0.0507750904170524986, 0.0306679856573149126, 0.0034964302162411309,  0.0507750904170409939, 0.3448565521462880201, 0.1203297479543086468, -0.2407269547559788558,  0.0306679856573056145, 0.1203297479543193049, 0.2859616597792459802, -0.2193003187703381762,  0.0034964302162647752, -0.2407269547560041412, -0.2193003187703470580, 0.3535885561441462488,  0.0625795709300176334, 0.0401721644414572560, 0.0224120788342426075, 0.0127773684136726906,  0.0401721644414458762, 0.4179282580049615836, 0.1276412597383520253, -0.2633934560188287977,  0.0224120788342333961, 0.1276412597383627390, 0.3375474509975972537, -0.2482600403344854545,  0.0127773684136963314, -0.2633934560188535556, -0.2482600403344941142, 0.3830954392677380915,  0.0697787525109675177, 0.0677359035523633496, 0.0532560038203183997, -0.0254172057469067292,  0.0677359035523523861, 0.5440019827786575224, 0.1468909444498669448, -0.3763369166836412205,  0.0532560038203095387, 0.1468909444498773809, 0.3817951341443424074, -0.3389358911266535657, -0.0254172057468834978, -0.3763369166836654234, -0.3389358911266615593, 0.5737972516701184134 ))

  expect_equal(c(res$lag_one_cov),
               c(NULL ))

  expect_equal(c(res$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(res$n_iter),
               c(27 ))

  expect_equal(c(res$Q),
               c( 0.13974629841037872, 0.13372538009524551, 0.06423071982379676, -0.28552480233678701,  0.13372538009524551, 1.29646430162645143, 1.01412028487301109, -1.63410250664436973,  0.06423071982379676, 1.01412028487301109, 1.51333762041293474, -1.79836299592134985, -0.28552480233678701, -1.63410250664436973, -1.79836299592134985, 2.63147975990961269 ))

  expect_equal(c(res$Q_0),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$n_risk),
               c(500, 480, 458, 421, 358, 298, 262, 215, 197, 163 ))

  expect_equal(c(res$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(res$risk_set),
               c(NULL ))

  expect_equal(c(res$data),
               c(NULL ))

  expect_equal(c(res$order),
               c(1 ))

  expect_equal(c(res$F_),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$method),
               c("UKF" ))

  expect_equal(c(res$model),
               c("logit" ))

  expect_equal(c(res$est_Q_0),
               c(FALSE ))

  expect_equal(c(res$LR),
               c(1 ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  suppressMessages(m1 <- do.call(ddhazard, arg_list))

  arg_list$control$beta <- 2

  suppressMessages(m2 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m1$state_vecs, m2$state_vecs)) == "character")
  expect_true(class(all.equal(m1$state_vars, m2$state_vars)) == "character")

  arg_list$control$alpha <- .1
  arg_list$control$kappa <- 4 / (.1)^2 + 4

  suppressMessages(m3 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m2$state_vecs, m3$state_vecs)) == "character")
  expect_true(class(all.equal(m2$state_vars, m3$state_vars)) == "character")

  arg_list$control$beta <- 0
  arg_list$control$alpha <- 1
  arg_list$control$kappa <- .5

  suppressMessages(m4 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m3$state_vecs, m4$state_vecs)) == "character")
  expect_true(class(all.equal(m3$state_vars, m4$state_vars)) == "character")
})

arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                 by = 1,
                 data = NULL,
                 Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                 Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                 control = list(kappa = 0, alpha = 1, beta = 0,
                                est_Q_0 = F, method = "UKF", eps = 1e-2),
                 id = NULL,
                 verbose = F,
                 max_T = 10)

set.seed(2972)
sims <- test_sim_func_logit(n_series = 2e3, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -2, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

arg_list$data <- sims$res
arg_list$id <- sims$res$id

arg_list$control$beta <- 0
suppressMessages(fit1 <- do.call(ddhazard, arg_list))

arg_list$control$beta = 2
suppressMessages(fit2 <- do.call(ddhazard, arg_list))

# matplot(sims$betas, type = "l", lty = 1, ylim = range(sims$betas, fit1$state_vecs, fit2$state_vecs))
# matplot(fit1$state_vecs, type = "l", lty = 2, add = T)
# matplot(fit2$state_vecs, type = "l", lty = 4, add = T)

test_that("UKF on head_neck works with exponential model", {
  # Change by argument
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3, beta = 0,
                   method = "UKF", save_data = F, save_risk_set = F),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "exponential"
  ))
  # sink()
  # close(tmp)
  # matplot(result_exp$state_vecs, type = "l")
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-3.269312599750143988, -3.269197862646453956, -3.104885444658833649, -2.928897832218397834, -2.782057810442525980, -2.600837038124587330, -2.654115861702174950, -2.847454705778457829, -2.981849883445724103, -3.091176140108300441, -3.199350881891904752, -3.329694793478519266, -3.420505540924595689, -3.480507771129218053, -3.471404105823772124, -3.523795955733581842, -3.600994068411660809, -3.668895308135079247, -3.689497170656039771, -3.749419441301436784, -3.772574766895772314, -3.845827049305180712, -3.933041749178425750, -3.996837999103710182, -4.037850317540603307, -4.099568557503340926, -4.141532951351009295, -4.165079022896459371, -4.213634580756536074, -4.245715381762500407, -4.261647730119692667, 0.281871889014344068,  0.282058758542807930, 0.353382355278996418, 0.437062600264207846, 0.468134242619716923,  0.563028024259429549, 0.546248180882790590, 0.463049659756999132, 0.453508247442041823,  0.427459578322440636, 0.395509291576195632, 0.345462278202971707, 0.325730899799145934,  0.332630535037540087, 0.368874363141783845, 0.340481270673724024, 0.301036904525137594,  0.277342506400808264, 0.271954345595538771, 0.249437879985356548, 0.240893212683506108,  0.183816885007242192, 0.131975442329176518, 0.087898851198681016, 0.051371492092545712,  0.018307312477981647, -0.008033809711030987, -0.027929708909459713, -0.045435886245177373, -0.056934327724024986, -0.062612603119453478 ))

  expect_equal(c(result_exp$state_vars),
               c( 0.26085750895924154, -0.04890853140028083, -0.04890853140028428, 0.26648051925508087,  0.21445032426265415, -0.06038025985913355, -0.06038025985913752, 0.23693383148101194,  0.19217516942386859, -0.06440992954773039, -0.06440992954773428, 0.21918994652339463,  0.17247164379102148, -0.06757415438992270, -0.06757415438992653, 0.20185318375287414,  0.15466408790633504, -0.07069416089549292, -0.07069416089549667, 0.18520919708344763,  0.14081557400285841, -0.07069708874859204, -0.07069708874859577, 0.17365717316223964,  0.12666538521382312, -0.07278923812593957, -0.07278923812594337, 0.16324983401317034,  0.12494609761356520, -0.07193939018004462, -0.07193939018004845, 0.16311037112511551,  0.13240572540820456, -0.06942672763886309, -0.06942672763886693, 0.17126579761950947,  0.14139592830989656, -0.06891872606063917, -0.06891872606064303, 0.18159178275393506,  0.15083238460557369, -0.06938923020286192, -0.06938923020286580, 0.19380179067983949,  0.16111584640418203, -0.07014862006819750, -0.07014862006820141, 0.20796373326796835,  0.17314722182858935, -0.07088086700457719, -0.07088086700458111, 0.22401951700618439,  0.18495829010270651, -0.07261276617416364, -0.07261276617416756, 0.24043269670630596,  0.19604460238844715, -0.07548292499596848, -0.07548292499597245, 0.25684102333482151,  0.20416241361754267, -0.08023884270998830, -0.08023884270999228, 0.27232240933761487,  0.21357097880543358, -0.08490482947629582, -0.08490482947629981, 0.28939429094835678,  0.22544974600824119, -0.08921772986532955, -0.08921772986533355, 0.30865495516351688,  0.23912413227606161, -0.09370456659300772, -0.09370456659301171, 0.32962578113557178,  0.25267296622140278, -0.09911424507370553, -0.09911424507370953, 0.35141170919170117,  0.26729959924243496, -0.10492265939689237, -0.10492265939689638, 0.37471386919138761,  0.28165661780666307, -0.11172301959173739, -0.11172301959174140, 0.39889081026549744,  0.29949683011135264, -0.11814115971106816, -0.11814115971107217, 0.42580522064100801,  0.32111174488939043, -0.12395980416665067, -0.12395980416665470, 0.45571836387094333,  0.34583731692242620, -0.12953698401938224, -0.12953698401938626, 0.48811197941846429,  0.37364699024510428, -0.13497227899146061, -0.13497227899146461, 0.52274216292928133,  0.40737052807815316, -0.13953557092894636, -0.13953557092895036, 0.56043053593885250,  0.44669256920179001, -0.14301308617251257, -0.14301308617251657, 0.60107085734772270,  0.49260695975120750, -0.14513851269891009, -0.14513851269891409, 0.64468974383336053,  0.54942275884813696, -0.14463396679780513, -0.14463396679780913, 0.69245967470466097,  0.61883997124940404, -0.14097014498807658, -0.14097014498808058, 0.74447772559535697 ))

  expect_equal(c(result_exp$lag_one_cov),
               c(NULL ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(16 ))

  expect_equal(c(result_exp$Q),
               c(0.083690957288656401, 0.007830052950138168, 0.007830052950138168, 0.054804487884793793 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})

test_that("UKF on simulated data works with exponential model", {
  set.seed(9997)
  sims <- test_sim_func_exp(n_series = 1e3, n_vars = 10, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = 0, re_draw = T, beta_start = (1:10 - 5) / 2.5,
                            intercept_start = -5, sds = c(.1, rep(1, 10)))
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
    data = sims$res,
    by = (by_ <- 1),
    Q_0 = diag(1, 11),
    Q = diag(1e-1, 11),
    control = list(est_Q_0 = F, eps = 10^-2, n_max = 10^3, method = "UKF",
                   debug = F, beta = 0, save_data = F, save_risk_set = F),
    max_T = 10,
    id = sims$res$id, order = 1,
    verbose = F,
    model = "exponential"))
  # sink()
  # close(tmp)

  # sum(sims$res$event)
  # diag(result_exp$Q)
  # result_exp$LR
  # matplot(sims$betas, type = "l", lty = 1)
  # matplot(result_exp$state_vecs, type = "l", lty = 2, add = T)
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-5.37308759860788498, -5.37557873693110366, -5.31731179786011765, -5.11956565678470721, -5.08769369388194015, -4.83112368787442659, -4.87919127756330973, -4.72966034651836509, -4.41370547559501514, -4.18101204700410722, -3.75407083714642065, -2.76398259588303530, -2.78127959746593856, -2.79405060725461230, -2.72592964901389623, -2.70670629400499951, -2.50274778954452870, -2.43193708992886570, -2.39938698423352204, -2.46530638417823500, -2.48870328219889503, -2.72128257304443810, 0.76478934161754220, 0.83005232208223623,  0.80430238353695305, 0.59620480733396752, 0.51171115343532025, -0.36866137071273120, -0.48578463889829093, -0.97509292542801274, -1.01248946362705849, -0.75895405178738651,  0.05994728527810933, -0.23506472554026916, -0.28346914431274806, -0.28664081374398553, -0.14490714115119974, -0.10596873281107434, 0.59756559212823201, 0.66837234781933907,  1.07377775579098533, 1.17691677312397358, 0.98199572084791664, 0.40501627998185863, -0.48540960126425658, -0.51094659601047998, -0.42076275132371566, -0.12222786220242537, -0.01234824401921242, 0.59348121251594499, 0.52283438159879492, 0.78855944667738742,  1.08356245430987430, 1.24420782972220589, 1.33487078388374325, 0.70777107853792198,  0.61382565852608617, 0.73252296246627535, 1.07966762225570756, 1.53724023694320544,  2.84197949694232710, 2.91905481576807491, 3.36259704552211680, 2.96218270899232738,  2.63866126174649995, 1.49628540836874357, -0.62100414070312127, -0.46866865730328822, -0.74651771711560977, -1.71586160633638518, -2.35030594348127098, -4.96960390740416802, -5.06228211225687463, -6.08501591922546758, -6.19956179846043920, -6.03077780579114897, -4.96306235148358166, 0.57230715528681231, 0.46287548129045242, 0.68922359622350959,  1.30834487939241506, 1.91618972911073082, 3.49437361832330673, 3.34220148941166162,  3.78034710404216989, 3.38452343535625344, 3.00337903041953691, 1.71539546871966242,  1.16624286480273143, 1.16932056763645909, 1.18316015452420253, 1.46107731528522700,  1.39899168268345941, 1.80771586454077759, 1.92134452357676899, 2.20607418667964028,  2.82662412460092050, 3.23830723927615693, 4.02342559030730484, 2.07932796218975513,  2.17866305322282416, 2.09780210891063579, 1.74213795302138852, 1.23877428529352063, -0.05111685548829714, -0.13134050770944550, -0.51159433840398671, 0.05781244288456444,  0.47196289267228853, 1.75408050625960477, 3.79272976220903102, 3.80160338119554142,  3.88029475505591881, 3.97965101740395477, 4.04473503583908212, 4.01296881676804151,  3.85751345077158847, 3.77453669497875577, 3.79476172009636814, 3.80661187200471307,  3.94445776140256754 ))

  expect_equal(c(result_exp$state_vars),
               c( 1.760467098116870e-01, 1.621502712750398e-02, 1.662514110749777e-02, -4.874656149937594e-03,  6.237036784973121e-02, -3.904251744527936e-02, -5.275791389736404e-02, -1.479144385787382e-02,  8.304492101877563e-02, 2.823172356810001e-02, -1.533332175748432e-02, 1.621502712749939e-02,  2.307874315903526e-01, -2.153433280800895e-02, 3.287302195025234e-03, -3.248647167117403e-03,  1.830806029127379e-02, -1.672872542432637e-02, 9.001489663059359e-03, 9.134370623964761e-04, -2.256661408554916e-02, -1.063966871799226e-02, 1.662514110750079e-02, -2.153433280800964e-02,  2.675434638188894e-01, -8.266569245316206e-02, -4.001002085817016e-03, -5.558402072796090e-02,  8.519343786840748e-02, -4.959717522658273e-02, 2.361672875660071e-02, 5.485121302291378e-02,  2.477778836137947e-02, -4.874656149936597e-03, 3.287302195025025e-03, -8.266569245316246e-02,  2.628601536467708e-01, 1.340289276308430e-02, 3.744089155577307e-02, -7.669744000729545e-02,  2.642545137663262e-02, -1.180880333506781e-03, -2.864633638884080e-02, -2.081122242755955e-02,  6.237036784973510e-02, -3.248647167118069e-03, -4.001002085817198e-03, 1.340289276308399e-02,  2.537483462418453e-01, -3.314605065248197e-03, -8.749883182208253e-02, 1.859327553335851e-02,  7.574260381505464e-02, 2.300657569282449e-02, 2.070470348933327e-02, -3.904251744528078e-02,  1.830806029127414e-02, -5.558402072796171e-02, 3.744089155577308e-02, -3.314605065248313e-03,  2.940018048236995e-01, -1.160545746487441e-01, 1.080588799569887e-01, -4.508215117977147e-02, -1.260543538190015e-01, -1.340474937558148e-02, -5.275791389736501e-02, -1.672872542432670e-02,  8.519343786840688e-02, -7.669744000729561e-02, -8.749883182208254e-02, -1.160545746487443e-01,  4.982616789525670e-01, -1.358217560267387e-01, -9.942428382303506e-02, 9.742866751870607e-02, -2.688479007659250e-03, -1.479144385787571e-02, 9.001489663059442e-03, -4.959717522658249e-02,  2.642545137663238e-02, 1.859327553335812e-02, 1.080588799569890e-01, -1.358217560267385e-01,  3.817532378420325e-01, -5.651032390163625e-02, -1.241508679343898e-01, 2.583454250220073e-02,  8.304492101878420e-02, 9.134370623956173e-04, 2.361672875660058e-02, -1.180880333506716e-03,  7.574260381505424e-02, -4.508215117977127e-02, -9.942428382303510e-02, -5.651032390163616e-02,  3.894580774578923e-01, 7.704467746575946e-02, 6.761443940827110e-04, 2.823172356808969e-02, -2.256661408554727e-02, 5.485121302291337e-02, -2.864633638884055e-02, 2.300657569282361e-02, -1.260543538190016e-01, 9.742866751870635e-02, -1.241508679343898e-01, 7.704467746575865e-02,  3.617493189293656e-01, 1.789289832514498e-02, -1.533332175748519e-02, -1.063966871798828e-02,  2.477778836137955e-02, -2.081122242755991e-02, 2.070470348933354e-02, -1.340474937558204e-02, -2.688479007658718e-03, 2.583454250220053e-02, 6.761443940825123e-04, 1.789289832514318e-02,  2.742429373498462e-01, 1.408882685891389e-01, 1.860047660111536e-02, 1.085747865201751e-02, -2.663399716630772e-03, 5.135230738103193e-02, -3.216293199394335e-02, -3.858931501968450e-02, -1.498225941690113e-02, 6.621408419729774e-02, 2.057405117891572e-02, -2.027615938468005e-02,  1.860047660111065e-02, 2.022995702829520e-01, -2.018161825391162e-02, 4.173461159281394e-03, -1.421712542311274e-04, 1.864354360805014e-02, -2.307610352806323e-02, 1.359842108525088e-02,  3.179889120366002e-03, -2.211080724557946e-02, -5.670233173270200e-03, 1.085747865201878e-02, -2.018161825391197e-02, 2.113589353101682e-01, -6.398402854227028e-02, -2.358218904363815e-03, -4.429205630835992e-02, 7.045543587081390e-02, -4.350150718461791e-02, 2.166974872433041e-02,  5.132453778034476e-02, 1.648501110945836e-02, -2.663399716627803e-03, 4.173461159280928e-03, -6.398402854227064e-02, 2.254127645154890e-01, 1.224198177205739e-02, 3.659721553739461e-02, -7.263714167329334e-02, 3.062014854200852e-02, -4.026391329449198e-03, -3.429389640313450e-02, -1.572895817837644e-02, 5.135230738103845e-02, -1.421712542316895e-04, -2.358218904363631e-03,  1.224198177205663e-02, 2.222067814228263e-01, -4.543883323218076e-03, -7.345820173511601e-02,  1.276435803605952e-02, 6.723742963449275e-02, 1.918742800724764e-02, 1.642989422312012e-02, -3.216293199394173e-02, 1.864354360804981e-02, -4.429205630836029e-02, 3.659721553739442e-02, -4.543883323217521e-03, 2.428746875555535e-01, -9.496990773183539e-02, 9.149494316920226e-02, -4.256359022762134e-02, -1.132663797376141e-01, -9.727879275818384e-03, -3.858931501969334e-02, -2.307610352806319e-02, 7.045543587081249e-02, -7.263714167329276e-02, -7.345820173511645e-02, -9.496990773183528e-02, 4.157243921503458e-01, -1.203160948951922e-01, -6.896703578344429e-02,  1.013530225170945e-01, 6.884441609074123e-04, -1.498225941689948e-02, 1.359842108525038e-02, -4.350150718461707e-02, 3.062014854200798e-02, 1.276435803605975e-02, 9.149494316920280e-02, -1.203160948951925e-01, 3.344668523015434e-01, -5.370106484450630e-02, -1.234098381531267e-01,  1.991033387233195e-02, 6.621408419730980e-02, 3.179889120365563e-03, 2.166974872433068e-02, -4.026391329449656e-03, 6.723742963449199e-02, -4.256359022762221e-02, -6.896703578344344e-02, -5.370106484450717e-02, 3.362633095369965e-01, 7.211302890293168e-02, -3.674301199945787e-03,  2.057405117890069e-02, -2.211080724557651e-02, 5.132453778034355e-02, -3.429389640313416e-02,  1.918742800724463e-02, -1.132663797376137e-01, 1.013530225170971e-01, -1.234098381531263e-01,  7.211302890292720e-02, 3.349545264560009e-01, 1.135676182765903e-02, -2.027615938468126e-02, -5.670233173265565e-03, 1.648501110945813e-02, -1.572895817837671e-02, 1.642989422312013e-02, -9.727879275818477e-03, 6.884441609079205e-04, 1.991033387233224e-02, -3.674301199946706e-03,  1.135676182765658e-02, 2.401494291132161e-01, 1.150586602102509e-01, 1.845414568127320e-02,  6.716709514112842e-03, 2.529054317294442e-04, 4.851427685440176e-02, -2.727977847111671e-02, -4.402760843880209e-02, -1.441441599234778e-02, 6.682612425302564e-02, 1.767331036661897e-02, -2.093497383580941e-02, 1.845414568126801e-02, 1.824779028837052e-01, -2.312868536775384e-02,  6.731025719878150e-03, 3.621335537317289e-04, 2.331090609211153e-02, -2.919629971463598e-02,  1.913301036799751e-02, 7.720165614842440e-04, -2.695513017078635e-02, -6.738865165540148e-03,  6.716709514115836e-03, -2.312868536775424e-02, 1.916608606911883e-01, -6.474948011410761e-02, -8.639121871505942e-03, -5.885834236638381e-02, 9.593232946260165e-02, -6.338724188213662e-02,  1.906560649111820e-02, 6.347839402823253e-02, 1.521578896040703e-02, 2.529054317311243e-04,  6.731025719877709e-03, -6.474948011410811e-02, 2.083940070731601e-01, 1.804391495133041e-02,  5.005783074103743e-02, -9.855087212990452e-02, 4.786679240496659e-02, 1.287699978041472e-03, -4.515855407436178e-02, -1.432577850221888e-02, 4.851427685440805e-02, 3.621335537313827e-04, -8.639121871506275e-03, 1.804391495133000e-02, 2.120571216590300e-01, 7.497187310643694e-03, -1.053894977684223e-01, 2.508397456233243e-02, 8.136783335918453e-02, 1.151047264346299e-02,  1.766495027001030e-02, -2.727977847111690e-02, 2.331090609211110e-02, -5.885834236638408e-02,  5.005783074103701e-02, 7.497187310643786e-03, 2.539387744633624e-01, -1.460525023158258e-01,  1.337523851825272e-01, -4.389243379736538e-02, -1.395954175123983e-01,
                  -6.702605905480240e-03, -4.402760843880824e-02, -2.919629971463632e-02, 9.593232946260113e-02, -9.855087212990447e-02, -1.053894977684222e-01, -1.460525023158268e-01, 5.232055295802154e-01, -1.884789166718744e-01, -1.005284851322273e-01, 1.416678693279645e-01, -5.325691506953105e-03, -1.441441599234829e-02,  1.913301036799701e-02, -6.338724188213571e-02, 4.786679240496580e-02, 2.508397456233197e-02,  1.337523851825279e-01, -1.884789166718733e-01, 3.709903884761780e-01, -5.656986658674620e-02, -1.646270862051284e-01, 2.174760188497525e-02, 6.682612425303810e-02, 7.720165614841712e-04,  1.906560649111741e-02, 1.287699978041911e-03, 8.136783335918388e-02, -4.389243379736535e-02, -1.005284851322281e-01, -5.656986658674581e-02, 3.480338240173612e-01, 8.179206286481991e-02, -4.799745012000756e-04, 1.767331036660616e-02, -2.695513017078343e-02, 6.347839402823133e-02, -4.515855407436117e-02, 1.151047264346071e-02, -1.395954175123982e-01, 1.416678693279656e-01, -1.646270862051278e-01, 8.179206286481695e-02, 3.427894250939090e-01, 9.105301690177977e-03, -2.093497383581001e-02, -6.738865165535408e-03, 1.521578896040685e-02, -1.432577850221912e-02,  1.766495027001059e-02, -6.702605905480372e-03, -5.325691506953145e-03, 2.174760188497558e-02, -4.799745012003150e-04, 9.105301690175451e-03, 2.206705543727359e-01, 9.411941574553886e-02,  1.863003388958400e-02, 4.656916933304588e-03, 4.852255873286000e-04, 4.241690889099676e-02, -2.413349125069105e-02, -3.925852217185718e-02, -1.394942378332719e-02, 5.934626569955553e-02,  1.339279087063758e-02, -2.251820623557738e-02, 1.863003388957892e-02, 1.628466642507044e-01, -2.327869325345218e-02, 7.868940723410741e-03, 5.970464434180700e-04, 2.276166480298747e-02, -2.694645852319398e-02, 1.853887389170326e-02, -3.910525741691985e-04, -2.667641354781657e-02, -7.720479588122074e-03, 4.656916933305373e-03, -2.327869325345236e-02, 1.662042122617400e-01, -6.065985141637510e-02, -9.035132818843510e-03, -5.455246615889228e-02, 8.347728586616371e-02, -5.790409594848602e-02, 1.867917373654076e-02, 5.891944121121030e-02, 1.451777794485207e-02,  4.852255873316597e-04, 7.868940723410090e-03, -6.065985141637543e-02, 1.895506735375181e-01,  1.811703084110441e-02, 5.127195122254687e-02, -9.515847992333631e-02, 4.872084436573217e-02,  8.729929751257123e-04, -4.626599452670856e-02, -1.418036994051872e-02, 4.241690889100370e-02,  5.970464434175860e-04, -9.035132818842682e-03, 1.811703084110339e-02, 1.932015813623493e-01,  1.040796540945994e-02, -1.041162224565297e-01, 2.521263620360585e-02, 7.987137301182776e-02,  8.282877682973911e-03, 1.564612366653399e-02, -2.413349125068848e-02, 2.276166480298658e-02, -5.455246615889302e-02, 5.127195122254678e-02, 1.040796540946137e-02, 2.331655419751282e-01, -1.351486727877015e-01, 1.279139523244973e-01, -4.250254241356212e-02, -1.318354600992602e-01, -4.619088223814712e-03, -3.925852217186790e-02, -2.694645852319367e-02, 8.347728586616168e-02, -9.515847992333556e-02, -1.041162224565312e-01, -1.351486727876997e-01, 4.884378244823270e-01, -1.744332349844527e-01, -1.030531095809956e-01, 1.289421207841130e-01, -5.911769156702763e-03, -1.394942378332445e-02, 1.853887389170230e-02, -5.790409594848546e-02, 4.872084436573158e-02,  2.521263620360691e-02, 1.279139523244981e-01, -1.744332349844546e-01, 3.433795827213665e-01, -5.347750247448340e-02, -1.574552454862962e-01, 2.133965537963484e-02, 5.934626569956803e-02, -3.910525741693920e-04, 1.867917373654228e-02, 8.729929751248745e-04, 7.987137301182648e-02, -4.250254241356467e-02, -1.030531095809921e-01, -5.347750247448595e-02, 3.265178639794990e-01,  7.904250233602131e-02, -8.428636400207804e-04, 1.339279087062180e-02, -2.667641354781342e-02,  5.891944121121014e-02, -4.626599452670865e-02, 8.282877682969987e-03, -1.318354600992608e-01,  1.289421207841179e-01, -1.574552454862964e-01, 7.904250233601559e-02, 3.148064469737489e-01,  6.982753751855045e-03, -2.251820623557783e-02, -7.720479588117314e-03, 1.451777794485243e-02, -1.418036994051930e-02, 1.564612366653419e-02, -4.619088223815390e-03, -5.911769156702024e-03,  2.133965537963456e-02, -8.428636400209313e-04, 6.982753751852970e-03, 2.012354814839785e-01,  7.816399195281737e-02, 1.814331353042880e-02, 4.968183370311829e-03, -1.062263616766653e-03,  3.335751604715205e-02, -2.264099585217993e-02, -2.634663258103545e-02, -1.752530087474190e-02,  4.773274007777643e-02, 9.444859728274534e-03, -2.545061090300334e-02, 1.814331353042325e-02,  1.428288851055759e-01, -1.994766888015796e-02, 5.663654557965200e-03, 3.623049599640730e-04,  1.603357256458801e-02, -1.722468704995275e-02, 1.066896693822099e-02, -3.682417315615041e-05, -1.955628306821412e-02, -8.945758024648351e-03, 4.968183370315310e-03, -1.994766888015826e-02,  1.324783296037217e-01, -4.435777970958788e-02, -4.277979049595992e-03, -3.280925488047619e-02,  4.756265597351103e-02, -3.287977847579141e-02, 1.598914420734633e-02, 3.651485560099357e-02,  1.245890815451587e-02, -1.062263616765451e-03, 5.663654557964569e-03, -4.435777970958835e-02,  1.597028383070649e-01, 1.171719088808331e-02, 3.456252642705671e-02, -6.350932526434497e-02,  2.927681607446465e-02, 6.836080406001834e-04, -2.962111280342015e-02, -1.250924786164031e-02,  3.335751604715795e-02, 3.623049599639000e-04, -4.277979049597151e-03, 1.171719088808351e-02,  1.662786550658261e-01, 6.253395066442392e-03, -8.006225427292599e-02, 1.320151518892529e-02,  6.797330004997146e-02, 9.067711292674410e-03, 9.769991100331325e-03, -2.264099585218049e-02,  1.603357256458692e-02, -3.280925488047620e-02, 3.456252642705585e-02, 6.253395066441247e-03,  1.890707837299855e-01, -8.983141144484104e-02, 8.971359236782778e-02, -3.279395974242420e-02, -9.457501030628547e-02, -2.064706688977414e-03, -2.634663258104068e-02, -1.722468704995291e-02,  4.756265597351174e-02, -6.350932526434552e-02, -8.006225427292456e-02, -8.983141144484427e-02,  3.860071259573455e-01, -1.122239164011916e-01, -9.498676827149723e-02, 8.292398576853020e-02, -2.695871770378618e-04, -1.752530087474307e-02, 1.066896693821991e-02, -3.287977847579079e-02,  2.927681607446340e-02, 1.320151518892334e-02, 8.971359236782947e-02, -1.122239164011886e-01,  2.764103464304402e-01, -4.553610337596373e-02, -1.140278979047805e-01, 1.931760543227202e-02,  4.773274007778875e-02, -3.682417315584510e-05, 1.598914420734442e-02, 6.836080406016059e-04,  6.797330004997144e-02, -3.279395974242266e-02, -9.498676827150083e-02, -4.553610337596122e-02,  2.845234404901097e-01, 6.055824032673231e-02, -6.254479298934145e-03, 9.444859728261562e-03, -1.955628306821077e-02, 3.651485560099187e-02, -2.962111280341902e-02, 9.067711292673121e-03, -9.457501030628504e-02, 8.292398576852895e-02, -1.140278979047788e-01, 6.055824032673013e-02,  2.498237809995578e-01, 2.846803856259933e-03, -2.545061090300379e-02, -8.945758024643490e-03,  1.245890815451574e-02, -1.250924786164062e-02, 9.769991100331714e-03, -2.064706688977474e-03, -2.695871770381228e-04, 1.931760543227251e-02, -6.254479298934412e-03, 2.846803856257161e-03,  1.802026995058075e-01, 7.033122632794483e-02, 1.622571477805261e-02, 6.029919837279845e-03, -1.456528698878813e-03, 2.886963790658368e-02, -2.761066541100962e-02, -1.542277949697374e-02, -2.644875562886072e-02, 4.674359970306436e-02,
                  1.590536076785140e-02, -2.543553133202617e-02,  1.622571477804702e-02, 1.276759310958449e-01, -2.182604985863863e-02, 7.152383771272191e-03, -6.224650265274499e-04, 1.912786232044655e-02, -1.670171483272635e-02, 1.317179797830067e-02, -6.148740695205313e-03, -2.437240635997991e-02, -1.162985089607943e-02, 6.029919837284001e-03, -2.182604985863900e-02, 1.301635832202818e-01, -4.883499766879581e-02, -6.892923769206177e-03, -4.817984404858006e-02, 6.700556156851235e-02, -5.190688457365301e-02, 1.956934353734272e-02,  5.461615542871962e-02, 1.063419131019295e-02, -1.456528698878130e-03, 7.152383771271536e-03, -4.883499766879640e-02, 1.488493261575371e-01, 1.310350466323238e-02, 4.329449110728600e-02, -7.490954809872244e-02, 4.104222885892526e-02, -7.178979699318973e-04, -4.011447673163288e-02, -9.795446090445477e-03, 2.886963790658922e-02, -6.224650265276520e-04, -6.892923769207866e-03,  1.310350466323286e-02, 1.490500216319706e-01, 6.882791241974611e-03, -7.542533227976378e-02,  1.088862706331058e-02, 6.450022242856396e-02, 7.623253877235340e-03, 7.557313536816075e-03, -2.761066541101119e-02, 1.912786232044545e-02, -4.817984404858019e-02, 4.329449110728494e-02,  6.882791241972634e-03, 2.073909065148479e-01, -1.197738862638626e-01, 1.175230395042049e-01, -4.268740314937948e-02, -1.213914649602461e-01, -3.572469847729872e-03, -1.542277949697737e-02, -1.670171483272643e-02, 6.700556156851409e-02, -7.490954809872330e-02, -7.542533227976143e-02, -1.197738862638674e-01, 4.065510352530575e-01, -1.407002576401604e-01, -8.145387228359580e-02,  1.103800779311702e-01, 1.301487903811929e-03, -2.644875562886318e-02, 1.317179797829950e-02, -5.190688457365285e-02, 4.104222885892386e-02, 1.088862706330766e-02, 1.175230395042069e-01, -1.407002576401563e-01, 2.873261122688006e-01, -5.423806941460386e-02, -1.390568464308766e-01,  1.396428239614135e-02, 4.674359970307675e-02, -6.148740695205072e-03, 1.956934353734019e-02, -7.178979699300411e-04, 6.450022242856430e-02, -4.268740314937687e-02, -8.145387228360149e-02, -5.423806941459985e-02, 2.664505002538132e-01, 6.930919403468527e-02, -1.674374458083615e-03,  1.590536076783936e-02, -2.437240635997661e-02, 5.461615542871814e-02, -4.011447673163167e-02,  7.623253877234859e-03, -1.213914649602457e-01, 1.103800779311676e-01, -1.390568464308743e-01,  6.930919403468409e-02, 2.566315064612288e-01, 6.609690933854176e-03, -2.543553133202661e-02, -1.162985089607462e-02, 1.063419131019279e-02, -9.795446090445819e-03, 7.557313536816497e-03, -3.572469847729891e-03, 1.301487903811465e-03, 1.396428239614197e-02, -1.674374458083921e-03,  6.609690933851244e-03, 1.624313879725932e-01, 5.664509205149387e-02, 1.488423433446187e-02,  1.373151719800243e-02, -9.842947942876306e-03, 1.218506213197456e-02, -4.057274703397577e-02,  2.842105262635521e-02, -4.834399018162620e-02, 2.642580076402134e-02, 2.712597396062235e-02, -2.875714703667205e-02, 1.488423433445600e-02, 1.082539058171769e-01, -1.702967402860617e-02,  3.320803337186595e-03, -3.073832977578208e-03, 1.003473099768847e-02, -5.065259640214120e-04,  2.254056249969765e-03, -8.677237931014064e-03, -1.486650371669575e-02, -1.272006100215158e-02,  1.373151719800870e-02, -1.702967402860614e-02, 1.156771800992013e-01, -4.014872039205277e-02,  3.255988110961445e-05, -4.136695271982389e-02, 4.775923739242598e-02, -4.326985540271869e-02,  2.619943939829724e-02, 4.885240258636207e-02, 1.004983505719496e-02, -9.842947942877076e-03,  3.320803337185771e-03, -4.014872039205407e-02, 1.228149605988533e-01, 2.059624106819793e-03,  3.079753184904615e-02, -4.223211605155160e-02, 2.580080975404583e-02, -1.104989012531275e-02, -2.991976544205661e-02, -9.089094074507843e-03, 1.218506213197939e-02, -3.073832977578295e-03,  3.255988110583124e-05, 2.059624106821297e-03, 1.132440674925319e-01, -5.772502631172077e-03, -2.159546765116526e-02, -1.391653549429590e-02, 3.465259606324864e-02, 1.635228355574267e-02,  6.093184615315467e-05, -4.057274703398006e-02, 1.003473099768681e-02, -4.136695271982423e-02,  3.079753184904411e-02, -5.772502631176835e-03, 1.768324442850961e-01, -7.412775132566510e-02,  8.714372975047326e-02, -5.145889331113786e-02, -9.209123115929019e-02, -6.126279684426162e-03,  2.842105262635645e-02, -5.065259640210582e-04, 4.775923739243109e-02, -4.223211605155260e-02, -2.159546765115905e-02, -7.412775132567428e-02, 2.560599057345975e-01, -6.965197886875465e-02, -1.503313187699008e-02, 6.169592158876427e-02, 1.487361473889283e-02, -4.834399018163230e-02,  2.254056249967879e-03, -4.326985540271929e-02, 2.580080975404330e-02, -1.391653549430242e-02,  8.714372975047593e-02, -6.965197886874575e-02, 2.231743612864620e-01, -6.865417649000925e-02, -9.823200701483865e-02, 2.517618663337528e-03, 2.642580076403350e-02, -8.677237931013446e-03,  2.619943939829213e-02, -1.104989012530927e-02, 3.465259606324963e-02, -5.145889331113167e-02, -1.503313187700206e-02, -6.865417649000033e-02, 1.933753515419991e-01, 6.609299405399897e-02, -4.906208647196304e-03, 2.712597396061294e-02, -1.486650371669186e-02, 4.885240258636066e-02, -2.991976544205434e-02, 1.635228355574497e-02, -9.209123115928959e-02, 6.169592158875691e-02, -9.823200701483537e-02, 6.609299405400131e-02, 1.974062855951363e-01, 1.054350921265064e-02, -2.875714703667254e-02, -1.272006100214680e-02, 1.004983505719474e-02, -9.089094074508249e-03,  6.093184615357664e-05, -6.126279684426091e-03, 1.487361473889211e-02, 2.517618663338361e-03, -4.906208647196618e-03, 1.054350921264759e-02, 1.401698532960893e-01, 5.686211360731492e-02,  1.523585303045336e-02, 1.551146696427104e-02, -1.209319654364695e-02, 1.279862782469434e-02, -4.502784443768509e-02, 3.572228239946362e-02, -5.053979501905075e-02, 2.620186210541822e-02,  3.325118376840108e-02, -2.714217904244552e-02, 1.523585303044750e-02, 1.039611650604394e-01, -1.928218151760121e-02, 3.710786399855617e-03, -2.417506562315068e-03, 1.227926330723786e-02, -4.577639698126149e-03, 4.173256093639124e-03, -6.259191930695773e-03, -1.943829256928884e-02, -1.312800056652407e-02, 1.551146696427701e-02, -1.928218151760112e-02, 1.112717131908930e-01, -4.082980643532998e-02, 9.647060915864442e-04, -4.400774345399290e-02, 5.089317564809685e-02, -4.770265024374967e-02, 2.442950731654041e-02, 5.334507372906501e-02, 8.400024408827731e-03, -1.209319654364748e-02, 3.710786399854723e-03, -4.082980643533141e-02, 1.188752678724063e-01,  6.964479614555031e-05, 3.263347333129011e-02, -4.026487529209971e-02, 2.890484806912874e-02, -1.260551940211518e-02, -3.531983608758243e-02, -7.211904528489310e-03, 1.279862782469918e-02, -2.417506562315335e-03, 9.647060915832055e-04, 6.964479614646277e-05, 1.077326852137462e-01, -9.060111391532573e-03, -1.610091411283284e-02, -1.628457276443449e-02, 3.835383750049427e-02,  2.166333694059966e-02, 2.094315112387592e-04, -4.502784443768934e-02, 1.227926330723607e-02, -4.400774345399320e-02, 3.263347333128794e-02, -9.060111391536691e-03, 1.785840783094176e-01, -7.366437845307265e-02, 9.367738611103395e-02, -5.312410717654739e-02, -9.841946088974109e-02, -4.643464985171993e-03, 3.572228239946459e-02, -4.577639698125384e-03, 5.089317564810127e-02, -4.026487529209948e-02, -1.610091411282771e-02, -7.366437845308078e-02, 2.513811731090747e-01, -7.848008299251041e-02,
                  -1.325407162629844e-02, 6.161995499998116e-02, 1.197021300362018e-02, -5.053979501905677e-02, 4.173256093637051e-03, -4.770265024375008e-02, 2.890484806912576e-02, -1.628457276444019e-02, 9.367738611103650e-02, -7.848008299250242e-02, 2.282120998160923e-01, -6.397660678525073e-02, -1.054055368682156e-01, 5.437168192699224e-03, 2.620186210543037e-02, -6.259191930695233e-03, 2.442950731653582e-02, -1.260551940211224e-02, 3.835383750049515e-02, -5.312410717654159e-02, -1.325407162630964e-02, -6.397660678524228e-02, 1.880103192131282e-01,  7.115906037518711e-02, -2.908427389789589e-03, 3.325118376839154e-02, -1.943829256928478e-02,  5.334507372906348e-02, -3.531983608757992e-02, 2.166333694060122e-02, -9.841946088974064e-02,  6.161995499997487e-02, -1.054055368682125e-01, 7.115906037518893e-02, 2.000068333691892e-01,  9.807688131090720e-03, -2.714217904244587e-02, -1.312800056651926e-02, 8.400024408827535e-03, -7.211904528489768e-03, 2.094315112391868e-04, -4.643464985171921e-03, 1.197021300361926e-02,  5.437168192700006e-03, -2.908427389789790e-03, 9.807688131087716e-03, 1.333298117921997e-01,  5.584064985633271e-02, 1.479111323437996e-02, 1.749051376022402e-02, -1.395239023216696e-02,  8.542853273613787e-03, -4.813311167569591e-02, 4.816128067995461e-02, -5.381162683061456e-02,  1.926614699956978e-02, 3.604004636853828e-02, -2.568741606500557e-02, 1.479111323437411e-02,  1.041943140442178e-01, -2.015788096785308e-02, 2.151480866099716e-03, -3.483862740356487e-03,  9.375635534171168e-03, 1.694591724056688e-03, -4.400967508252050e-05, -9.138557884705479e-03, -1.699704835552910e-02, -1.378074880112667e-02, 1.749051376023028e-02, -2.015788096785289e-02,  1.077823089827783e-01, -4.081719100761999e-02, -3.061599527189052e-03, -4.237873621677483e-02,  4.959184820170292e-02, -4.706004346130818e-02, 2.153724143648303e-02, 5.114923239280109e-02,  2.584106438695724e-03, -1.395239023216765e-02, 2.151480866098741e-03, -4.081719100762174e-02,  1.206638117896543e-01, 2.533163000533788e-03, 3.176661904580620e-02, -3.623179914071538e-02,  2.717649127588495e-02, -1.071098226707479e-02, -3.282940252893302e-02, -2.272742035252788e-03,  8.542853273618487e-03, -3.483862740356816e-03, -3.061599527192783e-03, 2.533163000534898e-03,  1.031214095741021e-01, -6.387478749985011e-03, -1.077606081230236e-02, -1.266696038413590e-02,  3.063341599919607e-02, 1.764363371534904e-02, 9.951825611529226e-04, -4.813311167570054e-02,  9.375635534169256e-03, -4.237873621677593e-02, 3.176661904580427e-02, -6.387478749989581e-03,  1.776798757753487e-01, -6.825175993157155e-02, 8.616858979928678e-02, -4.899035432958651e-02, -9.445954415002925e-02, 8.753481158540466e-04, 4.816128067995645e-02, 1.694591724057556e-03,  4.959184820170909e-02, -3.623179914071561e-02, -1.077606081229675e-02, -6.825175993158031e-02,  2.389125385549594e-01, -6.672240962157455e-02, -5.857375549288176e-03, 5.371016615764865e-02,  9.697830193941513e-04, -5.381162683062102e-02, -4.400967508466809e-05, -4.706004346130954e-02,  2.717649127588217e-02, -1.266696038414202e-02, 8.616858979928947e-02, -6.672240962156609e-02,  2.106644381358815e-01, -5.703153994742129e-02, -9.100104871180101e-02, 1.267805758527851e-02,  1.926614699958177e-02, -9.138557884704926e-03, 2.153724143647794e-02, -1.071098226707162e-02,  3.063341599919697e-02, -4.899035432958000e-02, -5.857375549300397e-03, -5.703153994741214e-02,  1.717262459713814e-01, 6.430761802305415e-02, -4.139463090147132e-04, 3.604004636852912e-02, -1.699704835552494e-02, 5.114923239280023e-02, -3.282940252893069e-02, 1.764363371535093e-02, -9.445954415002893e-02, 5.371016615764170e-02, -9.100104871179766e-02, 6.430761802305657e-02,  1.917303838158963e-01, 6.037105942137441e-03, -2.568741606500596e-02, -1.378074880112186e-02,  2.584106438695650e-03, -2.272742035253343e-03, 9.951825611532582e-04, 8.753481158540501e-04,  9.697830193935580e-04, 1.267805758527913e-02, -4.139463090149561e-04, 6.037105942134541e-03,  1.317704107701058e-01, 5.182422423477409e-02, 1.871115306828807e-02, 1.490985688170288e-02, -1.291389881213233e-02, 2.804925604427245e-03, -4.044238804728177e-02, 5.693666194090278e-02, -4.442138297379139e-02, 3.049062156677800e-03, 2.160074183114105e-02, -2.734346332812074e-02,  1.871115306828270e-02, 1.138389632652425e-01, -2.476998336261147e-02, 2.557679920008960e-03,  1.431289232481201e-03, 7.185343228731773e-03, -2.005115188314056e-03, -1.968480890912287e-03, -3.545728034492220e-03, -1.167724237341254e-02, -1.424047710558135e-02, 1.490985688170724e-02, -2.476998336261126e-02, 1.008665728131839e-01, -3.605660639073095e-02, -9.413004612588810e-03, -3.090579420142239e-02, 4.505212053046195e-02, -4.179525189744814e-02, 1.194182761378716e-02,  3.750835139900664e-02, -2.468668666658569e-03, -1.291389881213163e-02, 2.557679920007897e-03, -3.605660639073245e-02, 1.268617968099581e-01, 7.579914556510754e-03, 2.341953926603872e-02, -2.902067641887655e-02, 2.238276965608606e-02, -4.072759027330695e-03, -2.177869606765659e-02,  1.891896515059764e-03, 2.804925604432430e-03, 1.431289232480361e-03, -9.413004612590486e-03,  7.579914556510464e-03, 1.107329365538326e-01, 8.883995413627346e-04, -1.379481705369232e-02,  2.404222925275140e-03, 2.202247818747798e-02, 3.712781521916333e-03, -4.411889948000300e-04, -4.044238804728341e-02, 7.185343228729881e-03, -3.090579420142392e-02, 2.341953926603772e-02,  8.883995413613518e-04, 1.684107220766114e-01, -6.478114450594857e-02, 6.654452885662697e-02, -2.868724845185368e-02, -7.277917993409386e-02, 4.123818510855491e-03, 5.693666194090068e-02, -2.005115188312323e-03, 4.505212053046506e-02, -2.902067641887528e-02, -1.379481705368990e-02, -6.478114450595134e-02, 2.484348439324502e-01, -6.839491322109231e-02, -4.214701598411282e-03,  5.400399087204419e-02, -3.214573389612284e-03, -4.442138297379433e-02, -1.968480890914424e-03, -4.179525189744963e-02, 2.238276965608406e-02, 2.404222925272612e-03, 6.654452885662905e-02, -6.839491322109018e-02, 1.940389697742150e-01, -2.880668593311203e-02, -6.190373555095949e-02,  1.770111453127411e-02, 3.049062156689205e-03, -3.545728034492458e-03, 1.194182761378533e-02, -4.072759027329991e-03, 2.202247818747735e-02, -2.868724845185219e-02, -4.214701598415553e-03, -2.880668593310878e-02, 1.538931001270035e-01, 3.186113726939267e-02, -7.628320705749705e-04,  2.160074183112871e-02, -1.167724237340856e-02, 3.750835139900691e-02, -2.177869606765566e-02,  3.712781521914700e-03, -7.277917993409465e-02, 5.400399087204504e-02, -6.190373555095770e-02,  3.186113726938996e-02, 1.697451041790085e-01, 7.111794719580830e-04, -2.734346332812137e-02, -1.424047710557664e-02, -2.468668666658114e-03, 1.891896515058809e-03, -4.411889948001506e-04,  4.123818510854809e-03, -3.214573389611256e-03, 1.770111453127383e-02, -7.628320705755998e-04,  7.111794719558400e-04, 1.391526538493346e-01, 6.359878623913845e-02, 1.656894728643296e-02,  2.029407776853744e-02, -1.681713946105124e-02, 2.174090034953377e-03, -4.966477019831021e-02,  7.499691842342558e-02, -5.315199120365081e-02, 2.283849311710329e-03, 2.950122223462624e-02, -3.078658803501799e-02, 1.656894728642764e-02, 1.420451482432825e-01, -3.537841998003181e-02,  6.471816481185000e-03, -8.786319757158809e-04, 1.496954309826955e-02, -5.546894627460414e-03,
                  2.706139813867595e-03, -1.141138106999548e-02, -2.215481552721575e-02, -2.268722647382858e-02,  2.029407776854106e-02, -3.537841998003203e-02, 1.169993877343640e-01, -4.336754734022066e-02, -7.334725660768565e-03, -2.539828774484088e-02, 4.826727075752990e-02, -4.347627874900145e-02,  1.015687507008316e-02, 3.593859860840021e-02, -2.968662829851240e-03, -1.681713946104995e-02,  6.471816481184250e-03, -4.336754734022194e-02, 1.574186373053429e-01, 9.035572541005482e-03,  2.144849109775623e-02, -3.709885278487457e-02, 2.371439980537504e-02, 1.169973070725002e-03, -2.273186671659713e-02, 1.526083964239460e-03, 2.174090034958664e-03, -8.786319757166910e-04, -7.334725660769190e-03, 9.035572541004455e-03, 1.352172015828516e-01, -3.906551147504558e-03, -7.643859663724939e-03, 1.871823838870426e-03, 2.324249878340057e-02, 1.082140827817379e-02, -6.119903836235042e-04, -4.966477019831099e-02, 1.496954309826801e-02, -2.539828774484210e-02,  2.144849109775518e-02, -3.906551147504891e-03, 1.958539364774972e-01, -7.684355007204402e-02,  7.773534816584482e-02, -3.637231740346225e-02, -8.315437437892614e-02, 2.327711923084091e-03,  7.499691842342202e-02, -5.546894627459303e-03, 4.826727075753134e-02, -3.709885278487229e-02, -7.643859663724162e-03, -7.684355007204524e-02, 3.048384624390430e-01, -8.987280285143684e-02, -6.640394790336512e-04, 6.721223421221401e-02, 2.980084174150731e-03, -5.315199120365276e-02,  2.706139813865943e-03, -4.347627874900245e-02, 2.371439980537282e-02, 1.871823838869149e-03,  7.773534816584671e-02, -8.987280285143617e-02, 2.452044430216022e-01, -5.022784713472814e-02, -7.181823571096657e-02, 2.714763368975799e-02, 2.283849311721681e-03, -1.141138106999580e-02,  1.015687507008244e-02, 1.169973070724847e-03, 2.324249878339973e-02, -3.637231740346208e-02, -6.640394790355386e-04, -5.022784713472646e-02, 2.035887879576739e-01, 4.685829093917887e-02, -1.097427027793657e-02, 2.950122223461302e-02, -2.215481552721217e-02, 3.593859860840032e-02, -2.273186671659624e-02, 1.082140827817103e-02, -8.315437437892725e-02, 6.721223421221678e-02, -7.181823571096513e-02, 4.685829093917479e-02, 2.094030488609142e-01, 8.167050914196849e-03, -3.078658803501869e-02, -2.268722647382389e-02, -2.968662829850692e-03, 1.526083964238419e-03, -6.119903836237298e-04, 2.327711923083214e-03, 2.980084174152142e-03, 2.714763368975750e-02, -1.097427027793729e-02, 8.167050914194788e-03, 1.719713927986453e-01 ))

  expect_equal(c(result_exp$lag_one_cov),
               c(NULL ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(9 ))

  expect_equal(c(result_exp$Q),
               c( 0.105260967610434492, -0.006807137171777326, 0.023603909690573993, -0.005808201701570790,  0.079307279309542567, -0.056202188142265172, -0.082900596778196348, -0.043881415628727875,  0.152385749742438237, 0.078914900739504468, 0.010092436170618189, -0.006807137171777326,  0.061341793634302033, -0.061734697279920134, 0.043032687525843279, 0.011135161093990268,  0.086901481943602449, -0.120851202813762798, 0.094122521339424031, -0.016974796784790375, -0.096913089596386115, -0.015168893491292634, 0.023603909690573993, -0.061734697279920134,  0.312249850839726673, -0.214286655456294273, -0.072838476429536975, -0.343601071993290486,  0.532457072739195958, -0.393140390744878165, 0.046430845984279046, 0.360099331150337987,  0.037341818331852725, -0.005808201701570790, 0.043032687525843279, -0.214286655456294273,  0.205356932220913752, 0.068190144433304845, 0.250180271420766875, -0.418864170559494320,  0.284967274998875530, -0.007279298672222215, -0.256265631735144050, -0.028586847275948263,  0.079307279309542567, 0.011135161093990268, -0.072838476429536975, 0.068190144433304845,  0.148798380815928083, 0.083532417807057391, -0.301193206107112865, 0.123925315174567480,  0.139158798914760629, -0.060191340837338708, 0.011143613349747478, -0.056202188142265172,  0.086901481943602449, -0.343601071993290486, 0.250180271420766875, 0.083532417807057391,  0.584864086821213602, -0.767704617917131737, 0.635232360828472675, -0.122180887644380426, -0.590071120176482888, -0.031208442178157145, -0.082900596778196348, -0.120851202813762798,  0.532457072739195958, -0.418864170559494320, -0.301193206107112865, -0.767704617917131737,  1.482613438033887343, -0.926370398872919498, -0.146255544407250276, 0.768352330058446276,  0.023237051398925304, -0.043881415628727875, 0.094122521339424031, -0.393140390744878165,  0.284967274998875530, 0.123925315174567480, 0.635232360828472675, -0.926370398872919498,  0.823870715127693609, -0.133038283394786433, -0.680525258998512239, -0.005317272783931317,  0.152385749742438237, -0.016974796784790375, 0.046430845984279046, -0.007279298672222215,  0.139158798914760629, -0.122180887644380426, -0.146255544407250276, -0.133038283394786433,  0.362089987702304605, 0.181163817403980382, 0.014272272086026168, 0.078914900739504468, -0.096913089596386115, 0.360099331150337987, -0.256265631735144050, -0.060191340837338708, -0.590071120176482888, 0.768352330058446276, -0.680525258998512239, 0.181163817403980382,  0.685443934995258575, 0.038506775002575266, 0.010092436170618189, -0.015168893491292634,  0.037341818331852725, -0.028586847275948263, 0.011143613349747478, -0.031208442178157145,  0.023237051398925304, -0.005317272783931317, 0.014272272086026168, 0.038506775002575266,  0.070845615116106722 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(2052, 1893, 1887, 1886, 1877, 1702, 1594, 1438, 1239, 1112 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})
