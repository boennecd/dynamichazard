if(interactive()){
  library(dynamichazard); library(testthat); library(survival); source("R/test_utils.R")
}


# Had issues with win builder. Thus, these lines
test_name <- "UKF"
cat("\nRunning", test_name, "\n")


test_that("UKF on head_neck works with logit model", {
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3,
                   method = "UKF", save_data = F, save_risk_set = F,
                   beta = 0),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "logit"
  ))
  # sink()
  # close(tmp)
  # matplot(result$state_vecs, type = "l")
  # get_expect_equal(result, file = "tmp.txt")

  expect_equal(c(result$state_vecs),
               c(-3.6210434470696890585, -3.6219775909341636044, -3.1965255364948381711, -2.8822948351329835681, -2.6776156900575127651, -2.2095602359803558912, -2.3039025570373250495, -2.7036359117999517743, -2.8953691047058138786, -3.0279231524362413275, -3.1628588573884406365, -3.3904425619815969917, -3.5138861403774774850, -3.5567556811008818052, -3.3898744925660686533, -3.4585646333131219166, -3.5946313394922535522, -3.6965037242615896851, -3.6474672416224787064, -3.7300581555136917977, -3.6881032589664783927, -3.8180662106301541669, -3.9901818199601550852, -4.0988787019364556485, -4.1448073556898235026, -4.2615650315205364507, -4.3290075039660331768, -4.3505261677194129177, -4.4572955274518104574, -4.5274560988752776680, -4.5621022108524913463, 0.0437524209268248740, 0.0434488530566888853, 0.2434369545035404980, 0.3969322710753109273,  0.4240346032522276376, 0.6773390287582086167, 0.6451839996937245303, 0.4537886436474507512, 0.4583136798526994404,  0.4345211638159840462, 0.3960674102490738813, 0.2955817385491453231, 0.2705570910979426813, 0.3096639084387750596,  0.4470865166245729938, 0.4000008635825747505, 0.3212092861022941559, 0.2816445842895028973, 0.3106255364430759447,  0.2768430914252567598, 0.2992739675623217188, 0.1908583206996150583, 0.0829235578956353248, 0.0007578594815966233, -0.0555913462040324990, -0.1227738310103664021, -0.1696660035920780352, -0.1974353476942747043, -0.2421429545513467396, -0.2713445719050950333, -0.2856785819140564842 ))

  expect_equal(c(result$state_vars),
               c( 0.27586130139258525, -0.01729696648038014, -0.01729696648038018, 0.25673566962837213, 0.19204978899311037, -0.04652972542539296, -0.04652972542539302, 0.21250496603901070, 0.17969437455520307, -0.04149160607874319, -0.04149160607874328, 0.19263335842713530,  0.15127185438701288, -0.04590055557720557, -0.04590055557720563, 0.16646399084541957, 0.12408621590335175, -0.05264837752236441, -0.05264837752236444, 0.14021440808669886, 0.11181404217186226, -0.04597460917218005, -0.04597460917218010, 0.12930818038659231,  0.08969222661530118, -0.04965701541242944, -0.04965701541242947, 0.11483060025883877, 0.09296408991344228, -0.04606189072130398, -0.04606189072130403, 0.11692307001859213, 0.10838201464451167, -0.03966349773915480, -0.03966349773915485, 0.12981193907805577,  0.12097949468442352, -0.03851290694902363, -0.03851290694902369, 0.14206446783109883, 0.13211592509083336, -0.03874511949845088, -0.03874511949845093, 0.15539114693965705, 0.14384890041396725, -0.03855383544648393, -0.03855383544648397, 0.17079679789240104,  0.16264830505235467, -0.03457106391527271, -0.03457106391527275, 0.19045525247100575, 0.17912420788215988, -0.03264849154946278, -0.03264849154946281, 0.20869824116994468, 0.19170844991569747, -0.03405708296339675, -0.03405708296339679, 0.22394393261604215,  0.18681363202722745, -0.04542000114778499, -0.04542000114778502, 0.23139642142144787, 0.19283005720931323, -0.05054236761614715, -0.05054236761614718, 0.24501581354478283, 0.20818936050880404, -0.05078982491866487, -0.05078982491866491, 0.26471653072460333,  0.22639191934206793, -0.05080994943479061, -0.05080994943479065, 0.28653105710720650, 0.23654094916899326, -0.05606446938229647, -0.05606446938229650, 0.30597282151091842, 0.25064078106728011, -0.06050423110661661, -0.06050423110661664, 0.32802302101753855,  0.25575159167104355, -0.07080863826708850, -0.07080863826708853, 0.34775129645080316, 0.27284865609263720, -0.07508608685919037, -0.07508608685919041, 0.37559466447733608, 0.29861404981717721, -0.07541670702878020, -0.07541670702878023, 0.41013515123571959,  0.32594704948607256, -0.07566214415849024, -0.07566214415849026, 0.44792698017987587, 0.35200387652970888, -0.07740493704447665, -0.07740493704447668, 0.48739743860021112, 0.38891852074022082, -0.07592996632165271, -0.07592996632165273, 0.53185859068309049,  0.43234651088258613, -0.07262126182518183, -0.07262126182518186, 0.57999557271232094, 0.48292910117995069, -0.06748916445709460, -0.06748916445709463, 0.63130448681350515, 0.56054019723716186, -0.05250657840787097, -0.05250657840787101, 0.69090884779240913,  0.66854326851757739, -0.02655958573405968, -0.02655958573405972, 0.75856729979961257 ))

  expect_equal(c(result$lag_one_cov),
               c(NULL ))

  expect_equal(c(result$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result$n_iter),
               c(14 ))

  expect_equal(c(result$Q),
               c(0.1479302025208791, 0.0414058984636589, 0.0414058984636589, 0.0752060922218248 ))

  expect_equal(c(result$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result$risk_set),
               c(NULL ))

  expect_equal(c(result$data),
               c(NULL ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$method),
               c("UKF" ))

  expect_equal(c(result$model),
               c("logit" ))

  expect_equal(c(result$est_Q_0),
               c(FALSE ))

  expect_equal(c(result$LR),
               c(1 ))
})


set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$state_vecs, res_old$state_vecs)
  expect_equal(res_new$state_vars, res_old$state_vars)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$state_vecs, res_new_time$state_vecs)
  expect_equal(res$state_vars, res_new_time$state_vars)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2,
                                  save_data = F, save_risk_set = F),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  # matplot(sims$betas, type = "l")
  # matplot(res$state_vecs, add = T, type = "l")
  # get_expect_equal(res, file = "tmp.txt")

  expect_equal(c(res$state_vecs),
               c(-1.586377228122479943, -1.586630033484746516, -1.428376221113095479, -0.784370178711367605, -0.641999351480161407, -0.518433459927804763, -0.727906112606297895, -0.559484221494314204, -0.731705419333232077, -0.248707136761067260, -0.367935180117968219, 2.198771692817839352, 2.175231794247460382, 2.045516835180890780, 1.933855355358886641,  1.603907220226844288, 1.196301311713791060, 1.818038819570645392, 3.400829273222566673, 3.299842637531596790,  2.550263998669416221, 2.388201262064851615, 0.920991063786816277, 0.886046736214297526, 0.953588306031064148,  1.175089262870585793, 0.791708045469890154, 0.593000224938449838, 1.215726149479578133, 2.375444389485041441,  1.464487580941969957, -0.335690612684172829, -0.806051122637007067, 1.425111865038881431, 1.480868651999746044,  1.253247745933509183, 0.066811905544865408, 0.497641457837281531, 0.801002033089991405, -0.008536873968637337, -2.724247674919297868, -1.405637265305051731, 0.315610362649203113, 1.135735482814673514 ))

  expect_equal(c(res$state_vars),
               c( 0.1824210226547152702, -0.0280567323423201904, -0.0510051459995278234, -0.0495654523271920333, -0.0280567323423278475,  0.4305693732570275989, -0.0013574119131351814, -0.1907928477608626938, -0.0510051459995305434, -0.0013574119131365258,  0.4189410607259385078, -0.2424785841118443086, -0.0495654523271992775, -0.1907928477608632212, -0.2424785841118429763,  0.6024630917946190989, 0.1013657754692213198, 0.0156306337058410849, 0.0073509843173614753, -0.0268884278373829472,  0.0156306337058329664, 0.4064563825696114185, 0.0685159081505088974, -0.3226725501523874939, 0.0073509843173616973,  0.0685159081505069267, 0.4141679079403943753, -0.3907653399689948737, -0.0268884278373968250, -0.3226725501523870498, -0.3907653399689898222, 0.8257138664824452690, 0.0663798238546949304, 0.0262599432837489349, 0.0246249497727718952, -0.0076471942063543047, 0.0262599432837406221, 0.3507836336884601613, 0.0690548826900880819, -0.2996261151965867175,  0.0246249497727720479, 0.0690548826900864443, 0.3610801623583721476, -0.3651998385274937697, -0.0076471942063682935, -0.2996261151965861069, -0.3651998385274876635, 0.7461269585768464108, 0.0592165548797238539, 0.0220032502799559909,  0.0216019785463589797, 0.0028276012260004812, 0.0220032502799478030, 0.2790894576969081275, 0.0599830146087604044, -0.2321988193208725793, 0.0216019785463590352, 0.0599830146087596966, 0.3062152034547571677, -0.3036780373732752558,  0.0028276012259867561, -0.2321988193208721074, -0.3036780373732677618, 0.6153341528879432420, 0.0464677116509729787,  0.0149739483771787751, 0.0090077371435139594, 0.0396265514245370959, 0.0149739483771707330, 0.1510173226968049565,  0.0044512076679463844, -0.0772574714336502488, 0.0090077371435133557, 0.0044512076679491721, 0.1649460466541940729, -0.1094233633948897277, 0.0396265514245242034, -0.0772574714336518586, -0.1094233633948788614, 0.2477618406607089707,  0.0457933278824830189, 0.0189979885556992474, 0.0181719065278271100, 0.0271404629246799478, 0.0189979885556913405,  0.1504277543321448363, 0.0100330729069115221, -0.0853888505698948558, 0.0181719065278262183, 0.0100330729069145318,  0.1581817287805460381, -0.1140592962951975375, 0.0271404629246679817, -0.0853888505698969930, -0.1140592962951878786,  0.2621288086480622059, 0.0461191460035962758, 0.0238808575706914543, 0.0195345526366445185, 0.0221014143085921586,  0.0238808575706839291, 0.1611883120170764239, 0.0170997395987705567, -0.1024694511914471529, 0.0195345526366442548,  0.0170997395987733392, 0.1582661013906956349, -0.1154217804871662256, 0.0221014143085789608, -0.1024694511914489292, -0.1154217804871567055, 0.2747418086179178598, 0.0505433907259783405, 0.0208193912344890042, 0.0124159188930033776,  0.0268482653090398246, 0.0208193912344817877, 0.1958486607521109923, 0.0334458343199537586, -0.1318413432886212655,  0.0124159188930035910, 0.0334458343199564301, 0.2120134817275364236, -0.1613327444182467707, 0.0268482653090259954, -0.1318413432886225978, -0.1613327444182368897, 0.3281275258530819139, 0.0552289918339923941, 0.0124368321962026462,  0.0005551672977831268, 0.0462487962034608333, 0.0124368321961957559, 0.2499891923201728594, 0.0646110960888437169, -0.1816810466370180344, 0.0005551672977833272, 0.0646110960888461872, 0.2401066921843042490, -0.1850146587074111282,  0.0462487962034465044, -0.1816810466370191446, -0.1850146587074022742, 0.3468552081735357673, 0.0604163269531132405,  0.0067712707394571442, -0.0015307105494844556, 0.0489851583859482326, 0.0067712707394502287, 0.2990597506576424536,  0.0634040541957961862, -0.1983717136626504951, -0.0015307105494842595, 0.0634040541957986842, 0.2699057656205353095, -0.2079062532167276489, 0.0489851583859339454, -0.1983717136626514388, -0.2079062532167189892, 0.3841578936288893575,  0.0602019128638456857, 0.0305336369372033664, 0.0309621279864029514, 0.0110088952405827216, 0.0305336369371969757,  0.3205268793431931273, 0.0292230528586805427, -0.2043880476042079231, 0.0309621279864037285, 0.0292230528586820970,  0.2681554241099355362, -0.2349343460011865670, 0.0110088952405680424, -0.2043880476042079231, -0.2349343460011785734,  0.4784499873473575526 ))

  expect_equal(c(res$lag_one_cov),
               c(NULL ))

  expect_equal(c(res$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(res$n_iter),
               c(32 ))

  expect_equal(c(res$Q),
               c( 0.12160536293782964, -0.05097094130727473, -0.07849865845916659, -0.06184413844291841, -0.05097094130727473,  0.66720696425256443, 0.50251010237681148, -0.95634626918935339, -0.07849865845916659, 0.50251010237681148,  0.95470908871885174, -1.27004602490409324, -0.06184413844291841, -0.95634626918935339, -1.27004602490409324,  2.19193807022204634 ))

  expect_equal(c(res$Q_0),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$n_risk),
               c(500, 476, 458, 421, 359, 295, 259, 214, 194, 157 ))

  expect_equal(c(res$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(res$risk_set),
               c(NULL ))

  expect_equal(c(res$data),
               c(NULL ))

  expect_equal(c(res$order),
               c(1 ))

  expect_equal(c(res$F_),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$method),
               c("UKF" ))

  expect_equal(c(res$model),
               c("logit" ))

  expect_equal(c(res$est_Q_0),
               c(FALSE ))

  expect_equal(c(res$LR),
               c(1 ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  suppressMessages(m1 <- do.call(ddhazard, arg_list))

  arg_list$control$beta <- 2

  suppressMessages(m2 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m1$state_vecs, m2$state_vecs)) == "character")
  expect_true(class(all.equal(m1$state_vars, m2$state_vars)) == "character")

  arg_list$control$alpha <- .1
  arg_list$control$kappa <- 4 / (.1)^2 + 4

  suppressMessages(m3 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m2$state_vecs, m3$state_vecs)) == "character")
  expect_true(class(all.equal(m2$state_vars, m3$state_vars)) == "character")

  arg_list$control$beta <- 0
  arg_list$control$alpha <- 1
  arg_list$control$kappa <- .5

  suppressMessages(m4 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m3$state_vecs, m4$state_vecs)) == "character")
  expect_true(class(all.equal(m3$state_vars, m4$state_vars)) == "character")
})

arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                 by = 1,
                 data = NULL,
                 Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                 Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                 control = list(kappa = 0, alpha = 1, beta = 0,
                                est_Q_0 = F, method = "UKF", eps = 1e-2),
                 id = NULL,
                 verbose = F,
                 max_T = 10)

set.seed(2972)
sims <- test_sim_func_logit(n_series = 2e3, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -2, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

arg_list$data <- sims$res
arg_list$id <- sims$res$id

arg_list$control$beta <- 0
suppressMessages(fit1 <- do.call(ddhazard, arg_list))

arg_list$control$beta = 2
suppressMessages(fit2 <- do.call(ddhazard, arg_list))

# matplot(sims$betas, type = "l", lty = 1, ylim = range(sims$betas, fit1$state_vecs, fit2$state_vecs))
# matplot(fit1$state_vecs, type = "l", lty = 2, add = T)
# matplot(fit2$state_vecs, type = "l", lty = 4, add = T)

test_that("UKF on head_neck works with exponential model", {
  # Change by argument
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3, beta = 0,
                   method = "UKF", save_data = F, save_risk_set = F),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "exponential"
  ))
  # sink()
  # close(tmp)
  # matplot(result_exp$state_vecs, type = "l")
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-3.62169912365052138, -3.62246078452342424, -3.22364359257399835, -2.92217977205102253, -2.72907999003154789, -2.31190644378908861, -2.42049669642081922, -2.78394368630350941, -2.96084539618035114, -3.08533315953903431, -3.21320088682824023, -3.42328511524642787, -3.53914011221686220, -3.58347883705927117, -3.44131620120169446, -3.50485901032138036, -3.62983767601771934, -3.72502283544137036, -3.68571947451093873, -3.76393606572367734, -3.73198475887238157, -3.85137633806533186, -4.00968934620624928, -4.11071598748750056, -4.15544703206457289, -4.26352440239257380, -4.32694584038677466, -4.34893991704142202, -4.44666450998967910, -4.51086590148823863, -4.54257172268638154, 0.03512153461984305, 0.03499222987309403, 0.21904752732582489, 0.36349610863524906, 0.37975430073260097,  0.60372085835324862, 0.56248876424764083, 0.39490258987221666, 0.41325691765382555, 0.39761739711562594, 0.36622107890507077,  0.27804691138392745, 0.26016928296526448, 0.30176607029358010, 0.42852938902956261, 0.38505456407735117, 0.31329924797493830,  0.27896343070447388, 0.30391561557526409, 0.27386171379931751, 0.29203485932130385, 0.18924291566550427, 0.08933460325358744,  0.01157613939984603, -0.04414995777165318, -0.10612942803044154, -0.15059962381984210, -0.17859069537436190, -0.21782376721781033, -0.24342466059260034, -0.25598554356591635 ))

  expect_equal(c(result_exp$state_vars),
               c( 0.26179350713741312, -0.02518477240080714, -0.02518477240080657, 0.25041835838325355, 0.18393691970255002, -0.05025960835094892, -0.05025960835094823, 0.20774054207588433, 0.17137008347534013, -0.04496823747370379, -0.04496823747370315, 0.18771414842964934,  0.14516715664778784, -0.04769253323669073, -0.04769253323669005, 0.16194072493710138, 0.11889796047033377, -0.05342280266159982, -0.05342280266159918, 0.13530799475546648, 0.10582589814661759, -0.04658165898077433, -0.04658165898077363, 0.12344861967201867,  0.08313613429058933, -0.05034845851381021, -0.05034845851380952, 0.10738477237551117, 0.08700514565472872, -0.04631427160359920, -0.04631427160359852, 0.11025031850038432, 0.10219195715158980, -0.04000705463604366, -0.04000705463604295, 0.12422177899873321,  0.11437522628233976, -0.03952595961941931, -0.03952595961941859, 0.13672962334571048, 0.12508816746533474, -0.04040307339437286, -0.04040307339437216, 0.15002705609780154, 0.13630789900930673, -0.04089970967323204, -0.04089970967323135, 0.16517439744018070,  0.15385886149528005, -0.03799173775194831, -0.03799173775194760, 0.18428623361581675, 0.16921157576514878, -0.03702988940581356, -0.03702988940581282, 0.20190492266278764, 0.18104762414551845, -0.03913483944086422, -0.03913483944086346, 0.21657512006117122,  0.17805207668510784, -0.04955804999934899, -0.04955804999934817, 0.22427712705464720, 0.18410058923231776, -0.05472902877865486, -0.05472902877865403, 0.23752059866658176, 0.19840204349199297, -0.05565523798676760, -0.05565523798676678, 0.25648493655242899,  0.21525804099994120, -0.05659656554308166, -0.05659656554308083, 0.27737253346425306, 0.22543035980169196, -0.06198157350380359, -0.06198157350380275, 0.29627505072024507, 0.23888290615416641, -0.06699283747087292, -0.06699283747087208, 0.31750358925872424,  0.24494004212485823, -0.07699086971009064, -0.07699086971008978, 0.33685884702696189, 0.26140825476372442, -0.08177119028289324, -0.08177119028289238, 0.36399049173075732, 0.28558403983407588, -0.08332215609003478, -0.08332215609003391, 0.39744323778357521,  0.31146988351280047, -0.08484249930210493, -0.08484249930210402, 0.43413380789258649, 0.33681863620703600, -0.08753868007063045, -0.08753868007062955, 0.47274077770520945, 0.37190976148156496, -0.08777888706176394, -0.08777888706176304, 0.51605618435243505,  0.41325624916857340, -0.08646971224126070, -0.08646971224125981, 0.56302663516032425, 0.46161411173626238, -0.08351269871312506, -0.08351269871312415, 0.61326724927858622, 0.53351538087394712, -0.07276018186437519, -0.07276018186437430, 0.67097219462493185,  0.63194503520661316, -0.05320906518387750, -0.05320906518387660, 0.73592908613487684 ))

  expect_equal(c(result_exp$lag_one_cov),
               c(NULL ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(13 ))

  expect_equal(c(result_exp$Q),
               c(0.13282206634683452, 0.03202721699929914, 0.03202721699929914, 0.07120662065543586 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})

test_that("UKF on simulated data works with exponential model", {
  set.seed(9997)
  sims <- test_sim_func_exp(n_series = 1e3, n_vars = 10, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = 0, re_draw = T, beta_start = (1:10 - 5) / 2.5,
                            intercept_start = -5, sds = c(.1, rep(1, 10)))
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
    data = sims$res,
    by = (by_ <- 1),
    Q_0 = diag(1, 11),
    Q = diag(1e-1, 11),
    control = list(est_Q_0 = F, eps = 10^-2, n_max = 10^3, method = "UKF",
                   debug = F, beta = 0, save_data = F, save_risk_set = F),
    max_T = 10,
    id = sims$res$id, order = 1,
    verbose = F,
    model = "exponential"))
  # sink()
  # close(tmp)

  # sum(sims$res$event)
  # diag(result_exp$Q)
  # result_exp$LR
  # matplot(sims$betas, type = "l", lty = 1)
  # matplot(result_exp$state_vecs, type = "l", lty = 2, add = T)
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-5.296985751931666542, -5.294997720366526828, -4.987931290161729869, -4.790365169112824617, -4.719816425838490481, -4.632238719804252725, -4.788674354517598708, -4.740386195760116550, -4.613032780318246928, -4.201210052042589460, -3.803262785212128350, -2.072226320663728583, -2.056332478790297902, -2.554356756714668553, -2.332029520834581149, -1.836895545678870256, -1.802448703526633000, -1.996368704429387853, -2.262155454794579246, -2.385241061073536173, -1.821641600602017741, -1.593990021324609208, -0.201978209091266597, -0.103105335987053681, -1.407690323835784074, -0.580716240638760040, 0.994498562080960102, 0.477382287548883288, 0.592517572595406827, -0.627086589251302451, -1.945897379530036719, -0.870211508056799476, 0.731963694100878026, 0.005299053452932317, -0.049477931190040791,  0.582038060750140973, 0.286153973223754576, -0.608556434282100378, -0.214685842952759109, -0.023814536985214046,  0.558859729567239505, 1.252541499128918989, 0.465284923411283802, -0.530473641569741527, -0.215368006986644267, -0.221136530877780929, -0.521633778771008916, -0.267148540153603120, -0.156355884721407046, 0.380171675657571373,  0.640726525403425784, 0.904449362439669891, 0.991961671915229548, 1.229680129445827941, 1.331819024479016678,  0.569587491755787045, 0.580074070396911168, -0.797388641227575135, 0.457003793248005219, 0.844866285461513544,  1.942221233568787842, 2.925982593758558625, 2.883705544000623622, 2.416805095089312516, 2.122318571208535953,  2.303653227172255402, -1.210546063847233622, -1.127402057267626212, -1.138676420221215402, -2.452475696615405543, -1.478568819371093745, -3.794811689160051849, -5.079974584064555820, -6.325221676979642105, -7.138817795434787783, -6.178388872773273199, -5.322892858271043082, -0.106228603475141653, -0.195160335623876219, -1.201069324059879095,  1.007593281935528440, 1.233108998269667245, 3.653397130810078774, 3.155402596108486168, 3.536763571301665188,  4.097296930611038945, 3.211786440832852030, 1.835422847785916023, 1.374969911906207543, 1.413743903197165475,  1.566712523598329243, 1.817345504919710253, 1.962554546233724828, 2.115986386795585261, 3.211074244777490705,  3.311417917604556838, 3.155523584764688749, 3.909825978564392734, 5.184385936669507089, 2.010419730604675159,  2.014380151220583226, 4.405422284852015480, 2.606537459372088250, 1.739768264372042905, 0.174903203177358746, -0.492264806495917639, -0.226825404336185588, 0.352348400806409834, 0.847477290027751962, 1.382959172463448461,  2.363675420334485189, 2.312563813615891917, 3.167160018567376500, 3.929891885048522049, 3.613724621996472486,  4.217355055640840789, 3.198738591417742860, 3.301241479116225896, 3.714410848720285596, 3.127782296801913553,  2.590662278064039814 ))

  expect_equal(c(result_exp$state_vars),
               c( 1.442959460496754e-01, 5.160445035091613e-02, 4.211332909911270e-02, -4.193835803731979e-02, 3.903754432397725e-02, -3.385441773702751e-02, -6.215211887600101e-03, 2.845211779683128e-02, 6.907179845259179e-02, 5.744242623014516e-02,  3.094847885527608e-02, 5.160445035091461e-02, 2.135134103898079e-01, 7.426403950254132e-02, -5.067016213329337e-02,  4.631182505184175e-02, -1.425848508489183e-02, 5.086333805562290e-02, 4.706821646579924e-02, 1.589296520950823e-02, -3.459136465971743e-02, -3.985481024913286e-02, 4.211332909910802e-02, 7.426403950254200e-02, 4.627099922123573e-01, -1.884332692097576e-01, -1.216891399014912e-02, 1.026822063160919e-01, 1.526448800873511e-01, -3.023047896977525e-02,  1.076611626529131e-01, -1.017970127860425e-01, -1.096564714613831e-02, -4.193835803731404e-02, -5.067016213329385e-02, -1.884332692097578e-01, 2.681339075714266e-01, -3.731250219879080e-02, -2.735903687031177e-02, -1.021581123913636e-01,  1.800281356097098e-02, -4.731977165540389e-02, 2.652810124466400e-02, 4.881208670995308e-03, 3.903754432397463e-02,  4.631182505184123e-02, -1.216891399014888e-02, -3.731250219879086e-02, 2.017357681676648e-01, 2.648704376643518e-02, -5.749981336663351e-02, 4.166109479630123e-02, 6.046016517035593e-02, -1.534948338758168e-02, -6.009983081874426e-02, -3.385441773702309e-02, -1.425848508489224e-02, 1.026822063160920e-01, -2.735903687031132e-02, 2.648704376643466e-02,  2.859702905773561e-01, -1.209568042346074e-01, 5.786739319787282e-02, 6.301324540318760e-02, -1.898280375953029e-01, -4.666311242964261e-02, -6.215211887602735e-03, 5.086333805562254e-02, 1.526448800873511e-01, -1.021581123913633e-01, -5.749981336663334e-02, -1.209568042346070e-01, 4.952873805249908e-01, -1.329405709219308e-01, -1.068963310495554e-01,  6.647420248371823e-02, -1.738206946067629e-02, 2.845211779683064e-02, 4.706821646579944e-02, -3.023047896977563e-02,  1.800281356097048e-02, 4.166109479630120e-02, 5.786739319787324e-02, -1.329405709219308e-01, 5.029648087380483e-01, -8.739476804560356e-02, -1.767197062952541e-01, 1.486063502168543e-01, 6.907179845259523e-02, 1.589296520950774e-02,  1.076611626529134e-01, -4.731977165540441e-02, 6.046016517035642e-02, 6.301324540318722e-02, -1.068963310495558e-01, -8.739476804560337e-02, 3.958974753400147e-01, 5.404812374174634e-02, -6.713535647210322e-02, 5.744242623014502e-02, -3.459136465971737e-02, -1.017970127860425e-01, 2.652810124466324e-02, -1.534948338758165e-02, -1.898280375953029e-01,  6.647420248371824e-02, -1.767197062952547e-01, 5.404812374174535e-02, 4.706643434109500e-01, 6.454544599923850e-02,  3.094847885527874e-02, -3.985481024913300e-02, -1.096564714613787e-02, 4.881208670995455e-03, -6.009983081874325e-02, -4.666311242964283e-02, -1.738206946067639e-02, 1.486063502168543e-01, -6.713535647210428e-02, 6.454544599923864e-02,  4.240343861640425e-01, 1.072147398468091e-01, 4.938901193257121e-02, 5.111778721467519e-02, -4.267796344882502e-02,  3.055191571342383e-02, -2.121421779865385e-02, 1.721689730618654e-02, 1.128132405377519e-02, 5.145277991022046e-02,  3.140297749914291e-02, 5.407703444717457e-03, 4.938901193256613e-02, 1.800846678364515e-01, 7.308448378548453e-02, -5.044408990229277e-02, 4.054587361662376e-02, -3.212240530851493e-03, 3.713005867575258e-02, 3.523422405796319e-02,  2.875476785940101e-02, -2.996496107467870e-02, -3.279302217023847e-02, 5.111778721465709e-02, 7.308448378548565e-02,  3.278045618396414e-01, -1.454369018943343e-01, 3.193078162150361e-03, 6.037935410571375e-02, 1.065485607181728e-01, -2.436015516607696e-02, 1.006956431645236e-01, -5.425100808750180e-02, -1.309337603066706e-02, -4.267796344881047e-02, -5.044408990229376e-02, -1.454369018943357e-01, 2.276185335867452e-01, -3.655786123651856e-02, -1.553808910184488e-02, -8.315702740611575e-02, 2.132208422725577e-02, -5.197306411840578e-02, 1.034631717379929e-02, 1.026835962844764e-02,  3.055191571342181e-02, 4.054587361662328e-02, 3.193078162151084e-03, -3.655786123651887e-02, 1.676126229390192e-01,  2.782616449364055e-02, -4.265665906781760e-02, 3.503219780087138e-02, 5.356238569224849e-02, -2.421428510146631e-02, -5.401569118081161e-02, -2.121421779864685e-02, -3.212240530852138e-03, 6.037935410571250e-02, -1.553808910184309e-02,  2.782616449363948e-02, 1.945717135038873e-01, -8.639898430809413e-02, 4.861558209373115e-02, 4.417252925986209e-02, -1.371171499058456e-01, -3.496812143313740e-02, 1.721689730616829e-02, 3.713005867575257e-02, 1.065485607181734e-01, -8.315702740611465e-02, -4.265665906781725e-02, -8.639898430809173e-02, 3.660917978350471e-01, -1.134194537295263e-01, -5.228084885863869e-02, 8.777010703179150e-02, -8.123507318534492e-04, 1.128132405378373e-02, 3.523422405796311e-02, -2.436015516607952e-02, 2.132208422725625e-02, 3.503219780087127e-02, 4.861558209373128e-02, -1.134194537295282e-01,  4.047691442451877e-01, -7.825211449249930e-02, -1.665709196181848e-01, 1.212138349106529e-01, 5.145277991022316e-02,  2.875476785940087e-02, 1.006956431645258e-01, -5.197306411840791e-02, 5.356238569224887e-02, 4.417252925985980e-02, -5.228084885863690e-02, -7.825211449250052e-02, 3.244391411346935e-01, 3.531163668422253e-02, -8.159280685404315e-02,  3.140297749914084e-02, -2.996496107467817e-02, -5.425100808749850e-02, 1.034631717379525e-02, -2.421428510146566e-02, -1.371171499058475e-01, 8.777010703179640e-02, -1.665709196181884e-01, 3.531163668421938e-02, 3.934517907851997e-01,  3.514487134346666e-02, 5.407703444724479e-03, -3.279302217023823e-02, -1.309337603066600e-02, 1.026835962844668e-02, -5.401569118080999e-02, -3.496812143313850e-02, -8.123507318524154e-04, 1.212138349106524e-01, -8.159280685404466e-02,  3.514487134346805e-02, 3.547339403822855e-01, 8.171176096460897e-02, 4.538135085008629e-02, 6.133670558753212e-02, -4.390297112190376e-02, 2.318214683174692e-02, -1.583380502672094e-02, 2.796647241270560e-02, 3.754792729205765e-04,  4.703731031942416e-02, 2.219235143718046e-02, -1.882516166020858e-03, 4.538135085008103e-02, 1.639794594015089e-01,  1.056396875706231e-01, -6.766373150761112e-02, 3.604693255783164e-02, 9.737229146445807e-03, 5.778335415452213e-02,  2.629781228207055e-02, 3.016215218535812e-02, -4.478813926105686e-02, -3.789996094153091e-02, 6.133670558751405e-02,  1.056396875706250e-01, 3.970302405953996e-01, -1.996120996585702e-01, 1.219054391223120e-02, 6.975569092721312e-02,  1.719546349735608e-01, -6.450953848111093e-02, 1.266285871314356e-01, -6.727345289259330e-02, -4.806237907435786e-02, -4.390297112188937e-02, -6.766373150761229e-02, -1.996120996585712e-01, 2.378235364892681e-01, -3.216803445548669e-02, -1.839360908397079e-02, -1.310632184361520e-01, 5.580304265270060e-02, -6.760701679097658e-02, 1.465370194403191e-02,  3.250642483314026e-02, 2.318214683174451e-02, 3.604693255783104e-02, 1.219054391223142e-02, -3.216803445548686e-02,  1.419707970038930e-01, 4.010143368536914e-02, -5.042499740852557e-02, 4.017030370811858e-02, 5.216279113173972e-02, -4.014668089418783e-02, -5.003991864601273e-02, -1.583380502671543e-02, 9.737229146445300e-03, 6.975569092721164e-02, -1.839360908396905e-02, 4.010143368536839e-02, 1.942915646396777e-01, -1.107106505560581e-01, 8.718996602574111e-02,  4.770001951469588e-02, -1.695430317855846e-01,
                  -3.437313441099472e-02, 2.796647241268887e-02, 5.778335415452220e-02,  1.719546349735617e-01, -1.310632184361510e-01, -5.042499740852544e-02, -1.107106505560552e-01, 4.617931185208000e-01, -2.044585228399286e-01, -4.270742465647900e-02, 1.252021580913351e-01, -3.675102203493297e-02, 3.754792729270470e-04,  2.629781228207054e-02, -6.450953848111436e-02, 5.580304265270110e-02, 4.017030370811887e-02, 8.718996602574083e-02, -2.044585228399310e-01, 5.076140374564312e-01, -1.172044889252181e-01, -2.443659535181436e-01, 1.658669091227874e-01,  4.703731031942696e-02, 3.016215218535812e-02, 1.266285871314373e-01, -6.760701679097844e-02, 5.216279113174020e-02,  4.770001951469390e-02, -4.270742465647774e-02, -1.172044889252185e-01, 3.308714906616736e-01, 4.788970361033945e-02, -9.677024625911193e-02, 2.219235143718090e-02, -4.478813926105639e-02, -6.727345289258922e-02, 1.465370194402799e-02, -4.014668089418780e-02, -1.695430317855866e-01, 1.252021580913406e-01, -2.443659535181486e-01, 4.788970361033748e-02,  4.412633633110921e-01, 2.102777386401778e-02, -1.882516166013634e-03, -3.789996094153054e-02, -4.806237907435630e-02,  3.250642483313913e-02, -5.003991864601112e-02, -3.437313441099570e-02, -3.675102203493218e-02, 1.658669091227867e-01, -9.677024625911335e-02, 2.102777386401938e-02, 3.528092000246664e-01, 5.597995104300475e-02, 4.377994417395787e-02,  6.310285872530511e-02, -3.835985110182168e-02, 2.072677338411147e-02, 3.488844589337444e-03, 2.342988454853408e-02,  1.478629698043888e-02, 2.785747152707718e-02, -1.974084541837387e-02, -1.684288695522457e-02, 4.377994417395135e-02,  1.263617587513195e-01, 8.671548987701248e-02, -5.264081898699502e-02, 2.209619873270708e-02, -5.954123444288407e-03,  5.733003022896989e-02, -2.562921179300494e-04, 2.818707305056932e-02, -5.216210681675836e-03, -2.080465519278853e-02,  6.310285872528187e-02, 8.671548987701579e-02, 2.832422056726625e-01, -1.372089311135710e-01, 1.153046181242135e-02,  2.748500264075120e-02, 1.236453119508758e-01, -5.774836605528541e-02, 9.883774723275246e-02, -4.457098843223234e-03, -2.116513915934396e-02, -3.835985110180574e-02, -5.264081898699643e-02, -1.372089311135719e-01, 1.709956571520206e-01, -2.574076563927348e-02, -2.255419695772328e-03, -8.584076442003205e-02, 4.398032404882100e-02, -5.329430590008079e-02, -8.411442423823585e-03, 1.686924522839861e-02, 2.072677338410685e-02, 2.209619873270684e-02, 1.153046181242175e-02, -2.574076563927381e-02, 9.846522428367610e-02, 2.111595223227914e-02, -1.717001983800003e-02, 1.567258525420226e-02,  3.095928660913456e-02, -1.141976131912539e-02, -2.565413402843326e-02, 3.488844589332143e-03, -5.954123444286245e-03,  2.748500264075169e-02, -2.255419695771465e-03, 2.111595223227915e-02, 1.211383923834642e-01, -7.350043398939682e-02,  3.948873700801118e-02, 3.499404180056619e-02, -6.478548991394698e-02, 2.588339853622917e-03, 2.342988454852589e-02,  5.733003022896693e-02, 1.236453119508715e-01, -8.584076442002896e-02, -1.717001983800212e-02, -7.350043398940057e-02,  3.005981444189226e-01, -1.206536584402046e-01, -1.174835411752737e-02, 7.396440039008628e-02, -3.401992480091360e-02,  1.478629698043412e-02, -2.562921179274577e-04, -5.774836605529022e-02, 4.398032404882073e-02, 1.567258525420224e-02,  3.948873700800441e-02, -1.206536584401958e-01, 2.799931581889871e-01, -5.276594693058725e-02, -9.444973468960864e-02,  1.091196237725575e-01, 2.785747152707787e-02, 2.818707305057031e-02, 9.883774723275780e-02, -5.329430590008279e-02,  3.095928660913700e-02, 3.499404180057382e-02, -1.174835411753321e-02, -5.276594693057539e-02, 2.106586992434445e-01,  9.617090101862243e-03, -5.331362511354099e-02, -1.974084541835831e-02, -5.216210681677911e-03, -4.457098843217478e-03, -8.411442423826992e-03, -1.141976131912433e-02, -6.478548991393952e-02, 7.396440039007479e-02, -9.444973468961283e-02,  9.617090101876117e-03, 1.937817869355041e-01, -2.417474484117984e-02, -1.684288695521660e-02, -2.080465519278744e-02, -2.116513915934042e-02, 1.686924522839628e-02, -2.565413402843112e-02, 2.588339853624907e-03, -3.401992480091579e-02,  1.091196237725588e-01, -5.331362511354108e-02, -2.417474484118120e-02, 2.251510540766790e-01, 4.358836445264071e-02,  3.402486367601027e-02, 4.619646487578237e-02, -3.169810120866215e-02, 1.441911338367883e-02, -6.462344942766266e-03,  3.583080426369201e-02, -8.952298343405839e-03, 1.912078776823290e-02, -3.519840719594332e-03, -2.452937104564646e-02,  3.402486367600325e-02, 1.046580912277660e-01, 8.352934693937397e-02, -4.718383149599968e-02, 2.060171941752949e-02,  5.941916508247196e-03, 4.036806370027327e-02, 1.402112646301633e-02, 2.578443727160530e-02, -2.323950322455957e-02, -1.821482178209995e-02, 4.619646487575685e-02, 8.352934693937887e-02, 2.572751940225726e-01, -1.211348249647752e-01,  1.532027435494488e-02, 4.411491748646502e-02, 9.702641231346414e-02, -2.565553602946294e-02, 8.635353142832999e-02, -3.857920191909407e-02, -2.631827229622479e-02, -3.169810120864474e-02, -4.718383149600190e-02, -1.211348249647763e-01,  1.459324627081435e-01, -2.607978798419956e-02, -1.059194597243695e-02, -6.349039850358498e-02, 2.447180938246818e-02, -5.183682642311927e-02, 4.819702647661366e-03, 1.326583359991242e-02, 1.441911338367409e-02, 2.060171941752948e-02,  1.532027435494626e-02, -2.607978798420045e-02, 8.281113750281643e-02, 2.109109107005740e-02, -1.294113862884143e-02,  1.204553885038906e-02, 2.693844496719443e-02, -1.841256766785564e-02, -3.150156498877377e-02, -6.462344942771927e-03,  5.941916508250525e-03, 4.411491748646848e-02, -1.059194597243744e-02, 2.109109107005688e-02, 8.513445259977480e-02, -3.511347617297018e-02, 1.673923826171445e-02, 2.728767178422082e-02, -5.037701183684795e-02, -1.386474389153495e-02,  3.583080426368213e-02, 4.036806370026988e-02, 9.702641231345295e-02, -6.349039850357802e-02, -1.294113862884373e-02, -3.511347617297674e-02, 2.215447660647301e-01, -6.249333926517806e-02, 2.824959955661614e-03, 5.027042861878115e-02,  4.379922849321779e-03, -8.952298343409403e-03, 1.402112646301956e-02, -2.565553602946332e-02, 2.447180938246536e-02,  1.204553885038883e-02, 1.673923826170859e-02, -6.249333926516864e-02, 2.029638792942333e-01, -5.888687931243666e-02, -8.611573383397925e-02, 5.213264297034235e-02, 1.912078776823320e-02, 2.578443727160726e-02, 8.635353142833919e-02, -5.183682642312335e-02, 2.693844496719657e-02, 2.728767178422799e-02, 2.824959955660483e-03, -5.888687931242811e-02,  1.834507876854514e-01, 7.593974870537226e-03, -6.177463316282338e-02, -3.519840719578057e-03, -2.323950322456281e-02, -3.857920191908946e-02, 4.819702647658129e-03, -1.841256766785380e-02, -5.037701183683992e-02, 5.027042861876822e-02, -8.611573383398410e-02, 7.593974870551394e-03, 1.852704286929950e-01, 2.089206147909695e-04, -2.452937104563800e-02, -1.821482178209895e-02, -2.631827229621926e-02, 1.326583359990897e-02, -3.150156498877155e-02, -1.386474389153188e-02,  4.379922849319560e-03, 5.213264297034344e-02, -6.177463316282199e-02, 2.089206147890127e-04, 1.790857363514045e-01,  3.868115746490976e-02, 2.580276341331452e-02, 3.321201972357997e-02, -2.421978215335279e-02, 1.225656086454226e-02, -1.239796191552179e-02, 3.068347654348569e-02, -1.564048857624480e-02, 1.821433164694879e-02,
                  9.782499817305777e-03, -2.108143081031552e-02, 2.580276341330766e-02, 8.886301104285542e-02, 7.361321658294918e-02, -4.354605828000414e-02,  1.682461646524194e-02, 1.742273082058427e-03, 4.543152493593675e-02, 4.119945582876983e-03, 1.977677145513970e-02, -2.137687306743102e-02, -2.471266563678070e-02, 3.321201972355595e-02, 7.361321658295400e-02, 2.272124740382112e-01, -1.109947118410505e-01, 7.714227448961431e-03, 3.635442551648015e-02, 1.009481042851409e-01, -3.808657459030512e-02,  7.033227194750426e-02, -3.578186621273490e-02, -3.751802067294242e-02, -2.421978215333608e-02, -4.354605828000623e-02, -1.109947118410512e-01, 1.338181752843074e-01, -1.911601938271160e-02, -9.721735009170594e-04, -7.545328145381859e-02,  3.694446619415361e-02, -4.121847363530302e-02, -1.617262240759011e-04, 2.136891331915738e-02, 1.225656086453729e-02,  1.682461646524188e-02, 7.714227448962474e-03, -1.911601938271224e-02, 7.116402305170910e-02, 1.698167952038005e-02, -1.367205607900992e-02, 1.097910404444170e-02, 2.409125571986115e-02, -1.436104555617713e-02, -3.028729595154638e-02, -1.239796191552813e-02, 1.742273082061246e-03, 3.635442551648382e-02, -9.721735009177133e-04, 1.698167952037814e-02,  9.675553011261737e-02, -5.002535468304838e-02, 3.019054798717558e-02, 2.298425475444396e-02, -7.310038353238275e-02, -1.897711291132146e-02, 3.068347654347774e-02, 4.543152493593394e-02, 1.009481042851306e-01, -7.545328145381244e-02, -1.367205607901065e-02, -5.002535468305688e-02, 2.467271355517321e-01, -8.278983036724538e-02, -8.640861183071284e-03,  5.565652401733917e-02, -7.928831261802161e-03, -1.564048857625069e-02, 4.119945582879473e-03, -3.808657459030627e-02,  3.694446619415161e-02, 1.097910404443933e-02, 3.019054798717123e-02, -8.278983036723485e-02, 2.334280677057330e-01, -7.370264727098735e-02, -1.083381034689119e-01, 6.698538649050070e-02, 1.821433164694967e-02, 1.977677145514146e-02,  7.033227194751183e-02, -4.121847363530642e-02, 2.409125571986363e-02, 2.298425475445189e-02, -8.640861183075110e-03, -7.370264727097624e-02, 1.831615267990975e-01, 2.221250439537571e-02, -6.826261141304321e-02, 9.782499817323455e-03, -2.137687306743340e-02, -3.578186621273029e-02, -1.617262240792179e-04, -1.436104555617308e-02, -7.310038353237461e-02,  5.565652401732330e-02, -1.083381034689142e-01, 2.221250439539137e-02, 2.134292431471407e-01, 9.262850752182267e-03, -2.108143081030805e-02, -2.471266563678003e-02, -3.751802067293790e-02, 2.136891331915480e-02, -3.028729595154458e-02, -1.897711291131757e-02, -7.928831261805158e-03, 6.698538649050254e-02, -6.826261141304296e-02, 9.262850752179086e-03,  1.870805125230552e-01, 3.318987171900897e-02, 1.573588515350322e-02, 1.830164531699434e-02, -1.389874223014401e-02,  5.281476897328954e-03, -2.305742770788402e-02, 3.696167785773608e-02, -3.473499473409056e-02, 1.127646704078566e-02,  2.672487996944445e-02, -2.161013446803004e-02, 1.573588515349632e-02, 5.982718786386711e-02, 2.889549700991120e-02, -1.527283975997846e-02, 8.503456283031105e-03, -8.822344723774633e-03, 2.883430162169626e-02, -3.161705817088455e-03,  4.631517333195998e-03, -1.748457146074737e-03, -1.622286322401465e-02, 1.830164531696984e-02, 2.889549700991534e-02,  1.205838548747314e-01, -5.009942397675712e-02, -2.425707639280372e-03, 1.031705594531601e-02, 6.253234113059933e-02, -4.655604684993610e-02, 3.465297574496976e-02, 8.136157032500415e-03, -2.144213933361742e-02, -1.389874223012677e-02, -1.527283975997989e-02, -5.009942397675680e-02, 8.115642563271244e-02, -1.065081167976757e-02, 7.709001501744766e-03, -3.768504219138171e-02, 2.733453843052012e-02, -2.048557196192498e-02, -1.286827239517619e-02, 6.904052277297216e-03,  5.281476897324328e-03, 8.503456283032052e-03, -2.425707639276064e-03, -1.065081167976994e-02, 5.530303149392082e-02,  1.026955353988607e-02, -3.868042589463869e-03, -1.636817683894416e-03, 1.197921644262416e-02, -3.647036152179432e-03, -2.713274444968947e-02, -2.305742770789087e-02, -8.822344723771015e-03, 1.031705594532343e-02, 7.709001501741649e-03,  1.026955353988183e-02, 1.054337707754620e-01, -5.892049808275534e-02, 4.284202502728306e-02, 4.084505090918813e-03, -8.184693062739849e-02, -1.616825852228407e-02, 3.696167785772824e-02, 2.883430162169133e-02, 6.253234113058206e-02, -3.768504219137209e-02, -3.868042589464472e-03, -5.892049808277076e-02, 1.802870717025704e-01, -5.326137201700345e-02, -1.595089757327225e-03, 6.203680472657829e-02, 1.486458798768099e-02, -3.473499473409776e-02, -3.161705817084311e-03, -4.655604684992983e-02, 2.733453843051370e-02, -1.636817683900954e-03, 4.284202502727930e-02, -5.326137201698116e-02,  1.896034600748784e-01, -7.544245954811307e-02, -1.055783663506612e-01, 3.161289476233643e-02, 1.127646704078684e-02,  4.631517333198147e-03, 3.465297574497882e-02, -2.048557196192938e-02, 1.197921644262679e-02, 4.084505090929306e-03, -1.595089757333214e-03, -7.544245954809727e-02, 1.309681561232047e-01, 3.773462398706372e-02, -4.599742685796118e-02,  2.672487996946301e-02, -1.748457146078530e-03, 8.136157032498578e-03, -1.286827239517549e-02, -3.647036152171350e-03, -8.184693062738932e-02, 6.203680472654990e-02, -1.055783663506595e-01, 3.773462398708298e-02, 1.889242116510925e-01,  8.143154387076353e-03, -2.161013446802285e-02, -1.622286322401371e-02, -2.144213933361070e-02, 6.904052277293102e-03, -2.713274444968889e-02, -1.616825852228058e-02, 1.486458798768158e-02, 3.161289476233592e-02, -4.599742685796108e-02,  8.143154387073331e-03, 1.324443301483917e-01, 3.518243877246465e-02, 1.578462041977440e-02, 1.662078117709618e-02, -1.388295091298936e-02, 3.406231763602240e-03, -3.153696139884019e-02, 4.543837903679795e-02, -2.987090705770241e-02,  4.015668752444600e-03, 3.295306385561587e-02, -1.238147987514632e-02, 1.578462041976795e-02, 5.928630347594697e-02,  3.194477144433685e-02, -1.675255055784405e-02, 1.087831627643816e-02, -3.696044264544369e-03, 2.440310772342551e-02,  5.303185860882718e-03, 4.812483609790419e-03, -9.558064307341067e-03, -1.562275406065793e-02, 1.662078117707319e-02,  3.194477144434087e-02, 1.256380958657254e-01, -5.302905574782560e-02, -4.680540150211565e-05, 1.753795153691843e-02,  5.788593257069304e-02, -2.558424213655533e-02, 3.221969963201142e-02, -1.304189874573788e-02, -2.351912499644103e-02, -1.388295091297284e-02, -1.675255055784575e-02, -5.302905574782683e-02, 7.908862164947353e-02, -1.217173193969098e-02,  6.806661438998911e-03, -3.655183700681942e-02, 1.644095415214933e-02, -1.614750741119300e-02, -2.459734119803937e-03,  8.411099767472840e-03, 3.406231763597522e-03, 1.087831627643783e-02, -4.680540150245327e-05, -1.217173193969077e-02,  5.666084089062712e-02, 1.497442491974560e-02, -6.256621778438850e-03, 7.170366153079234e-04, 1.391476010828070e-02, -1.073543888066659e-02, -2.960718002160501e-02, -3.153696139884681e-02, -3.696044264544358e-03, 1.753795153691225e-02,  6.806661439002900e-03, 1.497442491974165e-02, 1.272196975024444e-01, -7.253047279078566e-02, 5.830708558264221e-02,  8.436374362126112e-03, -1.141994793126626e-01, -2.238315090188197e-02, 4.543837903679120e-02, 2.440310772342593e-02,  5.788593257069554e-02, -3.655183700681845e-02, -6.256621778435469e-03, -7.253047279078796e-02, 1.818134663109345e-01, -5.905273456424017e-02,
                  -2.868637734189749e-03, 7.619577397976175e-02, 8.315923867422735e-03, -2.987090705771047e-02,  5.303185860881099e-03, -2.558424213656882e-02, 1.644095415215179e-02, 7.170366152982350e-04, 5.830708558262652e-02, -5.905273456422034e-02, 1.925353968536600e-01, -6.043016591304433e-02, -1.180048933895161e-01, 3.836872344149943e-02,  4.015668752446248e-03, 4.812483609791690e-03, 3.221969963201678e-02, -1.614750741119492e-02, 1.391476010828468e-02,  8.436374362141192e-03, -2.868637734205199e-03, -6.043016591301936e-02, 1.198692152602268e-01, 2.618391769195668e-02, -3.900557126543813e-02, 3.295306385563435e-02, -9.558064307340207e-03, -1.304189874572291e-02, -2.459734119811965e-03, -1.073543888065876e-02, -1.141994793126526e-01, 7.619577397974894e-02, -1.180048933895286e-01, 2.618391769198181e-02,  2.229935111566278e-01, 1.645705868654344e-02, -1.238147987513953e-02, -1.562275406065810e-02, -2.351912499643751e-02,  8.411099767469215e-03, -2.960718002160677e-02, -2.238315090188654e-02, 8.315923867431744e-03, 3.836872344148952e-02, -3.900557126544078e-02, 1.645705868655068e-02, 1.328682327451591e-01, 3.714118390294955e-02, 1.780094898790507e-02,  2.361922740166334e-02, -1.786256105658001e-02, 2.800826959592741e-03, -3.005672004822169e-02, 5.061028740232701e-02, -2.558450321542670e-02, 9.375488215463690e-04, 2.710143472341046e-02, -8.938375236574529e-03, 1.780094898789887e-02,  6.057443357432225e-02, 3.245809790231314e-02, -1.970544336856320e-02, 1.109427749641707e-02, -4.902582371081301e-03,  2.504659569535776e-02, 3.561068214214968e-03, 6.719007561114648e-03, -8.954022971555828e-03, -1.534289065977650e-02,  2.361922740164159e-02, 3.245809790231755e-02, 1.460842354858560e-01, -6.523698461733719e-02, -1.209044640939816e-03,  2.567305994590982e-02, 5.571033999804395e-02, -2.110100418912339e-02, 4.517243885682654e-02, -2.104719847601077e-02, -2.126725107355804e-02, -1.786256105656458e-02, -1.970544336856517e-02, -6.523698461733859e-02, 8.671192563248353e-02, -1.500444939833294e-02, 7.831319272633124e-04, -3.125795929402617e-02, 7.121705936870345e-03, -2.228977693181229e-02,  9.008882460532820e-03, 7.579443295634186e-03, 2.800826959587293e-03, 1.109427749641629e-02, -1.209044640942995e-03, -1.500444939833084e-02, 5.938807784277762e-02, 1.871758034907758e-02, -1.157130776038525e-02, 9.193038437729572e-03,  1.334119414758406e-02, -1.482521897655541e-02, -2.772009465489091e-02, -3.005672004823018e-02, -4.902582371082408e-03,  2.567305994589714e-02, 7.831319272712869e-04, 1.871758034907195e-02, 1.353658786260171e-01, -8.175212320905985e-02,  6.247847763620293e-02, 2.304732407950599e-02, -1.090031748178057e-01, -1.994367215841274e-02, 5.061028740232452e-02,  2.504659569536001e-02, 5.571033999805670e-02, -3.125795929403180e-02, -1.157130776037811e-02, -8.175212320905795e-02,  1.901194806978594e-01, -6.493959927882730e-02, -6.598295153734989e-03, 6.902232741972106e-02, 2.887003501470461e-03, -2.558450321543880e-02, 3.561068214211736e-03, -2.110100418914485e-02, 7.121705936877337e-03, 9.193038437714419e-03,  6.247847763618007e-02, -6.493959927880079e-02, 1.809314565632642e-01, -4.738698209553611e-02, -9.825210827893174e-02,  3.845867764051725e-02, 9.375488215479198e-04, 6.719007561115523e-03, 4.517243885682818e-02, -2.228977693181132e-02,  1.334119414759008e-02, 2.304732407952614e-02, -6.598295153761442e-03, -4.738698209550044e-02, 1.215393211427238e-01,  8.079703455100704e-03, -3.711689258723937e-02, 2.710143472343172e-02, -8.954022971553725e-03, -2.104719847598956e-02,  9.008882460521405e-03, -1.482521897654382e-02, -1.090031748177921e-01, 6.902232741970574e-02, -9.825210827894663e-02,  8.079703455133310e-03, 1.946257174938296e-01, 2.118280460864147e-02, -8.938375236568798e-03, -1.534289065977696e-02, -2.126725107355564e-02, 7.579443295630987e-03, -2.772009465489438e-02, -1.994367215842144e-02, 2.887003501484355e-03,  3.845867764050352e-02, -3.711689258724442e-02, 2.118280460865229e-02, 1.337282487261468e-01, 3.721567651794819e-02,  1.774308033043163e-02, 2.535245852065382e-02, -1.763227835053749e-02, 1.937467245382686e-03, -2.649122139053900e-02,  5.366723804831447e-02, -2.458769815267896e-02, -6.434547898400778e-03, 1.567733541348410e-02, -1.357266955309398e-02,  1.774308033042594e-02, 5.823364071197408e-02, 2.461978887911226e-02, -1.534788243825851e-02, 7.745228956589504e-03, -9.710368220699171e-03, 2.457282505545787e-02, -1.003645772374752e-03, -4.842741180601145e-04, -3.918474336564108e-03, -1.199301497125140e-02, 2.535245852063340e-02, 2.461978887912047e-02, 1.310665461297283e-01, -5.519405084248980e-02, -8.047202196080794e-03, 1.219599164943801e-02, 5.486261111306896e-02, -1.983897444390045e-02, 1.827397099124433e-02, -1.757690512172458e-02, -1.117051176604691e-02, -1.763227835052290e-02, -1.534788243826282e-02, -5.519405084249202e-02,  8.311085652067340e-02, -1.182120633747921e-02, 9.561523794125320e-03, -2.926861951574359e-02, 5.742014766987810e-03, -6.990674303889001e-03, 9.171871126456193e-03, 3.468680231604138e-03, 1.937467245377530e-03, 7.745228956587147e-03, -8.047202196090598e-03, -1.182120633747350e-02, 5.802064053457948e-02, 1.140034620912769e-02, -8.430516473634367e-03,  1.058497113855259e-02, 5.013454248634912e-03, -7.108567645152138e-03, -1.845503377389644e-02, -2.649122139054725e-02, -9.710368220703116e-03, 1.219599164941144e-02, 9.561523794141200e-03, 1.140034620912208e-02, 9.968021074211826e-02, -5.998694382145830e-02, 4.423323680815435e-02, 1.398642150261472e-02, -6.506406562923207e-02, -6.818993000759373e-04,  5.366723804831348e-02, 2.457282505546820e-02, 5.486261111310197e-02, -2.926861951576012e-02, -8.430516473620290e-03, -5.998694382144331e-02, 1.703817817833378e-01, -4.366021081118480e-02, -1.338764247109286e-02, 3.767556088408813e-02, -7.916868599535953e-04, -2.458769815269152e-02, -1.003645772386803e-03, -1.983897444395330e-02, 5.742014767011522e-03,  1.058497113853290e-02, 4.423323680811999e-02, -4.366021081117218e-02, 1.427957163010488e-01, -2.915248075143731e-02, -6.365491608212596e-02, 2.476874692484477e-02, -6.434547898399124e-03, -4.842741180587796e-04, 1.827397099124662e-02, -6.990674303887703e-03, 5.013454248642139e-03, 1.398642150263940e-02, -1.338764247112564e-02, -2.915248075139323e-02,  9.535829210368971e-02, 4.848354984519406e-03, -1.834442765361889e-02, 1.567733541350482e-02, -3.918474336557731e-03, -1.757690512168045e-02, 9.171871126432011e-03, -7.108567645140868e-03, -6.506406562921760e-02, 3.767556088409338e-02, -6.365491608215859e-02, 4.848354984558890e-03, 1.343784571963818e-01, 3.470579716479807e-03, -1.357266955308902e-02, -1.199301497125489e-02, -1.117051176605081e-02, 3.468680231603957e-03, -1.845503377390349e-02, -6.818993000928921e-04, -7.916868599342776e-04, 2.476874692481917e-02, -1.834442765362594e-02, 3.470579716503204e-03, 1.016925687660520e-01,  4.321971207119854e-02, 1.956476620463100e-02, 2.489685926849219e-02, -1.861487238954306e-02, 2.243636825822945e-03, -3.183658991377039e-02, 6.500944437381201e-02, -2.495119680293242e-02, -1.118278411350104e-02, 1.860780240351692e-02, -1.043300297495678e-02, 1.956476620462499e-02, 7.902513964316007e-02, 3.743757429774125e-02, -2.115971709043254e-02,  1.407678850911955e-02, -7.670494913596657e-03, 3.318514451806567e-02,
                  3.386876714042598e-03, 3.388310739942904e-03, -1.573952377472757e-02, -2.117419677917748e-02, 2.489685926847111e-02, 3.743757429774852e-02, 1.435510531826900e-01, -5.241812990643402e-02, -7.544946571048518e-03, 1.423153147548789e-02, 6.571573059980584e-02, -1.433234479001455e-02,  2.244772199377904e-02, -2.095915873696458e-02, -9.220846337025856e-03, -1.861487238952798e-02, -2.115971709043618e-02, -5.241812990643580e-02, 9.454271029648909e-02, -1.572634359572563e-02, 1.586859633980586e-02, -3.726587657965097e-02,  7.867428382706265e-03, -1.097858267128712e-02, 2.555230294484984e-03, 6.014867818006364e-04, 2.243636825818098e-03,  1.407678850911843e-02, -7.544946571054416e-03, -1.572634359572268e-02, 7.597409762298424e-02, 6.985786692420226e-03, -5.774991458904755e-04, -1.310673677717700e-04, 1.181128213810048e-02, -2.654268641927082e-03, -3.298176557153513e-02, -3.183658991377833e-02, -7.670494913598322e-03, 1.423153147547124e-02, 1.586859633981527e-02, 6.985786692413593e-03,  1.177413459245218e-01, -6.852912356382523e-02, 3.376193788499560e-02, 2.018959277641430e-02, -7.315060373647908e-02, -7.525887471344778e-03, 6.500944437380926e-02, 3.318514451807103e-02, 6.571573059982405e-02, -3.726587657965830e-02, -5.774991458794565e-04, -6.852912356382224e-02, 2.142115386103429e-01, -3.426902415894828e-02, -1.303768735845819e-02,  4.610311069242434e-02, 3.496853727468219e-03, -2.495119680294382e-02, 3.386876714034608e-03, -1.433234479005291e-02,  7.867428382720920e-03, -1.310673677903940e-04, 3.376193788496806e-02, -3.426902415892874e-02, 1.563632548765068e-01, -3.589515326121134e-02, -6.364417534375133e-02, 2.774566883648966e-02, -1.118278411349932e-02, 3.388310739945166e-03,  2.244772199378398e-02, -1.097858267128776e-02, 1.181128213810692e-02, 2.018959277643781e-02, -1.303768735848552e-02, -3.589515326117115e-02, 1.226896342589492e-01, 4.478866840940319e-03, -2.258202694954642e-02, 1.860780240353729e-02, -1.573952377472398e-02, -2.095915873693371e-02, 2.555230294469357e-03, -2.654268641914065e-03, -7.315060373646420e-02,  4.610311069241346e-02, -6.364417534377464e-02, 4.478866840978552e-03, 1.716407305563972e-01, 2.803102663107689e-02, -1.043300297495117e-02, -2.117419677918010e-02, -9.220846337027799e-03, 6.014867817996650e-04, -3.298176557154068e-02, -7.525887471357601e-03, 3.496853727483373e-03, 2.774566883646878e-02, -2.258202694955169e-02, 2.803102663109515e-02,  1.484426464460484e-01 ))

  expect_equal(c(result_exp$lag_one_cov),
               c(NULL ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(10 ))

  expect_equal(c(result_exp$Q),
               c( 0.09838852237126759, 0.05140918756478066, 0.11378507294515343, -0.09078805806262612, 0.02719767155293180, -0.05290452939263308,  0.07070072659809151, -0.05554707944678014, 0.11526395792495003, 0.11881884070868155, 0.02692412203630609, 0.05140918756478066,  0.18070898587386780, 0.38624749510275336, -0.23089328553314165, 0.05502541870514686, 0.09953844046870351, 0.20787769897346381,  0.04569575566736697, 0.07512156562174019, -0.20190286296130458, -0.10242053211100018, 0.11378507294515343, 0.38624749510275336,  1.56608602278498887, -0.86319307760929265, 0.06112478078223799, 0.43793191478287519, 0.82260478646035451, -0.28413741056078473,  0.43927901470634712, -0.56964149484040150, -0.40739492529819687, -0.09078805806262612, -0.23089328553314165, -0.86319307760929265,  0.53862760774702922, -0.03601608629558598, -0.14621803528743477, -0.57630403946470055, 0.25410269303610433, -0.23778632643303871,  0.18690631641477357, 0.22676602136325572, 0.02719767155293180, 0.05502541870514686, 0.06112478078223799, -0.03601608629558598,  0.13150468182004410, 0.18384054612210302, -0.23223041189381555, 0.20934184577675780, 0.11494013792053398, -0.23330587728650082, -0.06178030957995829, -0.05290452939263308, 0.09953844046870351, 0.43793191478287519, -0.14621803528743477, 0.18384054612210302,  0.79751653056014415, -0.60588921969678178, 0.71241919118590546, 0.19919278837192433, -1.05668917820002184, -0.12448776882467145,  0.07070072659809151, 0.20787769897346381, 0.82260478646035451, -0.57630403946470055, -0.23223041189381555, -0.60588921969678178,  1.72585199125573086, -1.23609558379502849, -0.04727168238344588, 0.74345070955969850, -0.30242464802816338, -0.05554707944678014,  0.04569575566736697, -0.28413741056078473, 0.25410269303610433, 0.20934184577675780, 0.71241919118590546, -1.23609558379502849,  1.91750486405226250, -0.34381881737516251, -1.31417418088687787, 0.55763211720650641, 0.11526395792495003, 0.07512156562174019,  0.43927901470634712, -0.23778632643303871, 0.11494013792053398, 0.19919278837192433, -0.04727168238344588, -0.34381881737516251,  0.57625369753258326, 0.01805390567072239, -0.28623143334541323, 0.11881884070868155, -0.20190286296130458, -0.56964149484040150,  0.18690631641477357, -0.23330587728650082, -1.05668917820002184, 0.74345070955969850, -1.31417418088687787, 0.01805390567072239,  1.70627043743598716, 0.06655144230407503, 0.02692412203630609, -0.10242053211100018, -0.40739492529819687, 0.22676602136325572, -0.06178030957995829, -0.12448776882467145, -0.30242464802816338, 0.55763211720650641, -0.28623143334541323, 0.06655144230407503,  0.57769489356176029 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(2007, 1936, 1882, 1818, 1767, 1656, 1543, 1364, 1254, 1103 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})






test_that("UKF second order model works", {
  for(m in c("logit", "exponential")){
    expect_no_error(result <- ddhazard(
      formula = survival::Surv(start, stop, event) ~ group,
      data = head_neck_cancer,
      by = 1, Q_0 = diag(1, 4),
      Q = diag(1e-1, 2),
      control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3,
                     method = "UKF", save_data = F, save_risk_set = F,
                     beta = 0),
      max_T = 30,
      id = head_neck_cancer$id, order = 2,
      verbose = F,
      model = m
    ))

    set.seed(9997)
    sim_f <- if(m == "logit") test_sim_func_logit else test_sim_func_exp
    sims <- sim_f(n_series = 1e3, n_vars = 3, t_0 = 0, t_max = 20,
                  x_range = 1, x_mean = 0.5, re_draw = T, beta_start = c(0, 1, 1),
                  intercept_start = -5, sds = c(.1, rep(1, 3)),
                  tstart_sampl_func = function(...) max(0, runif(1, min = -10, max = 20 - 1)))

    expect_no_error(result_sim <-
                      ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                               by = 1,
                               data = sims$res,
                               Q_0 = diag(c(rep(1, ncol(sims$res) + 1 - 4), rep(.01, ncol(sims$res) + 1 - 4))),
                               Q = diag(rep(1e-3, ncol(sims$res) + 1 - 4)),
                               control = list(est_Q_0 = F, method = "UKF", eps = 1e-2),
                               id = sims$res$id,
                               verbose = F, model = m,
                               order = 2,
                               max_T = 20))
  }

  # matplot(result$state_vecs[, 1:2], type = "l")
  #
  # matplot(result_sim$state_vecs[, 1:4], type = "l", lty = 2, ylim = range(
  #   result_sim$state_vecs[, 1:4], sims$betas))
  # matplot(sims$betas, type = "l", lty = 1, add = T)

  # get_expect_equal(result, file = "tmp.txt")
})



# Had issues with win builder. Thus, these lines
cat("\nFinished", test_name, "\n")
