set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$a_t_d_s, res_old$a_t_d_s)
  expect_equal(res_new$V_t_d_s, res_old$V_t_d_s)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$a_t_d_s, res_new_time$a_t_d_s)
  expect_equal(res$V_t_d_s, res_new_time$V_t_d_s)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  expect_equal(c(res$a_t_d_s),
               c(-1.02044380420273995, -1.02137045182381159, -0.84409375427726285, -0.72085298131780173, -0.58469121708859406, -0.56366588153185870, -0.57748004609843095, -0.56693857128147829, -0.62359832488672029, -0.53680702053023177, -0.59946321861764518, 1.88049311986896805, 1.87829824157486991, 1.82542261041619991,  1.80436755001335336, 1.86915575428792291, 2.11432158445751295, 2.44871115027625708, 2.80229963552436923, 2.82963169713453677, 2.79523516355331703,  2.63418703401005283, 0.77789003862143113, 0.77811712655274379, 0.66709848177852649, 0.59745843968683465, 0.53593086300178383, 0.57484359740119639,  0.63127243841162373, 0.64613735745903011, 0.65225992078018991, 0.57693785272685449, 0.57829105366964584, 0.99996819680651627, 1.00283701067709652,  0.83171670531715192, 0.67841145560989191, 0.47895601028017742, 0.26732860074112708, 0.01211588429835797, -0.27071819727906821, -0.22007081733158479, -0.28374678153176491, -0.07323579703933936 ))

  expect_equal(c(res$V_t_d_s),
               c( 0.1037455778335087953, 0.0231897069123925721, 0.0012826780162166727, -0.0272188661503642015, 0.0231897069123871875, 0.2450948187399515366, 0.0159893908502746346, -0.1225342619230826990, 0.0012826780162132952, 0.0159893908502736215, 0.0987473588981562234, 0.0075441966776641951, -0.0272188661503725143, -0.1225342619230825048,  0.0075441966776665119, 0.2348106993044061230, 0.0776529878463631529, 0.0273325060475695381, 0.0117607208034664484, -0.0087855065625662976, 0.0273325060475640147,  0.2037750847068677262, 0.0104677063523493930, -0.1008544409386675778, 0.0117607208034628541, 0.0104677063523483556, 0.0845497939755520678, 0.0005106310981705733, -0.0087855065625754014, -0.1008544409386675084, 0.0005106310981730922, 0.1900310998705317944, 0.0658749970002237006, 0.0287720910104220795, 0.0140589495245088542, -0.0045723376989168785, 0.0287720910104221211, 0.1851928389128045527, 0.0087856140178648474, -0.0920206346125566482, 0.0140589495245088542, 0.0087856140178648318,  0.0774852820132369835, 0.0005867478029597962, -0.0045723376989169062, -0.0920206346125567037, 0.0005867478029598309, 0.1745292136768372415, 0.0608776632518496230,  0.0278680941933621557, 0.0142188254501997152, -0.0028697937758827043, 0.0278680941933621834, 0.1673784788785931399, 0.0074345674305618436, -0.0815714083192076445,  0.0142188254501997013, 0.0074345674305618436, 0.0718913538475187686, 0.0012841030957655482, -0.0028697937758827008, -0.0815714083192076583, 0.0012841030957655691,  0.1599061742657770235, 0.0600754184792321802, 0.0273199230531985804, 0.0134072755662569230, -0.0023049250293727744, 0.0273199230531985769, 0.1554034411849257724,  0.0058108540187847540, -0.0743338345470364453, 0.0134072755662569126, 0.0058108540187847418, 0.0685070925947765114, 0.0022508866649087970, -0.0023049250293727622, -0.0743338345470364315, 0.0022508866649087753, 0.1487049462279606826, 0.0603571592779261409, 0.0273120773534237735, 0.0131209535780405281, -0.0017064872787548660,  0.0273120773534237526, 0.1494079427452755793, 0.0039838988056467607, -0.0701915067873854492, 0.0131209535780405073, 0.0039838988056467434, 0.0665063081129196459,  0.0031428721171553090, -0.0017064872787548313, -0.0701915067873854770, 0.0031428721171552622, 0.1419309611910842261, 0.0613303242686220051, 0.0273382739440017584,  0.0129534143780623175, -0.0012858565620631618, 0.0273382739440017584, 0.1571694740209243490, 0.0040756363277770907, -0.0736048462072112497, 0.0129534143780623001,  0.0040756363277770890, 0.0675949496072885125, 0.0035638829522881103, -0.0012858565620631522, -0.0736048462072112775, 0.0035638829522880991, 0.1442984163430317546,  0.0635614455161135627, 0.0270955911498761623, 0.0132906978025158565, -0.0004891285980739481, 0.0270955911498761727, 0.1733275147832509799, 0.0060884033586088605, -0.0823595826338606452, 0.0132906978025158357, 0.0060884033586088588, 0.0707597385774047238, 0.0019374476046673389, -0.0004891285980739325, -0.0823595826338606452,  0.0019374476046673207, 0.1527635555675282975, 0.0668100452670697398, 0.0266080993276297945, 0.0140077889394891967, 0.0002372554067622979, 0.0266080993276297875,  0.1990090716747520694, 0.0092830366307054980, -0.0969749363862290881, 0.0140077889394891950, 0.0092830366307055014, 0.0753516269866731370, -0.0006000090899331142,  0.0002372554067622962, -0.0969749363862291158, -0.0006000090899331233, 0.1678412761773808992, 0.0734792555174980933, 0.0271343817727065229, 0.0135309296040969067, -0.0021797923910697060, 0.0271343817727065159, 0.2373963578471150748, 0.0124257914014350365, -0.1214107942796310569, 0.0135309296040969050, 0.0124257914014350383,  0.0823854088641458038, -0.0017171187123527650, -0.0021797923910696973, -0.1214107942796310846, -0.0017171187123527563, 0.1962322056994400821, 0.0860965497217900666,  0.0287534499942547969, 0.0111246310159169338, -0.0096896925858158262, 0.0287534499942547934, 0.2942464518487821201, 0.0173140128796465675, -0.1602872363757563978,  0.0111246310159169373, 0.0173140128796465710, 0.0918147992562737408, -0.0026675326892060241, -0.0096896925858158262, -0.1602872363757563978, -0.0026675326892060119,  0.2414367667840628673 ))

  expect_equal(c(res$n_iter),
               c(13 ))

  expect_equal(c(res$Q),
               c( 0.034243664001520860, 0.004629030068920106, -0.013266591044440113, -0.034128876575844208, 0.004629030068920106, 0.117896754643346993, 0.010782807516640930, -0.088439612698669706, -0.013266591044440113, 0.010782807516640930, 0.018444077622435183, 0.007285169546703585, -0.034128876575844208, -0.088439612698669706,  0.007285169546703585, 0.116959364969516907 ))

  expect_equal(c(res$Q_0),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$order),
               c(1 ))

  expect_equal(c(res$F_),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$method),
               c("UKF" ))

  expect_equal(c(res$model),
               c("logit" ))

  expect_equal(c(res$est_Q_0),
               c(FALSE ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  m1 <- do.call(ddhazard, arg_list)

  arg_list$control$beta <- 2

  m2 <- do.call(ddhazard, arg_list)

  expect_true(class(all.equal(m1$a_t_d_s, m2$a_t_d_s)) == "character")
  expect_true(class(all.equal(m1$V_t_d_s, m2$V_t_d_s)) == "character")
  expect_true(class(all.equal(m1$lag_one_cor, m2$lag_one_cor)) == "character")
})


test_that("Implement cont time model for UKF when Feodor aggress on implementation", {
  expect_true(F)
})
