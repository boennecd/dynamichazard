if(interactive()){
  library(dynamichazard); library(testthat); library(survival); source("R/test_utils.R")
}

set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$state_vecs, res_old$state_vecs)
  expect_equal(res_new$state_vars, res_old$state_vars)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$state_vecs, res_new_time$state_vecs)
  expect_equal(res$state_vars, res_new_time$state_vars)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  # get_expect_equal(res, file = "get_expect_equal.txt")

  expect_equal(c(res$state_vecs),
               c(-1.2523134932512461, -1.2527275015618569, -0.9077658184501548, -0.8785872995949650, -0.5778546027822988, -0.5519123261225787, -0.5813354806022529, -0.5107156838397143, -0.7109421507219802, -0.4143543106345482, -0.5821485317572963, 2.0797091121540054,  2.0966644346866534, 1.6660064116534976, 1.5759940541462967, 1.3596152305108589, 1.7569362733754790, 2.4515627883025091,  3.6897065316125879, 3.5709271868789489, 3.1643081087558347, 2.3553026338986358, 0.9310008540215439, 0.9335859966850538,  0.6794347394960744, 0.6509097257606298, 0.4643707024714062, 0.5279956294570556, 0.6496084407270231, 0.7561999260384598,  0.8158174219224759, 0.5741219780298368, 0.5393010630309369, 1.2164252146215278, 1.2041271199856405, 1.1325660886377484,  1.1431337413794311, 0.9701428202807645, 0.6385584271135097, 0.1297769137618259, -0.8905000726770533, -0.5626549468656443, -0.5781469091620129, 0.2457468129715883 ))

  expect_equal(c(res$state_vars),
               c( 0.1253912443884652728, -0.0001409690234737285, -0.0146139848560780210, -0.0379006853514499975, -0.0001409690234732844,  0.4278785933549378306, 0.0545619809043480994, -0.2413686332847996274, -0.0146139848560783020, 0.0545619809043481063,  0.1121976890345955935, -0.0043077438114269666, -0.0379006853514485959, -0.2413686332847999882, -0.0043077438114268209,  0.3365784373540192664, 0.0782138685484559115, 0.0256664173180353866, 0.0100327926907035347, -0.0125041581085627296,  0.0256664173180354283, 0.3547162625383834533, 0.0343669705992700192, -0.2182748544886896069, 0.0100327926907032294,  0.0343669705992701094, 0.0884388986333659033, -0.0152184165007477334, -0.0125041581085608422, -0.2182748544886903286, -0.0152184165007476224, 0.2834100548941877462, 0.0559319157670168099, 0.0321865479390976844, 0.0182013088742298129, -0.0007177000733910172, 0.0321865479390977122, 0.3342120378144996518, 0.0321569429424430758, -0.2117895355534550883,  0.0182013088742298684, 0.0321569429424430342, 0.0779910894841757130, -0.0205789710920340763, -0.0007177000733909616, -0.2117895355534549218, -0.0205789710920340589, 0.2601048036707117594, 0.0429469282352172715, 0.0307328548813935384,  0.0229977283978007457, 0.0099068133373092504, 0.0307328548813936217, 0.2330413080260306247, 0.0196110719823978097, -0.1394121209237753067, 0.0229977283978007804, 0.0196110719823978860, 0.0669476688204122261, -0.0164338062833569234,  0.0099068133373093198, -0.1394121209237749182, -0.0164338062833567604, 0.1896000418495625284, 0.0428464886556561911,  0.0280996465477681943, 0.0211024536717795905, 0.0116462673184732704, 0.0280996465477682603, 0.2066486153999992359,  0.0166198761621389711, -0.1198928463012935430, 0.0211024536717796390, 0.0166198761621389746, 0.0633970680487046245, -0.0134372289494254817, 0.0116462673184732496, -0.1198928463012933765, -0.0134372289494253429, 0.1676674611686768956,  0.0427251659854689866, 0.0274480808547734774, 0.0214294824461973774, 0.0146914380657424751, 0.0274480808547733282,  0.1620344851166854450, 0.0076594796954128231, -0.0869934267712791365, 0.0214294824461974363, 0.0076594796954126583,  0.0587053006876303712, -0.0087742292544114343, 0.0146914380657424889, -0.0869934267712791920, -0.0087742292544114274,  0.1348176336765588845, 0.0433924796486155617, 0.0269795511083717812, 0.0205701406468566037, 0.0153204219258762063,  0.0269795511083717951, 0.1721376180519397225, 0.0073320111180690808, -0.0888318924946848165, 0.0205701406468565412,  0.0073320111180691840, 0.0598800021021439477, -0.0066142797264051850, 0.0153204219258762896, -0.0888318924946848165, -0.0066142797264052162, 0.1335838871188760324, 0.0458027695903417756, 0.0246112269259888099, 0.0201382969535762804,  0.0175657070383831229, 0.0246112269259888099, 0.2035455494941593169, 0.0145376046314689318, -0.1070859400059607641,  0.0201382969535762561, 0.0145376046314689006, 0.0642869885105214617, -0.0115009131676806504, 0.0175657070383831125, -0.1070859400059607502, -0.0115009131676806192, 0.1470560996498474493, 0.0478435377945662099, 0.0189705448337635120,  0.0210907348757641659, 0.0232195845281978619, 0.0189705448337635016, 0.2570472690353847733, 0.0266638438433405081, -0.1345627095530523842, 0.0210907348757641520, 0.0266638438433404526, 0.0698383739183449370, -0.0207924700285044804,  0.0232195845281979035, -0.1345627095530523565, -0.0207924700285044700, 0.1638447015050878142, 0.0525954772773509979,  0.0158428603449477304, 0.0202519239986111710, 0.0237328433562699129, 0.0158428603449477234, 0.3079223902506980082,  0.0325596707809271343, -0.1639807146032329632, 0.0202519239986111814, 0.0325596707809270997, 0.0775668051732249786, -0.0229019897834410111, 0.0237328433562699788, -0.1639807146032328800, -0.0229019897834410041, 0.1932670001862853426,  0.0563265995017241117, 0.0188063442625668945, 0.0233122516376004577, 0.0260969200177724910, 0.0188063442625669049,  0.3717189687688129407, 0.0386886629463472215, -0.2105037013525632994, 0.0233122516376004923, 0.0386886629463472215,  0.0838384899282977603, -0.0320814485141299316, 0.0260969200177725465, -0.2105037013525632994, -0.0320814485141299177,  0.2308862443003361631 ))

  expect_equal(c(res$lag_one_cor),
               c( 7.003236375388522e+275, 7.304268153621279e+275, -8.910791670548508e+274, 9.092556343644846e+275, 4.096966229360316e+275,  4.273072955347481e+275, -5.212905947227448e+274, 5.319240174354705e+275, 4.554770670698092e+275, 4.750555967801761e+275, -5.795408062527892e+274, 5.913624321070539e+275, 5.783943462732931e+275, 6.032564342059974e+275, -7.359385356714426e+274,  7.509504035616370e+275, 6.799307287261669e+275, 7.546710315055493e+275, -7.762947161451158e+274, 9.288271266452088e+275,  4.239079597097284e+275, 4.705053672407170e+275, -4.839868171144979e+274, 5.790843030684563e+275, 4.586623686547295e+275,  5.090800992535318e+275, -5.236668358088980e+274, 6.265609597848181e+275, 5.685894500997177e+275, 6.310907401020562e+275, -6.491734630014537e+274, 7.767281031206254e+275, 6.684643038628992e+275, 7.383401497820681e+275, -8.050984113428170e+274,  9.512446361914669e+275, 4.613765658697504e+275, 5.096051364024294e+275, -5.556819385358309e+274, 6.565526102319040e+275,  4.844846043558586e+275, 5.351287021312320e+275, -5.835132602188366e+274, 6.894360380167402e+275, 5.829358390665916e+275,  6.438712317808941e+275, -7.020879278597376e+274, 8.295350805592114e+275, 7.248924159159162e+275, 7.750330882919467e+275, -1.099181724913794e+275, 9.767415335153281e+275, 4.879145504058562e+275, 5.216635082956793e+275, -7.398432448048348e+274,  6.574305313785171e+275, 5.254698971926833e+275, 5.618165513721376e+275, -7.967898343324994e+274, 7.080337191162689e+275,  6.438974460371797e+275, 6.884357115461654e+275, -9.763659956470431e+274, 8.676065096836519e+275, 8.296599590879030e+275,  8.685445008595978e+275, -1.552475042274298e+275, 1.029593223355170e+276, 5.324722737988083e+275, 5.574282092347685e+275, -9.963719554267557e+274, 6.607886022732432e+275, 5.793540062187612e+275, 6.065071968827754e+275, -1.084097919206632e+275,  7.189679966986401e+275, 7.140555692586350e+275, 7.475219590801629e+275, -1.336153972393339e+275, 8.861302358329373e+275,  9.490819355849130e+275, 1.076081822001163e+276, -1.964264251966004e+275, 1.129864147272302e+276, 5.551914192172594e+275,  6.294834740295913e+275, -1.149050062884865e+275, 6.609449152145249e+275, 6.162343780181297e+275, 6.986947990626611e+275, -1.275387418292317e+275, 7.336154065667997e+275, 7.714271534737831e+275, 8.746544483955879e+275, -1.596581626675448e+275,  9.183694792433157e+275, 1.062971292580569e+276, 1.182246756339878e+276, -2.645765419005672e+275, 1.307597849497145e+276,  6.376574213668634e+275, 7.092086336940138e+275, -1.587147241322983e+275, 7.844045071725275e+275, 6.995773069050053e+275,  7.780765178423114e+275, -1.741267576508976e+275, 8.605743056759494e+275, 8.601089668725910e+275, 9.566213530709158e+275, -2.140835389452167e+275, 1.058049867636068e+276, 1.194751235481580e+276, 1.323151891166083e+276, -3.433452779468460e+275,  1.665619466703503e+276, 6.511436165491754e+275, 7.211224245442910e+275, -1.871243815180285e+275, 9.077684551687152e+275,  7.459799525546582e+275, 8.261508803519449e+275, -2.143782626426110e+275, 1.039981122300125e+276, 9.348563483297681e+275,  1.035325939430863e+276, -2.686571925814144e+275, 1.303296356686144e+276, 1.249309854349707e+276, 1.359047546405569e+276, -4.046470451656858e+275, 2.943538632872136e+276, 4.026621952839241e+275, 4.380314992518378e+275, -1.304208615294882e+275,  9.487251891023338e+275, 5.659737258264708e+275, 6.156880942997615e+275, -1.833168889204873e+275, 1.333508673897374e+276,  7.940783730697657e+275, 8.638291460015207e+275, -2.571991777491507e+275, 1.870953279141287e+276, 3.708862226892077e+161,   4.303690099236476e-80, 5.340860205960691e+228, 1.115308778627661e+277, 4.562997700509277e-144, 2.422600893202835e-52,   1.160966434774022e-28, 7.070922061100410e+194, 2.220461363942529e+142, 2.033742144889103e-110, 2.646372323777622e-260,  3.804844204163747e-258, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00 ))

  expect_equal(c(res$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(res$n_iter),
               c(19 ))

  expect_equal(c(res$Q),
               c( 0.062859469725999845, -0.008064224128434744, -0.030833584241349465, -0.057689297818599078, -0.008064224128434744, 0.628550245621145143,  0.090116798709797497, -0.464222916829216237, -0.030833584241349465, 0.090116798709797497, 0.039583828085431393, -0.033676819067505637, -0.057689297818599078, -0.464222916829216237, -0.033676819067505637, 0.429796730687514894 ))

  expect_equal(c(res$Q_0),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  suppressMessages(m1 <- do.call(ddhazard, arg_list))

  arg_list$control$beta <- 2

  suppressMessages(m2 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m1$state_vecs, m2$state_vecs)) == "character")
  expect_true(class(all.equal(m1$state_vars, m2$state_vars)) == "character")
  expect_true(class(all.equal(m1$lag_one_cor, m2$lag_one_cor)) == "character")

  arg_list$control$alpha <- .1

  suppressMessages(m3 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m2$state_vecs, m3$state_vecs)) == "character")
  expect_true(class(all.equal(m2$state_vars, m3$state_vars)) == "character")
  expect_true(class(all.equal(m2$lag_one_cor, m3$lag_one_cor)) == "character")

  arg_list$control$kappa <- -1
  suppressMessages(m4 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m3$state_vecs, m4$state_vecs)) == "character")
  expect_true(class(all.equal(m3$state_vars, m4$state_vars)) == "character")
  expect_true(class(all.equal(m3$lag_one_cor, m4$lag_one_cor)) == "character")
})

arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                 by = 1,
                 data = NULL,
                 Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                 Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                 control = list(kappa = 0, alpha = 1, beta = 0,
                                est_Q_0 = F, method = "UKF", eps = 1e-2),
                 id = NULL,
                 verbose = F,
                 max_T = 10)

set.seed(2972)
sims <- test_sim_func_logit(n_series = 2e3, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -2, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

arg_list$data <- sims$res
arg_list$id <- sims$res$id

arg_list$control$beta <- 0
suppressMessages(fit1 <- do.call(ddhazard, arg_list))

arg_list$control$beta = 2
suppressMessages(fit2 <- do.call(ddhazard, arg_list))

matplot(sims$betas, type = "l", lty = 1, ylim = range(sims$betas, fit1$state_vecs, fit2$state_vecs))
matplot(fit1$state_vecs, type = "l", lty = 2, add = T)
matplot(fit2$state_vecs, type = "l", lty = 4, add = T)

diag(fit1$Q)
diag(fit2$Q)
