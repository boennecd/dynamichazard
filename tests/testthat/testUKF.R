if(interactive()){
  library(dynamichazard); library(testthat); library(survival); source("R/test_utils.R")
}

set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$state_vecs, res_old$state_vecs)
  expect_equal(res_new$state_vars, res_old$state_vars)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$state_vecs, res_new_time$state_vecs)
  expect_equal(res$state_vars, res_new_time$state_vars)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  # get_expect_equal(res, file = "tmp.txt")

  expect_equal(c(res$state_vecs),
               c(-1.82175475810386667, -1.82816927803518103, -1.52928743885032814, -0.91261339491150095, -0.80937439470323558, -0.71961976642752956, -0.82620200567099988, -0.34877009902600475, -0.67072222998575493, -0.35164715388816170, -0.45884785766393377, 1.74823354160711242, 1.71024425455886631, 1.17718210914339627,  1.82596386069990135, 1.08699694788124024, 1.27146339192872393, 1.73413938914166654, 3.80020270590380083, 4.17246844968774155, 3.45216585247874352,  2.11168367652384426, 0.87689474885067942, 0.83300010699138816, 0.15666462747638921, 1.10010266808821222, 0.58266251559216031, 0.55273990018173580,  1.13709059396185452, 2.25371994499357342, 2.06996560757513004, 0.28431749619368174, -1.73823667840769547, 1.49570540405658758, 1.55818015538102639,  1.99907889129901228, 0.14775095059684612, 0.80607371316883292, 0.61720237530801558, 0.04457011873143307, -2.49894051734825506, -2.14490779262878251, -0.75749721567875250, 1.67257240804977347 ))

  expect_equal(c(res$state_vars),
               c( 0.1833646061097586877, 0.0232351049161488195, -0.0318128400728157068, -0.0789784532342156925, 0.0232351049161476086, 0.4930336699579240811,  0.0157282603100363516, -0.2306446337073753128, -0.0318128400728183575, 0.0157282603100367298, 0.4804470527267734603, -0.2587458745288236384, -0.0789784532342187318, -0.2306446337073755071, -0.2587458745288236384, 0.5433561855029452881, 0.1126882756088086190, 0.0909164543443801987,  0.0637061938088744339, -0.1107553872974808562, 0.0909164543443795325, 0.5440529711191295359, 0.1570546385821474100, -0.4603261480073812528,  0.0637061938088717417, 0.1570546385821489921, 0.5281890320378079817, -0.4970416830587455204, -0.1107553872974856857, -0.4603261480073832512, -0.4970416830587454649, 0.8933492559869526950, 0.0806856943930435722, 0.0805776384598594630, 0.0635811040139241945, -0.0746937606538435328,  0.0805776384598590190, 0.5091446756278807939, 0.1964415880903630784, -0.4534065045719717912, 0.0635811040139234590, 0.1964415880903631617,  0.5328410059403529964, -0.5159707793405902132, -0.0746937606538426585, -0.4534065045719727349, -0.5159707793405903242, 0.8477145688411493740,  0.0676572981381723532, 0.0713986545387564342, 0.0698141853995124517, -0.0635917586655196931, 0.0713986545387576138, 0.4080545873498140352,  0.1508938560522591343, -0.3505495140486254990, 0.0698141853995134926, 0.1508938560522620487, 0.3838368964012836004, -0.3830535792435117437, -0.0635917586655209005, -0.3505495140486272199, -0.3830535792435074693, 0.6666015613288149844, 0.0497615542912576009, 0.0303834273992316592,  0.0257645184261139706, 0.0161330273255860523, 0.0303834273992330817, 0.2272090813718311564, 0.0493493178876202865, -0.1291424779926476640,  0.0257645184261148449, 0.0493493178876207028, 0.2306499147754653423, -0.1635734543880585923, 0.0161330273255859552, -0.1291424779926444444, -0.1635734543880545955, 0.2755178384476562048, 0.0519218659164402963, 0.0395042663500205296, 0.0348143499925336677, 0.0023863114700490157,  0.0395042663500186908, 0.2222476241472097769, 0.0561537197411941386, -0.1457618847680276775, 0.0348143499925318428, 0.0561537197411938402,  0.2121069069191763856, -0.1616338575037951641, 0.0023863114700515067, -0.1457618847680302587, -0.1616338575037977177, 0.2930330717713161004,  0.0516412388469874792, 0.0419426819725856048, 0.0347854357674662676, 0.0002014022736995386, 0.0419426819725825933, 0.2423603262642068101,  0.0635649822790533281, -0.1652837637595204467, 0.0347854357674637349, 0.0635649822790487345, 0.2144100464416551777, -0.1678859314671292957,  0.0002014022737031641, -0.1652837637595201969, -0.1678859314671349023, 0.3148092018941338610, 0.0561875893944335653, 0.0475707483554089205,  0.0314552440514770659, -0.0032283424235968888, 0.0475707483554104610, 0.2851191673215316968, 0.0869861382185206644, -0.2053799073918136653,  0.0314552440514783635, 0.0869861382185214693, 0.2763162947652617607, -0.2175140067817649125, -0.0032283424235991405, -0.2053799073918126106, -0.2175140067817634137, 0.3746982635585577315, 0.0591078744897894776, 0.0508212443943900777, 0.0307642595533897042, 0.0033480570387506570,  0.0508212443943898209, 0.3442642524621976063, 0.1201042444549735577, -0.2402052939823175748, 0.0307642595533898291, 0.1201042444549744737,  0.2860801061231120768, -0.2192321600484086475, 0.0033480570387501170, -0.2402052939823186573, -0.2192321600484083977, 0.3530824161290353480,  0.0625685873042029911, 0.0402427834238226617, 0.0225355172149302868, 0.0125907107689490066, 0.0402427834238228005, 0.4170991741098601935,  0.1272507593715579977, -0.2626415069673372349, 0.0225355172149305227, 0.1272507593715583862, 0.3376217781973919752, -0.2481164754595842625,  0.0125907107689489685, -0.2626415069673371794, -0.2481164754595835964, 0.3824643681831367825, 0.0697745568389629423, 0.0677900421695364908,  0.0534125304243987867, -0.0256178704377758859, 0.0677900421695364908, 0.5429543088458619327, 0.1465352942419799742, -0.3754809308702820037,  0.0534125304243987728, 0.1465352942419793081, 0.3819197511324383676, -0.3389127484829057568, -0.0256178704377760524, -0.3754809308702815596, -0.3389127484829055348, 0.5732127462071732182 ))

  # expect_equal(c(res$lag_one_cor),
  #              c( 4.871779447872124e+293, 2.193614475440825e+293, 3.209660757905688e+293, 4.806166883957096e+293, 2.358964301975204e+293, 1.062170054131070e+293,  1.554149819458110e+293, 2.327194042731588e+293, 3.317579677340855e+293, 1.493805473238703e+293, 2.185711692313428e+293, 3.272898896744804e+293,  4.406560172163602e+293, 1.984140350356192e+293, 2.903161650333168e+293, 4.347213127816637e+293, 4.740362922826458e+293, 2.602496292023533e+293,  3.559673713923266e+293, 4.514537143149831e+293, 2.193189269263895e+293, 1.204078049273454e+293, 1.646928372058544e+293, 2.088708096667385e+293,  3.070033857521643e+293, 1.685472581036656e+293, 2.305375980993074e+293, 2.923780753952289e+293, 4.688982861979125e+293, 2.574288237067395e+293,  3.521090960873426e+293, 4.465604773015126e+293, 4.716521264834387e+293, 2.829042840552353e+293, 3.633099772316870e+293, 4.311110053801182e+293,  2.677353632555843e+293, 1.605918366632214e+293, 2.062344750859918e+293, 2.447220210571425e+293, 3.457850884492571e+293, 2.074072762357157e+293,  2.663555734354728e+293, 3.160629386710647e+293, 4.511561797952357e+293, 2.706104963284795e+293, 3.475221083628409e+293, 4.123767991997105e+293,  5.093707294847870e+293, 2.865713242818071e+293, 3.473528288639318e+293, 4.421777581669654e+293, 3.215181780224735e+293, 1.808857178538091e+293,  2.192514061030648e+293, 2.791055295063842e+293, 3.794737094684200e+293, 2.134914261023370e+293, 2.587727539756133e+293, 3.294159330783843e+293,  4.684293897779332e+293, 2.635377786567344e+293, 3.194338901784697e+293, 4.066371415590191e+293, 5.725617579999433e+293, 3.055996707369436e+293,  3.985395749454510e+293, 4.613267549259961e+293, 3.522990629529785e+293, 1.880364452132597e+293, 2.452226626057248e+293, 2.838558132895471e+293,  3.646894126438387e+293, 1.946496825329670e+293, 2.538471378352098e+293, 2.938390155125698e+293, 5.003451567880111e+293, 2.670547116233630e+293,  3.482722052706998e+293, 4.031401054975360e+293, 6.180775854187295e+293, 3.246460390016874e+293, 4.361680810305739e+293, 5.270060634512209e+293,  4.050097814277050e+293, 2.127319035657417e+293, 2.858093277145093e+293, 3.453330384483253e+293, 3.701145262080296e+293, 1.944031263146693e+293,  2.611842695255334e+293, 3.155794742999213e+293, 4.993122131307797e+293, 2.622643759330896e+293, 3.523571392559703e+293, 4.257403440652183e+293,  6.679726287603915e+293, 3.615408891395456e+293, 5.117702535625310e+293, 5.388975649387590e+293, 5.672612549821889e+293, 3.070307519655004e+293,  4.346097786030250e+293, 4.576470589241197e+293, 3.187473813522803e+293, 1.725223560116010e+293, 2.442097492524114e+293, 2.571545303587076e+293,  5.504171032011231e+293, 2.979138370658145e+293, 4.217045554593174e+293, 4.440577709990731e+293, 8.146297492879453e+293, 4.544191205470328e+293,  6.603254224064209e+293, 4.567737719902673e+293, 1.102641796011552e+294, 6.150788326352435e+293, 8.937832314014134e+293, 6.182659702258098e+293,  1.977364933557401e+293, 1.103019420654729e+293, 1.602819361979145e+293, 1.108734906982931e+293, 5.525425185245084e+293, 3.082208642051433e+293,  4.478818411199936e+293, 3.098179640407795e+293, 1.063038925378250e+294, 1.976040534243303e+293, 5.065285333359586e+293, 7.291906987052362e+293,  2.928754426838076e+294, 5.444144446749495e+293, 1.395525270911062e+294, 2.008976751328475e+294, 2.791580698610527e+293, 5.189157690630040e+292,  1.330163217168202e+293, 1.914882542412600e+293, -1.416173530166983e+293, -2.632468324842064e+292, -6.747940118274109e+292, -9.714230977787409e+292,  1.714390355572542e+161, 5.544830413494099e+199, 7.848758931442511e-85, 4.562956623587279e-144, 1.227974270664481e+295, 5.646192149496897e-62,  6.322759456332708e+233, 3.684214138454974e+180, 4.235093475207102e+175, 3.260424692761878e-311, 3.320923413632382e-311, -2.082611459474571e-309,  5.928787750094959e-323, 7.905050333459945e-323, 1.914040203450182e-311, 6.475189814570930e+170 ))

  expect_equal(c(res$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(res$n_iter),
               c(27 ))

  expect_equal(c(res$Q),
               c( 0.14011877108026924, 0.13402085109470754, 0.06538551832042985, -0.28695364304449644, 0.13402085109470754, 1.29399441215636624, 1.01413854447444840, -1.63275017613479267, 0.06538551832042985, 1.01413854447444840, 1.51761102050455787, -1.80248535474546578, -0.28695364304449644, -1.63275017613479267, -1.80248535474546578, 2.63489164551056554 ))

  expect_equal(c(res$order),
               c(1 ))

  expect_equal(c(res$F_),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$method),
               c("UKF" ))

  expect_equal(c(res$model),
               c("logit" ))

  expect_equal(c(res$est_Q_0),
               c(FALSE ))

  expect_equal(c(res$LR),
               c(1 ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  suppressMessages(m1 <- do.call(ddhazard, arg_list))

  arg_list$control$beta <- 2

  suppressMessages(m2 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m1$state_vecs, m2$state_vecs)) == "character")
  expect_true(class(all.equal(m1$state_vars, m2$state_vars)) == "character")
  expect_true(class(all.equal(m1$lag_one_cor, m2$lag_one_cor)) == "character")

  arg_list$control$alpha <- .1
  arg_list$control$kappa <- 4 / (.1)^2 + 4

  suppressMessages(m3 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m2$state_vecs, m3$state_vecs)) == "character")
  expect_true(class(all.equal(m2$state_vars, m3$state_vars)) == "character")
  expect_true(class(all.equal(m2$lag_one_cor, m3$lag_one_cor)) == "character")

  arg_list$control$beta <- 0
  arg_list$control$alpha <- 1
  arg_list$control$kappa <- .5

  suppressMessages(m4 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m3$state_vecs, m4$state_vecs)) == "character")
  expect_true(class(all.equal(m3$state_vars, m4$state_vars)) == "character")
  expect_true(class(all.equal(m3$lag_one_cor, m4$lag_one_cor)) == "character")
})

arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                 by = 1,
                 data = NULL,
                 Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                 Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                 control = list(kappa = 0, alpha = 1, beta = 0,
                                est_Q_0 = F, method = "UKF", eps = 1e-2),
                 id = NULL,
                 verbose = F,
                 max_T = 10)

set.seed(2972)
sims <- test_sim_func_logit(n_series = 2e3, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -2, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

arg_list$data <- sims$res
arg_list$id <- sims$res$id

arg_list$control$beta <- 0
suppressMessages(fit1 <- do.call(ddhazard, arg_list))

arg_list$control$beta = 2
suppressMessages(fit2 <- do.call(ddhazard, arg_list))

# matplot(sims$betas, type = "l", lty = 1, ylim = range(sims$betas, fit1$state_vecs, fit2$state_vecs))
# matplot(fit1$state_vecs, type = "l", lty = 2, add = T)
# matplot(fit2$state_vecs, type = "l", lty = 4, add = T)

diag(fit1$Q)
diag(fit2$Q)
