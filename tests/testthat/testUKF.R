if(interactive()){
  library(dynamichazard); library(testthat); library(survival); source("R/test_utils.R")
}

test_that("UKF on head_neck works with logit model", {
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3,
                   method = "UKF", save_data = F, save_risk_set = F,
                   beta = 0),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "logit"
  ))
  # sink()
  # close(tmp)
  # matplot(result$state_vecs, type = "l")
  # get_expect_equal(result, file = "tmp.txt")

  expect_equal(c(result$state_vecs),
               c(-3.25347027308416026, -3.25348518175704404, -3.07342297817660404, -2.87982776868289525, -2.71347411931766302, -2.50760195207121583, -2.55500433010638028, -2.76551303378312863, -2.91591789772243404, -3.03593361486824076, -3.15363581560333550, -3.29563166961682663, -3.39498160370249646, -3.46082875960332847, -3.44894126638617138, -3.50314447916955096, -3.58489014221007407, -3.65715012061161060, -3.67623578540701290, -3.73929106974020131, -3.76086648729047113, -3.83675699388854863, -3.92950260901732040, -3.99630802914913863, -4.03781317499296399, -4.10386467010477496, -4.14807220495404927, -4.17192273805562674, -4.22527834757904230, -4.26052602151125193, -4.27802923398206314, 0.28314467098939328,  0.28341711307973327, 0.37231662657832926, 0.47912596350538245, 0.51602204998918177,  0.64273401925061979, 0.63026427351929037, 0.52474837435392385, 0.51660691233764056,  0.48497461421975291, 0.44557013767825299, 0.38202020930963870, 0.35860362561966602,  0.37128814204774874, 0.42253124791109881, 0.38636811791189363, 0.33625567805297429,  0.30787397938688410, 0.30322634897375350, 0.27662974349485103, 0.26821424113066467,  0.19384419558199328, 0.12717072340937846, 0.06995745919561791, 0.02200997013820158, -0.02030313271789833, -0.05434553665424643, -0.08041946043353154, -0.10214595586876887, -0.11640223558698601, -0.12343561176512610 ))

  expect_equal(c(result$state_vars),
               c( 0.27890208706433761, -0.05674156087237262, -0.05674156087237259, 0.30832244411997733,  0.22907299456629920, -0.07054986372374671, -0.07054986372374669, 0.27281079366263078,  0.20641927751791855, -0.07481194932541189, -0.07481194932541189, 0.25355941739814719,  0.18621898446389673, -0.07797694223094721, -0.07797694223094723, 0.23403545031696382,  0.16782540488486974, -0.08111400955125457, -0.08111400955125456, 0.21474190508687119,  0.15347409943388154, -0.08040908532391380, -0.08040908532391378, 0.20196408405772731,  0.13887630710897608, -0.08218133993631316, -0.08218133993631313, 0.19022973235333143,  0.13720994008460005, -0.08134139863658270, -0.08134139863658267, 0.19057442838481059,  0.14511195485474510, -0.07927919920623706, -0.07927919920623702, 0.20053080305009252,  0.15492898903389471, -0.07945276548812980, -0.07945276548812974, 0.21318379315542910,  0.16534886594288800, -0.08065363640363740, -0.08065363640363735, 0.22812110198457958,  0.17671794549301001, -0.08207156379098801, -0.08207156379098796, 0.24547295076417719,  0.19001541413007306, -0.08334349853215670, -0.08334349853215665, 0.26517316924176160,  0.20312685844629286, -0.08573171517857962, -0.08573171517857957, 0.28505470966279972,  0.21549765674345600, -0.08948667100691216, -0.08948667100691210, 0.30454815289511317,  0.22445797834457820, -0.09563636483719384, -0.09563636483719379, 0.32217826541330397,  0.23488323874662398, -0.10149027943881546, -0.10149027943881539, 0.34203255134260147,  0.24808539117571130, -0.10685693656866554, -0.10685693656866548, 0.36491936505949918,  0.26334319593569488, -0.11251797532122977, -0.11251797532122970, 0.39006830479438359,  0.27838981854711253, -0.11944922990285778, -0.11944922990285770, 0.41610910024196490,  0.29467115118605319, -0.12699584191360266, -0.12699584191360258, 0.44416036961743827,  0.31053933269322709, -0.13597857163889673, -0.13597857163889665, 0.47321529820671726,  0.33028719138729679, -0.14451877231635799, -0.14451877231635790, 0.50636812571923517,  0.35426420803906411, -0.15247895187164764, -0.15247895187164756, 0.54396888568019186,  0.38164663400653764, -0.16032650243034979, -0.16032650243034971, 0.58528153934548466,  0.41234501120104627, -0.16820885497735891, -0.16820885497735882, 0.62997684651337948,  0.44977788919837536, -0.17531923856312037, -0.17531923856312026, 0.67937378183655850,  0.49349336669744315, -0.18136890512766310, -0.18136890512766299, 0.73334176165057807,  0.54461515495142554, -0.18603072347065033, -0.18603072347065022, 0.79197245887592560,  0.60840476300308555, -0.18777423632839363, -0.18777423632839352, 0.85718857551504468,  0.68686424463453066, -0.18591187992901625, -0.18591187992901614, 0.92918920222214807 ))

  expect_equal(c(result$lag_one_cov),
               c(NULL ))

  expect_equal(c(result$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result$n_iter),
               c(7 ))

  expect_equal(c(result$Q),
               c(0.095369828559475484, 0.007195823231527877, 0.007195823231527877, 0.076434834365142645 ))

  expect_equal(c(result$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result$risk_set),
               c(NULL ))

  expect_equal(c(result$data),
               c(NULL ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$method),
               c("UKF" ))

  expect_equal(c(result$model),
               c("logit" ))

  expect_equal(c(result$est_Q_0),
               c(FALSE ))

  expect_equal(c(result$LR),
               c(1 ))
})


set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$state_vecs, res_old$state_vecs)
  expect_equal(res_new$state_vars, res_old$state_vars)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$state_vecs, res_new_time$state_vecs)
  expect_equal(res$state_vars, res_new_time$state_vars)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2,
                                  save_data = F, save_risk_set = F),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  # matplot(sims$betas, type = "l")
  # matplot(res$state_vecs, add = T, type = "l")
  # get_expect_equal(res, file = "tmp.txt")

  expect_equal(c(res$state_vecs),
               c(-1.82092085034524831, -1.82729795316858490, -1.52843015101533553, -0.91369778530616419, -0.80931154209078215, -0.71970220328478218, -0.82627630867849955, -0.34917207165345704, -0.67073071515865579, -0.35203515774073890, -0.45818136504754303, 1.74685275814275731,  1.70889823546716424, 1.17642034813401453, 1.82522929868875705, 1.08652811518080350,  1.27155083182447659, 1.73397504696440952, 3.80192067969428615, 4.17364636042877990,  3.45275920940089698, 2.10868752410488192, 0.87938631755887708, 0.83568280050013011,  0.16131153751258032, 1.09700488310951050, 0.58265276204107375, 0.55335163311118651,  1.13703759239390223, 2.25264642735934695, 2.06970656973678269, 0.28555646162506110, -1.73614419848997681, 1.49334484101376108, 1.55562608479074105, 1.99478225152721445,  0.15117004282423357, 0.80558935981253699, 0.61614045698793973, 0.04401197711053828, -2.49987472129883948, -2.14632286845168174, -0.75864890044179412, 1.67224250429885668 ))

  expect_equal(c(res$state_vars),
               c( 0.1832550178309723110, 0.0233353149245731743, -0.0320001767098580456, -0.0787052371077972823,  0.0233353149245753531, 0.4932117914625737676, 0.0159274731616371977, -0.2309158724878811464, -0.0320001767098556100, 0.0159274731616370346, 0.4801248604083833138, -0.2584318687087763800, -0.0787052371077913565, -0.2309158724878818680, -0.2584318687087771016, 0.5431939208721094925,  0.1126244723720488672, 0.0908467354812348554, 0.0632669975110951854, -0.1102528799644592050,  0.0908467354812319550, 0.5446703831205768065, 0.1570849847474341809, -0.4605712731706196883,  0.0632669975110922711, 0.1570849847474334038, 0.5273542683750356286, -0.4959500623033006872, -0.1102528799644439672, -0.4605712731706230745, -0.4959500623033057942, 0.8923506826483633692,  0.0807222400054121159, 0.0805044205153931242, 0.0632506595770789271, -0.0743888091748181601,  0.0805044205153901959, 0.5099085783511227987, 0.1964886306379626246, -0.4537069299955319157,  0.0632506595770759433, 0.1964886306379620973, 0.5320714519024762890, -0.5150586661646207043, -0.0743888091748029362, -0.4537069299955351909, -0.5150586661646255893, 0.8470892472010426166,  0.0676680561508966050, 0.0713761983950712831, 0.0695742415170743228, -0.0633478628472181615,  0.0713761983950687295, 0.4087051402737104655, 0.1509155122555868589, -0.3508339597055954440,  0.0695742415170721024, 0.1509155122555937423, 0.3833102531908965660, -0.3824096333028234040, -0.0633478628472038813, -0.3508339597056047698, -0.3824096333028238481, 0.6662247605496338654,  0.0498098359721213940, 0.0303732275708384972, 0.0257716857988383660, 0.0161476111946547499,  0.0303732275708270966, 0.2276928026644160219, 0.0494913924497374161, -0.1294635098705269882,  0.0257716857988291512, 0.0494913924497486710, 0.2307632867646948749, -0.1637715595456765982,  0.0161476111946780784, -0.1294635098705529952, -0.1637715595456846751, 0.2760548490654503029,  0.0519462181903844258, 0.0394756518556704725, 0.0347384498062630401, 0.0025222790318358140,  0.0394756518556586694, 0.2223777584850486766, 0.0560728717256625958, -0.1456977455083329209,  0.0347384498062530342, 0.0560728717256684522, 0.2117365773154165076, -0.1612191636065007927,  0.0025222790318596734, -0.1456977455083553752, -0.1612191636065128386, 0.2926798455607076965,  0.0516588570101625122, 0.0418979783122658683, 0.0346933262266429371, 0.0003691802354863771,  0.0418979783122543914, 0.2425010144281349311, 0.0634897041535592704, -0.1652257252397389686,  0.0346933262266334239, 0.0634897041535678330, 0.2140101105353587330, -0.1674096251083421749,  0.0003691802355100856, -0.1652257252397623666, -0.1674096251083521669, 0.3143530896703636834,  0.0562048010134722428, 0.0475073169624853284, 0.0313282880118159746, -0.0030194223283249860,  0.0475073169624740249, 0.2852846299142142716, 0.0869177069669883895, -0.2053339288549395070,  0.0313282880118069471, 0.0869177069669993252, 0.2758212277191780526, -0.2169507699767647124, -0.0030194223283018327, -0.2053339288549649311, -0.2169507699767733999, 0.3741481110974585467,  0.0591158733559115773, 0.0507750904170524986, 0.0306679856573149126, 0.0034964302162411309,  0.0507750904170409939, 0.3448565521462880201, 0.1203297479543086468, -0.2407269547559788558,  0.0306679856573056145, 0.1203297479543193049, 0.2859616597792459802, -0.2193003187703381762,  0.0034964302162647752, -0.2407269547560041412, -0.2193003187703470580, 0.3535885561441462488,  0.0625795709300176334, 0.0401721644414572560, 0.0224120788342426075, 0.0127773684136726906,  0.0401721644414458762, 0.4179282580049615836, 0.1276412597383520253, -0.2633934560188287977,  0.0224120788342333961, 0.1276412597383627390, 0.3375474509975972537, -0.2482600403344854545,  0.0127773684136963314, -0.2633934560188535556, -0.2482600403344941142, 0.3830954392677380915,  0.0697787525109675177, 0.0677359035523633496, 0.0532560038203183997, -0.0254172057469067292,  0.0677359035523523861, 0.5440019827786575224, 0.1468909444498669448, -0.3763369166836412205,  0.0532560038203095387, 0.1468909444498773809, 0.3817951341443424074, -0.3389358911266535657, -0.0254172057468834978, -0.3763369166836654234, -0.3389358911266615593, 0.5737972516701184134 ))

  expect_equal(c(res$lag_one_cov),
               c(NULL ))

  expect_equal(c(res$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(res$n_iter),
               c(27 ))

  expect_equal(c(res$Q),
               c( 0.13974629841037872, 0.13372538009524551, 0.06423071982379676, -0.28552480233678701,  0.13372538009524551, 1.29646430162645143, 1.01412028487301109, -1.63410250664436973,  0.06423071982379676, 1.01412028487301109, 1.51333762041293474, -1.79836299592134985, -0.28552480233678701, -1.63410250664436973, -1.79836299592134985, 2.63147975990961269 ))

  expect_equal(c(res$Q_0),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$n_risk),
               c(500, 480, 458, 421, 358, 298, 262, 215, 197, 163 ))

  expect_equal(c(res$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(res$risk_set),
               c(NULL ))

  expect_equal(c(res$data),
               c(NULL ))

  expect_equal(c(res$order),
               c(1 ))

  expect_equal(c(res$F_),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$method),
               c("UKF" ))

  expect_equal(c(res$model),
               c("logit" ))

  expect_equal(c(res$est_Q_0),
               c(FALSE ))

  expect_equal(c(res$LR),
               c(1 ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  suppressMessages(m1 <- do.call(ddhazard, arg_list))

  arg_list$control$beta <- 2

  suppressMessages(m2 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m1$state_vecs, m2$state_vecs)) == "character")
  expect_true(class(all.equal(m1$state_vars, m2$state_vars)) == "character")

  arg_list$control$alpha <- .1
  arg_list$control$kappa <- 4 / (.1)^2 + 4

  suppressMessages(m3 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m2$state_vecs, m3$state_vecs)) == "character")
  expect_true(class(all.equal(m2$state_vars, m3$state_vars)) == "character")

  arg_list$control$beta <- 0
  arg_list$control$alpha <- 1
  arg_list$control$kappa <- .5

  suppressMessages(m4 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m3$state_vecs, m4$state_vecs)) == "character")
  expect_true(class(all.equal(m3$state_vars, m4$state_vars)) == "character")
})

arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                 by = 1,
                 data = NULL,
                 Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                 Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                 control = list(kappa = 0, alpha = 1, beta = 0,
                                est_Q_0 = F, method = "UKF", eps = 1e-2),
                 id = NULL,
                 verbose = F,
                 max_T = 10)

set.seed(2972)
sims <- test_sim_func_logit(n_series = 2e3, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -2, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

arg_list$data <- sims$res
arg_list$id <- sims$res$id

arg_list$control$beta <- 0
suppressMessages(fit1 <- do.call(ddhazard, arg_list))

arg_list$control$beta = 2
suppressMessages(fit2 <- do.call(ddhazard, arg_list))

# matplot(sims$betas, type = "l", lty = 1, ylim = range(sims$betas, fit1$state_vecs, fit2$state_vecs))
# matplot(fit1$state_vecs, type = "l", lty = 2, add = T)
# matplot(fit2$state_vecs, type = "l", lty = 4, add = T)

test_that("UKF on head_neck works with exponential model", {
  # Change by argument
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3,
                   method = "UKF", save_data = F, save_risk_set = F),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "exponential"
  ))
  # sink()
  # close(tmp)
  # matplot(result_exp$state_vecs)
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-3.1557783138080078, -3.1557230333400685, -3.0962061441835989, -3.0242235288965391, -2.9610314690769148, -2.9003448202130886, -2.9275580146695681, -3.0138761827589708, -3.0876564639100663, -3.1550257132128201, -3.2228314988598514, -3.2966343735226644, -3.3569488609398315, -3.4063486404020171, -3.4329823266285908, -3.4759064559251431, -3.5257532206854596, -3.5718945362550221, -3.6021014017891089, -3.6430129526908415, -3.6714427734804973, -3.7135118650389325, -3.7586529690748751, -3.7946038368341801, -3.8215289014203355, -3.8532431529924680, -3.8766776314642177, -3.8923034593579149, -3.9140157679358731, -3.9284364821171844, -3.9356268582802976, 0.4099564277361265, 0.4100083918461017, 0.4344167162901158, 0.4681528419359097,  0.4843054595323164, 0.5160542913036995, 0.5083225107599908, 0.4739365215694858, 0.4614324210793589,  0.4418449459578161, 0.4198769365001624, 0.3926430947052931, 0.3754733696565922, 0.3673530491754680,  0.3681968061084228, 0.3493215968856320, 0.3274748333392600, 0.3111776847803159, 0.3004258161706556,  0.2853278047826699, 0.2744784116427679, 0.2485643412215487, 0.2254162981782061, 0.2050917432372885,  0.1875296170024237, 0.1724679932914356, 0.1600462991765582, 0.1502133683518932, 0.1427179457362049,  0.1377557156153096, 0.1352893809808380 ))

  expect_equal(c(result_exp$state_vars),
               c( 0.26507192437403859, -0.06954502393314611, -0.06954502393314507, 0.28764427280748472, 0.23923814819567629, -0.07609473240226672, -0.07609473240226558, 0.27132420889994635, 0.22137247529404586, -0.08197034136667897, -0.08197034136667782, 0.25984627344300371, 0.20655926187363965, -0.08693347497997958, -0.08693347497997841,  0.24976862000609579, 0.19383771769139410, -0.09139678032472048, -0.09139678032471935, 0.24088486818522747,  0.18353047189482447, -0.09488825707026183, -0.09488825707026068, 0.23429757747345165, 0.17502997446038054, -0.09824717701228755, -0.09824717701228639, 0.22953074692057870, 0.17185797617832263, -0.10023194976563650, -0.10023194976563532, 0.22952023840218008, 0.17389178376906886, -0.10093282805601318, -0.10093282805601200,  0.23417000532865023, 0.17836728682260339, -0.10164558562632478, -0.10164558562632361, 0.24135626995815723,  0.18435481261237213, -0.10254912896726540, -0.10254912896726423, 0.25049330356868105, 0.19155032566473515, -0.10365552750445613, -0.10365552750445495, 0.26132822482433349, 0.19981711778279770, -0.10512530947556621, -0.10512530947556503, 0.27352021016169015, 0.20868072353627848, -0.10713709818956765, -0.10713709818956646,  0.28666147587907509, 0.21801296267768594, -0.10961804077015375, -0.10961804077015254, 0.30070216334285915,  0.22750320581449274, -0.11258588190559740, -0.11258588190559618, 0.31549209768600073, 0.23783122176710580, -0.11592414440267329, -0.11592414440267207, 0.33125632054575999, 0.24934311394981573, -0.11955625152182024, -0.11955625152181902, 0.34810713542546501, 0.26213128420896104, -0.12341381935874061, -0.12341381935873939,  0.36608457931227661, 0.27608408523900219, -0.12750438689270865, -0.12750438689270743, 0.38510193271939830,  0.29111588059254018, -0.13180047488520036, -0.13180047488519914, 0.40510060694732386, 0.30728728054885818, -0.13627982074556486, -0.13627982074556363, 0.42605992081972444, 0.32536489885461339, -0.14092193470004635, -0.14092193470004513, 0.44809497623765276, 0.34548590405352353, -0.14551315771171150, -0.14551315771171028,  0.47135989799897327, 0.36785254946033574, -0.15000213280245189, -0.15000213280245067, 0.49585688863601207,  0.39273528868453550, -0.15431965523670468, -0.15431965523670346, 0.52160599019703313, 0.42080716611711177, -0.15825593128066004, -0.15825593128065885, 0.54881800893383437, 0.45212778659623548, -0.16164365941254832, -0.16164365941254713, 0.57752944697862518, 0.48715700183037314, -0.16435780710901227, -0.16435780710901107,  0.60779777596591344, 0.52679363352068498, -0.16609347230870533, -0.16609347230870414, 0.63989366655892521,  0.57163332470350547, -0.16667714041089260, -0.16667714041089141, 0.67389199510006037 ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(39 ))

  expect_equal(c(result_exp$Q),
               c(0.0501772353506762109, 0.0008047627724870963, 0.0008047627724870963, 0.0353345554737870271 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})

test_that("UKF on simulated data works with exponential model", {
  set.seed(9997)
  sims <- test_sim_func_exp(n_series = 1e3, n_vars = 10, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = 0, re_draw = T, beta_start = (1:10 - 5) / 2.5,
                            intercept_start = -5, sds = c(.1, rep(1, 10)))
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
    data = sims$res,
    by = (by_ <- 1),
    Q_0 = diag(1, 11),
    Q = diag(1e-1, 11),
    control = list(est_Q_0 = F, eps = 10^-2, n_max = 10^3, method = "UKF",
                   debug = F, beta = 0, save_data = F, save_risk_set = F),
    max_T = 10,
    id = sims$res$id, order = 1,
    verbose = F,
    model = "exponential"))
  # sink()
  # close(tmp)

  # sum(sims$res$event)
  # diag(result_exp$Q)
  # result_exp$LR
  # matplot(sims$betas, type = "l", lty = 1)
  # matplot(result_exp$state_vecs, type = "l", lty = 2, add = T)
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-5.332777769868411788, -5.338387983273727322, -5.280352438568282736, -5.100477135145620622, -5.074430027104600782, -4.818060857262651986, -4.904146387867366563, -4.778778381595115476, -4.517985434324814698, -4.278956055695000593, -3.978080223750885658, -2.731896257992550314, -2.750859083128911475, -2.772028584417567387, -2.741430152736954451, -2.685296475077356249, -2.540779139609654624, -2.454128136346131583, -2.461778933657382762, -2.613924313087947926, -2.718627417252987399, -2.971031382204626592, 0.775260078928940333, 0.853476618558409950,  0.844275149799206259, 0.684024273585193909, 0.533386214977018103, -0.290225405341002607, -0.453182061356221078, -0.995707788113108117, -1.056957720637903497, -0.847392957112619860, -0.055676004228949694, -0.198018398013188185, -0.253030175786261413, -0.268621199821777346, -0.167805723892313075, -0.102870567177703931, 0.531138792495585599, 0.616582017807408400,  1.037103017408051553, 1.167852710781883241, 1.016593502104719882, 0.476048825084896987, -0.453665079880736455, -0.484436225092257700, -0.395535864232815337, -0.112118960037047105, -0.007628331792502552, 0.603705535673179972, 0.521368336320395920, 0.806168920822411317,  1.131460101460572076, 1.396686803840180957, 1.500391183004561313, 0.711080925916330431,  0.600344984448224706, 0.700143104785491577, 0.980023300019923882, 1.543073314467667601,  2.762489306430119917, 2.918083076304207601, 3.418736134917359060, 3.061676566328802807,  2.826769646130126823, 1.787661160547668215, -0.659956237276494551, -0.473753646882154822, -0.726234498296417286, -1.593530338999129325, -2.336503218003431304, -4.889814250418110575, -5.044902582376677103, -6.166343612161043097, -6.349261714480657126, -6.425129445726732058, -5.348967439016956149, 0.564390619397057591, 0.432244970349930258, 0.636885535305461437,  1.187722669111150875, 1.919651891912486752, 3.437394901904484268, 3.372126183997589344,  3.889843184857448399, 3.557337116833946933, 3.279280218615034936, 2.033135198206464711,  1.069395266448463166, 1.061038834148726462, 1.076762771405758157, 1.391390285586335596,  1.263019445644596450, 1.842264148819734881, 1.929686195909206647, 2.316933712564642978,  3.042734546920034866, 3.634843469972453889, 4.276637400155114399, 2.011832326109581626,  2.124547409752292282, 2.073459723772456798, 1.821389161480101659, 1.194883686803912326,  0.082591177752433340, -0.080981942739025009, -0.452252027684955316, 0.158441846331101394,  0.581001708227165459, 1.773758865136670249, 3.759268714777285858, 3.768899144628815812,  3.859918648114469608, 4.001150882555873700, 4.045318609312977820, 4.078184908175494172,  3.906615791175631180, 3.859559115069165269, 3.967862350577143538, 4.077230150348106541,  4.271149724786491575 ))

  expect_equal(c(result_exp$state_vars),
               c( 1.680861118697475e-01, 1.384141563416273e-02, 1.343082262932701e-02, -4.721075253080643e-03,  5.538031873752071e-02, -2.988609455745202e-02, -4.298287187036525e-02, -5.594497675495008e-03,  6.430527607755608e-02, 1.867606146982729e-02, -1.241765311854298e-02, 1.384141563416751e-02,  2.416320683138005e-01, -1.890061724447976e-02, 4.593875319665617e-04, -1.228892742914729e-02,  1.991207504731152e-02, -6.373252395808320e-03, 1.193120862380882e-02, -1.441344300995807e-02, -3.268776711205099e-02, -1.488215481383306e-02, 1.343082262932686e-02, -1.890061724447994e-02,  2.804970578587130e-01, -7.986127928937653e-02, 4.091754323855693e-05, -5.298753315470778e-02,  8.456519056120272e-02, -5.260509079034244e-02, 1.218769458130177e-02, 5.141929903293208e-02,  2.899040655305489e-02, -4.721075253079571e-03, 4.593875319665896e-04, -7.986127928937652e-02,  2.679461674318437e-01, 1.071722488264498e-02, 3.331551215062778e-02, -7.302128420462591e-02,  2.829153271508373e-02, 6.930712610758845e-03, -2.292737067060477e-02, -2.000993202381444e-02,  5.538031873752303e-02, -1.228892742914744e-02, 4.091754323848676e-05, 1.071722488264494e-02,  2.575977987757108e-01, -9.953239434884712e-04, -8.549636567881677e-02, 1.879215556595269e-02,  8.064162341170096e-02, 2.689793155897531e-02, 2.991131842444065e-02, -2.988609455745088e-02,  1.991207504731145e-02, -5.298753315470775e-02, 3.331551215062770e-02, -9.953239434885536e-04,  2.959803372441612e-01, -1.196599750455413e-01, 1.028929663722474e-01, -3.294834141825766e-02, -1.179001506348593e-01, -1.546077926455183e-02, -4.298287187036593e-02, -6.373252395808239e-03,  8.456519056120262e-02, -7.302128420462571e-02, -8.549636567881667e-02, -1.196599750455413e-01,  5.014178358892747e-01, -1.410769590655302e-01, -1.086329446676048e-01, 8.879205532205194e-02, -1.397686496925952e-02, -5.594497675494072e-03, 1.193120862380869e-02, -5.260509079034240e-02,  2.829153271508362e-02, 1.879215556595265e-02, 1.028929663722475e-01, -1.410769590655300e-01,  3.835685795320123e-01, -4.652281359898618e-02, -1.171590904442153e-01, 2.174622548562323e-02,  6.430527607756052e-02, -1.441344300995843e-02, 1.218769458130197e-02, 6.930712610758663e-03,  8.064162341170081e-02, -3.294834141825773e-02, -1.086329446676049e-01, -4.652281359898628e-02,  4.111356469959341e-01, 8.450702590989340e-02, 1.569692405198597e-02, 1.867606146982777e-02, -3.268776711205101e-02, 5.141929903293209e-02, -2.292737067060493e-02, 2.689793155897517e-02, -1.179001506348591e-01, 8.879205532205209e-02, -1.171590904442155e-01, 8.450702590989323e-02,  3.706956329373098e-01, 2.913515896971917e-02, -1.241765311854398e-02, -1.488215481383335e-02,  2.899040655305479e-02, -2.000993202381473e-02, 2.991131842444025e-02, -1.546077926455174e-02, -1.397686496925939e-02, 2.174622548562297e-02, 1.569692405198587e-02, 2.913515896971922e-02,  2.921498963701205e-01, 1.343259979843970e-01, 1.755502300124250e-02, 6.258529547730669e-03, -1.446077102067516e-03, 4.488612478315278e-02, -2.260358910240805e-02, -3.304799515002042e-02, -4.726618511613549e-03, 4.902875919242529e-02, 8.895044633901655e-03, -1.918610416351272e-02,  1.755502300124815e-02, 2.114349615958101e-01, -1.827843108886567e-02, 1.816449612200121e-03, -8.031056575899261e-03, 2.037088157361087e-02, -1.473325763305943e-02, 1.655066651158486e-02, -9.956666167759348e-03, -3.091281397899286e-02, -9.247579679418617e-03, 6.258529547728800e-03, -1.827843108886585e-02, 2.218455973123099e-01, -6.189495695907374e-02, -1.360954555526695e-04, -4.268782426523018e-02, 7.116277325354735e-02, -4.592871477810323e-02, 1.191974565931535e-02,  4.860201151477373e-02, 2.010558540175741e-02, -1.446077102064862e-03, 1.816449612200041e-03, -6.189495695907377e-02, 2.296481489644465e-01, 1.077253209174764e-02, 3.332504659320833e-02, -7.017160733847887e-02, 3.181624013525067e-02, 3.478015575697366e-03, -2.884384899250208e-02, -1.517848696933996e-02, 4.488612478315689e-02, -8.031056575899965e-03, -1.360954555525325e-04,  1.077253209174734e-02, 2.250697895648577e-01, -1.485169294464423e-03, -7.256307026638598e-02,  1.434078483747610e-02, 7.098987162652939e-02, 2.175052049970445e-02, 2.481199114136908e-02, -2.260358910240462e-02, 2.037088157361077e-02, -4.268782426523013e-02, 3.332504659320815e-02, -1.485169294464229e-03, 2.457102552445564e-01, -1.000919461803136e-01, 8.852861874544149e-02, -3.119581731361797e-02, -1.070648308685468e-01, -1.197106999971008e-02, -3.304799515002651e-02, -1.473325763305844e-02, 7.116277325354689e-02, -7.017160733847799e-02, -7.256307026638580e-02, -1.000919461803133e-01, 4.192772841540551e-01, -1.268523691759567e-01, -7.654870873812943e-02,  9.598121659046971e-02, -8.544438536408887e-03, -4.726618511609866e-03, 1.655066651158454e-02, -4.592871477810299e-02, 3.181624013525029e-02, 1.434078483747628e-02, 8.852861874544153e-02, -1.268523691759568e-01, 3.369466507237230e-01, -4.308079928787825e-02, -1.178058106281327e-01,  1.608902694802545e-02, 4.902875919243231e-02, -9.956666167760694e-03, 1.191974565931615e-02,  3.478015575696589e-03, 7.098987162652906e-02, -3.119581731361886e-02, -7.654870873812911e-02, -4.308079928787916e-02, 3.512108721524532e-01, 7.594584687853100e-02, 1.022233717245216e-02,  8.895044633900465e-03, -3.091281397899311e-02, 4.860201151477393e-02, -2.884384899250240e-02,  2.175052049970389e-02, -1.070648308685471e-01, 9.598121659047068e-02, -1.178058106281334e-01,  7.594584687852990e-02, 3.415312441830254e-01, 2.185749722958426e-02, -1.918610416351380e-02, -9.247579679419131e-03, 2.010558540175759e-02, -1.517848696934056e-02, 2.481199114136831e-02, -1.197106999971038e-02, -8.544438536407810e-03, 1.608902694802462e-02, 1.022233717245161e-02,  2.185749722958464e-02, 2.558597580345855e-01, 1.082710269967355e-01, 1.799596293893142e-02,  7.335519348204466e-04, 2.004962512780584e-03, 4.150535341888354e-02, -1.568373619208897e-02, -3.930210133469705e-02, -1.321188564147885e-03, 4.778544352114782e-02, 3.367345296244575e-03, -2.062216980252635e-02, 1.799596293893713e-02, 1.915983654019604e-01, -2.063531338100026e-02,  3.255945433829497e-03, -9.249682237230132e-03, 2.332652484639865e-02, -1.533588995254338e-02,  2.023101042047185e-02, -1.545114291200481e-02, -3.546622056232230e-02, -1.173548753090193e-02,  7.335519348191490e-04, -2.063531338100050e-02, 2.024575546482911e-01, -6.375735106917160e-02, -8.138820131817512e-03, -5.698326942956855e-02, 9.963283402730999e-02, -6.532421260361856e-02,  5.619482665432225e-03, 5.891561983249030e-02, 1.826619290055454e-02, 2.004962512782848e-03,  3.255945433829439e-03, -6.375735106917169e-02, 2.121531590905916e-01, 1.771177159386352e-02,  4.646600583231640e-02, -9.783347500419952e-02, 4.839603181126363e-02, 1.224069457724593e-02, -3.761409624319335e-02, -1.275993166590114e-02, 4.150535341888720e-02, -9.249682237230850e-03, -8.138820131817626e-03, 1.771177159386330e-02, 2.153909291223168e-01, 1.258724557493369e-02, -1.083520055813095e-01, 2.957396239092839e-02, 8.842674272494663e-02, 1.516026140418406e-02,  2.866467869385155e-02, -1.568373619208606e-02, 2.332652484639859e-02, -5.698326942956843e-02,  4.646600583231614e-02, 1.258724557493371e-02, 2.519334366810028e-01, -1.526959756140079e-01,  1.270333746331959e-01, -2.387301601645304e-02, -1.270759029475718e-01,
                  -7.623048308026497e-03, -3.930210133470162e-02, -1.533588995254239e-02, 9.963283402730992e-02, -9.783347500419877e-02, -1.083520055813091e-01, -1.526959756140080e-01, 5.353368761847344e-01, -1.983134538414224e-01, -1.222144423620913e-01, 1.294159075893618e-01, -2.128391434565903e-02, -1.321188564144907e-03,  2.023101042047156e-02, -6.532421260361843e-02, 4.839603181126317e-02, 2.957396239092835e-02,  1.270333746331960e-01, -1.983134538414222e-01, 3.690066533874535e-01, -3.520441255168619e-02, -1.518309221482206e-01, 1.984270839625609e-02, 4.778544352115434e-02, -1.545114291200618e-02,  5.619482665432550e-03, 1.224069457724536e-02, 8.842674272494641e-02, -2.387301601645362e-02, -1.222144423620915e-01, -3.520441255168669e-02, 3.669592711713917e-01, 8.255473817574145e-02,  1.895030487720368e-02, 3.367345296243832e-03, -3.546622056232261e-02, 5.891561983249035e-02, -3.761409624319360e-02, 1.516026140418371e-02, -1.270759029475720e-01, 1.294159075893623e-01, -1.518309221482213e-01, 8.255473817574076e-02, 3.427484742356657e-01, 2.087731937821038e-02, -2.062216980252768e-02, -1.173548753090242e-02, 1.826619290055457e-02, -1.275993166590167e-02,  2.866467869385069e-02, -7.623048308026638e-03, -2.128391434565799e-02, 1.984270839625542e-02,  1.895030487720294e-02, 2.087731937821055e-02, 2.378558652317627e-01, 8.846946301298558e-02,  1.907911040894932e-02, -1.327444284185949e-03, 2.099681912450228e-03, 3.530226784616059e-02, -1.319179060631536e-02, -3.359753980610061e-02, -1.543766143703480e-03, 4.019321865815344e-02, -1.059566512340872e-03, -2.336940321187503e-02, 1.907911040895493e-02, 1.712873800014157e-01, -2.081243337195481e-02, 4.396452358069596e-03, -8.613134855615543e-03, 2.200875500510121e-02, -1.249776719531913e-02, 1.875754118184457e-02, -1.585331823610982e-02, -3.424105017341609e-02, -1.289572551979935e-02, -1.327444284186400e-03, -2.081243337195519e-02, 1.759111084040495e-01, -6.014341669906918e-02, -9.018813977877176e-03, -5.243654330501964e-02, 8.709039647705655e-02, -5.897697946817469e-02, 5.960376239642141e-03, 5.433821181276512e-02, 1.796381058023429e-02,  2.099681912451983e-03, 4.396452358069641e-03, -6.014341669906937e-02, 1.925072432635887e-01,  1.794110545773501e-02, 4.787124054980411e-02, -9.508393454045588e-02, 4.904008681816040e-02,  1.159104278504159e-02, -3.889623762352622e-02, -1.298047327416267e-02, 3.530226784616392e-02, -8.613134855616158e-03, -9.018813977877830e-03, 1.794110545773502e-02, 1.954581048292191e-01,  1.608622765623990e-02, -1.069820029556110e-01, 3.069601549471241e-02, 8.567058975538655e-02,  1.135940850853752e-02, 2.639955413978744e-02, -1.319179060631333e-02, 2.200875500510132e-02, -5.243654330501942e-02, 4.787124054980371e-02, 1.608622765623943e-02, 2.298412636408598e-01, -1.429764076707922e-01, 1.206901955574654e-01, -2.145810091612279e-02, -1.186987687224150e-01, -5.314497159973404e-03, -3.359753980610345e-02, -1.249776719531855e-02, 8.709039647705741e-02, -9.508393454045549e-02, -1.069820029556098e-01, -1.429764076707933e-01, 5.009478683441401e-01, -1.855826931656096e-01, -1.234384617212648e-01, 1.175760735290794e-01, -2.227841462659138e-02, -1.543766143701611e-03, 1.875754118184449e-02, -5.897697946817456e-02, 4.904008681815984e-02,  3.069601549471175e-02, 1.206901955574655e-01, -1.855826931656082e-01, 3.397257626611509e-01, -3.054984693621447e-02, -1.435461859949085e-01, 2.010030067175312e-02, 4.019321865815998e-02, -1.585331823611106e-02, 5.960376239641479e-03, 1.159104278504153e-02, 8.567058975538672e-02, -2.145810091612247e-02, -1.234384617212668e-01, -3.054984693621385e-02, 3.413939515617566e-01,  7.805969090919342e-02, 1.837592287048362e-02, -1.059566512340765e-03, -3.424105017341650e-02,  5.433821181276479e-02, -3.889623762352613e-02, 1.135940850853770e-02, -1.186987687224149e-01,  1.175760735290784e-01, -1.435461859949087e-01, 7.805969090919350e-02, 3.130485926605265e-01,  1.857591363989998e-02, -2.336940321187644e-02, -1.289572551979980e-02, 1.796381058023404e-02, -1.298047327416306e-02, 2.639955413978660e-02, -5.314497159973275e-03, -2.227841462659071e-02,  2.010030067175275e-02, 1.837592287048278e-02, 1.857591363989990e-02, 2.178583347626200e-01,  7.379508814566543e-02, 1.959435507713323e-02, -5.208930719832836e-04, 2.361413047413225e-04,  2.640488532461561e-02, -1.293592952371822e-02, -1.991665275745112e-02, -6.626871628754339e-03,  2.906870872603969e-02, -4.419281014475515e-03, -2.743487501836369e-02, 1.959435507713863e-02,  1.500226447914553e-01, -1.833775008687381e-02, 3.249889759353286e-03, -6.645187713703437e-03,  1.527908732702076e-02, -5.695121968194531e-03, 1.134893094326657e-02, -1.235609820718199e-02, -2.565328642519075e-02, -1.306834871439566e-02, -5.208930719830937e-04, -1.833775008687417e-02,  1.426687157737355e-01, -4.527827728155687e-02, -5.351644455146200e-03, -3.257024839147368e-02,  5.366749451438903e-02, -3.557720934514878e-02, 5.646461452469921e-03, 3.501733749277942e-02,  1.618611679768924e-02, 2.361413047426864e-04, 3.249889759353343e-03, -4.527827728155719e-02,  1.628775278057794e-01, 1.217136488547303e-02, 3.313924448842506e-02, -6.603872267313271e-02,  3.132952795137216e-02, 9.117917125698967e-03, -2.549393014240517e-02, -1.189546015771963e-02,  2.640488532461869e-02, -6.645187713703880e-03, -5.351644455147383e-03, 1.217136488547331e-02,  1.672909243003212e-01, 1.357452183442918e-02, -8.399555020327004e-02, 2.058045668701548e-02,  7.022628845085838e-02, 8.369333098842075e-03, 1.841001885371040e-02, -1.293592952371683e-02,  1.527908732702079e-02, -3.257024839147345e-02, 3.313924448842455e-02, 1.357452183442822e-02,  1.872936286779877e-01, -1.017634175379465e-01, 8.509821358825748e-02, -1.289773011512567e-02, -8.475011613203035e-02, -2.237884360691512e-03, -1.991665275745266e-02, -5.695121968194126e-03,  5.366749451439039e-02, -6.603872267313241e-02, -8.399555020326822e-02, -1.017634175379481e-01,  4.037203219633084e-01, -1.280452616648236e-01, -1.104750313843058e-01, 7.955909109779158e-02, -1.459858191509365e-02, -6.626871628753382e-03, 1.134893094326643e-02, -3.557720934514867e-02,  3.132952795137151e-02, 2.058045668701419e-02, 8.509821358825764e-02, -1.280452616648214e-01,  2.748344154141951e-01, -2.415098924090492e-02, -1.040865611023021e-01, 1.852173060527948e-02,  2.906870872604633e-02, -1.235609820718291e-02, 5.646461452468374e-03, 9.117917125699425e-03,  7.022628845085888e-02, -1.289773011512447e-02, -1.104750313843096e-01, -2.415098924090314e-02,  2.925969267795320e-01, 5.650903048973975e-02, 9.219200548813932e-03, -4.419281014474710e-03, -2.565328642519099e-02, 3.501733749277882e-02, -2.549393014240473e-02, 8.369333098842854e-03, -8.475011613202990e-02, 7.955909109778936e-02, -1.040865611023020e-01, 5.650903048974072e-02,  2.489223863323044e-01, 1.171775995644662e-02, -2.743487501836504e-02, -1.306834871439605e-02,  1.618611679768881e-02, -1.189546015771992e-02, 1.841001885370966e-02, -2.237884360691206e-03, -1.459858191509333e-02, 1.852173060527934e-02, 9.219200548813141e-03, 1.171775995644640e-02,  1.940600181666536e-01, 6.698090189239661e-02, 1.745021553472233e-02, 1.205136399408630e-03, -3.372815322022469e-04, 2.288499560855510e-02, -1.934065342908657e-02, -8.639668355998449e-03, -1.752606212774956e-02, 3.054285022453586e-02,
                  4.357863222908313e-03, -2.732097282672568e-02,  1.745021553472780e-02, 1.351158593846074e-01, -2.033072700777151e-02, 4.739300531973494e-03, -7.723519897528523e-03, 1.883872078498059e-02, -5.351010592486461e-03, 1.431177581095006e-02, -1.923173222531714e-02, -3.127242805812987e-02, -1.668789232368508e-02, 1.205136399408599e-03, -2.033072700777184e-02, 1.388715839743138e-01, -4.910059464701776e-02, -7.227880183917231e-03, -4.734171987142016e-02, 7.209084119480251e-02, -5.420786237999911e-02, 9.530193206314394e-03,  5.279742782051103e-02, 1.438536215999437e-02, -3.372815322007523e-04, 4.739300531973506e-03, -4.910059464701806e-02, 1.509582104536477e-01, 1.340627158248136e-02, 4.108317210071526e-02, -7.722731758784783e-02, 4.233930202919133e-02, 8.314858896018681e-03, -3.508394145325586e-02, -8.888418969256483e-03, 2.288499560855808e-02, -7.723519897529055e-03, -7.227880183918198e-03,  1.340627158248149e-02, 1.511445073111937e-01, 1.265457648519473e-02, -8.006844620216830e-02,  1.713218319010188e-02, 6.957426424528727e-02, 9.355880075394944e-03, 1.657544920244280e-02, -1.934065342908466e-02, 1.883872078498059e-02, -4.734171987141989e-02, 4.108317210071492e-02,  1.265457648519428e-02, 2.048363594582654e-01, -1.312904445930369e-01, 1.133323917705276e-01, -2.351163202530612e-02, -1.119604575983605e-01, -4.379315758302943e-03, -8.639668356000276e-03, -5.351010592485871e-03, 7.209084119480351e-02, -7.722731758784726e-02, -8.006844620216685e-02, -1.312904445930377e-01, 4.284199927972731e-01, -1.576842497755202e-01, -1.017685273276171e-01,  1.055280021116227e-01, -1.348432829598711e-02, -1.752606212774829e-02, 1.431177581094982e-02, -5.420786237999882e-02, 4.233930202919065e-02, 1.713218319010092e-02, 1.133323917705274e-01, -1.576842497755184e-01, 2.871587842169532e-01, -3.304325092476291e-02, -1.298924654398064e-01,  1.311225262883784e-02, 3.054285022454230e-02, -1.923173222531815e-02, 9.530193206313048e-03,  8.314858896018937e-03, 6.957426424528769e-02, -2.351163202530557e-02, -1.017685273276203e-01, -3.304325092476159e-02, 2.791690091768415e-01, 6.705911986583273e-02, 1.551810337321268e-02,  4.357863222908671e-03, -3.127242805813005e-02, 5.279742782051040e-02, -3.508394145325549e-02,  9.355880075395312e-03, -1.119604575983600e-01, 1.055280021116212e-01, -1.298924654398064e-01,  6.705911986583317e-02, 2.558087831630301e-01, 1.666355445512474e-02, -2.732097282672714e-02, -1.668789232368550e-02, 1.438536215999407e-02, -8.888418969256885e-03, 1.657544920244196e-02, -4.379315758302846e-03, -1.348432829598642e-02, 1.311225262883749e-02, 1.551810337321181e-02,  1.666355445512469e-02, 1.761050475727419e-01, 5.492979246653626e-02, 1.764917538831180e-02,  8.696277868148503e-03, -8.317731603727046e-03, 7.262370469375123e-03, -3.299087597511793e-02,  3.352337278831152e-02, -4.063850331519624e-02, 1.119212467312980e-02, 1.518749366275769e-02, -3.236251079864644e-02, 1.764917538831746e-02, 1.140397914318613e-01, -1.547843584950387e-02,  2.227047392182211e-03, -6.651686413576850e-03, 9.565914022675665e-03, 5.589075014168342e-03,  4.040607696479938e-03, -1.606391813789946e-02, -1.977217915977836e-02, -1.636745501702244e-02,  8.696277868148181e-03, -1.547843584950398e-02, 1.180298251771196e-01, -3.751078732900685e-02,  6.812467707086974e-04, -3.448236504518597e-02, 4.458167997763245e-02, -3.819806693424808e-02,  1.719309447840539e-02, 4.245012671271683e-02, 1.394547874183052e-02, -8.317731603725379e-03,  2.227047392182001e-03, -3.751078732900707e-02, 1.224440652734432e-01, 1.795982556633862e-03,  2.582668272379174e-02, -4.086827245534454e-02, 2.318348234736952e-02, -4.411621512355621e-03, -2.433594346669840e-02, -9.165371232216892e-03, 7.262370469377779e-03, -6.651686413577733e-03,  6.812467707086201e-04, 1.795982556633353e-03, 1.144721459663871e-01, -1.748025268283479e-03, -2.443043375233859e-02, -1.002998783916781e-02, 3.599495051202692e-02, 1.636070192696013e-02,  5.669494705067541e-03, -3.299087597511480e-02, 9.565914022675462e-03, -3.448236504518681e-02,  2.582668272379252e-02, -1.748025268281455e-03, 1.656573754453668e-01, -7.475091918151461e-02,  7.408655478832282e-02, -3.435798182365492e-02, -7.731820604834480e-02, -7.496520852892867e-03,  3.352337278830887e-02, 5.589075014169746e-03, 4.458167997763359e-02, -4.086827245534443e-02, -2.443043375234014e-02, -7.475091918151139e-02, 2.660530041115278e-01, -7.372790655610101e-02, -2.992951384064964e-02, 5.423153036789297e-02, 6.201784871617501e-03, -4.063850331519418e-02,  4.040607696479229e-03, -3.819806693424795e-02, 2.318348234736919e-02, -1.002998783916672e-02,  7.408655478832077e-02, -7.372790655609981e-02, 2.116280572753151e-01, -5.056414630586685e-02, -8.372571725406737e-02, 1.683200371516867e-04, 1.119212467313558e-02, -1.606391813790080e-02,  1.719309447840486e-02, -4.411621512356078e-03, 3.599495051202706e-02, -3.435798182365702e-02, -2.992951384064919e-02, -5.056414630586781e-02, 1.937778738824899e-01, 5.813246157437289e-02,  5.888072323601452e-03, 1.518749366275686e-02, -1.977217915977834e-02, 4.245012671271700e-02, -2.433594346669890e-02, 1.636070192695829e-02, -7.731820604834413e-02, 5.423153036789448e-02, -8.372571725406890e-02, 5.813246157437090e-02, 1.889964539004189e-01, 1.841150316062840e-02, -3.236251079864816e-02, -1.636745501702292e-02, 1.394547874183054e-02, -9.165371232217574e-03,  5.669494705066494e-03, -7.496520852893434e-03, 6.201784871619436e-03, 1.683200371506190e-04,  5.888072323600363e-03, 1.841150316062895e-02, 1.498525208260434e-01, 5.583748880552927e-02,  1.758775429679931e-02, 1.086985149402648e-02, -1.056952159621916e-02, 7.688317904757558e-03, -3.843442112042756e-02, 4.245278013184404e-02, -4.456477254619122e-02, 1.108261806368667e-02,  2.245758045417084e-02, -3.063573143508203e-02, 1.758775429680485e-02, 1.098672027125622e-01, -1.755241972654002e-02, 2.572030738445796e-03, -6.216659266782667e-03, 1.187086488799968e-02,  1.764548205114091e-03, 5.588087402773230e-03, -1.343170881571334e-02, -2.459992611720026e-02, -1.688654024693617e-02, 1.086985149402694e-02, -1.755241972654013e-02, 1.145396025904420e-01, -3.859487726895587e-02, 1.825789881745539e-03, -3.839904213820342e-02, 4.867320056147509e-02, -4.364381545174036e-02, 1.587447578662763e-02, 4.771720319362849e-02, 1.269144710916530e-02, -1.056952159621805e-02, 2.572030738445643e-03, -3.859487726895634e-02, 1.183671878968949e-01,  1.750664900687475e-05, 2.788595080278957e-02, -3.958829790603617e-02, 2.593856712321218e-02, -5.790518089538514e-03, -2.946426351036277e-02, -7.465908277769580e-03, 7.688317904759998e-03, -6.216659266783406e-03, 1.825789881744600e-03, 1.750664900693547e-05, 1.097493127588193e-01, -5.030289375432163e-03, -1.971731998443109e-02, -1.290566521521690e-02, 4.129661098634368e-02,  2.308939864819605e-02, 6.569208619122076e-03, -3.843442112042487e-02, 1.187086488799966e-02, -3.839904213820537e-02, 2.788595080279092e-02, -5.030289375430355e-03, 1.688857074852166e-01, -7.586778611872097e-02, 8.272344428874027e-02, -3.670564460163470e-02, -8.505010860336502e-02, -6.117084927406351e-03, 4.245278013184273e-02, 1.764548205115110e-03, 4.867320056147819e-02, -3.958829790603705e-02, -1.971731998443171e-02, -7.586778611871692e-02, 2.641062802010182e-01, -8.396532224345507e-02,
                  -2.998026449509793e-02, 5.403067041086715e-02, 2.459156083516338e-03, -4.456477254618999e-02, 5.588087402772689e-03, -4.364381545174111e-02, 2.593856712321223e-02, -1.290566521521650e-02, 8.272344428873750e-02, -8.396532224345321e-02, 2.193407901361187e-01, -4.632405699423291e-02, -9.201959734644236e-02, 3.948383545982604e-03, 1.108261806369246e-02, -1.343170881571451e-02, 1.587447578662603e-02, -5.790518089538143e-03, 4.129661098634409e-02, -3.670564460163629e-02, -2.998026449509937e-02, -4.632405699423273e-02, 1.927492357732412e-01,  6.559020851063434e-02, 9.231654790094123e-03, 2.245758045417063e-02, -2.459992611720037e-02,  4.771720319362935e-02, -2.946426351036350e-02, 2.308939864819473e-02, -8.505010860336389e-02,  5.403067041086834e-02, -9.201959734644408e-02, 6.559020851063316e-02, 1.933482825258259e-01,  1.862006419484359e-02, -3.063573143508365e-02, -1.688654024693662e-02, 1.269144710916514e-02, -7.465908277770083e-03, 6.569208619121198e-03, -6.117084927406691e-03, 2.459156083517682e-03,  3.948383545981860e-03, 9.231654790093170e-03, 1.862006419484390e-02, 1.431821606696194e-01,  5.643306449548113e-02, 1.782058327660138e-02, 1.350173797187574e-02, -1.325850684711092e-02,  3.560511596412539e-03, -4.357191944331108e-02, 5.706087872108587e-02, -5.046208085317298e-02,  4.749443257039360e-03, 2.679106724325937e-02, -2.987262056296972e-02, 1.782058327660702e-02,  1.115456691923566e-01, -1.823213502792115e-02, 1.003728203943496e-03, -6.465605772288917e-03,  8.912273122224043e-03, 7.149031090994093e-03, 1.409812141284960e-03, -1.568308729896485e-02, -2.216213872247570e-02, -1.813198275171131e-02, 1.350173797187556e-02, -1.823213502792125e-02,  1.099465066916245e-01, -3.874947151334163e-02, -2.165968877754310e-03, -3.751137800014352e-02,  4.689905911799291e-02, -4.383615818154919e-02, 1.344291043828210e-02, 4.547804803605196e-02,  6.175160328794779e-03, -1.325850684710933e-02, 1.003728203943292e-03, -3.874947151334186e-02,  1.207001859897884e-01, 2.702985895717004e-03, 2.864283992621214e-02, -3.723142055591878e-02,  2.553126973130451e-02, -3.716595260275181e-03, -2.733320943627039e-02, -1.815309741642825e-03,  3.560511596415147e-03, -6.465605772289769e-03, -2.165968877754406e-03, 2.702985895716520e-03,  1.051094020624611e-01, -2.052356428485316e-03, -1.599381739867882e-02, -9.046767827087939e-03,  3.470361470603774e-02, 1.905035707474667e-02, 7.229404000841758e-03, -4.357191944330700e-02,  8.912273122224049e-03, -3.751137800014587e-02, 2.864283992621422e-02, -2.052356428481737e-03,  1.703953984104540e-01, -7.251669645426440e-02, 7.912861169787756e-02, -3.368693235750962e-02, -8.288713469901463e-02, 7.017678866852450e-04, 5.706087872108304e-02, 7.149031090995370e-03,  4.689905911799445e-02, -3.723142055591901e-02, -1.599381739868082e-02, -7.251669645425605e-02,  2.561981084403698e-01, -7.603927833235938e-02, -2.511947582279112e-02, 4.617333603845414e-02, -1.110395538342481e-02, -5.046208085317033e-02, 1.409812141284384e-03, -4.383615818154997e-02,  2.553126973130506e-02, -9.046767827085814e-03, 7.912861169787400e-02, -7.603927833236088e-02,  2.072861989854679e-01, -3.937486734219343e-02, -7.973114049201964e-02, 1.354672788798024e-02,  4.749443257044972e-03, -1.568308729896619e-02, 1.344291043828203e-02, -3.716595260275967e-03,  3.470361470603756e-02, -3.368693235751413e-02, -2.511947582278885e-02, -3.937486734219638e-02,  1.795600200111635e-01, 6.008531472213145e-02, 1.303220279841736e-02, 2.679106724325791e-02, -2.216213872247579e-02, 4.547804803605332e-02, -2.733320943627189e-02, 1.905035707474374e-02, -8.288713469901382e-02, 4.617333603845931e-02, -7.973114049202246e-02, 6.008531472212775e-02,  1.857720001372204e-01, 1.435511143445264e-02, -2.987262056297151e-02, -1.813198275171179e-02,  6.175160328795098e-03, -1.815309741643704e-03, 7.229404000840549e-03, 7.017678866841686e-04, -1.110395538342210e-02, 1.354672788797862e-02, 1.303220279841612e-02, 1.435511143445359e-02,  1.418442239686164e-01, 5.598289446792613e-02, 2.162217234030782e-02, 1.265047257993934e-02, -1.397571781757700e-02, -2.574800232176981e-03, -4.021132804184585e-02, 6.892052297763798e-02, -4.648684934646406e-02, -9.901732013445911e-03, 1.589249644216322e-02, -3.323266599618301e-02,  2.162217234031329e-02, 1.216339186473697e-01, -2.137547858985624e-02, 7.065031115636436e-05, -2.853758275908030e-03, 4.884338706108261e-03, 7.611047154728584e-03, -3.942755831194288e-03, -1.187434785632972e-02, -1.533386708321249e-02, -1.947946445427327e-02, 1.265047257994069e-02, -2.137547858985635e-02, 1.053128398524623e-01, -3.648336810503830e-02, -8.832139774711738e-03, -3.006507824817355e-02, 4.608014152952134e-02, -4.185728903118184e-02, 5.482931877853888e-03,  3.556309913124812e-02, 1.309718262325851e-03, -1.397571781757636e-02, 7.065031115619273e-05, -3.648336810503879e-02, 1.297765687894019e-01, 8.564390176259956e-03, 2.459035597105812e-02, -3.477244904552131e-02, 2.372998073031465e-02, 2.149787363438798e-03, -1.939808321906413e-02,  2.462139665731268e-03, -2.574800232174699e-03, -2.853758275908736e-03, -8.832139774713300e-03,  8.564390176260333e-03, 1.132839763578221e-01, 5.949283306286552e-03, -2.274746665676402e-02,  5.423494999803860e-03, 2.931214184349624e-02, 5.289330225213170e-03, 5.977559786095997e-03, -4.021132804184360e-02, 4.884338706108242e-03, -3.006507824817585e-02, 2.459035597105985e-02,  5.949283306288427e-03, 1.679041892892915e-01, -7.428450750382803e-02, 6.524950720218184e-02, -1.670815775323202e-02, -6.737182822849504e-02, 5.270292685225147e-03, 6.892052297763827e-02,  7.611047154729615e-03, 4.608014152952528e-02, -3.477244904552249e-02, -2.274746665676346e-02, -7.428450750382255e-02, 2.790147461197147e-01, -8.146490800210220e-02, -2.949989003026119e-02,  4.931614355585578e-02, -1.731521031146364e-02, -4.648684934646362e-02, -3.942755831194822e-03, -4.185728903118305e-02, 2.372998073031508e-02, 5.423494999803933e-03, 6.524950720217881e-02, -8.146490800210097e-02, 1.959317644864790e-01, -1.222728817975186e-02, -5.470528273931648e-02,  2.173271434125534e-02, -9.901732013440334e-03, -1.187434785633084e-02, 5.482931877851475e-03,  2.149787363439466e-03, 2.931214184349644e-02, -1.670815775323383e-02, -2.949989003026366e-02, -1.222728817975146e-02, 1.716590668472932e-01, 3.109129902011070e-02, 1.388394762570135e-02,  1.589249644216364e-02, -1.533386708321249e-02, 3.556309913124886e-02, -1.939808321906495e-02,  5.289330225212141e-03, -6.737182822849359e-02, 4.931614355585676e-02, -5.470528273931802e-02,  3.109129902010987e-02, 1.687539268724204e-01, 7.242361596178960e-03, -3.323266599618473e-02, -1.947946445427376e-02, 1.309718262326014e-03, 2.462139665730477e-03, 5.977559786094844e-03,  5.270292685224193e-03, -1.731521031146129e-02, 2.173271434125393e-02, 1.388394762570021e-02,  7.242361596179800e-03, 1.503861389408429e-01, 6.657147549940122e-02, 2.123628894287862e-02,  1.744538793472995e-02, -1.773638152883938e-02, -5.549260874590872e-03, -4.859666427008487e-02,  9.104199911588438e-02, -5.486592406770278e-02, -1.765166071831405e-02, 2.100392479357554e-02, -3.704030805307457e-02, 2.123628894288413e-02, 1.515594505994542e-01, -2.896379299341013e-02,  8.507298470978621e-04, -5.954535855182458e-03, 1.058931032282776e-02, 5.981226347286248e-03,
                  -1.238615192031514e-03, -1.915108325968984e-02, -2.500039268533634e-02, -2.829291989375776e-02,  1.744538793473201e-02, -2.896379299341000e-02, 1.178725237372298e-01, -4.174380681036885e-02, -7.056100208856331e-03, -2.716663530655072e-02, 4.902745473931880e-02, -4.364757009031861e-02,  2.234712002894238e-03, 3.292429494365368e-02, -1.496360786597317e-03, -1.773638152883919e-02,  8.507298470975463e-04, -4.174380681036960e-02, 1.607403644811620e-01, 1.179336554623651e-02,  2.625145103724502e-02, -4.604506561068616e-02, 2.626307258523894e-02, 9.939704327883814e-03, -1.889107028272932e-02, 5.033812564399966e-03, -5.549260874588846e-03, -5.954535855183311e-03, -7.056100208858482e-03, 1.179336554623718e-02, 1.403706161322155e-01, 6.695797055887992e-03, -2.352969276932615e-02, 8.117685996446300e-03, 3.325237428993277e-02, 1.037574734247718e-02,  8.406045503151667e-03, -4.859666427008343e-02, 1.058931032282746e-02, -2.716663530655322e-02,  2.625145103724666e-02, 6.695797055889408e-03, 2.077974890227557e-01, -1.004916831386004e-01,  8.563404433791122e-02, -2.377298962630332e-02, -8.401805263952777e-02, 6.026099328449976e-03,  9.104199911588620e-02, 5.981226347287885e-03, 4.902745473932368e-02, -4.604506561068755e-02, -2.352969276932482e-02, -1.004916831385952e-01, 3.507587146003806e-01, -1.121383019641531e-01, -2.920703174792516e-02, 6.647672994208875e-02, -1.870547565037869e-02, -5.486592406770327e-02, -1.238615192032388e-03, -4.364757009032022e-02, 2.626307258523938e-02, 8.117685996445925e-03,  8.563404433790844e-02, -1.121383019641519e-01, 2.536460071357635e-01, -3.219684175963214e-02, -6.791158831448840e-02, 3.466350812029786e-02, -1.765166071830866e-02, -1.915108325969112e-02,  2.234712002891066e-03, 9.939704327884876e-03, 3.325237428993302e-02, -2.377298962630460e-02, -2.920703174792855e-02, -3.219684175963120e-02, 2.292803983062430e-01, 4.867869564606023e-02,  6.996455556469258e-03, 2.100392479357670e-02, -2.500039268533608e-02, 3.292429494365440e-02, -1.889107028272993e-02, 1.037574734247660e-02, -8.401805263952605e-02, 6.647672994208909e-02, -6.791158831448951e-02, 4.867869564605989e-02, 2.144581405646570e-01, 1.376915027709855e-02, -3.704030805307629e-02, -2.829291989375828e-02, -1.496360786597241e-03, 5.033812564399245e-03,  8.406045503150564e-03, 6.026099328449080e-03, -1.870547565037654e-02, 3.466350812029653e-02,  6.996455556468231e-03, 1.376915027709938e-02, 1.838948983026356e-01 ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(8 ))

  expect_equal(c(result_exp$Q),
               c( 0.0811992854821780713, -0.0148668281818819213, 0.0099290865036286077, 0.0023131140245354828,  0.0740493074082670122, -0.0256073453329111397, -0.0939248100003835101, -0.0100217815894890934,  0.1303912648411176822, 0.0553664333234564487, 0.0234806372658790397, -0.0148668281818819213,  0.0682758568253712256, -0.0551887276396524976, 0.0334390723056329220, -0.0088703266721802867,  0.0841712043080526523, -0.0888898238788539130, 0.0921499776273114884, -0.0442689223313546959, -0.1045289187933932662, -0.0221905051966314812, 0.0099290865036286077, -0.0551887276396524976,  0.3082280214599897317, -0.1998655443020427303, -0.0684191759192388504, -0.3183567196669809807,  0.5190899432716367112, -0.3765390657265438312, 0.0009554541368762548, 0.3228105125106952022,  0.0405070532056580543, 0.0023131140245354828, 0.0334390723056329220, -0.1998655443020427303,  0.1917165485242241507, 0.0636019223837986508, 0.2204404656359877368, -0.3916171190659756274,  0.2609826711342447814, 0.0297241735666343675, -0.2141027910515223009, -0.0257337528579460670,  0.0740493074082670122, -0.0088703266721802867, -0.0684191759192388504, 0.0636019223837986508,  0.1608537579173855703, 0.0813946645531395535, -0.3095106002303836257, 0.1236344398544931139,  0.1770282788082973568, -0.0335472227764328224, 0.0333338657730489138, -0.0256073453329111397,  0.0841712043080526523, -0.3183567196669809807, 0.2204404656359877368, 0.0813946645531395535,  0.5363570195702834775, -0.7361969896131728142, 0.5889783691159743428, -0.0593001377972292854, -0.5255370236614586021, -0.0377091476759182920, -0.0939248100003835101, -0.0888898238788539130,  0.5190899432716367112, -0.3916171190659756274, -0.3095106002303836257, -0.7361969896131728142,  1.4870045041910768813, -0.9113671781458930754, -0.2594636382706518862, 0.6830105438009645979, -0.0043162867494282052, -0.0100217815894890934, 0.0921499776273114884, -0.3765390657265438312,  0.2609826711342447814, 0.1236344398544931139, 0.5889783691159743428, -0.9113671781458930754,  0.7899794831497310987, -0.0621938420291714145, -0.6178464002256438548, -0.0120629953698368174,  0.1303912648411176822, -0.0442689223313546959, 0.0009554541368762548, 0.0297241735666343675,  0.1770282788082973568, -0.0593001377972292854, -0.2594636382706518862, -0.0621938420291714145,  0.4213441153980430620, 0.1620983025938859123, 0.0519403388721186299, 0.0553664333234564487, -0.1045289187933932662, 0.3228105125106952022, -0.2141027910515223009, -0.0335472227764328224, -0.5255370236614586021, 0.6830105438009645979, -0.6178464002256438548, 0.1620983025938859123,  0.6293213887977419096, 0.0586891250749007470, 0.0234806372658790397, -0.0221905051966314812,  0.0405070532056580543, -0.0257337528579460670, 0.0333338657730489138, -0.0377091476759182920, -0.0043162867494282052, -0.0120629953698368174, 0.0519403388721186299, 0.0586891250749007470,  0.0854930775169358004 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(2052, 1893, 1887, 1886, 1877, 1702, 1594, 1438, 1239, 1112 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})
