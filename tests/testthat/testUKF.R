if(interactive()){
  library(dynamichazard); library(testthat); library(survival); source("R/test_utils.R")
}


# Had issues with win builder. Thus, these lines
test_name <- "UKF"
cat("\nRunning", test_name, "\n")


test_that("UKF on head_neck works with logit model", {
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3,
                   method = "UKF", save_data = F, save_risk_set = F,
                   beta = 0),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "logit"
  ))
  # sink()
  # close(tmp)
  # matplot(result$state_vecs, type = "l")
  # get_expect_equal(result, file = "tmp.txt")

  expect_equal(c(result$state_vecs),
               c(-3.25347027308416026, -3.25348518175704404, -3.07342297817660404, -2.87982776868289525, -2.71347411931766302, -2.50760195207121583, -2.55500433010638028, -2.76551303378312863, -2.91591789772243404, -3.03593361486824076, -3.15363581560333550, -3.29563166961682663, -3.39498160370249646, -3.46082875960332847, -3.44894126638617138, -3.50314447916955096, -3.58489014221007407, -3.65715012061161060, -3.67623578540701290, -3.73929106974020131, -3.76086648729047113, -3.83675699388854863, -3.92950260901732040, -3.99630802914913863, -4.03781317499296399, -4.10386467010477496, -4.14807220495404927, -4.17192273805562674, -4.22527834757904230, -4.26052602151125193, -4.27802923398206314, 0.28314467098939328,  0.28341711307973327, 0.37231662657832926, 0.47912596350538245, 0.51602204998918177,  0.64273401925061979, 0.63026427351929037, 0.52474837435392385, 0.51660691233764056,  0.48497461421975291, 0.44557013767825299, 0.38202020930963870, 0.35860362561966602,  0.37128814204774874, 0.42253124791109881, 0.38636811791189363, 0.33625567805297429,  0.30787397938688410, 0.30322634897375350, 0.27662974349485103, 0.26821424113066467,  0.19384419558199328, 0.12717072340937846, 0.06995745919561791, 0.02200997013820158, -0.02030313271789833, -0.05434553665424643, -0.08041946043353154, -0.10214595586876887, -0.11640223558698601, -0.12343561176512610 ))

  expect_equal(c(result$state_vars),
               c( 0.27890208706433761, -0.05674156087237262, -0.05674156087237259, 0.30832244411997733,  0.22907299456629920, -0.07054986372374671, -0.07054986372374669, 0.27281079366263078,  0.20641927751791855, -0.07481194932541189, -0.07481194932541189, 0.25355941739814719,  0.18621898446389673, -0.07797694223094721, -0.07797694223094723, 0.23403545031696382,  0.16782540488486974, -0.08111400955125457, -0.08111400955125456, 0.21474190508687119,  0.15347409943388154, -0.08040908532391380, -0.08040908532391378, 0.20196408405772731,  0.13887630710897608, -0.08218133993631316, -0.08218133993631313, 0.19022973235333143,  0.13720994008460005, -0.08134139863658270, -0.08134139863658267, 0.19057442838481059,  0.14511195485474510, -0.07927919920623706, -0.07927919920623702, 0.20053080305009252,  0.15492898903389471, -0.07945276548812980, -0.07945276548812974, 0.21318379315542910,  0.16534886594288800, -0.08065363640363740, -0.08065363640363735, 0.22812110198457958,  0.17671794549301001, -0.08207156379098801, -0.08207156379098796, 0.24547295076417719,  0.19001541413007306, -0.08334349853215670, -0.08334349853215665, 0.26517316924176160,  0.20312685844629286, -0.08573171517857962, -0.08573171517857957, 0.28505470966279972,  0.21549765674345600, -0.08948667100691216, -0.08948667100691210, 0.30454815289511317,  0.22445797834457820, -0.09563636483719384, -0.09563636483719379, 0.32217826541330397,  0.23488323874662398, -0.10149027943881546, -0.10149027943881539, 0.34203255134260147,  0.24808539117571130, -0.10685693656866554, -0.10685693656866548, 0.36491936505949918,  0.26334319593569488, -0.11251797532122977, -0.11251797532122970, 0.39006830479438359,  0.27838981854711253, -0.11944922990285778, -0.11944922990285770, 0.41610910024196490,  0.29467115118605319, -0.12699584191360266, -0.12699584191360258, 0.44416036961743827,  0.31053933269322709, -0.13597857163889673, -0.13597857163889665, 0.47321529820671726,  0.33028719138729679, -0.14451877231635799, -0.14451877231635790, 0.50636812571923517,  0.35426420803906411, -0.15247895187164764, -0.15247895187164756, 0.54396888568019186,  0.38164663400653764, -0.16032650243034979, -0.16032650243034971, 0.58528153934548466,  0.41234501120104627, -0.16820885497735891, -0.16820885497735882, 0.62997684651337948,  0.44977788919837536, -0.17531923856312037, -0.17531923856312026, 0.67937378183655850,  0.49349336669744315, -0.18136890512766310, -0.18136890512766299, 0.73334176165057807,  0.54461515495142554, -0.18603072347065033, -0.18603072347065022, 0.79197245887592560,  0.60840476300308555, -0.18777423632839363, -0.18777423632839352, 0.85718857551504468,  0.68686424463453066, -0.18591187992901625, -0.18591187992901614, 0.92918920222214807 ))

  expect_equal(c(result$lag_one_cov),
               c(NULL ))

  expect_equal(c(result$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result$n_iter),
               c(7 ))

  expect_equal(c(result$Q),
               c(0.095369828559475484, 0.007195823231527877, 0.007195823231527877, 0.076434834365142645 ))

  expect_equal(c(result$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result$risk_set),
               c(NULL ))

  expect_equal(c(result$data),
               c(NULL ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result$method),
               c("UKF" ))

  expect_equal(c(result$model),
               c("logit" ))

  expect_equal(c(result$est_Q_0),
               c(FALSE ))

  expect_equal(c(result$LR),
               c(1 ))
})


set.seed(2972)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -1, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

test_that("UKF does not fail and both methods give the same",{
  res_new <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                  by = 1,
                  data = sims$res,
                  a_0 = rep(0, ncol(sims$res) + 1 - 4),
                  Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                  verbose = F,
                  control = list(eps = 1e-2, est_Q_0 = F, method = "UKF",
                                 kappa = 0, alpha = 1, beta = 0),
                  id = sims$res$id,
                  max_T = 10)


  res_old <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                      by = 1,
                      data = sims$res,
                      a_0 = rep(0, ncol(sims$res) + 1 - 4),
                      Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                      control = list(est_Q_0 = F, kappa = 0, alpha = 1, beta = 0, eps = 1e-2, method = "UKF_org"),
                      id = sims$res$id,
                      max_T = 10)

  expect_equal(res_new$state_vecs, res_old$state_vecs)
  expect_equal(res_new$state_vars, res_old$state_vars)
})

test_that("Chaning time scale in UKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$state_vecs, res_new_time$state_vecs)
  expect_equal(res$state_vars, res_new_time$state_vars)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

test_that("Testing UKF against prev computed values",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-2, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2,
                                  save_data = F, save_risk_set = F),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  # matplot(sims$betas, type = "l")
  # matplot(res$state_vecs, add = T, type = "l")
  # get_expect_equal(res, file = "tmp.txt")

  expect_equal(c(res$state_vecs),
               c(-1.586377228122479943, -1.586630033484746516, -1.428376221113095479, -0.784370178711367605, -0.641999351480161407, -0.518433459927804763, -0.727906112606297895, -0.559484221494314204, -0.731705419333232077, -0.248707136761067260, -0.367935180117968219, 2.198771692817839352, 2.175231794247460382, 2.045516835180890780, 1.933855355358886641,  1.603907220226844288, 1.196301311713791060, 1.818038819570645392, 3.400829273222566673, 3.299842637531596790,  2.550263998669416221, 2.388201262064851615, 0.920991063786816277, 0.886046736214297526, 0.953588306031064148,  1.175089262870585793, 0.791708045469890154, 0.593000224938449838, 1.215726149479578133, 2.375444389485041441,  1.464487580941969957, -0.335690612684172829, -0.806051122637007067, 1.425111865038881431, 1.480868651999746044,  1.253247745933509183, 0.066811905544865408, 0.497641457837281531, 0.801002033089991405, -0.008536873968637337, -2.724247674919297868, -1.405637265305051731, 0.315610362649203113, 1.135735482814673514 ))

  expect_equal(c(res$state_vars),
               c( 0.1824210226547152702, -0.0280567323423201904, -0.0510051459995278234, -0.0495654523271920333, -0.0280567323423278475,  0.4305693732570275989, -0.0013574119131351814, -0.1907928477608626938, -0.0510051459995305434, -0.0013574119131365258,  0.4189410607259385078, -0.2424785841118443086, -0.0495654523271992775, -0.1907928477608632212, -0.2424785841118429763,  0.6024630917946190989, 0.1013657754692213198, 0.0156306337058410849, 0.0073509843173614753, -0.0268884278373829472,  0.0156306337058329664, 0.4064563825696114185, 0.0685159081505088974, -0.3226725501523874939, 0.0073509843173616973,  0.0685159081505069267, 0.4141679079403943753, -0.3907653399689948737, -0.0268884278373968250, -0.3226725501523870498, -0.3907653399689898222, 0.8257138664824452690, 0.0663798238546949304, 0.0262599432837489349, 0.0246249497727718952, -0.0076471942063543047, 0.0262599432837406221, 0.3507836336884601613, 0.0690548826900880819, -0.2996261151965867175,  0.0246249497727720479, 0.0690548826900864443, 0.3610801623583721476, -0.3651998385274937697, -0.0076471942063682935, -0.2996261151965861069, -0.3651998385274876635, 0.7461269585768464108, 0.0592165548797238539, 0.0220032502799559909,  0.0216019785463589797, 0.0028276012260004812, 0.0220032502799478030, 0.2790894576969081275, 0.0599830146087604044, -0.2321988193208725793, 0.0216019785463590352, 0.0599830146087596966, 0.3062152034547571677, -0.3036780373732752558,  0.0028276012259867561, -0.2321988193208721074, -0.3036780373732677618, 0.6153341528879432420, 0.0464677116509729787,  0.0149739483771787751, 0.0090077371435139594, 0.0396265514245370959, 0.0149739483771707330, 0.1510173226968049565,  0.0044512076679463844, -0.0772574714336502488, 0.0090077371435133557, 0.0044512076679491721, 0.1649460466541940729, -0.1094233633948897277, 0.0396265514245242034, -0.0772574714336518586, -0.1094233633948788614, 0.2477618406607089707,  0.0457933278824830189, 0.0189979885556992474, 0.0181719065278271100, 0.0271404629246799478, 0.0189979885556913405,  0.1504277543321448363, 0.0100330729069115221, -0.0853888505698948558, 0.0181719065278262183, 0.0100330729069145318,  0.1581817287805460381, -0.1140592962951975375, 0.0271404629246679817, -0.0853888505698969930, -0.1140592962951878786,  0.2621288086480622059, 0.0461191460035962758, 0.0238808575706914543, 0.0195345526366445185, 0.0221014143085921586,  0.0238808575706839291, 0.1611883120170764239, 0.0170997395987705567, -0.1024694511914471529, 0.0195345526366442548,  0.0170997395987733392, 0.1582661013906956349, -0.1154217804871662256, 0.0221014143085789608, -0.1024694511914489292, -0.1154217804871567055, 0.2747418086179178598, 0.0505433907259783405, 0.0208193912344890042, 0.0124159188930033776,  0.0268482653090398246, 0.0208193912344817877, 0.1958486607521109923, 0.0334458343199537586, -0.1318413432886212655,  0.0124159188930035910, 0.0334458343199564301, 0.2120134817275364236, -0.1613327444182467707, 0.0268482653090259954, -0.1318413432886225978, -0.1613327444182368897, 0.3281275258530819139, 0.0552289918339923941, 0.0124368321962026462,  0.0005551672977831268, 0.0462487962034608333, 0.0124368321961957559, 0.2499891923201728594, 0.0646110960888437169, -0.1816810466370180344, 0.0005551672977833272, 0.0646110960888461872, 0.2401066921843042490, -0.1850146587074111282,  0.0462487962034465044, -0.1816810466370191446, -0.1850146587074022742, 0.3468552081735357673, 0.0604163269531132405,  0.0067712707394571442, -0.0015307105494844556, 0.0489851583859482326, 0.0067712707394502287, 0.2990597506576424536,  0.0634040541957961862, -0.1983717136626504951, -0.0015307105494842595, 0.0634040541957986842, 0.2699057656205353095, -0.2079062532167276489, 0.0489851583859339454, -0.1983717136626514388, -0.2079062532167189892, 0.3841578936288893575,  0.0602019128638456857, 0.0305336369372033664, 0.0309621279864029514, 0.0110088952405827216, 0.0305336369371969757,  0.3205268793431931273, 0.0292230528586805427, -0.2043880476042079231, 0.0309621279864037285, 0.0292230528586820970,  0.2681554241099355362, -0.2349343460011865670, 0.0110088952405680424, -0.2043880476042079231, -0.2349343460011785734,  0.4784499873473575526 ))

  expect_equal(c(res$lag_one_cov),
               c(NULL ))

  expect_equal(c(res$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(res$n_iter),
               c(32 ))

  expect_equal(c(res$Q),
               c( 0.12160536293782964, -0.05097094130727473, -0.07849865845916659, -0.06184413844291841, -0.05097094130727473,  0.66720696425256443, 0.50251010237681148, -0.95634626918935339, -0.07849865845916659, 0.50251010237681148,  0.95470908871885174, -1.27004602490409324, -0.06184413844291841, -0.95634626918935339, -1.27004602490409324,  2.19193807022204634 ))

  expect_equal(c(res$Q_0),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$n_risk),
               c(500, 476, 458, 421, 359, 295, 259, 214, 194, 157 ))

  expect_equal(c(res$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(res$risk_set),
               c(NULL ))

  expect_equal(c(res$data),
               c(NULL ))

  expect_equal(c(res$order),
               c(1 ))

  expect_equal(c(res$F_),
               c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1 ))

  expect_equal(c(res$method),
               c("UKF" ))

  expect_equal(c(res$model),
               c("logit" ))

  expect_equal(c(res$est_Q_0),
               c(FALSE ))

  expect_equal(c(res$LR),
               c(1 ))
})

test_that("Altering UKF alpha, beta and kappa change the results",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                   control = list(kappa = 0, alpha = 1, beta = 0,
                                  est_Q_0 = F, method = "UKF", eps = 1e-2),
                   id = sims$res$id,
                   verbose = F,
                   max_T = 10)
  suppressMessages(m1 <- do.call(ddhazard, arg_list))

  arg_list$control$beta <- 2

  suppressMessages(m2 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m1$state_vecs, m2$state_vecs)) == "character")
  expect_true(class(all.equal(m1$state_vars, m2$state_vars)) == "character")

  arg_list$control$alpha <- .1
  arg_list$control$kappa <- 4 / (.1)^2 + 4

  suppressMessages(m3 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m2$state_vecs, m3$state_vecs)) == "character")
  expect_true(class(all.equal(m2$state_vars, m3$state_vars)) == "character")

  arg_list$control$beta <- 0
  arg_list$control$alpha <- 1
  arg_list$control$kappa <- .5

  suppressMessages(m4 <- do.call(ddhazard, arg_list))

  expect_true(class(all.equal(m3$state_vecs, m4$state_vecs)) == "character")
  expect_true(class(all.equal(m3$state_vars, m4$state_vars)) == "character")
})

arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                 by = 1,
                 data = NULL,
                 Q_0 = diag(rep(1, ncol(sims$res) + 1 - 4)),
                 Q = diag(rep(1e-1, ncol(sims$res) + 1 - 4)),
                 control = list(kappa = 0, alpha = 1, beta = 0,
                                est_Q_0 = F, method = "UKF", eps = 1e-2),
                 id = NULL,
                 verbose = F,
                 max_T = 10)

set.seed(2972)
sims <- test_sim_func_logit(n_series = 2e3, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 1,
                            intercept_start = -2, sds = c(.1, rep(1, 3)))
sum(sims$res$event)

arg_list$data <- sims$res
arg_list$id <- sims$res$id

arg_list$control$beta <- 0
suppressMessages(fit1 <- do.call(ddhazard, arg_list))

arg_list$control$beta = 2
suppressMessages(fit2 <- do.call(ddhazard, arg_list))

# matplot(sims$betas, type = "l", lty = 1, ylim = range(sims$betas, fit1$state_vecs, fit2$state_vecs))
# matplot(fit1$state_vecs, type = "l", lty = 2, add = T)
# matplot(fit2$state_vecs, type = "l", lty = 4, add = T)

test_that("UKF on head_neck works with exponential model", {
  # Change by argument
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(start, stop, event) ~ group,
    data = head_neck_cancer,
    by = 1, Q_0 = diag(1, 2), a_0 = c(-3, 0),
    Q = diag(1e-1, 2),
    control = list(est_Q_0 = F, n_max = 10^4, eps = 10^-3, beta = 0,
                   method = "UKF", save_data = F, save_risk_set = F),
    max_T = 30,
    id = head_neck_cancer$id, order = 1,
    verbose = F,
    model = "exponential"
  ))
  # sink()
  # close(tmp)
  # matplot(result_exp$state_vecs, type = "l")
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-3.269312599750143988, -3.269197862646453956, -3.104885444658833649, -2.928897832218397834, -2.782057810442525980, -2.600837038124587330, -2.654115861702174950, -2.847454705778457829, -2.981849883445724103, -3.091176140108300441, -3.199350881891904752, -3.329694793478519266, -3.420505540924595689, -3.480507771129218053, -3.471404105823772124, -3.523795955733581842, -3.600994068411660809, -3.668895308135079247, -3.689497170656039771, -3.749419441301436784, -3.772574766895772314, -3.845827049305180712, -3.933041749178425750, -3.996837999103710182, -4.037850317540603307, -4.099568557503340926, -4.141532951351009295, -4.165079022896459371, -4.213634580756536074, -4.245715381762500407, -4.261647730119692667, 0.281871889014344068,  0.282058758542807930, 0.353382355278996418, 0.437062600264207846, 0.468134242619716923,  0.563028024259429549, 0.546248180882790590, 0.463049659756999132, 0.453508247442041823,  0.427459578322440636, 0.395509291576195632, 0.345462278202971707, 0.325730899799145934,  0.332630535037540087, 0.368874363141783845, 0.340481270673724024, 0.301036904525137594,  0.277342506400808264, 0.271954345595538771, 0.249437879985356548, 0.240893212683506108,  0.183816885007242192, 0.131975442329176518, 0.087898851198681016, 0.051371492092545712,  0.018307312477981647, -0.008033809711030987, -0.027929708909459713, -0.045435886245177373, -0.056934327724024986, -0.062612603119453478 ))

  expect_equal(c(result_exp$state_vars),
               c( 0.26085750895924154, -0.04890853140028083, -0.04890853140028428, 0.26648051925508087,  0.21445032426265415, -0.06038025985913355, -0.06038025985913752, 0.23693383148101194,  0.19217516942386859, -0.06440992954773039, -0.06440992954773428, 0.21918994652339463,  0.17247164379102148, -0.06757415438992270, -0.06757415438992653, 0.20185318375287414,  0.15466408790633504, -0.07069416089549292, -0.07069416089549667, 0.18520919708344763,  0.14081557400285841, -0.07069708874859204, -0.07069708874859577, 0.17365717316223964,  0.12666538521382312, -0.07278923812593957, -0.07278923812594337, 0.16324983401317034,  0.12494609761356520, -0.07193939018004462, -0.07193939018004845, 0.16311037112511551,  0.13240572540820456, -0.06942672763886309, -0.06942672763886693, 0.17126579761950947,  0.14139592830989656, -0.06891872606063917, -0.06891872606064303, 0.18159178275393506,  0.15083238460557369, -0.06938923020286192, -0.06938923020286580, 0.19380179067983949,  0.16111584640418203, -0.07014862006819750, -0.07014862006820141, 0.20796373326796835,  0.17314722182858935, -0.07088086700457719, -0.07088086700458111, 0.22401951700618439,  0.18495829010270651, -0.07261276617416364, -0.07261276617416756, 0.24043269670630596,  0.19604460238844715, -0.07548292499596848, -0.07548292499597245, 0.25684102333482151,  0.20416241361754267, -0.08023884270998830, -0.08023884270999228, 0.27232240933761487,  0.21357097880543358, -0.08490482947629582, -0.08490482947629981, 0.28939429094835678,  0.22544974600824119, -0.08921772986532955, -0.08921772986533355, 0.30865495516351688,  0.23912413227606161, -0.09370456659300772, -0.09370456659301171, 0.32962578113557178,  0.25267296622140278, -0.09911424507370553, -0.09911424507370953, 0.35141170919170117,  0.26729959924243496, -0.10492265939689237, -0.10492265939689638, 0.37471386919138761,  0.28165661780666307, -0.11172301959173739, -0.11172301959174140, 0.39889081026549744,  0.29949683011135264, -0.11814115971106816, -0.11814115971107217, 0.42580522064100801,  0.32111174488939043, -0.12395980416665067, -0.12395980416665470, 0.45571836387094333,  0.34583731692242620, -0.12953698401938224, -0.12953698401938626, 0.48811197941846429,  0.37364699024510428, -0.13497227899146061, -0.13497227899146461, 0.52274216292928133,  0.40737052807815316, -0.13953557092894636, -0.13953557092895036, 0.56043053593885250,  0.44669256920179001, -0.14301308617251257, -0.14301308617251657, 0.60107085734772270,  0.49260695975120750, -0.14513851269891009, -0.14513851269891409, 0.64468974383336053,  0.54942275884813696, -0.14463396679780513, -0.14463396679780913, 0.69245967470466097,  0.61883997124940404, -0.14097014498807658, -0.14097014498808058, 0.74447772559535697 ))

  expect_equal(c(result_exp$lag_one_cov),
               c(NULL ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(16 ))

  expect_equal(c(result_exp$Q),
               c(0.083690957288656401, 0.007830052950138168, 0.007830052950138168, 0.054804487884793793 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})

test_that("UKF on simulated data works with exponential model", {
  set.seed(9997)
  sims <- test_sim_func_exp(n_series = 1e3, n_vars = 10, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = 0, re_draw = T, beta_start = (1:10 - 5) / 2.5,
                            intercept_start = -5, sds = c(.1, rep(1, 10)))
  # tmp <- file("tmp.txt")
  # sink(tmp)
  suppressMessages(result_exp <- ddhazard(
    formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
    data = sims$res,
    by = (by_ <- 1),
    Q_0 = diag(1, 11),
    Q = diag(1e-1, 11),
    control = list(est_Q_0 = F, eps = 10^-2, n_max = 10^3, method = "UKF",
                   debug = F, beta = 0, save_data = F, save_risk_set = F),
    max_T = 10,
    id = sims$res$id, order = 1,
    verbose = F,
    model = "exponential"))
  # sink()
  # close(tmp)

  # sum(sims$res$event)
  # diag(result_exp$Q)
  # result_exp$LR
  # matplot(sims$betas, type = "l", lty = 1)
  # matplot(result_exp$state_vecs, type = "l", lty = 2, add = T)
  # get_expect_equal(result_exp, file = "tmp.txt")

  expect_equal(c(result_exp$state_vecs),
               c(-4.941986513610550524, -4.942896983885742834, -4.815352396036972848, -4.698884147383275867, -4.694681137715979169, -4.666934633306203395, -4.678745120901998789, -4.637474806390120108, -4.539571695853072519, -4.232821932725617131, -3.797937210266962627, -2.073207368409348827, -2.074380744415620370, -2.087588825248671398, -2.115496553412261616, -2.047085104323076887, -2.063123897534844264, -2.089366943289474587, -2.158480480087285436, -2.155985188334351044, -1.956206854704228837, -1.789623237533834788, -0.377626095715023424, -0.388812369075206110, -0.325484351580935360,  0.018533501552796261, 0.495608476888371285, 0.329808312018968652, 0.015982168751287718, -0.861877996153066928, -1.526650676314311506, -0.831772446660414833, 0.500260115543968320, -0.030524734087731410, -0.027707491348773483, -0.057471952565174705, -0.161648211366398703, -0.444238680753436477, -0.247654375368857177, 0.008960083283585649,  0.526510881161214028, 0.979969677402074302, 0.508309687367865082, -0.347881318856914756, -0.148762458687671933, -0.160408791653709110, -0.189642472822239949, -0.039034360719508193, -0.112242352422963043, 0.345303033685450789,  0.642436284886786169, 0.982812339371882282, 1.243005353067443641, 1.386807998530931396, 1.501924478814399722,  0.046428408342397413, -0.017808814965630415, -0.362617467739461186, 0.607684287828351710, 0.667021305394410291,  2.109066657701290204, 2.531641644542502956, 2.669727312000097719, 2.739599099638673430, 2.411517717954438034,  2.228613862875014728, -1.259784651953768986, -1.185425736192583290, -0.961701724861743656, -2.216646643657582683, -1.839678287299822301, -3.999296488716606923, -4.960806104645764769, -5.994362758616761155, -6.810060779134744280, -6.217774076419138929, -5.388522498380613257, 0.197876754638697583, 0.121356720694685866, -0.194144360435314578,  1.162042794004567670, 1.218566735310840921, 3.003812255277613641, 3.169416797237820660, 3.505600638034713334,  3.867949983215360987, 3.056364768528820441, 1.947021538639722937, 1.262767493828414800, 1.247014608060635910,  1.382015404807360071, 1.743563310364431684, 1.684679818663476825, 2.217019682889291854, 2.754069575791381119,  2.996271618541624271, 3.247421831472856901, 3.827264553686336335, 4.778759742438500879, 2.290797566271058017,  2.360322598009710227, 2.864732412762021063, 1.893405977058743250, 1.696691921965546523, 0.252712888082564979, -0.003804641174824985, 0.005938842280399037, 0.059579760441348911, 0.680046834850378090, 1.396346251799547300,  2.966575832892319742, 2.946595635451664030, 3.078273558044255509, 3.713484486400308704, 3.806606334499300193,  4.118267482532184331, 3.753154702624248884, 3.492907738489743785, 3.351597246205362701, 3.112886793470127866,  2.986407969034131860 ))

  expect_equal(c(result_exp$state_vars),
               c( 1.574894572372375e-01, 3.249651579000069e-02, 5.612329329948985e-02, -3.131440260564831e-02, 3.623914467504815e-02, -1.025302475695146e-02, -3.305139569504656e-03, -9.229409775470111e-03, 6.444689879591767e-02, 2.620657250543872e-02, -1.030522844965626e-02, 3.249651579000401e-02, 2.210552142076867e-01, 2.553895669156054e-02, -1.196621338675797e-02,  1.560178571294973e-02, -1.039879661069792e-02, 1.298848259236451e-02, -4.763294057422753e-03, 1.472446711643068e-02, -2.338202089256529e-03, -1.570484736325248e-02, 5.612329329949718e-02, 2.553895669156016e-02, 4.102324014140956e-01, -1.444085388222396e-01, -1.137166011185497e-02, 3.398147222251668e-02, 9.521266124690729e-02, -4.130775733658266e-02,  8.686564572338286e-02, -1.964030744443022e-03, 5.578053049848308e-02, -3.131440260565476e-02, -1.196621338675736e-02, -1.444085388222395e-01, 2.860753179476097e-01, -3.586813187027756e-03, -1.300661367641156e-02, -7.094043553387552e-02,  3.445845243473829e-02, -4.424170235505854e-02, -4.277415088010530e-03, -2.921241532938029e-02, 3.623914467504424e-02,  1.560178571294940e-02, -1.137166011185531e-02, -3.586813187027425e-03, 2.437452585868274e-01, 2.225984911266531e-02, -7.642773373913490e-02, 7.810742684375446e-03, 8.235331680255809e-02, 1.314930273651013e-02, -4.366840246139919e-02, -1.025302475696923e-02, -1.039879661069671e-02, 3.398147222251698e-02, -1.300661367641153e-02, 2.225984911266490e-02,  2.872937537352892e-01, -1.305858805169644e-01, 1.046039585519013e-01, 4.385814462575447e-02, -1.246745220639156e-01,  1.994317768393833e-02, -3.305139569515573e-03, 1.298848259236525e-02, 9.521266124690726e-02, -7.094043553387580e-02, -7.642773373913535e-02, -1.305858805169649e-01, 4.810065779755843e-01, -1.464707220463253e-01, -9.811907837525881e-02,  8.607499241720273e-02, 8.613369743159788e-03, -9.229409775466843e-03, -4.763294057423456e-03, -4.130775733658262e-02,  3.445845243473802e-02, 7.810742684375636e-03, 1.046039585519010e-01, -1.464707220463257e-01, 4.211626672062790e-01, -4.324372310545242e-02, -1.494761711235716e-01, 8.688613759220776e-02, 6.444689879591850e-02, 1.472446711643030e-02,  8.686564572338240e-02, -4.424170235505876e-02, 8.235331680255799e-02, 4.385814462575544e-02, -9.811907837525884e-02, -4.324372310545244e-02, 4.044800404124451e-01, 4.671858588940250e-02, -4.079432678623079e-02, 2.620657250543756e-02, -2.338202089257601e-03, -1.964030744442988e-03, -4.277415088010180e-03, 1.314930273651056e-02, -1.246745220639144e-01,  8.607499241720293e-02, -1.494761711235720e-01, 4.671858588940145e-02, 3.811822055074332e-01, -2.588413659130980e-02, -1.030522844967018e-02, -1.570484736325119e-02, 5.578053049848331e-02, -2.921241532938035e-02, -4.366840246139899e-02,  1.994317768393964e-02, 8.613369743161025e-03, 8.688613759220805e-02, -4.079432678623204e-02, -2.588413659131052e-02,  3.590741096216221e-01, 1.262565038477891e-01, 2.991348510916306e-02, 5.084310621417163e-02, -2.943993813858847e-02,  2.820586749323821e-02, -1.029690441351133e-02, 9.944110517878274e-03, -1.621569216904344e-02, 5.032741306208880e-02,  2.086021142472798e-02, -1.735596083027653e-02, 2.991348510916764e-02, 1.927019241982144e-01, 2.432604831102809e-02, -1.234315976565064e-02, 1.196621957105896e-02, -1.091786055217140e-02, 1.428138762530919e-02, -8.024147588737391e-03,  1.411818506560104e-02, 2.375586315835041e-03, -1.189741475341103e-02, 5.084310621418135e-02, 2.432604831102733e-02,  3.202796946268748e-01, -1.126017677469166e-01, -3.823575204539817e-03, 1.493297920974792e-02, 7.623603799464647e-02, -4.207916843938961e-02, 7.658212905005912e-02, 1.502143344104723e-02, 3.818605623704346e-02, -2.943993813859673e-02, -1.234315976564975e-02, -1.126017677469167e-01, 2.447594995696148e-01, -6.008527347722321e-03, -2.399091756785023e-03, -6.223090038892732e-02, 3.601952789988627e-02, -4.140379724044192e-02, -1.517254132896911e-02, -2.018307701987111e-02,  2.820586749323482e-02, 1.196621957105820e-02, -3.823575204541093e-03, -6.008527347721351e-03, 2.060351186742681e-01,  1.812029903114167e-02, -5.603590843607567e-02, 5.451093719946143e-03, 6.717769165119343e-02, 9.328483062973913e-03, -3.705799354388901e-02, -1.029690441353334e-02, -1.091786055217010e-02, 1.493297920974631e-02, -2.399091756783870e-03,  1.812029903114024e-02, 2.094149699534731e-01, -8.890167593792210e-02, 7.698431917239046e-02, 2.795250141372006e-02, -9.289706585637166e-02, 1.738543795680138e-02, 9.944110517867845e-03, 1.428138762530934e-02, 7.623603799464471e-02, -6.223090038892641e-02, -5.603590843607626e-02, -8.890167593792186e-02, 3.694358425449202e-01, -1.153028193265643e-01, -5.849128551930445e-02, 8.171746369544115e-02, 8.903598109367803e-03, -1.621569216904395e-02, -8.024147588737089e-03, -4.207916843938850e-02, 3.601952789988519e-02, 5.451093719946006e-03, 7.698431917238818e-02, -1.153028193265654e-01,  3.579632809804492e-01, -4.355032327529070e-02, -1.371739369373593e-01, 7.721247639189713e-02, 5.032741306209256e-02,  1.411818506559973e-02, 7.658212905005771e-02, -4.140379724044145e-02, 6.717769165119389e-02, 2.795250141372390e-02, -5.849128551930351e-02, -4.355032327529081e-02, 3.390730624343377e-01, 4.105833486885827e-02, -4.286271766066318e-02,  2.086021142472991e-02, 2.375586315832835e-03, 1.502143344104618e-02, -1.517254132896785e-02, 9.328483062974721e-03, -9.289706585636807e-02, 8.171746369544167e-02, -1.371739369373594e-01, 4.105833486885686e-02, 3.345493039024467e-01, -3.369274330572355e-02, -1.735596083029452e-02, -1.189741475340969e-02, 3.818605623704230e-02, -2.018307701987029e-02, -3.705799354388965e-02, 1.738543795680321e-02, 8.903598109368898e-03, 7.721247639189931e-02, -4.286271766066714e-02, -3.369274330572643e-02, 3.133408709084689e-01, 1.035783358924909e-01, 2.937525192511012e-02, 6.111277918238471e-02, -3.594687570372239e-02, 2.499162501969641e-02, -1.153509019687929e-02, 2.027231106281384e-02, -2.917123234174196e-02,  5.489275218511300e-02, 2.409716903946152e-02, -2.047669404574605e-02, 2.937525192511439e-02, 1.733211101610206e-01,  3.137917034637532e-02, -1.705080672505545e-02, 1.173092425857833e-02, -1.317088878639777e-02, 2.039659345270280e-02, -1.667862833067742e-02, 1.921417379447597e-02, 8.226474270192078e-03, -1.304139409649406e-02, 6.111277918239347e-02,  3.137917034637473e-02, 3.650074134971039e-01, -1.541298693638855e-01, -6.670511418430182e-03, -5.547650839275574e-03,  1.340472446742645e-01, -9.628857376972312e-02, 1.047721368904717e-01, 5.067897771846806e-02, 4.206311343636012e-02, -3.594687570372967e-02, -1.705080672505467e-02, -1.541298693638855e-01, 2.541883237491519e-01, -1.349402266193640e-03,  1.631507966878977e-02, -1.084255485087008e-01, 7.888696561135065e-02, -5.851702777144356e-02, -4.356247884842858e-02, -2.170907908279474e-02, 2.499162501969410e-02, 1.173092425857770e-02, -6.670511418431149e-03, -1.349402266192931e-03,  1.933339806524411e-01, 3.083395754686993e-02, -8.358545762424439e-02, 1.569645568834323e-02, 8.237955475628092e-02,  1.735444954241255e-03, -3.930160279143669e-02, -1.153509019689595e-02, -1.317088878639609e-02, -5.547650839275090e-03,  1.631507966878943e-02, 3.083395754686927e-02, 2.197352710621989e-01, -1.555889861708731e-01, 1.365680239972494e-01,  3.006153434697190e-02, -1.340043568675790e-01,
                  2.717688601846123e-02, 2.027231106279601e-02, 2.039659345270254e-02,  1.340472446742601e-01, -1.084255485086981e-01, -8.358545762424610e-02, -1.555889861708729e-01, 5.094533583419710e-01, -2.339283484734394e-01, -7.484437270713773e-02, 1.641394479407461e-01, 1.356427483856757e-03, -2.917123234173585e-02, -1.667862833067679e-02, -9.628857376971994e-02, 7.888696561134823e-02, 1.569645568834418e-02, 1.365680239972483e-01, -2.339283484734420e-01, 4.561583790921447e-01, -6.510236021061903e-02, -2.251236524758284e-01, 9.798330729964153e-02,  5.489275218511763e-02, 1.921417379447489e-02, 1.047721368904710e-01, -5.851702777144364e-02, 8.237955475628134e-02,  3.006153434697337e-02, -7.484437270713377e-02, -6.510236021062200e-02, 3.732444824087654e-01, 6.024229323418434e-02, -5.115398509479029e-02, 2.409716903945816e-02, 8.226474270189521e-03, 5.067897771846513e-02, -4.356247884842608e-02,  1.735444954241236e-03, -1.340043568675768e-01, 1.641394479407478e-01, -2.251236524758284e-01, 6.024229323418046e-02,  3.797039792597866e-01, -5.324611473789664e-02, -2.047669404576276e-02, -1.304139409649262e-02, 4.206311343635940e-02, -2.170907908279419e-02, -3.930160279143706e-02, 2.717688601846329e-02, 1.356427483857531e-03, 9.798330729964386e-02, -5.115398509479371e-02, -5.324611473789961e-02, 3.052367266381696e-01, 8.262516246379191e-02, 2.690950996575281e-02,  5.410272568842185e-02, -3.179122321145492e-02, 2.050734616711628e-02, -7.982950266428330e-03, 2.011304242573710e-02, -2.453420728961268e-02, 4.441847081214697e-02, 1.446619590795986e-02, -2.170313902358130e-02, 2.690950996575705e-02,  1.520285799174145e-01, 3.037580893579488e-02, -1.580485467674230e-02, 1.011961429043539e-02, -1.308287822156515e-02,  2.080569599518307e-02, -1.609051705644881e-02, 1.669162630354085e-02, 7.967291470639220e-03, -1.175923275884285e-02,  5.410272568843080e-02, 3.037580893579440e-02, 2.990680123605540e-01, -1.222093308538582e-01, 4.292553519254404e-03, -3.532736738858299e-03, 9.915351794349922e-02, -8.074876880956025e-02, 9.645037315034209e-02, 4.615272598556485e-02,  2.748922914654153e-02, -3.179122321146224e-02, -1.580485467674152e-02, -1.222093308538581e-01, 2.145255946338103e-01, -8.154561318307350e-03, 1.354777401611381e-02, -8.192818607751957e-02, 6.746266967416412e-02, -5.626261695837403e-02, -3.960959551343362e-02, -1.395483127556784e-02, 2.050734616711403e-02, 1.011961429043485e-02, 4.292553519253610e-03, -8.154561318306748e-03, 1.626157309811851e-01, 2.503159796338164e-02, -6.000377985681109e-02, 6.355272196356771e-03,  7.050691428405098e-02, 4.770165566036950e-03, -3.170056949970342e-02, -7.982950266444978e-03, -1.308287822156340e-02, -3.532736738858073e-03, 1.354777401611364e-02, 2.503159796338113e-02, 1.716183465316303e-01, -1.176296103337073e-01,  1.034884837735040e-01, 1.954783505717838e-02, -1.016177583581305e-01, 2.326550119286757e-02, 2.011304242571937e-02,  2.080569599518272e-02, 9.915351794349458e-02, -8.192818607751697e-02, -6.000377985681324e-02, -1.176296103337064e-01,  4.162895906476775e-01, -1.857817362982129e-01, -5.585394096556033e-02, 1.306202632035608e-01, -5.958331251803362e-03, -2.453420728960636e-02, -1.609051705644804e-02, -8.074876880955706e-02, 6.746266967416195e-02, 6.355272196358082e-03,  1.034884837735025e-01, -1.857817362982155e-01, 3.855198673605444e-01, -6.753078489245795e-02, -1.855792478107955e-01,  8.765557536447703e-02, 4.441847081215116e-02, 1.669162630353977e-02, 9.645037315034108e-02, -5.626261695837401e-02,  7.050691428405136e-02, 1.954783505718015e-02, -5.585394096555673e-02, -6.753078489246055e-02, 3.315853059428298e-01,  6.139785927092251e-02, -4.561576062866720e-02, 1.446619590795619e-02, 7.967291470636462e-03, 4.615272598556147e-02, -3.960959551343098e-02, 4.770165566036725e-03, -1.016177583581278e-01, 1.306202632035623e-01, -1.855792478107951e-01,  6.139785927091862e-02, 3.205327254517943e-01, -4.720041620168907e-02, -2.170313902359811e-02, -1.175923275884139e-02,  2.748922914654064e-02, -1.395483127556714e-02, -3.170056949970379e-02, 2.326550119286978e-02, -5.958331251802961e-03,  8.765557536447996e-02, -4.561576062867100e-02, -4.720041620169256e-02, 2.691544564332173e-01, 6.624567089834278e-02,  2.502946021905534e-02, 4.032427003294829e-02, -2.487867166722912e-02, 1.535611498367885e-02, -9.744453335858648e-03,  2.644714145194267e-02, -2.643987179460528e-02, 2.803621412774873e-02, 8.777392257790444e-03, -2.801386049726432e-02,  2.502946021905940e-02, 1.312088114196638e-01, 2.903718057313740e-02, -1.343172027331112e-02, 8.751642217330071e-03, -1.062044658047770e-02, 1.597535048426425e-02, -1.076591704726007e-02, 1.436633228213075e-02, 3.850338124838499e-03, -8.156209271676242e-03, 4.032427003295656e-02, 2.903718057313700e-02, 2.304653014270490e-01, -8.603355248316123e-02,  4.041163067510236e-03, -2.476955301074018e-03, 7.482667682690863e-02, -6.175824225638121e-02, 6.826011386562250e-02,  3.190226037872976e-02, 1.352656780520591e-02, -2.487867166723581e-02, -1.343172027331033e-02, -8.603355248316077e-02,  1.729767374675056e-01, -1.043544660790666e-02, 7.286154157606721e-03, -5.400643216155478e-02, 4.637018601460713e-02, -4.461943831111219e-02, -2.576910134810354e-02, -8.806824766696471e-03, 1.535611498367728e-02, 8.751642217329722e-03,  4.041163067510328e-03, -1.043544660790664e-02, 1.345857123889511e-01, 1.936021982069323e-02, -3.863259957407792e-02, -1.251150379690553e-03, 5.087358290458634e-02, 4.452272009828215e-03, -2.847655321050112e-02, -9.744453335871497e-03, -1.062044658047554e-02, -2.476955301069806e-03, 7.286154157604364e-03, 1.936021982069444e-02, 1.313670099171738e-01, -7.959881252634893e-02, 6.352613878422927e-02, 1.174545716144011e-02, -6.635119875180763e-02, 1.172459133874937e-02,  2.644714145191980e-02, 1.597535048426316e-02, 7.482667682689838e-02, -5.400643216154915e-02, -3.863259957408222e-02, -7.959881252634668e-02, 3.174043010734523e-01, -1.205187010037126e-01, -3.053114626914457e-02, 8.978260798689344e-02,  4.748297283646586e-03, -2.643987179459415e-02, -1.076591704725873e-02, -6.175824225637312e-02, 4.637018601460256e-02, -1.251150379686990e-03, 6.352613878422923e-02, -1.205187010037184e-01, 2.904505555455615e-01, -6.271749398608886e-02, -1.262953584071583e-01, 6.100253728388631e-02, 2.803621412775335e-02, 1.436633228212993e-02, 6.826011386562267e-02, -4.461943831111325e-02, 5.087358290458617e-02, 1.174545716143691e-02, -3.053114626913468e-02, -6.271749398609770e-02,  2.617817575579205e-01, 4.590231136170361e-02, -4.566412983192621e-02, 8.777392257782759e-03, 3.850338124835331e-03,  3.190226037872237e-02, -2.576910134809896e-02, 4.452272009825987e-03, -6.635119875180692e-02, 8.978260798689877e-02, -1.262953584071590e-01, 4.590231136169420e-02, 2.441121599155607e-01, -3.188971708258320e-02, -2.801386049728000e-02, -8.156209271674587e-03, 1.352656780520628e-02, -8.806824766696430e-03, -2.847655321050108e-02, 1.172459133875098e-02,  4.748297283647373e-03, 6.100253728388838e-02, -4.566412983192877e-02, -3.188971708258555e-02, 2.266905702777672e-01,  5.951072836981310e-02, 2.268927647366392e-02, 3.456514496087061e-02, -2.147994675263576e-02, 1.430404297633157e-02, -1.162803423514530e-02, 2.553262517248844e-02, -3.055431802219573e-02, 2.661093558498271e-02,
                  1.289849465196483e-02, -3.056244661549501e-02, 2.268927647366799e-02, 1.177758314684782e-01, 2.950356406149696e-02, -1.333908299641965e-02,  7.316220272920152e-03, -1.158496390833999e-02, 1.755476586167447e-02, -1.292343929847089e-02, 1.293288674338509e-02,  2.436862623910695e-03, -8.898483393233271e-03, 3.456514496087937e-02, 2.950356406149670e-02, 2.395550407781446e-01, -9.656253578626139e-02, -4.711281386199075e-03, 3.026735604193193e-03, 8.633602645556582e-02, -6.810806846796454e-02,  6.611721459340920e-02, 2.733263342227433e-02, 1.535080277320610e-02, -2.147994675264284e-02, -1.333908299641895e-02, -9.656253578626102e-02, 1.674809355813031e-01, -3.148047362034914e-03, 8.321496091250741e-03, -6.537930923583241e-02,  5.291706647230902e-02, -4.115242796173983e-02, -2.602652505627534e-02, -1.029526851871014e-02, 1.430404297632975e-02,  7.316220272919789e-03, -4.711281386199474e-03, -3.148047362034594e-03, 1.232097530666879e-01, 2.025143653872580e-02, -4.518213456381302e-02, 2.263325825665633e-03, 4.808175278786635e-02, 4.536441627925866e-03, -2.895414085173742e-02, -1.162803423515956e-02, -1.158496390833811e-02, 3.026735604195529e-03, 8.321496091249493e-03, 2.025143653872645e-02,  1.330908102298873e-01, -8.570263701179166e-02, 7.312019188189675e-02, 1.381340614369760e-02, -7.464823443987592e-02,  1.443937624444487e-02, 2.553262517246789e-02, 1.755476586167381e-02, 8.633602645555812e-02, -6.537930923582833e-02, -4.518213456381643e-02, -8.570263701178921e-02, 3.299645065780146e-01, -1.322569370222445e-01, -3.493933096793714e-02,  9.096426242895447e-02, 5.899511411049888e-03, -3.055431802218651e-02, -1.292343929846992e-02, -6.810806846795847e-02,  5.291706647230573e-02, 2.263325825668381e-03, 7.312019188189625e-02, -1.322569370222495e-01, 2.906502332424358e-01, -6.096471853771820e-02, -1.320344137885848e-01, 5.877407859889436e-02, 2.661093558498685e-02, 1.293288674338420e-02,  6.611721459340847e-02, -4.115242796174032e-02, 4.808175278786637e-02, 1.381340614369610e-02, -3.493933096792991e-02, -6.096471853772474e-02, 2.478537715904670e-01, 4.550717303451809e-02, -4.529466622386297e-02, 1.289849465195867e-02,  2.436862623907778e-03, 2.733263342226849e-02, -2.602652505627174e-02, 4.536441627924400e-03, -7.464823443987446e-02,  9.096426242895879e-02, -1.320344137885853e-01, 4.550717303451060e-02, 2.382385045672306e-01, -3.191173660061376e-02, -3.056244661551120e-02, -8.898483393231710e-03, 1.535080277320586e-02, -1.029526851870968e-02, -2.895414085173753e-02,  1.443937624444671e-02, 5.899511411050537e-03, 5.877407859889688e-02, -4.529466622386624e-02, -3.191173660061655e-02,  2.120466040860578e-01, 5.250306106890038e-02, 2.020240013874355e-02, 2.496708813328763e-02, -1.529408507905374e-02,  6.225775618942132e-03, -2.825556767438588e-02, 4.763469925450964e-02, -5.000041208595296e-02, 1.180723707959835e-02,  2.654837880362014e-02, -3.709328231474110e-02, 2.020240013874762e-02, 1.039369949123702e-01, 2.411001251032215e-02, -7.663157187562095e-03, 5.673574417600221e-03, -1.351891734386826e-02, 1.619999853945213e-02, -1.194293755971138e-02,  7.318777301028570e-03, 9.020632515480305e-05, -9.258906481008111e-03, 2.496708813329651e-02, 2.411001251032195e-02,  1.798085418002436e-01, -6.070320284571468e-02, -3.166903093750062e-03, -3.866946702368017e-03, 6.695593753180581e-02, -6.246248779153846e-02, 4.641962443806114e-02, 2.827014261774904e-02, 4.160237533781148e-04, -1.529408507906083e-02, -7.663157187561445e-03, -6.070320284571416e-02, 1.293757773278964e-01, -3.645145612696978e-03, 9.309932213315860e-03, -4.393487608800041e-02, 3.786371043431826e-02, -2.686770303975654e-02, -1.897702023179012e-02, -4.971374995827792e-03,  6.225775618940535e-03, 5.673574417599912e-03, -3.166903093750246e-03, -3.645145612696674e-03, 9.941453105282047e-02,  1.051300489400610e-02, -1.708036791284121e-02, -1.118740125386218e-02, 2.599691499697217e-02, 1.043495452076406e-02, -2.629148011320178e-02, -2.825556767439914e-02, -1.351891734386640e-02, -3.866946702365022e-03, 9.309932213314470e-03,  1.051300489400683e-02, 1.427949712159558e-01, -8.235207414421530e-02, 7.953570452163780e-02, 1.244679748195348e-03, -8.357448706678568e-02, 1.564546065561134e-02, 4.763469925448829e-02, 1.619999853945147e-02, 6.695593753179768e-02, -4.393487608799666e-02, -1.708036791284471e-02, -8.235207414421312e-02, 2.627431464400871e-01, -9.694799373352148e-02, -7.532404043162232e-03, 7.700243381718506e-02, 5.993437306987325e-03, -5.000041208594286e-02, -1.194293755971046e-02, -6.246248779153184e-02, 3.786371043431511e-02, -1.118740125385928e-02, 7.953570452163802e-02, -9.694799373352668e-02,  2.451903519328223e-01, -6.140856733125134e-02, -1.160643310949658e-01, 4.045148513514366e-02, 1.180723707960245e-02,  7.318777301027651e-03, 4.641962443806032e-02, -2.686770303975693e-02, 2.599691499697181e-02, 1.244679748192706e-03, -7.532404043153838e-03, -6.140856733125911e-02, 1.860516564059539e-01, 4.254811316180633e-02, -3.660096240701072e-02,  2.654837880361321e-02, 9.020632515187310e-05, 2.827014261774271e-02, -1.897702023178657e-02, 1.043495452076264e-02, -8.357448706678432e-02, 7.700243381718892e-02, -1.160643310949658e-01, 4.254811316179805e-02, 2.159982459609179e-01, -2.274167048250206e-02, -3.709328231475707e-02, -9.258906481006569e-03, 4.160237533780854e-04, -4.971374995827345e-03, -2.629148011320190e-02, 1.564546065561314e-02, 5.993437306988348e-03, 4.045148513514595e-02, -3.660096240701386e-02, -2.274167048250478e-02, 1.775275604490989e-01, 5.206119065733777e-02, 2.040141082504918e-02, 2.360433082400169e-02, -1.419999124405293e-02, 4.736705583944460e-03, -3.249220738081103e-02, 5.392190903984665e-02, -4.771926047992475e-02,  6.007577944917044e-03, 2.621643578237527e-02, -3.494220257579614e-02, 2.040141082505323e-02, 1.003894079827776e-01,  2.011221951998441e-02, -4.027716386639685e-03, 8.156611198818236e-03, -1.110200268225567e-02, 6.691328579143676e-03, -6.951582371614940e-03, 1.028885160359416e-02, -1.260933459255704e-03, -1.044873891584801e-02, 2.360433082401055e-02,  2.011221951998432e-02, 1.843467030873232e-01, -6.580569473461143e-02, -5.824802126233073e-03, -3.780981520150656e-03,  6.894955662399896e-02, -5.206638557326019e-02, 4.257802090315542e-02, 2.042196164408238e-02, -7.735507904633211e-04, -1.419999124406002e-02, -4.027716386639129e-03, -6.580569473461108e-02, 1.295957699116810e-01, -9.122087777106631e-04,  1.455806081887057e-02, -5.295325213762082e-02, 3.501567696202551e-02, -1.881177220220719e-02, -1.693413109006556e-02, -4.653560281310910e-03, 4.736705583943006e-03, 8.156611198817987e-03, -5.824802126233482e-03, -9.122087777100989e-04,  9.862423052684061e-02, 1.357342589206809e-02, -2.311385628158676e-02, -8.724836228178282e-03, 2.895357279582468e-02,  6.914264375442267e-03, -2.525946259865538e-02, -3.249220738082358e-02, -1.110200268225399e-02, -3.780981520147731e-03,  1.455806081886949e-02, 1.357342589206929e-02, 1.423502087671959e-01, -8.748885245683082e-02, 8.517109145100514e-02,  7.722195293055466e-03, -8.911776794586776e-02, 2.057901417346519e-02, 5.392190903982458e-02, 6.691328579143196e-03,  6.894955662399099e-02, -5.295325213761766e-02, -2.311385628159045e-02, -8.748885245682689e-02, 2.751140509809086e-01, -1.001580504788343e-01,
                  -2.046465271649549e-02, 8.215200980441079e-02, -2.751990485528601e-03, -4.771926047991401e-02, -6.951582371614238e-03, -5.206638557325353e-02, 3.501567696202266e-02, -8.724836228175405e-03, 8.517109145100445e-02, -1.001580504788398e-01, 2.462606586503987e-01, -4.838764462217851e-02, -1.180870094396758e-01, 4.971381740475984e-02,  6.007577944921302e-03, 1.028885160359322e-02, 4.257802090315439e-02, -1.881177220220721e-02, 2.895357279582448e-02,  7.722195293052195e-03, -2.046465271648706e-02, -4.838764462218639e-02, 1.826578635635712e-01, 3.074900607920501e-02, -3.067208274081658e-02, 2.621643578236774e-02, -1.260933459258488e-03, 2.042196164407597e-02, -1.693413109006218e-02,  6.914264375440636e-03, -8.911776794586640e-02, 8.215200980441578e-02, -1.180870094396765e-01, 3.074900607919630e-02,  2.151850886731480e-01, -2.688006150302683e-02, -3.494220257581193e-02, -1.044873891584648e-02, -7.735507904631095e-04, -4.653560281310469e-03, -2.525946259865533e-02, 2.057901417346718e-02, -2.751990485527929e-03, 4.971381740476231e-02, -3.067208274081946e-02, -2.688006150302956e-02, 1.698701101355742e-01, 5.626521359772377e-02, 2.161264036925469e-02,  3.308243101093105e-02, -2.066416653591126e-02, 3.033664601732963e-03, -3.465533307205422e-02, 6.434789278629917e-02, -4.855818448158586e-02, 4.164472543365078e-03, 2.554267971682032e-02, -3.093386989479363e-02, 2.161264036925868e-02,  1.046398436109299e-01, 2.241781223318712e-02, -6.052330608819973e-03, 7.481046742458171e-03, -1.466262152795371e-02,  1.121292088848975e-02, -1.291649200033964e-02, 1.177319096516860e-02, 2.452675206012242e-04, -1.308899460523738e-02,  3.308243101093971e-02, 2.241781223318706e-02, 2.069294821051137e-01, -7.729240039995441e-02, -9.170920392149860e-03,  7.633900725531537e-04, 6.677674164330290e-02, -4.922341665791353e-02, 5.393973661045973e-02, 1.359688388184003e-02,  5.300047897280044e-03, -2.066416653591824e-02, -6.052330608819451e-03, -7.729240039995401e-02, 1.386684386414888e-01, -3.811186312083424e-03, 1.178878402131933e-02, -4.642275070183677e-02, 2.836699954819050e-02, -2.722080157082523e-02, -9.847467498267027e-03, -7.517512162825497e-03, 3.033664601731581e-03, 7.481046742457940e-03, -9.170920392149968e-03, -3.811186312082940e-03, 1.043264328782652e-01, 2.423312051072186e-02, -3.626738247891908e-02, 3.442811045842689e-03,  3.111529185998532e-02, 1.471666793368731e-03, -2.178970526193424e-02, -3.465533307206642e-02, -1.466262152795208e-02,  7.633900725565641e-04, 1.178878402131819e-02, 2.423312051072328e-02, 1.704947453384557e-01, -1.241084985009788e-01,  1.120851323892868e-01, 2.188465806262627e-02, -1.004319282987660e-01, 3.104362968156742e-02, 6.434789278627658e-02,  1.121292088848930e-02, 6.677674164329370e-02, -4.642275070183322e-02, -3.626738247892299e-02, -1.241084985009738e-01,  3.244287017683443e-01, -1.312370988876824e-01, -3.201453208701437e-02, 9.157240898086957e-02, -1.648262831485380e-02, -4.855818448157462e-02, -1.291649200033901e-02, -4.922341665790623e-02, 2.836699954818753e-02, 3.442811045845971e-03,  1.120851323892863e-01, -1.312370988876894e-01, 2.727746153899414e-01, -4.042580897672941e-02, -1.230620974818753e-01,  5.863720930395395e-02, 4.164472543369320e-03, 1.177319096516768e-02, 5.393973661045923e-02, -2.722080157082546e-02,  3.111529185998491e-02, 2.188465806262200e-02, -3.201453208700490e-02, -4.042580897673860e-02, 1.933003777861321e-01,  2.362340128142040e-02, -2.295468020732622e-02, 2.554267971681250e-02, 2.452675205984964e-04, 1.359688388183322e-02, -9.847467498263634e-03, 1.471666793366898e-03, -1.004319282987648e-01, 9.157240898087578e-02, -1.230620974818761e-01,  2.362340128141090e-02, 2.130910292673469e-01, -2.849113022888776e-02, -3.093386989480927e-02, -1.308899460523582e-02,  5.300047897280427e-03, -7.517512162825105e-03, -2.178970526193409e-02, 3.104362968156958e-02, -1.648262831485352e-02,  5.863720930395655e-02, -2.295468020732885e-02, -2.849113022889058e-02, 1.731283485755817e-01, 5.952760282218890e-02,  2.142494041241640e-02, 3.379847637960292e-02, -2.255323498920016e-02, -2.002211436400827e-03, -4.054041699350398e-02,  8.125324275272602e-02, -5.073775867293552e-02, -1.114144143260958e-02, 2.116977970320824e-02, -3.049008413671409e-02,  2.142494041242034e-02, 1.123858841032921e-01, 1.889641501501581e-02, -4.883171555580676e-03, 6.259948030017228e-03, -1.942979396081622e-02, 1.539773710587452e-02, -1.598619281509506e-02, 6.900648330973817e-03, -3.878611503499347e-04, -1.679539297535826e-02, 3.379847637961139e-02, 1.889641501501562e-02, 1.981923858438319e-01, -6.965761480781238e-02, -1.664431691258089e-02, -8.354934264885098e-03, 7.070230541721861e-02, -4.198987158871105e-02, 2.569382730158124e-02,  5.212968014992192e-03, 7.837204961614448e-03, -2.255323498920702e-02, -4.883171555580095e-03, -6.965761480781202e-02,  1.433585500498312e-01, -4.166167041431369e-03, 2.039249719785311e-02, -4.865047388885003e-02, 2.420988902767271e-02, -1.406962733427606e-02, -6.314363713849559e-03, -6.893740717868061e-03, -2.002211436402179e-03, 6.259948030017042e-03, -1.664431691258081e-02, -4.166167041431007e-03, 1.037867824834069e-01, 1.991882177292021e-02, -2.285129909151090e-02,  1.381393312298302e-03, 1.747720342341507e-02, 2.490058481004126e-03, -1.929654297155640e-02, -4.054041699351581e-02, -1.942979396081447e-02, -8.354934264881139e-03, 2.039249719785162e-02, 1.991882177292221e-02, 1.314464445098305e-01, -8.630190596537118e-02, 7.518810520998585e-02, 1.311874040194642e-02, -6.376101275012361e-02, 2.604237587233759e-02,  8.125324275270265e-02, 1.539773710587381e-02, 7.070230541720822e-02, -4.865047388884573e-02, -2.285129909151555e-02, -8.630190596536670e-02, 2.902461539988758e-01, -8.645123336581023e-02, -2.338927469588801e-02, 5.521702361802855e-02, -1.049085463505898e-02, -5.073775867292368e-02, -1.598619281509423e-02, -4.198987158870296e-02, 2.420988902766932e-02,  1.381393312302326e-03, 7.518810520998602e-02, -8.645123336581753e-02, 2.344060845397968e-01, -3.424576990994067e-02, -8.257228616447511e-02, 4.480681249478405e-02, -1.114144143260527e-02, 6.900648330972967e-03, 2.569382730158122e-02, -1.406962733427663e-02, 1.747720342341458e-02, 1.311874040194120e-02, -2.338927469587690e-02, -3.424576990995128e-02,  1.673424226573735e-01, 1.473541434542673e-02, -1.741674406919745e-02, 2.116977970319996e-02, -3.878611503527977e-04,  5.212968014984911e-03, -6.314363713845882e-03, 2.490058481001647e-03, -6.376101275012309e-02, 5.521702361803523e-02, -8.257228616447618e-02, 1.473541434541612e-02, 1.801501240587855e-01, -1.719963903556520e-02, -3.049008413672962e-02, -1.679539297535668e-02, 7.837204961615069e-03, -6.893740717867800e-03, -1.929654297155613e-02, 2.604237587233984e-02, -1.049085463505844e-02, 4.480681249478645e-02, -1.741674406919989e-02, -1.719963903556787e-02, 1.690406288603667e-01,  7.043018710710647e-02, 2.549494030109289e-02, 3.728125713590533e-02, -2.477031228290608e-02, -1.507337516588395e-03, -4.758417963758853e-02, 9.718254873958800e-02, -5.647794821036727e-02, -1.489160293776083e-02, 2.505702720051073e-02, -2.967127567218573e-02, 2.549494030109685e-02, 1.389495589648010e-01, 2.745727045859857e-02, -9.117498488871167e-03,  1.292704166743008e-02, -2.155251446715214e-02, 1.823454295017789e-02,
                  -1.748332002556355e-02, 1.493702423488097e-02, -1.332117824535281e-03, -2.165881715594158e-02, 3.728125713591401e-02, 2.745727045859843e-02, 2.441257401481345e-01, -8.188025179590047e-02, -1.999724522752332e-02, 5.406967348182426e-03, 8.088524912124584e-02, -3.648060576034334e-02,  3.818620834052844e-02, -5.175840370667151e-03, 2.389378008865603e-02, -2.477031228291317e-02, -9.117498488870661e-03, -8.188025179590019e-02, 1.704941123501085e-01, -6.350051078892673e-03, 1.821762217528237e-02, -5.576936614135586e-02,  2.496063259941089e-02, -2.163235367103063e-02, -4.152803214593936e-03, -1.477688371398225e-02, -1.507337516590060e-03,  1.292704166742975e-02, -1.999724522752354e-02, -6.350051078892013e-03, 1.327041419216592e-01, 1.081964659869017e-02, -1.543035762818251e-02, -2.089074717945084e-02, 3.019337404839192e-02, 1.899716674573727e-02, -3.683486020555569e-02, -4.758417963760109e-02, -2.155251446715054e-02, 5.406967348185590e-03, 1.821762217528138e-02, 1.081964659869128e-02,  1.624359067430901e-01, -9.243359848990085e-02, 7.459080840565857e-02, 1.862123171394903e-02, -7.863779229609280e-02,  2.921355841102111e-02, 9.718254873956580e-02, 1.823454295017740e-02, 8.088524912123607e-02, -5.576936614135197e-02, -1.543035762818601e-02, -9.243359848989596e-02, 3.379279959493771e-01, -7.639893794937480e-02, -3.026599008223585e-02,  5.808645648999200e-02, -2.264473130849307e-03, -5.647794821035637e-02, -1.748332002556287e-02, -3.648060576033590e-02,  2.496063259940789e-02, -2.089074717944805e-02, 7.459080840565779e-02, -7.639893794938124e-02, 2.736443335970395e-01, -5.560665121416315e-02, -9.843388281353538e-02, 5.844707582107556e-02, -1.489160293775674e-02, 1.493702423488004e-02,  3.818620834052813e-02, -2.163235367103092e-02, 3.019337404839159e-02, 1.862123171394495e-02, -3.026599008222633e-02, -5.560665121417218e-02, 2.211664888949095e-01, 2.603091004678617e-02, -2.160061535466321e-02, 2.505702720050312e-02, -1.332117824538050e-03, -5.175840370673784e-03, -4.152803214590606e-03, 1.899716674573573e-02, -7.863779229609169e-02,  5.808645648999833e-02, -9.843388281353660e-02, 2.603091004677675e-02, 2.317907799511161e-01, -1.189840068085141e-02, -2.967127567220137e-02, -2.165881715593999e-02, 2.389378008865663e-02, -1.477688371398199e-02, -3.683486020555575e-02,  2.921355841102291e-02, -2.264473130848182e-03, 5.844707582107764e-02, -2.160061535466599e-02, -1.189840068085385e-02,  2.220856683700737e-01 ))

  expect_equal(c(result_exp$lag_one_cov),
               c(NULL ))

  expect_equal(c(result_exp$fixed_effects),
               c(numeric(0) ))

  expect_equal(c(result_exp$n_iter),
               c(9 ))

  expect_equal(c(result_exp$Q),
               c( 0.08259643773390861, 0.02801576798285707, 0.12774526931241492, -0.08090900387915302, 0.03358835233991313, -0.02479423357697254, 0.05140359297791846, -0.09515479854437678, 0.12285301872947549, 0.08491428330367201, -0.01320675710221465, 0.02801576798285707, 0.05694592438503769, 0.07363369009696616, -0.04697012254116822,  0.00975954923341057, -0.02501940680624398, 0.06453474162740094, -0.06370418903998143, 0.04170753882038754,  0.03910269117666106, -0.01928337362931967, 0.12774526931241492, 0.07363369009696616, 0.68689195881436904, -0.41151353809309982, -0.04966461021290973, -0.07060619837812727, 0.49232988545401357, -0.34919001381735232,  0.20918510325696898, 0.17063364143448501, 0.07384704536030803, -0.08090900387915302, -0.04697012254116822, -0.41151353809309982, 0.30173954702327205, 0.03599545367838863, 0.08276713215496084, -0.36533400923807124,  0.27093578509606975, -0.11815177038976410, -0.14761490717023579, -0.03215975006827183, 0.03358835233991313,  0.00975954923341057, -0.04966461021290973, 0.03599545367838863, 0.13722306367067888, 0.11883767730228452, -0.26746524246831421, 0.11088282925856982, 0.15291415325248586, -0.06743040491908120, -0.04347980997344505, -0.02479423357697254, -0.02501940680624398, -0.07060619837812727, 0.08276713215496084, 0.11883767730228452,  0.53614536539602187, -0.72341466608887028, 0.63403477209215753, 0.12591002417496761, -0.53166172040156967,  0.12658136586190827, 0.05140359297791846, 0.06453474162740094, 0.49232988545401357, -0.36533400923807124, -0.26746524246831421, -0.72341466608887028, 1.44031158042025575, -1.03876152119643805, -0.21203973315716940,  0.73667822123317728, -0.09467432014119892, -0.09515479854437678, -0.06370418903998143, -0.34919001381735232,  0.27093578509606975, 0.11088282925856982, 0.63403477209215753, -1.03876152119643805, 1.08855531560189389, -0.06030887111654323, -0.77944565261614118, 0.24613199897948279, 0.12285301872947549, 0.04170753882038754,  0.20918510325696898, -0.11815177038976410, 0.15291415325248586, 0.12591002417496761, -0.21203973315716940, -0.06030887111654323, 0.44065676963027656, 0.04730190309510305, -0.06306661767781324, 0.08491428330367201,  0.03910269117666106, 0.17063364143448501, -0.14761490717023579, -0.06743040491908120, -0.53166172040156967,  0.73667822123317728, -0.77944565261614118, 0.04730190309510305, 0.69534177970406341, -0.17099218624779378, -0.01320675710221465, -0.01928337362931967, 0.07384704536030803, -0.03215975006827183, -0.04347980997344505,  0.12658136586190827, -0.09467432014119892, 0.24613199897948279, -0.06306661767781324, -0.17099218624779378,  0.22944940053298582 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$n_risk),
               c(2007, 1936, 1882, 1818, 1767, 1656, 1543, 1364, 1254, 1103 ))

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ))

  expect_equal(c(result_exp$risk_set),
               c(NULL ))

  expect_equal(c(result_exp$data),
               c(NULL ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("UKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))

  expect_equal(c(result_exp$LR),
               c(1 ))
})



# Had issues with win builder. Thus, these lines
cat("\nFinished", test_name, "\n")
