# library(survival); source("R/test_utils.R")

# Simulate series to work with
set.seed(2972)
sims <- test_sim_func_logit(n_series = 10^4, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = 0.5, re_draw = T, beta_start = 1,
                            intercept_start = -4)
sims$res <- as.data.frame(sims$res)

design_mat <- get_design_matrix(survival::Surv(tstart, tstop, event) ~ x1 + x2 + x3, sims$res)
rist_sets <- get_risk_obj(design_mat$Y, by = 1, max_T = 10, id = sims$res$id)






#########
# Without estimating Q_0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2],
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = F)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 1 and no Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 1.220770964039888e+00, 2.933356392867275e-02, -2.631297395117910e-01, -3.274724576484336e-01, 2.933356392867275e-02,  6.651805982545689e-01, 6.066078648578059e-03, -9.767660549770345e-01, -2.631297395117910e-01, 6.066078648578060e-03,  1.168881691298266e+00, -7.830515440706630e-02, -3.274724576484336e-01, -9.767660549770345e-01, -7.830515440706633e-02,  1.883517014823243e+00, 2.602875811448074e-02, -1.407341180542901e-02, -1.190545448798228e-02, -1.452458800124049e-02, -1.407341180542902e-02, 2.341906134094476e-02, -6.576796197494683e-05, -9.592957830216035e-04, -1.190545448798228e-02, -6.576796197494677e-05, 2.328720983625676e-02, -4.575405073203485e-04, -1.452458800124049e-02, -9.592957830216039e-04, -4.575405073203485e-04, 2.486555963570219e-02, 2.467276845780544e-02, -1.187035875430268e-02, -1.271818559106548e-02, -1.381953587708798e-02, -1.187035875430268e-02, 2.169903829074911e-02, -3.137464526760961e-05, -2.730666218297713e-03, -1.271818559106548e-02, -3.137464526760973e-05, 2.490852473714218e-02, -4.489420868308029e-04, -1.381953587708798e-02, -2.730666218297710e-03, -4.489420868308029e-04, 2.572299877760921e-02, 7.968628869146722e-03, -4.371717489587037e-03, -4.721970698354984e-03, -4.626286761135482e-03, -4.371717489587037e-03, 7.529468624429933e-03, 3.576320292681516e-04,  2.100612169845585e-04, -4.721970698354984e-03, 3.576320292681516e-04, 8.111473956489666e-03, 4.903243367279922e-04, -4.626286761135482e-03, 2.100612169845585e-04, 4.903243367279922e-04, 8.019920449947222e-03, 1.142660389963227e-02, -6.115916774614438e-03, -6.497066673093413e-03, -6.565253740248141e-03, -6.115916774614438e-03, 1.098956373920415e-02,  2.151079237773433e-04, -3.263837172010247e-04, -6.497066673093414e-03, 2.151079237773433e-04, 1.186480000912416e-02,  3.459230152164976e-04, -6.565253740248141e-03, -3.263837172010249e-04, 3.459230152164976e-04, 1.206308052342858e-02,  1.091358208625393e-02, -6.083795024653503e-03, -6.614839930305437e-03, -6.120318400655647e-03, -6.083795024653503e-03,  1.176358907839454e-02, -2.170802633219183e-06, -5.141254947568124e-04, -6.614839930305437e-03, -2.170802633219182e-06,  1.302661809648839e-02, -1.067719129849316e-04, -6.120318400655647e-03, -5.141254947568128e-04, -1.067719129849316e-04,  1.259466703320689e-02, 1.770887226278521e-02, -8.556355228331293e-03, -1.096994715241947e-02, -9.962576659622434e-03, -8.556355228331293e-03, 1.789739469299280e-02, -2.922295693242075e-04, -2.159595842562078e-03, -1.096994715241947e-02, -2.922295693242076e-04, 2.130988948087501e-02, -2.863203175318359e-04, -9.962576659622434e-03, -2.159595842562078e-03, -2.863203175318358e-04, 2.111405035769074e-02, 2.179524245326044e-02, -1.117514395343087e-02, -1.477964275592349e-02, -9.569636320198072e-03, -1.117514395343087e-02, 2.124862794023922e-02, 6.130540514023770e-04, -3.247970831343769e-03, -1.477964275592349e-02, 6.130540514023771e-04, 2.618141658410134e-02, -1.063700662566211e-03, -9.569636320198069e-03, -3.247970831343771e-03, -1.063700662566211e-03, 2.464792976827931e-02, 1.969100778418886e-02, -1.075086961653644e-02, -1.478499225843130e-02, -8.961133686200188e-03, -1.075086961653644e-02, 3.054404875517194e-02, 4.167978307507054e-03, -1.367117251589334e-02, -1.478499225843130e-02, 4.167978307507054e-03, 2.939513720691248e-02, -3.687059674613585e-03, -8.961133686200187e-03, -1.367117251589334e-02, -3.687059674613585e-03, 3.561905855019189e-02, 3.457972654933975e-02, -1.442258098840249e-02, -2.751002776898206e-02, -2.187416715287070e-02, -1.442258098840250e-02, 4.556204740301917e-02,  6.305635681388469e-03, -1.400330581596880e-02, -2.751002776898206e-02, 6.305635681388469e-03, 6.214630400123509e-02, -3.942309636489424e-03, -2.187416715287070e-02, -1.400330581596881e-02, -3.942309636489424e-03, 5.543734663766787e-02,  6.031254766425480e-02, -2.552463655051856e-02, -4.285835645018093e-02, -3.722429042006889e-02, -2.552463655051856e-02,  8.046243945032083e-02, 7.675153531114445e-04, -2.558215249181558e-02, -4.285835645018093e-02, 7.675153531114445e-04,  9.456311843146953e-02, -3.025093224519677e-03, -3.722429042006889e-02, -2.558215249181558e-02, -3.025093224519677e-03,  9.594246929485468e-02 ))

  expect_equal(c(res$a_t_d_s),
               c(-4.9866769587256146, -4.9867131190528715, -2.9636826024279070, -3.1336943905300272, -2.2837621092633151, -2.8337501113091488, -3.1611468188948844, -1.0424458845830322, -1.5362292852489998, -1.7917283893022637, -0.2653965070267152, 1.8885502553983691, 1.8885546653463670, 1.5825300676843632, 1.5029007853478267,  1.5480691123338028, 1.0755889863182679, 1.6871561052706299, 3.3783543527941733, 2.3624008710915834,  2.8648761588005520, 1.3073070738075618, 0.2863018820684052, 0.2862980656036826, 1.1328742378822172,  0.6338514045119475, 0.4711080464053391, 0.4278338927467338, 1.3589754030855596, 0.8511841736247218,  2.1602990099116233, 0.1583503866079902, -1.7450006498550643, 1.6593959361948460, 1.6594027732451808,  1.3060793044606060, 1.1931061655761317, 0.5481869550994021, 0.7400325892144077, -0.1210841141422665, -2.8639574602173035, -0.3352738868105959, -0.5489014127797550, 2.1094602107875935 ))

  expect_equal(c(res$B_s),
               c( 0.8798177815085161946, -0.0042303261012859921, 0.0254854170618412472, 0.0317116498832084315, -0.0042303261012859921,  0.9355503851775306412, -0.0006505262874303983, 0.0979744345713213227, 0.0254854170618412472, -0.0006505262874303983,  0.8848822539772548401, 0.0077630560443400585, 0.0317116498832084315, 0.0979744345713213227, 0.0077630560443400585,  0.8132178349820922136, -0.0041318738637590845, 0.0105391934923893416, -0.0052807113138112214, 0.0034920700709202314, -0.1634268259622315700, 0.1765263791677911809, -0.0036023668153710065, 0.0915473593871385383, -0.0149715898694653543,  0.0073773561398826097, 0.0163151364638604440, 0.0037485752488011729, -0.0935175991838406162, 0.0950562838503474089, -0.0024163448535223760, 0.0591814217959559796, -0.0030319848277065280, 0.0097564918261418155, -0.0055634051490028808,  0.0030689955332980877, -0.1477419709079491050, 0.1606056448684611837, -0.0033198190734615852, 0.0838785361342230112, -0.0148748621287799580, 0.0067274590702443666, 0.0174935496879802081, 0.0034696092917016362, -0.0848375647802832866,  0.0858603673374833121, -0.0022690973599311538, 0.0554443769237064829, -0.0018609932682897114, 0.0041319050059497311, -0.0014940295365702817, 0.0019706285518430976, -0.0538021180047873887, 0.0615688938423716303, 0.0045277034101049640,  0.0354973866882803413, -0.0056699483602581794, 0.0029996463424571845, 0.0059487801311206134, 0.0020767708735286859, -0.0308872812812301840, 0.0335203110907745030, 0.0025528388099758676, 0.0224578955177040657, -0.0023596977527968171,  0.0057023691994264542, -0.0024031055782029473, 0.0025323554025467399, -0.0750555188423055741, 0.0866175943654583502,  0.0026093040009683597, 0.0478656354108028328, -0.0077827125627161851, 0.0039528119385603298, 0.0085261330498568027,  0.0025645656575939888, -0.0430789117155444962, 0.0468682559236869092, 0.0014144027845628586, 0.0307513541468369400, -0.0024757623163761643, 0.0063109616567662468, -0.0027632797986520928, 0.0030025499439931668, -0.0727714092634175330,  0.0917075919056898059, -0.0009554502366630154, 0.0486913970550026318, -0.0078304071989018838, 0.0040780623645045979,  0.0092111890908222263, 0.0023805647644219857, -0.0417044682410222939, 0.0495880978234434847, -0.0006926190622435489,  0.0314750304489438137, -0.0026259509109341477, 0.0090577141868158247, -0.0050496729497562180, 0.0038531929326660504, -0.1057539646364719088, 0.1319981030363017449, -0.0047060939085043019, 0.0698916954024034198, -0.0121951254630164214,  0.0056012858301358439, 0.0148394417479803045, 0.0032883462022873506, -0.0608619060100826642, 0.0707490349635946231, -0.0029455251593617305, 0.0462973598913323584, -0.0022200708022789631, 0.0094889114965510026, -0.0069480304808410102,  0.0054628718944904030, -0.1228315486839817450, 0.1519424307294703902, -0.0023363489327214238, 0.0768105618469788892, -0.0154317601702879548, 0.0068903704701501305, 0.0181047695381346060, 0.0033986717163522551, -0.0697668414549590110,  0.0809622035647840771, -0.0022287399731713499, 0.0516747327230341474, -0.0030364355412742352, 0.0125038503656803683, -0.0043195247385817903, 0.0023783239520050944, -0.1148467857830068883, 0.1781897912119479732, 0.0162237147387823896,  0.0382242116925409492, -0.0153349390908133140, 0.0106659097736315853, 0.0216361214817106517, -0.0001352032710685899, -0.0654508932374751884, 0.0913203252804516696, 0.0071381029937461378, 0.0350185990908049583, -0.0039550707127060502,  0.0224052238564542774, -0.0056487953996318570, 0.0031697372861248796, -0.1728090165207367135, 0.2657382065432576379,  0.0312138424888161736, 0.0988120931737995062, -0.0268595319968021537, 0.0167499031947521380, 0.0465223048265423350,  0.0018781824907008384, -0.1014567995675379336, 0.1388406785244281627, 0.0156019505196946916, 0.0749779138416625801 ))

  expect_equal(c(res$lag_one_cor),
               c( 2.219608521866870e-02, -1.251320519531239e-02, -9.895377445032919e-03, -1.199806534792117e-02, -1.469178945586157e-02,  2.187530330117169e-02, -7.114150194739814e-05, 1.600460992162001e-03, -9.975171712141373e-03, -4.395454537322052e-04,  2.029951412699844e-02, -5.813778781164427e-04, -1.245749641870434e-02, 1.067551185083164e-03, -5.752853690152637e-04,  1.966297954864158e-02, 3.320771562724682e-03, -3.241323051970838e-03, -2.732588331549878e-04, -1.895467020773200e-03, -3.242860679120958e-03, 3.445550208074556e-03, 1.506420123695446e-06, 1.814139284810279e-03, -2.616345501713967e-04, -9.397608046990355e-06, 4.747448686238078e-04, 1.333365370195570e-05, -1.866075820118783e-03, 1.783315212753766e-03,  1.951738712618595e-05, 1.222396678036504e-03, 1.084446962239631e-03, -1.122304362595348e-03, -2.007752967940825e-04, -7.046920545525692e-04, -1.053358189494174e-03, 1.187064426082821e-03, 1.080368908720570e-04, 6.804926410015976e-04, -1.019259337362698e-04, 5.104766360273430e-06, 1.658688415072536e-04, 1.542007518086907e-05, -6.151225573647239e-04,  6.310315813406642e-04, 7.083531685735381e-05, 4.497823001732316e-04, 5.474053145659227e-04, -5.710186703117147e-04, -7.743968938574516e-05, -3.447790985952638e-04, -5.688948388367543e-04, 6.410496600572860e-04, 3.358434564802735e-05,  3.581737693348646e-04, -1.001723966459884e-04, 5.934127024483840e-05, 8.214492664320128e-05, 4.118383442152512e-05, -3.555161721823747e-04, 3.711654318204679e-04, 2.724163807290456e-05, 2.471063593704238e-04, 7.460076908605205e-04, -8.464015027461655e-04, -8.101085285947563e-05, -4.887035167662075e-04, -7.777262826885198e-04, 9.601369956703863e-04,  8.579269007984334e-06, 5.104353997972454e-04, -1.071565614261406e-04, 4.456909272491613e-05, 1.268061550407338e-04,  3.026984216483754e-05, -4.687399159525654e-04, 5.318497124191996e-04, 1.326920401383026e-05, 3.469214778637657e-04,  1.080198184564208e-03, -1.188882059359923e-03, -1.064993360488191e-04, -6.964864331355040e-04, -1.211684074238711e-03,  1.479046158603845e-03, -2.332560757293054e-05, 7.849131889627820e-04, -1.349053843865282e-04, 5.347528983793304e-06,  2.270799765924259e-04, 1.233142884069308e-05, -7.031361897156928e-04, 7.770892510170881e-04, -5.449248879850512e-06,  5.288169012096946e-04, 1.887248445662059e-03, -2.027579843933002e-03, -2.805690904087016e-04, -1.118532834214491e-03, -2.037510264386288e-03, 2.477200409372788e-03, 1.844599433615008e-05, 1.222454134392736e-03, -2.486016125491083e-04, -2.490285669761742e-05, 4.633980356377545e-04, -2.477703186859158e-05, -1.188717961957535e-03, 1.293686105481766e-03,  2.274560141472710e-05, 8.737564159668498e-04, 2.130178981043108e-03, -2.838429836158722e-03, -6.755197005635116e-04, -7.289857463088461e-04, -2.274054235582368e-03, 3.460793624327242e-03, 3.970301816978290e-04, 6.961296745790825e-04, -3.594027801392360e-04, 1.092655894447582e-04, 6.333984071535046e-04, -5.193612596860403e-05, -1.231524405736331e-03,  1.595086326715581e-03, 1.487528351006874e-04, 7.290302575848008e-04, 3.404936337716324e-03, -4.369029125589906e-03, -1.335631663718092e-03, -1.893314616118982e-03, -4.428552502294953e-03, 6.726822818494124e-03, 1.082452507627528e-03,  2.251750756176590e-03, -1.134706184850636e-03, 8.379568158096873e-04, 1.537595450840268e-03, 1.777215669805690e-04, -1.231333241177512e-03, 1.216043080378495e-03, 2.914365094030535e-05, 1.354582048146084e-03, 9.100159717065449e-03, -1.122881507111095e-02, -2.196130571220173e-03, -5.084711975572212e-03, -1.131767406897137e-02, 1.727107155563557e-02,  4.076241666725219e-04, 5.637873635099737e-03, -3.712056287065020e-03, 2.292300466642329e-03, 4.618152056302976e-03,  7.679104716344238e-04, -5.202463288502074e-03, 5.953100780248412e-03, -1.092183177246364e-04, 4.542067262518313e-03 ))

  expect_equal(c(res$Q),
               c( 1.39209602885464179, 0.09820388296811670, -0.32335446608087548, -0.45215975033742140, 0.09820388296811670,  0.82780003630397514, 0.01576366610538953, -1.30929039605105180, -0.32335446608087548, 0.01576366610538953,  1.31099247664804208, -0.09765706852910964, -0.45215975033742140, -1.30929039605105180, -0.09765706852910964,  2.47216797935405497 ))

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10 ))
})








#########
# With estimating Q_0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2],
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = T)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 1 and Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 7.871936045867025e-03, 6.965726628823138e-04, -2.101202042426233e-03, -2.693563207801878e-03, 6.965726628823138e-04,  4.849940966207365e-03, 1.799341926799392e-04, -7.612945051461875e-03, -2.101202042426233e-03, 1.799341926799392e-04,  7.723067429320032e-03, -5.141307566217908e-04, -2.693563207801878e-03, -7.612945051461875e-03, -5.141307566217908e-04,  1.469022764853586e-02, 2.124411014980083e-02, -1.001594906667408e-02, -1.113368534909170e-02, -1.180048023572017e-02, -1.001594906667408e-02, 1.871438287063235e-02, -4.768946730451959e-05, -2.758629964357650e-03, -1.113368534909170e-02, -4.768946730451952e-05, 2.179945717544149e-02, -4.372829088012702e-04, -1.180048023572017e-02, -2.758629964357651e-03, -4.372829088012702e-04, 2.238810902810217e-02, 2.362178659212277e-02, -1.090335686616452e-02, -1.261982604659575e-02, -1.324828992569389e-02, -1.090335686616452e-02, 2.067749871613666e-02, -4.234175781604214e-05, -3.198609727683838e-03, -1.261982604659575e-02, -4.234175781604216e-05, 2.474401265768287e-02, -4.545010420665704e-04, -1.324828992569389e-02, -3.198609727683837e-03, -4.545010420665704e-04, 2.531477504854783e-02, 7.994672326937161e-03, -4.344291136032769e-03, -4.753897516201875e-03, -4.633900169944805e-03, -4.344291136032768e-03, 7.494479583549890e-03, 3.574357759688628e-04,  1.663827352906614e-04, -4.753897516201875e-03, 3.574357759688628e-04, 8.166051142157373e-03, 4.930395524379663e-04, -4.633900169944805e-03, 1.663827352906613e-04, 4.930395524379663e-04, 8.056522010214463e-03, 1.126933259712181e-02, -5.925978095269676e-03, -6.487363500260333e-03, -6.466901709824020e-03, -5.925978095269676e-03, 1.077875830666970e-02,  2.020909569976748e-04, -4.574173925523485e-04, -6.487363500260333e-03, 2.020909569976748e-04, 1.187057779909801e-02,  3.382993099242365e-04, -6.466901709824020e-03, -4.574173925523481e-04, 3.382993099242365e-04, 1.201713078287255e-02,  1.072565727155951e-02, -5.873713897431179e-03, -6.592454801515497e-03, -6.003287929744635e-03, -5.873713897431179e-03,  1.150458457962534e-02, -5.643614816884027e-06, -6.442022272507709e-04, -6.592454801515497e-03, -5.643614816884021e-06,  1.299121221475590e-02, -1.099640439179504e-04, -6.003287929744634e-03, -6.442022272507709e-04, -1.099640439179504e-04,  1.251016650804876e-02, 1.731661195609219e-02, -8.127446273333283e-03, -1.092461035355896e-02, -9.721793867100226e-03, -8.127446273333283e-03, 1.737404597327768e-02, -2.900867169454047e-04, -2.424083852777291e-03, -1.092461035355896e-02, -2.900867169454049e-04, 2.122796815066692e-02, -2.884182066896979e-04, -9.721793867100228e-03, -2.424083852777290e-03, -2.884182066896978e-04, 2.094213716694920e-02, 2.126049040084284e-02, -1.060662545723052e-02, -1.468305261501831e-02, -9.289168534978064e-03, -1.060662545723052e-02, 2.057603031852517e-02, 5.842400596110013e-04, -3.556102152505440e-03, -1.468305261501831e-02, 5.842400596110013e-04, 2.605743335086981e-02, -1.071794523905663e-03, -9.289168534978064e-03, -3.556102152505440e-03, -1.071794523905663e-03, 2.445896493896603e-02, 1.929359293232091e-02, -1.022570783842180e-02, -1.465347133992734e-02, -8.843214801216592e-03, -1.022570783842180e-02, 2.972185039873737e-02, 4.064321277533144e-03, -1.377154462918007e-02, -1.465347133992734e-02, 4.064321277533145e-03, 2.924601806173988e-02, -3.693732682909022e-03, -8.843214801216593e-03, -1.377154462918007e-02, -3.693732682909022e-03, 3.549738438309299e-02, 3.363596171771623e-02, -1.331050956485559e-02, -2.707406711873742e-02, -2.138019713590177e-02, -1.331050956485559e-02, 4.392079123730577e-02,  6.033593378383681e-03, -1.454046919179713e-02, -2.707406711873742e-02, 6.033593378383682e-03, 6.149190664292345e-02, -3.995773429955780e-03, -2.138019713590177e-02, -1.454046919179713e-02, -3.995773429955780e-03, 5.499819939718950e-02,  5.858519976128861e-02, -2.344986381096829e-02, -4.246689825570275e-02, -3.630951216833601e-02, -2.344986381096829e-02,  7.725918661654586e-02, 7.907526013344050e-04, -2.650715784649161e-02, -4.246689825570275e-02, 7.907526013344050e-04,  9.372869844852516e-02, -3.051925160774555e-03, -3.630951216833601e-02, -2.650715784649161e-02, -3.051925160774555e-03,  9.514040578264217e-02 ))

  expect_equal(c(res$a_t_d_s),
               c(-4.8986231489573333, -4.9740321197160444, -3.0109312219718203, -3.1460894778339936, -2.2801685702513317, -2.8391368557580270, -3.1600331608439700, -1.0502810181093460, -1.5316691498792818, -1.7768280991854173, -0.2788536343537094, 1.8799499265727020, 1.8790436842125777, 1.6232822853221296, 1.5141849915415706,  1.5464526666121290, 1.0829685001312759, 1.6892294037589553, 3.3808681314283846, 2.3641064241901244,  2.8411495497487094, 1.3208327737320387, 0.2850611331519913, 0.2863298070650770, 1.1292918231771638,  0.6313005384651705, 0.4714486856634988, 0.4286738084563894, 1.3554574142076588, 0.8572206997591333,  2.1520182543823250, 0.1559414406714338, -1.7284257587955540, 1.6162843310751922, 1.6514877044109508,  1.3344653650722897, 1.2002505600397586, 0.5455364440516963, 0.7426738234441562, -0.1214824429361719, -2.8584623435749950, -0.3386526568409842, -0.5532339293106359, 2.1024950028088996 ))

  expect_equal(c(res$B_s),
               c( 6.222725710521993e-03, 1.168511505011361e-04, -7.627870056966672e-05, 1.376887984285164e-04, -6.818516924981186e-04,  7.557756570709340e-03, 7.255810538477807e-04, 1.321580851161547e-03, -2.452376428325917e-04, 1.122679881405252e-04,  6.530264352285721e-03, 1.110240637790111e-04, -4.150706039091605e-04, 6.702905572208880e-04, 3.945183920566427e-04,  7.170343395790285e-03, -2.970759565304425e-04, 6.718356750069931e-03, -5.408949532297418e-03, 1.387649395893033e-03, -1.417975036155640e-01, 1.546711387066934e-01, -3.356750516115510e-03, 7.886217763051531e-02, -1.322436836911016e-02,  5.264365883445481e-03, 1.696342043441485e-02, 2.572828077662108e-03, -8.037108603384499e-02, 8.163165091394116e-02, -2.295719078553552e-03, 5.167835821932100e-02, -3.913048316117555e-04, 7.624955521587673e-03, -6.080292982953171e-03,  1.676514708222533e-03, -1.598392529023089e-01, 1.740481869911575e-01, -3.460786048851200e-03, 9.063658418120343e-02, -1.498693244889118e-02, 5.952118529391018e-03, 1.928579324994842e-02, 3.008630602056217e-03, -9.066217413560712e-02,  9.190761298779684e-02, -2.391436503365905e-03, 5.927273064748161e-02, -1.074227095844200e-03, 3.468370476458464e-03, -1.754245259523000e-03, 1.519278304931627e-03, -6.208007966077705e-02, 7.055901553147242e-02, 5.400639916668441e-03,  4.068171239587637e-02, -5.919296273460609e-03, 2.874359863966493e-03, 6.605959695394804e-03, 2.033766157853877e-03, -3.517065673106787e-02, 3.799901149688593e-02, 2.996183396895208e-03, 2.532751751363887e-02, -1.180840126176019e-03,  4.690631258800421e-03, -2.722181510518034e-03, 1.869167479934044e-03, -8.467796517192175e-02, 9.741716302452012e-02,  3.088347326935876e-03, 5.370584305503976e-02, -8.007201075182964e-03, 3.674331987167826e-03, 9.433208216993279e-03,  2.429557927751850e-03, -4.797458935917431e-02, 5.212342960264129e-02, 1.641528357972479e-03, 3.400187660225630e-02, -1.336511703263468e-03, 5.243401943254878e-03, -3.044878703258067e-03, 2.362283555728577e-03, -8.160546378186039e-02,  1.026690717405523e-01, -9.149409768751777e-04, 5.431975711024172e-02, -8.052377100026192e-03, 3.764061726975945e-03,  1.018910584265086e-02, 2.211639679958872e-03, -4.616983111707577e-02, 5.489749757337924e-02, -6.942127210955921e-04,  3.461456584809512e-02, -7.932955424176215e-04, 7.432008277737725e-03, -5.498937188437364e-03, 2.829298753910758e-03, -1.170352862711655e-01, 1.457817194082524e-01, -4.957298830259803e-03, 7.690450161700886e-02, -1.253478050747592e-02,  5.055410683678749e-03, 1.642204875916252e-02, 2.989645383899430e-03, -6.649747802076462e-02, 7.722966267100330e-02, -3.109872728137301e-03, 5.029837630181781e-02, 2.521011946033692e-06, 7.505579411155179e-03, -7.637712243592608e-03,  4.457022044538612e-03, -1.353036783273771e-01, 1.671619659883021e-01, -2.215987578387049e-03, 8.399118351260089e-02, -1.590737182864626e-02, 6.260595253946332e-03, 1.998747846732937e-02, 3.026240089994812e-03, -7.589359162574229e-02,  8.802981397079059e-02, -2.265543084709440e-03, 5.586203117805885e-02, -1.017779802706148e-03, 1.028781694748256e-02, -5.104843694225765e-03, 1.774350245744488e-03, -1.263584992904412e-01, 1.958308746336045e-01, 1.795619901217356e-02,  4.161902458224007e-02, -1.582018433338491e-02, 1.013330095732506e-02, 2.370781902610233e-02, -5.656971239849234e-04, -7.117840623008581e-02, 9.930545098729424e-02, 7.810090288681897e-03, 3.777120825292146e-02, -4.567249400039709e-04,  1.893882558883549e-02, -6.924367546723839e-03, 1.152759948147952e-03, -1.839828995392652e-01, 2.832495455268081e-01,  3.268449080995498e-02, 1.048414709588861e-01, -2.751174657454057e-02, 1.556742669381979e-02, 5.064872860779029e-02,  8.868611131602980e-04, -1.068199362014902e-01, 1.460089214813720e-01, 1.603373809430071e-02, 7.921034671759447e-02 ))

  expect_equal(c(res$lag_one_cor),
               c( 1.466540934583230e-04, -7.393021594905250e-05, -7.441389714235905e-05, -8.073558295402233e-05, -8.237541308557613e-05,  1.384139373189651e-04, 4.928652678054081e-07, -7.270508228140275e-06, -8.624927102890060e-05, 1.294305013902629e-05,  1.429983624189466e-04, 4.875463445511012e-06, -9.616141301015960e-05, 3.567867226201139e-06, -2.311213538010478e-06,  1.552113343074577e-04, 2.770719997618474e-03, -2.671142893176672e-03, -2.809421935096684e-04, -1.571074851321743e-03, -2.675650192930855e-03, 2.863628935625316e-03, 1.826324247542863e-06, 1.480354873039825e-03, -2.748302658485615e-04, -3.808649128732022e-06, 4.891886295700632e-04, 1.657076213887977e-05, -1.544202223415216e-03, 1.450134702763766e-03,  1.932316564083141e-05, 1.036423350130727e-03, 1.182625700743742e-03, -1.216653561764107e-03, -2.223561389249191e-04, -7.625921764634308e-04, -1.149343440022080e-03, 1.288694897422183e-03, 1.198821843462675e-04, 7.370156675349093e-04, -1.141762945043090e-04, 6.973311252942507e-06, 1.839777821754564e-04, 1.784165368492528e-05, -6.693151616819019e-04,  6.829281129494947e-04, 7.821921064514186e-05, 4.863269939545615e-04, 6.216251765359045e-04, -6.478888942353770e-04, -8.774059688829554e-05, -3.893094462905793e-04, -6.434278496829939e-04, 7.231845606777143e-04, 3.873411069423054e-05,  4.029069528664305e-04, -1.140045324775282e-04, 6.857230966449985e-05, 9.190201243375951e-05, 4.711450437576378e-05, -4.009420306652332e-04, 4.183208941891944e-04, 3.107555666717114e-05, 2.766185657780953e-04, 8.255012387598177e-04, -9.362983684159270e-04, -9.048524358414650e-05, -5.376509397885976e-04, -8.590252643778827e-04, 1.059593799553785e-03,  1.052976398190241e-05, 5.607531754839073e-04, -1.193798207086728e-04, 5.040875478568824e-05, 1.402967298433675e-04,  3.385099854138983e-05, -5.155445131740872e-04, 5.849666627162750e-04, 1.519842155593714e-05, 3.792833995822887e-04,  1.176922831194073e-03, -1.292699222621823e-03, -1.193458540581507e-04, -7.537607057337973e-04, -1.318462470665159e-03,  1.606993663136538e-03, -2.299511245467886e-05, 8.487315885302223e-04, -1.498538675325866e-04, 7.577967059578301e-06,  2.500237635307711e-04, 1.434255508855194e-05, -7.612511355495622e-04, 8.400044471719649e-04, -4.599321716668254e-06,  5.696238289327105e-04, 2.026238716688262e-03, -2.170558906142534e-03, -3.120812772842219e-04, -1.189466284913729e-03, -2.179872169136015e-03, 2.649097554011498e-03, 2.500364927736815e-05, 1.296087386402495e-03, -2.765675634206577e-04, -2.302292001028881e-05, 5.090945170870790e-04, -2.495611460598639e-05, -1.266672180603330e-03, 1.375260551076185e-03,  2.738090919385842e-05, 9.272798402037152e-04, 2.287866073384714e-03, -3.040982150426924e-03, -7.348512043348039e-04, -7.719480642022606e-04, -2.434745838991969e-03, 3.704751641950065e-03, 4.273560233094639e-04, 7.332512525395382e-04, -3.975501281508508e-04, 1.246733243860436e-04, 6.958349787991903e-04, -5.618975438466677e-05, -1.311222197951730e-03,  1.693790342460966e-03, 1.582223715194548e-04, 7.756751357060874e-04, 3.597787100416731e-03, -4.596703237124816e-03, -1.423240879632320e-03, -1.992398107522902e-03, -4.658087901931215e-03, 7.081303243619604e-03, 1.129344735878660e-03,  2.353702266056163e-03, -1.219560839346675e-03, 8.860795017123511e-04, 1.673180927268260e-03, 1.828608356525039e-04, -1.286528604447205e-03, 1.251698707899474e-03, 1.736240839815910e-05, 1.436512737731507e-03, 9.334534931844343e-03, -1.139392110724178e-02, -2.378723012365650e-03, -5.185481065387800e-03, -1.149524142348343e-02, 1.758154507056057e-02,  4.332134766267793e-04, 5.648037485011701e-03, -3.905183927177311e-03, 2.302594438268107e-03, 5.018207399991233e-03,  7.559276699665434e-04, -5.304734832549380e-03, 5.973994830388578e-03, -1.246701858421541e-04, 4.712492324220795e-03 ))

  expect_equal(c(res$Q),
               c( 1.23810180636015721, 0.11433605392226150, -0.29477446669987295, -0.41586024766021518, 0.11433605392226150,  0.74613467469296713, 0.01856407013140937, -1.20174663267387527, -0.29477446669987295, 0.01856407013140937,  1.18230465964501086, -0.08779706945123422, -0.41586024766021518, -1.20174663267387527, -0.08779706945123422,  2.27941634619650069 ))

  expect_equal(c(res$Q_0),
               c( 0.0078719360458670250, 0.0006965726628823138, -0.0021012020424262326, -0.0026935632078018781, 0.0006965726628823138,  0.0048499409662073655, 0.0001799341926799392, -0.0076129450514618750, -0.0021012020424262326, 0.0001799341926799392,  0.0077230674293200319, -0.0005141307566217908, -0.0026935632078018781, -0.0076129450514618750, -0.0005141307566217908,  0.0146902276485358623 ))
})






#########
# Without estimating Q_0 and second order

# Setup the parems we need to parse
n_parem <- ncol(design_mat$X)

Q_0 <- Q <- matrix(0.0, nrow = n_parem * 2, ncol = n_parem * 2)
diag(Q[1:n_parem, 1:n_parem]) <- 1.0e-6
diag(Q_0) <- 1.0e1

a_0 <- rep(0, 2 * n_parem)

F_ = matrix(NA_real_, nrow = 2 * n_parem, ncol = 2 * n_parem)
F_[1:n_parem, 1:n_parem] = diag(2, n_parem)
F_[n_parem + 1:n_parem, 1:n_parem] = diag(1, n_parem)
F_[1:n_parem, n_parem + 1:n_parem] = diag(-1, n_parem)
F_[n_parem + 1:n_parem, n_parem + 1:n_parem] = 0.0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2],
                    a_0 = a_0,
                    Q_0 = Q_0,
                    Q = Q,
                    F_= F_, # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 2,
                    est_Q_0 = F)

# expect_equal_eps <- 1.0e-3
# get_expect_equal(res, eps = expect_equal_eps)

test_that("Testing versus previously computed values with order 2 and no Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 7.140327974661531e-01, 3.918583871184473e-01, 3.175713717620532e-01, 3.649498423497686e-01, 1.121653865903965e+00,  6.196311247461598e-01, 5.021109461172948e-01, 5.771038183748548e-01, 3.918583871184458e-01, 2.332617877000303e-01,  1.818271118019307e-01, 2.089271948780261e-01, 6.198855227439591e-01, 3.641429696867690e-01, 2.864922916355139e-01,  3.291548872246226e-01, 3.175713717620539e-01, 1.818271118019315e-01, 1.554648406795334e-01, 1.689526128366009e-01,  5.023936894366846e-01, 2.865364240200988e-01, 2.418692822383073e-01, 2.663580579602545e-01, 3.649498423497696e-01,  2.089271948780231e-01, 1.689526128366023e-01, 2.029914881376591e-01, 5.774092317136426e-01, 3.291958598158286e-01,  2.663488113395880e-01, 3.166774469569690e-01, 1.121653865903965e+00, 6.198855227439605e-01, 5.023936894366841e-01,  5.774092317136416e-01, 2.938732127133142e+00, 1.641620844680185e+00, 1.330184405308455e+00, 1.529010485884409e+00,  6.196311247461581e-01, 3.641429696867718e-01, 2.865364240200978e-01, 3.291958598158321e-01, 1.641620844680184e+00,  9.430884681157679e-01, 7.538874834243807e-01, 8.663015894972874e-01, 5.021109461172957e-01, 2.864922916355149e-01,  2.418692822383067e-01, 2.663488113395863e-01, 1.330184405308455e+00, 7.538874834243819e-01, 6.224994576476774e-01,  7.014977426694406e-01, 5.771038183748561e-01, 3.291548872246191e-01, 2.663580579602561e-01, 3.166774469569629e-01,  1.529010485884411e+00, 8.663015894972835e-01, 7.014977426694430e-01, 8.190317345981075e-01, 6.714163649821952e-03, -3.496315652910221e-03, -2.772211964713139e-03, -3.298283276389468e-03, 7.901687326295039e-03, -4.375563479851330e-03, -3.481434115118251e-03, -4.104262506237568e-03, -3.496315652911355e-03, 6.167113069384708e-03, 2.409309222791455e-04,  3.376740273972828e-04, -4.154607828726521e-03, 7.579243690926531e-03, 3.382964747461650e-04, 4.017483268728655e-04, -2.772211964712924e-03, 2.409309222796550e-04, 5.575391629946351e-03, 2.392692280118547e-05, -3.270280996984237e-03,  3.573507186127084e-04, 6.856464211314424e-03, 5.401099171640743e-05, -3.298283276388550e-03, 3.376740273950080e-04,  2.392692280200903e-05, 5.785559001860709e-03, -3.887199955643696e-03, 4.104797745112590e-04, 4.199918836474812e-05,  7.111507709920230e-03, 7.901687326295046e-03, -4.154607828725271e-03, -3.270280996984548e-03, -3.887199955644678e-03,  7.140327974661496e-01, 3.918583871184472e-01, 3.175713717620529e-01, 3.649498423497685e-01, -4.375563479852625e-03,  7.579243690926506e-03, 3.573507186121289e-04, 4.104797745138811e-04, 3.918583871184457e-01, 2.332617877000329e-01,  1.818271118019308e-01, 2.089271948780266e-01, -3.481434115117915e-03, 3.382964747467292e-04, 6.856464211314429e-03,  4.199918836369856e-05, 3.175713717620535e-01, 1.818271118019315e-01, 1.554648406795294e-01, 1.689526128366008e-01, -4.104262506236570e-03, 4.017483268702257e-04, 5.401099171747104e-05, 7.111507709920219e-03, 3.649498423497695e-01,  2.089271948780235e-01, 1.689526128366022e-01, 2.029914881376553e-01, 4.225806678880889e-03, -2.342856252285318e-03, -1.782944183757447e-03, -2.132521796004724e-03, 4.889931350647632e-03, -3.073934787452358e-03, -2.348314659516754e-03, -2.782977602335406e-03, -2.342856252286116e-03, 3.759743645875124e-03, 9.313218177605303e-05, 2.423676645472979e-04, -2.975913652368390e-03, 4.622019265236324e-03, 8.270718796376188e-05, 2.233801871324701e-04, -1.782944183757399e-03,  9.313218177644026e-05, 3.492709086978835e-03, 5.652169896477591e-05, -2.353713742798672e-03, 3.584562209539822e-05,  4.260448737466636e-03, -2.775716594534827e-05, -2.132521796003969e-03, 2.423676645456842e-04, 5.652169896526672e-05,  3.651787384794127e-03, -2.826499165051559e-03, 1.497727949974145e-04, -4.508912295249088e-05, 4.420969736543196e-03,  4.889931350647639e-03, -2.975913652367418e-03, -2.353713742798774e-03, -2.826499165052399e-03, 6.714163649822000e-03, -3.496315652910260e-03, -2.772211964713120e-03, -3.298283276389511e-03, -3.073934787453353e-03, 4.622019265236315e-03,  3.584562209495544e-05, 1.497727949993375e-04, -3.496315652911395e-03, 6.167113069384764e-03, 2.409309222791342e-04,  3.376740273973087e-04, -2.348314659516659e-03, 8.270718796418517e-05, 4.260448737466629e-03, -4.508912295308967e-05, -2.772211964712905e-03, 2.409309222796437e-04, 5.575391629946358e-03, 2.392692280117300e-05, -2.782977602334536e-03,  2.233801871305504e-04, -2.775716594474438e-05, 4.420969736543201e-03, -3.298283276388593e-03, 3.376740273950338e-04,  2.392692280199656e-05, 5.785559001860750e-03, 2.456639250915089e-03, -1.409121605412034e-03, -1.154893056393675e-03, -1.331864860835391e-03, 2.895641948271563e-03, -1.755440883688887e-03, -1.424611422104953e-03, -1.653117047671297e-03, -1.409121605412469e-03, 2.502132524314861e-03, 1.261683678528203e-04, 2.903707942494042e-04, -1.987025120483649e-03,  2.871539428780115e-03, 3.068968047111202e-05, 2.140266880685575e-04, -1.154893056393732e-03, 1.261683678531481e-04,  2.238519384657683e-03, 1.055317952264900e-04, -1.521594443900009e-03, 8.271443068679803e-05, 2.627776349241956e-03,  6.017019461317810e-05, -1.331864860834934e-03, 2.903707942483169e-04, 1.055317952267785e-04, 2.389762146428624e-03, -1.831548324487716e-03, 2.373954654634150e-04, 2.931142546022500e-05, 2.769783069443205e-03, 2.895641948271596e-03, -1.987025120483026e-03, -1.521594443899995e-03, -1.831548324488342e-03, 4.225806678880917e-03, -2.342856252285355e-03, -1.782944183757470e-03, -2.132521796004728e-03, -1.755440883689477e-03, 2.871539428780131e-03, 8.271443068646502e-05,  2.373954654647432e-04, -2.342856252286152e-03, 3.759743645875169e-03, 9.313218177607323e-05, 2.423676645473071e-04, -1.424611422104979e-03, 3.068968047143529e-05, 2.627776349241940e-03, 2.931142545983946e-05, -1.782944183757422e-03,  9.313218177646045e-05, 3.492709086978856e-03, 5.652169896477672e-05, -1.653117047670702e-03, 2.140266880672108e-04,  6.017019461352605e-05, 2.769783069443176e-03, -2.132521796003972e-03, 2.423676645456933e-04, 5.652169896526753e-05,  3.651787384794134e-03, 1.921361676485493e-03, -9.673374993913767e-04, -8.322200652313666e-04, -8.995119532395051e-04,  1.793675205802515e-03, -1.193401213201573e-03, -9.918956420712018e-04, -1.124239224540139e-03, -9.673374993915277e-04,  1.920939767191799e-03, 1.142150394786900e-04, 1.840274554520884e-04, -1.188733950205927e-03, 1.928069297305739e-03,  5.481686260846296e-05, 1.787385884964926e-04, -8.322200652314347e-04, 1.142150394790340e-04, 1.753786291340243e-03,  7.504239184842021e-05, -9.871780642521579e-04, 5.627412636041179e-05, 1.755724948497954e-03, 4.842779871627055e-05, -8.995119532392297e-04, 1.840274554514567e-04, 7.504239184859336e-05, 1.851313628606996e-03, -1.127887806502789e-03,  1.766084079065842e-04, 4.400441097320862e-05, 1.855902977608120e-03, 1.793675205802481e-03, -1.188733950205682e-03, -9.871780642520991e-04, -1.127887806503143e-03, 2.456639250915068e-03, -1.409121605412020e-03, -1.154893056393663e-03, -1.331864860835385e-03, -1.193401213201829e-03, 1.928069297305747e-03, 5.627412636007432e-05, 1.766084079074059e-04, -1.409121605412455e-03, 2.502132524314847e-03, 1.261683678528152e-04, 2.903707942493975e-04, -9.918956420712404e-04,  5.481686260882030e-05, 1.755724948497965e-03,
                  4.400441097301192e-05, -1.154893056393721e-03, 1.261683678531431e-04,  2.238519384657674e-03, 1.055317952264895e-04, -1.124239224539780e-03, 1.787385884956868e-04, 4.842779871649381e-05,  1.855902977608129e-03, -1.331864860834928e-03, 2.903707942483102e-04, 1.055317952267781e-04, 2.389762146428631e-03,  2.035999656299037e-03, -1.003173490607476e-03, -9.310397805718362e-04, -8.875155851764899e-04, 1.531413636200187e-03, -1.005589223928578e-03, -8.948521468904829e-04, -9.206391215371495e-04, -1.003173490607525e-03, 2.215700604436808e-03,  1.483141260643837e-04, 7.369548743382906e-05, -1.032549730946917e-03, 1.766630340624993e-03, 4.954000786157417e-05,  5.081603403798261e-05, -9.310397805719489e-04, 1.483141260647011e-04, 2.052377578667464e-03, 2.000048644130117e-05, -9.085010609090015e-04, 5.507712077322840e-05, 1.651667430243795e-03, -7.788341433703902e-06, -8.875155851763954e-04,  7.369548743347301e-05, 2.000048644141545e-05, 2.140576040089951e-03, -9.460385061634557e-04, 5.301974626772439e-05, -1.249972050036724e-05, 1.714898970671278e-03, 1.531413636200228e-03, -1.032549730946830e-03, -9.085010609088729e-04, -9.460385061636099e-04, 1.921361676485478e-03, -9.673374993913738e-04, -8.322200652313586e-04, -8.995119532394883e-04, -1.005589223928674e-03, 1.766630340624978e-03, 5.507712077288022e-05, 5.301974626816102e-05, -9.673374993915246e-04,  1.920939767191792e-03, 1.142150394786909e-04, 1.840274554520784e-04, -8.948521468905922e-04, 4.954000786190694e-05,  1.651667430243793e-03, -1.249972050050670e-05, -8.322200652314265e-04, 1.142150394790349e-04, 1.753786291340224e-03,  7.504239184841612e-05, -9.206391215370166e-04, 5.081603403750515e-05, -7.788341433584006e-06, 1.714898970671253e-03, -8.995119532392129e-04, 1.840274554514468e-04, 7.504239184858928e-05, 1.851313628606985e-03, 3.309458881593135e-03, -1.285430803880921e-03, -1.255832658185831e-03, -1.028348173022303e-03, 1.960054793972163e-03, -1.329098550923908e-03, -1.236485108128317e-03, -1.127256438979169e-03, -1.285430803880921e-03, 3.484878655047310e-03, 3.132139713352934e-04,  8.065643616321391e-05, -1.327428995358899e-03, 2.463577885125210e-03, 8.212982048791203e-05, -7.377124012285390e-05, -1.255832658185952e-03, 3.132139713354978e-04, 3.206352775515280e-03, 4.308468191189228e-05, -1.231862968860421e-03,  8.488888206271546e-05, 2.322989550277753e-03, -8.363175678578470e-05, -1.028348173022275e-03, 8.065643616301388e-05,  4.308468191199795e-05, 3.397674079980947e-03, -1.158598675720438e-03, -8.996033342744300e-05, -1.006551494505102e-04,  2.408730657851905e-03, 1.960054793972218e-03, -1.327428995358888e-03, -1.231862968860299e-03, -1.158598675720486e-03,  2.035999656299011e-03, -1.003173490607468e-03, -9.310397805718392e-04, -8.875155851764726e-04, -1.329098550923893e-03,  2.463577885125208e-03, 8.488888206242612e-05, -8.996033342719440e-05, -1.003173490607517e-03, 2.215700604436791e-03,  1.483141260643945e-04, 7.369548743383923e-05, -1.236485108128485e-03, 8.212982048815722e-05, 2.322989550277719e-03, -1.006551494506566e-04, -9.310397805719517e-04, 1.483141260647119e-04, 2.052377578667481e-03, 2.000048644129699e-05, -1.127256438979117e-03, -7.377124012311986e-05, -8.363175678568829e-05, 2.408730657851891e-03, -8.875155851763778e-04,  7.369548743348312e-05, 2.000048644141127e-05, 2.140576040089934e-03, 4.701889702343668e-03, -2.492010436185176e-03, -2.371294440270834e-03, -1.921718993217913e-03, 3.153156764516716e-03, -2.185517397023652e-03, -2.049204785876084e-03, -1.737770403413196e-03, -2.492010436185154e-03, 5.295686315227602e-03, 2.489294541147730e-04, -1.812336283980306e-04, -2.089907036719318e-03, 3.974373333906635e-03, 1.079310150843585e-04, -2.220249303989558e-04, -2.371294440270855e-03,  2.489294541148843e-04, 4.917777152145451e-03, -1.766639564814012e-04, -1.962300400836634e-03, 1.141727938249439e-04,  3.737575794099417e-03, -1.965303074781082e-04, -1.921718993217893e-03, -1.812336283981415e-04, -1.766639564813435e-04,  5.280522895268884e-03, -1.719300321472858e-03, -2.594684210416084e-04, -2.340141741591776e-04, 3.945011593381193e-03,  3.153156764516705e-03, -2.089907036719342e-03, -1.962300400836592e-03, -1.719300321472896e-03, 3.309458881593167e-03, -1.285430803880857e-03, -1.255832658185930e-03, -1.028348173022317e-03, -2.185517397023615e-03, 3.974373333906647e-03,  1.141727938247923e-04, -2.594684210414621e-04, -1.285430803880857e-03, 3.484878655047226e-03, 3.132139713352574e-04,  8.065643616323121e-05, -2.049204785876119e-03, 1.079310150845251e-04, 3.737575794099422e-03, -2.340141741592480e-04, -1.255832658186051e-03, 3.132139713354618e-04, 3.206352775515561e-03, 4.308468191184152e-05, -1.737770403413174e-03, -2.220249303990986e-04, -1.965303074780367e-04, 3.945011593381187e-03, -1.028348173022290e-03, 8.065643616303117e-05,  4.308468191194720e-05, 3.397674079980997e-03, 6.606510436353970e-03, -3.554787778642194e-03, -3.466879638228403e-03, -3.504482625191579e-03, 4.879502440491702e-03, -3.039371889412452e-03, -2.943465184614718e-03, -2.988528019252632e-03, -3.554787778642222e-03, 8.729689178785083e-03, 7.992522098203093e-04, -2.316159264697948e-04, -3.570952022229632e-03,  6.534603891578177e-03, 2.917402249599440e-04, -5.902234149409031e-04, -3.466879638228447e-03, 7.992522098203327e-04,  7.847083126482725e-03, -2.789496927126795e-04, -3.319185091060867e-03, 3.236310825708728e-04, 6.022949658545865e-03, -5.139742917670270e-04, -3.504482625191587e-03, -2.316159264698228e-04, -2.789496927126406e-04, 7.749499069973189e-03, -2.825040116257491e-03, -2.167507727452862e-04, -2.424342546942754e-04, 6.161778029034766e-03, 4.879502440491750e-03, -3.570952022229606e-03, -3.319185091060834e-03, -2.825040116257477e-03, 4.701889702343663e-03, -2.492010436185142e-03, -2.371294440270773e-03, -1.921718993217937e-03, -3.039371889412480e-03, 6.534603891578161e-03, 3.236310825707955e-04, -2.167507727452330e-04, -2.492010436185121e-03, 5.295686315227564e-03, 2.489294541147553e-04, -1.812336283980226e-04, -2.943465184614784e-03, 2.917402249599773e-04, 6.022949658545841e-03, -2.424342546943541e-04, -2.371294440270794e-03,  2.489294541148666e-04, 4.917777152145248e-03, -1.766639564814147e-04, -2.988528019252624e-03, -5.902234149409741e-04, -5.139742917669788e-04, 6.161778029034764e-03, -1.921718993217917e-03, -1.812336283981335e-04, -1.766639564813570e-04,  5.280522895268892e-03, 9.953507180676039e-03, -4.228116176607005e-03, -4.268793194848916e-03, -4.943771882527299e-03,  6.759859396543057e-03, -4.274664198877833e-03, -4.174474574648900e-03, -4.812064257734868e-03, -4.228116176607005e-03,  1.377144803577019e-02, 1.991807889590749e-03, 2.534080115587703e-04, -4.956993005098097e-03, 1.050971814535622e-02,  9.593031514680160e-04, -6.005293014014168e-04, -4.268793194848916e-03, 1.991807889590749e-03, 1.205317197876872e-02,  3.768752770317209e-05, -4.708732490972753e-03, 9.706756697556478e-04, 9.415344066840159e-03, -6.022738229458309e-04, -4.943771882527299e-03, 2.534080115587703e-04, 3.768752770317209e-05, 1.142574346635181e-02, -4.846289463739943e-03, -2.593671147321045e-04, -3.378022313960785e-04, 9.007295192048587e-03, 6.759859396543057e-03, -4.956993005098097e-03, -4.708732490972753e-03, -4.846289463739943e-03, 6.606510436353950e-03, -3.554787778642194e-03,
                  -3.466879638228411e-03, -3.504482625191546e-03, -4.274664198877833e-03, 1.050971814535622e-02, 9.706756697556479e-04, -2.593671147321045e-04, -3.554787778642222e-03, 8.729689178785083e-03, 7.992522098203295e-04, -2.316159264698356e-04, -4.174474574648900e-03,  9.593031514680160e-04, 9.415344066840159e-03, -3.378022313960785e-04, -3.466879638228456e-03, 7.992522098203529e-04,  7.847083126482818e-03, -2.789496927127041e-04, -4.812064257734867e-03, -6.005293014014171e-04, -6.022738229458309e-04,  9.007295192048587e-03, -3.504482625191555e-03, -2.316159264698636e-04, -2.789496927126652e-04, 7.749499069973124e-03,  1.776518888064814e-02, -5.692461670639142e-03, -5.480687852391862e-03, -3.531229696974897e-03, 9.535348677362882e-03, -7.896934582375637e-03, -7.152279978708186e-03, -5.848153827829159e-03, -5.692461670639142e-03, 1.813340370623702e-02,  2.113800839565983e-03, 1.287314891199114e-03, -6.217148670713275e-03, 1.455457158268509e-02, 1.139849726373140e-03,  3.114055916192877e-04, -5.480687852391862e-03, 2.113800839565983e-03, 1.626607416922092e-02, 9.166217058010765e-04, -6.012262449186167e-03, 1.016282936373869e-03, 1.317343355304965e-02, 4.474090314611757e-05, -3.531229696974897e-03,  1.287314891199114e-03, 9.166217058010765e-04, 1.832278496479600e-02, -6.971219722268592e-03, -1.200938416998173e-03, -1.066761056190730e-03, 1.342060051505562e-02, 9.535348677362882e-03, -6.217148670713275e-03, -6.012262449186167e-03, -6.971219722268592e-03, 9.953507180676134e-03, -4.228116176606903e-03, -4.268793194848897e-03, -4.943771882527326e-03, -7.896934582375637e-03, 1.455457158268509e-02, 1.016282936373869e-03, -1.200938416998173e-03, -4.228116176606903e-03,  1.377144803576993e-02, 1.991807889590684e-03, 2.534080115587172e-04, -7.152279978708186e-03, 1.139849726373140e-03,  1.317343355304965e-02, -1.066761056190730e-03, -4.268793194848897e-03, 1.991807889590684e-03, 1.205317197876870e-02,  3.768752770314052e-05, -5.848153827829159e-03, 3.114055916192877e-04, 4.474090314611757e-05, 1.342060051505562e-02, -4.943771882527326e-03, 2.534080115587172e-04, 3.768752770314052e-05, 1.142574346635180e-02 )
               , tolerance = 0.001)

  expect_equal(c(res$a_t_d_s),
               c(-5.290440333401230433, -4.422732790070636355, -3.554805726067822302, -3.185195135335881833, -2.781452766284515654, -2.892511171562709649, -2.630911915678770807, -1.821616980806506580, -1.185874360209378864, -1.750664291861727229,  0.914973294521816527, 0.774174464994691558, 1.171790865457916553, 1.569530987668283473, 1.686451800399369816,  1.822700797177850829, 1.668921416646759193, 1.725282539298885531, 2.090353546452857092, 2.357572857800913191,  1.948135982992327930, 3.359349573615310280, 0.102369218316746183, 0.365518292503823949, 0.628767601581405211,  0.664476888431879686, 0.715761935069396227, 0.531955453426907310, 0.518238659074546693, 0.754482489848566029,  0.911352998122094693, 0.519941735613486333, 1.603525387055905860, 1.422199270663745185, 1.407452208652427039,  1.392820369422265170, 1.116641528418677698, 0.858424863350343514, 0.330087848745020396, -0.002527917349380323, -0.047495311045642641, -0.183335541672053459, -0.949155720684146442, -0.019307384425789387, -6.158056916008242787, -5.290440333401230433, -4.422732790070637243, -3.554805726067822746, -3.185195135335882277, -2.781452766284515654, -2.892511171562711425, -2.630911915678775248, -1.821616980806498809, -1.185874360209406397, -1.750664291861756316,  0.376609329959248229, 0.774174464994691558, 1.171790865457917885, 1.569530987668284361, 1.686451800399370260,  1.822700797177851051, 1.668921416646760303, 1.725282539298889306, 2.090353546452858424, 2.357572857800929178,  1.948135982992323934, -0.160738322477522066, 0.102369218316746183, 0.365518292503823394, 0.628767601581405544,  0.664476888431879908, 0.715761935069396227, 0.531955453426905644, 0.518238659074551578, 0.754482489848553595,  0.911352998122133884, 0.519941735613511535, 1.436994076462391190, 1.422199270663745185, 1.407452208652427927,  1.392820369422265392, 1.116641528418678142, 0.858424863350343736, 0.330087848745019508, -0.002527917349384179, -0.047495311045641198, -0.183335541672063229, -0.949155720684118132 )
               , tolerance = 0.001)

  expect_equal(c(res$B_s),
               c( 5.551115123125783e-17, 6.938893903907228e-18, -1.734723475976807e-17, -6.938893903907228e-18, -8.825163494727566e-01,  6.621372506988550e-02, 5.364393227134633e-02, 6.166520321446661e-02, -1.040834085586084e-17, 1.110223024625157e-16,  1.734723475976807e-18, 0.000000000000000e+00, 6.621372506988550e-02, -9.626818374441124e-01, 3.023371851546679e-02,  3.475450887897812e-02, -3.469446951953614e-17, -6.938893903907228e-18, 5.551115123125783e-17, -1.214306433183765e-17,  5.364393227134633e-02, 3.023371851546679e-02, -9.755056455824272e-01, 2.815682030144067e-02, -2.428612866367530e-17,  8.673617379884035e-18, 5.204170427930421e-18, -1.110223024625157e-16, 6.166520321446661e-02, 3.475450887897812e-02,  2.815682030144067e-02, -9.676328276457549e-01, 9.999999999999997e-01, -1.387778780781446e-17, 1.387778780781446e-17, -6.938893903907228e-18, 1.765032698945513e+00, -1.324274501397710e-01, -1.072878645426926e-01, -1.233304064289332e-01, -1.387778780781446e-17, 1.000000000000000e+00, 0.000000000000000e+00, 2.775557561562891e-17, -1.324274501397710e-01,  1.925363674888225e+00, -6.046743703093358e-02, -6.950901775795626e-02, 4.163336342344337e-17, 1.387778780781446e-17,  9.999999999999997e-01, 2.081668171172169e-17, -1.072878645426926e-01, -6.046743703093359e-02, 1.951011291164854e+00, -5.631364060288135e-02, 4.857225732735060e-17, 0.000000000000000e+00, -2.081668171172169e-17, 1.000000000000000e+00, -1.233304064289332e-01, -6.950901775795625e-02, -5.631364060288133e-02, 1.935265655291510e+00, -4.533038252900306e-18,  1.707205039732696e-18, 2.687942503562677e-18, 8.342561213978773e-19, -7.073666337772717e-01, 1.649278642050248e-01,  1.336185177500352e-01, 1.535982220212809e-01, 2.570823070227372e-18, 2.354269324964856e-19, -1.025324808730070e-18, -5.499613758001156e-19, 1.649278642050250e-01, -9.070461197294756e-01, 7.530738842328459e-02, 8.656796010761229e-02,  1.079361408325950e-18, -1.981546398926213e-18, -4.207576984927516e-18, 1.722714449908526e-18, 1.336185177500351e-01,  7.530738842328452e-02, -9.389881897193730e-01, 7.013414967145291e-02, -3.384470689641330e-19, -3.663050798087928e-19,  9.377225489139236e-19, 9.398061266111418e-19, 1.535982220212806e-01, 8.656796010761207e-02, 7.013414967145280e-02, -9.193782416493754e-01, 1.000000000000003e+00, -1.347632726620191e-15, 1.246199423425430e-15, -5.285446968948278e-16,  1.525821343254113e+00, -2.672466093280562e-01, -2.165134188900037e-01, -2.488882288837550e-01, 7.765629552151111e-16,  1.000000000000001e+00, 2.265206266265977e-16, 4.838514143943661e-16, -2.672466093280527e-01, 1.849378953384946e+00, -1.220269497896455e-01, -1.402734092722519e-01, 1.987063170753781e-15, -7.723148792088650e-16, 1.000000000000001e+00, -4.012319828096820e-16, -2.165134188900037e-01, -1.220269497896478e-01, 1.901137398965752e+00, -1.136443128171306e-01,  5.065734102654429e-16, -2.946069802240264e-16, 2.680331096323711e-16, 1.000000000000001e+00, -2.488882288837524e-01, -1.402734092722523e-01, -1.136443128171290e-01, 1.869361736987540e+00, 1.368455348621728e-16, -6.369619740079916e-17, -7.305899500803667e-17, 9.219703388661039e-18, -4.793191742109481e-01, 2.934426635658208e-01, 2.377367643436529e-01,  2.732856404724111e-01, -8.316343963501748e-17, 2.536448015182144e-16, 3.452071893947382e-17, -2.068073630148120e-19,  3.143768792119713e-01, -8.227797965701423e-01, 1.435407722961018e-01, 1.650032853667392e-01, 3.529253317526597e-17, -1.083903421554030e-17, -3.226404226582353e-17, -6.066292240433444e-17, 2.871284782997610e-01, 1.618181638222468e-01, -8.688544435175254e-01, 1.506996776377963e-01, 3.137723565949422e-17, -1.080155685045817e-16, -1.019694914957917e-16,  3.132177522933430e-17, 3.251706209631842e-01, 1.832573723456097e-01, 1.484667113845954e-01, -8.292849185755223e-01,  1.000000000000003e+00, -7.479299680758097e-16, -2.332553058246156e-16, 7.870870872338968e-16, 9.588068071473304e-01, -5.867908710368677e-01, -4.753969837203116e-01, -5.464833152009263e-01, 8.024928499805851e-16, 1.000000000000001e+00,  3.776479033065619e-16, 8.063545936162967e-16, -6.286593129109709e-01, 1.645613677018259e+00, -2.870384243465715e-01, -3.299569982744064e-01, -4.547433240916813e-17, 1.264584339275199e-15, 1.000000000000001e+00, 4.276095370538908e-16, -5.741804350696034e-01, -3.235932157762613e-01, 1.737744657592201e+00, -3.013592586515607e-01, 1.937113801442788e-15,  1.258847747481466e-16, 1.646506692152724e-16, 1.000000000000001e+00, -6.502533019423364e-01, -3.664651811961908e-01, -2.968933256055800e-01, 1.658616864733218e+00, -2.852874780467735e-16, 3.486268050630574e-17, 1.878481020725141e-16,  1.454931064067551e-16, -4.807342607563154e-01, 2.925881985924898e-01, 2.370409353881814e-01, 2.724900594467473e-01, -1.203605944571513e-18, -1.313535989441041e-16, -5.065856826075747e-17, -2.314512977766009e-16, 3.330102858739292e-01, -8.120999346066115e-01, 1.520149030900209e-01, 1.747351778967078e-01, 6.615090678919743e-16, -4.665797424353228e-16,  1.082459368393019e-16, -2.908973679951318e-16, 2.830156604304123e-01, 1.594622954078384e-01, -8.705297648761120e-01,  1.484935645332547e-01, 3.081618391233775e-16, -3.277638580864570e-16, 3.309132413112239e-17, 1.686911957026693e-16,  3.117995557853264e-01, 1.756716613493115e-01, 1.423163142232596e-01, -8.361092920347973e-01, 9.999999999999989e-01, -7.803343755603423e-16, -5.876964253225031e-16, -7.915934358920276e-16, 9.616555444391159e-01, -5.850966333412939e-01, -4.740166981434317e-01, -5.449040585863254e-01, 3.224118428915582e-16, 9.999999999999986e-01, -4.812491697191431e-16, -6.776318048963473e-16, -6.659333666075939e-01, 1.624322914546313e+00, -3.040024710233435e-01, -3.494406564636342e-01, -4.879570178306712e-16, 1.383039657493356e-16, 9.999999999999987e-01, -7.911694335925910e-17, -5.659442985334632e-01, -3.188904356310744e-01, 1.741179168405956e+00, -2.969601847017325e-01, -1.030761484756315e-15, -6.892754038860286e-17,  2.514563997419060e-16, 1.000000000000000e+00, -6.235005566800405e-01, -3.513053708677060e-01, -2.846051966610723e-01,  1.672346016497691e+00, -2.971243646200040e-17, -4.353011383371639e-16, -5.370141366204630e-16, -4.860157656884000e-16, -4.556492316665255e-01, 3.065707061129450e-01, 2.483596557754003e-01, 2.855113678545433e-01, -6.566207718310282e-16,  1.630390517546425e-16, 4.637998419488732e-16, -3.859932130364404e-16, 2.998590345392085e-01, -8.302794479701221e-01,  1.367785356945380e-01, 1.571887748218280e-01, 2.219168359629322e-16, -3.179668080292981e-16, -2.751814969442067e-16, -6.966906397333845e-16, 2.881050716969627e-01, 1.622193868216093e-01, -8.676342579228160e-01, 1.510247015643707e-01,  6.159443442871531e-16, 9.420326559599504e-16, 1.235601552192557e-16, 1.051784577375134e-15, 2.952492008566014e-01,  1.661949865511896e-01, 1.346263412175495e-01, -8.442407204655605e-01, 9.999999999999990e-01, -7.097075605439590e-18,  9.575533329860787e-16, 1.004505372859507e-15, 9.115233102351834e-01, -6.131289513902773e-01, -4.967163348692729e-01, -5.710107368861816e-01, 9.441498482472909e-17, 9.999999999999987e-01, -4.474965247975781e-16, -1.173669909150940e-16, -5.996882505719748e-01, 1.660932451442102e+00, -2.736114307253587e-01, -3.144586994620088e-01, -1.499080186152915e-16,  1.053156927054356e-16, 9.999999999999987e-01,
                  6.800271989020458e-16, -5.762061304871635e-01, -3.245121888333206e-01,  1.735676099825599e+00, -3.021419315204736e-01, 3.001689886278412e-16, -2.907793427751400e-15, -2.669435453901446e-16,  9.999999999999974e-01, -5.904820947683479e-01, -3.324801925824151e-01, -2.693352794248768e-01, 1.688878336327011e+00, -1.652014998795643e-15, 8.050079461489560e-16, 9.673407043458216e-16, 5.003392839914586e-16, -4.558311666115996e-01,  3.061483038901532e-01, 2.480072945108904e-01, 2.851198118334024e-01, 1.299242728924871e-15, 6.182299765385482e-16, -2.982631433214208e-16, -1.108009695143677e-15, 3.009884434449732e-01, -8.286081950874290e-01, 1.370930499852778e-01,  1.574887491964213e-01, 1.642844511599305e-15, -4.303349819972393e-17, 2.457006284403550e-15, -1.221422297814418e-15,  2.901490647764817e-01, 1.631408457791652e-01, -8.655470126770590e-01, 1.518053527850258e-01, 2.834381391224646e-15, -1.642497510687323e-15, -5.158100760956489e-16, 2.501078902895905e-16, 2.925279354266460e-01, 1.643601900749966e-01,  1.331090197067269e-01, -8.445363889733484e-01, 1.000000000000002e+00, -6.539075486451957e-16, 4.485701749247815e-17, -1.169868616124328e-15, 9.121291113376377e-01, -6.123696784448105e-01, -4.960920214633344e-01, -5.703072885330885e-01, -7.577991700444481e-16, 9.999999999999977e-01, 2.187975308212778e-15, 2.794799146115586e-15, -6.020627807305672e-01,  1.658249117012931e+00, -2.744357267010490e-01, -3.153294580909813e-01, -2.505617485248026e-15, 1.497899286127483e-15,  9.999999999999989e-01, 9.259169055871169e-16, -5.803964158099896e-01, -3.265739104193235e-01, 1.732270063556887e+00, -3.039605255480349e-01, -1.691292167590538e-15, 3.616824911229305e-15, 1.173873762470053e-15, 9.999999999999976e-01, -5.851330750235669e-01, -3.290783389418446e-01, -2.665358902043597e-01, 1.690216902703647e+00, -2.471860857980731e-15,  2.462656911191271e-15, 1.043028577591024e-15, -6.526361946833498e-16, -4.495900340025354e-01, 3.091235210523718e-01,  2.504119801616158e-01, 2.878961664572932e-01, 9.610435070163651e-15, 4.676755881817346e-15, 1.673070963533082e-15, -4.566181450436616e-15, 2.946080294332084e-01, -8.304826987035309e-01, 1.338521876272483e-01, 1.536710585520984e-01, -3.311150711026929e-15, -2.613035930914576e-15, 7.921486563238151e-15, -1.307749298204167e-15, 2.904931812749730e-01,  1.629539398796238e-01, -8.634926764678158e-01, 1.515029904754461e-01, -4.274270066327143e-15, -7.026549603638502e-15, -2.079794848051251e-15, 8.152412042424193e-15, 2.871273449670929e-01, 1.608323891190844e-01, 1.301922433787526e-01, -8.454959694681139e-01, 1.000000000000002e+00, -1.198113626796669e-15, -1.786557068872807e-15, 3.797200205820200e-16,  9.000046196927082e-01, -6.185352280139397e-01, -5.010847172922899e-01, -5.760566868538228e-01, -9.159973059165222e-15,  9.999999999999880e-01, -4.298106574426625e-15, 8.579512008099067e-15, -5.894780829366381e-01, 1.663236546007792e+00, -2.682921875265670e-01, -3.081586759180843e-01, -4.513700099910042e-15, 6.932098214300961e-16, 1.000000000000012e+00, -3.536783317841290e-15, -5.813054298623783e-01, -3.266219236218716e-01, 1.729544445524565e+00, -3.038488588339005e-01,  3.920577037982514e-15, 1.041365755492521e-14, -1.346109214654483e-15, 9.999999999999927e-01, -5.745088788558822e-01, -3.225061083476034e-01, -2.611367079346911e-01, 1.693503398896005e+00, -5.207970923367597e-16, 1.352409007809860e-15,  4.722633836085383e-15, -2.110261241237608e-15, -4.471125941142599e-01, 3.097196039172146e-01, 2.508969006562751e-01,  2.884607092901468e-01, 9.828129137646519e-16, -8.117371795379348e-15, -1.091491467276952e-15, -1.759905601705575e-15,  2.965070041532181e-01, -8.269217080227981e-01, 1.342563036136259e-01, 1.540136319705345e-01, -1.910757068773426e-15,  7.591379051478408e-16, -2.576776068491155e-14, -3.224368588757221e-15, 2.939637286637897e-01, 1.643665127034930e-01, -8.591871459813323e-01, 1.526370179461174e-01, 3.345971213784126e-15, -1.094128401838970e-15, -1.533339157178583e-15,  1.974307646038368e-14, 2.767226763798319e-01, 1.542911431691504e-01, 1.248029024860278e-01, -8.482547603943686e-01,  1.000000000000001e+00, 4.408424771070859e-16, -6.741770597611447e-15, 1.561162642060717e-15, 8.959444057815272e-01, -6.198876684368788e-01, -5.021866653389777e-01, -5.773277522455028e-01, 4.169553392230431e-15, 1.000000000000007e+00, -3.768025966082800e-15, 7.202118010318677e-15, -5.934527363098424e-01, 1.658099487056486e+00, -2.695722928427522e-01, -3.094923162310788e-01, 4.857421153545391e-15, -5.195918267138836e-16, 1.000000000000008e+00, 1.815197413688013e-15, -5.884494963168116e-01, -3.300185756693729e-01, 1.723126535081815e+00, -3.068019554513527e-01, -1.056289917740229e-14, -2.124980300211184e-16, 2.678520919093618e-15, 9.999999999999737e-01, -5.537851939742503e-01, -3.100465265831726e-01, -2.509356218508495e-01, 1.701241186679511e+00, -4.856476080111600e-15, -2.507696782315231e-15, 9.597539470568383e-15,  5.467500876977840e-15, -4.541852855604498e-01, 3.046569135411669e-01, 2.468070605272234e-01, 2.837584858990724e-01, -9.468701930235107e-15, 5.498483488472788e-15, 1.457404902144063e-14, 3.797287323291353e-16, 3.063397684830035e-01, -8.180956497070216e-01, 1.381492960972384e-01, 1.583426476597684e-01, -8.244036992315651e-15, 1.397857406507302e-14, -1.768761765430455e-14, 3.042988072111404e-15, 3.044489408642133e-01, 1.695712939291943e-01, -8.508371026431016e-01,  1.572547267077549e-01, 1.329342317718331e-14, 5.098041147950016e-15, 5.042961055306035e-15, -3.567719524430352e-14,  2.708348734762736e-01, 1.501102210696437e-01, 1.212954312527739e-01, -8.477952670555003e-01, 1.000000000000000e+00,  5.433642359057269e-15, -1.676635693589989e-15, -5.036353712309868e-16, 9.106709029792601e-01, -6.103630335050332e-01, -4.944873473320637e-01, -5.684715035248484e-01, 6.498818996037437e-15, 9.999999999999898e-01, -1.926560955047738e-14, -1.456214547957502e-14, -6.137703166352569e-01, 1.642930436556604e+00, -2.781773795735185e-01, -3.192244628325706e-01, -1.481075493898458e-15, -8.433968343588844e-15, 1.000000000000047e+00, -2.715929978318785e-15, -6.101142573651649e-01, -3.414332685510530e-01, 1.709210732860587e+00, -3.171758673075341e-01, -9.273005137057091e-15, -4.112993951820524e-15, -8.865818838684585e-15, 1.000000000000035e+00, -5.424467678172569e-01, -3.026894684720418e-01, -2.448377103996390e-01,  1.703177447733459e+00, 1.304182477173194e-14, 8.076937801331409e-15, -5.953244727815447e-15, 2.126943709548225e-15, -4.358055160366691e-01, 3.136495675481155e-01, 2.541165192273573e-01, 2.921462387551682e-01, 1.299427666747115e-14, -2.488019653733077e-14, -1.916128625960612e-14, 9.912873520070282e-15, 2.565010301028925e-01, -8.421107202592113e-01,  1.146662260890221e-01, 1.311968107853410e-01, -9.246841782238651e-15, -1.448101456734149e-14, 1.424869538513970e-14,  1.952047639702774e-14, 2.726021772368442e-01, 1.507616435395274e-01, -8.609855525329980e-01, 1.394745359194605e-01, -3.847673411563330e-15, 6.778032167303545e-15, 8.840795904572207e-15, -4.759360323783870e-14, 3.168100592087308e-01,  1.749988792965309e-01, 1.413093956939010e-01, -8.192790861632221e-01, 1.000000000000001e+00, 7.876403170684668e-15,  5.098988224287649e-15, -6.152810285990362e-15, 8.748844231788035e-01, -6.290094688775372e-01,
                  -5.096249059715414e-01, -5.858492034174071e-01, 3.284105507957718e-14, 9.999999999999408e-01, 1.634261147621168e-14, -2.230192053161670e-14, -5.140616061061251e-01, 1.694607930615848e+00, -2.318437300348367e-01, -2.658102367235213e-01, -2.549972666766947e-15,  3.974451715001024e-14, 9.999999999999909e-01, -1.678734796165200e-14, -5.466350065456806e-01, -3.046999915257943e-01,  1.733330367235056e+00, -2.826831289772703e-01, -6.158628568185666e-16, 8.034512040811716e-15, -1.615672542290688e-14,  1.000000000000054e+00, -6.356438060429860e-01, -3.540965754248395e-01, -2.863162722125560e-01, 1.649401663279181e+00 )
               , tolerance = 0.001)

  expect_equal(c(res$lag_one_cor),
               c( 8.000164405091874e-03, -4.216100723149672e-03, -3.321358643037989e-03, -3.940313404416484e-03, 7.141283700524530e-01,  3.917958093771079e-01, 3.175194270770578e-01, 3.648956660910061e-01, -4.440167350480959e-03, 7.668706553450871e-03,  3.698241340955717e-04, 4.164039424844714e-04, 3.917958321631186e-01, 2.333515322115018e-01, 1.818404244688459e-01,  2.089342108338156e-01, -3.535446744851242e-03, 3.502749913633407e-04, 6.940942917699210e-03, 4.230138498995575e-05,  3.175191140524436e-01, 1.818399950607573e-01, 1.555492614583138e-01, 1.689539263117200e-01, -4.160533133302824e-03,  4.074640929187091e-04, 5.460306276535332e-05, 7.195552731347941e-03, 3.648949485164252e-01, 2.089336838657593e-01,  1.689538998189405e-01, 2.030753772854728e-01, 9.020442276190668e-03, -4.972504300974505e-03, -3.862768892487353e-03, -4.571967314027333e-03, 1.121773750317574e+00, 6.198065721555482e-01, 5.023285477966296e-01, 5.773416914651126e-01, -5.447522491128143e-03, 9.061052829342636e-03, 4.736533569450939e-04, 4.745297438099920e-04, 6.195494656671375e-01,  3.642592470890071e-01, 2.865545090247578e-01, 3.292052372713879e-01, -4.349434994971993e-03, 4.141709962113745e-04,  8.233851711290548e-03, 4.745132761905349e-05, 5.020422748522275e-01, 2.865094328607029e-01, 2.419793949602358e-01,  2.663510507873775e-01, -5.084577140797209e-03, 4.300597286399065e-04, 6.950304356485450e-05, 8.531184193129740e-03,  5.770322142731693e-01, 3.291631822868405e-01, 2.663603057476436e-01, 3.167865401587933e-01, 4.963203953270157e-03, -3.021198582365927e-03, -2.391362915286234e-03, -2.865965621319473e-03, 6.786832961970503e-03, -3.541534868225492e-03, -2.809799014599450e-03, -3.337722901274327e-03, -3.120605672206202e-03, 4.684985287046018e-03, 4.352194062858729e-05,  1.532665906525788e-04, -3.541616080588131e-03, 6.230235266867258e-03, 2.491708314237896e-04, 3.418976755866252e-04, -2.385841523608676e-03, 9.076942035439634e-05, 4.320000671508856e-03, -4.526976355039597e-05, -2.809607472031628e-03,  2.490109568818151e-04, 5.634403056072997e-03, 2.388069942588472e-05, -2.822038059168752e-03, 2.278909364982629e-04, -2.748217516018924e-05, 4.480943215390018e-03, -3.337818781007208e-03, 3.419128400516838e-04, 2.403481872614258e-05,  5.844665172667261e-03, 5.641671964476822e-03, -3.583998960133682e-03, -2.815694500871838e-03, -3.379557472445304e-03,  8.000164405091888e-03, -4.216100723149679e-03, -3.321358643037994e-03, -3.940313404416491e-03, -3.878143561047180e-03,  5.622314115959129e-03, 8.038844347773905e-05, 1.714382848059296e-04, -4.440167350480966e-03, 7.668706553450873e-03,  3.698241340955718e-04, 4.164039424844740e-04, -2.973225913443059e-03, 1.237555381117087e-04, 5.186469503544270e-03, -5.798018442819728e-05, -3.535446744851244e-03, 3.502749913633444e-04, 6.940942917699221e-03, 4.230138498995172e-05, -3.495153073552497e-03, 2.559249779910560e-04, -2.724431884331308e-05, 5.377290912043696e-03, -4.160533133302828e-03,  4.074640929187114e-04, 5.460306276534941e-05, 7.195552731347941e-03, 2.938078603334171e-03, -2.016725483374104e-03, -1.545084897912057e-03, -1.856645878787313e-03, 4.270371363917919e-03, -2.371104353802083e-03, -1.805264359360552e-03, -2.156296643671595e-03, -1.781903566526762e-03, 2.910047284499567e-03, 8.828730432858646e-05, 2.416037052916328e-04, -2.371161160734402e-03, 3.796852548518784e-03, 9.782673698345324e-05, 2.456032253653138e-04, -1.446254162823422e-03,  3.547052154068477e-05, 2.663003868880332e-03, 2.995254685654411e-05, -1.805014303059599e-03, 9.764179078989024e-05,  3.527393707760800e-03, 5.697067468814645e-05, -1.675868000550246e-03, 2.180120459070166e-04, 6.135465458376018e-05,  2.806495429253038e-03, -2.156460538655445e-03, 2.456752584430630e-04, 5.718845099559502e-05, 3.687510632473356e-03,  3.457479794101784e-03, -2.322147635824419e-03, -1.828138386924021e-03, -2.227801956352040e-03, 4.963203953270143e-03, -3.021198582365909e-03, -2.391362915286230e-03, -2.865965621319466e-03, -2.115390842807640e-03, 3.469784675073734e-03,  1.046001130344424e-04, 2.712571320286455e-04, -3.120605672206189e-03, 4.684985287045995e-03, 4.352194062858311e-05,  1.532665906525749e-04, -1.706854206328299e-03, 7.634238410286042e-05, 3.122908636455281e-03, 1.946438499526191e-05, -2.385841523608673e-03, 9.076942035439165e-05, 4.320000671508849e-03, -4.526976355039190e-05, -1.983579696652520e-03,  2.957206351078133e-04, 6.827056233886392e-05, 3.287405957250829e-03, -2.822038059168747e-03, 2.278909364982583e-04, -2.748217516018844e-05, 4.480943215390011e-03, 1.807755241310744e-03, -1.198642374584094e-03, -9.944303183547331e-04, -1.136643839464309e-03, 2.470643269049282e-03, -1.418990332412729e-03, -1.162121268264700e-03, -1.340589253275046e-03, -1.203379090683116e-03, 1.940921770522860e-03, 5.837096313794654e-05, 1.798319418675893e-04, -1.419037184882332e-03,  2.514904080104603e-03, 1.282807260975903e-04, 2.936071661061626e-04, -9.989140172320873e-04, 5.669838184104228e-05,  1.765853978663220e-03, 4.505308575302857e-05, -1.161854458340262e-03, 1.280691687964182e-04, 2.248577986146041e-03,  1.066109730646961e-04, -1.133196599712721e-03, 1.821035699985085e-04, 4.977484128772151e-05, 1.867737394712188e-03, -1.340801056515066e-03, 2.937260075834325e-04, 1.068875074762149e-04, 2.401495464105118e-03, 2.062822227330947e-03, -1.404971156092712e-03, -1.076355716251157e-03, -1.317298601895585e-03, 2.938078603334168e-03, -2.016725483374102e-03, -1.545084897912054e-03, -1.856645878787314e-03, -1.246315125056437e-03, 1.993332690051546e-03, 5.422438230002915e-05,  2.094433149950950e-04, -1.781903566526756e-03, 2.910047284499563e-03, 8.828730432858215e-05, 2.416037052916317e-04, -1.011524437665349e-03, 1.609599250205697e-05, 1.833610455926718e-03, 4.277628085071102e-05, -1.446254162823420e-03,  3.547052154068351e-05, 2.663003868880328e-03, 2.995254685654374e-05, -1.185662332052825e-03, 1.957730952020490e-04,  6.987726419691879e-05, 1.930870181678046e-03, -1.675868000550246e-03, 2.180120459070160e-04, 6.135465458376003e-05,  2.806495429253035e-03, 1.519177886480472e-03, -1.024467388937583e-03, -8.998742826344158e-04, -9.396867562969286e-04,  1.909030782634947e-03, -9.593718378206737e-04, -8.237072026369128e-04, -8.932554307494171e-04, -9.977538790300344e-04,  1.752244177819801e-03, 5.337546724351111e-05, 5.453448469104589e-05, -9.594112584268681e-04, 1.906731253489666e-03,  1.125668112003877e-04, 1.855638988956538e-04, -8.860622625131917e-04, 4.765417798734648e-05, 1.636032246138579e-03, -1.153397295456507e-05, -8.234206819633113e-04, 1.123462433272691e-04, 1.738298583780618e-03, 7.598917796421416e-05, -9.147013446606505e-04, 5.248235291137699e-05, -6.546408640713791e-06, 1.700588748538312e-03, -8.935004664923395e-04,  1.857107331215690e-04, 7.629458154723017e-05, 1.837176695716691e-03, 1.313367854539266e-03, -8.832473019171824e-04, -7.497094106677601e-04, -8.441759447718439e-04, 1.807755241310745e-03, -1.198642374584094e-03, -9.944303183547329e-04, -1.136643839464307e-03, -8.639938753709324e-04, 1.436506567368791e-03, 4.495817858801199e-05, 1.310160468294264e-04, -1.203379090683117e-03, 1.940921770522861e-03, 5.837096313794684e-05, 1.798319418675881e-04, -7.409811589755100e-04,  3.886994450098651e-05, 1.326318451803221e-03,
                  3.336856753031150e-05, -9.989140172320867e-04, 5.669838184104262e-05,  1.765853978663219e-03, 4.505308575302669e-05, -8.192939851156249e-04, 1.304066248796779e-04, 4.120985571195453e-05,  1.389597202121748e-03, -1.133196599712718e-03, 1.821035699985078e-04, 4.977484128772122e-05, 1.867737394712185e-03,  1.922055966334036e-03, -1.301419846590333e-03, -1.207191233827599e-03, -1.137228552150199e-03, 1.998024074913765e-03, -9.773358783528065e-04, -9.065362515812594e-04, -8.662760372940446e-04, -1.303121486694967e-03, 2.421311339430532e-03,  7.930542442977523e-05, -9.031207138041549e-05, -9.773701014128039e-04, 2.173669548273969e-03, 1.426847236001439e-04,  7.322473239919046e-05, -1.211449866133358e-03, 7.637797089870074e-05, 2.281185932945250e-03, -9.977320715526368e-05, -9.062470230238252e-04, 1.424596070730101e-04, 2.010807813288396e-03, 2.071253495492897e-05, -1.106652452022775e-03, -7.427043633160150e-05, -8.273062513030260e-05, 2.367372564756567e-03, -8.665324053916885e-04, 7.338627456113275e-05,  2.103344704876991e-05, 2.099761461676326e-03, 1.392366086848711e-03, -9.410648676690741e-04, -8.557163132037488e-04, -8.478071951632420e-04, 1.519177886480468e-03, -1.024467388937583e-03, -8.998742826344207e-04, -9.396867562969295e-04, -9.171795012659215e-04, 1.664321520531222e-03, 4.850298913439484e-05, -1.408718727803289e-05, -9.977538790300322e-04,  1.752244177819798e-03, 5.337546724351337e-05, 5.453448469105200e-05, -8.455547528745627e-04, 4.111582115098925e-05,  1.580405291900222e-03, -4.488823678724392e-05, -8.860622625131931e-04, 4.765417798734981e-05, 1.636032246138586e-03, -1.153397295456608e-05, -8.034141118337965e-04, -6.084732704695844e-06, -2.886310453952961e-05, 1.633069679109760e-03, -9.147013446606458e-04, 5.248235291138089e-05, -6.546408640713993e-06, 1.700588748538311e-03, 3.087857762254024e-03, -2.046416868232676e-03, -1.921840940443500e-03, -1.684227005948901e-03, 3.245758635859048e-03, -1.241306102561447e-03, -1.214893844673902e-03, -9.926383613155397e-04, -2.139791319042511e-03, 3.904869472799022e-03, 1.055427159893194e-04, -2.612288588738631e-04, -1.241345112602434e-03, 3.414916512296789e-03, 3.038809350855955e-04, 7.801146432162516e-05, -2.006436174951670e-03, 9.920181756458202e-05, 3.670031703076513e-03, -2.327166144305791e-04, -1.214614736120115e-03,  3.036587484145501e-04, 3.138572146758901e-03, 4.351730656057155e-05, -1.702551349420058e-03, -2.246158868296307e-04, -1.958305311047425e-04, 3.875838153269675e-03, -9.928978684709663e-04, 7.817439381448306e-05, 4.383721975971887e-05,  3.329104123627505e-03, 2.188082187105322e-03, -1.432480282081314e-03, -1.351457170411297e-03, -1.228392203497148e-03,  1.922055966334052e-03, -1.301419846590310e-03, -1.207191233827635e-03, -1.137228552150209e-03, -1.501088295977632e-03,  2.740470858081123e-03, 7.430409606662227e-05, -1.868162822810613e-04, -1.303121486694948e-03, 2.421311339430508e-03,  7.930542442976042e-05, -9.031207138040526e-05, -1.416791417395550e-03, 6.660311104977056e-05, 2.596669165206109e-03, -1.678246233922043e-04, -1.211449866133393e-03, 7.637797089868186e-05, 2.281185932945338e-03, -9.977320715528489e-05, -1.206494598467980e-03, -1.429034142444497e-04, -1.224183059706279e-04, 2.708096763510048e-03, -1.106652452022780e-03, -7.427043633160741e-05, -8.273062513031827e-05, 2.367372564756587e-03, 4.791135239667567e-03, -3.504843690685036e-03, -3.258536687399111e-03, -2.772579925528126e-03, 4.608335760068080e-03, -2.429114753644450e-03, -2.313283032083994e-03, -1.872195289163259e-03, -2.984106572441662e-03, 6.433350698757214e-03, 3.085925812499626e-04, -2.245225302739623e-04, -2.428594571038196e-03, 5.199508694420680e-03, 2.376561283990577e-04, -1.847444866910264e-04, -2.890744386130190e-03,  2.768161951324674e-04, 5.926963155398883e-03, -2.441722477643229e-04, -2.312609458412953e-03, 2.374136717813207e-04,  4.824996974572998e-03, -1.753205998061422e-04, -2.933918652737599e-03, -5.908484580916862e-04, -5.100447651356368e-04,  6.067770883211955e-03, -1.872704559516255e-03, -1.850321500930017e-04, -1.753454427259995e-04, 5.184081301679002e-03,  3.504054995243156e-03, -2.527809435529091e-03, -2.366525643972625e-03, -2.074308604224066e-03, 3.087857762254010e-03, -2.046416868232674e-03, -1.921840940443418e-03, -1.684227005948906e-03, -2.251450385071335e-03, 4.837983598109236e-03,  2.664885386244554e-04, -1.875493478630006e-04, -2.139791319042519e-03, 3.904869472799039e-03, 1.055427159893295e-04, -2.612288588738533e-04, -2.193130153603141e-03, 2.358203324839128e-04, 4.477529897838363e-03, -1.913324520149488e-04, -2.006436174951633e-03, 9.920181756458554e-05, 3.670031703076360e-03, -2.327166144305707e-04, -2.216573718916068e-03, -4.171950307885193e-04, -3.461676183397389e-04, 4.524972939159773e-03, -1.702551349420075e-03, -2.246158868296505e-04, -1.958305311047215e-04, 3.875838153269659e-03, 7.983511768251553e-03, -4.128442419869476e-03, -4.028304718164456e-03, -4.074646254890831e-03, 6.497902973246770e-03, -3.477285055507056e-03, -3.394946503242778e-03, -3.432291642196478e-03, -5.454179025523699e-03, 9.668263144392730e-03, 3.754057259366861e-04, -9.257120846045920e-04, -3.480385454619107e-03,  8.595298537859061e-03, 7.765716909398549e-04, -2.398180170632759e-04, -4.925443907823162e-03, 4.738366559293709e-04,  8.914799874320839e-03, -7.691843065811820e-04, -3.396872697496064e-03, 7.765314733706171e-04, 7.721754077928366e-03, -2.794552354466795e-04, -3.149000719578883e-03, 2.897597079478236e-04, 1.251966144239229e-04, 9.723036085582892e-03, -3.431122987446547e-03, -2.372837252800863e-04, -2.773805057854463e-04, 7.631180182032597e-03, 6.036546590945414e-03, -3.981705897272880e-03, -3.718621439553292e-03, -3.115210992298998e-03, 4.791135239667581e-03, -3.504843690685089e-03, -3.258536687399151e-03, -2.772579925528042e-03, -4.401203041607538e-03, 7.181647666831540e-03, -1.385873761152758e-05, -7.165610454902165e-04, -2.984106572441693e-03, 6.433350698757245e-03, 3.085925812499722e-04, -2.245225302739884e-04, -3.985910858208258e-03, 2.483699302263556e-05, 6.792895482394565e-03, -5.844256117856590e-04, -2.890744386130283e-03,  2.768161951325293e-04, 5.926963155399070e-03, -2.441722477643490e-04, -2.582076356404243e-03, -2.002929434921688e-04, -1.995487528692505e-04, 7.693194504724410e-03, -2.933918652737567e-03, -5.908484580917416e-04, -5.100447651356663e-04,  6.067770883211959e-03, 5.814882751941243e-03, -8.157321261684279e-03, -7.573229571949683e-03, -8.767093800866415e-03,  6.233041255253559e-03, -6.168288767578722e-03, -5.829760317612898e-03, -6.739645961125788e-03, -1.226034989094017e-02,  1.187178741941254e-02, -1.051678282574890e-03, -3.550533806570929e-03, -8.591531485171614e-03, 1.108866387249734e-02, -7.615332935811911e-05, -2.096187378014225e-03, -1.043715464417587e-02, -7.935936345372089e-04, 1.147652565558281e-02, -2.837275451066319e-03, -7.553667860315551e-03, 5.836452868082510e-05, 1.035626408130236e-02, -1.732826867172105e-03, -6.561252103094968e-03, -1.557880376014388e-04, -3.260124532666963e-04, 1.285339301197558e-02, -5.656870157792467e-03, -2.137856176616396e-04, -3.330658287094284e-04, 1.085853596327204e-02, 9.437454523611503e-03, -4.797603241638689e-03, -4.676269943998270e-03, -4.733762020819079e-03, 7.983511768251444e-03, -4.128442419869390e-03,
                  -4.028304718164368e-03, -4.074646254890925e-03, -7.387948453237052e-03, 1.076408991240183e-02, -7.448378059270278e-06, -1.590620226606587e-03, -5.454179025523564e-03, 9.668263144392671e-03, 3.754057259366148e-04, -9.257120846046082e-04, -6.420916226460301e-03,  1.898349321735688e-04, 1.012325868388524e-02, -1.241579115035818e-03, -4.925443907823061e-03, 4.738366559294109e-04,  8.914799874320660e-03, -7.691843065810820e-04, -2.876406065095701e-03, 8.114277934321156e-04, 5.233952393982599e-04,  1.181018930371526e-02, -3.149000719579155e-03, 2.897597079480103e-04, 1.251966144239458e-04, 9.723036085582989e-03 )
               , tolerance = 0.001)

  expect_equal(c(res$Q),
               c(1.4901872946380808, 0.8398665613732734, 0.6804245095534588, 0.7821827696419223, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.8398665613732734, 0.4733485194253870, 0.3834861426610171, 0.4408369575160737, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.6804245095534588, 0.3834861426610171, 0.3106853664814359, 0.3571474387988012, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.7821827696419223, 0.4408369575160737, 0.3571474387988012, 0.4105604522462084, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000 )
               , tolerance = 0.001)

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0,  0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10 )
               , tolerance = 0.001)
})

#########
# With estimating Q_0 and second order

# Re-sample because the other sample had a high intercept which screwed things up
warning("Figure out if what happens with 2 order and est_Q_0 is expected. What is up with the predicted in the latest period?")

diag(Q_0) <- 1.0e4
diag(Q[1:n_parem, 1:n_parem]) <- 1.0e2

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2],
                    a_0 = a_0,
                    Q_0 = Q_0,
                    Q = Q,
                    F_= F_, # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 2,
                    est_Q_0 = T)

# get_expect_equal(res, eps = expect_equal_eps)

# par(mfcol = c(2, 2))
# plot(res$a_t_d_s[, 1], type = "l", ylim = range(res$a_t_d_s[, 1], res_new$a_t_d_s[, 1]))
# for(i in 1:3){
#   plot(res$a_t_d_s[, i + 1], type = "l", ylim = range(sims$betas[, i ], res$a_t_d_s[, i + 1], res_new$a_t_d_s[, i + 1]))
#   lines(x = seq_len(nrow(sims$betas)), sims$betas[, i], col = "red")
# }

design_mat <- get_design_matrix(survival::Surv(tstart, tstop, event) ~ x1 + x2 + x3, sims$res)

arg_list <- list(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2],
                 a_0 = rep(0, ncol(design_mat$X)),
                 Q_0 = diag(10, ncol(design_mat$X)), # something large
                 Q = diag(1, ncol(design_mat$X)), # something large
                 F_= diag(1, ncol(design_mat$X)), # first order random walk
                 eps = 10^-4, n_max = 10^4,
                 order_ = 1,
                 est_Q_0 = F)

test_that("Fit throw error when you use wrong is_for_discrete_model for risk set",{
  risk_obj <- get_risk_obj(design_mat$Y, by = 1, max_T = 10, id = sims$res$id, is_for_discrete_model = T)
  arg_list$risk_obj <- risk_obj
  arg_list$model <- "poisson"
  expect_error(do.call(ddhazard_fit_cpp_prelim, arg_list))

  risk_obj <- get_risk_obj(design_mat$Y, by = 1, max_T = 10, id = sims$res$id, is_for_discrete_model = F)
  arg_list$risk_obj <- risk_obj
  arg_list$model <- "logit"
  expect_error(do.call(ddhazard_fit_cpp_prelim, arg_list))
})
