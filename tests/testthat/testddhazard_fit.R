# library(survival); library(benssurvutils); library(dynamichazard); source("R/test_utils.R")

# Simulate series to work with
set.seed(2972)
sims <- test_sim_func_logit(n_series = 10^4, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = .1, x_mean = -.4, re_draw = T)
sims$res <- as.data.frame(sims$res)

design_mat <- benssurvutils::get_design_matrix(survival::Surv(tstart, tstop, event) ~ x1 + x2 + x3, sims$res)
rist_sets <- benssurvutils::get_risk_sets(design_mat$Y, by = 1, max_T = 10, id = sims$res$id)

design_mat$Y[, 2] <- rist_sets$stop_new
design_mat$Y[, 3] <- rist_sets$new_events_flags






#########
# Without estimating Q_0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_sets = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = F)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 1 and no Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 0.590989929209872145, 0.984518276587618701, 0.697023853102439972, 0.410462698211114363, 0.984518276587619701,  2.395259571910619556, 1.112478365381281531, 0.501257802420081444, 0.697023853102440083, 1.112478365381280865,  1.281883890380488111, 0.292435639609743503, 0.410462698211114085, 0.501257802420080556, 0.292435639609744558,  0.796476105996861250, 0.314017419863397595, 0.322121880177917319, 0.285319334930023150, 0.191193382899863096,  0.322121880177918873, 0.742250262422693652, 0.124361481449782790, -0.033157422701280512, 0.285319334930023150,  0.124361481449781652, 0.638822308531641347, -0.030380684979929296, 0.191193382899862874, -0.033157422701281435, -0.030380684979928324, 0.553040116588403130, 0.283728546025673101, 0.279876694188687103, 0.253585559543698547,  0.191742766431003742, 0.279876694188685660, 0.657314681716500537, 0.087613625865292061, -0.014846628630316935,  0.253585559543698769, 0.087613625865293893, 0.585641774632491119, -0.017026725738322174, 0.191742766431003853, -0.014846628630316334, -0.017026725738321730, 0.524271530658120266, 0.252578117171293692, 0.231440718564015657,  0.218346849009751154, 0.185676765334214011, 0.231440718564015657, 0.562935597496653339, 0.037733081971774267, -0.013571476117295077, 0.218346849009751542, 0.037733081971774350, 0.530684061341656910, -0.015620291728526071,  0.185676765334214233, -0.013571476117295301, -0.015620291728526036, 0.498459378384268792, 0.255319414047003979,  0.237224652926965235, 0.222047510779167623, 0.186588971371529355, 0.237224652926965818, 0.573526327889214871,  0.045814494992510280, -0.010296933949039000, 0.222047510779167345, 0.045814494992509662, 0.534031140679193550, -0.013595280338397575, 0.186588971371529133, -0.010296933949039584, -0.013595280338397400, 0.498625623261576667,  0.272517198540888406, 0.264470212235610236, 0.242064244725319344, 0.190014260911479632, 0.264470212235610291,  0.626921020707393528, 0.075791635796177897, -0.009647497509855028, 0.242064244725319122, 0.075791635796177662,  0.564137362856990343, -0.013226431706672797, 0.190014260911479715, -0.009647497509854958, -0.013226431706672474,  0.511329280548604381, 0.293933580856512222, 0.296917516337894372, 0.266064846852502257, 0.194226222700019380,  0.296917516337894094, 0.692288841766142804, 0.108861030932587657, -0.011328756321956387, 0.266064846852502312,  0.108861030932588282, 0.602154691466796677, -0.014794803739484386, 0.194226222700019491, -0.011328756321956079, -0.014794803739484184, 0.529619842315859568, 0.313934890760961149, 0.323329599750915131, 0.286703111516319165,  0.196493758043673472, 0.323329599750915020, 0.744387854316318043, 0.130319461996324604, -0.020408880302714018,  0.286703111516319331, 0.130319461996324826, 0.636967838582420010, -0.021292768490593597, 0.196493758043673500, -0.020408880302714150, -0.021292768490593549, 0.549768615051527743, 0.335494720082257836, 0.348977147981149316,  0.308034685637247618, 0.196559502029717614, 0.348977147981149316, 0.793915680872271712, 0.147620351543982897, -0.037335952317478834, 0.308034685637247729, 0.147620351543983314, 0.675042771944227793, -0.032864214570555460,  0.196559502029717559, -0.037335952317479028, -0.032864214570555418, 0.573624006026876687, 0.380764304051999680,  0.416691595947043247, 0.358054553740919046, 0.202969856019359379, 0.416691595947043414, 0.928052613695493522,  0.214376047994625507, -0.045909069584618503, 0.358054553740919213, 0.214376047994625535, 0.754280234493245327, -0.039407931485515989, 0.202969856019359435, -0.045909069584618670, -0.039407931485516037, 0.612489076924820131,  0.443712359812153345, 0.516835921171008184, 0.430031162020929780, 0.213557797927490467, 0.516835921171008184,  1.129059305949814629, 0.321045561326899875, -0.047642363172880696, 0.430031162020929780, 0.321045561326899875,  0.865120165053681167, -0.042131334836178647, 0.213557797927490467, -0.047642363172880696, -0.042131334836178647,  0.661794720499680134 ))

  expect_equal(c(res$a_t_d_s),
               c( 0.2191135193434557, 0.2191637670963300, -1.0807701905278368, -0.5120298733328240, 0.2568366132596853, 0.7625280118396124,  0.6551965017411194, 0.1319056466018235, 0.7169449734695408, 1.5603083664863111, 2.2329899682901893, 3.3608783900246522,  3.3609942522557077, 0.3841562219832703, 1.7258093321706305, 3.4887533409352751, 4.6166368737042216, 4.3550321672429710,  3.1601751542597025, 4.5628820990890322, 6.5514623519615069, 8.1241497566460019, 3.1775634127354722, 3.1776331715500730,  1.3247702158328254, 2.1225444825998543, 3.2032923524181176, 3.9030312770586635, 3.7297370654280786, 2.9783915177676281,  3.8277480757918023, 5.0400974847580180, 6.0014926249800906, 3.1384490904389222, 3.1384843052587055, 2.1178576312323227,  2.5742655169905624, 3.1043024110884607, 3.4135970469926460, 3.3161331486068555, 2.9503928255441010, 3.5093001584596766,  4.2347380560494994, 4.7946267029670047 ))

  expect_equal(c(res$B_s),
               c( 0.96159225344638388, -0.08503095715122021, -0.05328345837583150, -0.02721693196023317, -0.08503095715122021, 0.80407561225777191, -0.11837956921934435, -0.06116353900353915, -0.05328345837583150, -0.11837956921934435, 0.92252592144627787, -0.03729092153396421, -0.02721693196023317, -0.06116353900353915, -0.03729092153396421, 0.97291537313637833, 2.11636777919183272, 2.66011565872910527,  1.62549595357014032, 0.98177862883731404, -0.46951461354733870, -0.10799914944202602, -0.67181255027645814, -0.38552591864364949, -0.46295072718555852, -1.08216739475478385, 0.32381092318517157, -0.38634346327991143, -0.44643836011841187, -1.05421956586179899, -0.64408914624342495, 0.59478774948725155, 2.06799268161217986, 2.58813954873227647, 1.57589469796396342, 0.99590092459361923, -0.46210277265939131, -0.10192194659225522, -0.66229609407913037, -0.38625478637735378, -0.45162250390971148, -1.06052418918493019,  0.33033913941876913, -0.38774155611993155, -0.42665390117274926, -1.01864763044260220, -0.62001034173320013, 0.58202691564396458,  1.94287189668620797, 2.38393708981098351, 1.44018714330439601, 1.00777834542991673, -0.44284474139111119, -0.08135475481161326, -0.63670956620233576, -0.38413139645701200, -0.42670100537888478, -1.01147176733284971, 0.34377632312884759, -0.38883419854878509, -0.38043068939081004, -0.93267981331929084, -0.56240139531391475, 0.55570006700428309, 1.90158691870057384, 2.32172139038330405,  1.39972326657932467, 1.00518261371298845, -0.43446466658789928, -0.07358229593202538, -0.62514672938638416, -0.38047511458802541, -0.41746416859590257, -0.99195083885408619, 0.34573528811907239, -0.38642037186168121, -0.36585879968860191, -0.90372352098875675, -0.54361758183319353, 0.54684678658317476, 1.90400721016727603, 2.32964883566019676, 1.40653447130902221, 0.99563070889060379, -0.43256010948662915, -0.07243451659076261, -0.62196310196492299, -0.37695172806998656, -0.41641391978190651, -0.98784442546215323,  0.34336693673989988, -0.38246646157447783, -0.36864788267234383, -0.90691450806169338, -0.54636390628820419, 0.54713689183082348,  1.91533622670062598, 2.34973000583414970, 1.42151754695290844, 0.98481145103555656, -0.43195131151993083, -0.07148603647695113, -0.62049455992470948, -0.37353592446681200, -0.41774975174032686, -0.98861509072330234, 0.34025748928117117, -0.37901005590850056, -0.37491695331121100, -0.91669431854698069, -0.55352589869757352, 0.55002806455977971, 1.92509538317144901, 2.37066763977297157,  1.43626863184858067, 0.98139182577758532, -0.43305494461020622, -0.07518230884891547, -0.62171363484044484, -0.37262286847159826, -0.42066561390526602, -0.99396820001993202, 0.33430572339450038, -0.37861560877721723, -0.38022172703987445, -0.92611778072250150, -0.56005193244734530, 0.54960910801094920, 1.91830943567621492, 2.36360567704226154, 1.43243506761295891, 0.97966233492863442, -0.43291547937022756, -0.07862972347333207, -0.62140947888457365, -0.37233072446932997, -0.42049948693413891, -0.99341943941591893,  0.33039413988996069, -0.37877865792982113, -0.37942552843017419, -0.92421488609875324, -0.55906617678341242, 0.54591417661767416,  1.92380719363600239, 2.37114262322338165, 1.43874360369495036, 0.96978482368406871, -0.43107205404670779, -0.07406052956679751, -0.61852408193949859, -0.36895841910592847, -0.41993496591502255, -0.99084023832268420, 0.33108109647846962, -0.37510365487462261, -0.38195185033866974, -0.92692080222017947, -0.56139951677459810, 0.55018118753369361 ))

  expect_equal(c(res$lag_one_cor),
               c( 0.254159888396791045, 0.240911687882378156, 0.230574493576575335, 0.173236216034766799, 0.186839102361362364,  0.556741169130280600, 0.001969738714214131, -0.073147869649344888, 0.201220121391066376, 0.010932127002166558,  0.560538403050256928, -0.054912628241785721, 0.147126455601323647, -0.091062742698034493, -0.068752013291905334,  0.536018483152744807, 0.266068809528237638, 0.249770481695852031, 0.232022527877442042, 0.186596534529890112,  0.247963302887439063, 0.594353947325020560, 0.049292194599086084, -0.022610179315355916, 0.231789267204603411,  0.051278982678317500, 0.553946300434236427, -0.021539799958385730, 0.186734028459117463, -0.021314433920433362, -0.021198599991606892, 0.512381158488009358, 0.237550233133347777, 0.207232826055369634, 0.201098717840444530,  0.184634445497905170, 0.209417213595511048, 0.515433090824539142, 0.014374575386088887, -0.009248156536637575,  0.201761227226050888, 0.012775323209356988, 0.504091627403567166, -0.012614597610559108, 0.185554423140336988, -0.009474191654987994, -0.011982448674325356, 0.486331120677079842, 0.225267157050337063, 0.191282171624467284,  0.188421597475207453, 0.183187041944594370, 0.190743512275419913, 0.482133229160517429, -0.001857308505784437, -0.005652737049556655, 0.188061310654923930, -0.001980855560761701, 0.481852709605439078, -0.009822287748644243,  0.183527777441409218, -0.004775850342775077, -0.009028581700662210, 0.474368302652280971, 0.232740639193069032,  0.202427393369404102, 0.196709284747857260, 0.183967374193622801, 0.201412496156934129, 0.501432954507130768,  0.008785319368585497, -0.007110268722725549, 0.196511033504405519, 0.009715876010625773, 0.493674376622918354, -0.010541947694509682, 0.183675348128852639, -0.007250123107269161, -0.010745062327931286, 0.479399400758683092,  0.248822792333643128, 0.224721628170848842, 0.214208925004557182, 0.185626025225925750, 0.224277692653195637,  0.544304389539053801, 0.030534831452788409, -0.012405467798213859, 0.213995647960684654, 0.030615508663275705,  0.521365192836060198, -0.014213266452000800, 0.185233179872201920, -0.013173351780228021, -0.014531778745941023,  0.493081056676974216, 0.268189229664635986, 0.250956297943806583, 0.234731056724799547, 0.187944730284573064,  0.250984946906500472, 0.596396842879331257, 0.054161824455486028, -0.019753184483996322, 0.234428194993444583,  0.053369102172226075, 0.555210162888845060, -0.019573266540782161, 0.187805173460444341, -0.020254756540402371, -0.019459329799064236, 0.511591093618201320, 0.290417263754017441, 0.280102319669226385, 0.257596834365326155,  0.190284843393468739, 0.280895636666746773, 0.655467972010811972, 0.078614506803131035, -0.029793153378964279,  0.257790920917301936, 0.077897127821243112, 0.594719300242947391, -0.026721410416753414, 0.190619062523072896, -0.029759366637025754, -0.026348198002676602, 0.534526001113257099, 0.322457814204665905, 0.324849132927615303,  0.291830642964232390, 0.193410760127325887, 0.323926209289368550, 0.741386613466717193, 0.116548195736271246, -0.043572395859771622, 0.291309579036211352, 0.116677761362765517, 0.650916001529291299, -0.036172605748829953,  0.193054061861176157, -0.043588923845570518, -0.036264832502527017, 0.565228633722822726, 0.368669590129941216,  0.390965580839031213, 0.341701207694488196, 0.196300021882268250, 0.389784802344115278, 0.867928788789142258,  0.177744953463247868, -0.061781455545273478, 0.341196799987448562, 0.178282521206187927, 0.730207616517919433, -0.048757260095028870, 0.195803770501925045, -0.061993599294467683, -0.049104371777993316, 0.604593785318598531 ))

  expect_equal(c(res$Q),
               c(0.5662151883161876, 1.2641553003991997, 0.7885508764949164, 0.4058157116373461, 1.2641553003991997, 2.8989541397833865, 1.7646616826903763, 0.9151796370232327, 0.7885508764949164, 1.7646616826903763, 1.1334709764752691, 0.5604781223374399, 0.4058157116373461, 0.9151796370232327, 0.5604781223374399, 0.3687654984117195 ))

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10 ))
})








#########
# With estimating Q_0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_sets = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = T)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 1 and Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c(0.0020913991459398959, 0.0039041669051419663, 0.0024529247355145915, 0.0016193743000390425, 0.0039041669051419620, 0.0106709854416605528, 0.0045409852180656523, 0.0022714305194235628, 0.0024529247355145746, 0.0045409852180656419, 0.0045208596889710472, 0.0011772800644625724, 0.0016193743000390433, 0.0022714305194235659, 0.0011772800644625802, 0.0027010698429842227, 0.0077455290272512474, 0.0147074421704285821, 0.0090713345349717738, 0.0053980174587721008, 0.0147074421704286341, 0.0393422854557464730, 0.0167859782765449154, 0.0076790972406085012, 0.0090713345349717651, 0.0167859782765449363, 0.0160465273625828783, 0.0039702950637541283, 0.0053980174587720722, 0.0076790972406084648, 0.0039702950637541187, 0.0092044313838945541, 0.0107150271144243695, 0.0182368931596497731, 0.0119098797114692082, 0.0072025760830520405, 0.0182368931596497107, 0.0481154537934523063, 0.0187814764797481874, 0.0077493163615806326, 0.0119098797114692220, 0.0187814764797482568, 0.0221860309935336744, 0.0040029316810348999, 0.0072025760830520327, 0.0077493163615806058, 0.0040029316810349484, 0.0141748712171174147, 0.0107161434071351563, 0.0136933463313662282, 0.0105101810945473374, 0.0068278330476330392, 0.0136933463313659767, 0.0347892774862379947, 0.0092422551827851512, 0.0019015181727511112, 0.0105101810945475299, 0.0092422551827856837, 0.0222234182914045966, 0.0009383436132616523, 0.0068278330476330123, 0.0019015181727512092, 0.0009383436132615408, 0.0174833304494358653, 0.0143661986378830556, 0.0191395910897999011, 0.0143417950419374683, 0.0091588909900289957, 0.0191395910897995923, 0.0488471157196652406, 0.0140276314940283031, 0.0034587995622960624, 0.0143417950419376834, 0.0140276314940287732, 0.0297725029673371333, 0.0017488566936014146, 0.0091588909900289228, 0.0034587995622960286, 0.0017488566936012377, 0.0228131427709564356, 0.0191079399721275807, 0.0275432728517291080, 0.0197302561606566701, 0.0122858441112139068, 0.0275432728517290247, 0.0709665447599887589, 0.0230342928419454106, 0.0071672599759756237, 0.0197302561606568574, 0.0230342928419456222, 0.0395581200638281325, 0.0036889552154464821, 0.0122858441112138322, 0.0071672599759755387, 0.0036889552154463498, 0.0287429380404091300, 0.0237558332220541672, 0.0357066321874647818, 0.0249726075094868945, 0.0153433237053061267, 0.0357066321874648027, 0.0925042432854234903, 0.0316666958899815276, 0.0106957362352195773, 0.0249726075094870645, 0.0316666958899817774, 0.0491275912107800306, 0.0055175905663378995, 0.0153433237053061007, 0.0106957362352195426, 0.0055175905663378752, 0.0346325684782706616, 0.0259670468151665702, 0.0371509966005096129, 0.0267013161974046266, 0.0165826873108411779, 0.0371509966005094186, 0.0955436771900622372, 0.0306114979156413697, 0.0092090155139870102, 0.0267013161974047133, 0.0306114979156416993, 0.0536402329148645135, 0.0047218110922978103, 0.0165826873108411502, 0.0092090155139870344, 0.0047218110922977738, 0.0391764237308871652, 0.0266873946258243469, 0.0345105593493172935, 0.0263072522570883503, 0.0167239866510717067, 0.0345105593493173490, 0.0874618720789730464, 0.0237447743545872447, 0.0047105240902268024, 0.0263072522570883365, 0.0237447743545871788, 0.0551553098695400368, 0.0023562289010832585, 0.0167239866510716477, 0.0047105240902266124, 0.0023562289010831674, 0.0429397618725754701, 0.0324492022657204976, 0.0455870857144938663, 0.0330987738409499049, 0.0205714919409599947, 0.0455870857144939010, 0.1168599829673090534, 0.0364360398508108349, 0.0102818010526592642, 0.0330987738409498355, 0.0364360398508108002, 0.0669685114325384856, 0.0052566381472190669, 0.0205714919409599149, 0.0102818010526591671, 0.0052566381472190331, 0.0494939825837196409, 0.0428328843367132214, 0.0693584777669560143, 0.0465274411562092011, 0.0278633962251296045, 0.0693584777669560143, 0.1812454495665768439, 0.0673660954197931039, 0.0253079567417809417, 0.0465274411562092011, 0.0673660954197931039, 0.0883539084400366687, 0.0130921328817790797, 0.0278633962251296045, 0.0253079567417809417, 0.0130921328817790797, 0.0586634124539681459 ))

  expect_equal(c(res$a_t_d_s),
               c( 0.2976975940777115, 0.3355356479130722, -0.7162323180447083, -0.2422761855169988, 0.3515519963408090, 0.7073944628619520,  0.5991179396479441, 0.1919622122767809, 0.7364703056472663, 1.4747323415709452, 2.0473708767046821, 3.3727134236956164,  3.4772364240484972, 0.5748528111147526, 1.8888688138939074, 3.5299191076769745, 4.5105913997780496, 4.2102465799984410,  3.0858276195960013, 4.5932509501623775, 6.6356376189145791, 8.2188032421146549, 3.2120186776709319, 3.2662931263108845,  1.7513713849180075, 2.4315641663011682, 3.2858739344023720, 3.7971835705336487, 3.6392753511766895, 3.0518597686005320,  3.8364161983746010, 4.8998006493547672, 5.7242349343692158, 3.1901148024371970, 3.2183032343060187, 2.4295327786137948,  2.7842737573280605, 3.2253635734349682, 3.4889957521225963, 3.4084900322469873, 3.1061088522292133, 3.5180775864403451,  4.0733237550795121, 4.5034500952032133 ))

  expect_equal(c(res$B_s),
               c( 0.49207752710866237, 0.58462573637626025, 0.29350152929810530, 0.25729006074164973, -0.10841476115810419, -0.01186302739177107, -0.15415709070228170, -0.09346269239530922, -0.09363017368811560, -0.25797456215776038, 0.15662670290393238, -0.09722511291559838, -0.07227747462740919, -0.22769433692279106, -0.11726037988657123, 0.19169007971721586, 1.15271092019995414, 1.57909885383297444,  0.81901843228555049, 0.46136439848230593, -0.23267263245948649, -0.05933984772284372, -0.33436372488504507, -0.17847815396425143, -0.22999557736933091, -0.63524473128306069, 0.25377272047870858, -0.18146197884872972, -0.22186187325102913, -0.62254851829704994, -0.32394265624077145, 0.40346251065799987, 1.40716736790743124, 1.94236875264661957, 1.01014781702051071, 0.54342550989717076, -0.28290829262963274, -0.07632302133093166, -0.40703957355896025, -0.21408959661059196, -0.28097071628027565, -0.77630836422987570,  0.30159888707153587, -0.21516016936979926, -0.27698995878456878, -0.77026152006938697, -0.40112791382029650, 0.49094510966656035,  1.54192386166592899, 2.13291158105948675, 1.11010174677117845, 0.58941487015325600, -0.31162818815250126, -0.09021681764264836, -0.44853518943431692, -0.23490912352741530, -0.30976451915691178, -0.85603284460425488, 0.32535458224915342, -0.23516758962768530, -0.30602472647461310, -0.84892187969078403, -0.44216655631664720, 0.53699148423018761, 1.62642207058049859, 2.25102861375150232,  1.17198778140858373, 0.61842682779593638, -0.32793641953274955, -0.09372114256651463, -0.47209382145045176, -0.24675733565584212, -0.32606263698305893, -0.90115148923143717, 0.34334054311969964, -0.24656009005505208, -0.32321704778608817, -0.89559574857246727, -0.46652311564507803, 0.56693468141555314, 1.68429136028218474, 2.33066210432102894, 1.21371509616498630, 0.63812269815966705, -0.33818249412543017, -0.09312650244816958, -0.48688577568486130, -0.25420354294419834, -0.33633360459457706, -0.92955978605001643,  0.35737881071066524, -0.25373634149345009, -0.33459735028506854, -0.92651136157388558, -0.48265805285987734, 0.58812208758038398,  1.72436823139058815, 2.38256537151463288, 1.24092427566143071, 0.65097363884611781, -0.34472024764900017, -0.09000137346137414, -0.49632123500514119, -0.25895142427727830, -0.34353311548459686, -0.94945026299527202, 0.36814535371934054, -0.25879610643886020, -0.34215089004632260, -0.94702917989627733, -0.49337555367004793, 0.60417808173801835, 1.75947011658414532, 2.43513750151698893,  1.26843944197087977, 0.66450977033590153, -0.35179180114239372, -0.09351681175328530, -0.50652044630195359, -0.26416221275691815, -0.35135701576034317, -0.97107887146977012, 0.37285270156064443, -0.26445923341367927, -0.34979434326255299, -0.96794645266999324, -0.50429186475220600, 0.61477675956260802, 1.78634287557076998, 2.47529599247583221, 1.28946165099301591, 0.67509879850522081, -0.35845453739311461, -0.09961010323871552, -0.51612269304395220, -0.26910812700710041, -0.35800310026650389, -0.98944632903538121,  0.37555950304666902, -0.26936026173263744, -0.35602616392965403, -0.98505448674004470, -0.51323395139323802, 0.62253457593680039,  1.80293060228707946, 2.49290916024315479, 1.29867353544673958, 0.67949714264452465, -0.35971518222897947, -0.09288859351080768, -0.51795576063658988, -0.27001485851333407, -0.35976744856650400, -0.99436085075846925, 0.38321243017075712, -0.27058068225219090, -0.35818739498873065, -0.99095239408146463, -0.51630097080348214, 0.63128417840532858 ))

  expect_equal(c(res$lag_one_cor),
               c( 9.773912417174230e-04, 8.452174746921774e-04, 8.545499951040494e-04, 7.867031169300092e-04, 7.844892610311425e-04,  2.052788248434415e-03, 6.059353988681756e-05, -5.530944051913969e-05, 7.939077593570468e-04, -1.955692549971059e-05,  2.122529349506580e-03, -5.692180582842217e-05, 7.710353629302809e-04, -5.296910542235223e-05, -3.395776816279783e-05,  2.049532936427957e-03, 3.770906143039861e-03, 3.787782228339462e-03, 3.367925898517553e-03, 2.433914202423396e-03,  3.788271166793753e-03, 9.187533986464493e-03, 1.106808963753627e-03, -4.536499487914953e-04, 3.367230128795532e-03,  1.104181545114518e-03, 7.808055695736738e-03, -2.680582833692554e-04, 2.433424103570334e-03, -4.552693800092773e-04, -2.681769826129269e-04, 6.932577728855622e-03, 6.361151776521539e-03, 6.303150520452103e-03, 5.670831718940264e-03,  3.963594540750432e-03, 6.351225983440716e-03, 1.530279898461736e-02, 1.734255023949479e-03, -1.078140735404414e-03,  5.682179513007309e-03, 1.696393091344537e-03, 1.318103528840189e-02, -6.069209784669580e-04, 3.982541602767322e-03, -1.061732813714375e-03, -5.880893988755314e-04, 1.168478481092926e-02, 8.941722032843161e-03, 8.885913321055572e-03,  7.984892150653049e-03, 5.521333593865700e-03, 8.862887889818925e-03, 2.147186024413476e-02, 2.353369347914927e-03, -1.640592040083457e-03, 7.979575533048950e-03, 2.371831891867353e-03, 1.854229970214901e-02, -9.023026692053188e-04,  5.517107632857135e-03, -1.634971919592140e-03, -9.043579654283985e-04, 1.642507195329238e-02, 1.164083939750444e-02,  1.169726939163646e-02, 1.044518240058684e-02, 7.138524400427576e-03, 1.164803314969903e-02, 2.817327478539336e-02,  3.302899516583692e-03, -2.082297752166813e-03, 1.043382983239461e-02, 3.342426091453063e-03, 2.411019535911246e-02, -1.127437088943237e-03, 7.120935459874985e-03, -2.093985715225483e-03, -1.144217996879212e-03, 2.121514091562575e-02,  1.440342416608121e-02, 1.462771740874015e-02, 1.298259385473646e-02, 8.781800028076681e-03, 1.461229104648828e-02,  3.525968967473645e-02, 4.474557812849870e-03, -2.452351874366743e-03, 1.296686412197991e-02, 4.453301164076027e-03,  2.978561753385892e-02, -1.328996339601557e-03, 8.769673485006605e-03, -2.474286746309949e-03, -1.334636982454105e-03,  2.604019430372752e-02, 1.712348227897290e-02, 1.745922213699245e-02, 1.544773004830993e-02, 1.039377835769165e-02,  1.746868537240253e-02, 4.213031468842777e-02, 5.462128355171911e-03, -2.903828711547875e-03, 1.543278320868258e-02,  5.407195286746703e-03, 3.535895136866583e-02, -1.583147647626765e-03, 1.039225901317860e-02, -2.915102990154492e-03, -1.574106676277540e-03, 3.085775483010389e-02, 1.972194792845008e-02, 1.996132063408608e-02, 1.773020663773869e-02,  1.192026762948649e-02, 2.002581760226801e-02, 4.824121807614260e-02, 6.000381469500710e-03, -3.566780410952961e-03,  1.774599968342393e-02, 5.951152451940279e-03, 4.071852189330595e-02, -1.948258744756459e-03, 1.194197130765993e-02, -3.555121880229236e-03, -1.928822177591705e-03, 3.564415123316966e-02, 2.245105055230594e-02, 2.284036923471577e-02,  2.021865960394738e-02, 1.355913431813000e-02, 2.276694530512329e-02, 5.502145547622857e-02, 6.860041763241721e-03, -4.059070632188170e-03, 2.018604344022054e-02, 6.875641328877025e-03, 4.632690825717635e-02, -2.208332728425486e-03,  1.352953283672661e-02, -4.085828917736103e-03, -2.226508755267709e-03, 4.051665930127184e-02, 2.555604438333877e-02,  2.655066280828191e-02, 2.317684303458410e-02, 1.540949533554323e-02, 2.645951310667009e-02, 6.400356139908009e-02,  8.901794420165390e-03, -4.040858228007723e-03, 2.314530550079580e-02, 8.945897344881420e-03, 5.263013435906243e-02, -2.193855441948276e-03, 1.537729737917124e-02, -4.061528340509657e-03, -2.216587878631656e-03, 4.559037964664375e-02 ))

  expect_equal(c(res$Q),
               c(0.3284521133661092, 0.9028465556511629, 0.4714318169537647, 0.2456850096146581, 0.9028465556511629, 2.4939853112360222, 1.2967561771330269, 0.6738975151263655, 0.4714318169537647, 1.2967561771330269, 0.6808940547554896, 0.3511088793016583, 0.2456850096146581, 0.6738975151263655, 0.3511088793016583, 0.1878572384173380 ))

  expect_equal(c(res$Q_0),
               c(0.002091399145939896, 0.003904166905141964, 0.002452924735514583, 0.001619374300039043, 0.003904166905141964, 0.010670985441660553, 0.004540985218065647, 0.002271430519423565, 0.002452924735514583, 0.004540985218065647, 0.004520859688971047, 0.001177280064462576, 0.001619374300039043, 0.002271430519423565, 0.001177280064462576, 0.002701069842984223 ))
})






#########
# Without estimating Q_0 and second order

# Setup the parems we need to parse
n_parem <- ncol(design_mat$X)

Q_0 <- Q <- matrix(0.0, nrow = n_parem * 2, ncol = n_parem * 2)
diag(Q[1:n_parem, 1:n_parem]) <- 1.0e-6
diag(Q_0) <- 1.0e1

a_0 <- rep(0, 2 * n_parem)

F_ = matrix(NA_real_, nrow = 2 * n_parem, ncol = 2 * n_parem)
F_[1:n_parem, 1:n_parem] = diag(2, n_parem)
F_[n_parem + 1:n_parem, 1:n_parem] = diag(1, n_parem)
F_[1:n_parem, n_parem + 1:n_parem] = diag(-1, n_parem)
F_[n_parem + 1:n_parem, n_parem + 1:n_parem] = 0.0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = a_0,
                    Q_0 = Q_0,
                    Q = Q,
                    F_= F_, # first order random walk
                    risk_sets = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 2,
                    est_Q_0 = F)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 2 and no Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 6.615982861024481e-01, 3.606236225328838e-01, 3.562756717331124e-01, 3.599361102573336e-01, 9.004193733768271e-01,  3.791983293903925e-01, 3.741158005465237e-01, 3.777553409527079e-01, 3.606236225328903e-01, 1.192183091763821e+00, -3.586299559829822e-02, -2.304811207706398e-02, 3.802472478261372e-01, 1.428237021105825e+00, -2.319334483142046e-02, -9.314260368363456e-03, 3.562756717331034e-01, -3.586299559830793e-02, 1.200741805635591e+00, -3.703500803576347e-02,  3.752470944900522e-01, -2.322711490351754e-02, 1.437532823986981e+00, -2.519816091742711e-02, 3.599361102573330e-01, -2.304811207706822e-02, -3.703500803575960e-02, 1.195427981429699e+00, 3.786386930061571e-01, -9.359916820899473e-03, -2.520308331511644e-02, 1.431259258380417e+00, 9.004193733768263e-01, 3.802472478261304e-01, 3.752470944900631e-01,  3.786386930061578e-01, 1.467033206410237e+00, 2.994647951704968e-01, 2.937028681670222e-01, 2.965661741487041e-01,  3.791983293903997e-01, 1.428237021105824e+00, -2.322711490350636e-02, -9.359916820894966e-03, 2.994647951705033e-01,  1.769342753347242e+00, 3.571440249565772e-02, 5.075312666330792e-02, 3.741158005465121e-01, -2.319334483143151e-02,  1.437532823986982e+00, -2.520308331512057e-02, 2.937028681670076e-01, 3.571440249564512e-02, 1.779287930917992e+00,  3.265744181422079e-02, 3.777553409527065e-01, -9.314260368368368e-03, -2.519816091742319e-02, 1.431259258380418e+00,  2.965661741487020e-01, 5.075312666330273e-02, 3.265744181422468e-02, 1.771908032381276e+00, 3.465385248854289e-01,  2.889907401479752e-01, 2.859405560693999e-01, 2.895845633788667e-01, 4.152056822989096e-01, 3.439854460428646e-01,  3.403163720407036e-01, 3.442678230560351e-01, 2.889907401479797e-01, 7.988209896761980e-01, -4.117681028094675e-02, -3.045141624463106e-02, 3.450716139766691e-01, 9.549371253744758e-01, -4.970141711506990e-02, -3.794770158407784e-02,  2.859405560693946e-01, -4.117681028095374e-02, 8.058671149670991e-01, -4.101582819640431e-02, 3.414542743938012e-01, -4.972297387935927e-02, 9.627496787200022e-01, -5.007673546852099e-02, 2.895845633788667e-01, -3.045141624463439e-02, -4.101582819640098e-02, 8.021654996576419e-01, 3.451443080365616e-01, -3.797572214103030e-02, -5.007627753674190e-02,  9.583832705591431e-01, 4.152056822989104e-01, 3.450716139766632e-01, 3.414542743938074e-01, 3.451443080365613e-01,  6.615982861024581e-01, 3.606236225328840e-01, 3.562756717331124e-01, 3.599361102573337e-01, 3.439854460428707e-01,  9.549371253744756e-01, -4.972297387935090e-02, -3.797572214102674e-02, 3.606236225328905e-01, 1.192183091763815e+00, -3.586299559829816e-02, -2.304811207706397e-02, 3.403163720406967e-01, -4.970141711507817e-02, 9.627496787200005e-01, -5.007627753674575e-02, 3.562756717331034e-01, -3.586299559830787e-02, 1.200741805635597e+00, -3.703500803576348e-02,  3.442678230560348e-01, -3.794770158408180e-02, -5.007673546851735e-02, 9.583832705591429e-01, 3.599361102573332e-01, -2.304811207706821e-02, -3.703500803575961e-02, 1.195427981429682e+00, 2.367031027421350e-01, 1.983762954724860e-01,  1.963772133677598e-01, 1.995278196951750e-01, 2.775412769009482e-01, 2.329634132947476e-01, 2.305524800389358e-01,  2.341806915257832e-01, 1.983762954724887e-01, 5.438297157102374e-01, -2.559954169254539e-02, -1.696363482427525e-02,  2.341276466726452e-01, 6.426831128566667e-01, -3.268083549900703e-02, -2.298937224648862e-02, 1.963772133677572e-01, -2.559954169254980e-02, 5.493411997448046e-01, -2.473970208188899e-02, 2.316961808699210e-01, -3.267358206494590e-02,  6.489340914531645e-01, -3.201755508696945e-02, 1.995278196951750e-01, -1.696363482427775e-02, -2.473970208188684e-02,  5.465291507473946e-01, 2.350331222515075e-01, -2.297657489486043e-02, -3.200518809859380e-02, 6.458850377539356e-01,  2.775412769009482e-01, 2.341276466726417e-01, 2.316961808699247e-01, 2.350331222515080e-01, 3.465385248851506e-01,  2.889907401477088e-01, 2.859405560693261e-01, 2.895845633787099e-01, 2.329634132947508e-01, 6.426831128566668e-01, -3.267358206494018e-02, -2.297657489485767e-02, 2.889907401477131e-01, 7.988209896757930e-01, -4.117681028100069e-02, -3.045141624470225e-02, 2.305524800389326e-01, -3.268083549901266e-02, 6.489340914531647e-01, -3.200518809859681e-02,  2.859405560693210e-01, -4.117681028100768e-02, 8.058671149669776e-01, -4.101582819628279e-02, 2.341806915257837e-01, -2.298937224649172e-02, -3.201755508696674e-02, 6.458850377539362e-01, 2.895845633787097e-01, -3.045141624470558e-02, -4.101582819627948e-02, 8.021654996574333e-01, 1.810304770160839e-01, 1.508373181510123e-01, 1.498205662074058e-01,  1.516990997119809e-01, 1.956873507584628e-01, 1.646984573839512e-01, 1.635145565360332e-01, 1.659566313802063e-01,  1.508373181510138e-01, 4.017338637754746e-01, -1.467472918400236e-02, -8.009873582067051e-03, 1.638598102976849e-01,  4.441479189648943e-01, -1.950616293121245e-02, -1.172288745497781e-02, 1.498205662074047e-01, -1.467472918400474e-02,  4.055486725061375e-01, -1.370206728314911e-02, 1.622724874071262e-01, -1.934499943523160e-02, 4.487683681973967e-01, -1.824539144562669e-02, 1.516990997119806e-01, -8.009873582068519e-03, -1.370206728314778e-02, 4.031404078498290e-01,  1.649456898380370e-01, -1.176703751785475e-02, -1.844404807280363e-02, 4.463993061230089e-01, 1.956873507584629e-01,  1.638598102976830e-01, 1.622724874071281e-01, 1.649456898380374e-01, 2.367031027422447e-01, 1.983762954725021e-01,  1.963772133678419e-01, 1.995278196952821e-01, 1.646984573839529e-01, 4.441479189648947e-01, -1.934499943522842e-02, -1.176703751785290e-02, 1.983762954725048e-01, 5.438297157102004e-01, -2.559954169251721e-02, -1.696363482430997e-02,  1.635145565360317e-01, -1.950616293121582e-02, 4.487683681973968e-01, -1.844404807280547e-02, 1.963772133678392e-01, -2.559954169252162e-02, 5.493411997448507e-01, -2.473970208176139e-02, 1.659566313802063e-01, -1.172288745497982e-02, -1.824539144562511e-02, 4.463993061230097e-01, 1.995278196952820e-01, -1.696363482431247e-02, -2.473970208175924e-02,  5.465291507474813e-01, 1.747512226855075e-01, 1.452872691661677e-01, 1.446513677154526e-01, 1.449745699226431e-01,  1.645410371502599e-01, 1.377183793801922e-01, 1.370648061693749e-01, 1.381185882593415e-01, 1.452872691661686e-01,  3.741594393508226e-01, -6.563691789280686e-03, -1.945806130916366e-03, 1.377074480871859e-01, 3.593574953750776e-01, -9.883176213757217e-03, -4.119427806117938e-03, 1.446513677154521e-01, -6.563691789281512e-03, 3.765371895841492e-01, -6.047186191520785e-03, 1.368568840740512e-01, -9.804860486713481e-03, 3.624492968689283e-01, -8.826977970616517e-03,  1.449745699226431e-01, -1.945806130917258e-03, -6.047186191520445e-03, 3.736588306697756e-01, 1.381739777454631e-01, -4.258324174334622e-03, -9.037279290657774e-03, 3.600142090188389e-01, 1.645410371502602e-01, 1.377074480871848e-01,  1.368568840740519e-01, 1.381739777454635e-01, 1.810304770161172e-01, 1.508373181510364e-01, 1.498205662074278e-01,  1.516990997120222e-01, 1.377183793801935e-01, 3.593574953750779e-01, -9.804860486712121e-03, -4.258324174333750e-03,  1.508373181510378e-01, 4.017338637755157e-01, -1.467472918400095e-02, -8.009873582061877e-03, 1.370648061693740e-01, -9.883176213758522e-03, 3.624492968689285e-01,
                  -9.037279290658593e-03, 1.498205662074268e-01, -1.467472918400333e-02,  4.055486725061697e-01, -1.370206728308168e-02, 1.381185882593418e-01, -4.119427806119262e-03, -8.826977970615999e-03,  3.600142090188395e-01, 1.516990997120218e-01, -8.009873582063344e-03, -1.370206728308036e-02, 4.031404078498361e-01,  2.201318930989751e-01, 1.813270048836944e-01, 1.807683641395376e-01, 1.796796231200096e-01, 1.829115108235308e-01,  1.532532433970262e-01, 1.527750562084955e-01, 1.525996547640396e-01, 1.813270048836945e-01, 4.610628213788255e-01, -1.427701368256526e-03, 8.963895547086584e-04, 1.536741130834789e-01, 3.888061745072386e-01, -3.453957670469902e-03,  3.753544467463565e-05, 1.807683641395379e-01, -1.427701368256873e-03, 4.620261210024756e-01, -2.225701083035422e-03,  1.530548086992606e-01, -3.398174947975632e-03, 3.904927780287809e-01, -3.385835362697459e-03, 1.796796231200098e-01,  8.963895547080269e-04, -2.225701083035450e-03, 4.574607427751916e-01, 1.526497835872870e-01, 7.339586004805748e-05, -3.399041112474473e-03, 3.869727278429524e-01, 1.829115108235311e-01, 1.536741130834784e-01, 1.530548086992609e-01,  1.526497835872873e-01, 1.747512226855038e-01, 1.452872691661498e-01, 1.446513677154790e-01, 1.449745699226578e-01,  1.532532433970263e-01, 3.888061745072391e-01, -3.398174947975084e-03, 7.339586004874443e-05, 1.452872691661507e-01,  3.741594393508180e-01, -6.563691789279576e-03, -1.945806130914865e-03, 1.527750562084958e-01, -3.453957670470478e-03,  3.904927780287805e-01, -3.399041112474882e-03, 1.446513677154785e-01, -6.563691789280401e-03, 3.765371895841838e-01, -6.047186191489487e-03, 1.525996547640401e-01, 3.753544467367462e-05, -3.385835362697688e-03, 3.869727278429531e-01,  1.449745699226578e-01, -1.945806130915757e-03, -6.047186191489147e-03, 3.736588306698180e-01, 3.151068989109860e-01,  2.596404259120220e-01, 2.591521809246096e-01, 2.568753629561938e-01, 2.515301606930639e-01, 2.109602362131275e-01,  2.105870561170500e-01, 2.092700625707857e-01, 2.596404259120222e-01, 6.622271718756656e-01, 3.979304680080537e-04,  1.494409500739924e-04, 2.117246816971933e-01, 5.325277442493264e-01, -2.976590349013652e-04, 6.971126049465370e-04,  2.591521809246099e-01, 3.979304680082202e-04, 6.615618714287419e-01, -2.723405034013290e-03, 2.110825361540982e-01, -1.910156994825718e-04, 5.327190181980284e-01, -2.073287632289825e-03, 2.568753629561940e-01, 1.494409500739508e-04, -2.723405034013304e-03, 6.540278221450246e-01, 2.090871413693209e-01, 9.633930743034660e-04, -1.907316009281644e-03,  5.269237737310237e-01, 2.515301606930643e-01, 2.117246816971931e-01, 2.110825361540979e-01, 2.090871413693211e-01,  2.201318930989993e-01, 1.813270048837064e-01, 1.807683641395672e-01, 1.796796231200366e-01, 2.109602362131281e-01,  5.325277442493261e-01, -1.910156994828632e-04, 9.633930743035424e-04, 1.813270048837066e-01, 4.610628213788943e-01, -1.427701368248518e-03, 8.963895547169434e-04, 2.105870561170505e-01, -2.976590349013375e-04, 5.327190181980286e-01, -1.907316009281720e-03, 1.807683641395675e-01, -1.427701368248872e-03, 4.620261210024597e-01, -2.225701083002830e-03,  2.092700625707855e-01, 6.971126049463636e-04, -2.073287632289790e-03, 5.269237737310251e-01, 1.796796231200368e-01,  8.963895547163120e-04, -2.225701083002858e-03, 4.574607427752337e-01, 4.551361524490574e-01, 3.819597868903368e-01,  3.820762507321869e-01, 3.780385768350590e-01, 3.697423773449372e-01, 3.109673365434854e-01, 3.110990588359301e-01,  3.081080789600319e-01, 3.819597868903368e-01, 9.769942143741233e-01, -1.962199933889915e-03, -4.743911579986448e-03,  3.118898586337380e-01, 7.905638201155778e-01, -5.610255386693432e-04, -2.039653104892163e-03, 3.820762507321870e-01, -1.962199933889835e-03, 9.740545406910761e-01, -8.314124103281091e-03, 3.112818632017793e-01, -2.665268172625922e-04,  7.888579080947203e-01, -4.912828415980477e-03, 3.780385768350589e-01, -4.743911579986399e-03, -8.314124103281077e-03,  9.629061870169200e-01, 3.080554891420603e-01, -1.762197458431425e-03, -4.923845648198692e-03, 7.797536302357312e-01,  3.697423773449372e-01, 3.118898586337381e-01, 3.112818632017793e-01, 3.080554891420603e-01, 3.151068989109764e-01,  2.596404259119826e-01, 2.591521809246705e-01, 2.568753629561670e-01, 3.109673365434855e-01, 7.905638201155779e-01, -2.665268172628073e-04, -1.762197458431442e-03, 2.596404259119828e-01, 6.622271718755617e-01, 3.979304679975568e-04,  1.494409500634019e-04, 3.110990588359304e-01, -5.610255386693051e-04, 7.888579080947206e-01, -4.923845648198571e-03,  2.591521809246708e-01, 3.979304679977286e-04, 6.615618714289370e-01, -2.723405034006303e-03, 3.081080789600318e-01, -2.039653104892174e-03, -4.912828415980449e-03, 7.797536302357314e-01, 2.568753629561672e-01, 1.494409500633568e-04, -2.723405034006324e-03, 6.540278221449950e-01, 6.492995362661972e-01, 5.453570900450978e-01, 5.461233000844252e-01,  5.392443376427544e-01, 5.382707770273435e-01, 4.535000611087415e-01, 4.541783670444150e-01, 4.485859500622857e-01,  5.453570900450978e-01, 1.406257056379987e+00, -7.421355334866427e-03, -1.249505223135405e-02, 4.538539462705223e-01,  1.162837066767725e+00, -4.179955807723880e-03, -7.950902709879040e-03, 5.461233000844252e-01, -7.421355334866425e-03,  1.400788116869595e+00, -1.751375602584603e-02, 4.539539673154663e-01, -3.949607761513289e-03, 1.158729237412304e+00, -1.192938138088551e-02, 5.392443376427544e-01, -1.249505223135405e-02, -1.751375602584601e-02, 1.385785320364766e+00,  4.488721933045847e-01, -8.036090969780689e-03, -1.223831549445002e-02, 1.145832571991551e+00, 5.382707770273435e-01,  4.538539462705223e-01, 4.539539673154663e-01, 4.488721933045847e-01, 4.551361524490187e-01, 3.819597868903282e-01,  3.820762507321762e-01, 3.780385768350499e-01, 4.535000611087414e-01, 1.162837066767725e+00, -3.949607761513318e-03, -8.036090969780692e-03, 3.819597868903282e-01, 9.769942143741233e-01, -1.962199933879629e-03, -4.743911579968101e-03,  4.541783670444151e-01, -4.179955807723904e-03, 1.158729237412304e+00, -1.223831549445001e-02, 3.820762507321763e-01, -1.962199933879547e-03, 9.740545406910714e-01, -8.314124103266315e-03, 4.485859500622857e-01, -7.950902709879033e-03, -1.192938138088548e-02, 1.145832571991551e+00, 3.780385768350498e-01, -4.743911579968051e-03, -8.314124103266301e-03,  9.629061870169393e-01, 8.941608005886347e-01, 7.498929525195249e-01, 7.509465896790152e-01, 7.410446199022085e-01,  7.565440745708670e-01, 6.376804974380501e-01, 6.386193573493757e-01, 6.302100835706016e-01, 7.498929525195249e-01,  1.950517760069211e+00, -1.531793142326406e-02, -2.279965834021458e-02, 6.387248171466318e-01, 1.649349385684957e+00, -1.102354254225732e-02, -1.719099614142745e-02, 7.509465896790152e-01, -1.531793142326406e-02, 1.942588116626297e+00, -2.985552053218218e-02, 6.395769487689760e-01, -1.098979986060946e-02, 1.642716541075608e+00, -2.302586448172042e-02,  7.410446199022085e-01, -2.279965834021458e-02, -2.985552053218218e-02, 1.922775987859620e+00, 6.314157888302037e-01, -1.736718683963567e-02, -2.322876855946217e-02, 1.625500527038769e+00, 7.565440745708670e-01, 6.387248171466318e-01,  6.395769487689760e-01, 6.314157888302037e-01, 6.492995362661982e-01, 5.453570900451151e-01,
                  5.461233000844095e-01,  5.392443376427570e-01, 6.376804974380501e-01, 1.649349385684957e+00, -1.098979986060946e-02, -1.736718683963567e-02,  5.453570900451151e-01, 1.406257056380017e+00, -7.421355334867365e-03, -1.249505223135039e-02, 6.386193573493757e-01, -1.102354254225733e-02, 1.642716541075608e+00, -2.322876855946217e-02, 5.461233000844095e-01, -7.421355334867362e-03,  1.400788116869566e+00, -1.751375602585030e-02, 6.302100835706016e-01, -1.719099614142746e-02, -2.302586448172042e-02,  1.625500527038769e+00, 5.392443376427570e-01, -1.249505223135039e-02, -1.751375602585029e-02, 1.385785320364783e+00,  1.202825258631969e+00, 9.908727549108018e-01, 9.921407487294018e-01, 9.791736606817232e-01, 1.024447805367775e+00,  8.639738127725861e-01, 8.651099024048635e-01, 8.538086508679447e-01, 9.908727549108018e-01, 2.611438586109525e+00, -2.410708466767834e-02, -3.416924008353738e-02, 8.650316341554366e-01, 2.250523254074559e+00, -2.076137916797654e-02, -2.948379328342307e-02, 9.921407487294018e-01, -2.410708466767834e-02, 2.600886709274653e+00, -4.396607858631167e-02,  8.661962079556992e-01, -2.077363974781124e-02, 2.241345804293312e+00, -3.773229220217929e-02, 9.791736606817232e-01, -3.416924008353738e-02, -4.396607858631167e-02, 2.575196814191492e+00, 8.548099623879893e-01, -2.957298506799664e-02, -3.780223629767297e-02, 2.218797790850177e+00, 1.024447805367775e+00, 8.650316341554366e-01, 8.661962079556992e-01,  8.548099623879893e-01, 8.941608005886361e-01, 7.498929525195271e-01, 7.509465896790195e-01, 7.410446199022056e-01,  8.639738127725861e-01, 2.250523254074559e+00, -2.077363974781124e-02, -2.957298506799664e-02, 7.498929525195271e-01,  1.950517760069209e+00, -1.531793142326119e-02, -2.279965834021305e-02, 8.651099024048635e-01, -2.076137916797654e-02,  2.241345804293312e+00, -3.780223629767297e-02, 7.509465896790195e-01, -1.531793142326119e-02, 1.942588116626305e+00, -2.985552053218088e-02, 8.538086508679447e-01, -2.948379328342307e-02, -3.773229220217929e-02, 2.218797790850177e+00,  7.410446199022056e-01, -2.279965834021305e-02, -2.985552053218088e-02, 1.922775987859611e+00 ))

  expect_equal(c(res$a_t_d_s),
               c(-1.4123719614411352, -0.5954985728724345, 0.2213748302442289, 0.5754523674249364, 0.4698996182019390, 0.4464061657761225,  1.0688690825556506, 1.4667455172637414, 1.4616968942912212, 1.1001163196113133, 1.0053023866760644, 0.9973446121311770,  1.5020584092525746, 2.0067722004986552, 2.6962480886266569, 3.5692223309921647, 4.4094359564566723, 4.9917640863588666,  5.6637529254199537, 6.4966007070458716, 7.4717863193368066, 8.3404707839867367, 3.2676988787070451, 3.1440993566694440,  3.0204998287638571, 3.0814200023490614, 3.3255982049112953, 3.5370594679875751, 3.4909741413526811, 3.5344321690563127,  3.7385381861346350, 4.0847951956277040, 4.3246908093108898, 3.1409052726678932, 2.9872383817392363, 2.8335714849228566,  2.8649558155833064, 3.0801258205902129, 3.2624850079287393, 3.1865568622587568, 3.2004312628285723, 3.3754174119523053,  3.6929645935412880, 3.9038441500599439, -2.2292453472420424, -1.4123719614411352, -0.5954985728726093, 0.2213748302442444,  0.5754523674249075, 0.4698996182019327, 0.4464061657761105, 1.0688690825556575, 1.4667455172637462, 1.4616968942912167,  1.1001163196113237, 0.4926308138804821, 0.9973446121311770, 1.5020584092523903, 2.0067722004986610, 2.6962480886266307,  3.5692223309921749, 4.4094359564566785, 4.9917640863588391, 5.6637529254199572, 6.4966007070458822, 7.4717863193368030,  3.3912983996165220, 3.2676988787070451, 3.1440993566694857, 3.0204998287638634, 3.0814200023490459, 3.3255982049112611,  3.5370594679875662, 3.4909741413527011, 3.5344321690563270, 3.7385381861346154, 4.0847951956277102, 3.2945721624642581,  3.1409052726678932, 2.9872383817391901, 2.8335714849228895, 2.8649558155832313, 3.0801258205901725, 3.2624850079287180,  3.1865568622587594, 3.2004312628285980, 3.3754174119522857, 3.6929645935413022 ))

  expect_equal(c(res$B_s),
               c( 4.440892098500626e-16, 1.734723475976807e-18, 1.734723475976807e-18, 0.000000000000000e+00, -9.835408363916865e-01, -6.570942483171933e-03, -6.562318120580821e-03, -6.581224787863177e-03, 0.000000000000000e+00, 2.220446049250313e-16,  0.000000000000000e+00, 8.673617379884035e-19, -6.570942483171933e-03, -9.973765863915584e-01, 2.619870488978498e-03,  2.627418586048539e-03, 3.469446951953614e-18, 2.602085213965211e-18, 2.220446049250313e-16, 0.000000000000000e+00, -6.562318120580821e-03, 2.619870488978498e-03, -9.973834680886285e-01, 2.623970100161441e-03, 3.469446951953614e-18,  8.673617379884035e-19, -8.673617379884035e-19, -4.440892098500626e-16, -6.581224787863177e-03, 2.627418586048539e-03,  2.623970100161441e-03, -9.973683699929505e-01, 9.999999999999996e-01, -6.938893903907228e-18, 0.000000000000000e+00,  3.469446951953614e-18, 1.967081672783373e+00, 1.314188496634387e-02, 1.312463624116164e-02, 1.316244957572635e-02, -3.469446951953614e-18, 9.999999999999991e-01, 3.469446951953614e-18, 0.000000000000000e+00, 1.314188496634386e-02,  1.994753172783116e+00, -5.239740977956998e-03, -5.254837172097078e-03, -3.469446951953614e-18, -1.734723475976807e-18,  1.000000000000000e+00, 0.000000000000000e+00, 1.312463624116164e-02, -5.239740977956995e-03, 1.994766936177257e+00, -5.247940200322882e-03, -3.469446951953614e-18, 0.000000000000000e+00, 1.734723475976807e-18, 1.000000000000000e+00,  1.316244957572635e-02, -5.254837172097078e-03, -5.247940200322883e-03, 1.994736739985902e+00, 7.632783294297951e-17, -8.348356728138384e-17, 2.593411596585327e-16, -9.714451465470120e-17, -9.263037433286283e-01, -2.942151447864876e-02, -2.938289874058234e-02, -2.946755368798560e-02, 2.255140518769849e-16, 1.537398680584445e-16, -3.100818213308543e-17, -2.775557561562891e-17, -2.942151447864883e-02, -9.882535655949086e-01, 1.173051776569852e-02, 1.176431450748970e-02, -8.673617379884035e-17, 2.696410802971450e-16, -5.958775139980332e-16, 9.020562075079397e-17, -2.938289874058246e-02,  1.173051776569861e-02, -9.882843785260375e-01, 1.174887385077189e-02, -2.220446049250313e-16, 5.065392549852277e-16,  0.000000000000000e+00, -4.440892098500626e-16, -2.946755368798543e-02, 1.176431450748993e-02, 1.174887385077189e-02, -9.882167765298076e-01, 1.000000000000057e+00, -1.776356839400250e-14, 5.684341886080801e-14, 0.000000000000000e+00,  1.881939697176136e+00, 4.713282729649304e-02, 4.707096546023770e-02, 4.720658142312573e-02, -5.684341886080801e-14,  9.999999999999489e-01, -8.881784197001252e-15, 0.000000000000000e+00, 4.713282729655788e-02, 1.981182388304372e+00, -1.879211446951912e-02, -1.884625634571080e-02, -5.684341886080801e-14, -2.398081733190338e-14, 9.999999999999627e-01,  0.000000000000000e+00, 4.707096546018263e-02, -1.879211446948048e-02, 1.981231750160188e+00, -1.882152064393949e-02, -5.684341886080801e-14, -1.554312234475219e-14, 9.769962616701378e-15, 9.999999999999716e-01, 4.720658142307599e-02, -1.884625634566417e-02, -1.882152064395459e-02, 1.981123452770689e+00, 1.332267629550188e-15, 1.144917494144693e-15,  9.714451465470120e-17, 2.220446049250313e-15, -3.299798817306528e-01, -2.674911690023665e-01, -2.671400816736932e-01, -2.679097378390172e-01, 1.665334536937735e-16, -3.252606517456513e-17, 3.816391647148976e-16, -2.220446049250313e-16, -2.671778474034672e-01, -8.933332568101910e-01, 1.065252371389487e-01, 1.068321448325600e-01, -9.436895709313831e-16, -5.759281940243000e-16, 1.589006703994755e-15, -8.881784197001252e-16, -2.658724364854119e-01, 1.061440789012017e-01, -8.939937327223426e-01, 1.063101764229967e-01, -4.440892098500626e-16, -1.124100812432971e-15, -3.053113317719180e-16, -8.881784197001252e-16, -2.665311446960184e-01, 1.064070528203645e-01, 1.062673970241149e-01, -8.934249357561370e-01,  1.000000000000085e+00, 4.107825191113079e-15, 6.927791673660977e-14, 0.000000000000000e+00, 6.612275444266231e-01,  5.344765217831022e-01, 5.337750103066705e-01, 5.353128671561933e-01, -1.421085471520200e-14, 9.999999999999862e-01, -1.776356839400250e-14, 0.000000000000000e+00, 5.338498785538590e-01, 1.786869250614481e+00, -2.128488022048729e-01, -2.134620365275595e-01, 0.000000000000000e+00, 5.051514762044462e-15, 9.999999999999849e-01, 5.684341886080801e-14,  5.312397198030467e-01, -2.120864856911975e-01, 1.788189673161024e+00, -2.124183648364664e-01, 0.000000000000000e+00, -2.287059430727822e-14, -3.552713678800501e-15, 1.000000000000028e+00, 5.325556807321021e-01, -2.126118524606153e-01, -2.123328060344460e-01, 1.787053241486902e+00, 6.106226635438361e-16, -1.431146867680866e-17, -4.597017211338539e-16,  4.440892098500626e-16, -3.254835910747638e-01, -2.692854586256000e-01, -2.689320104983458e-01, -2.697068335395222e-01,  2.289834988289385e-16, 2.155393918901183e-16, -4.694595406862234e-16, -5.551115123125783e-16, -2.676030310994740e-01, -8.931614099050867e-01, 1.066946567078300e-01, 1.070020439368674e-01, -8.187894806610529e-16, -1.314649344247298e-15,  1.052109788179934e-15, -4.718447854656915e-16, -2.662950172083561e-01, 1.063126843747710e-01, -8.938231550552723e-01,  1.064790627806361e-01, 4.440892098500626e-16, -2.012279232133096e-16, 1.387778780781446e-17, -8.881784197001252e-16, -2.672861679103113e-01, 1.067083685808206e-01, 1.065683429252699e-01, -8.931209432334017e-01, 9.999999999999716e-01, -7.555067682574190e-14, 9.769962616701378e-14, -5.684341886080801e-14, 6.584655416024248e-01, 5.355781732172220e-01,  5.348752073179167e-01, 5.364162440244513e-01, 4.263256414560601e-14, 1.000000000000059e+00, -3.574918139293004e-14,  5.684341886080801e-14, 5.322171408933301e-01, 1.787518260116649e+00, -2.121976517340605e-01, -2.128089970026821e-01,  2.131628207280301e-14, 3.338995746560158e-14, 9.999999999999820e-01, 8.526512829121202e-14, 5.296166620569238e-01, -2.114383475776247e-01, 1.788833981406830e+00, -2.117692409389065e-01, 2.842170943040401e-14, 6.064593272014918e-15, -6.217248937900877e-15, 1.000000000000028e+00, 5.315917029700685e-01, -2.122268209299705e-01, -2.119483213077704e-01,  1.787435875483766e+00, 2.498001805406602e-16, -8.586881206085195e-16, -1.413799632921098e-15, 1.110223024625157e-16, -3.251923250282821e-01, -2.694003063692745e-01, -2.690467005362747e-01, -2.698218635346720e-01, 1.665334536937735e-16, -1.294103713078698e-15, -2.324529457808922e-16, -6.661338147750939e-16, -2.690489499853179e-01, -8.925799545586942e-01,  1.072708801828492e-01, 1.075798816204911e-01, 4.440892098500626e-16, 1.956768080901838e-15, -3.236994006172722e-15,  3.330669073875470e-16, -2.686072482693528e-01, 1.072355255448995e-01, -8.928970847716812e-01, 1.074033665666335e-01, -1.776356839400250e-15, -8.326672684688674e-16, -3.441691376337985e-15, 1.776356839400250e-15, -2.689145381203590e-01,  1.073581418251989e-01, 1.072173277800713e-01, -8.924656549193379e-01, 1.000000000000014e+00, -1.332267629550188e-14,  3.907985046680551e-14, 5.684341886080801e-14, 6.546294680060285e-01, 5.371077994867893e-01, 5.364028281165567e-01,  5.379482722255489e-01, -2.131628207280301e-14, 1.000000000000005e+00, -6.661338147750939e-15, -1.421085471520200e-14,  5.364242259696610e-01, 1.785833091406149e+00, -2.138746670126318e-01, -2.144907639600717e-01, 7.105427357601002e-15, -2.775557561562891e-15, 1.000000000000011e+00,
                  0.000000000000000e+00, 5.355490162005090e-01, -2.138063445739637e-01,  1.786463187873516e+00, -2.141409539787418e-01, -7.105427357601002e-15, 2.442490654175344e-15, 4.884981308350689e-15,  1.000000000000000e+00, 5.361552992690086e-01, -2.140482859540889e-01, -2.137674860964920e-01, 1.785605561694311e+00,  1.110223024625157e-15, -6.938893903907228e-16, 1.665334536937735e-15, -8.881784197001252e-16, -3.269404398368545e-01, -2.686999799753010e-01, -2.683472818450224e-01, -2.691204535219782e-01, -2.442490654175344e-15, 1.817990202823694e-15, -1.665334536937735e-16, -3.552713678800501e-15, -2.684687197540310e-01, -8.928043194612486e-01, 1.070389985792127e-01,  1.073472179203829e-01, 5.107025913275720e-15, 6.120104423246175e-15, 7.271960811294775e-15, 1.776356839400250e-15, -2.685527423271628e-01, 1.072132290083954e-01, -8.929116078577365e-01, 1.073810347625899e-01, -1.776356839400250e-15, -1.998401444325282e-15, -1.998401444325282e-15, -7.105427357601002e-15, -2.679027941767558e-01, 1.069535625953362e-01,  1.068133930820943e-01, -8.928629686213192e-01, 1.000000000000021e+00, 1.643130076445232e-14, 2.531308496145357e-14,  2.842170943040401e-14, 6.613549291587546e-01, 5.344198120216647e-01, 5.337183545722604e-01, 5.352560900647632e-01, -5.329070518200751e-15, 1.000000000000016e+00, -2.886579864025407e-15, 0.000000000000000e+00, 5.339463638292692e-01,  1.786813334224058e+00, -2.128860343282682e-01, -2.134991285400929e-01, 0.000000000000000e+00, -1.532107773982716e-14,  9.999999999999745e-01, 0.000000000000000e+00, 5.341097397271248e-01, -2.132310529736092e-01, 1.787028136020780e+00, -2.135647489459984e-01, 0.000000000000000e+00, -1.998401444325282e-15, 2.220446049250313e-15, 1.000000000000014e+00,  5.328139980344488e-01, -2.127134834435228e-01, -2.124345765350710e-01, 1.786932655936560e+00, 7.105427357601002e-15,  5.273559366969494e-15, 2.220446049250313e-15, 5.329070518200751e-15, -3.350457866450482e-01, -2.654605289398908e-01, -2.651120664075165e-01, -2.658759609273673e-01, -2.664535259100376e-15, -4.773959005888173e-15, -1.387778780781446e-15, -7.105427357601002e-15, -2.645034945582236e-01, -8.943765438695490e-01, 1.054571852803641e-01, 1.057606595671601e-01, -1.776356839400250e-15, -5.773159728050814e-15, -1.348920974919565e-14, 5.329070518200751e-15, -2.649307163839638e-01,  1.057663595410128e-01, -8.943450344119332e-01, 1.059318827062405e-01, 3.552713678800501e-15, -8.881784197001252e-16,  5.773159728050814e-15, 1.421085471520200e-14, -2.645401519065906e-01, 1.056100389892987e-01, 1.054718018378220e-01, -8.941967809213622e-01, 1.000000000000014e+00, 2.220446049250313e-16, 2.220446049250313e-15, 0.000000000000000e+00,  6.942435899549757e-01, 5.212855446612830e-01, 5.206013076062064e-01, 5.221013136845229e-01, -1.154631945610163e-14,  9.999999999999767e-01, 3.330669073875470e-15, 3.552713678800501e-15, 5.193757696453858e-01, 1.792617722289214e+00, -2.070756356783591e-01, -2.076717685733325e-01, 0.000000000000000e+00, -3.108624468950438e-15, 1.000000000000064e+00, -1.421085471520200e-14, 5.202084257187449e-01, -2.076802229840333e-01, 1.792558180750530e+00, -2.080052091348428e-01, -2.131628207280301e-14, -5.773159728050814e-15, 8.881784197001252e-16, 9.999999999999716e-01, 5.194849223626505e-01, -2.073908590427940e-01, -2.071191350282930e-01, 1.792249778487218e+00, 0.000000000000000e+00, 5.134781488891349e-15,  5.551115123125783e-16, 0.000000000000000e+00, -3.413013132398808e-01, -2.629584041628084e-01, -2.626132053228537e-01, -2.633699622661432e-01, -8.881784197001252e-16, -2.775557561562891e-16, 9.436895709313831e-16, -3.552713678800501e-15, -2.609028900740018e-01, -8.957995109953784e-01, 1.040204130056158e-01, 1.043194869716668e-01, -1.776356839400250e-15, -1.054711873393899e-15, -1.390554338343009e-14, -1.776356839400250e-15, -2.617399142596044e-01, 1.044913136842645e-01, -8.956028826837399e-01, 1.046548067995463e-01, 0.000000000000000e+00, 4.884981308350689e-15, -4.884981308350689e-15,  0.000000000000000e+00, -2.624648237331755e-01, 1.047800340654836e-01, 1.046431120128517e-01, -8.950121771054427e-01,  9.999999999999574e-01, -2.664535259100376e-14, -1.776356839400250e-15, 2.842170943040401e-14, 7.189767545592645e-01,  5.114059996358855e-01, 5.107347087366487e-01, 5.122063683737110e-01, 7.105427357601002e-15, 1.000000000000008e+00,  7.327471962526033e-15, 1.421085471520200e-14, 5.073877104255331e-01, 1.797387335015377e+00, -2.022945660413736e-01, -2.028766308512218e-01, 7.105427357601002e-15, 1.199040866595169e-14, 1.000000000000015e+00, 1.421085471520200e-14,  5.090190858889976e-01, -2.032117520849964e-01, 1.797003236862959e+00, -2.035297080269487e-01, -1.421085471520200e-14,  1.332267629550188e-15, -4.440892098500626e-16, 1.000000000000000e+00, 5.104760008002458e-01, -2.037925458588077e-01, -2.035257997826734e-01, 1.795835729117186e+00, -5.329070518200751e-15, 9.353628982466944e-15, -8.826273045769994e-15, -7.105427357601002e-15, -3.274160287598606e-01, -2.684958165215293e-01, -2.681433270151265e-01, -2.689160889785889e-01,  7.105427357601002e-15, 3.030908857226677e-14, -2.220446049250313e-15, 7.105427357601002e-15, -2.653009372297381e-01, -8.940251823159663e-01, 1.057723719814816e-01, 1.060761605423579e-01, -3.552713678800501e-15, -5.162537064506978e-15, -2.020605904817785e-14, 1.776356839400250e-14, -2.671384563916561e-01, 1.066450130786012e-01, -8.934321543735264e-01,  1.068118266706843e-01, -7.105427357601002e-15, -7.327471962526033e-15, 1.953992523340276e-14, -1.421085471520200e-14, -2.681963016192839e-01, 1.070662847553958e-01, 1.069266449388346e-01, -8.927020033794548e-01, 1.000000000000007e+00,  3.175237850427948e-14, -1.021405182655144e-14, -2.842170943040401e-14, 6.647799706983903e-01, 5.330362731901286e-01,  5.323365756293339e-01, 5.338705456126434e-01, 1.776356839400250e-14, 9.999999999999932e-01, 5.551115123125783e-15,  0.000000000000000e+00, 5.266941594710524e-01, 1.789659010877525e+00, -2.099903832945925e-01, -2.105942514457695e-01, -2.486899575160351e-14, -7.771561172376096e-15, 9.999999999999881e-01, -2.131628207280301e-14, 5.303503461502608e-01, -2.117260564105618e-01, 1.788477941263156e+00, -2.120572809534025e-01, 1.421085471520200e-14, 1.021405182655144e-14, -1.376676550535194e-14, 1.000000000000057e+00, 5.324382328803381e-01, -2.125583490937686e-01, -2.122804118597639e-01,  1.787033502659227e+00, 1.421085471520200e-14, 6.772360450213455e-15, 1.909583602355269e-14, 7.105427357601002e-15, -3.285612564824874e-01, -2.680312100548693e-01, -2.676792998722060e-01, -2.684508042819154e-01, 0.000000000000000e+00, -2.770006446439766e-14, 2.042810365310288e-14, -7.105427357601002e-15, -2.645938717692253e-01, -8.942845212996500e-01,  1.054884613630480e-01, 1.057910310134780e-01, 2.309263891220326e-14, 1.648681191568357e-14, -1.620925615952729e-14,  1.421085471520200e-14, -2.669470707098345e-01, 1.065666183541072e-01, -8.934857586117920e-01, 1.067332490416675e-01, -1.421085471520200e-14, -3.108624468950438e-15, 4.440892098500626e-16, -2.842170943040401e-14, -2.674929514415751e-01,  1.067830601837618e-01, 1.066441323668528e-01, -8.929603879726074e-01, 1.000000000000004e+00, 7.327471962526033e-15, -4.218847493575595e-15, 7.105427357601002e-15, 6.698785841221220e-01, 5.309926348540923e-01,
                  5.302955844773949e-01,  5.318237494221236e-01, 1.376676550535194e-14, 1.000000000000018e+00, -8.493206138382448e-15, 1.509903313490213e-14,  5.241979526684228e-01, 1.790630305121994e+00, -2.089929035101779e-01, -2.095934608870067e-01, -1.421085471520200e-14, -1.077610223276793e-14, 1.000000000000060e+00, -1.376676550535194e-14, 5.288520206770715e-01, -2.111256658931949e-01,  1.789050328120056e+00, -2.114558846820747e-01, -1.421085471520200e-14, 3.552713678800501e-15, 8.881784197001252e-16,  9.999999999999716e-01, 5.299182109902603e-01, -2.115495936734759e-01, -2.112733506648117e-01, 1.788015973729614e+00 ))

  expect_equal(c(res$lag_one_cor),
               c( 4.174818304031233e-01, 3.470301411156866e-01, 3.433839664385348e-01, 3.469787562255572e-01, 6.638809212483616e-01,  3.625794483062406e-01, 3.582026668423375e-01, 3.617678600973951e-01, 3.459453415383228e-01, 9.605085157007963e-01, -4.997958057023753e-02, -3.837719918178668e-02, 3.625894852458065e-01, 1.197751804047328e+00, -3.612198005166187e-02, -2.345196159685596e-02, 3.422467411439717e-01, -4.995793647003484e-02, 9.684715894642179e-01, -5.067343506108378e-02,  3.582122236713980e-01, -3.612198203092698e-02, 1.206460951007790e+00, -3.763461833284713e-02, 3.460926592778569e-01, -3.835850981201380e-02, -5.068316435606450e-02, 9.639878801638666e-01, 3.617650851223901e-01, -2.346055750278519e-02, -3.764306636346067e-02, 1.201030640846696e+00, 4.869076050287711e-01, 4.038896794985575e-01, 3.996916784719527e-01,  4.033034467616756e-01, 9.035899337815652e-01, 3.829638292898877e-01, 3.779254933928833e-01, 3.811812046244848e-01,  4.017501291073160e-01, 1.118676919891146e+00, -5.859166092771629e-02, -4.602809384817604e-02, 3.819260199323818e-01,  1.435863830327124e+00, -2.353634203830516e-02, -9.870049057769420e-03, 3.974226015058191e-01, -5.853835037876016e-02,  1.127449331654547e+00, -5.992795811876019e-02, 3.768042883004682e-01, -2.350235990270348e-02, 1.445362777219660e+00, -2.597652023620187e-02, 4.015359447467348e-01, -4.596686204300743e-02, -5.993376895588998e-02, 1.122245998019254e+00,  3.802953446939729e-01, -9.832671851219266e-03, -2.597994507686491e-02, 1.438922874048113e+00, 2.789279316047030e-01,  2.353260705315324e-01, 2.328752826139343e-01, 2.361576634433789e-01, 3.479293715774724e-01, 2.901874228110843e-01,  2.871179195229046e-01, 2.907073649538755e-01, 2.341596642098266e-01, 6.461972052728533e-01, -3.287929305060056e-02, -2.327113313732108e-02, 2.901910704007020e-01, 8.023332684192972e-01, -4.138414425618563e-02, -3.074759465244904e-02,  2.317292858147269e-01, -3.288668296323680e-02, 6.525458535926403e-01, -3.242796038774610e-02, 2.871213312972326e-01, -4.138423907337264e-02, 8.094771064751569e-01, -4.144017280327973e-02, 2.352936079885358e-01, -2.329386894614118e-02, -3.244997983202259e-02, 6.494290408849395e-01, 2.906999693822082e-01, -3.075689471728817e-02, -4.144922972114938e-02,  8.057083220219335e-01, 3.207274258069200e-01, 2.717384601518612e-01, 2.689013054640074e-01, 2.723537934566936e-01,  4.174818304030909e-01, 3.470301411156525e-01, 3.433839664385438e-01, 3.469787562255482e-01, 2.694722527750937e-01,  7.471512512507388e-01, -3.998309210243748e-02, -2.937962590752766e-02, 3.459453415382959e-01, 9.605085157007514e-01, -4.997958057022634e-02, -3.837719918178716e-02, 2.666201543904284e-01, -3.997545870625360e-02, 7.542699808479522e-01, -3.985654756271848e-02, 3.422467411439453e-01, -4.995793647005935e-02, 9.684715894642062e-01, -5.067343506108334e-02,  2.706226707233065e-01, -2.938355609508370e-02, -3.988168487571803e-02, 7.508559703808806e-01, 3.460926592778305e-01, -3.835850981203182e-02, -5.068316435603848e-02, 9.639878801638447e-01, 1.961938416750559e-01, 1.642943479249557e-01,  1.626976732250897e-01, 1.653570985598214e-01, 2.372074189118870e-01, 1.988116771626297e-01, 1.968032424762090e-01,  1.999400751577074e-01, 1.651389165789972e-01, 4.456013456468269e-01, -1.950314176751517e-02, -1.195804601597548e-02,  1.988154142148103e-01, 5.452836023410921e-01, -2.575714422064735e-02, -1.715409907642115e-02, 1.639468843476760e-01, -1.966498141282285e-02, 4.502659433446767e-01, -1.869629268151719e-02, 1.968067982037530e-01, -2.575725978011939e-02,  5.508397919983988e-01, -2.499083971694320e-02, 1.663630588909774e-01, -1.192324647383292e-02, -1.850615991222303e-02,  4.478800768437149e-01, 1.999328340880160e-01, -1.716342066248844e-02, -2.499989628602664e-02, 5.480104104525821e-01,  2.136548323902574e-01, 1.789763122129693e-01, 1.771461932948355e-01, 1.801172252452827e-01, 2.789279316047464e-01,  2.353260705315461e-01, 2.328752826139653e-01, 2.361576634434183e-01, 1.789938380054120e-01, 4.897158088721442e-01, -2.471959395974100e-02, -1.614082511791189e-02, 2.341596642098652e-01, 6.461972052728826e-01, -3.287929305057652e-02, -2.327113313730579e-02, 1.776275919081857e-01, -2.490431359474649e-02, 4.951003590263270e-01, -2.393174314843214e-02,  2.317292858147375e-01, -3.288668296324275e-02, 6.525458535926596e-01, -3.242796038773797e-02, 1.805640270912011e-01, -1.610108190373650e-02, -2.372060923872457e-02, 4.928793769553970e-01, 2.352936079885611e-01, -2.329386894615350e-02, -3.244997983201083e-02, 6.494290408849734e-01, 1.641639606787455e-01, 1.373833711256313e-01, 1.365329252550137e-01,  1.378760834944368e-01, 1.806535277248395e-01, 1.505132078418543e-01, 1.494965741626817e-01, 1.514011706341059e-01,  1.373979848911303e-01, 3.587504627906302e-01, -9.914816738043956e-03, -4.344770978257396e-03, 1.505170179885737e-01,  4.011268245495563e-01, -1.478471609889726e-02, -8.096352776524485e-03, 1.367440874010775e-01, -9.993142955043754e-03,  3.618344849931657e-01, -9.116576827353732e-03, 1.495002064361586e-01, -1.478483230047318e-02, 4.049337486752072e-01, -1.378150303028362e-02, 1.378135342643116e-01, -4.215248654508744e-03, -8.915488937266026e-03, 3.594325077076551e-01,  1.513939117370379e-01, -8.105635195760429e-03, -1.379051907055160e-02, 4.025587896616599e-01, 1.551342339760958e-01,  1.297953193275863e-01, 1.286103793003586e-01, 1.307924473750972e-01, 1.961938416750477e-01, 1.642943479249482e-01,  1.626976732250818e-01, 1.653570985598174e-01, 1.304713737987760e-01, 3.463146231984295e-01, -1.285403481055952e-02, -6.365760417365834e-03, 1.651389165790094e-01, 4.456013456468380e-01, -1.950314176751731e-02, -1.195804601595749e-02,  1.297930338759808e-01, -1.305615585726615e-02, 3.502078693872598e-01, -1.188439919511884e-02, 1.639468843476709e-01, -1.966498141282674e-02, 4.502659433446771e-01, -1.869629268151256e-02, 1.315494877626751e-01, -6.186553779963733e-03, -1.151655528337766e-02, 3.482469585157513e-01, 1.663630588909684e-01, -1.192324647383667e-02, -1.850615991224009e-02,  4.478800768437063e-01, 1.816496769437473e-01, 1.525894049714947e-01, 1.519769045548317e-01, 1.516416553323277e-01,  1.734880022501727e-01, 1.442031691457340e-01, 1.435740708210045e-01, 1.439670467288027e-01, 1.521749757106086e-01,  3.861382483776872e-01, -3.459062579257807e-03, 9.085614290790106e-05, 1.442068779472346e-01, 3.714924874612859e-01, -6.623724874030887e-03, -1.927494526801667e-03, 1.517024831712596e-01, -3.514590642545619e-03, 3.877669652170506e-01, -3.305328078102035e-03, 1.435775760398043e-01, -6.623830268942393e-03, 3.738119905632248e-01, -5.952985398679797e-03,  1.515848936969529e-01, 4.651471654724612e-05, -3.300709123769400e-03, 3.843281715873988e-01, 1.439596746740670e-01, -1.936770987624482e-03, -5.962005834911493e-03, 3.710144526078921e-01, 1.479618027901533e-01, 1.241385767214108e-01,  1.234544687334694e-01, 1.242358562535234e-01, 1.641639606787364e-01, 1.373833711256178e-01, 1.365329252550183e-01,  1.378760834944404e-01, 1.238024901279129e-01, 3.165638188265892e-01, -4.854965773526259e-03, -4.026983810153095e-04,  1.373979848911227e-01, 3.587504627906182e-01, -9.914816738041263e-03, -4.344770978245288e-03, 1.234056451423864e-01, -4.968989166653107e-03, 3.189668937051129e-01,
                  -4.218829280024511e-03, 1.367440874010757e-01, -9.993142955046788e-03,  3.618344849931673e-01, -9.116576827355005e-03, 1.241559994464164e-01, -2.940832372654335e-04, -4.009718985733532e-03,  3.163365769083601e-01, 1.378135342642959e-01, -4.215248654522247e-03, -8.915488937281790e-03, 3.594325077076651e-01,  2.493880697353673e-01, 2.098823326500350e-01, 2.092523164573871e-01, 2.073677305522985e-01, 2.179873538322090e-01,  1.794857157459984e-01, 1.789392028685409e-01, 1.779612681201618e-01, 2.091280440510164e-01, 5.277952284487561e-01, -2.058059355648512e-04, 1.082861087486210e-03, 1.794893437851022e-01, 4.563326888158297e-01, -1.440302976199188e-03,  1.018043657609283e-03, 2.087646384428257e-01, -3.116991990464099e-04, 5.278798270391396e-01, -1.641712597384874e-03,  1.789425914515076e-01, -1.440393789865761e-03, 4.571884698152229e-01, -1.958759967817747e-03, 2.075417606079186e-01,  8.104866710042583e-04, -1.814383184314393e-03, 5.222173892354884e-01, 1.779540115567266e-01, 1.008688723459945e-03, -1.967873178480725e-03, 4.527534801531252e-01, 1.905701757719165e-01, 1.606724075509304e-01, 1.600769023060266e-01,  1.590125545160362e-01, 1.816496769437564e-01, 1.525894049715094e-01, 1.519769045548311e-01, 1.516416553323414e-01,  1.596567688321419e-01, 4.009774490854570e-01, -1.005128807932201e-04, 2.303647068915282e-03, 1.521749757106103e-01,  3.861382483777106e-01, -3.459062579248117e-03, 9.085614291448607e-05, 1.594052139014205e-01, -2.368107293440960e-04,  4.018895545811091e-01, -4.888713014614132e-04, 1.517024831712677e-01, -3.514590642550403e-03, 3.877669652170371e-01, -3.305328078096054e-03, 1.590980477790414e-01, 2.074529372914399e-03, -5.947408938573873e-04, 3.976859906454933e-01,  1.515848936969504e-01, 4.651471654531364e-05, -3.300709123768522e-03, 3.843281715874034e-01, 3.667229748568449e-01,  3.092953049144894e-01, 3.087023507881508e-01, 3.056206990287667e-01, 3.120853218526688e-01, 2.570468366810152e-01,  2.565736316938377e-01, 2.544415325691768e-01, 3.083838860694359e-01, 7.837628528129617e-01, -2.379799895394167e-04, -1.540637324004217e-03, 2.570503651815181e-01, 6.554290821370882e-01, 4.291204154778828e-04, 3.736412526240407e-04,  3.085246393977439e-01, -5.302698744618899e-04, 7.819043657062977e-01, -4.484337698611528e-03, 2.565771411362018e-01,  4.289416472136702e-04, 6.546088178835482e-01, -2.283655933039148e-03, 3.056646157796584e-01, -1.823896961983099e-03, -4.481190999774804e-03, 7.729870766786356e-01, 2.544340925647695e-01, 3.643185699173362e-04, -2.292648878207538e-03,  6.472606279582669e-01, 2.832020661519262e-01, 2.393152350705689e-01, 2.386029798904113e-01, 2.358089684997740e-01,  2.493880697353589e-01, 2.098823326500134e-01, 2.092523164574136e-01, 2.073677305522865e-01, 2.377502860740788e-01,  5.996629112760449e-01, 1.433959550660026e-03, 1.554110951233006e-03, 2.091280440510027e-01, 5.277952284487051e-01, -2.058059355619889e-04, 1.082861087481707e-03, 2.379034372491185e-01, 1.089769027070780e-03, 5.988429413600762e-01, -1.051467132042988e-03, 2.087646384428341e-01, -3.116991990601090e-04, 5.278798270392149e-01, -1.641712597397094e-03,  2.360501353306745e-01, 1.043199826965501e-03, -1.230542237883284e-03, 5.921122305458479e-01, 2.075417606078996e-01,  8.104866709962612e-04, -1.814383184309099e-03, 5.222173892354685e-01, 5.343782181565143e-01, 4.505088663504444e-01,  4.506208612825272e-01, 4.457214898802868e-01, 4.512375759364031e-01, 3.786172006757945e-01, 3.787456352777396e-01,  3.748903653721177e-01, 4.501622448624902e-01, 1.153967470278368e+00, -3.875439842961742e-03, -7.711653454576745e-03,  3.786207010116965e-01, 9.681253539268777e-01, -1.887519791601632e-03, -4.418970440670276e-03, 4.508452573887098e-01, -4.103075385041089e-03, 1.149664977739528e+00, -1.162268365966710e-02, 3.787495771624408e-01, -1.887882618567493e-03,  9.649879469087432e-01, -7.701073712748327e-03, 4.454366097570100e-01, -7.637812877709804e-03, -1.132766114328729e-02,  1.137001601020949e+00, 3.748816885203479e-01, -4.427812482961768e-03, -7.709402503485719e-03, 9.540784611808183e-01,  4.258975821175742e-01, 3.597323469199927e-01, 3.590220207227077e-01, 3.549856022442689e-01, 3.667229748568316e-01,  3.092953049144943e-01, 3.087023507881451e-01, 3.056206990287886e-01, 3.583943499898087e-01, 9.126244698076544e-01, -3.775684373332551e-04, -2.925885963869168e-03, 3.083838860694403e-01, 7.837628528129829e-01, -2.379799895273263e-04, -1.540637323985732e-03, 3.589887019318197e-01, -8.972484045996964e-04, 9.097910104536268e-01, -6.091860908141775e-03,  3.085246393977160e-01, -5.302698744627018e-04, 7.819043657062571e-01, -4.484337698602056e-03, 3.548227752103019e-01, -3.184764174675084e-03, -5.843469941077740e-03, 8.995418083090398e-01, 3.056646157796403e-01, -1.823896961981719e-03, -4.481190999776039e-03, 7.729870766786499e-01, 7.530493438826431e-01, 6.341171833330917e-01, 6.349797357917304e-01,  6.270443225941373e-01, 6.445593475891770e-01, 5.412467411159360e-01, 5.420227194970435e-01, 5.353709307017678e-01,  6.331153153687052e-01, 1.638601847193514e+00, -1.067991641483686e-02, -1.675207918779261e-02, 5.412513892425582e-01,  1.395326234970980e+00, -7.294666110529682e-03, -1.206367333905526e-02, 6.339557402500380e-01, -1.067040805383061e-02,  1.631771061623474e+00, -2.220970574401837e-02, 5.420239544887796e-01, -7.293490894416246e-03, 1.389617816746488e+00, -1.672032549251757e-02, 6.260780783086353e-01, -1.666822302701307e-02, -2.214219597091729e-02, 1.614714479500285e+00,  5.353706325151459e-01, -1.207540347248699e-02, -1.673307930336024e-02, 1.374896144657002e+00, 6.182335433318457e-01,  5.221151899069767e-01, 5.222111199771142e-01, 5.162668243702396e-01, 5.343782181565389e-01, 4.505088663504638e-01,  4.506208612825355e-01, 4.457214898803224e-01, 5.208954400358589e-01, 1.340132253688530e+00, -5.541065606974887e-03, -1.068111640484945e-02, 4.501622448624969e-01, 1.153967470278380e+00, -3.875439842966203e-03, -7.711653454577489e-03,  5.216390061766620e-01, -5.798497511129925e-03, 1.334861046237574e+00, -1.502371131082857e-02, 4.508452573887021e-01, -4.103075385049748e-03, 1.149664977739518e+00, -1.162268365966386e-02, 5.151562844430603e-01, -1.051435997638240e-02, -1.461290292948431e-02, 1.320258666629701e+00, 4.454366097569868e-01, -7.637812877729085e-03, -1.132766114331316e-02,  1.137001601020944e+00, 1.011043780241759e+00, 8.632808019801584e-01, 8.644513302164909e-01, 8.533474646334474e-01,  8.807567754626032e-01, 7.481421203442523e-01, 7.492017119397943e-01, 7.395821221476544e-01, 8.622542245669135e-01,  2.236270086625150e+00, -2.185469946933693e-02, -3.029912968519052e-02, 7.481733643138505e-01, 1.936264592619820e+00, -1.639899114479164e-02, -2.352580295741576e-02, 8.632702385936344e-01, -2.179232554124972e-02, 2.226860069269359e+00, -3.804425096541100e-02, 7.491069258677659e-01, -1.634887779653862e-02, 1.928102381602325e+00, -3.009753519993195e-02,  8.526065221405247e-01, -3.031510105351404e-02, -3.812938599739779e-02, 2.204488999994712e+00, 7.398424911747721e-01, -2.363096611031093e-02, -3.025261432741130e-02, 1.908467197004145e+00, 8.614663352512979e-01, 7.270168211586903e-01,  7.279659095056767e-01, 7.187469524384343e-01, 7.530493438826413e-01, 6.341171833330483e-01,
                  6.349797357917800e-01,  6.270443225941262e-01, 7.249683395860596e-01, 1.881881937876019e+00, -1.406081685686783e-02, -2.143612872078295e-02,  6.331153153686644e-01, 1.638601847193438e+00, -1.067991641483926e-02, -1.675207918782048e-02, 7.258839903630555e-01, -1.404591022160160e-02, 1.873925843540202e+00, -2.769767702545259e-02, 6.339557402500702e-01, -1.067040805382142e-02,  1.631771061623549e+00, -2.220970574402034e-02, 7.167584885798892e-01, -2.125025215988663e-02, -2.754053833396614e-02,  1.854543749226220e+00, 6.260780783086308e-01, -1.666822302700238e-02, -2.214219597089206e-02, 1.614714479500239e+00 ))

  expect_equal(c(res$Q),
               c( 0.16869948190492851, -0.06734943368160234, -0.06726104633973248, -0.06745480290999870, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, -0.06734943368160234, 0.02688889021654985, 0.02685260316885123, 0.02692995652566269,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, -0.06726104633973248, 0.02685260316885123,  0.02681836265759394, 0.02689461448473386, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, -0.06745480290999870, 0.02692995652566269, 0.02689461448473386, 0.02697308884673862, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000 ))

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0,  0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10 ))
})

#########
# With estimating Q_0 and second order

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = a_0,
                    Q_0 = Q_0,
                    Q = Q,
                    F_= F_, # first order random walk
                    risk_sets = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 2,
                    est_Q_0 = T)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 2 and Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 1.233458243772930e-03, 1.017724869918139e-03, 1.013004093233540e-03, 1.028304878075202e-03, 1.440036400119907e-03,  1.187986272066257e-03, 1.182795569308629e-03, 1.199647764422507e-03, 1.017724869916865e-03, 2.605598862215230e-03, -4.221365471618697e-05, 9.075654161347678e-06, 1.187891065249375e-03, 3.040141833749236e-03, -4.687939623128418e-05,  1.053557361346122e-05, 1.013004093235372e-03, -4.221365471365347e-05, 2.634670321233117e-03, -2.887479617374188e-05,  1.182750656551625e-03, -4.689907972905059e-05, 3.073819400942717e-03, -3.306064999085596e-05, 1.028304878074673e-03,  9.075654162022110e-06, -2.887479617580886e-05, 2.617066948120128e-03, 1.199584751490657e-03, 1.050113243983561e-05, -3.306280264671271e-05, 3.053302186011860e-03, 1.440036400119913e-03, 1.187891065250779e-03, 1.182750656549501e-03,  1.199584751491336e-03, 1.689612683014491e-03, 1.393238064688459e-03, 1.387673552860995e-03, 1.406089959466186e-03,  1.187986272064851e-03, 3.040141833749235e-03, -4.689907973189724e-05, 1.050113243914145e-05, 1.393238064686899e-03,  3.564143508538313e-03, -5.182493652121007e-05, 1.230860028925570e-05, 1.182795569310751e-03, -4.687939622843891e-05,  3.073819400942717e-03, -3.306280264423087e-05, 1.387673552863457e-03, -5.182493651801031e-05, 3.603317260010407e-03, -3.779949194165292e-05, 1.199647764421840e-03, 1.053557361415037e-05, -3.306064999334181e-05, 3.053302186011857e-03,  1.406089959465320e-03, 1.230860028993658e-05, -3.779949194466351e-05, 3.579277330743294e-03, 1.915024064529351e-03,  2.963244633655203e-04, 2.905804634559799e-04, 2.991875228297350e-04, 1.019441987869414e-03, 8.524988641389193e-04,  8.470880353272913e-04, 8.612845372499706e-04, 2.963244633644812e-04, 1.991710572579604e-03, 1.324101098016210e-04,  1.735108365656560e-04, 8.504202324050209e-04, 2.169092464609676e-03, -3.905086707614979e-05, 5.957009232152366e-06,  2.905804634572909e-04, 1.324101098035839e-04, 2.014008963128898e-03, 1.467051512874044e-04, 8.461768663173554e-04, -3.951662039217739e-05, 2.193995053733817e-03, -2.638423120646593e-05, 2.991875228294575e-04, 1.735108365662904e-04,  1.467051512860683e-04, 2.004532152789952e-03, 8.599543053368700e-04, 5.628401290593963e-06, -2.622986325772563e-05,  2.179118486833252e-03, 1.019441987869410e-03, 8.504202324061733e-04, 8.461768663158153e-04, 8.599543053372609e-04,  1.233458243772929e-03, 1.017724869918139e-03, 1.013004093233540e-03, 1.028304878075201e-03, 8.524988641377624e-04,  2.169092464609679e-03, -3.951662039440105e-05, 5.628401289933012e-06, 1.017724869916864e-03, 2.605598862215230e-03, -4.221365471618706e-05, 9.075654161347641e-06, 8.470880353288271e-04, -3.905086707392102e-05, 2.193995053733820e-03, -2.622986325607977e-05, 1.013004093235372e-03, -4.221365471365357e-05, 2.634670321233117e-03, -2.887479617374194e-05,  8.612845372495835e-04, 5.957009232816144e-06, -2.638423120811018e-05, 2.179118486833252e-03, 1.028304878074673e-03,  9.075654162022073e-06, -2.887479617580891e-05, 2.617066948120128e-03, 3.578130917979231e-03, -7.124542533075224e-04, -7.185288293809664e-04, -7.204132368970338e-04, 7.090868267226450e-04, 5.749064845414259e-04, 5.712228794140643e-04,  5.821317472044444e-04, -7.124542533083550e-04, 1.702941918394289e-03, 4.495324461981371e-04, 4.832029811942646e-04,  5.755093423953398e-04, 1.483337046560264e-03, -2.807022195364711e-05, 6.016000257567294e-06, -7.185288293800755e-04,  4.495324461995972e-04, 1.719750072152285e-03, 4.654962929132637e-04, 5.715429899740110e-04, -2.795682007402802e-05,  1.500775778197854e-03, -1.658454513866798e-05, -7.204132368971277e-04, 4.832029811948129e-04, 4.654962929124710e-04,  1.720282597535402e-03, 5.824894263911015e-04, 6.095153905179271e-06, -1.660750113915925e-05, 1.490537772422310e-03,  7.090868267226250e-04, 5.755093423962703e-04, 5.715429899729303e-04, 5.824894263912734e-04, 1.915024064529336e-03,  2.963244633655205e-04, 2.905804634559791e-04, 2.991875228297442e-04, 5.749064845404608e-04, 1.483337046560283e-03, -2.795682007571377e-05, 6.095153904586263e-06, 2.963244633644813e-04, 1.991710572579606e-03, 1.324101098016237e-04,  1.735108365656547e-04, 5.712228794151422e-04, -2.807022195193918e-05, 1.500775778197858e-03, -1.660750113813194e-05,  2.905804634572900e-04, 1.324101098035866e-04, 2.014008963128901e-03, 1.467051512874035e-04, 5.821317472042846e-04,  6.016000258177100e-06, -1.658454513969365e-05, 1.490537772422310e-03, 2.991875228294667e-04, 1.735108365662891e-04,  1.467051512860674e-04, 2.004532152789948e-03, 5.822484758104914e-04, 2.392617140781205e-04, 2.378884091269977e-04,  2.430145937929748e-04, 4.608974207814133e-04, 3.810997339699139e-04, 3.795161486925119e-04, 3.867171040979880e-04,  2.392617140775149e-04, 8.457724258903871e-04, 1.193985648849737e-05, 3.245212395066558e-05, 3.797453194339419e-04,  9.758864953234190e-04, -2.226079966899661e-05, 2.316538946646679e-06, 2.378884091275378e-04, 1.193985648952310e-05,  8.548952328921277e-04, 2.004342766579628e-05, 3.772925498087305e-04, -2.191625549081633e-05, 9.870421811801059e-04, -1.281488798254441e-05, 2.430145937929853e-04, 3.245212395110784e-05, 2.004342766541085e-05, 8.502348340807788e-04,  3.852004660625428e-04, 2.353365623002195e-06, -1.311419877237421e-05, 9.805186762676622e-04, 4.608974207813836e-04,  3.797453194346465e-04, 3.772925498080301e-04, 3.852004660625732e-04, 3.578130917979274e-03, -7.124542533075216e-04, -7.185288293809754e-04, -7.204132368970590e-04, 3.810997339691959e-04, 9.758864953234310e-04, -2.191625549203709e-05,  2.353365622506884e-06, -7.124542533083543e-04, 1.702941918394282e-03, 4.495324461981335e-04, 4.832029811942674e-04,  3.795161486931921e-04, -2.226079966775228e-05, 9.870421811801180e-04, -1.311419877180838e-05, -7.185288293800845e-04,  4.495324461995936e-04, 1.719750072152285e-03, 4.654962929132704e-04, 3.867171040979524e-04, 2.316538947159853e-06, -1.281488798309270e-05, 9.805186762676694e-04, -7.204132368971529e-04, 4.832029811948157e-04, 4.654962929124778e-04,  1.720282597535416e-03, 7.179438667252730e-04, 5.184352975598371e-05, 5.091773509840969e-05, 5.248877220293985e-05,  3.072951812624667e-04, 2.545724765980878e-04, 2.536474161916896e-04, 2.582199929285608e-04, 5.184352975559287e-05,  6.557495586608319e-04, 5.691022959721464e-05, 6.970591254280313e-05, 2.549550832315598e-04, 6.537281030730162e-04, -1.588172845417359e-05, -1.252124900683872e-08, 5.091773509869382e-05, 5.691022959786846e-05, 6.623768675527851e-04,  6.252743375462115e-05, 2.541901151672865e-04, -1.594458292162652e-05, 6.609131011387257e-04, -9.520446532651531e-06,  5.248877220300778e-05, 6.970591254314130e-05, 6.252743375453890e-05, 6.598301992410910e-04, 2.587367369515972e-04, -8.520433062159712e-08, -9.517249872621951e-06, 6.566340693148629e-04, 3.072951812624460e-04, 2.549550832320495e-04,  2.541901151668834e-04, 2.587367369515362e-04, 5.822484758104921e-04, 2.392617140781201e-04, 2.378884091269979e-04,  2.430145937929749e-04, 2.545724765976160e-04, 6.537281030730143e-04, -1.594458292244737e-05, -8.520433100734221e-08,  2.392617140775145e-04, 8.457724258903874e-04, 1.193985648849733e-05, 3.245212395066558e-05, 2.536474161920867e-04, -1.588172845334975e-05, 6.609131011387310e-04,
                  -9.517249872407842e-06, 2.378884091275380e-04, 1.193985648952306e-05,  8.548952328921275e-04, 2.004342766579607e-05, 2.582199929285837e-04, -1.252124860575041e-08, -9.520446532843521e-06,  6.566340693148818e-04, 2.430145937929854e-04, 3.245212395110784e-05, 2.004342766541064e-05, 8.502348340807786e-04,  2.791370850395548e-03, -7.974273526260707e-04, -7.996846373410009e-04, -8.085126757126032e-04, 2.465169679089631e-04,  1.992642910228702e-04, 1.991192179521109e-04, 2.011667574034572e-04, -7.974273526262828e-04, 9.443704134287522e-04,  3.929907576651342e-04, 4.020238232634958e-04, 1.997407118453033e-04, 5.184305083385008e-04, -9.946673566543603e-06, -1.586913257561162e-06, -7.996846373408890e-04, 3.929907576655022e-04, 9.517017266280375e-04, 3.990038533851485e-04,  1.997001702021488e-04, -9.987349337785920e-06, 5.237728576499832e-04, -6.868323946722511e-06, -8.085126757124775e-04,  4.020238232637223e-04, 3.990038533852352e-04, 9.555728284938564e-04, 2.015976415545970e-04, -1.587728290110074e-06, -6.815523515461987e-06, 5.202437758914149e-04, 2.465169679089775e-04, 1.997407118455987e-04, 1.997001702019644e-04,  2.015976415544692e-04, 7.179438667252745e-04, 5.184352975598256e-05, 5.091773509840946e-05, 5.248877220293915e-05,  1.992642910226044e-04, 5.184305083384887e-04, -9.987349338279044e-06, -1.587728290395471e-06, 5.184352975559172e-05,  6.557495586608325e-04, 5.691022959721494e-05, 6.970591254280363e-05, 1.991192179522890e-04, -9.946673566063056e-06,  5.237728576499833e-04, -6.815523515495836e-06, 5.091773509869359e-05, 5.691022959786877e-05, 6.623768675527850e-04,  6.252743375462127e-05, 2.011667574035806e-04, -1.586913257290097e-06, -6.868323946690967e-06, 5.202437758914144e-04,  5.248877220300708e-05, 6.970591254314180e-05, 6.252743375453902e-05, 6.598301992410913e-04, 9.893180668157550e-03, -3.536294432360828e-03, -3.544463541434492e-03, -3.582530462919765e-03, 3.684687695545010e-04, 1.802424509957383e-04,  1.811262705177032e-04, 1.800907522417217e-04, -3.536294432360956e-03, 2.201653828515341e-03, 1.509345879843530e-03,  1.523337665663660e-03, 1.805752371083744e-04, 5.853034651524693e-04, 8.836035798017526e-06, 1.114157478529544e-05, -3.544463541434483e-03, 1.509345879843705e-03, 2.215102924992434e-03, 1.524525473053766e-03, 1.811954983394819e-04,  8.941532455930026e-06, 5.905050598639524e-04, 8.321871711894459e-06, -3.582530462919678e-03, 1.523337665663795e-03,  1.524525473053890e-03, 2.239299921053243e-03, 1.802347020304695e-04, 1.119703520261352e-05, 8.283160309029457e-06,  5.868558360353394e-04, 3.684687695544844e-04, 1.805752371085445e-04, 1.811954983394489e-04, 1.802347020303533e-04,  2.791370850395557e-03, -7.974273526260677e-04, -7.996846373409986e-04, -8.085126757126013e-04, 1.802424509955698e-04,  5.853034651524727e-04, 8.941532455691925e-06, 1.119703520244820e-05, -7.974273526262799e-04, 9.443704134287486e-04,  3.929907576651308e-04, 4.020238232634926e-04, 1.811262705177260e-04, 8.836035798265182e-06, 5.905050598639590e-04,  8.283160308893457e-06, -7.996846373408867e-04, 3.929907576654988e-04, 9.517017266280343e-04, 3.990038533851454e-04,  1.800907522418237e-04, 1.114157478547125e-05, 8.321871712043432e-06, 5.868558360353478e-04, -8.085126757124755e-04,  4.020238232637191e-04, 3.990038533852322e-04, 9.555728284938535e-04, 7.437906484188137e-04, 2.959466177085275e-04,  2.985056191831949e-04, 2.927041824031911e-04, 3.890039939360209e-04, 3.120958847570339e-04, 3.143469082508758e-04,  3.108513296195640e-04, 2.959466177084707e-04, 1.065957549213036e-03, 3.392416897536032e-05, 2.965338779643653e-05,  3.111993177505305e-04, 8.107906846813411e-04, -5.095794120285398e-06, -7.859703347939971e-06, 2.985056191831990e-04,  3.392416897542530e-05, 1.074029018341249e-03, 2.655462913272154e-05, 3.130904083345890e-04, -4.953222386438051e-06,  8.172334496557159e-04, -1.026024588058890e-05, 2.927041824032543e-04, 2.965338779650516e-05, 2.655462913279439e-05,  1.068112201971342e-03, 3.097860950466206e-04, -7.818133381458029e-06, -1.035040355115972e-05, 8.118268343366910e-04,  3.890039939360265e-04, 3.111993177506081e-04, 3.130904083345871e-04, 3.097860950465379e-04, 9.893180668157274e-03, -3.536294432360676e-03, -3.544463541434511e-03, -3.582530462919689e-03, 3.120958847569501e-04, 8.107906846813431e-04, -4.953222386539510e-06, -7.818133381552197e-06, -3.536294432360804e-03, 2.201653828515264e-03, 1.509345879843521e-03,  1.523337665663612e-03, 3.143469082508851e-04, -5.095794120185725e-06, 8.172334496557123e-04, -1.035040355126873e-05, -3.544463541434502e-03, 1.509345879843696e-03, 2.215102924992494e-03, 1.524525473053787e-03, 3.108513296196531e-04, -7.859703347847607e-06, -1.026024588048735e-05, 8.118268343366872e-04, -3.582530462919602e-03, 1.523337665663747e-03,  1.524525473053912e-03, 2.239299921053226e-03, 1.199866388775254e-03, 4.188346545264380e-04, 4.233819920795215e-04,  4.137072077153615e-04, 5.819299844664140e-04, 4.842296852914253e-04, 4.884323399300843e-04, 4.819745573223482e-04,  4.188346545264245e-04, 1.627049912099551e-03, 6.460773025039073e-05, 5.767746713305953e-05, 4.851653549073267e-04,  1.240216844335690e-03, -8.492287110839834e-06, -1.490064677856548e-05, 4.233819920795122e-04, 6.460773025041052e-05,  1.638441188195334e-03, 5.200420261538862e-05, 4.885512745016224e-04, -8.166294362783663e-06, 1.249323759814680e-03, -1.877315959486267e-05, 4.137072077153768e-04, 5.767746713308463e-05, 5.200420261540645e-05, 1.630181026360173e-03,  4.823932305082904e-04, -1.471186269701725e-05, -1.890135649062629e-05, 1.241384616857129e-03, 5.819299844664100e-04,  4.851653549073593e-04, 4.885512745016273e-04, 4.823932305082577e-04, 7.437906484188140e-04, 2.959466177085282e-04,  2.985056191831952e-04, 2.927041824031917e-04, 4.842296852914002e-04, 1.240216844335688e-03, -8.166294362817314e-06, -1.471186269706577e-05, 2.959466177084715e-04, 1.065957549213035e-03, 3.392416897535986e-05, 2.965338779643596e-05,  4.884323399300677e-04, -8.492287110803156e-06, 1.249323759814686e-03, -1.890135649066033e-05, 2.985056191831994e-04,  3.392416897542484e-05, 1.074029018341249e-03, 2.655462913272113e-05, 4.819745573223798e-04, -1.490064677851835e-05, -1.877315959482215e-05, 1.241384616857130e-03, 2.927041824032549e-04, 2.965338779650460e-05, 2.655462913279398e-05,  1.068112201971342e-03, 3.221560948534802e-03, 2.888707645742837e-05, 3.420564395346039e-05, 1.532742068810182e-05,  8.763678040805785e-04, 7.254356226881875e-04, 7.318574805493353e-04, 7.225694761871759e-04, 2.888707645742837e-05,  2.616363154904576e-03, 3.278598802396802e-04, 3.216261848847510e-04, 7.276622793820471e-04, 1.865641291818067e-03, -1.114300470124713e-05, -2.000961670681096e-05, 3.420564395346039e-05, 3.278598802396802e-04, 2.633768952284947e-03,  3.120584715483406e-04, 7.334999065454076e-04, -1.090813543264763e-05, 1.878658171673116e-03, -2.754586493872607e-05,  1.532742068810182e-05, 3.216261848847510e-04, 3.120584715483406e-04, 2.626267178342329e-03, 7.241600583291085e-04, -1.976732968159110e-05, -2.752820497844630e-05, 1.867096960946724e-03, 8.763678040805786e-04, 7.276622793820470e-04,  7.334999065454076e-04, 7.241600583291084e-04, 1.199866388775250e-03, 4.188346545264348e-04,
                  4.233819920795204e-04,  4.137072077153630e-04, 7.254356226881875e-04, 1.865641291818067e-03, -1.090813543264770e-05, -1.976732968159110e-05,  4.188346545264212e-04, 1.627049912099554e-03, 6.460773025039306e-05, 5.767746713306087e-05, 7.318574805493354e-04, -1.114300470124719e-05, 1.878658171673116e-03, -2.752820497844628e-05, 4.233819920795111e-04, 6.460773025041285e-05,  1.638441188195336e-03, 5.200420261538910e-05, 7.225694761871761e-04, -2.000961670681110e-05, -2.754586493872603e-05,  1.867096960946724e-03, 4.137072077153782e-04, 5.767746713308597e-05, 5.200420261540692e-05, 1.630181026360173e-03,  2.367664350240604e-02, -7.576410876535160e-03, -7.589218595999587e-03, -7.686580841827408e-03, 1.353222774976965e-03,  1.005624357672242e-03, 1.013841984216976e-03, 1.001304719283405e-03, -7.576410876535160e-03, 6.699500071962917e-03,  3.494331844140317e-03, 3.517563931756369e-03, 1.007227987962396e-03, 2.701064475683563e-03, -7.513137137526795e-07, -1.067158469412125e-05, -7.589218595999587e-03, 3.494331844140317e-03, 6.739670844376073e-03, 3.509887644738321e-03,  1.015675453824218e-03, -8.406650885974215e-07, 2.719814114438703e-03, -2.374844932204434e-05, -7.686580841827408e-03,  3.517563931756369e-03, 3.509887644738321e-03, 6.787233086070084e-03, 1.003104226082561e-03, -1.076297644178332e-05, -2.373719403488502e-05, 2.703649411818415e-03, 1.353222774976965e-03, 1.007227987962396e-03, 1.015675453824218e-03,  1.003104226082561e-03, 3.221560948534776e-03, 2.888707645738632e-05, 3.420564395345439e-05, 1.532742068804937e-05,  1.005624357672242e-03, 2.701064475683563e-03, -8.406650885974215e-07, -1.076297644178332e-05, 2.888707645738632e-05,  2.616363154904614e-03, 3.278598802397036e-04, 3.216261848847930e-04, 1.013841984216976e-03, -7.513137137526795e-07,  2.719814114438703e-03, -2.373719403488502e-05, 3.420564395345439e-05, 3.278598802397036e-04, 2.633768952284956e-03,  3.120584715483682e-04, 1.001304719283405e-03, -1.067158469412125e-05, -2.374844932204434e-05, 2.703649411818415e-03,  1.532742068804937e-05, 3.216261848847930e-04, 3.120584715483682e-04, 2.626267178342376e-03 ))

  expect_equal(c(res$a_t_d_s),
               c(-1.3754067795394525, -1.6505047449872141, -0.3732848769586986, -0.2348019878981554, -0.7610793038931566, -1.4053064024448521, -0.2029880587776106, 0.1585192064439372, -0.1773357650055555, -1.0760623040834991, -1.6920929787625179, 0.5420036028861241,  1.0530277166050368, 0.9469946456862127, 1.2936074516910390, 1.9044609657239555, 2.5621966460807437, 2.4859228284196613,  2.7438715063004917, 3.2790229495686254, 4.0379173125554200, 4.6844393737685532, 1.7246901683542100, 1.8893441819817234,  1.4353836531776476, 1.4352145495366151, 1.6999560797186066, 2.0117001942373784, 1.5875814186285926, 1.4985304623007365,  1.6873828046252826, 2.1005432858487678, 2.4010474524591081, 1.4872468526562701, 1.6974343928224218, 1.2831506745790799,  1.3269546368954823, 1.6381769541161009, 1.9968475588478019, 1.6126899859179922, 1.5667739613290563, 1.8013932966158879,  2.2624448815383822, 2.6097737522432172, -1.4039242399942329, -1.3754067795394542, -1.6505047449872086, -0.3732848769586946, -0.2348019878981549, -0.7610793038931565, -1.4053064024448536, -0.2029880587776164, 0.1585192064439374, -0.1773357650055566, -1.0760623040834982, 0.1516590953673636, 0.5420036028861236, 1.0530277166050388, 0.9469946456862145, 1.2936074516910385,  1.9044609657239553, 2.5621966460807419, 2.4859228284196653, 2.7438715063004926, 3.2790229495686232, 4.0379173125554235,  1.6810228744238633, 1.7246901683542095, 1.8893441819817263, 1.4353836531776476, 1.4352145495366155, 1.6999560797186066,  2.0117001942373771, 1.5875814186285893, 1.4985304623007369, 1.6873828046252815, 2.1005432858487687, 1.3991915791255509,  1.4872468526562703, 1.6974343928224174, 1.2831506745790768, 1.3269546368954828, 1.6381769541161009, 1.9968475588478005,  1.6126899859179931, 1.5667739613290572, 1.8013932966158883, 2.2624448815383862 ))

  expect_equal(c(res$B_s),
               c(-1.243449787580175e-14, 4.427014310692812e-15, -5.551115123125783e-15, -1.065814103640150e-14, -3.098438641499861e-01, -2.589590418804359e-01, -2.597984136950081e-01, -2.621125646107565e-01, 5.329070518200751e-15, 2.045585922871851e-14,  3.247402347028583e-15, 3.552713678800501e-15, -2.578265436268659e-01, -8.477460292796009e-01, 9.738495098365885e-02,  9.830766213667985e-02, -7.105427357601002e-15, -5.301314942585122e-15, -1.504352198367087e-14, -3.552713678800501e-15, -2.590309219781624e-01, 9.746483004507335e-02, -8.478326966446337e-01, 9.883060407584310e-02, -1.421085471520200e-14,  4.996003610813204e-16, 1.332267629550188e-15, -2.842170943040401e-14, -2.588525552651006e-01, 9.739890359640285e-02,  9.783718855600365e-02, -8.466119078784118e-01, 9.999999999999858e-01, -1.884603584301203e-14, -2.053912595556540e-15,  7.105427357601002e-15, 1.448521767525392e+00, 2.060564848510365e-01, 2.070198080186508e-01, 2.087491250213418e-01, -2.214894934127187e-14, 9.999999999999631e-01, -2.961172973492410e-15, -4.440892098500626e-15, 2.053845369977567e-01,  1.877025839258051e+00, -7.731154618153571e-02, -7.805148113076998e-02, 2.775557561562891e-16, -1.534362914501486e-15,  1.000000000000031e+00, -2.609024107869118e-15, 2.064537216847212e-01, -7.729889071898519e-02, 1.876964044767208e+00, -7.849855405517769e-02, 7.105427357601002e-15, 1.998401444325282e-15, -2.220446049250313e-16, 1.000000000000000e+00,  2.062598068045531e-01, -7.727725523363593e-02, -7.773270029242574e-02, 1.876042679341026e+00, 2.220446049250313e-15,  4.662936703425657e-15, 3.219646771412954e-15, -3.552713678800501e-15, -3.124415673240497e-01, -2.628262264113780e-01, -2.636153088250919e-01, -2.659956475646101e-01, 3.774758283725532e-15, 2.053912595556540e-14, -4.440892098500626e-16, -3.552713678800501e-15, -2.586416627838197e-01, -8.634918527060935e-01, 9.948612396650525e-02, 1.004932076444813e-01,  8.215650382226158e-15, -8.881784197001252e-16, 1.043609643147647e-14, 1.776356839400250e-15, -2.621945934444376e-01,  1.005447933994947e-01, -8.623493918462098e-01, 1.019262399942384e-01, 2.664535259100376e-15, -4.440892098500626e-15,  2.664535259100376e-15, -1.421085471520200e-14, -2.613429746617513e-01, 1.002825127041505e-01, 1.006423583004540e-01, -8.615018952451976e-01, 9.999999999999996e-01, -3.996802888650564e-15, -1.221245327087672e-15, 1.776356839400250e-15,  6.373942413066165e-01, 5.331436882940729e-01, 5.345941334277902e-01, 5.395510361835498e-01, -4.884981308350689e-15,  9.999999999999805e-01, 2.109423746787797e-15, -1.776356839400250e-15, 5.302584757936861e-01, 1.761867853236233e+00, -2.083690202789469e-01, -2.104298595529368e-01, -7.993605777301127e-15, 2.331468351712829e-15, 9.999999999999913e-01, -1.776356839400250e-15, 5.327566204134881e-01, -2.087521514332387e-01, 1.760769504165201e+00, -2.114280739767480e-01,  1.776356839400250e-15, -1.332267629550188e-15, -1.776356839400250e-15, 1.000000000000000e+00, 5.326537209276587e-01, -2.088132198578853e-01, -2.094184460135980e-01, 1.758641013877586e+00, 2.220446049250313e-15, 6.661338147750939e-16,  2.220446049250313e-16, 8.881784197001252e-16, -3.184716285774516e-01, -2.639934511543353e-01, -2.647427344477780e-01, -2.671612340103016e-01, -1.332267629550188e-15, -6.661338147750939e-16, -8.881784197001252e-16, -8.881784197001252e-16, -2.651136994535870e-01, -8.724429591165886e-01, 1.032911812167409e-01, 1.043550626430099e-01, 7.105427357601002e-15, -1.554312234475219e-15, -3.774758283725532e-15, -8.881784197001252e-16, -2.643982492337453e-01, 1.026789148467427e-01, -8.728018002011686e-01, 1.040596213062495e-01, -8.881784197001252e-15, 0.000000000000000e+00, 5.329070518200751e-15,  1.065814103640150e-14, -2.649858240796821e-01, 1.030111373426617e-01, 1.033309319930384e-01, -8.714424987358598e-01,  1.000000000000000e+00, -3.330669073875470e-15, -3.996802888650564e-15, -2.664535259100376e-15, 6.452356150890572e-01,  5.330381098349011e-01, 5.344503769612478e-01, 5.394347528330528e-01, 4.440892098500626e-16, 9.999999999999967e-01, -1.110223024625157e-15, 0.000000000000000e+00, 5.353478590480236e-01, 1.769583276625702e+00, -2.114433704260648e-01, -2.135328581227398e-01, -9.769962616701378e-15, 1.332267629550188e-15, 9.999999999999947e-01, 0.000000000000000e+00,  5.337495460854862e-01, -2.102211275588436e-01, 1.769951590474646e+00, -2.128820840781858e-01, 3.552713678800501e-15,  8.881784197001252e-16, -2.664535259100376e-15, 1.000000000000004e+00, 5.350245807770611e-01, -2.108284940492351e-01, -2.114069590038704e-01, 1.767327345882808e+00, 5.551115123125783e-16, 1.110223024625157e-16, -4.857225732735060e-17,  0.000000000000000e+00, -3.216547316654971e-01, -2.651214271321903e-01, -2.658424638951536e-01, -2.682995162870481e-01,  3.330669073875470e-16, 1.373900992973631e-15, -1.450228825916611e-15, -4.440892098500626e-16, -2.659649432009143e-01, -8.797829087140019e-01, 1.044423778572323e-01, 1.054973929577785e-01, 4.440892098500626e-16, -9.714451465470120e-17, -7.632783294297951e-16, -8.881784197001252e-16, -2.653567193013810e-01, 1.038943279079499e-01, -8.799783325948043e-01,  1.052544653366221e-01, -1.332267629550188e-15, 3.330669073875470e-16, 1.387778780781446e-16, 0.000000000000000e+00, -2.659586767712527e-01, 1.042091314578928e-01, 1.045169012188821e-01, -8.786558947874799e-01, 9.999999999999998e-01, -4.510281037539698e-16, -5.551115123125783e-17, 0.000000000000000e+00, 6.520116000694716e-01, 5.322053526178828e-01,  5.335887100359420e-01, 5.385947927525863e-01, -7.216449660063518e-16, 9.999999999999983e-01, 1.665334536937735e-16,  0.000000000000000e+00, 5.339012535953485e-01, 1.776135719367415e+00, -2.115152165664402e-01, -2.135645945823759e-01, -1.054711873393899e-15, -2.151057110211241e-16, 9.999999999999976e-01, 6.661338147750939e-16, 5.326040594468804e-01, -2.104328276716712e-01, 1.776295475648727e+00, -2.130543883732219e-01, 8.881784197001252e-16, -3.330669073875470e-16,  2.220446049250313e-16, 1.000000000000001e+00, 5.338716307448608e-01, -2.109904049122487e-01, -2.115685748993385e-01,  1.773712710117651e+00, 3.330669073875470e-16, 2.775557561562891e-16, -6.938893903907228e-17, 0.000000000000000e+00, -3.216574511052980e-01, -2.664242313251364e-01, -2.671268106743235e-01, -2.696266339230642e-01, -1.429412144204889e-15,  2.775557561562891e-15, -2.636779683484747e-16, 2.220446049250313e-16, -2.681345196734110e-01, -8.830957179414488e-01,  1.057713310541506e-01, 1.067787866109453e-01, -1.804112415015879e-16, 2.220446049250313e-16, 9.714451465470120e-17,  0.000000000000000e+00, -2.683658534832301e-01, 1.055692067211771e-01, -8.828970738340887e-01, 1.069026989560509e-01,  2.775557561562891e-16, 1.110223024625157e-16, -2.220446049250313e-16, 8.881784197001252e-16, -2.682610311183538e-01,  1.055344745097535e-01, 1.058594805510875e-01, -8.818687898608477e-01, 1.000000000000001e+00, -4.024558464266192e-16,  2.220446049250313e-16, -4.440892098500626e-16, 6.465218683204068e-01, 5.351676945669728e-01, 5.365408207081526e-01,  5.416074324533460e-01, 8.465450562766819e-16, 1.000000000000001e+00, 2.081668171172169e-16, 0.000000000000000e+00,  5.386161844489282e-01, 1.776772836617336e+00, -2.137021591251156e-01, -2.156908787928886e-01, -1.249000902703301e-16, -1.665334536937735e-16, 9.999999999999989e-01,
                 4.440892098500626e-16, 5.390289679388121e-01, -2.133055841787119e-01,  1.776217797098890e+00, -2.159076921365022e-01, -3.330669073875470e-16, 0.000000000000000e+00, 1.110223024625157e-16,  1.000000000000000e+00, 5.388537170669767e-01, -2.131971050506263e-01, -2.138088410051568e-01, 1.774200696997033e+00,  1.554312234475219e-15, -1.110223024625157e-16, 0.000000000000000e+00, 0.000000000000000e+00, -3.216350596850061e-01, -2.666857030549846e-01, -2.673755081839849e-01, -2.699116579545162e-01, 6.661338147750939e-16, -5.551115123125783e-16, -1.776356839400250e-15, -4.440892098500626e-16, -2.680480789629867e-01, -8.839610686750830e-01, 1.058842806016677e-01,  1.067921146748162e-01, -2.442490654175344e-15, -1.554312234475219e-15, -2.220446049250313e-16, 4.440892098500626e-16, -2.680239398017706e-01, 1.055877885955605e-01, -8.838645767071025e-01, 1.068615578892553e-01, 3.552713678800501e-15, -4.440892098500626e-16, 0.000000000000000e+00, -1.776356839400250e-15, -2.679813480646900e-01, 1.054635270080441e-01,  1.058297900891013e-01, -8.828104624830075e-01, 9.999999999999973e-01, 1.665334536937735e-15, 9.992007221626409e-16,  1.332267629550188e-15, 6.461980853387023e-01, 5.350295175971538e-01, 5.363927848734472e-01, 5.414939941842019e-01, -1.776356839400250e-15, 1.000000000000002e+00, 2.775557561562891e-15, 0.000000000000000e+00, 5.377719999940376e-01,  1.776293345098433e+00, -2.133601741766261e-01, -2.152238547332457e-01, 2.442490654175344e-15, 1.998401444325282e-15,  9.999999999999999e-01, -1.776356839400250e-15, 5.376905059752446e-01, -2.127715992112485e-01, 1.775964499327124e+00, -2.153000295873529e-01, -1.065814103640150e-14, 8.881784197001252e-16, 8.881784197001252e-16, 1.000000000000004e+00,  5.376106210075977e-01, -2.125629322528663e-01, -2.132283809397966e-01, 1.773900520061072e+00, -8.881784197001252e-15,  0.000000000000000e+00, -4.440892098500626e-15, -5.329070518200751e-15, -3.219904506762169e-01, -2.657713643908768e-01, -2.664533129971962e-01, -2.690179247785409e-01, -3.552713678800501e-15, -5.329070518200751e-15, -4.440892098500626e-15, -1.421085471520200e-14, -2.665172657918657e-01, -8.821619564309611e-01, 1.051232883327941e-01, 1.058851023748342e-01,  1.243449787580175e-14, -6.217248937900877e-15, -8.881784197001252e-16, -5.329070518200751e-15, -2.662889355731389e-01,  1.047473830953193e-01, -8.822025237507864e-01, 1.059382712064341e-01, -1.421085471520200e-14, 0.000000000000000e+00,  3.552713678800501e-15, 3.552713678800501e-15, -2.665549757386048e-01, 1.045885607217700e-01, 1.050195008232807e-01, -8.810070308633637e-01, 1.000000000000012e+00, 1.776356839400250e-15, 5.329070518200751e-15, 1.776356839400250e-15,  6.501263882913894e-01, 5.321806840179443e-01, 5.335350849413312e-01, 5.386482993304349e-01, 4.263256414560601e-14,  9.999999999999911e-01, -8.881784197001252e-16, -3.552713678800501e-15, 5.336843144305599e-01, 1.773885742892608e+00, -2.114307147573406e-01, -2.131171659285347e-01, -1.065814103640150e-14, 8.881784197001252e-16, 1.000000000000010e+00,  1.243449787580175e-14, 5.332038394746134e-01, -2.106844508478199e-01, 1.773801447721637e+00, -2.131080548018558e-01,  1.421085471520200e-14, -1.065814103640150e-14, 0.000000000000000e+00, 9.999999999999929e-01, 5.337064202470057e-01, -2.105273252015228e-01, -2.112677803214007e-01, 1.771485235503863e+00, 0.000000000000000e+00, 4.718447854656915e-16,  5.273559366969494e-16, 8.881784197001252e-16, -3.254289072479806e-01, -2.626458100770635e-01, -2.633218729515554e-01, -2.658959631835192e-01, -8.881784197001252e-16, -4.996003610813204e-15, -5.828670879282072e-16, -8.881784197001252e-16, -2.628747767170563e-01, -8.781245509951511e-01, 1.032477741467299e-01, 1.038223583365419e-01, 1.110223024625157e-15, -9.714451465470120e-17, -5.412337245047638e-16, 0.000000000000000e+00, -2.630790545014816e-01, 1.030412777825315e-01, -8.780983436241621e-01, 1.041289291687311e-01, -8.881784197001252e-16, 2.553512956637860e-15, 5.551115123125783e-16,  0.000000000000000e+00, -2.632607161521978e-01, 1.026570334716904e-01, 1.031708105254421e-01, -8.769064703640090e-01,  9.999999999999989e-01, -1.110223024625157e-15, 0.000000000000000e+00, -8.881784197001252e-16, 6.680927380387049e-01,  5.227771654081245e-01, 5.241136080507702e-01, 5.291782108910410e-01, -2.664535259100376e-15, 9.999999999999961e-01, -1.110223024625157e-16, 0.000000000000000e+00, 5.232495006266795e-01, 1.770968362922462e+00, -2.067058248849813e-01, -2.081602116674768e-01, -6.661338147750939e-16, -4.163336342344337e-16, 9.999999999999934e-01, 0.000000000000000e+00,  5.236450997942117e-01, -2.063087673335147e-01, 1.770672958718576e+00, -2.085910402713029e-01, -8.881784197001252e-16, -2.997602166487923e-15, -4.440892098500626e-16, 1.000000000000000e+00, 5.239259144046597e-01, -2.058514378189431e-01, -2.066797099604210e-01, 1.768429393145961e+00, -1.332267629550188e-15, -4.607425552194400e-15, -6.106226635438361e-16, -3.552713678800501e-15, -3.173311700583010e-01, -2.631972009098710e-01, -2.638835605747302e-01, -2.665015934846497e-01, -8.881784197001252e-16, 1.942890293094024e-15, 2.220446049250313e-15, -1.776356839400250e-15, -2.641509154685737e-01, -8.693591157063693e-01, 1.031058974765759e-01, 1.034929169305263e-01, 2.664535259100376e-15, 5.551115123125783e-16,  2.997602166487923e-15, -1.776356839400250e-15, -2.648118231476917e-01, 1.030678481410649e-01, -8.692883468033902e-01,  1.040688750140584e-01, 0.000000000000000e+00, -3.330669073875470e-15, -1.776356839400250e-15, -7.105427357601002e-15, -2.647926801274174e-01, 1.023928047674948e-01, 1.030062185168943e-01, -8.681151384610715e-01, 9.999999999999991e-01,  2.775557561562891e-15, 2.331468351712829e-15, 1.776356839400250e-15, 6.403120864321319e-01, 5.306707593898768e-01,  5.320396368591904e-01, 5.372187115491336e-01, 3.552713678800501e-15, 1.000000000000011e+00, 0.000000000000000e+00,  0.000000000000000e+00, 5.326151183697343e-01, 1.757492246332515e+00, -2.096581842941118e-01, -2.109403393817040e-01, -3.552713678800501e-15, -1.665334536937735e-16, 1.000000000000002e+00, -3.552713678800501e-15, 5.339133493096662e-01, -2.095956644146887e-01, 1.756988861324993e+00, -2.118261042619807e-01, 5.329070518200751e-15, 3.330669073875470e-15,  0.000000000000000e+00, 1.000000000000014e+00, 5.337525455769345e-01, -2.087360249096952e-01, -2.096815117729938e-01,  1.754820013240384e+00, -5.426215032855453e-15, -1.332267629550188e-15, 0.000000000000000e+00, 3.552713678800501e-15, -3.144802455323976e-01, -2.608846629967426e-01, -2.615796652233174e-01, -2.642107368896802e-01, 2.581268532253489e-15,  1.820765760385257e-14, 3.108624468950438e-15, 0.000000000000000e+00, -2.612208647491494e-01, -8.599974660733780e-01,  1.011364995000628e-01, 1.013215342935521e-01, 1.117161918529064e-14, -2.664535259100376e-15, 1.776356839400250e-15,  0.000000000000000e+00, -2.625248617595224e-01, 1.013411457881470e-01, -8.598318858431926e-01, 1.022383551129789e-01, -1.926236947724647e-14, 8.881784197001252e-15, 1.776356839400250e-15, 4.263256414560601e-14, -2.623125760478722e-01,  1.003812186990209e-01, 1.010907992767374e-01, -8.586843518035892e-01, 1.000000000000011e+00, 8.881784197001252e-16,  5.773159728050814e-15, -3.552713678800501e-15, 6.373396049366526e-01, 5.279599567599136e-01,
                 5.293396676033155e-01,  5.345279836274557e-01, -2.442490654175344e-15, 1.000000000000019e+00, 4.440892098500626e-15, 7.105427357601002e-15,  5.286653088964277e-01, 1.747178589664655e+00, -2.071738642531671e-01, -2.082405616574370e-01, -8.479328350574633e-15,  9.325873406851315e-15, 1.000000000000013e+00, 7.105427357601002e-15, 5.312556383437288e-01, -2.076103800479566e-01,  1.746340517011140e+00, -2.097316969162115e-01, 2.425837308805967e-14, 0.000000000000000e+00, -3.552713678800501e-15,  9.999999999999716e-01, 5.306563877626971e-01, -2.063586005728119e-01, -2.074057613829048e-01, 1.744291059859620e+00 ))

  expect_equal(c(res$lag_one_cor),
               c( 1.019448205669372e-03, 8.504255242990578e-04, 8.461821063964673e-04, 8.599593671605466e-04, 1.233464447363372e-03,  1.017730148403969e-03, 1.013009319176715e-03, 1.028309929475236e-03, 8.525041812350434e-04, 2.169105595144401e-03, -3.951645584337083e-05, 5.628424493437970e-06, 1.017730175962419e-03, 2.605611956420816e-03, -4.221349360840691e-05,  9.075682189659441e-06, 8.470932878806961e-04, -3.905069607131611e-05, 2.194008571935036e-03, -2.623035369451847e-05,  1.013009331549611e-03, -4.221348616606377e-05, 2.634683804323344e-03, -2.887528231336074e-05, 8.612896076849053e-04,  5.957029757990446e-06, -2.638472987535797e-05, 2.179131672133103e-03, 1.028309938056406e-03, 9.075679711364652e-06, -2.887529186281624e-05, 2.617080098120957e-03, 1.181841174318262e-03, 9.859812541174445e-04, 9.812735651989672e-04,  9.965576653482673e-04, 1.440044250471418e-03, 1.187897743776117e-03, 1.182757275290103e-03, 1.199591139411130e-03,  9.885363161557744e-04, 2.513856519258658e-03, -4.428236146848025e-05, 6.362478918608921e-06, 1.187992988203569e-03,  3.040158386554227e-03, -4.689885471734790e-05, 1.050116812130737e-05, 9.823925221357638e-04, -4.370974594267296e-05,  2.542561276542481e-03, -3.012418012890678e-05, 1.182802204499570e-03, -4.687916143859150e-05, 3.073836444002361e-03, -3.306340434235041e-05, 9.981882229278399e-04, 6.784543432965132e-06, -3.030545712727261e-05, 2.525345163941705e-03,  1.199654165544522e-03, 1.053560763778663e-05, -3.306126371479481e-05, 3.053318806387699e-03, 7.090914090679461e-04,  5.755132514588110e-04, 5.715468464890321e-04, 5.824931614987544e-04, 1.915028614818297e-03, 2.963283414663487e-04,  2.905842892278169e-04, 2.991912307295125e-04, 5.749103909901081e-04, 1.483346728810948e-03, -2.795671816920210e-05,  6.095166002998101e-06, 2.963283431767982e-04, 1.991720163823687e-03, 1.324102146285299e-04, 1.735108586209715e-04,  5.712267359438014e-04, -2.807011933158758e-05, 1.500785749393376e-03, -1.660787948871397e-05, 2.905842916689921e-04,  1.324102159032064e-04, 2.014018843072085e-03, 1.467047849680196e-04, 5.821354764834907e-04, 6.016006922313683e-06, -1.658492736160753e-05, 1.490547499362288e-03, 2.991912266635800e-04, 1.735108532241366e-04, 1.467047801081817e-04,  2.004541789572264e-03, 8.142034029633174e-04, 6.796354772400007e-04, 6.758606611723625e-04, 6.880814822300914e-04,  1.019448205669428e-03, 8.504255242991144e-04, 8.461821063964973e-04, 8.599593671605758e-04, 6.804415780104484e-04,  1.735319932014057e-03, -3.409495478626633e-05, 4.931431492995692e-06, 8.525041812350804e-04, 2.169105595144456e-03, -3.951645584334632e-05, 5.628424493444889e-06, 6.761583612016062e-04, -3.389285991455238e-05, 1.755336495977365e-03, -2.156640143843522e-05, 8.470932878806883e-04, -3.905069607130980e-05, 2.194008571935000e-03, -2.623035369451474e-05,  6.886407227092025e-04, 5.075774417583083e-06, -2.165112630723489e-05, 1.743450602860382e-03, 8.612896076849330e-04,  5.957029757995388e-06, -2.638472987534449e-05, 2.179131672133157e-03, 4.609003286937189e-04, 3.797477890143442e-04,  3.772949808055551e-04, 3.852028313210140e-04, 3.578133784844260e-03, -7.124518084582960e-04, -7.185264225468892e-04, -7.204108933895960e-04, 3.811022129414942e-04, 9.758926354753893e-04, -2.191621243697177e-05, 2.353378702183288e-06, -7.124518077093131e-04, 1.702947975060928e-03, 4.495324970903169e-04, 4.832030064658116e-04, 3.795185954107954e-04, -2.226075682741761e-05, 9.870485035373680e-04, -1.311445264378975e-05, -7.185264208877630e-04, 4.495324987618825e-04,  1.719756311952758e-03, 4.654960556262442e-04, 3.867194766386861e-04, 2.316548755184543e-06, -1.281514153172255e-05,  9.805248480656155e-04, -7.204108957869795e-04, 4.832030027779039e-04, 4.654960532845919e-04, 1.720288686048445e-03,  5.347288542438195e-04, 4.446454584599570e-04, 4.414205457182994e-04, 4.508142132350480e-04, 7.090914090679515e-04,  5.755132514588068e-04, 5.715468464890288e-04, 5.824931614987461e-04, 4.457616193609607e-04, 1.137049441114701e-03, -2.584003338301300e-05, 2.701409038901532e-06, 5.749103909901171e-04, 1.483346728810951e-03, -2.795671816920621e-05,  6.095166003002932e-06, 4.437692939783998e-04, -2.632967104300982e-05, 1.150185392199216e-03, -1.575015450295940e-05,  5.712267359438061e-04, -2.807011933159253e-05, 1.500785749393373e-03, -1.660787948871881e-05, 4.523093574840440e-04,  2.598462162207025e-06, -1.538274592246980e-05, 1.142604512883418e-03, 5.821354764834942e-04, 6.016006922325473e-06, -1.658492736160335e-05, 1.490547499362309e-03, 3.072963489965155e-04, 2.549560759069015e-04, 2.541910843134281e-04,  2.587376983510089e-04, 5.822496293902904e-04, 2.392626926214471e-04, 2.378893646028937e-04, 2.430155421605733e-04,  2.545734676542925e-04, 6.537305522553362e-04, -1.594458650444299e-05, -8.516947168489744e-08, 2.392626926083499e-04,  8.457748337027344e-04, 1.193985591914254e-05, 3.245216258253700e-05, 2.536483842932553e-04, -1.588172947134825e-05,  6.609156273104599e-04, -9.517351573834734e-06, 2.378893656107824e-04, 1.193985809378206e-05, 8.548977167430534e-04,  2.004333127118679e-05, 2.582209515350446e-04, -1.248817315896161e-08, -9.520548424360394e-06, 6.566365383385984e-04,  2.430155411763368e-04, 3.245216044846165e-05, 2.004333093927637e-05, 8.502372614637251e-04, 3.370396922649844e-04,  2.820745581315270e-04, 2.802369186064767e-04, 2.866434038853911e-04, 4.609003286937183e-04, 3.797477890143459e-04,  3.772949808055560e-04, 3.852028313210158e-04, 2.826507552665997e-04, 7.226637771873953e-04, -1.834235786752776e-05,  1.023606431315839e-06, 3.811022129414973e-04, 9.758926354753937e-04, -2.191621243696978e-05, 2.353378702184251e-06,  2.812814404167351e-04, -1.852873524060254e-05, 7.310687319739982e-04, -1.048469845367130e-05, 3.795185954108014e-04, -2.226075682741519e-05, 9.870485035373786e-04, -1.311445264378951e-05, 2.871948206101730e-04, 1.078585194069384e-06, -1.026586752667806e-05, 7.261752975131952e-04, 3.867194766386843e-04, 2.316548755185108e-06, -1.281514153172021e-05,  9.805248480656045e-04, 2.465163259161238e-04, 1.997401632492759e-04, 1.996996089476020e-04, 2.015971400376651e-04,  7.179432327379978e-04, 5.184298958926785e-05, 5.091718246657091e-05, 5.248827791735921e-05, 1.992637433138570e-04,  5.184290884375537e-04, -9.987383054773044e-06, -1.587649026326775e-06, 5.184298899178832e-05, 6.557481645557369e-04,  5.691019491650376e-05, 6.970598789899611e-05, 1.991186591277821e-04, -9.946704736793539e-06, 5.237714085961400e-04, -6.815446664277117e-06, 5.091718308470702e-05, 5.691019748959707e-05, 6.623754444323304e-04, 6.252750712511558e-05,  2.011662567816733e-04, -1.586835223755130e-06, -6.868246202931264e-06, 5.202423639810858e-04, 5.248827787006422e-05,  6.970598681347650e-05, 6.252750811302162e-05, 6.598288128265481e-04, 2.298903086289169e-04, 1.921236662914201e-04,  1.917685869763193e-04, 1.949903109395740e-04, 3.072963489965152e-04, 2.549560759069021e-04, 2.541910843134286e-04,  2.587376983510093e-04, 1.913827037325110e-04, 4.928901183533954e-04, -1.254557887943482e-05, -1.042886205855239e-06,  2.545734676542932e-04, 6.537305522553364e-04, -1.594458650444280e-05, -8.516947168491460e-08, 1.908076038934964e-04, -1.245965570510088e-05, 4.982553965943620e-04,
                  -7.458899215769149e-06, 2.536483842932561e-04, -1.588172947134747e-05,  6.609156273104621e-04, -9.517351573834865e-06, 1.941931306708865e-04, -9.816978951870693e-07, -7.509413997149027e-06,  4.949090495263954e-04, 2.582209515350444e-04, -1.248817315868545e-08, -9.520548424360204e-06, 6.566365383385979e-04,  3.684662577063553e-04, 1.805730929722054e-04, 1.811933550988097e-04, 1.802326884587314e-04, 2.791368373892792e-03, -7.974294668859989e-04, -7.996867509282505e-04, -8.085146628356509e-04, 1.802403004299498e-04, 5.852979946375887e-04,  8.941482577346732e-06, 1.119718112670885e-05, -7.974294676328991e-04, 9.443650351974412e-04, 3.929906988350735e-04,  4.020239540486818e-04, 1.811241265279991e-04, 8.835986986947977e-06, 5.904994490841059e-04, 8.283440798138904e-06, -7.996867504111412e-04, 3.929907016988376e-04, 9.516962108014276e-04, 3.990041190813398e-04, 1.800887378091360e-04,  1.114171728915874e-05, 8.322152623925062e-06, 5.868503599520813e-04, -8.085146624866150e-04, 4.020239534200181e-04,  3.990041206070470e-04, 9.555674465051094e-04, 2.051966795477594e-04, 1.766677952083221e-04, 1.770804878345885e-04,  1.776817010130355e-04, 2.465163259161211e-04, 1.997401632492765e-04, 1.996996089476024e-04, 2.015971400376654e-04,  1.759838276643498e-04, 4.489618982572281e-04, -8.859525821121500e-06, -4.211822993064334e-06, 1.992637433138589e-04,  5.184290884375511e-04, -9.987383054773857e-06, -1.587649026327657e-06, 1.765153466493949e-04, -8.908236903819204e-06,  4.532322265511772e-04, -7.447052414044682e-06, 1.991186591277822e-04, -9.946704736793302e-06, 5.237714085961407e-04, -6.815446664276879e-06, 1.771925505123786e-04, -4.250147844887481e-06, -7.461078230446503e-06, 4.501081675617243e-04,  2.011662567816743e-04, -1.586835223755445e-06, -6.868246202931710e-06, 5.202423639810850e-04, 3.890007913348560e-04,  3.111950405657480e-04, 3.130861399627411e-04, 3.097820269796823e-04, 9.893176406482011e-03, -3.536298220445838e-03, -3.544467320111406e-03, -3.582534041510140e-03, 3.120914823988620e-04, 8.107812421893739e-04, -4.953036090791912e-06, -7.817660935736696e-06, -3.536298232332649e-03, 2.201644311679178e-03, 1.509345833542558e-03, 1.523337895239739e-03,  3.143426222413306e-04, -5.095647380058115e-06, 8.172237201063569e-04, -1.034969183914180e-05, -3.544467319324871e-03,  1.509345831964264e-03, 2.215093159484850e-03, 1.524525976668534e-03, 3.108472475895400e-04, -7.859277624998962e-06, -1.025953604465115e-05, 8.118173404017227e-04, -3.582534040978860e-03, 1.523337889748150e-03, 1.524525977917365e-03,  2.239290387822222e-03, 2.770953309156749e-04, 2.317851621826107e-04, 2.329411255413898e-04, 2.310510742097481e-04,  3.684662577063658e-04, 1.805730929721976e-04, 1.811933550988224e-04, 1.802326884587359e-04, 2.320999786353180e-04,  5.942406055908770e-04, -6.165930577640398e-06, -7.194807296039451e-06, 1.802403004299337e-04, 5.852979946375956e-04,  8.941482577346188e-06, 1.119718112671277e-05, 2.337971998255828e-04, -6.381557109860494e-06, 5.991698805964184e-04, -9.066057202141113e-06, 1.811241265279844e-04, 8.835986986955038e-06, 5.904994490841054e-04, 8.283440798142228e-06,  2.316920252367856e-04, -7.280559693292039e-06, -8.958708476029702e-06, 5.950673553241709e-04, 1.800887378091221e-04,  1.114171728916616e-05, 8.322152623924606e-06, 5.868503599520840e-04, 5.819262627672724e-04, 4.851588078207190e-04,  4.885447427765096e-04, 4.823869744255773e-04, 7.437837801075794e-04, 2.959413966211328e-04, 2.985004160429022e-04,  2.926992623711405e-04, 4.842238750646830e-04, 1.240202981723680e-03, -8.166203827815357e-06, -1.471139678630623e-05,  2.959412621350554e-04, 1.065943687917946e-03, 3.392408605378641e-05, 2.965367046078811e-05, 4.884257301861177e-04, -8.491868750479296e-06, 1.249309870783089e-03, -1.890013051949734e-05, 2.985004316708078e-04, 3.392402963424057e-05,  1.074014746183768e-03, 2.655527874754828e-05, 4.819682064527001e-04, -1.489984985304314e-05, -1.877192874037433e-05,  1.241371073784459e-03, 2.926992799499843e-04, 2.965360779190228e-05, 2.655527806929863e-05, 1.068098256540238e-03,  4.295610269420570e-04, 3.646309299134596e-04, 3.669952353466592e-04, 3.624424341690695e-04, 3.890007913348423e-04,  3.111950405657019e-04, 3.130861399627288e-04, 3.097820269796727e-04, 3.649584994364246e-04, 9.286470293551132e-04, -6.709591511779827e-06, -1.211079021455180e-05, 3.120914823988717e-04, 8.107812421893919e-04, -4.953036090783599e-06, -7.817660935723570e-06, 3.683469447795832e-04, -7.117153874737607e-06, 9.355947889908862e-04, -1.462860110962974e-05,  3.143426222413306e-04, -5.095647380047373e-06, 8.172237201063524e-04, -1.034969183914093e-05, 3.633503401914572e-04, -1.229752776351325e-05, -1.442825026676297e-05, 9.294511941488383e-04, 3.108472475895484e-04, -7.859277624974115e-06, -1.025953604465133e-05, 8.118173404017311e-04, 1.331802936005950e-03, 5.466151230498365e-04, 5.519953776794891e-04,  5.409375586014004e-04, 1.200545350664576e-03, 4.185542947164055e-04, 4.231010291211354e-04, 4.134240180416305e-04,  5.449427229038575e-04, 1.937366501152630e-03, 6.101664375180161e-05, 5.283886650557886e-05, 4.185551664717145e-04,  1.627139963886754e-03, 6.471621133589098e-05, 5.778743330493902e-05, 5.502307937557103e-04, 6.105121068289155e-05,  1.951016013750205e-03, 4.553468297058253e-05, 4.231008110751298e-04, 6.471664859382173e-05, 1.638531715127777e-03,  5.211543884414985e-05, 5.392099466876797e-04, 5.287401132679704e-05, 4.552248615427087e-05, 1.940837697189101e-03,  4.134237738422653e-04, 5.778787805428509e-05, 5.211544703973955e-05, 1.630274065996847e-03, 6.826841379506191e-04,  5.699858355627333e-04, 5.739349099620131e-04, 5.664297061303024e-04, 5.819262627672759e-04, 4.851588078207254e-04,  4.885447427765098e-04, 4.823869744255802e-04, 5.676296187659454e-04, 1.456150869948894e-03, -8.462331276993394e-06, -1.688661183454456e-05, 4.842238750646875e-04, 1.240202981723693e-03, -8.166203827814439e-06, -1.471139678630603e-05,  5.724581719865277e-04, -8.815087961115892e-06, 1.466803811740915e-03, -2.175697215609157e-05, 4.884257301861207e-04, -8.491868750478942e-06, 1.249309870783097e-03, -1.890013051949790e-05, 5.646320402756045e-04, -1.707751225973842e-05, -2.161625939343168e-05, 1.457528747190870e-03, 4.819682064526998e-04, -1.489984985304209e-05, -1.877192874037443e-05,  1.241371073784460e-03, -2.881968267607198e-03, 2.690714689484758e-03, 2.703415452448669e-03, 2.706823549042962e-03, -1.013630094049066e-03, 1.712373777979769e-03, 1.721945642577688e-03, 1.719046743648951e-03, 2.689737069177926e-03,  2.031599097132610e-03, -6.719747724641823e-04, -6.882505418688224e-04, 1.712999787963057e-03, 1.946897776353589e-03, -3.432742271358519e-04, -3.558613805425006e-04, 2.701390365893166e-03, -6.715597805193720e-04, 2.047287732131679e-03, -7.026061160867247e-04, 1.721754025629619e-03, -3.429485865659737e-04, 1.961242569977960e-03, -3.668104505037210e-04,  2.704814458374472e-03, -6.878240129251484e-04, -7.026109369257915e-04, 2.018335832004566e-03, 1.718837159778863e-03, -3.555262433461975e-04, -3.668040160552484e-04, 1.940953598528370e-03, 1.461419651533788e-03, 6.753282425962520e-04,  6.815436653274537e-04, 6.691112262595646e-04, 1.331802936005944e-03, 5.466151230498498e-04,
                  5.519953776794952e-04,  5.409375586014048e-04, 6.719804587243563e-04, 2.247334688907534e-03, 5.705797975846931e-05, 4.762874556299145e-05,  5.449427229038428e-04, 1.937366501152604e-03, 6.101664375180493e-05, 5.283886650558110e-05, 6.780150708166421e-04,  5.712569369411427e-05, 2.263239670780424e-03, 3.869071551931271e-05, 5.502307937556990e-04, 6.105121068288135e-05,  1.951016013750194e-03, 4.553468297058300e-05, 6.656566616450134e-04, 4.769757678186725e-05, 3.866629211129921e-05,  2.251135703152269e-03, 5.392099466876861e-04, 5.287401132679597e-05, 4.552248615428159e-05, 1.940837697189087e-03 ))

  expect_equal(c(res$Q),
               c( 0.9390880397796438, -0.3732898323406337, -0.3742330540157039, -0.3777760348982663, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, -0.3732898323406337, 0.1483847950664508, 0.1487587397717451, 0.1501670844833531,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, -0.3742330540157039, 0.1487587397717451,  0.1491356014489583, 0.1505465207816752, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, -0.3777760348982663, 0.1501670844833531, 0.1505465207816752, 0.1519727754777215, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000 ))

  expect_equal(c(res$Q_0),
               c( 1.233458243772930e-03, 1.017724869917502e-03, 1.013004093234456e-03, 1.028304878074937e-03, 1.440036400119910e-03,  1.187986272065554e-03, 1.182795569309690e-03, 1.199647764422173e-03, 1.017724869917502e-03, 2.605598862215230e-03, -4.221365471492022e-05, 9.075654161684894e-06, 1.187891065250077e-03, 3.040141833749236e-03, -4.687939622986155e-05,  1.053557361380579e-05, 1.013004093234456e-03, -4.221365471492022e-05, 2.634670321233117e-03, -2.887479617477537e-05,  1.182750656550563e-03, -4.689907973047392e-05, 3.073819400942717e-03, -3.306064999209888e-05, 1.028304878074937e-03,  9.075654161684894e-06, -2.887479617477537e-05, 2.617066948120128e-03, 1.199584751490996e-03, 1.050113243948853e-05, -3.306280264547179e-05, 3.053302186011859e-03, 1.440036400119910e-03, 1.187891065250077e-03, 1.182750656550563e-03,  1.199584751490996e-03, 1.689612683014491e-03, 1.393238064687679e-03, 1.387673552862226e-03, 1.406089959465753e-03,  1.187986272065554e-03, 3.040141833749236e-03, -4.689907973047392e-05, 1.050113243948853e-05, 1.393238064687679e-03,  3.564143508538313e-03, -5.182493651961019e-05, 1.230860028959614e-05, 1.182795569309690e-03, -4.687939622986155e-05,  3.073819400942717e-03, -3.306280264547179e-05, 1.387673552862226e-03, -5.182493651961019e-05, 3.603317260010407e-03, -3.779949194315822e-05, 1.199647764422173e-03, 1.053557361380579e-05, -3.306064999209888e-05, 3.053302186011859e-03,  1.406089959465753e-03, 1.230860028959614e-05, -3.779949194315822e-05, 3.579277330743294e-03 ))
})



test_that("Implement tests for non-integer start and stop times",
          expect_true(FALSE))

# par(mfcol = c(2, 2))
# plot(res$a_t_d_s[, 1], type = "l", ylim = range(res$a_t_d_s[, 1], res_new$a_t_d_s[, 1]))
# for(i in 1:3){
#   plot(res$a_t_d_s[, i + 1], type = "l", ylim = range(sims$betas[, i ], res$a_t_d_s[, i + 1], res_new$a_t_d_s[, i + 1]))
#   lines(x = seq_len(nrow(sims$betas)), sims$betas[, i], col = "red")
# }
