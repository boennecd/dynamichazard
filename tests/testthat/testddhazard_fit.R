# library(survival); library(benssurvutils); source("R/test_utils.R")

# Simulate series to work with
set.seed(2972)
sims <- test_sim_func_logit(n_series = 10^4, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = .1, x_mean = -.4, re_draw = T)
sims$res <- as.data.frame(sims$res)

design_mat <- benssurvutils::get_design_matrix(survival::Surv(tstart, tstop, event) ~ x1 + x2 + x3, sims$res)
rist_sets <- benssurvutils::get_risk_sets(design_mat$Y, by = 1, max_T = 10, id = sims$res$id)

design_mat$Y[, 2] <- rist_sets$stop_new
design_mat$Y[, 3] <- rist_sets$new_events_flags






#########
# Without estimating Q_0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = F)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 1 and no Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 0.590989929209872145, 0.984518276587618701, 0.697023853102439972, 0.410462698211114363, 0.984518276587619701,  2.395259571910619556, 1.112478365381281531, 0.501257802420081444, 0.697023853102440083, 1.112478365381280865,  1.281883890380488111, 0.292435639609743503, 0.410462698211114085, 0.501257802420080556, 0.292435639609744558,  0.796476105996861250, 0.314017419863397595, 0.322121880177917319, 0.285319334930023150, 0.191193382899863096,  0.322121880177918873, 0.742250262422693652, 0.124361481449782790, -0.033157422701280512, 0.285319334930023150,  0.124361481449781652, 0.638822308531641347, -0.030380684979929296, 0.191193382899862874, -0.033157422701281435, -0.030380684979928324, 0.553040116588403130, 0.283728546025673101, 0.279876694188687103, 0.253585559543698547,  0.191742766431003742, 0.279876694188685660, 0.657314681716500537, 0.087613625865292061, -0.014846628630316935,  0.253585559543698769, 0.087613625865293893, 0.585641774632491119, -0.017026725738322174, 0.191742766431003853, -0.014846628630316334, -0.017026725738321730, 0.524271530658120266, 0.252578117171293692, 0.231440718564015657,  0.218346849009751154, 0.185676765334214011, 0.231440718564015657, 0.562935597496653339, 0.037733081971774267, -0.013571476117295077, 0.218346849009751542, 0.037733081971774350, 0.530684061341656910, -0.015620291728526071,  0.185676765334214233, -0.013571476117295301, -0.015620291728526036, 0.498459378384268792, 0.255319414047003979,  0.237224652926965235, 0.222047510779167623, 0.186588971371529355, 0.237224652926965818, 0.573526327889214871,  0.045814494992510280, -0.010296933949039000, 0.222047510779167345, 0.045814494992509662, 0.534031140679193550, -0.013595280338397575, 0.186588971371529133, -0.010296933949039584, -0.013595280338397400, 0.498625623261576667,  0.272517198540888406, 0.264470212235610236, 0.242064244725319344, 0.190014260911479632, 0.264470212235610291,  0.626921020707393528, 0.075791635796177897, -0.009647497509855028, 0.242064244725319122, 0.075791635796177662,  0.564137362856990343, -0.013226431706672797, 0.190014260911479715, -0.009647497509854958, -0.013226431706672474,  0.511329280548604381, 0.293933580856512222, 0.296917516337894372, 0.266064846852502257, 0.194226222700019380,  0.296917516337894094, 0.692288841766142804, 0.108861030932587657, -0.011328756321956387, 0.266064846852502312,  0.108861030932588282, 0.602154691466796677, -0.014794803739484386, 0.194226222700019491, -0.011328756321956079, -0.014794803739484184, 0.529619842315859568, 0.313934890760961149, 0.323329599750915131, 0.286703111516319165,  0.196493758043673472, 0.323329599750915020, 0.744387854316318043, 0.130319461996324604, -0.020408880302714018,  0.286703111516319331, 0.130319461996324826, 0.636967838582420010, -0.021292768490593597, 0.196493758043673500, -0.020408880302714150, -0.021292768490593549, 0.549768615051527743, 0.335494720082257836, 0.348977147981149316,  0.308034685637247618, 0.196559502029717614, 0.348977147981149316, 0.793915680872271712, 0.147620351543982897, -0.037335952317478834, 0.308034685637247729, 0.147620351543983314, 0.675042771944227793, -0.032864214570555460,  0.196559502029717559, -0.037335952317479028, -0.032864214570555418, 0.573624006026876687, 0.380764304051999680,  0.416691595947043247, 0.358054553740919046, 0.202969856019359379, 0.416691595947043414, 0.928052613695493522,  0.214376047994625507, -0.045909069584618503, 0.358054553740919213, 0.214376047994625535, 0.754280234493245327, -0.039407931485515989, 0.202969856019359435, -0.045909069584618670, -0.039407931485516037, 0.612489076924820131,  0.443712359812153345, 0.516835921171008184, 0.430031162020929780, 0.213557797927490467, 0.516835921171008184,  1.129059305949814629, 0.321045561326899875, -0.047642363172880696, 0.430031162020929780, 0.321045561326899875,  0.865120165053681167, -0.042131334836178647, 0.213557797927490467, -0.047642363172880696, -0.042131334836178647,  0.661794720499680134 ))

  expect_equal(c(res$a_t_d_s),
               c( 0.2191135193434557, 0.2191637670963300, -1.0807701905278368, -0.5120298733328240, 0.2568366132596853, 0.7625280118396124,  0.6551965017411194, 0.1319056466018235, 0.7169449734695408, 1.5603083664863111, 2.2329899682901893, 3.3608783900246522,  3.3609942522557077, 0.3841562219832703, 1.7258093321706305, 3.4887533409352751, 4.6166368737042216, 4.3550321672429710,  3.1601751542597025, 4.5628820990890322, 6.5514623519615069, 8.1241497566460019, 3.1775634127354722, 3.1776331715500730,  1.3247702158328254, 2.1225444825998543, 3.2032923524181176, 3.9030312770586635, 3.7297370654280786, 2.9783915177676281,  3.8277480757918023, 5.0400974847580180, 6.0014926249800906, 3.1384490904389222, 3.1384843052587055, 2.1178576312323227,  2.5742655169905624, 3.1043024110884607, 3.4135970469926460, 3.3161331486068555, 2.9503928255441010, 3.5093001584596766,  4.2347380560494994, 4.7946267029670047 ))

  expect_equal(c(res$B_s),
               c( 0.96159225344638388, -0.08503095715122021, -0.05328345837583150, -0.02721693196023317, -0.08503095715122021, 0.80407561225777191, -0.11837956921934435, -0.06116353900353915, -0.05328345837583150, -0.11837956921934435, 0.92252592144627787, -0.03729092153396421, -0.02721693196023317, -0.06116353900353915, -0.03729092153396421, 0.97291537313637833, 2.11636777919183272, 2.66011565872910527,  1.62549595357014032, 0.98177862883731404, -0.46951461354733870, -0.10799914944202602, -0.67181255027645814, -0.38552591864364949, -0.46295072718555852, -1.08216739475478385, 0.32381092318517157, -0.38634346327991143, -0.44643836011841187, -1.05421956586179899, -0.64408914624342495, 0.59478774948725155, 2.06799268161217986, 2.58813954873227647, 1.57589469796396342, 0.99590092459361923, -0.46210277265939131, -0.10192194659225522, -0.66229609407913037, -0.38625478637735378, -0.45162250390971148, -1.06052418918493019,  0.33033913941876913, -0.38774155611993155, -0.42665390117274926, -1.01864763044260220, -0.62001034173320013, 0.58202691564396458,  1.94287189668620797, 2.38393708981098351, 1.44018714330439601, 1.00777834542991673, -0.44284474139111119, -0.08135475481161326, -0.63670956620233576, -0.38413139645701200, -0.42670100537888478, -1.01147176733284971, 0.34377632312884759, -0.38883419854878509, -0.38043068939081004, -0.93267981331929084, -0.56240139531391475, 0.55570006700428309, 1.90158691870057384, 2.32172139038330405,  1.39972326657932467, 1.00518261371298845, -0.43446466658789928, -0.07358229593202538, -0.62514672938638416, -0.38047511458802541, -0.41746416859590257, -0.99195083885408619, 0.34573528811907239, -0.38642037186168121, -0.36585879968860191, -0.90372352098875675, -0.54361758183319353, 0.54684678658317476, 1.90400721016727603, 2.32964883566019676, 1.40653447130902221, 0.99563070889060379, -0.43256010948662915, -0.07243451659076261, -0.62196310196492299, -0.37695172806998656, -0.41641391978190651, -0.98784442546215323,  0.34336693673989988, -0.38246646157447783, -0.36864788267234383, -0.90691450806169338, -0.54636390628820419, 0.54713689183082348,  1.91533622670062598, 2.34973000583414970, 1.42151754695290844, 0.98481145103555656, -0.43195131151993083, -0.07148603647695113, -0.62049455992470948, -0.37353592446681200, -0.41774975174032686, -0.98861509072330234, 0.34025748928117117, -0.37901005590850056, -0.37491695331121100, -0.91669431854698069, -0.55352589869757352, 0.55002806455977971, 1.92509538317144901, 2.37066763977297157,  1.43626863184858067, 0.98139182577758532, -0.43305494461020622, -0.07518230884891547, -0.62171363484044484, -0.37262286847159826, -0.42066561390526602, -0.99396820001993202, 0.33430572339450038, -0.37861560877721723, -0.38022172703987445, -0.92611778072250150, -0.56005193244734530, 0.54960910801094920, 1.91830943567621492, 2.36360567704226154, 1.43243506761295891, 0.97966233492863442, -0.43291547937022756, -0.07862972347333207, -0.62140947888457365, -0.37233072446932997, -0.42049948693413891, -0.99341943941591893,  0.33039413988996069, -0.37877865792982113, -0.37942552843017419, -0.92421488609875324, -0.55906617678341242, 0.54591417661767416,  1.92380719363600239, 2.37114262322338165, 1.43874360369495036, 0.96978482368406871, -0.43107205404670779, -0.07406052956679751, -0.61852408193949859, -0.36895841910592847, -0.41993496591502255, -0.99084023832268420, 0.33108109647846962, -0.37510365487462261, -0.38195185033866974, -0.92692080222017947, -0.56139951677459810, 0.55018118753369361 ))

  expect_equal(c(res$lag_one_cor),
               c( 0.254159888396791045, 0.240911687882378156, 0.230574493576575335, 0.173236216034766799, 0.186839102361362364,  0.556741169130280600, 0.001969738714214131, -0.073147869649344888, 0.201220121391066376, 0.010932127002166558,  0.560538403050256928, -0.054912628241785721, 0.147126455601323647, -0.091062742698034493, -0.068752013291905334,  0.536018483152744807, 0.266068809528237638, 0.249770481695852031, 0.232022527877442042, 0.186596534529890112,  0.247963302887439063, 0.594353947325020560, 0.049292194599086084, -0.022610179315355916, 0.231789267204603411,  0.051278982678317500, 0.553946300434236427, -0.021539799958385730, 0.186734028459117463, -0.021314433920433362, -0.021198599991606892, 0.512381158488009358, 0.237550233133347777, 0.207232826055369634, 0.201098717840444530,  0.184634445497905170, 0.209417213595511048, 0.515433090824539142, 0.014374575386088887, -0.009248156536637575,  0.201761227226050888, 0.012775323209356988, 0.504091627403567166, -0.012614597610559108, 0.185554423140336988, -0.009474191654987994, -0.011982448674325356, 0.486331120677079842, 0.225267157050337063, 0.191282171624467284,  0.188421597475207453, 0.183187041944594370, 0.190743512275419913, 0.482133229160517429, -0.001857308505784437, -0.005652737049556655, 0.188061310654923930, -0.001980855560761701, 0.481852709605439078, -0.009822287748644243,  0.183527777441409218, -0.004775850342775077, -0.009028581700662210, 0.474368302652280971, 0.232740639193069032,  0.202427393369404102, 0.196709284747857260, 0.183967374193622801, 0.201412496156934129, 0.501432954507130768,  0.008785319368585497, -0.007110268722725549, 0.196511033504405519, 0.009715876010625773, 0.493674376622918354, -0.010541947694509682, 0.183675348128852639, -0.007250123107269161, -0.010745062327931286, 0.479399400758683092,  0.248822792333643128, 0.224721628170848842, 0.214208925004557182, 0.185626025225925750, 0.224277692653195637,  0.544304389539053801, 0.030534831452788409, -0.012405467798213859, 0.213995647960684654, 0.030615508663275705,  0.521365192836060198, -0.014213266452000800, 0.185233179872201920, -0.013173351780228021, -0.014531778745941023,  0.493081056676974216, 0.268189229664635986, 0.250956297943806583, 0.234731056724799547, 0.187944730284573064,  0.250984946906500472, 0.596396842879331257, 0.054161824455486028, -0.019753184483996322, 0.234428194993444583,  0.053369102172226075, 0.555210162888845060, -0.019573266540782161, 0.187805173460444341, -0.020254756540402371, -0.019459329799064236, 0.511591093618201320, 0.290417263754017441, 0.280102319669226385, 0.257596834365326155,  0.190284843393468739, 0.280895636666746773, 0.655467972010811972, 0.078614506803131035, -0.029793153378964279,  0.257790920917301936, 0.077897127821243112, 0.594719300242947391, -0.026721410416753414, 0.190619062523072896, -0.029759366637025754, -0.026348198002676602, 0.534526001113257099, 0.322457814204665905, 0.324849132927615303,  0.291830642964232390, 0.193410760127325887, 0.323926209289368550, 0.741386613466717193, 0.116548195736271246, -0.043572395859771622, 0.291309579036211352, 0.116677761362765517, 0.650916001529291299, -0.036172605748829953,  0.193054061861176157, -0.043588923845570518, -0.036264832502527017, 0.565228633722822726, 0.368669590129941216,  0.390965580839031213, 0.341701207694488196, 0.196300021882268250, 0.389784802344115278, 0.867928788789142258,  0.177744953463247868, -0.061781455545273478, 0.341196799987448562, 0.178282521206187927, 0.730207616517919433, -0.048757260095028870, 0.195803770501925045, -0.061993599294467683, -0.049104371777993316, 0.604593785318598531 ))

  expect_equal(c(res$Q),
               c(0.5662151883161876, 1.2641553003991997, 0.7885508764949164, 0.4058157116373461, 1.2641553003991997, 2.8989541397833865, 1.7646616826903763, 0.9151796370232327, 0.7885508764949164, 1.7646616826903763, 1.1334709764752691, 0.5604781223374399, 0.4058157116373461, 0.9151796370232327, 0.5604781223374399, 0.3687654984117195 ))

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10 ))
})








#########
# With estimating Q_0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = T)

# get_expect_equal(res)

test_that("Testing versus previously computed values with order 1 and Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c(0.0020913991459398959, 0.0039041669051419663, 0.0024529247355145915, 0.0016193743000390425, 0.0039041669051419620, 0.0106709854416605528, 0.0045409852180656523, 0.0022714305194235628, 0.0024529247355145746, 0.0045409852180656419, 0.0045208596889710472, 0.0011772800644625724, 0.0016193743000390433, 0.0022714305194235659, 0.0011772800644625802, 0.0027010698429842227, 0.0077455290272512474, 0.0147074421704285821, 0.0090713345349717738, 0.0053980174587721008, 0.0147074421704286341, 0.0393422854557464730, 0.0167859782765449154, 0.0076790972406085012, 0.0090713345349717651, 0.0167859782765449363, 0.0160465273625828783, 0.0039702950637541283, 0.0053980174587720722, 0.0076790972406084648, 0.0039702950637541187, 0.0092044313838945541, 0.0107150271144243695, 0.0182368931596497731, 0.0119098797114692082, 0.0072025760830520405, 0.0182368931596497107, 0.0481154537934523063, 0.0187814764797481874, 0.0077493163615806326, 0.0119098797114692220, 0.0187814764797482568, 0.0221860309935336744, 0.0040029316810348999, 0.0072025760830520327, 0.0077493163615806058, 0.0040029316810349484, 0.0141748712171174147, 0.0107161434071351563, 0.0136933463313662282, 0.0105101810945473374, 0.0068278330476330392, 0.0136933463313659767, 0.0347892774862379947, 0.0092422551827851512, 0.0019015181727511112, 0.0105101810945475299, 0.0092422551827856837, 0.0222234182914045966, 0.0009383436132616523, 0.0068278330476330123, 0.0019015181727512092, 0.0009383436132615408, 0.0174833304494358653, 0.0143661986378830556, 0.0191395910897999011, 0.0143417950419374683, 0.0091588909900289957, 0.0191395910897995923, 0.0488471157196652406, 0.0140276314940283031, 0.0034587995622960624, 0.0143417950419376834, 0.0140276314940287732, 0.0297725029673371333, 0.0017488566936014146, 0.0091588909900289228, 0.0034587995622960286, 0.0017488566936012377, 0.0228131427709564356, 0.0191079399721275807, 0.0275432728517291080, 0.0197302561606566701, 0.0122858441112139068, 0.0275432728517290247, 0.0709665447599887589, 0.0230342928419454106, 0.0071672599759756237, 0.0197302561606568574, 0.0230342928419456222, 0.0395581200638281325, 0.0036889552154464821, 0.0122858441112138322, 0.0071672599759755387, 0.0036889552154463498, 0.0287429380404091300, 0.0237558332220541672, 0.0357066321874647818, 0.0249726075094868945, 0.0153433237053061267, 0.0357066321874648027, 0.0925042432854234903, 0.0316666958899815276, 0.0106957362352195773, 0.0249726075094870645, 0.0316666958899817774, 0.0491275912107800306, 0.0055175905663378995, 0.0153433237053061007, 0.0106957362352195426, 0.0055175905663378752, 0.0346325684782706616, 0.0259670468151665702, 0.0371509966005096129, 0.0267013161974046266, 0.0165826873108411779, 0.0371509966005094186, 0.0955436771900622372, 0.0306114979156413697, 0.0092090155139870102, 0.0267013161974047133, 0.0306114979156416993, 0.0536402329148645135, 0.0047218110922978103, 0.0165826873108411502, 0.0092090155139870344, 0.0047218110922977738, 0.0391764237308871652, 0.0266873946258243469, 0.0345105593493172935, 0.0263072522570883503, 0.0167239866510717067, 0.0345105593493173490, 0.0874618720789730464, 0.0237447743545872447, 0.0047105240902268024, 0.0263072522570883365, 0.0237447743545871788, 0.0551553098695400368, 0.0023562289010832585, 0.0167239866510716477, 0.0047105240902266124, 0.0023562289010831674, 0.0429397618725754701, 0.0324492022657204976, 0.0455870857144938663, 0.0330987738409499049, 0.0205714919409599947, 0.0455870857144939010, 0.1168599829673090534, 0.0364360398508108349, 0.0102818010526592642, 0.0330987738409498355, 0.0364360398508108002, 0.0669685114325384856, 0.0052566381472190669, 0.0205714919409599149, 0.0102818010526591671, 0.0052566381472190331, 0.0494939825837196409, 0.0428328843367132214, 0.0693584777669560143, 0.0465274411562092011, 0.0278633962251296045, 0.0693584777669560143, 0.1812454495665768439, 0.0673660954197931039, 0.0253079567417809417, 0.0465274411562092011, 0.0673660954197931039, 0.0883539084400366687, 0.0130921328817790797, 0.0278633962251296045, 0.0253079567417809417, 0.0130921328817790797, 0.0586634124539681459 ))

  expect_equal(c(res$a_t_d_s),
               c( 0.2976975940777115, 0.3355356479130722, -0.7162323180447083, -0.2422761855169988, 0.3515519963408090, 0.7073944628619520,  0.5991179396479441, 0.1919622122767809, 0.7364703056472663, 1.4747323415709452, 2.0473708767046821, 3.3727134236956164,  3.4772364240484972, 0.5748528111147526, 1.8888688138939074, 3.5299191076769745, 4.5105913997780496, 4.2102465799984410,  3.0858276195960013, 4.5932509501623775, 6.6356376189145791, 8.2188032421146549, 3.2120186776709319, 3.2662931263108845,  1.7513713849180075, 2.4315641663011682, 3.2858739344023720, 3.7971835705336487, 3.6392753511766895, 3.0518597686005320,  3.8364161983746010, 4.8998006493547672, 5.7242349343692158, 3.1901148024371970, 3.2183032343060187, 2.4295327786137948,  2.7842737573280605, 3.2253635734349682, 3.4889957521225963, 3.4084900322469873, 3.1061088522292133, 3.5180775864403451,  4.0733237550795121, 4.5034500952032133 ))

  expect_equal(c(res$B_s),
               c( 0.49207752710866237, 0.58462573637626025, 0.29350152929810530, 0.25729006074164973, -0.10841476115810419, -0.01186302739177107, -0.15415709070228170, -0.09346269239530922, -0.09363017368811560, -0.25797456215776038, 0.15662670290393238, -0.09722511291559838, -0.07227747462740919, -0.22769433692279106, -0.11726037988657123, 0.19169007971721586, 1.15271092019995414, 1.57909885383297444,  0.81901843228555049, 0.46136439848230593, -0.23267263245948649, -0.05933984772284372, -0.33436372488504507, -0.17847815396425143, -0.22999557736933091, -0.63524473128306069, 0.25377272047870858, -0.18146197884872972, -0.22186187325102913, -0.62254851829704994, -0.32394265624077145, 0.40346251065799987, 1.40716736790743124, 1.94236875264661957, 1.01014781702051071, 0.54342550989717076, -0.28290829262963274, -0.07632302133093166, -0.40703957355896025, -0.21408959661059196, -0.28097071628027565, -0.77630836422987570,  0.30159888707153587, -0.21516016936979926, -0.27698995878456878, -0.77026152006938697, -0.40112791382029650, 0.49094510966656035,  1.54192386166592899, 2.13291158105948675, 1.11010174677117845, 0.58941487015325600, -0.31162818815250126, -0.09021681764264836, -0.44853518943431692, -0.23490912352741530, -0.30976451915691178, -0.85603284460425488, 0.32535458224915342, -0.23516758962768530, -0.30602472647461310, -0.84892187969078403, -0.44216655631664720, 0.53699148423018761, 1.62642207058049859, 2.25102861375150232,  1.17198778140858373, 0.61842682779593638, -0.32793641953274955, -0.09372114256651463, -0.47209382145045176, -0.24675733565584212, -0.32606263698305893, -0.90115148923143717, 0.34334054311969964, -0.24656009005505208, -0.32321704778608817, -0.89559574857246727, -0.46652311564507803, 0.56693468141555314, 1.68429136028218474, 2.33066210432102894, 1.21371509616498630, 0.63812269815966705, -0.33818249412543017, -0.09312650244816958, -0.48688577568486130, -0.25420354294419834, -0.33633360459457706, -0.92955978605001643,  0.35737881071066524, -0.25373634149345009, -0.33459735028506854, -0.92651136157388558, -0.48265805285987734, 0.58812208758038398,  1.72436823139058815, 2.38256537151463288, 1.24092427566143071, 0.65097363884611781, -0.34472024764900017, -0.09000137346137414, -0.49632123500514119, -0.25895142427727830, -0.34353311548459686, -0.94945026299527202, 0.36814535371934054, -0.25879610643886020, -0.34215089004632260, -0.94702917989627733, -0.49337555367004793, 0.60417808173801835, 1.75947011658414532, 2.43513750151698893,  1.26843944197087977, 0.66450977033590153, -0.35179180114239372, -0.09351681175328530, -0.50652044630195359, -0.26416221275691815, -0.35135701576034317, -0.97107887146977012, 0.37285270156064443, -0.26445923341367927, -0.34979434326255299, -0.96794645266999324, -0.50429186475220600, 0.61477675956260802, 1.78634287557076998, 2.47529599247583221, 1.28946165099301591, 0.67509879850522081, -0.35845453739311461, -0.09961010323871552, -0.51612269304395220, -0.26910812700710041, -0.35800310026650389, -0.98944632903538121,  0.37555950304666902, -0.26936026173263744, -0.35602616392965403, -0.98505448674004470, -0.51323395139323802, 0.62253457593680039,  1.80293060228707946, 2.49290916024315479, 1.29867353544673958, 0.67949714264452465, -0.35971518222897947, -0.09288859351080768, -0.51795576063658988, -0.27001485851333407, -0.35976744856650400, -0.99436085075846925, 0.38321243017075712, -0.27058068225219090, -0.35818739498873065, -0.99095239408146463, -0.51630097080348214, 0.63128417840532858 ))

  expect_equal(c(res$lag_one_cor),
               c( 9.773912417174230e-04, 8.452174746921774e-04, 8.545499951040494e-04, 7.867031169300092e-04, 7.844892610311425e-04,  2.052788248434415e-03, 6.059353988681756e-05, -5.530944051913969e-05, 7.939077593570468e-04, -1.955692549971059e-05,  2.122529349506580e-03, -5.692180582842217e-05, 7.710353629302809e-04, -5.296910542235223e-05, -3.395776816279783e-05,  2.049532936427957e-03, 3.770906143039861e-03, 3.787782228339462e-03, 3.367925898517553e-03, 2.433914202423396e-03,  3.788271166793753e-03, 9.187533986464493e-03, 1.106808963753627e-03, -4.536499487914953e-04, 3.367230128795532e-03,  1.104181545114518e-03, 7.808055695736738e-03, -2.680582833692554e-04, 2.433424103570334e-03, -4.552693800092773e-04, -2.681769826129269e-04, 6.932577728855622e-03, 6.361151776521539e-03, 6.303150520452103e-03, 5.670831718940264e-03,  3.963594540750432e-03, 6.351225983440716e-03, 1.530279898461736e-02, 1.734255023949479e-03, -1.078140735404414e-03,  5.682179513007309e-03, 1.696393091344537e-03, 1.318103528840189e-02, -6.069209784669580e-04, 3.982541602767322e-03, -1.061732813714375e-03, -5.880893988755314e-04, 1.168478481092926e-02, 8.941722032843161e-03, 8.885913321055572e-03,  7.984892150653049e-03, 5.521333593865700e-03, 8.862887889818925e-03, 2.147186024413476e-02, 2.353369347914927e-03, -1.640592040083457e-03, 7.979575533048950e-03, 2.371831891867353e-03, 1.854229970214901e-02, -9.023026692053188e-04,  5.517107632857135e-03, -1.634971919592140e-03, -9.043579654283985e-04, 1.642507195329238e-02, 1.164083939750444e-02,  1.169726939163646e-02, 1.044518240058684e-02, 7.138524400427576e-03, 1.164803314969903e-02, 2.817327478539336e-02,  3.302899516583692e-03, -2.082297752166813e-03, 1.043382983239461e-02, 3.342426091453063e-03, 2.411019535911246e-02, -1.127437088943237e-03, 7.120935459874985e-03, -2.093985715225483e-03, -1.144217996879212e-03, 2.121514091562575e-02,  1.440342416608121e-02, 1.462771740874015e-02, 1.298259385473646e-02, 8.781800028076681e-03, 1.461229104648828e-02,  3.525968967473645e-02, 4.474557812849870e-03, -2.452351874366743e-03, 1.296686412197991e-02, 4.453301164076027e-03,  2.978561753385892e-02, -1.328996339601557e-03, 8.769673485006605e-03, -2.474286746309949e-03, -1.334636982454105e-03,  2.604019430372752e-02, 1.712348227897290e-02, 1.745922213699245e-02, 1.544773004830993e-02, 1.039377835769165e-02,  1.746868537240253e-02, 4.213031468842777e-02, 5.462128355171911e-03, -2.903828711547875e-03, 1.543278320868258e-02,  5.407195286746703e-03, 3.535895136866583e-02, -1.583147647626765e-03, 1.039225901317860e-02, -2.915102990154492e-03, -1.574106676277540e-03, 3.085775483010389e-02, 1.972194792845008e-02, 1.996132063408608e-02, 1.773020663773869e-02,  1.192026762948649e-02, 2.002581760226801e-02, 4.824121807614260e-02, 6.000381469500710e-03, -3.566780410952961e-03,  1.774599968342393e-02, 5.951152451940279e-03, 4.071852189330595e-02, -1.948258744756459e-03, 1.194197130765993e-02, -3.555121880229236e-03, -1.928822177591705e-03, 3.564415123316966e-02, 2.245105055230594e-02, 2.284036923471577e-02,  2.021865960394738e-02, 1.355913431813000e-02, 2.276694530512329e-02, 5.502145547622857e-02, 6.860041763241721e-03, -4.059070632188170e-03, 2.018604344022054e-02, 6.875641328877025e-03, 4.632690825717635e-02, -2.208332728425486e-03,  1.352953283672661e-02, -4.085828917736103e-03, -2.226508755267709e-03, 4.051665930127184e-02, 2.555604438333877e-02,  2.655066280828191e-02, 2.317684303458410e-02, 1.540949533554323e-02, 2.645951310667009e-02, 6.400356139908009e-02,  8.901794420165390e-03, -4.040858228007723e-03, 2.314530550079580e-02, 8.945897344881420e-03, 5.263013435906243e-02, -2.193855441948276e-03, 1.537729737917124e-02, -4.061528340509657e-03, -2.216587878631656e-03, 4.559037964664375e-02 ))

  expect_equal(c(res$Q),
               c(0.3284521133661092, 0.9028465556511629, 0.4714318169537647, 0.2456850096146581, 0.9028465556511629, 2.4939853112360222, 1.2967561771330269, 0.6738975151263655, 0.4714318169537647, 1.2967561771330269, 0.6808940547554896, 0.3511088793016583, 0.2456850096146581, 0.6738975151263655, 0.3511088793016583, 0.1878572384173380 ))

  expect_equal(c(res$Q_0),
               c(0.002091399145939896, 0.003904166905141964, 0.002452924735514583, 0.001619374300039043, 0.003904166905141964, 0.010670985441660553, 0.004540985218065647, 0.002271430519423565, 0.002452924735514583, 0.004540985218065647, 0.004520859688971047, 0.001177280064462576, 0.001619374300039043, 0.002271430519423565, 0.001177280064462576, 0.002701069842984223 ))
})






#########
# Without estimating Q_0 and second order

# Setup the parems we need to parse
n_parem <- ncol(design_mat$X)

Q_0 <- Q <- matrix(0.0, nrow = n_parem * 2, ncol = n_parem * 2)
diag(Q[1:n_parem, 1:n_parem]) <- 1.0e-6
diag(Q_0) <- 1.0e1

a_0 <- rep(0, 2 * n_parem)

F_ = matrix(NA_real_, nrow = 2 * n_parem, ncol = 2 * n_parem)
F_[1:n_parem, 1:n_parem] = diag(2, n_parem)
F_[n_parem + 1:n_parem, 1:n_parem] = diag(1, n_parem)
F_[1:n_parem, n_parem + 1:n_parem] = diag(-1, n_parem)
F_[n_parem + 1:n_parem, n_parem + 1:n_parem] = 0.0

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = a_0,
                    Q_0 = Q_0,
                    Q = Q,
                    F_= F_, # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 2,
                    est_Q_0 = F)

# expect_equal_eps <- 1.0e-3
# get_expect_equal(res, eps = expect_equal_eps)

test_that("Testing versus previously computed values with order 2 and no Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 6.615875982470545e-01, 3.606226349826424e-01, 3.562742159025620e-01, 3.599313799798862e-01,  9.003966826819754e-01, 3.791927597183573e-01, 3.741091162070700e-01, 3.777406758286611e-01,  3.606226349826364e-01, 1.192185657476818e+00, -3.586043346758416e-02, -2.304429939291427e-02,  3.802484060197629e-01, 1.428242373894485e+00, -2.318774805272042e-02, -9.305580378345210e-03,  3.562742159025734e-01, -3.586043346757593e-02, 1.200744821320226e+00, -3.703093559481808e-02,  3.752474140180658e-01, -2.322163155447160e-02, 1.437539050049772e+00, -2.518906011387680e-02,  3.599313799798854e-01, -2.304429939291255e-02, -3.703093559482912e-02, 1.195433544996753e+00,  3.786335826931017e-01, -9.352315051066212e-03, -2.519494196410405e-02, 1.431270762117626e+00,  9.003966826819763e-01, 3.802484060197719e-01, 3.752474140180487e-01, 3.786335826931010e-01,  1.466959212808479e+00, 2.994569519241934e-01, 2.936921392276947e-01, 2.965353441612760e-01,  3.791927597183495e-01, 1.428242373894485e+00, -2.322163155448098e-02, -9.352315051069301e-03,  2.994569519241811e-01, 1.769360645531510e+00, 3.573323080557264e-02, 5.077989962183067e-02,  3.741091162070830e-01, -2.318774805271110e-02, 1.437539050049767e+00, -2.519494196409155e-02,  2.936921392277154e-01, 3.573323080558330e-02, 1.779308230330178e+00, 3.268547071005519e-02,  3.777406758286625e-01, -9.305580378342559e-03, -2.518906011388904e-02, 1.431270762117624e+00,  2.965353441612799e-01, 5.077989962183538e-02, 3.268547071004149e-02, 1.771944353140483e+00,  3.465385355824335e-01, 2.889907976182187e-01, 2.859406321432048e-01, 2.895845983634595e-01,  4.152099009239796e-01, 3.439836842325045e-01, 3.403146303804064e-01, 3.442659610276472e-01,  2.889907976182160e-01, 7.988211769554647e-01, -4.117679291089616e-02, -3.045140061021382e-02,  3.450745903668040e-01, 9.549361429838106e-01, -4.970258631048974e-02, -3.794888846126054e-02,  2.859406321432110e-01, -4.117679291088996e-02, 8.058673320876508e-01, -4.101577864767222e-02,  3.414574667416987e-01, -4.972422108386015e-02, 9.627486602361114e-01, -5.007795569269057e-02,  2.895845983634566e-01, -3.045140061021372e-02, -4.101577864768069e-02, 8.021657150200170e-01,  3.451491933169896e-01, -3.797765737363654e-02, -5.007816425201733e-02, 9.583815612107790e-01,  4.152099009239798e-01, 3.450745903668082e-01, 3.414574667416888e-01, 3.451491933169924e-01,  6.615875982470365e-01, 3.606226349826430e-01, 3.562742159025624e-01, 3.599313799798868e-01,  3.439836842325017e-01, 9.549361429838127e-01, -4.972422108386731e-02, -3.797765737363736e-02,  3.606226349826371e-01, 1.192185657476803e+00, -3.586043346758423e-02, -2.304429939291432e-02,  3.403146303804122e-01, -4.970258631048261e-02, 9.627486602361101e-01, -5.007816425200742e-02,  3.562742159025738e-01, -3.586043346757600e-02, 1.200744821320219e+00, -3.703093559481813e-02,  3.442659610276452e-01, -3.794888846126014e-02, -5.007795569270015e-02, 9.583815612107780e-01,  3.599313799798861e-01, -2.304429939291260e-02, -3.703093559482917e-02, 1.195433544996740e+00,  2.367031553413416e-01, 1.983764104190523e-01, 1.963773397203408e-01, 1.995279227777275e-01,  2.775414863934805e-01, 2.329635048284675e-01, 2.305525845362417e-01, 2.341807775776477e-01,  1.983764104190509e-01, 5.438299382546365e-01, -2.559944605999156e-02, -1.696351978657285e-02,  2.341277873974713e-01, 6.426832869013331e-01, -3.268081825261623e-02, -2.298937405803656e-02,  1.963773397203447e-01, -2.559944605998709e-02, 5.493414429691388e-01, -2.473956780691825e-02,  2.316963424955491e-01, -3.267355984280276e-02, 6.489342805261021e-01, -3.201753579544041e-02,  1.995279227777249e-01, -1.696351978657336e-02, -2.473956780692433e-02, 5.465294101413072e-01,  2.350333283232536e-01, -2.297654384177460e-02, -3.200514057297883e-02, 6.458851999574415e-01,  2.775414863934807e-01, 2.341277873974736e-01, 2.316963424955430e-01, 2.350333283232565e-01,  3.465385355821622e-01, 2.889907976182681e-01, 2.859406321428791e-01, 2.895845983632703e-01,  2.329635048284668e-01, 6.426832869013346e-01, -3.267355984280806e-02, -2.297654384177437e-02,  2.889907976182655e-01, 7.988211769556353e-01, -4.117679291112945e-02, -3.045140061013358e-02,  2.305525845362452e-01, -3.268081825261097e-02, 6.489342805261006e-01, -3.200514057297132e-02,  2.859406321428852e-01, -4.117679291112325e-02, 8.058673320872937e-01, -4.101577864775754e-02,  2.341807775776452e-01, -2.298937405803719e-02, -3.201753579544739e-02, 6.458851999574413e-01,  2.895845983632673e-01, -3.045140061013348e-02, -4.101577864776600e-02, 8.021657150200558e-01,  1.810304473881092e-01, 1.508373289596369e-01, 1.498205670165981e-01, 1.516990839793430e-01,  1.956874579213424e-01, 1.646985357971762e-01, 1.635146201754072e-01, 1.659567285119264e-01,  1.508373289596360e-01, 4.017339473594024e-01, -1.467473642186378e-02, -8.009879202758374e-03,  1.638598768934484e-01, 4.441480461656676e-01, -1.950615857949605e-02, -1.172286552619482e-02,  1.498205670166009e-01, -1.467473642186107e-02, 4.055487447341229e-01, -1.370208047711320e-02,  1.622725647701565e-01, -1.934497935910036e-02, 4.487684891046678e-01, -1.824535675524080e-02,  1.516990839793411e-01, -8.009879202758943e-03, -1.370208047711695e-02, 4.031404710298481e-01,  1.649457449672526e-01, -1.176703201418363e-02, -1.844406110901919e-02, 4.463994085262002e-01,  1.956874579213423e-01, 1.638598768934501e-01, 1.622725647701526e-01, 1.649457449672546e-01,  2.367031553412827e-01, 1.983764104190930e-01, 1.963773397203098e-01, 1.995279227776699e-01,  1.646985357971753e-01, 4.441480461656692e-01, -1.934497935910394e-02, -1.176703201418302e-02,  1.983764104190916e-01, 5.438299382547067e-01, -2.559944605998966e-02, -1.696351978648133e-02,  1.635146201754102e-01, -1.950615857949283e-02, 4.487684891046657e-01, -1.844406110901444e-02,  1.963773397203137e-01, -2.559944605998518e-02, 5.493414429691699e-01, -2.473956780699588e-02,  1.659567285119239e-01, -1.172286552619544e-02, -1.824535675524538e-02, 4.463994085262001e-01,  1.995279227776673e-01, -1.696351978648184e-02, -2.473956780700196e-02, 5.465294101413067e-01,  1.747510898596188e-01, 1.452872230358198e-01, 1.446513223969765e-01, 1.449745123990805e-01,  1.645410589319052e-01, 1.377183772648728e-01, 1.370647933468865e-01, 1.381185989866141e-01,  1.452872230358196e-01, 3.741594543382043e-01, -6.563704989011279e-03, -1.945808819828291e-03,  1.377074471130805e-01, 3.593575252471298e-01, -9.883214252595685e-03, -4.119459661951526e-03,  1.446513223969776e-01, -6.563704989009711e-03, 3.765372108202859e-01, -6.047180307078470e-03,  1.368568867148063e-01, -9.804889114943684e-03, 3.624493184706797e-01, -8.827004779787909e-03,  1.449745123990792e-01, -1.945808819828540e-03, -6.047180307080544e-03, 3.736589031991818e-01,  1.381739774839172e-01, -4.258363843101859e-03, -9.037331839138994e-03, 3.600142308404680e-01,  1.645410589319049e-01, 1.377074471130815e-01, 1.368568867148041e-01, 1.381739774839186e-01,  1.810304473881038e-01, 1.508373289596206e-01, 1.498205670165435e-01, 1.516990839793486e-01,  1.377183772648730e-01, 3.593575252471309e-01, -9.804889114945953e-03, -4.258363843101406e-03,  1.508373289596198e-01, 4.017339473593822e-01, -1.467473642192738e-02, -8.009879202779697e-03,  1.370647933468874e-01, -9.883214252593581e-03, 3.624493184706786e-01,
                  -9.037331839135803e-03,  1.498205670165463e-01, -1.467473642192467e-02, 4.055487447340290e-01, -1.370208047712273e-02,  1.381185989866122e-01, -4.119459661951994e-03, -8.827004779790560e-03, 3.600142308404681e-01,  1.516990839793467e-01, -8.009879202780266e-03, -1.370208047712648e-02, 4.031404710298572e-01,  2.201314308927540e-01, 1.813268934678126e-01, 1.807682665249822e-01, 1.796794315834398e-01,  1.829114851194413e-01, 1.532531993899708e-01, 1.527750219670542e-01, 1.525996236768160e-01,  1.813268934678123e-01, 4.610628430321737e-01, -1.427630694103565e-03, 8.964914797491216e-04,  1.536740649292425e-01, 3.888061282931372e-01, -3.454002652120321e-03, 3.747722059603206e-05,  1.807682665249825e-01, -1.427630694103232e-03, 4.620261896294937e-01, -2.225558522929341e-03,  1.530547827842895e-01, -3.398211700581695e-03, 3.904927502047646e-01, -3.385867472453057e-03,  1.796794315834394e-01, 8.964914797489967e-04, -2.225558522930021e-03, 4.574609239307124e-01,  1.526497808634427e-01, 7.336038647413196e-05, -3.399062873673822e-03, 3.869727254616209e-01,  1.829114851194410e-01, 1.536740649292429e-01, 1.530547827842884e-01, 1.526497808634436e-01,  1.747510898596177e-01, 1.452872230358307e-01, 1.446513223969771e-01, 1.449745123990528e-01,  1.532531993899706e-01, 3.888061282931384e-01, -3.398211700582417e-03, 7.336038647449278e-05,  1.452872230358305e-01, 3.741594543381983e-01, -6.563704988998751e-03, -1.945808819855973e-03,  1.527750219670544e-01, -3.454002652119592e-03, 3.904927502047639e-01, -3.399062873672462e-03,  1.446513223969781e-01, -6.563704988997186e-03, 3.765372108203101e-01, -6.047180307090824e-03,  1.525996236768152e-01, 3.747722059587247e-05, -3.385867472454136e-03, 3.869727254616206e-01,  1.449745123990515e-01, -1.945808819856223e-03, -6.047180307092899e-03, 3.736589031991443e-01,  3.151062079112844e-01, 2.596402861171481e-01, 2.591520611732209e-01, 2.568750564570552e-01,  2.515300762800605e-01, 2.109601777791578e-01, 2.105870226491988e-01, 2.092699894308474e-01,  2.596402861171482e-01, 6.622272073695159e-01, 3.980897979636855e-04, 1.496333326198862e-04,  2.117245938788246e-01, 5.325276459688919e-01, -2.976857734308669e-04, 6.970460486995997e-04,  2.591520611732209e-01, 3.980897979637410e-04, 6.615619809582332e-01, -2.723154587922313e-03,  2.110824944777669e-01, -1.910268814377808e-04, 5.327189684711227e-01, -2.073298760651453e-03,  2.568750564570550e-01, 1.496333326200666e-04, -2.723154587922438e-03, 6.540280176511790e-01,  2.090871109640038e-01, 9.633883069218516e-04, -1.907287361797669e-03, 5.269237302901444e-01,  2.515300762800607e-01, 2.117245938788248e-01, 2.110824944777666e-01, 2.090871109640039e-01,  2.201314308928135e-01, 1.813268934678395e-01, 1.807682665250332e-01, 1.796794315834817e-01,  2.109601777791579e-01, 5.325276459688923e-01, -1.910268814379196e-04, 9.633883069217336e-04,  1.813268934678391e-01, 4.610628430321666e-01, -1.427630694058789e-03, 8.964914797717043e-04,  2.105870226491986e-01, -2.976857734309363e-04, 5.327189684711218e-01, -1.907287361797336e-03,  1.807682665250334e-01, -1.427630694058463e-03, 4.620261896294933e-01, -2.225558522902217e-03,  2.092699894308473e-01, 6.970460486997454e-04, -2.073298760651557e-03, 5.269237302901444e-01,  1.796794315834812e-01, 8.964914797715724e-04, -2.225558522902897e-03, 4.574609239307568e-01,  4.551360209365355e-01, 3.819597423199368e-01, 3.820762115342811e-01, 3.780384767836645e-01,  3.697423542921959e-01, 3.109673173202488e-01, 3.110990459461266e-01, 3.081080386262565e-01,  3.819597423199367e-01, 9.769941033860574e-01, -1.962147014956329e-03, -4.743874731712120e-03,  3.118897676890190e-01, 7.905636767908418e-01, -5.610467988752307e-04, -2.039726467835495e-03,  3.820762115342810e-01, -1.962147014956336e-03, 9.740544468905703e-01, -8.314079230708427e-03,  3.112818309107839e-01, -2.665105233552213e-04, 7.888578073187100e-01, -4.912835318678203e-03,  3.780384767836646e-01, -4.743874731712103e-03, -8.314079230708475e-03, 9.629060266972620e-01,  3.080554337423452e-01, -1.762194619129104e-03, -4.923838917942180e-03, 7.797534643098301e-01,  3.697423542921959e-01, 3.118897676890190e-01, 3.112818309107838e-01, 3.080554337423452e-01,  3.151062079112422e-01, 2.596402861171235e-01, 2.591520611732238e-01, 2.568750564570224e-01,  3.109673173202486e-01, 7.905636767908419e-01, -2.665105233551433e-04, -1.762194619129149e-03,  2.596402861171236e-01, 6.622272073695954e-01, 3.980897979551420e-04, 1.496333325638304e-04,  3.110990459461264e-01, -5.610467988752428e-04, 7.888578073187097e-01, -4.923838917942146e-03,  2.591520611732238e-01, 3.980897979551871e-04, 6.615619809583015e-01, -2.723154587924118e-03,  3.081080386262566e-01, -2.039726467835477e-03, -4.912835318678276e-03, 7.797534643098298e-01,  2.568750564570222e-01, 1.496333325640212e-04, -2.723154587924246e-03, 6.540280176511580e-01,  6.492993838247449e-01, 5.453570569067442e-01, 5.461232250338717e-01, 5.392442383269910e-01,  5.382708286735324e-01, 4.535000431486589e-01, 4.541783229116720e-01, 4.485859258307745e-01,  5.453570569067442e-01, 1.406256922506389e+00, -7.421283184755960e-03, -1.249496100220428e-02,  4.538539213863211e-01, 1.162836890987739e+00, -4.179960586577595e-03, -7.950920375676775e-03,  5.461232250338717e-01, -7.421283184755960e-03, 1.400787937118141e+00, -1.751371375748256e-02,  4.539539578071028e-01, -3.949584988864136e-03, 1.158729050021079e+00, -1.192938953252745e-02,  5.392442383269910e-01, -1.249496100220428e-02, -1.751371375748256e-02, 1.385785141176176e+00,  4.488721680348137e-01, -8.036099581263645e-03, -1.223836513423021e-02, 1.145832306107906e+00,  5.382708286735323e-01, 4.538539213863211e-01, 4.539539578071028e-01, 4.488721680348137e-01,  4.551360209365095e-01, 3.819597423199042e-01, 3.820762115342480e-01, 3.780384767836326e-01,  4.535000431486588e-01, 1.162836890987738e+00, -3.949584988864126e-03, -8.036099581263681e-03,  3.819597423199041e-01, 9.769941033860599e-01, -1.962147015005686e-03, -4.743874731744435e-03,  4.541783229116720e-01, -4.179960586577599e-03, 1.158729050021078e+00, -1.223836513423021e-02,  3.820762115342480e-01, -1.962147015005692e-03, 9.740544468905072e-01, -8.314079230735866e-03,  4.485859258307745e-01, -7.950920375676761e-03, -1.192938953252747e-02, 1.145832306107906e+00,  3.780384767836327e-01, -4.743874731744417e-03, -8.314079230735915e-03, 9.629060266972143e-01,  8.941603796352819e-01, 7.498929799001679e-01, 7.509465318297844e-01, 7.410445039646061e-01,  7.565441680190135e-01, 6.376805173095692e-01, 6.386193231207413e-01, 6.302100890018977e-01,  7.498929799001679e-01, 1.950517754920187e+00, -1.531766493797071e-02, -2.279927920354191e-02,  6.387248596625503e-01, 1.649349210648522e+00, -1.102348685951371e-02, -1.719091892522868e-02,  7.509465318297844e-01, -1.531766493797071e-02, 1.942588042426311e+00, -2.985521964563215e-02,  6.395769520249635e-01, -1.098973780142639e-02, 1.642716301617350e+00, -2.302584691523205e-02,  7.410445039646061e-01, -2.279927920354191e-02, -2.985521964563215e-02, 1.922776107083827e+00,  6.314158552943892e-01, -1.736710246460791e-02, -2.322875476902012e-02, 1.625500296935363e+00,  7.565441680190135e-01, 6.387248596625503e-01, 6.395769520249635e-01, 6.314158552943892e-01,  6.492993838247632e-01, 5.453570569067471e-01,
                  5.461232250338928e-01, 5.392442383270122e-01,  6.376805173095692e-01, 1.649349210648522e+00, -1.098973780142638e-02, -1.736710246460791e-02,  5.453570569067471e-01, 1.406256922506383e+00, -7.421283184752512e-03, -1.249496100219892e-02,  6.386193231207413e-01, -1.102348685951371e-02, 1.642716301617350e+00, -2.322875476902012e-02,  5.461232250338928e-01, -7.421283184752511e-03, 1.400787937118186e+00, -1.751371375747368e-02,  6.302100890018977e-01, -1.719091892522868e-02, -2.302584691523205e-02, 1.625500296935363e+00,  5.392442383270122e-01, -1.249496100219891e-02, -1.751371375747368e-02, 1.385785141176213e+00,  1.202822537902525e+00, 9.908726476554451e-01, 9.921404392559963e-01, 9.791727352590736e-01,  1.024447854987877e+00, 8.639739176108011e-01, 8.651099194511060e-01, 8.538087026467522e-01,  9.908726476554451e-01, 2.611439263574348e+00, -2.410603814930849e-02, -3.416777637100787e-02,  8.650317997078977e-01, 2.250523173630090e+00, -2.076116227068739e-02, -2.948348331260934e-02,  9.921404392559963e-01, -2.410603814930849e-02, 2.600887347578895e+00, -4.396470048539553e-02,  8.661962928521926e-01, -2.077342158877526e-02, 2.241345627996160e+00, -3.773208301904292e-02,  9.791727352590736e-01, -3.416777637100787e-02, -4.396470048539553e-02, 2.575198239124671e+00,  8.548101463340998e-01, -2.957266500268625e-02, -3.780201720370648e-02, 2.218797770653290e+00,  1.024447854987877e+00, 8.650317997078977e-01, 8.661962928521926e-01, 8.548101463340998e-01,  8.941603796352824e-01, 7.498929799001683e-01, 7.509465318297794e-01, 7.410445039646077e-01,  8.639739176108011e-01, 2.250523173630090e+00, -2.077342158877526e-02, -2.957266500268625e-02,  7.498929799001683e-01, 1.950517754920187e+00, -1.531766493797219e-02, -2.279927920354366e-02,  8.651099194511060e-01, -2.076116227068739e-02, 2.241345627996160e+00, -3.780201720370648e-02,  7.509465318297794e-01, -1.531766493797219e-02, 1.942588042426295e+00, -2.985521964563190e-02,  8.538087026467522e-01, -2.948348331260934e-02, -3.773208301904292e-02, 2.218797770653290e+00,  7.410445039646077e-01, -2.279927920354366e-02, -2.985521964563190e-02, 1.922776107083831e+00 )
               , tolerance = 0.001)

  expect_equal(c(res$a_t_d_s),
               c(-1.4123046491430307, -0.5954743136826726, 0.2213560391536888, 0.5754228004283394, 0.4698914404006738,  0.4464133851566777, 1.0688468914047367, 1.4667095088706055, 1.4616751523713563, 1.1001336384007918,  1.0053399723953271, 0.9973862180715898, 1.5020731695230305, 2.0067601139691322, 2.6962293511170388,  3.5692169557345039, 4.4094404702717158, 4.9917502050457223, 5.6637304773183459, 6.4965872815285035,  7.4717975027796353, 8.3404950109654319, 3.2677453193942561, 3.1441159270896901, 3.0204865277877126,  3.0813992647779567, 3.3255922676826648, 3.5370644607219224, 3.4909586547929088, 3.5344071178510594,  3.7385231088144035, 4.0848074033357626, 4.3247174459446747, 3.1409870893760550, 2.9872685304436715,  2.8335499644909627, 2.8649211900855192, 3.0801163458681691, 3.2624939543240790, 3.1865303079289555,  3.2003879498331660, 3.3753909214833664, 3.6929846625492986, 3.9038886254757021, -2.2291349807684200, -1.4123046491430307, -0.5954743136828505, 0.2213560391536676, 0.5754228004283487, 0.4698914404006740,  0.4464133851566493, 1.0688468914047304, 1.4667095088705844, 1.4616751523713547, 1.1001336384007856,  0.4926992650644993, 0.9973862180715898, 1.5020731695230343, 2.0067601139691229, 2.6962293511170716,  3.5692169557345017, 4.4094404702716972, 4.9917502050457578, 5.6637304773183486, 6.4965872815284964,  7.4717975027796415, 3.3913747101448806, 3.2677453193942561, 3.1441159270894805, 3.0204865277877149,  3.0813992647780521, 3.3255922676826457, 3.5370644607219002, 3.4909586547929194, 3.5344071178510079,  3.7385231088144213, 4.0848074033357413, 3.2947056467489624, 3.1409870893760550, 2.9872685304437021,  2.8335499644909259, 2.8649211900855107, 3.0801163458681984, 3.2624939543240625, 3.1865303079289480,  3.2003879498331513, 3.3753909214833535, 3.6929846625492866 )
               , tolerance = 0.001)

  expect_equal(c(res$B_s),
               c( 0.000000000000000e+00, 0.000000000000000e+00, -1.734723475976807e-18, 1.734723475976807e-18, -9.835431301476207e-01, -6.571203164241710e-03, -6.562659016595791e-03, -6.582137939999806e-03,  1.734723475976807e-18, -2.220446049250313e-16, -8.673617379884035e-19, 0.000000000000000e+00, -6.571203164241710e-03, -9.973760125937068e-01, 2.620475726216801e-03, 2.628253682314231e-03,  0.000000000000000e+00, -8.673617379884035e-19, -2.220446049250313e-16, 0.000000000000000e+00, -6.562659016595791e-03, 2.620475726216801e-03, -9.973828315250400e-01, 2.624836322309116e-03, -1.734723475976807e-18, -1.734723475976807e-18, 0.000000000000000e+00, 0.000000000000000e+00, -6.582137939999806e-03, 2.628253682314231e-03, 2.624836322309116e-03, -9.973672727536373e-01,  9.999999999999991e-01, 3.469446951953614e-18, 3.469446951953614e-18, -3.469446951953614e-18,  1.967086260295241e+00, 1.314240632848342e-02, 1.312531803319158e-02, 1.316427587999961e-02,  0.000000000000000e+00, 9.999999999999996e-01, 0.000000000000000e+00, 0.000000000000000e+00,  1.314240632848342e-02, 1.994752025187414e+00, -5.240951452433602e-03, -5.256507364628460e-03,  0.000000000000000e+00, 0.000000000000000e+00, 1.000000000000000e+00, 0.000000000000000e+00,  1.312531803319158e-02, -5.240951452433602e-03, 1.994765663050080e+00, -5.249672644618232e-03,  3.469446951953614e-18, 3.469446951953614e-18, 0.000000000000000e+00, 9.999999999999991e-01,  1.316427587999961e-02, -5.256507364628462e-03, -5.249672644618232e-03, 1.994734545507275e+00,  7.632783294297951e-17, 9.172350379227368e-17, -1.118896642005041e-16, -1.110223024625157e-16, -9.263140180291868e-01, -2.942267993869019e-02, -2.938442336339175e-02, -2.947164058607093e-02, -1.353084311261910e-16, 4.282598581317743e-17, -3.538835890992686e-16, 2.983724378680108e-16, -2.942267993869018e-02, -9.882509971105102e-01, 1.173322703366996e-02, 1.176805297133802e-02,  1.110223024625157e-16, -8.164042358815848e-17, 6.203804830962056e-16, 2.775557561562891e-17, -2.938442336339170e-02, 1.173322703367007e-02, -9.882815289962765e-01, 1.175275168186918e-02,  4.440892098500626e-16, -2.914335439641036e-16, 0.000000000000000e+00, 0.000000000000000e+00, -2.947164058607105e-02, 1.176805297133779e-02, 1.175275168186918e-02, -9.882118643033448e-01,  9.999999999999147e-01, -3.197442310920451e-14, -3.552713678800501e-15, -5.684341886080801e-14,  1.881956157008375e+00, 4.713469438008744e-02, 4.707340791713222e-02, 4.721312860684179e-02,  4.263256414560601e-14, 1.000000000000036e+00, -3.463895836830488e-14, 2.842170943040401e-14,  4.713469438003770e-02, 1.981178273616930e+00, -1.879645468986180e-02, -1.885224532244933e-02, -1.421085471520200e-14, -1.643130076445232e-14, 9.999999999999485e-01, 2.842170943040401e-14,  4.707340791706116e-02, -1.879645468984792e-02, 1.981227185242502e+00, -1.882773288495798e-02, -2.842170943040401e-14, 2.886579864025407e-14, -3.019806626980426e-14, 1.000000000000028e+00,  4.721312860694127e-02, -1.885224532251617e-02, -1.882773288502060e-02, 1.981115583443952e+00,  6.661338147750939e-16, 4.267419750902945e-16, -8.326672684688674e-17, -4.440892098500626e-16, -3.300267828080909e-01, -2.675203376338823e-01, -2.671724917383367e-01, -2.679654986645823e-01, -2.220446049250313e-16, 1.946793420914972e-15, -7.563394355258879e-16, -2.220446049250313e-16, -2.671593014969690e-01, -8.933215632702096e-01, 1.065382235440188e-01, 1.068544428802946e-01, -2.220446049250313e-16, -5.876375774871434e-16, 1.318389841742373e-15, 0.000000000000000e+00, -2.658539927751670e-01, 1.061557203232655e-01, -8.939808052077295e-01, 1.063323701878746e-01,  0.000000000000000e+00, -3.625572064791527e-16, -1.165734175856414e-15, -8.881784197001252e-16, -2.665127325146648e-01, 1.064187539963696e-01, 1.062803875267266e-01, -8.934026556430004e-01,  9.999999999999716e-01, 1.776356839400250e-14, -3.019806626980426e-14, 0.000000000000000e+00,  6.613211699582422e-01, 5.345348389766693e-01, 5.338398042408476e-01, 5.354243186469034e-01,  2.131628207280301e-14, 1.000000000000011e+00, 2.664535259100376e-14, 2.842170943040401e-14,  5.338127666667845e-01, 1.786845907577235e+00, -2.128747283657302e-01, -2.135065682735444e-01, -2.131628207280301e-14, -1.754152378907747e-14, 1.000000000000020e+00, -5.684341886080801e-14,  5.312028061823355e-01, -2.121097218858408e-01, 1.788163867141619e+00, -2.124626856251552e-01, -1.421085471520200e-14, 2.192690473634684e-14, 2.309263891220326e-14, 1.000000000000000e+00,  5.325187862015781e-01, -2.126351904620287e-01, -2.123587202976815e-01, 1.787008766002927e+00,  7.216449660063518e-16, -1.322726650432315e-17, -5.169475958410885e-16, 6.661338147750939e-16, -3.255304859428652e-01, -2.693149509985398e-01, -2.689647657561670e-01, -2.697630963188371e-01,  4.510281037539698e-16, 3.097565606791086e-16, -2.558717127065790e-16, 3.053113317719180e-16, -2.675843953471342e-01, -8.931497222490298e-01, 1.067076398163258e-01, 1.070243533950227e-01, -4.579669976578771e-16, 2.973153407498375e-16, 6.114900252818245e-17, -4.996003610813204e-16, -2.662764729923839e-01, 1.063243160470063e-01, -8.938102353708012e-01, 1.065012634558651e-01, -8.881784197001252e-16, 1.370431546021678e-16, -3.469446951953614e-16, 0.000000000000000e+00, -2.672675489571279e-01, 1.067200414520094e-01, 1.065813088197595e-01, -8.930986610487079e-01,  9.999999999999147e-01, -1.004196725773454e-13, -1.456612608308205e-13, -5.684341886080801e-14,  6.585588611190474e-01, 5.356368098719004e-01, 5.349403336375584e-01, 5.365281243376785e-01,  4.263256414560601e-14, 1.000000000000025e+00, 4.440892098500626e-16, 2.842170943040401e-14,  5.321801022114343e-01, 1.787495005100310e+00, -2.122234826707591e-01, -2.128533765147438e-01,  1.421085471520200e-14, 6.328271240363392e-15, 9.999999999999913e-01, 2.842170943040401e-14,  5.295798085864476e-01, -2.114614920152362e-01, 1.788808275192711e+00, -2.118134054233991e-01,  3.552713678800501e-14, 3.733124920302089e-15, 4.107825191113079e-14, 1.000000000000028e+00,  5.315547228993651e-01, -2.122500562675920e-01, -2.119741282690107e-01, 1.787391540336841e+00,  1.387778780781446e-16, 3.564856743132339e-16, 1.302777330458582e-15, 6.106226635438361e-16, -3.252394896265558e-01, -2.694297115718278e-01, -2.690793699075222e-01, -2.698780496756124e-01,  1.665334536937735e-16, 2.949029909160572e-16, 1.665334536937735e-16, 1.110223024625157e-15, -2.690301747539190e-01, -8.925682200557974e-01, 1.072839181565353e-01, 1.076022961800616e-01,  5.551115123125783e-16, 8.673617379884035e-17, 4.295175326518574e-15, -3.330669073875470e-16, -2.685885060348058e-01, 1.072472437886962e-01, -8.928840676484229e-01, 1.074257453918273e-01,  0.000000000000000e+00, 1.443289932012704e-15, -2.331468351712829e-15, 0.000000000000000e+00, -2.688957949332242e-01, 1.073698820784506e-01, 1.072303688504613e-01, -8.924432397327520e-01,  9.999999999999858e-01, -3.552713678800501e-15, 2.486899575160351e-14, -5.684341886080801e-14,  6.547235035432806e-01, 5.371664240866143e-01, 5.364679608430614e-01, 5.380602913234611e-01,  2.131628207280301e-14, 9.999999999999974e-01, -2.664535259100376e-15, 0.000000000000000e+00,  5.363867924956907e-01, 1.785809694379055e+00, -2.139006616982062e-01, -2.145354535686934e-01,  0.000000000000000e+00, 7.438494264988549e-15, 9.999999999999969e-01,
                  1.421085471520200e-14,  5.355116485379661e-01, -2.138297082343827e-01, 1.786437234136590e+00, -2.141855728357314e-01, -7.105427357601002e-15, -1.310063169057685e-14, -1.376676550535194e-14, 1.000000000000000e+00,  5.361179313615061e-01, -2.140716934375419e-01, -2.137934871930820e-01, 1.785560872005945e+00,  2.886579864025407e-15, 1.901256929670581e-15, 9.436895709313831e-16, 2.664535259100376e-15, -3.269874864230629e-01, -2.687293068537968e-01, -2.683798640054954e-01, -2.691764904908212e-01, -1.554312234475219e-15, -4.579669976578771e-15, -4.163336342344337e-16, 8.881784197001252e-16, -2.684499818118178e-01, -8.927926129860647e-01, 1.070520074628364e-01, 1.073695829389538e-01,  6.883382752675971e-15, 3.830269434956790e-15, -7.424616477180734e-15, 3.552713678800501e-15, -2.685340007074222e-01, 1.072249442073578e-01, -8.928985946414799e-01, 1.074034080412392e-01,  0.000000000000000e+00, 4.107825191113079e-15, 2.220446049250313e-16, 0.000000000000000e+00, -2.678841167826729e-01, 1.069652578193268e-01, 1.068263840576430e-01, -8.928406369210506e-01,  1.000000000000021e+00, 1.865174681370263e-14, 4.529709940470639e-14, 0.000000000000000e+00,  6.614484960411353e-01, 5.344781423941568e-01, 5.337831600042477e-01, 5.353675462027923e-01,  5.329070518200751e-15, 9.999999999999959e-01, 6.883382752675971e-15, 0.000000000000000e+00,  5.339090979997980e-01, 1.786790049172059e+00, -2.129119072090834e-01, -2.135436096887062e-01,  0.000000000000000e+00, -5.884182030513330e-15, 9.999999999999933e-01, -7.105427357601002e-15,  5.340724675776727e-01, -2.132543526336090e-01, 1.787002253991888e+00, -2.136092462419477e-01,  1.421085471520200e-14, 0.000000000000000e+00, 2.664535259100376e-15, 1.000000000000014e+00,  5.327768550594136e-01, -2.127367431586746e-01, -2.124604134818793e-01, 1.786888244544045e+00, -4.440892098500626e-15, -4.274358644806853e-15, -2.942091015256665e-15, 0.000000000000000e+00, -3.350922062647754e-01, -2.654895260532240e-01, -2.651442789253193e-01, -2.659313443274538e-01,  2.664535259100376e-15, 2.109423746787797e-15, 4.440892098500626e-15, -1.776356839400250e-15, -2.644850433736843e-01, -8.943650084960058e-01, 1.054700064658147e-01, 1.057826983469337e-01, -8.881784197001252e-16, 2.442490654175344e-15, 1.204591981718295e-14, 7.105427357601002e-15, -2.649122350713919e-01, 1.057779206604678e-01, -8.943321937045403e-01, 1.059539576220541e-01,  0.000000000000000e+00, -2.886579864025407e-15, -2.664535259100376e-15, 0.000000000000000e+00, -2.645217050973230e-01, 1.056215874375470e-01, 1.054846295011860e-01, -8.941747269507729e-01,  9.999999999999609e-01, -2.042810365310288e-14, -1.820765760385257e-14, -1.421085471520200e-14,  6.943347355931770e-01, 5.213424899772823e-01, 5.206645680677835e-01, 5.222100770194587e-01,  2.664535259100376e-15, 1.000000000000027e+00, 5.551115123125783e-15, -3.552713678800501e-15,  5.193395419834070e-01, 1.792595066790436e+00, -2.071008115323242e-01, -2.077150444863527e-01,  1.243449787580175e-14, 1.221245327087672e-15, 1.000000000000011e+00, -3.552713678800501e-15,  5.201721405828525e-01, -2.077029240756995e-01, 1.792532965610342e+00, -2.080485555051474e-01,  7.105427357601002e-15, -2.664535259100376e-15, 1.154631945610163e-14, 1.000000000000000e+00,  5.194487041412685e-01, -2.074135369743479e-01, -2.071443253890859e-01, 1.792206474979110e+00, -8.881784197001252e-16, 2.720046410331634e-15, 4.440892098500626e-16, -7.105427357601002e-15, -3.413472632849608e-01, -2.629871406691274e-01, -2.626451261102714e-01, -2.634248339412757e-01, -6.217248937900877e-15, -1.720845688168993e-15, 3.053113317719180e-15, 1.243449787580175e-14, -2.608846969558050e-01, -8.957881328580675e-01, 1.040330630113458e-01, 1.043412285947003e-01,  6.217248937900877e-15, 1.804112415015879e-15, 1.348920974919565e-14, -8.881784197001252e-15, -2.617216609237030e-01, 1.045027389490110e-01, -8.955901944906476e-01, 1.046766184834098e-01,  7.105427357601002e-15, 9.769962616701378e-15, 5.995204332975845e-15, -1.421085471520200e-14, -2.624465204742314e-01, 1.047914935378821e-01, 1.046558402886791e-01, -8.949902911256800e-01,  9.999999999999574e-01, -3.952393967665557e-14, -4.884981308350689e-14, -8.526512829121202e-14,  7.190661290033233e-01, 5.114618830932609e-01, 5.107967867100460e-01, 5.123130850129201e-01,  0.000000000000000e+00, 1.000000000000017e+00, -2.486899575160351e-14, 0.000000000000000e+00,  5.073523256845967e-01, 1.797365203174393e+00, -2.023191641677026e-01, -2.029189106729916e-01,  7.105427357601002e-15, -1.110223024625157e-15, 9.999999999999682e-01, 2.842170943040401e-14,  5.089835859858631e-01, -2.032339682168220e-01, 1.796978562199822e+00, -2.035721244971711e-01,  0.000000000000000e+00, -1.110223024625157e-14, -4.440892098500626e-16, 1.000000000000028e+00,  5.104404049400699e-01, -2.038148306257275e-01, -2.035505529738399e-01, 1.795793172552379e+00,  1.776356839400250e-15, -3.524958103184872e-15, 4.329869796038111e-15, 3.552713678800501e-15, -3.274629432624065e-01, -2.685251593284257e-01, -2.681759202069138e-01, -2.689721144206558e-01,  2.664535259100376e-15, -1.698641227676490e-14, 2.775557561562891e-15, 1.065814103640150e-14, -2.652824639162903e-01, -8.940136053656693e-01, 1.057852465046019e-01, 1.060982793399674e-01,  1.509903313490213e-14, 5.551115123125783e-16, 3.858025010572419e-14, 0.000000000000000e+00, -2.671198544853395e-01, 1.066566866178582e-01, -8.934191933705427e-01, 1.068340999417661e-01,  7.105427357601002e-15, 1.310063169057685e-14, -5.995204332975845e-15, 1.421085471520200e-14, -2.681776451464586e-01, 1.070780155365503e-01, 1.069396717448785e-01, -8.926796143126978e-01,  1.000000000000028e+00, -3.397282455352979e-14, 6.039613253960852e-14, 2.842170943040401e-14,  6.648731094298128e-01, 5.330945265110143e-01, 5.324012844637021e-01, 5.339817791156634e-01, -3.552713678800501e-15, 1.000000000000027e+00, -1.509903313490213e-14, -1.421085471520200e-14,  5.266574844341605e-01, 1.789636018258884e+00, -2.100159405230072e-01, -2.106381625596683e-01, -3.552713678800501e-15, 1.143529715363911e-14, 9.999999999999963e-01, 0.000000000000000e+00,  5.303134186957941e-01, -2.117492291086665e-01, 1.788452208621272e+00, -2.121014995580595e-01,  1.421085471520200e-14, 5.329070518200751e-15, 4.440892098500626e-16, 1.000000000000028e+00,  5.324012049261313e-01, -2.125816349324261e-01, -2.123062717793491e-01, 1.786989068535604e+00,  1.421085471520200e-14, -1.054711873393899e-15, -1.054711873393899e-14, 1.421085471520200e-14, -3.286080738871711e-01, -2.680605083101482e-01, -2.677118416457798e-01, -2.685067352425321e-01,  8.881784197001252e-15, 3.891331701311174e-14, -9.103828801926284e-15, 7.105427357601002e-15, -2.645754511604608e-01, -8.942729784450545e-01, 1.055013038781875e-01, 1.058130923383196e-01, -1.243449787580175e-14, -1.493249968120836e-14, -2.353672812205332e-14, -1.065814103640150e-14, -2.669284844152813e-01, 1.065782863645539e-01, -8.934728060210817e-01, 1.067555079567093e-01,  1.421085471520200e-14, 7.993605777301127e-15, -1.332267629550188e-14, 0.000000000000000e+00, -2.674743413107876e-01, 1.067947624605725e-01, 1.066571266628027e-01, -8.929380500421473e-01,  9.999999999999627e-01, -1.454392162258955e-14, -1.199040866595169e-14, -1.421085471520200e-14,  6.699713352285226e-01, 5.310506768784866e-01,
                  5.303600558859028e-01, 5.319345643549838e-01,  1.376676550535194e-14, 9.999999999999633e-01, 1.253164239045645e-14, -1.509903313490213e-14,  5.241614566296198e-01, 1.790607424536459e+00, -2.090183426961180e-01, -2.096371660492702e-01,  3.552713678800501e-15, 1.158795281952507e-14, 9.999999999999417e-01, 1.820765760385257e-14,  5.288152017375365e-01, -2.111487769282097e-01, 1.789024666552343e+00, -2.114999807873876e-01,  0.000000000000000e+00, -1.820765760385257e-14, 1.776356839400250e-14, 1.000000000000028e+00,  5.298813548660206e-01, -2.115727715838216e-01, -2.112990897982869e-01, 1.787971741738176e+00 )
               , tolerance = 0.001)

  expect_equal(c(res$lag_one_cor),
               c( 4.174860778276459e-01, 3.470331363331650e-01, 3.433871790654798e-01, 3.469836731109802e-01,  6.638702838161032e-01, 3.625784704758215e-01, 3.582012221446890e-01, 3.617631519888863e-01,  3.459435683869442e-01, 9.605075246263268e-01, -4.998083620069353e-02, -3.837914695723964e-02,  3.625885009182610e-01, 1.197754354885614e+00, -3.611943262905278e-02, -2.344816796196007e-02,  3.422449887169476e-01, -4.995911363817901e-02, 9.684705628459300e-01, -5.067533395114886e-02,  3.582107723654392e-01, -3.611943444716398e-02, 1.206463951981694e+00, -3.763056489190938e-02,  3.460907865385577e-01, -3.835970451420977e-02, -5.068439251691405e-02, 9.639861577301860e-01,  3.617603682836709e-01, -2.345676262654681e-02, -3.763901184551959e-02, 1.201036181089599e+00,  4.869176004391669e-01, 4.038966250075762e-01, 3.996991057553108e-01, 4.033149258640959e-01,  9.035673396133741e-01, 3.829650189201430e-01, 3.779258473222615e-01, 3.811761545660419e-01,  4.017459305552896e-01, 1.118674345281107e+00, -5.859462297041441e-02, -4.603268005236841e-02,  3.819204439434267e-01, 1.435869154865028e+00, -2.353088685312428e-02, -9.862485744758995e-03,  3.974184269238664e-01, -5.854112705691775e-02, 1.127446627950514e+00, -5.993247994951843e-02,  3.767975995405991e-01, -2.349679068171558e-02, 1.445368974998569e+00, -2.596841713872629e-02,  4.015315731252349e-01, -4.596967403187106e-02, -5.993671089863326e-02, 1.122241659722594e+00,  3.802806871592387e-01, -9.824023946059008e-03, -2.597087678720420e-02, 1.438934333379291e+00,  2.789281422029505e-01, 2.353262117776003e-01, 2.328754450072396e-01, 2.361578707197899e-01,  3.479293832741240e-01, 2.901874805406014e-01, 2.871179960703550e-01, 2.907074006804207e-01,  2.341597558610450e-01, 6.461973791071947e-01, -3.287927081482484e-02, -2.327110173146126e-02,  2.901911278550949e-01, 8.023334552829192e-01, -4.138412714233942e-02, -3.074757907553829e-02,  2.317293906913268e-01, -3.288666568083034e-02, 6.525460429630465e-01, -3.242791242139714e-02,  2.871214076135983e-01, -4.138422191360114e-02, 8.094773236405788e-01, -4.144012321350633e-02,  2.352936944040528e-01, -2.329387057595809e-02, -3.244996029958535e-02, 6.494292031574702e-01,  2.907000047282361e-01, -3.075687910616136e-02, -4.144918014592369e-02, 8.057085371026336e-01,  3.207311248762289e-01, 2.717408935810635e-01, 2.689039140606675e-01, 2.723578646224274e-01,  4.174860778276154e-01, 3.470331363331686e-01, 3.433871790654428e-01, 3.469836731109865e-01,  2.694709849615566e-01, 7.471504782766210e-01, -3.998410269345569e-02, -2.938117847495916e-02,  3.459435683869496e-01, 9.605075246263455e-01, -4.998083620072257e-02, -3.837914695723525e-02,  2.666189029923268e-01, -3.997641599807594e-02, 7.542691581085730e-01, -3.985808403211537e-02,  3.422449887169113e-01, -4.995911363820160e-02, 9.684705628458891e-01, -5.067533395114453e-02,  2.706213988456274e-01, -2.938456993604061e-02, -3.988273932571670e-02, 7.508545334336614e-01,  3.460907865385101e-01, -3.835970451419637e-02, -5.068439251693850e-02, 9.639861577301913e-01,  1.961939491467742e-01, 1.642944147795354e-01, 1.626977507462087e-01, 1.653571538583080e-01,  2.372074719425663e-01, 1.988117924727355e-01, 1.968033690979231e-01, 1.999401785882233e-01,  1.651389953948441e-01, 4.456014732828172e-01, -1.950312155444855e-02, -1.195804018216167e-02,  1.988155296407282e-01, 5.452838254002453e-01, -2.575704838352713e-02, -1.715398359211502e-02,  1.639469482525086e-01, -1.966497693901256e-02, 4.502660646279144e-01, -1.869630566640264e-02,  1.968069249936186e-01, -2.575716390494813e-02, 5.508400357386324e-01, -2.499070515758999e-02,  1.663631564798221e-01, -1.192322417809891e-02, -1.850612506623950e-02, 4.478801796195434e-01,  1.999329376878544e-01, -1.716330519251917e-02, -2.499976178178345e-02, 5.480106703221007e-01,  2.136549557871679e-01, 1.789763847010327e-01, 1.771462712183149e-01, 1.801173038682615e-01,  2.789281422029638e-01, 2.353262117776005e-01, 2.328754450072764e-01, 2.361578707198223e-01,  1.789938952373712e-01, 4.897159351509622e-01, -2.471960526252073e-02, -1.614084671442506e-02,  2.341597558610456e-01, 6.461973791071898e-01, -3.287927081479691e-02, -2.327110173145973e-02,  1.776276203316635e-01, -2.490434647597450e-02, 4.951004640411001e-01, -2.393179831573281e-02,  2.317293906913384e-01, -3.288666568081391e-02, 6.525460429630836e-01, -3.242791242140749e-02,  1.805640723591617e-01, -1.610111229383870e-02, -2.372063457585907e-02, 4.928794481194853e-01,  2.352936944040358e-01, -2.329387057594611e-02, -3.244996029958318e-02, 6.494292031574666e-01,  1.641639827956999e-01, 1.373833707049304e-01, 1.365329280681189e-01, 1.378760834753431e-01,  1.806534984239779e-01, 1.505132191993658e-01, 1.494965751419459e-01, 1.514011551429785e-01,  1.373979833134331e-01, 3.587504936564034e-01, -9.914845210145464e-03, -4.344810357173670e-03,  1.505170293268486e-01, 4.011269091202115e-01, -1.478472318130745e-02, -8.096358109113685e-03,  1.367440748032273e-01, -9.993180785882200e-03, 3.618345071161174e-01, -9.116629445410964e-03,  1.495002074449120e-01, -1.478483934335858e-02, 4.049338214091756e-01, -1.378151631783152e-02,  1.378135452241525e-01, -4.215280211015875e-03, -8.915515873261745e-03, 3.594325300719554e-01,  1.513938962493729e-01, -8.105640508475320e-03, -1.379053238122157e-02, 4.025588534077310e-01,  1.551343187859799e-01, 1.297953717970705e-01, 1.286104419597790e-01, 1.307924904518611e-01,  1.961939491467811e-01, 1.642944147795211e-01, 1.626977507462082e-01, 1.653571538583207e-01,  1.304714315439177e-01, 3.463147200615022e-01, -1.285402083068503e-02, -6.365760254721867e-03,  1.651389953948398e-01, 4.456014732828039e-01, -1.950312155445687e-02, -1.195804018217286e-02,  1.297930676941554e-01, -1.305616339743595e-02, 3.502079538319409e-01, -1.188442896168065e-02,  1.639469482524986e-01, -1.966497693902705e-02, 4.502660646278944e-01, -1.869630566640536e-02,  1.315495708670116e-01, -6.186532377616735e-03, -1.151652185346751e-02, 3.482470458644025e-01,  1.663631564798269e-01, -1.192322417812188e-02, -1.850612506622005e-02, 4.478801796195448e-01,  1.816496516044744e-01, 1.525893576021704e-01, 1.519768789361250e-01, 1.516416526470197e-01,  1.734878698392626e-01, 1.442031238835319e-01, 1.435740258977359e-01, 1.439669894091517e-01,  1.521749324332995e-01, 3.861382037428198e-01, -3.459099065561744e-03, 9.082078934036231e-05,  1.442068326578143e-01, 3.714925041160366e-01, -6.623737679770429e-03, -1.927496891762820e-03,  1.517024492976948e-01, -3.514635267629053e-03, 3.877669382696499e-01, -3.305350007740404e-03,  1.435775311400607e-01, -6.623843033960602e-03, 3.738120127536169e-01, -5.952979553657761e-03,  1.515848628476726e-01, 4.645679916712858e-05, -3.300741336651578e-03, 3.843281698376906e-01,  1.439596173524303e-01, -1.936773327618537e-03, -5.962000010919417e-03, 3.710145258505435e-01,  1.479618156969740e-01, 1.241385681668290e-01, 1.234544755776077e-01, 1.242358638584689e-01,  1.641639827957010e-01, 1.373833707049252e-01, 1.365329280681289e-01, 1.378760834753336e-01,  1.238024837813134e-01, 3.165638268697819e-01, -4.854982577496216e-03, -4.027221255432645e-04,  1.373979833134516e-01, 3.587504936564068e-01, -9.914845210130476e-03, -4.344810357170104e-03,  1.234056312679355e-01, -4.969021131704849e-03, 3.189669047019377e-01,
                  -4.218861455817818e-03,  1.367440748032446e-01, -9.993180785859285e-03, 3.618345071161470e-01, -9.116629445409169e-03,  1.241559937323321e-01, -2.941183765641613e-04, -4.009736539415450e-03, 3.163365835054344e-01,  1.378135452241447e-01, -4.215280211023362e-03, -8.915515873266430e-03, 3.594325300719434e-01,  2.493879854999361e-01, 2.098822455418542e-01, 2.092522749763013e-01, 2.073676998978986e-01,  2.179868919579455e-01, 1.794856051599273e-01, 1.789391055944370e-01, 1.779610765924683e-01,  2.091279860615463e-01, 5.277951319505230e-01, -2.058171336851364e-04, 1.082855802977574e-03,  1.794892331718502e-01, 4.563327124675924e-01, -1.440232028797471e-03, 1.018145547664856e-03,  2.087646051208191e-01, -3.117257910169313e-04, 5.278797782454172e-01, -1.641684519816305e-03,  1.789424942041531e-01, -1.440322799690759e-03, 4.571885395500344e-01, -1.958617673343134e-03,  2.075416876564526e-01, 8.104201839153821e-04, -1.814394510886039e-03, 5.222173466507714e-01,  1.779538200159202e-01, 1.008790631590293e-03, -1.967730916729360e-03, 4.527536620249264e-01,  1.905701563689678e-01, 1.606723441881625e-01, 1.600768783618562e-01, 1.590125623439236e-01,  1.816496516044945e-01, 1.525893576021713e-01, 1.519768789361442e-01, 1.516416526470307e-01,  1.596567314709922e-01, 4.009773764777710e-01, -1.005375598669735e-04, 2.303631188973643e-03,  1.521749324333123e-01, 3.861382037428189e-01, -3.459099065541395e-03, 9.082078934743998e-05,  1.594051872123309e-01, -2.368555715644982e-04, 4.018895122084474e-01, -4.888725909004132e-04,  1.517024492977098e-01, -3.514635267625153e-03, 3.877669382696456e-01, -3.305350007739433e-03,  1.590979937186471e-01, 2.074443622677211e-03, -5.947828845991460e-04, 3.976859459400666e-01,  1.515848628477023e-01, 4.645679918808404e-05, -3.300741336628749e-03, 3.843281698377137e-01,  3.667229513676476e-01, 3.092952141986931e-01, 3.087023183372367e-01, 3.056206432689474e-01,  3.120846307291277e-01, 2.570466971530391e-01, 2.565735118470475e-01, 2.544412258822466e-01,  3.083838665915520e-01, 7.837627111391565e-01, -2.379642710351893e-04, -1.540635719362041e-03,  2.570502256731436e-01, 6.554291195001545e-01, 4.292794759814863e-04, 3.738329384822218e-04,  3.085246263252428e-01, -5.302913777337076e-04, 7.819042658738323e-01, -4.484331594513041e-03,  2.565770213490465e-01, 4.291007412211174e-04, 6.546089283529382e-01, -2.283406080596118e-03,  3.056645752508562e-01, -1.823970860792772e-03, -4.481198355570565e-03, 7.729869122650787e-01,  2.544337859386708e-01, 3.645102677437770e-04, -2.292399046137596e-03, 6.472608248035444e-01,  2.832020478070618e-01, 2.393151233853160e-01, 2.386029343545151e-01, 2.358089548414857e-01,  2.493879854999086e-01, 2.098822455418454e-01, 2.092522749763019e-01, 2.073676998978766e-01,  2.377502626091297e-01, 5.996627746223165e-01, 1.433950917974619e-03, 1.554118727099402e-03,  2.091279860615259e-01, 5.277951319505532e-01, -2.058171336862700e-04, 1.082855802953905e-03,  2.379034162125575e-01, 1.089714249737419e-03, 5.988428467308703e-01, -1.051456693219599e-03,  2.087646051208005e-01, -3.117257910390490e-04, 5.278797782454407e-01, -1.641684519826908e-03,  2.360500857282541e-01, 1.043080034965123e-03, -1.230586925895172e-03, 5.921121213693189e-01,  2.075416876564341e-01, 8.104201838891739e-04, -1.814394510887236e-03, 5.222173466507550e-01,  5.343782672145756e-01, 4.505088410246578e-01, 4.506208514517293e-01, 4.457214637651101e-01,  4.512374433840017e-01, 3.786171554827742e-01, 3.787455956212020e-01, 3.748902645780723e-01,  4.501622256131025e-01, 1.153967296347523e+00, -3.875417613377807e-03, -7.711663421690709e-03,  3.786206559748623e-01, 9.681252445129713e-01, -1.887467630541508e-03, -4.418935118143233e-03,  4.508452126377637e-01, -4.103080338188498e-03, 1.149664792091607e+00, -1.162273308514348e-02,  3.787495376706504e-01, -1.887830442964672e-03, 9.649878542383314e-01, -7.701029450689801e-03,  4.454365832650886e-01, -7.637831860310884e-03, -1.132766972084925e-02, 1.137001336991510e+00,  3.748815880646213e-01, -4.427777119273685e-03, -7.709358189161783e-03, 9.540783029062900e-01,  4.258975750190934e-01, 3.597322407217858e-01, 3.590219892269972e-01, 3.549855531973183e-01,  3.667229513676462e-01, 3.092952141986947e-01, 3.087023183372166e-01, 3.056206432689361e-01,  3.583943312325393e-01, 9.126242913741036e-01, -3.775475770025722e-04, -2.925879598645348e-03,  3.083838665915346e-01, 7.837627111391423e-01, -2.379642710601292e-04, -1.540635719365024e-03,  3.589886650699942e-01, -8.972923866905765e-04, 9.097908655162730e-01, -6.091881402423657e-03,  3.085246263252355e-01, -5.302913777453233e-04, 7.819042658737940e-01, -4.484331594526519e-03,  3.548227432495972e-01, -3.184852749285140e-03, -5.843473744883403e-03, 8.995416159781311e-01,  3.056645752508554e-01, -1.823970860793935e-03, -4.481198355578406e-03, 7.729869122650639e-01,  7.530492286712932e-01, 6.341172158881655e-01, 6.349797234458854e-01, 6.270443280895804e-01,  6.445591875889758e-01, 5.412467067533530e-01, 5.420226436761206e-01, 5.353708285401563e-01,  6.331152920134338e-01, 1.638601724445918e+00, -1.067980240969567e-02, -1.675192762433867e-02,  5.412513538537096e-01, 1.395326104152939e+00, -7.294593396196876e-03, -1.206358240255434e-02,  6.339556648517082e-01, -1.067029546114348e-02, 1.631770884407795e+00, -2.220961157388785e-02,  5.420238779211479e-01, -7.293417990616261e-03, 1.389617640383331e+00, -1.672028144895128e-02,  6.260779618147856e-01, -1.666808088274100e-02, -2.214211057945209e-02, 1.614714328980164e+00,  5.353705285216300e-01, -1.207531257382037e-02, -1.673303564924336e-02, 1.374895969492163e+00,  6.182335897780015e-01, 5.221152069175506e-01, 5.222111589106606e-01, 5.162668671165205e-01,  5.343782672145996e-01, 4.505088410246856e-01, 4.506208514517431e-01, 4.457214637651284e-01,  5.208954195019372e-01, 1.340132083843241e+00, -5.541000850683396e-03, -1.068107093324196e-02,  4.501622256131175e-01, 1.153967296347519e+00, -3.875417613358749e-03, -7.711663421672331e-03,  5.216389539286297e-01, -5.798465635905935e-03, 1.334860867822991e+00, -1.502370873207688e-02,  4.508452126378101e-01, -4.103080338143185e-03, 1.149664792091665e+00, -1.162273308512699e-02,  5.151562294283998e-01, -1.051433268203908e-02, -1.461285981841392e-02, 1.320258430711602e+00,  4.454365832651281e-01, -7.637831860284275e-03, -1.132766972082256e-02, 1.137001336991555e+00,  1.011044873240053e+00, 8.632811024048086e-01, 8.644515887115169e-01, 8.533480903004960e-01,  8.807573978874731e-01, 7.481422825970855e-01, 7.492018276891114e-01, 7.395824479310120e-01,  8.622544249281396e-01, 2.236269745364202e+00, -2.185475998299562e-02, -3.029919958682470e-02,  7.481734872175193e-01, 1.936264326654303e+00, -1.639900333218683e-02, -2.352581378768019e-02,  8.632703986690625e-01, -2.179238160762051e-02, 2.226859608778983e+00, -3.804442375302125e-02,  7.491070110477476e-01, -1.634888427490012e-02, 1.928102023209127e+00, -3.009762619494074e-02,  8.526069429802788e-01, -3.031518381112569e-02, -3.812958333559613e-02, 2.204488456989158e+00,  7.398427442981490e-01, -2.363097970205477e-02, -3.025271996218004e-02, 1.908466793419713e+00,  8.614662724350226e-01, 7.270169228168131e-01, 7.279659631829259e-01, 7.187470706970072e-01,  7.530492286712474e-01, 6.341172158881466e-01,
                  6.349797234458401e-01, 6.270443280895259e-01,  7.249683307028424e-01, 1.881881822984067e+00, -1.406066169264217e-02, -2.143591628358631e-02,  6.331152920134390e-01, 1.638601724445932e+00, -1.067980240969120e-02, -1.675192762434862e-02,  7.258839181390254e-01, -1.404575847670313e-02, 1.873925664945761e+00, -2.769753312629967e-02,  6.339556648516422e-01, -1.067029546116609e-02, 1.631770884407677e+00, -2.220961157391689e-02,  7.167583643854265e-01, -2.125005873533781e-02, -2.754041103929394e-02, 1.854543624489333e+00,  6.260779618147344e-01, -1.666808088275940e-02, -2.214211057947177e-02, 1.614714328980073e+00 )
               , tolerance = 0.001)

  expect_equal(c(res$Q),
               c( 0.16867597311247720, -0.06735210604662489, -0.06726454087970239, -0.06746416284851561,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, -0.06735210604662489, 0.02689477160872758, 0.02685880679855486, 0.02693851611700866,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, -0.06726454087970239, 0.02685880679855486, 0.02682488737344855, 0.02690349310638634,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000, -0.06746416284851561, 0.02693851611700866, 0.02690349310638634, 0.02698433529184920,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000,  0.00000000000000000, 0.00000000000000000, 0.00000000000000000, 0.00000000000000000 )
               , tolerance = 0.001)

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0,  0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 10 )
               , tolerance = 0.001)
})

#########
# With estimating Q_0 and second order

res <- ddhazard_fit(X = design_mat$X, tstart = design_mat$Y[, 1],  tstop = design_mat$Y[, 2], events = design_mat$Y[, 3],
                    a_0 = a_0,
                    Q_0 = Q_0,
                    Q = Q,
                    F_= F_, # first order random walk
                    risk_obj = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 2,
                    est_Q_0 = T)

# get_expect_equal(res, eps = expect_equal_eps)

test_that("Testing versus previously computed values with order 2 and Q_0 estimation", {
  expect_equal(c(res$V_t_d_s),
               c( 1.233459652078745e-03, 1.017725252309268e-03, 1.013004405256177e-03, 1.028305611706015e-03,  1.440038112631801e-03, 1.187986746088717e-03, 1.182795957721136e-03, 1.199648662589154e-03,  1.017725252307357e-03, 2.605599389604312e-03, -4.221399291552604e-05, 9.075149867920029e-06,  1.187891536385713e-03, 3.040142496047129e-03, -4.687980260690380e-05, 1.053496350441061e-05,  1.013004405255719e-03, -4.221399291550240e-05, 2.634670793790814e-03, -2.887541810530138e-05,  1.182751045264071e-03, -4.689948434477118e-05, 3.073819998524195e-03, -3.306139973502443e-05,  1.028305611708353e-03, 9.075149872647227e-06, -2.887541810411465e-05, 2.617067052266464e-03,  1.199585651923229e-03, 1.050052742236484e-05, -3.306355140158670e-05, 3.053302347844981e-03,  1.440038112631794e-03, 1.187891536387826e-03, 1.182751045264596e-03, 1.199585651920634e-03,  1.689614806507119e-03, 1.393238655409197e-03, 1.387674043574851e-03, 1.406091082486247e-03,  1.187986746086594e-03, 3.040142496047130e-03, -4.689948434465406e-05, 1.050052741700696e-05,  1.393238655406847e-03, 3.564144339896500e-03, -5.182543184162812e-05, 1.230785220485699e-05,  1.182795957720616e-03, -4.687980260702048e-05, 3.073819998524193e-03, -3.306355140280201e-05,  1.387674043574242e-03, -5.182543184193685e-05, 3.603318015995387e-03, -3.780041088280991e-05,  1.199648662591745e-03, 1.053496350977542e-05, -3.306139973380547e-05, 3.053302347844987e-03,  1.406091082489102e-03, 1.230785221093116e-05, -3.780041088158871e-05, 3.579277560762716e-03,  1.915149799192348e-03, 2.963368173538786e-04, 2.905926923306776e-04, 2.992460821087427e-04,  1.019442182407205e-03, 8.524991690505980e-04, 8.470882149653557e-04, 8.612847226390397e-04,  2.963368173523575e-04, 1.991681578298643e-03, 1.323808132777936e-04, 1.734628330387049e-04,  8.504204486057824e-04, 2.169093142187073e-03, -3.905089211512330e-05, 5.957006988173233e-06,  2.905926923303456e-04, 1.323808132780773e-04, 2.013980021997222e-03, 1.466570464374142e-04,  8.461770283812799e-04, -3.951660528321387e-05, 2.193995648020175e-03, -2.638432460371575e-05,  2.992460821106069e-04, 1.734628330422551e-04, 1.466570464385177e-04, 2.004465812858649e-03,  8.599544753385576e-04, 5.628506317898435e-06, -2.622994101578809e-05, 2.179119124842417e-03,  1.019442182407210e-03, 8.504204486074831e-04, 8.461770283816705e-04, 8.599544753364592e-04,  1.233459652078745e-03, 1.017725252309268e-03, 1.013004405256177e-03, 1.028305611706015e-03,  8.524991690489041e-04, 2.169093142187069e-03, -3.951660528339215e-05, 5.628506313794121e-06,  1.017725252307357e-03, 2.605599389604312e-03, -4.221399291552587e-05, 9.075149867920070e-06,  8.470882149649545e-04, -3.905089211494630e-05, 2.193995648020178e-03, -2.622994101694801e-05,  1.013004405255719e-03, -4.221399291550223e-05, 2.634670793790814e-03, -2.887541810530136e-05,  8.612847226411479e-04, 5.957006992268469e-06, -2.638432460255820e-05, 2.179119124842413e-03,  1.028305611708353e-03, 9.075149872647267e-06, -2.887541810411463e-05, 2.617067052266464e-03,  3.578487054727181e-03, -7.124195091330745e-04, -7.184939682081968e-04, -7.202468049311061e-04,  7.090887634292165e-04, 5.749067930631757e-04, 5.712233449748535e-04, 5.821328960261978e-04, -7.124195091342654e-04, 1.702857838435297e-03, 4.494493252287500e-04, 4.830661746803209e-04,  5.755096407823529e-04, 1.483336808078054e-03, -2.807033410376738e-05, 6.015375052922756e-06, -7.184939682083947e-04, 4.494493252291959e-04, 1.719666747572731e-03, 4.653597595010885e-04,  5.715434279549677e-04, -2.795694179208979e-05, 1.500775815995418e-03, -1.658507958457922e-05, -7.202468049296962e-04, 4.830661746828703e-04, 4.653597595020615e-04, 1.720093327317060e-03,  5.824905162634157e-04, 6.094508072089457e-06, -1.660803429507449e-05, 1.490537794156757e-03,  7.090887634292276e-04, 5.755096407837037e-04, 5.715434279552285e-04, 5.824905162617897e-04,  1.915149799192357e-03, 2.963368173538829e-04, 2.905926923306852e-04, 2.992460821087434e-04,  5.749067930618255e-04, 1.483336808078053e-03, -2.795694179248304e-05, 6.094508069082729e-06,  2.963368173523618e-04, 1.991681578298638e-03, 1.323808132777874e-04, 1.734628330387015e-04,  5.712233449746044e-04, -2.807033410338161e-05, 1.500775815995411e-03, -1.660803429613983e-05,  2.905926923303532e-04, 1.323808132780712e-04, 2.013980021997215e-03, 1.466570464374094e-04,  5.821328960278247e-04, 6.015375055924857e-06, -1.658507958352465e-05, 1.490537794156753e-03,  2.992460821106075e-04, 1.734628330422518e-04, 1.466570464385130e-04, 2.004465812858648e-03,  5.822735551014213e-04, 2.392639772278024e-04, 2.378921717854900e-04, 2.430274018812249e-04,  4.608985455231036e-04, 3.810998035707983e-04, 3.795171012831901e-04, 3.867183056094864e-04,  2.392639772269121e-04, 8.457654089533842e-04, 1.193627320588531e-05, 3.244281156889394e-05,  3.797454228647606e-04, 9.758856631597235e-04, -2.225975754298563e-05, 2.316245162157117e-06,  2.378921717853723e-04, 1.193627320641093e-05, 8.548906146956846e-04, 2.003551300431150e-05,  3.772934826654287e-04, -2.191524292414895e-05, 9.870427092766041e-04, -1.281443252833625e-05,  2.430274018822273e-04, 3.244281157062446e-05, 2.003551300506734e-05, 8.502262823978779e-04,  3.852017779654092e-04, 2.353092990769205e-06, -1.311365462393566e-05, 9.805209114474044e-04,  4.608985455231005e-04, 3.797454228658001e-04, 3.772934826655809e-04, 3.852017779642207e-04,  3.578487054727329e-03, -7.124195091331408e-04, -7.184939682082736e-04, -7.202468049311605e-04,  3.810998035697750e-04, 9.758856631597190e-04, -2.191524292466210e-05, 2.353092988667409e-06, -7.124195091343316e-04, 1.702857838435326e-03, 4.494493252287835e-04, 4.830661746803456e-04,  3.795171012830041e-04, -2.225975754246290e-05, 9.870427092766175e-04, -1.311365462480933e-05, -7.184939682084715e-04, 4.494493252292294e-04, 1.719666747572769e-03, 4.653597595011174e-04,  3.867183056106875e-04, 2.316245164247848e-06, -1.281443252745566e-05, 9.805209114473975e-04, -7.202468049297507e-04, 4.830661746828949e-04, 4.653597595020904e-04, 1.720093327317079e-03,  7.179993988106521e-04, 5.184841907761344e-05, 5.092578997687232e-05, 5.251696527006577e-05,  3.072970556777984e-04, 2.545724296763187e-04, 2.536495232662597e-04, 2.582225993234981e-04,  5.184841907696497e-05, 6.557337510622653e-04, 5.690193673244923e-05, 6.968499137468058e-05,  2.549550496124716e-04, 6.537258116719915e-04, -1.587902870992784e-05, -1.302254634561204e-08,  5.092578997685143e-05, 5.690193673291728e-05, 6.623661463858908e-04, 6.250945963686396e-05,  2.541922473950670e-04, -1.594187839754123e-05, 6.609142191894255e-04, -9.518948633235507e-06,  5.251696527069700e-05, 6.968499137576087e-05, 6.250945963737912e-05, 6.598103506215824e-04,  2.587393616587423e-04, -8.571556283497355e-08, -9.515773837321625e-06, 6.566396427615470e-04,  3.072970556777776e-04, 2.549550496132368e-04, 2.541922473951229e-04, 2.587393616579456e-04,  5.822735551014218e-04, 2.392639772278023e-04, 2.378921717854906e-04, 2.430274018812248e-04,  2.545724296755238e-04, 6.537258116720082e-04, -1.594187839805004e-05, -8.571556418338994e-08,  2.392639772269120e-04, 8.457654089533842e-04, 1.193627320588506e-05, 3.244281156889393e-05,  2.536495232662087e-04, -1.587902870940082e-05, 6.609142191894261e-04,
                  -9.515773837966226e-06,  2.378921717853728e-04, 1.193627320641068e-05, 8.548906146956841e-04, 2.003551300431123e-05,  2.582225993242918e-04, -1.302254497779359e-08, -9.518948632587906e-06, 6.566396427615492e-04,  2.430274018822273e-04, 3.244281157062444e-05, 2.003551300506707e-05, 8.502262823978779e-04,  2.791677280582735e-03, -7.973986503880452e-04, -7.996503812005862e-04, -8.083659573083424e-04,  2.465210998399321e-04, 1.992641660950733e-04, 1.991233694900882e-04, 2.011721069841230e-04, -7.973986503884235e-04, 9.442933092382441e-04, 3.929274232736694e-04, 4.019069276925956e-04,  1.997405798769409e-04, 5.184256846580816e-04, -9.941453777648493e-06, -1.588195662825695e-06, -7.996503812005656e-04, 3.929274232740189e-04, 9.516338916608739e-04, 3.988922421126781e-04,  1.997043264298482e-04, -9.982127996118699e-06, 5.237748151499733e-04, -6.865653626221743e-06, -8.083659573079762e-04, 4.019069276932028e-04, 3.988922421129473e-04, 9.554267399654915e-04,  2.016029595933666e-04, -1.589023678902508e-06, -6.812872395756258e-06, 5.202544750726118e-04,  2.465210998399353e-04, 1.997405798774324e-04, 1.997043264298291e-04, 2.016029595928891e-04,  7.179993988106513e-04, 5.184841907761416e-05, 5.092578997687304e-05, 5.251696527006562e-05,  1.992641660945855e-04, 5.184256846580809e-04, -9.982127996545366e-06, -1.589023679711243e-06,  5.184841907696568e-05, 6.557337510622648e-04, 5.690193673244879e-05, 6.968499137468049e-05,  1.991233694900896e-04, -9.941453777215976e-06, 5.237748151499791e-04, -6.812872396133023e-06,  5.092578997685215e-05, 5.690193673291684e-05, 6.623661463858903e-04, 6.250945963686387e-05,  2.011721069846181e-04, -1.588195662026867e-06, -6.865653625848573e-06, 5.202544750726023e-04,  5.251696527069685e-05, 6.968499137576077e-05, 6.250945963737903e-05, 6.598103506215826e-04,  9.894320719167684e-03, -3.536183530901578e-03, -3.544344130182721e-03, -3.581989730117418e-03,  3.684873101279748e-04, 1.802433142556631e-04, 1.811345973301190e-04, 1.801053369318338e-04, -3.536183530901764e-03, 2.201375884847063e-03, 1.509090630395547e-03, 1.522899106651885e-03,  1.805760959796025e-04, 5.852923813085443e-04, 8.842503407415533e-06, 1.113496904650238e-05, -3.544344130182701e-03, 1.509090630395739e-03, 2.214840234114245e-03, 1.524095383364990e-03,  1.812038142932978e-04, 8.947987274071350e-06, 5.905058335287038e-04, 8.322148949887895e-06, -3.581989730117254e-03, 1.522899106652190e-03, 1.524095383365106e-03, 2.238716149010898e-03,  1.802492621625446e-04, 1.119041272078362e-05, 8.283445115023912e-06, 5.868685164204119e-04,  3.684873101279728e-04, 1.805760959798723e-04, 1.812038142932605e-04, 1.802492621623118e-04,  2.791677280582738e-03, -7.973986503880430e-04, -7.996503812005855e-04, -8.083659573083425e-04,  1.802433142554115e-04, 5.852923813085382e-04, 8.947987273800487e-06, 1.119041272036532e-05, -7.973986503884212e-04, 9.442933092382419e-04, 3.929274232736678e-04, 4.019069276925943e-04,  1.811345973301433e-04, 8.842503407685747e-06, 5.905058335287085e-04, 8.283445114858690e-06, -7.996503812005649e-04, 3.929274232740173e-04, 9.516338916608730e-04, 3.988922421126774e-04,  1.801053369320607e-04, 1.113496904691654e-05, 8.322148950059309e-06, 5.868685164204133e-04, -8.083659573079763e-04, 4.019069276932015e-04, 3.988922421129467e-04, 9.554267399654912e-04,  7.438348469986748e-04, 2.959490182944196e-04, 2.985229643045007e-04, 2.927365305564510e-04,  3.890153687831344e-04, 3.120955419849424e-04, 3.143585505614128e-04, 3.108661803775525e-04,  2.959490182943370e-04, 1.065934033753648e-03, 3.393562818324326e-05, 2.963773755914557e-05,  3.111990026094774e-04, 8.107773478543314e-04, -5.081118967633253e-06, -7.863220813151176e-06,  2.985229643045152e-04, 3.393562818330228e-05, 1.074029223171460e-03, 2.655277895756401e-05,  3.131020369180718e-04, -4.938551786662566e-06, 8.172390922907973e-04, -1.025272710791612e-05,  2.927365305565073e-04, 2.963773755927738e-05, 2.655277895760090e-05, 1.068134303168859e-03,  3.098010082261424e-04, -7.821633744096027e-06, -1.034284756308046e-05, 8.118570831117107e-04,  3.890153687831283e-04, 3.111990026095983e-04, 3.131020369180568e-04, 3.098010082260447e-04,  9.894320719167488e-03, -3.536183530901509e-03, -3.544344130182544e-03, -3.581989730117318e-03,  3.120955419848157e-04, 8.107773478543352e-04, -4.938551786767039e-06, -7.821633744280600e-06, -3.536183530901695e-03, 2.201375884847040e-03, 1.509090630395480e-03, 1.522899106651849e-03,  3.143585505614379e-04, -5.081118967528026e-06, 8.172390922907942e-04, -1.034284756314737e-05, -3.544344130182524e-03, 1.509090630395673e-03, 2.214840234114135e-03, 1.524095383364911e-03,  3.108661803776379e-04, -7.863220812957233e-06, -1.025272710784677e-05, 8.118570831117161e-04, -3.581989730117154e-03, 1.522899106652154e-03, 1.524095383365027e-03, 2.238716149010850e-03,  1.199941493360429e-03, 4.188390611494019e-04, 4.234081803996475e-04, 4.137591042561851e-04,  5.819452328514946e-04, 4.842290579182575e-04, 4.884496989097937e-04, 4.819960924402183e-04,  4.188390611493837e-04, 1.627013206176033e-03, 6.462197164823871e-05, 5.765059172208385e-05,  4.851647618138501e-04, 1.240197365675097e-03, -8.469783492926104e-06, -1.490512239178032e-05,  4.234081803996608e-04, 6.462197164824231e-05, 1.638439140619381e-03, 5.199751804196360e-05,  4.885686507268477e-04, -8.143831729552618e-06, 1.249332787156338e-03, -1.876106462546408e-05,  4.137591042561905e-04, 5.765059172212379e-05, 5.199751804197167e-05, 1.630207676342983e-03,  4.824147876131376e-04, -1.471640389822143e-05, -1.888925020283671e-05, 1.241431152030326e-03,  5.819452328514950e-04, 4.851647618138849e-04, 4.885686507268415e-04, 4.824147876131087e-04,  7.438348469986768e-04, 2.959490182944182e-04, 2.985229643045001e-04, 2.927365305564508e-04,  4.842290579182216e-04, 1.240197365675097e-03, -8.143831729567661e-06, -1.471640389829277e-05,  2.959490182943356e-04, 1.065934033753648e-03, 3.393562818324372e-05, 2.963773755914594e-05,  4.884496989098198e-04, -8.469783492918538e-06, 1.249332787156330e-03, -1.888925020284528e-05,  2.985229643045146e-04, 3.393562818330275e-05, 1.074029223171460e-03, 2.655277895756403e-05,  4.819960924402290e-04, -1.490512239170128e-05, -1.876106462545638e-05, 1.241431152030333e-03,  2.927365305565070e-04, 2.963773755927776e-05, 2.655277895760092e-05, 1.068134303168859e-03,  3.221845506928062e-03, 2.890954849706433e-05, 3.425834280130276e-05, 1.548164015121989e-05,  8.763898947839993e-04, 7.254347090701169e-04, 7.318822459779326e-04, 7.226003692062652e-04,  2.890954849706433e-05, 2.616270274307584e-03, 3.278381753334695e-04, 3.215205103375995e-04,  7.276613874465236e-04, 1.865613323597677e-03, -1.111101166925661e-05, -2.001628642961024e-05,  3.425834280130276e-05, 3.278381753334695e-04, 2.633724575072576e-03, 3.119810147302795e-04,  7.335247113023760e-04, -1.087618354449627e-05, 1.878671029856568e-03, -2.752875148743602e-05,  1.548164015121989e-05, 3.215205103375995e-04, 3.119810147302795e-04, 2.626209296229461e-03,  7.241908923359070e-04, -1.977410193121933e-05, -2.751112703291897e-05, 1.867163201829243e-03,  8.763898947839992e-04, 7.276613874465236e-04, 7.335247113023760e-04, 7.241908923359071e-04,  1.199941493360430e-03, 4.188390611494020e-04,
                  4.234081803996453e-04, 4.137591042561880e-04,  7.254347090701168e-04, 1.865613323597677e-03, -1.087618354449626e-05, -1.977410193121928e-05,  4.188390611493838e-04, 1.627013206176033e-03, 6.462197164823948e-05, 5.765059172208260e-05,  7.318822459779325e-04, -1.111101166925653e-05, 1.878671029856568e-03, -2.751112703291899e-05,  4.234081803996587e-04, 6.462197164824308e-05, 1.638439140619382e-03, 5.199751804196324e-05,  7.226003692062652e-04, -2.001628642961016e-05, -2.752875148743586e-05, 1.867163201829243e-03,  4.137591042561934e-04, 5.765059172212254e-05, 5.199751804197131e-05, 1.630207676342981e-03,  2.367933255890699e-02, -7.576166704921166e-03, -7.588936078991094e-03, -7.685317490150232e-03,  1.353264682580399e-03, 1.005624040954099e-03, 1.013876926422611e-03, 1.001352267809125e-03, -7.576166704921166e-03, 6.698840307376965e-03, 3.493768072851162e-03, 3.516547041529231e-03,  1.007227581625278e-03, 2.701023253569346e-03, -7.101036976591356e-07, -1.068536796977772e-05, -7.588936078991094e-03, 3.493768072851162e-03, 6.739076315309784e-03, 3.508907882100658e-03,  1.015710357732519e-03, -7.994619914312258e-07, 2.719829108119406e-03, -2.372942765516505e-05, -7.685317490150232e-03, 3.516547041529231e-03, 3.508907882100658e-03, 6.785932896446405e-03,  1.003151597315872e-03, -1.077678367704827e-05, -2.371819936441830e-05, 2.703734225219026e-03,  1.353264682580399e-03, 1.007227581625278e-03, 1.015710357732519e-03, 1.003151597315872e-03,  3.221845506928045e-03, 2.890954849709651e-05, 3.425834280128769e-05, 1.548164015122915e-05,  1.005624040954099e-03, 2.701023253569346e-03, -7.994619914312258e-07, -1.077678367704827e-05,  2.890954849709651e-05, 2.616270274307561e-03, 3.278381753334653e-04, 3.215205103375856e-04,  1.013876926422611e-03, -7.101036976591356e-07, 2.719829108119406e-03, -2.371819936441830e-05,  3.425834280128769e-05, 3.278381753334653e-04, 2.633724575072591e-03, 3.119810147302845e-04,  1.001352267809125e-03, -1.068536796977772e-05, -2.372942765516505e-05, 2.703734225219026e-03,  1.548164015122915e-05, 3.215205103375856e-04, 3.119810147302845e-04, 2.626209296229456e-03 )
               , tolerance = 0.001)

  expect_equal(c(res$a_t_d_s),
               c(-1.3754401317776521, -1.6505505246312691, -0.3732514332777621, -0.2347563434157597, -0.7610609977337170, -1.4053222894411261, -0.2029291197605532, 0.1586031976450224, -0.1772680555504347, -1.0760440963360340, -1.6921062215106555, 0.5419833797345157, 1.0530003120172065, 0.9470146391840532, 1.2936347221703806,  1.9044722562188270, 2.5621877664206041, 2.4859587043995086, 2.7439226273808943, 3.2790648604931723,  4.0379302177609517, 4.6844326720830072, 1.7246714261900218, 1.8893179186161053, 1.4354043438210362,  1.4352421467336745, 1.6999673698216711, 2.0116909939907153, 1.5876165312848132, 1.4985804325662464,  1.6874232234116413, 2.1005543947961476, 2.4010386303888716, 1.4872019738800186, 1.6973727986397875,  1.2831951448809900, 1.3270150174199264, 1.6382007821253872, 1.9968254611641445, 1.6127680172727261,  1.5668856702742335, 1.8014835898104686, 2.2624692333833973, 2.6097539755817283, -1.4039631289185353, -1.3754401317776515, -1.6505505246312722, -0.3732514332777481, -0.2347563434157593, -0.7610609977337172, -1.4053222894411266, -0.2029291197605571, 0.1586031976450237, -0.1772680555504346, -1.0760440963360334,  0.1516353939558030, 0.5419833797345115, 1.0530003120172020, 0.9470146391840463, 1.2936347221703806,  1.9044722562188270, 2.5621877664206032, 2.4859587043995099, 2.7439226273808930, 3.2790648604931723,  4.0379302177609500, 1.6810010116536500, 1.7246714261900200, 1.8893179186160984, 1.4354043438210273,  1.4352421467336756, 1.6999673698216711, 2.0116909939907148, 1.5876165312848189, 1.4985804325662462,  1.6874232234116400, 2.1005543947961489, 1.3991394147545173, 1.4872019738800175, 1.6973727986397857,  1.2831951448809853, 1.3270150174199264, 1.6382007821253872, 1.9968254611641443, 1.6127680172727286,  1.5668856702742338, 1.8014835898104704, 2.2624692333833969 )
               , tolerance = 0.001)

  expect_equal(c(res$B_s),
               c( 3.552713678800501e-15, 1.415534356397075e-15, -7.160938508832260e-15, -3.552713678800501e-15, -3.098020817369438e-01, -2.589362564727062e-01, -2.597717524068462e-01, -2.620568062514579e-01,  1.598721155460225e-14, 4.127254094044019e-14, 5.107025913275720e-15, 3.552713678800501e-15, -2.578434365583959e-01, -8.477616438604169e-01, 9.738148453967427e-02, 9.828413352339993e-02, -5.329070518200751e-15, 1.457167719820518e-15, -8.049116928532385e-16, 1.065814103640150e-14, -2.590421302117001e-01, 9.746284628234712e-02, -8.478407517959774e-01, 9.881239469594050e-02, -7.105427357601002e-15, -4.385380947269368e-15, -7.105427357601002e-15, -1.421085471520200e-14, -2.588623954563829e-01, 9.738849046069409e-02, 9.783052619569155e-02, -8.466197256894361e-01,  1.000000000000005e+00, 5.453970608471082e-15, 2.720046410331634e-15, -1.065814103640150e-14,  1.448488315719231e+00, 2.060383771770548e-01, 2.069983744634982e-01, 2.087045135350145e-01, -1.998401444325282e-15, 9.999999999999912e-01, 5.100087019371813e-15, -8.881784197001252e-16,  2.053980713190722e-01, 1.877038505476603e+00, -7.730896998731139e-02, -7.803261522348293e-02,  5.551115123125783e-16, 7.849623728795052e-17, 9.999999999999877e-01, -3.330669073875470e-15,  2.064625192987765e-01, -7.729759422514083e-02, 1.876970452686363e+00, -7.848411674618755e-02,  0.000000000000000e+00, -6.106226635438361e-16, 4.662936703425657e-15, 1.000000000000014e+00,  2.062674631831456e-01, -7.726892776321082e-02, -7.772746247250106e-02, 1.876048454915079e+00,  1.332267629550188e-15, -2.886579864025407e-15, 4.440892098500626e-16, -5.329070518200751e-15, -3.124004588333751e-01, -2.628029863626000e-01, -2.635895365186580e-01, -2.659404997202000e-01,  0.000000000000000e+00, -1.232347557333924e-14, 1.665334536937735e-15, 5.329070518200751e-15, -2.586579184985194e-01, -8.635052658976622e-01, 9.948064904460466e-02, 1.004706871910646e-01,  4.440892098500626e-15, -2.109423746787797e-15, -1.210143096841421e-14, 0.000000000000000e+00, -2.622073727738590e-01, 1.005402446580112e-01, -8.623578793477840e-01, 1.019070405312643e-01, -6.217248937900877e-15, 0.000000000000000e+00, 4.440892098500626e-16, -2.131628207280301e-14, -2.613547804961591e-01, 1.002724883660726e-01, 1.006348080555389e-01, -8.615142813554115e-01,  9.999999999999978e-01, 3.441691376337985e-15, 2.886579864025407e-15, 3.552713678800501e-15,  6.373131232133051e-01, 5.330966373318724e-01, 5.345450798200535e-01, 5.394427390600125e-01, -8.881784197001252e-16, 9.999999999999916e-01, -3.330669073875470e-15, -1.776356839400250e-15,  5.302906694717695e-01, 1.761889977863430e+00, -2.083533697409841e-01, -2.103862750375320e-01,  4.440892098500626e-16, 9.992007221626409e-16, 1.000000000000006e+00, -3.552713678800501e-15,  5.327859633678460e-01, -2.087372505376772e-01, 1.760787593830047e+00, -2.113872182364602e-01,  7.993605777301127e-15, 4.440892098500626e-16, -2.220446049250313e-15, 1.000000000000014e+00,  5.326822895836543e-01, -2.087938360535734e-01, -2.094010949599974e-01, 1.758676390375477e+00,  5.329070518200751e-15, -3.996802888650564e-15, -2.220446049250313e-15, -2.664535259100376e-15, -3.184307943844482e-01, -2.639702085038839e-01, -2.647178697627098e-01, -2.671069660900836e-01, -2.042810365310288e-14, 1.554312234475219e-15, 9.547918011776346e-15, 6.217248937900877e-15, -2.651301325902331e-01, -8.724550105191459e-01, 1.032842559905144e-01, 1.043328308952729e-01, -1.287858708565182e-14, 7.105427357601002e-15, 1.243449787580175e-14, 7.993605777301127e-15, -2.644121661827201e-01, 1.026726624401391e-01, -8.728105829835995e-01, 1.040397444849246e-01,  1.598721155460225e-14, -3.552713678800501e-15, -7.993605777301127e-15, -1.065814103640150e-14, -2.649992043346927e-01, 1.030013273904872e-01, 1.033227312470533e-01, -8.714580707235164e-01,  1.000000000000001e+00, 0.000000000000000e+00, -1.332267629550188e-15, 0.000000000000000e+00,  6.451548592282155e-01, 5.329911652876405e-01, 5.344021936938457e-01, 5.393274222001176e-01,  1.021405182655144e-14, 1.000000000000008e+00, -2.442490654175344e-15, -1.776356839400250e-15,  5.353802018624465e-01, 1.769604236325951e+00, -2.114265245917158e-01, -2.134895500197382e-01, -3.552713678800501e-15, -6.661338147750939e-16, 9.999999999999987e-01, 1.776356839400250e-15,  5.337798194616294e-01, -2.102048344612512e-01, 1.769969887418160e+00, -2.128407355709268e-01,  0.000000000000000e+00, 8.881784197001252e-16, 2.664535259100376e-15, 1.000000000000011e+00,  5.350544684495784e-01, -2.108093277806851e-01, -2.113890980090443e-01, 1.767365326820634e+00, -2.220446049250313e-16, -1.387778780781446e-16, 3.885780586188048e-16, -4.440892098500626e-16, -3.216142398236017e-01, -2.650980678092880e-01, -2.658180617738046e-01, -2.682456480739916e-01,  1.110223024625157e-16, -6.522560269672795e-16, 2.428612866367530e-16, 4.440892098500626e-16, -2.659811850807814e-01, -8.797940299705862e-01, 1.044346078920688e-01, 1.054755453683827e-01, -2.331468351712829e-15, -4.163336342344337e-16, -4.066191827689636e-15, 0.000000000000000e+00, -2.653713101636319e-01, 1.038869969127203e-01, -8.799873078362083e-01, 1.052341684750657e-01,  4.440892098500626e-16, 7.216449660063518e-16, 7.494005416219807e-16, -1.776356839400250e-15, -2.659729416273975e-01, 1.041994762768086e-01, 1.045083025654807e-01, -8.786733985246933e-01,  9.999999999999996e-01, -2.428612866367530e-16, -3.226585665316861e-16, 4.440892098500626e-16,  6.519314014683457e-01, 5.321584530864932e-01, 5.335410164453103e-01, 5.384880901978086e-01, -4.440892098500626e-16, 1.000000000000000e+00, -6.938893903907228e-18, -4.440892098500626e-16,  5.339333206177682e-01, 1.776155889804924e+00, -2.114977960817258e-01, -2.135217445201216e-01,  1.110223024625157e-15, 5.551115123125783e-17, 1.000000000000000e+00, 0.000000000000000e+00,  5.326347383585106e-01, -2.104157679048644e-01, 1.776313854014480e+00, -2.130128627915679e-01, -4.440892098500626e-16, 1.110223024625157e-16, -6.383782391594650e-16, 1.000000000000002e+00,  5.339021000161566e-01, -2.109714282745904e-01, -2.115504767720858e-01, 1.773752018831787e+00, -2.775557561562891e-17, 1.387778780781446e-16, 4.440892098500626e-16, 0.000000000000000e+00, -3.216168715686415e-01, -2.664008143144346e-01, -2.671026481109147e-01, -2.695728908630018e-01,  1.526556658859590e-16, -1.304512053934559e-15, -1.526556658859590e-16, 0.000000000000000e+00, -2.681508000201885e-01, -8.831064080213137e-01, 1.057630873873323e-01, 1.067570062245988e-01,  9.159339953157541e-16, -2.775557561562891e-17, -5.134781488891349e-16, 0.000000000000000e+00, -2.683809755626384e-01, 1.055612430505825e-01, -8.829062237445322e-01, 1.068819935076193e-01,  5.551115123125783e-17, 1.110223024625157e-16, 2.220446049250313e-16, 8.881784197001252e-16, -2.682758584916496e-01, 1.055248289690325e-01, 1.058506044688537e-01, -8.818874237289211e-01,  9.999999999999997e-01, -1.110223024625157e-16, 5.551115123125783e-17, -2.220446049250313e-16,  6.464410842557077e-01, 5.351206491043198e-01, 5.364931498271247e-01, 5.415004399535811e-01,  4.579669976578771e-16, 9.999999999999984e-01, -1.804112415015879e-16, 0.000000000000000e+00,  5.386485272114578e-01, 1.776792861987304e+00, -2.136843723225716e-01, -2.156478075363948e-01, -3.747002708109903e-16, 1.804112415015879e-16, 1.000000000000002e+00,
                  2.220446049250313e-16,  5.390602788161167e-01, -2.132880146823158e-01, 1.776236417748627e+00, -2.158655777804194e-01, -6.661338147750939e-16, 2.220446049250313e-16, -3.330669073875470e-16, 1.000000000000000e+00,  5.388847348521493e-01, -2.131780062463938e-01, -2.137904548531264e-01, 1.774240929982146e+00, -2.220446049250313e-16, -7.771561172376096e-16, -1.443289932012704e-15, -4.440892098500626e-16, -3.215945143739455e-01, -2.666622505570612e-01, -2.673513470732733e-01, -2.698578861979777e-01, -1.332267629550188e-15, -1.554312234475219e-15, -1.110223024625157e-16, 0.000000000000000e+00, -2.680643083891783e-01, -8.839716974184614e-01, 1.058759864398837e-01, 1.067703512745235e-01,  2.886579864025407e-15, -2.220446049250313e-15, -4.107825191113079e-15, -1.332267629550188e-15, -2.680390612378428e-01, 1.055797481952827e-01, -8.838737312888651e-01, 1.068408374283745e-01, -2.664535259100376e-15, 4.440892098500626e-16, 0.000000000000000e+00, 0.000000000000000e+00, -2.679961770404127e-01, 1.054538813398310e-01, 1.058208705810060e-01, -8.828292052901530e-01,  1.000000000000005e+00, -1.110223024625157e-16, 3.330669073875470e-16, -1.332267629550188e-15,  6.461173295725429e-01, 5.349824569886966e-01, 5.363450092008608e-01, 5.413868960350523e-01,  2.664535259100376e-15, 1.000000000000000e+00, -9.992007221626409e-16, -4.440892098500626e-16,  5.378042699852514e-01, 1.776313499315681e+00, -2.133425311773313e-01, -2.151807506875587e-01,  2.220446049250313e-15, 8.881784197001252e-16, 1.000000000000003e+00, 4.440892098500626e-16,  5.377215947530993e-01, -2.127542006468846e-01, 1.775983063097910e+00, -2.152580422976058e-01,  1.776356839400250e-15, -1.776356839400250e-15, -1.776356839400250e-15, 9.999999999999982e-01,  5.376413630759938e-01, -2.125438105542907e-01, -2.132100470648174e-01, 1.773940397264568e+00,  0.000000000000000e+00, 8.881784197001252e-16, 0.000000000000000e+00, -1.776356839400250e-15, -3.219499543093068e-01, -2.657479632866710e-01, -2.664289952133183e-01, -2.689640676441978e-01, -1.776356839400250e-15, 1.776356839400250e-15, -8.881784197001252e-15, 0.000000000000000e+00, -2.665334654255951e-01, -8.821728662292589e-01, 1.051153426041458e-01, 1.058632855350323e-01,  1.953992523340276e-14, 4.440892098500626e-15, -4.440892098500626e-15, -7.993605777301127e-15, -2.663037253082789e-01, 1.047397519340410e-01, -8.822115546211976e-01, 1.059177973768393e-01, -7.105427357601002e-15, -7.105427357601002e-15, -3.552713678800501e-15, -3.552713678800501e-15, -2.665694408352932e-01, 1.045788993889275e-01, 1.050107518558268e-01, -8.810249897026079e-01,  9.999999999999840e-01, 1.065814103640150e-14, 7.105427357601002e-15, 1.598721155460225e-14,  6.500459527562708e-01, 5.321338117956590e-01, 5.334871658336779e-01, 5.385413284342597e-01,  8.881784197001252e-15, 1.000000000000003e+00, 2.664535259100376e-15, 1.065814103640150e-14,  5.337164346341436e-01, 1.773906295545089e+00, -2.114136765454738e-01, -2.130741081304266e-01,  1.598721155460225e-14, -3.552713678800501e-15, 1.000000000000001e+00, 7.105427357601002e-15,  5.332342860261666e-01, -2.106677695238391e-01, 1.773819760315454e+00, -2.130665986255817e-01,  0.000000000000000e+00, 7.105427357601002e-15, 3.552713678800501e-15, 1.000000000000007e+00,  5.337364832113325e-01, -2.105082389626538e-01, -2.112497835806910e-01, 1.771523735790867e+00,  1.332267629550188e-15, -3.608224830031759e-16, -6.661338147750939e-16, -8.881784197001252e-16, -3.253885574184938e-01, -2.626226706685258e-01, -2.632973870996567e-01, -2.658422284977258e-01, -1.332267629550188e-15, 5.412337245047638e-15, 1.942890293094024e-16, 8.881784197001252e-16, -2.628909189878590e-01, -8.781360175754365e-01, 1.032405635119873e-01, 1.038004954290224e-01,  8.881784197001252e-16, -5.551115123125783e-16, -9.714451465470120e-16, 0.000000000000000e+00, -2.630932003793092e-01, 1.030345010237586e-01, -8.781071214810304e-01, 1.041089622581679e-01, -8.881784197001252e-16, -7.771561172376096e-16, -2.220446049250313e-16, -3.552713678800501e-15, -2.632744019997615e-01, 1.026473642639057e-01, 1.031624474189415e-01, -8.769227895532943e-01,  9.999999999999996e-01, 1.970645868709653e-15, -7.771561172376096e-16, 8.881784197001252e-16,  6.680133253456306e-01, 5.227310930342564e-01, 5.240659411575621e-01, 5.290724638808304e-01,  4.440892098500626e-16, 1.000000000000005e+00, -2.220446049250313e-16, 0.000000000000000e+00,  5.232812042194666e-01, 1.770989423379294e+00, -2.066899220983157e-01, -2.081175549365462e-01,  0.000000000000000e+00, -1.859623566247137e-15, 1.000000000000002e+00, 8.881784197001252e-16,  5.236744000229681e-01, -2.062933681085275e-01, 1.770690759667841e+00, -2.085506634159779e-01,  1.776356839400250e-15, 1.443289932012704e-15, 1.443289932012704e-15, 9.999999999999964e-01,  5.239546649384854e-01, -2.058325434694903e-01, -2.066624079153436e-01, 1.768465361926943e+00, -8.881784197001252e-16, -3.164135620181696e-15, 8.326672684688674e-16, 1.776356839400250e-15, -3.172900796602041e-01, -2.631740638295998e-01, -2.638584698175411e-01, -2.664471175770124e-01, -1.332267629550188e-15, -1.076916333886402e-14, 1.054711873393899e-15, -1.776356839400250e-15, -2.641673773107711e-01, -8.693715807989719e-01, 1.030994993360076e-01, 1.034705067298134e-01,  4.440892098500626e-16, 4.440892098500626e-15, 9.992007221626409e-15, -1.776356839400250e-15, -2.648254367909693e-01, 1.030620659032971e-01, -8.692969717137344e-01, 1.040491526838672e-01, -1.776356839400250e-15, -1.998401444325282e-15, -3.330669073875470e-15, 0.000000000000000e+00, -2.648055662868654e-01, 1.023829003930113e-01, 1.029981816271820e-01, -8.681296594168941e-01,  1.000000000000001e+00, 3.164135620181696e-15, 5.551115123125783e-17, 0.000000000000000e+00,  6.402306104696605e-01, 5.306240947447014e-01, 5.319906671471886e-01, 5.371107010187632e-01, -8.881784197001252e-16, 9.999999999999916e-01, -1.221245327087672e-15, 0.000000000000000e+00,  5.326476792925896e-01, 1.757514748163528e+00, -2.096429629822606e-01, -2.108964274436946e-01, -5.329070518200751e-15, -6.772360450213455e-15, 1.000000000000000e+00, 0.000000000000000e+00,  5.339425288287041e-01, -2.095811506361652e-01, 1.757006765127838e+00, -2.117853720773386e-01,  3.552713678800501e-15, 1.998401444325282e-15, -2.220446049250313e-16, 9.999999999999929e-01,  5.337808123225400e-01, -2.087165663008939e-01, -2.096643055069088e-01, 1.754854517694987e+00,  9.992007221626409e-16, 6.661338147750939e-15, 1.332267629550188e-15, 7.105427357601002e-15, -3.144388891221261e-01, -2.608617055770865e-01, -2.615540358843716e-01, -2.641558901709544e-01,  1.912359159916832e-14, 1.021405182655144e-14, -6.217248937900877e-15, 0.000000000000000e+00, -2.612373917827515e-01, -8.600109549294155e-01, 1.011311842584553e-01, 1.012988384011120e-01, -1.188632525739308e-14, -3.108624468950438e-15, 2.042810365310288e-14, 0.000000000000000e+00, -2.625375456148795e-01, 1.013366691218302e-01, -8.598401722933704e-01, 1.022192768936208e-01,  2.220446049250313e-16, -7.105427357601002e-15, 0.000000000000000e+00, 1.421085471520200e-14, -2.623242617129407e-01, 1.003712164660371e-01, 1.010833295310756e-01, -8.586964218339830e-01,  9.999999999999958e-01, 4.884981308350689e-15, -7.993605777301127e-15, -7.105427357601002e-15,  6.372578638575410e-01, 5.279134962164393e-01,
                  5.292900978035214e-01, 5.344195748792728e-01, -8.937295348232510e-15, 9.999999999999623e-01, -3.552713678800501e-15, 0.000000000000000e+00,  5.286978899981394e-01, 1.747202218670078e+00, -2.071598714252998e-01, -2.081963806037983e-01,  1.185163078787355e-14, -8.881784197001252e-16, 9.999999999999747e-01, 0.000000000000000e+00,  5.312837563019377e-01, -2.075973265558737e-01, 1.746358042502870e+00, -2.096916914119760e-01, -5.717648576819556e-15, 5.329070518200751e-15, 3.552713678800501e-15, 9.999999999999858e-01,  5.306832674958457e-01, -2.063390374022540e-01, -2.073891959625029e-01, 1.744322805813781e+00 )
               , tolerance = 0.001)

  expect_equal(c(res$lag_one_cor),
               c( 1.019448400198782e-03, 8.504257405007756e-04, 8.461822684512776e-04, 8.599595371497921e-04,  1.233465855656702e-03, 1.017730530795806e-03, 1.013009631183621e-03, 1.028310663090920e-03,  8.525044861445870e-04, 2.169106272730435e-03, -3.951644074552908e-05, 5.628529518068489e-06,  1.017730558351044e-03, 2.605612483823144e-03, -4.221383182725954e-05, 9.075177898185688e-06,  8.470934675100674e-04, -3.905072111619365e-05, 2.194009166213900e-03, -2.623043146071029e-05,  1.013009643558907e-03, -4.221382437641341e-05, 2.634684276870454e-03, -2.887590425253569e-05,  8.612897930648336e-04, 5.957027514345796e-06, -2.638482327636517e-05, 2.179132310123272e-03,  1.028310671672686e-03, 9.075175419694914e-06, -2.887591380004629e-05, 2.617080202236402e-03,  1.181841419278961e-03, 9.859815198731744e-04, 9.812737675741515e-04, 9.965578813313763e-04,  1.440045962967450e-03, 1.187898214914235e-03, 1.182757663985140e-03, 1.199592039821090e-03,  9.885366891949797e-04, 2.513857345524363e-03, -4.428234156787458e-05, 6.362606412584957e-06,  1.187993462223169e-03, 3.040159048869775e-03, -4.689925935501763e-05, 1.050056310149552e-05,  9.823927441826197e-04, -4.370977544471889e-05, 2.542562003396645e-03, -3.012427314654651e-05,  1.182802592895060e-03, -4.687956782840465e-05, 3.073837041570793e-03, -3.306415311140946e-05,  9.981884535656849e-04, 6.784538985784606e-06, -3.030556924682608e-05, 2.525345948327162e-03,  1.199655063692541e-03, 1.053499753065040e-05, -3.306201346698248e-05, 3.053318968182286e-03,  7.090933457713314e-04, 5.755135498467364e-04, 5.715472844664339e-04, 5.824942513653851e-04,  1.915154349469308e-03, 2.963406954559188e-04, 2.905965180873548e-04, 2.992497899926678e-04,  5.749106995106072e-04, 1.483346490331912e-03, -2.795683989172690e-05, 6.094520167860541e-06,  2.963406971640330e-04, 1.991691169557569e-03, 1.323809180851874e-04, 1.734628550971876e-04,  5.712272015010599e-04, -2.807023148257649e-05, 1.500785787187109e-03, -1.660841264912387e-05,  2.905965205301221e-04, 1.323809193655450e-04, 2.013989901931133e-03, 1.466566801097167e-04,  5.821366253023861e-04, 6.015381717783817e-06, -1.658546180801786e-05, 1.490547521089420e-03,  2.992497859274604e-04, 1.734628497005386e-04, 1.466566752515056e-04, 2.004475449606794e-03,  8.142035191592476e-04, 6.796355902381103e-04, 6.758607353952552e-04, 6.880815344015054e-04,  1.019448400198770e-03, 8.504257405007444e-04, 8.461822684512803e-04, 8.599595371497987e-04,  6.804417692388015e-04, 1.735320372925035e-03, -3.409497234114567e-05, 4.931457127457522e-06,  8.525044861445752e-04, 2.169106272730367e-03, -3.951644074554236e-05, 5.628529518066192e-06,  6.761584831530957e-04, -3.389289522606103e-05, 1.755336888245232e-03, -2.156648095511643e-05,  8.470934675100813e-04, -3.905072111621423e-05, 2.194009166213929e-03, -2.623043146070754e-05,  6.886408591707752e-04, 5.075745811230897e-06, -2.165121973227120e-05, 1.743450995981761e-03,  8.612897930648427e-04, 5.957027514351623e-06, -2.638482327636730e-05, 2.179132310123278e-03,  4.609014534268110e-04, 3.797478924461971e-04, 3.772959136529580e-04, 3.852041432112908e-04,  3.578489921575407e-03, -7.124170642831099e-04, -7.184915613942100e-04, -7.202444614470326e-04,  3.811022825423619e-04, 9.758918033229458e-04, -2.191519988348447e-05, 2.353106072245114e-06, -7.124170635349563e-04, 1.702863895123715e-03, 4.494493760942665e-04, 4.830661999575954e-04,  3.795195479914644e-04, -2.225971471233896e-05, 9.870490316279692e-04, -1.311390850315697e-05, -7.184915597346750e-04, 4.494493777689879e-04, 1.719672987362089e-03, 4.653595222012306e-04,  3.867206781384154e-04, 2.316254972847287e-06, -1.281468608181503e-05, 9.805270832189304e-04, -7.202444638440025e-04, 4.830661962686305e-04, 4.653595198617667e-04, 1.720099415778342e-03,  5.347292279513750e-04, 4.446455962859685e-04, 4.414209583587951e-04, 4.508147615322540e-04,  7.090933457713099e-04, 5.755135498467473e-04, 5.715472844664390e-04, 5.824942513653884e-04,  4.457617241193551e-04, 1.137049348309615e-03, -2.583959903964132e-05, 2.701427066103821e-06,  5.749106995106139e-04, 1.483346490331940e-03, -2.795683989172670e-05, 6.094520167861125e-06,  4.437697482972132e-04, -2.632919433447865e-05, 1.150185804172124e-03, -1.574981141076532e-05,  5.712272015010539e-04, -2.807023148257281e-05, 1.500785787187116e-03, -1.660841264911940e-05,  4.523098191471651e-04, 2.598472101475068e-06, -1.538250713343963e-05, 1.142605634565656e-03,  5.821366253023909e-04, 6.015381717779112e-06, -1.658546180801394e-05, 1.490547521089425e-03,  3.072982233821019e-04, 2.549560422896370e-04, 2.541932165079967e-04, 2.587403230155064e-04,  5.822747086481575e-04, 2.392649557728399e-04, 2.378931272237985e-04, 2.430283502024068e-04,  2.545734207344976e-04, 6.537282608944124e-04, -1.594188202625995e-05, -8.568069289810152e-08,  2.392649557600940e-04, 8.457678168102518e-04, 1.193627258526740e-05, 3.244285021363947e-05,  2.536504913333541e-04, -1.587902977187448e-05, 6.609167453438141e-04, -9.515875562458142e-06,  2.378931282310411e-04, 1.193627476132774e-05, 8.548930985273395e-04, 2.003541658455770e-05,  2.582235578884265e-04, -1.298946107848117e-08, -9.519050544541986e-06, 6.566421116919917e-04,  2.430283492184670e-04, 3.244284807726653e-05, 2.003541625568293e-05, 8.502287096774601e-04,  3.370405118541770e-04, 2.820745326717934e-04, 2.802380587118763e-04, 2.866447808957540e-04,  4.609014534268075e-04, 3.797478924462024e-04, 3.772959136529663e-04, 3.852041432112762e-04,  2.826506918329544e-04, 7.226625824561764e-04, -1.834084855294655e-05, 1.023389352373448e-06,  3.811022825423606e-04, 9.758918033229379e-04, -2.191519988348677e-05, 2.353106072248127e-06,  2.812825711502598e-04, -1.852721004405949e-05, 7.310694064485069e-04, -1.048381183355747e-05,  3.795195479914639e-04, -2.225971471234355e-05, 9.870490316279629e-04, -1.311390850315219e-05,  2.871961007541438e-04, 1.078362321822032e-06, -1.026502284637214e-05, 7.261784618454482e-04,  3.867206781384127e-04, 2.316254972844660e-06, -1.281468608182080e-05, 9.805270832189295e-04,  2.465204577786442e-04, 1.997400312849685e-04, 1.997037650969905e-04, 2.016024579787560e-04,  7.179987647581246e-04, 5.184787891427219e-05, 5.092523727054454e-05, 5.251647089201245e-05,  1.992636183909024e-04, 5.184242648509887e-04, -9.982161820423696e-06, -1.588944389644981e-06,  5.184787831790385e-05, 6.557323570460134e-04, 5.690190194998709e-05, 6.968506675541522e-05,  1.991228105862420e-04, -9.941485054520052e-06, 5.237733660567164e-04, -6.812795598229846e-06,  5.092523788732019e-05, 5.690190452350382e-05, 6.623647232279804e-04, 6.250953295673146e-05,  2.011716062654181e-04, -1.588117606253092e-06, -6.865575931867310e-06, 5.202530629455792e-04,  5.251647084496645e-05, 6.968506566668827e-05, 6.250953394846816e-05, 6.598089640012778e-04,  2.298925691517757e-04, 1.921235411004847e-04, 1.917712688080524e-04, 1.949935801954166e-04,  3.072982233821024e-04, 2.549560422896373e-04, 2.541932165079975e-04, 2.587403230155066e-04,  1.913825755278690e-04, 4.928870646701604e-04, -1.254207643170731e-05, -1.043565718702629e-06,  2.545734207344977e-04, 6.537282608944129e-04, -1.594188202625961e-05, -8.568069289853659e-08,  1.908102632034641e-04, -1.245615858985618e-05, 4.982567636794117e-04,
                  -7.457003779681727e-06,  2.536504913333542e-04, -1.587902977187435e-05, 6.609167453438168e-04, -9.515875562457946e-06,  1.941964164789666e-04, -9.823578264794416e-07, -7.507483777377195e-06, 4.949162231831793e-04,  2.582235578884264e-04, -1.298946107839884e-08, -9.519050544541932e-06, 6.566421116919916e-04,  3.684847981543597e-04, 1.805739518517622e-04, 1.812016709087315e-04, 1.802472484128594e-04,  2.791674803965295e-03, -7.974007646410151e-04, -7.996524949197326e-04, -8.083679445946911e-04,  1.802411636983411e-04, 5.852869109670093e-04, 8.947937198024742e-06, 1.119055869084810e-05, -7.974007653864830e-04, 9.442879311656987e-04, 3.929273642630020e-04, 4.019070585206576e-04,  1.811324531945882e-04, 8.842454399768932e-06, 5.905002226773815e-04, 8.283725507329047e-06, -7.996524944043025e-04, 3.929273671268264e-04, 9.516283757686366e-04, 3.988925077198402e-04,  1.801033223210462e-04, 1.113511159389660e-05, 8.322429769393421e-06, 5.868630399405441e-04, -8.083679442453833e-04, 4.019070578883522e-04, 3.988925092498530e-04, 9.554213576126670e-04,  2.052006224426432e-04, 1.766675036098742e-04, 1.770855523967207e-04, 1.776877801036367e-04,  2.465204577786452e-04, 1.997400312849675e-04, 1.997037650969897e-04, 2.016024579787559e-04,  1.759835442147756e-04, 4.489561216608182e-04, -8.852731686313149e-06, -4.213000231255499e-06,  1.992636183909013e-04, 5.184242648509908e-04, -9.982161820423137e-06, -1.588944389644521e-06,  1.765204128346666e-04, -8.901433387052994e-06, 4.532349304021237e-04, -7.443279680331718e-06,  1.991228105862402e-04, -9.941485054519250e-06, 5.237733660567162e-04, -6.812795598229247e-06,  1.771986732164180e-04, -4.251299572034713e-06, -7.457294432963775e-06, 4.501221599162674e-04,  2.011716062654188e-04, -1.588117606253307e-06, -6.865575931867696e-06, 5.202530629455785e-04,  3.890121661272747e-04, 3.111947254541215e-04, 3.130977683335361e-04, 3.097969399476602e-04,  9.894316457324045e-03, -3.536187318972857e-03, -3.544347909067758e-03, -3.581993308959960e-03,  3.120911396433124e-04, 8.107679056014557e-04, -4.938365840134005e-06, -7.821161289299691e-06, -3.536187330859782e-03, 2.201366368261420e-03, 1.509090583803681e-03, 1.522899336289674e-03,  3.143542643277697e-04, -5.080972570689179e-06, 8.172293625967368e-04, -1.034213605754277e-05, -3.544347908283912e-03, 1.509090582226101e-03, 2.214830468499629e-03, 1.524095886834065e-03,  3.108620981241280e-04, -7.862795072435080e-06, -1.025201747276458e-05, 8.118475884749607e-04, -3.581993308429667e-03, 1.522899330795657e-03, 1.524095888087347e-03, 2.238706615195236e-03,  2.771028933191758e-04, 2.317848079964306e-04, 2.329498373684200e-04, 2.310618839426012e-04,  3.684847981543664e-04, 1.805739518517581e-04, 1.812016709087116e-04, 1.802472484128530e-04,  2.320996094797708e-04, 5.942306919722016e-04, -6.154558238839288e-06, -7.197067814549575e-06,  1.802411636983325e-04, 5.852869109670138e-04, 8.947937198034662e-06, 1.119055869085401e-05,  2.338059328530858e-04, -6.370167607855832e-06, 5.991743629436219e-04, -9.059918411275332e-06,  1.811324531945828e-04, 8.842454399772192e-06, 5.905002226773906e-04, 8.283725507334148e-06,  2.317028148881398e-04, -7.282815145442752e-06, -8.952605281873344e-06, 5.950908269283868e-04,  1.801033223210420e-04, 1.113511159389895e-05, 8.322429769401466e-06, 5.868630399405488e-04,  5.819415112718575e-04, 4.851582147460054e-04, 4.885621186740348e-04, 4.824085312465280e-04,  7.438279783484929e-04, 2.959437972250365e-04, 2.985177608577898e-04, 2.927316101258193e-04,  4.842232478174234e-04, 1.240183503393459e-03, -8.143741701869803e-06, -1.471593796302932e-05,  2.959436627202589e-04, 1.065920172838551e-03, 3.393554485508392e-05, 2.963802033411087e-05,  4.884430889121835e-04, -8.469365673439882e-06, 1.249318897867091e-03, -1.888802459692805e-05,  2.985177764706660e-04, 3.393548844264652e-05, 1.074014950880999e-03, 2.655342839569511e-05,  4.819897413927096e-04, -1.490432552427622e-05, -1.875983414221838e-05, 1.241417607854899e-03,  2.927316276856254e-04, 2.963795767687767e-05, 2.655342772316009e-05, 1.068120356938341e-03,  4.295724178495056e-04, 3.646303711070679e-04, 3.670088559386753e-04, 3.624591788498344e-04,  3.890121661272519e-04, 3.111947254541399e-04, 3.130977683335100e-04, 3.097969399476706e-04,  3.649578845630909e-04, 9.286316802365634e-04, -6.691706914691918e-06, -1.211419583141235e-05,  3.120911396433130e-04, 8.107679056014406e-04, -4.938365840140290e-06, -7.821161289300893e-06,  3.683605688803775e-04, -7.099233143761032e-06, 9.356020017863709e-04, -1.461882729822764e-05,  3.143542643277769e-04, -5.080972570691408e-06, 8.172293625967379e-04, -1.034213605754292e-05,  3.633669983549842e-04, -1.230090409648938e-05, -1.441852802111645e-05, 9.294882400018907e-04,  3.108620981241260e-04, -7.862795072455383e-06, -1.025201747276710e-05, 8.118475884749554e-04,  1.331879711583109e-03, 5.466191974107141e-04, 5.520250902944957e-04, 5.409932369723953e-04,  1.200620538634858e-03, 4.185587083672124e-04, 4.231272239469457e-04, 4.134759510719398e-04,  5.449468664146782e-04, 1.937325942469870e-03, 6.103600021805178e-05, 5.281149929910382e-05,  4.185595802717756e-04, 1.627103239651763e-03, 6.473043336111677e-05, 5.776052714299850e-05,  5.502605309128258e-04, 6.107057945030674e-05, 1.951016244268513e-03, 4.553108310565119e-05,  4.231270060029748e-04, 6.473087057489771e-05, 1.638529648490298e-03, 5.210872299370171e-05,  5.392657785866630e-04, 5.284668057839231e-05, 4.551891435647006e-05, 1.940875050769051e-03,  4.134757070272149e-04, 5.776097178477250e-05, 5.210873118087534e-05, 1.630300671466714e-03,  6.827019863278310e-04, 5.699851055614958e-04, 5.739551402111768e-04, 5.664547909581673e-04,  5.819415112718556e-04, 4.851582147460067e-04, 4.885621186740337e-04, 4.824085312465261e-04,  5.676289011421929e-04, 1.456128112473541e-03, -8.436184033783606e-06, -1.689201101515171e-05,  4.842232478174189e-04, 1.240183503393444e-03, -8.143741701867858e-06, -1.471593796303056e-05,  5.724783987637814e-04, -8.788883030531487e-06, 1.466814316664708e-03, -2.174294791909926e-05,  4.884430889121838e-04, -8.469365673439140e-06, 1.249318897867091e-03, -1.888802459692843e-05,  5.646572134619839e-04, -1.708280674127913e-05, -2.160222693000655e-05, 1.457582939658243e-03,  4.819897413927125e-04, -1.490432552427754e-05, -1.875983414221972e-05, 1.241417607854909e-03, -2.882434111828537e-03, 2.690667796470411e-03, 2.703404407568683e-03, 2.706639577547397e-03, -1.013853287481381e-03, 1.712349763341676e-03, 1.721952392637275e-03, 1.718969620383131e-03,  2.689690377564711e-03, 2.031675039496202e-03, -6.718163709842822e-04, -6.880725021522791e-04,  1.712975885107736e-03, 1.946922060234726e-03, -3.431787336592473e-04, -3.557752081377235e-04,  2.701379437273341e-03, -6.714014064949284e-04, 2.047419924974916e-03, -7.023951245920117e-04,  1.721760853652085e-03, -3.428531274635359e-04, 1.961315391928226e-03, -3.666959104974168e-04,  2.704630782944082e-03, -6.876460281657401e-04, -7.023999269807538e-04, 2.018688827301635e-03,  1.718760155286357e-03, -3.554401498581433e-04, -3.666894845952361e-04, 1.941163898311913e-03,  1.461497814899417e-03, 6.753319608878729e-04, 6.815768791756500e-04, 6.691705615988504e-04,  1.331879711583116e-03, 5.466191974107044e-04,
                  5.520250902945078e-04, 5.409932369723920e-04,  6.719843148352185e-04, 2.247290340680282e-03, 5.708251560872708e-05, 4.760099105216958e-05,  5.449468664146911e-04, 1.937325942469918e-03, 6.103600021805478e-05, 5.281149929910634e-05,  6.780483334124993e-04, 5.715025429594670e-05, 2.263242243506265e-03, 3.869030568860089e-05,  5.502605309128124e-04, 6.107057945031357e-05, 1.951016244268489e-03, 4.553108310566097e-05,  6.657163035467518e-04, 4.766989553705041e-05, 3.866593845214765e-05, 2.251183908481327e-03,  5.392657785866734e-04, 5.284668057839829e-05, 4.551891435646899e-05, 1.940875050769061e-03 )
               , tolerance = 0.001)

  expect_equal(c(res$n_iter),
               c(389 )
               , tolerance = 0.001)

  expect_equal(c(res$conv_values),
               c(2.993885032679303e+10, 1.845551460085116e-01, 1.805572665585881e-01, 1.595335833831595e-01, 1.366389962341348e-01, 1.162751305416482e-01, 9.911712795908528e-02, 8.495347682541335e-02, 7.333706670975716e-02, 6.380216947694203e-02, 5.593878073501038e-02, 4.941004389073815e-02, 4.394783294078478e-02, 3.934163378049239e-02, 3.542683912183246e-02, 3.207457045633058e-02, 2.918348360363033e-02, 2.667340371590299e-02, 2.448046313817022e-02, 2.255341165633354e-02, 2.085081875789403e-02, 1.933894690031997e-02, 1.799012752170044e-02, 1.678151384676534e-02, 1.569411699711517e-02, 1.471205604707612e-02, 1.382197058100607e-02, 1.301255742161996e-02, 1.227420284687331e-02, 1.159868871869794e-02, 1.097895619259990e-02, 1.040891457248096e-02, 9.883285775741414e-03, 9.397477062250657e-03, 8.947476322698645e-03, 8.529765475610443e-03, 8.141248471844168e-03, 7.779191143912938e-03, 7.441170698030241e-03, 7.125033092828899e-03, 6.828856878596595e-03, 6.550922346128663e-03, 6.289685032344687e-03, 6.043752792761372e-03, 5.811865760108724e-03, 5.592878597222049e-03, 5.385744494139545e-03, 5.189500364818464e-03, 5.003252665959343e-03, 4.826163153513933e-03, 4.657433696440133e-03, 4.496288927428965e-03, 4.341954938726688e-03, 4.193631294593137e-03, 4.050452142628935e-03, 3.911429951451948e-03, 3.775372450360795e-03, 3.640761222010095e-03, 3.505586238179164e-03, 3.367170301125506e-03, 3.222167982081708e-03, 3.067343025724043e-03, 2.902345441476629e-03, 2.733894233313693e-03, 2.554482446482021e-03, 1.684194733438154e-03, 1.225693690726894e-02, 1.256101333201612e-02, 1.131738294112469e-02, 1.112325091090378e-02, 1.093765460957105e-02, 1.072934665380041e-02, 1.050413181783712e-02, 1.026769983662735e-02, 1.002444368861419e-02, 9.777717667032186e-03, 9.530079878948923e-03, 9.283476564700520e-03, 9.039381493361663e-03, 8.798902000142515e-03, 8.562860162738503e-03, 8.331855329026604e-03, 8.106312560021381e-03, 7.886520362205661e-03, 7.672660222052944e-03, 7.464829825976667e-03, 7.263061387970204e-03, 7.067336165001959e-03, 6.877595986454313e-03, 6.693752433895024e-03, 6.515694162495902e-03, 6.343292748033874e-03, 6.176407358235222e-03, 6.014888484701064e-03, 5.858580921181829e-03, 5.707326136041322e-03, 5.560964155850673e-03, 5.419335055362020e-03, 5.282280127731850e-03, 5.149642797155978e-03, 5.021269321695850e-03, 4.897009327035484e-03, 4.776716202378318e-03, 4.660247385618874e-03, 4.547464558069923e-03, 4.438233767395657e-03, 4.332425491582697e-03, 4.229914657070504e-03, 4.130580618976727e-03, 4.034307112955056e-03, 3.940982183310032e-03, 3.850498094214031e-03, 3.762751227105109e-03, 3.677641968499801e-03, 3.595074590613624e-03, 3.514957127496838e-03, 3.437201248302951e-03, 3.361722129501696e-03, 3.288438326712418e-03, 3.217271647835973e-03, 3.148147027678970e-03, 3.080992405156863e-03, 3.015738603015437e-03, 2.952319210945597e-03, 2.890670471884729e-03, 2.830731172197151e-03, 2.772442535218895e-03, 2.715748118752813e-03, 2.660593716412733e-03, 2.606927262583657e-03, 2.554698741217066e-03, 2.503860098200617e-03, 2.454365157522937e-03, 2.406169540825130e-03, 2.359230590383708e-03, 2.313507295326931e-03, 2.268960221216401e-03, 2.225551442631880e-03, 2.183244478740669e-03, 2.142004231702192e-03, 2.101796927885563e-03, 2.062590061647097e-03, 2.024352341662530e-03, 1.987053639749299e-03, 1.950664941884986e-03, 1.915158301505774e-03, 1.880506794912695e-03, 1.846684478658649e-03, 1.813666348878475e-03, 1.781428302517827e-03, 1.749947100192000e-03, 1.719200330832738e-03, 1.689166377864412e-03, 1.659824386846934e-03, 1.631154234762530e-03, 1.603136500430847e-03, 1.575752436304141e-03, 1.548983941784996e-03, 1.522813537330227e-03, 1.497224339852869e-03, 1.472200039416236e-03, 1.447724876565267e-03, 1.423783620987861e-03, 1.400361550838980e-03, 1.377444433348863e-03, 1.355018505630494e-03, 1.333070457055417e-03, 1.311587411774627e-03, 1.290556912474527e-03, 1.269966904398158e-03, 1.249805720255269e-03, 1.230062065933697e-03, 1.210725006408602e-03, 1.191783952608022e-03, 1.173228648567626e-03, 1.155049159406346e-03, 1.137235859424119e-03, 1.119779421104942e-03, 1.102670804104999e-03, 1.085901245242043e-03, 1.069462248303295e-03, 1.053345574784740e-03, 1.037543234655599e-03, 1.022047477647076e-03, 1.006850784815182e-03, 9.919458606056232e-04, 9.773256248946645e-04, 9.629832057381108e-04, 9.489119321802607e-04, 9.351053273017314e-04, 9.215571017259177e-04, 9.082611472062621e-04, 8.952115305208884e-04, 8.824024877345355e-04, 8.698284183106464e-04, 8.574838798476753e-04, 8.453635829485390e-04, 8.334623858815567e-04, 8.217752901143713e-04, 8.102974353354103e-04, 7.990240952009920e-04, 7.879506728763030e-04, 7.770726968988610e-04, 7.663858172427090e-04, 7.558858014120664e-04, 7.455685306683077e-04, 7.354299964987172e-04, 7.254662971529158e-04, 7.156736343396744e-04, 7.060483099486746e-04, 6.965867230083153e-04, 6.872853666297201e-04, 6.781408251236202e-04, 6.691497713434025e-04, 6.603089638752208e-04, 6.516152444289939e-04, 6.430655354427841e-04, 6.346568375653192e-04, 6.263862273145769e-04, 6.182508550026367e-04, 6.102479422911811e-04, 6.023747802673049e-04, 5.946287272733005e-04, 5.870072072670541e-04, 5.795077074022621e-04, 5.721277766840961e-04, 5.648650238096764e-04, 5.577171157828438e-04, 5.506817759358836e-04, 5.437567826834117e-04, 5.369399675822263e-04, 5.302292141042168e-04, 5.236224560401608e-04, 5.171176762382781e-04, 5.107129050280993e-04, 5.044062191188383e-04, 4.981957401770995e-04, 4.920796336161357e-04, 4.860561074593636e-04, 4.801234111310092e-04, 4.742798343207677e-04, 4.685237059252082e-04, 4.628533930159262e-04, 4.572672996578347e-04, 4.517638662146872e-04, 4.463415681353754e-04, 4.409989150762828e-04, 4.357344500502026e-04, 4.305467485200470e-04, 4.254344176469421e-04, 4.203960952195821e-04, 4.154304491396802e-04, 4.105361763996044e-04, 4.057120026039541e-04, 4.009566809792982e-04, 3.962689917167160e-04, 3.916477414972877e-04, 3.870917625773569e-04, 3.825999122099315e-04, 3.781710721041341e-04, 3.738041476883620e-04, 3.694980675662390e-04, 3.652517829885393e-04, 3.610642672718648e-04, 3.569345151310198e-04, 3.528615423771925e-04, 3.488443852447839e-04, 3.448820998903782e-04, 3.409737619782874e-04, 3.371184661586143e-04, 3.333153256689446e-04, 3.295634718544787e-04, 3.258620536049796e-04, 3.222102372309454e-04, 3.186072057461249e-04, 3.150521587144668e-04, 3.115443116443488e-04, 3.080828957817477e-04, 3.046671576327119e-04, 3.012963587734306e-04, 2.979697751845739e-04, 2.946866972935460e-04, 2.914464293444682e-04, 2.882482892461702e-04, 2.850916082177503e-04, 2.819757304538694e-04, 2.789000128396956e-04, 2.758638247067086e-04, 2.728665475563825e-04, 2.699075746438938e-04, 2.669863108860919e-04, 2.641021725757054e-04, 2.612545869758195e-04, 2.584429923654975e-04, 2.556668374494972e-04, 2.529255813545832e-04, 2.502186933776295e-04, 2.475456526730918e-04, 2.449059481763237e-04, 2.422990782903916e-04, 2.397245506041863e-04, 2.371818818748915e-04, 2.346705977758116e-04, 2.321902325972795e-04, 2.297403292054536e-04, 2.273204387709833e-04, 2.249301205435560e-04,
                 2.225689419438891e-04, 2.202364780379561e-04, 2.179323115700382e-04, 2.156560327947086e-04, 2.134072393648317e-04, 2.111855360001997e-04, 2.089905344965256e-04, 2.068218535252254e-04, 2.046791185811662e-04, 2.025619615948607e-04, 2.004700211886619e-04, 1.984029421420317e-04, 1.963603754794921e-04, 1.943419784306810e-04, 1.923474140477648e-04, 1.903763512611957e-04, 1.884284647859830e-04, 1.865034348698963e-04, 1.846009472671455e-04, 1.827206932069459e-04, 1.808623691181962e-04, 1.790256765934037e-04, 1.772103223811700e-04, 1.754160181697458e-04, 1.736424805020396e-04, 1.718894307412023e-04, 1.701565948882183e-04, 1.684437036454805e-04, 1.667504921561734e-04, 1.650767000229165e-04, 1.634220710888617e-04, 1.617863536702955e-04, 1.601692999758676e-04, 1.585706666066966e-04, 1.569902139539641e-04, 1.554277064638561e-04, 1.538829124668965e-04, 1.523556040050238e-04, 1.508455569661141e-04, 1.493525507159352e-04, 1.478763684682501e-04, 1.464167967459314e-04, 1.449736255948018e-04, 1.435466484062672e-04, 1.421356620894390e-04, 1.407404666144688e-04, 1.393608652426307e-04, 1.379966644322818e-04, 1.366476736733712e-04, 1.353137054874549e-04, 1.339945754939901e-04, 1.326901020677206e-04, 1.314001066551612e-04, 1.301244133395995e-04, 1.288628491980927e-04, 1.276152438127855e-04, 1.263814296008999e-04, 1.251612415453563e-04, 1.239545172534385e-04, 1.227610968186117e-04, 1.215808229191437e-04, 1.204135405967450e-04, 1.192590973476323e-04, 1.181173430109390e-04, 1.169881298532712e-04, 1.158713122359354e-04, 1.147667469382670e-04, 1.136742929068517e-04, 1.125938112167493e-04, 1.115251651045591e-04, 1.104682199146706e-04, 1.094228430314931e-04, 1.083889039226321e-04, 1.073662739049280e-04, 1.063548264591098e-04, 1.053544368165321e-04, 1.043649822190879e-04, 1.033863417107294e-04, 1.024183961650379e-04, 1.014610282678091e-04, 1.005141224827861e-04, 9.957756498372063e-05 )
               , tolerance = 0.001)

  expect_equal(c(res$Q),
               c( 0.9391990518400130, -0.3732788989372035, -0.3742222383999275, -0.3777241050637700, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, -0.3732788989372035, 0.1483585652022716,  0.1487325017253130, 0.1501242979641959, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, -0.3742222383999275, 0.1487325017253130, 0.1491093550006312, 0.1505036847762440,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, -0.3777241050637700,  0.1501242979641959, 0.1505036847762440, 0.1519130401145398, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000,  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000 )
               , tolerance = 0.001)

  expect_equal(c(res$Q_0),
               c( 1.233459652078745e-03, 1.017725252308313e-03, 1.013004405255948e-03, 1.028305611707184e-03,  1.440038112631797e-03, 1.187986746087655e-03, 1.182795957720876e-03, 1.199648662590449e-03,  1.017725252308313e-03, 2.605599389604312e-03, -4.221399291551422e-05, 9.075149870283627e-06,  1.187891536386770e-03, 3.040142496047129e-03, -4.687980260696214e-05, 1.053496350709301e-05,  1.013004405255948e-03, -4.221399291551422e-05, 2.634670793790814e-03, -2.887541810470802e-05,  1.182751045264334e-03, -4.689948434471262e-05, 3.073819998524194e-03, -3.306139973441495e-05,  1.028305611707184e-03, 9.075149870283627e-06, -2.887541810470802e-05, 2.617067052266464e-03,  1.199585651921931e-03, 1.050052741968590e-05, -3.306355140219436e-05, 3.053302347844985e-03,  1.440038112631797e-03, 1.187891536386770e-03, 1.182751045264334e-03, 1.199585651921931e-03,  1.689614806507119e-03, 1.393238655408022e-03, 1.387674043574546e-03, 1.406091082487674e-03,  1.187986746087655e-03, 3.040142496047129e-03, -4.689948434471262e-05, 1.050052741968590e-05,  1.393238655408022e-03, 3.564144339896500e-03, -5.182543184178248e-05, 1.230785220789408e-05,  1.182795957720876e-03, -4.687980260696214e-05, 3.073819998524194e-03, -3.306355140219436e-05,  1.387674043574546e-03, -5.182543184178248e-05, 3.603318015995387e-03, -3.780041088219931e-05,  1.199648662590449e-03, 1.053496350709301e-05, -3.306139973441495e-05, 3.053302347844985e-03,  1.406091082487674e-03, 1.230785220789408e-05, -3.780041088219931e-05, 3.579277560762716e-03 )
               , tolerance = 0.001)
})

# par(mfcol = c(2, 2))
# plot(res$a_t_d_s[, 1], type = "l", ylim = range(res$a_t_d_s[, 1], res_new$a_t_d_s[, 1]))
# for(i in 1:3){
#   plot(res$a_t_d_s[, i + 1], type = "l", ylim = range(sims$betas[, i ], res$a_t_d_s[, i + 1], res_new$a_t_d_s[, i + 1]))
#   lines(x = seq_len(nrow(sims$betas)), sims$betas[, i], col = "red")
# }
