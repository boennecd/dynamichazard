# Simulate series to work with
set.seed(2972)
sims <- test_sim_func_logit(n_series = 10^4, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = .1, x_mean = -.4, re_draw = T)
sims$res <- as.data.frame(sims$res)

design_mat <- benssurvutils::get_design_matrix(survival::Surv(tstart, tstop, event) ~ x1 + x2 + x3, sims$res)
rist_sets <- benssurvutils::get_risk_sets(design_mat$Y, by = 1, max_T = 10, id = sims$res$id)

res <- ddhazard_fit(X = design_mat$X, Y = design_mat$Y,
                    a_0 = rep(0, ncol(design_mat$X)),
                    Q_0 = diag(10, ncol(design_mat$X)), # something large
                    Q = diag(1, ncol(design_mat$X)), # something large
                    F_= diag(1, ncol(design_mat$X)), # first order random walk
                    risk_sets = rist_sets,
                    eps = 10^-4, n_max = 10^4,
                    order_ = 1,
                    est_Q_0 = F)

# get_expect_equal(res)

test_that("Testing versus previously computed values", {
  expect_equal(c(res$V_t_d_s),
               c( 0.4029214966915901641, 0.4993391738275719249, 0.4302867630986570990, 0.3741188319647095750, 0.4993391738275717584, 1.4238250879023635065,  0.5756348887506965717, 0.3580439028978005256, 0.4302867630986570435, 0.5756348887506964607, 1.3430132992519094870, 0.3246630511738523017,  0.3741188319647096305, 0.3580439028978001370, 0.3246630511738525238, 0.9363533675493762587, 0.3336481600440015516, 0.3112788532796001428,  0.2634009256516216535, 0.2665915288915029491, 0.3112788532796000318, 0.7732208022694160299, 0.0035870730672170614, 0.0167436885227067317,  0.2634009256516215425, 0.0035870730672170198, 0.6899790528119904565, -0.0178497106034805619, 0.2665915288915030601, 0.0167436885227064958, -0.0178497106034803954, 0.6780892162641674048, 0.3095627612631597358, 0.2793682691892662162, 0.2510952718056420063, 0.2527057292720807924,  0.2793682691892663272, 0.6995733125178633660, 0.0030627254514624253, 0.0125381120519529356, 0.2510952718056421729, 0.0030627254514625779,  0.6549769026387830539, -0.0104412195201863539, 0.2527057292720806814, 0.0125381120519528454, -0.0104412195201864233, 0.6421639653568003148,  0.2920202611579862939, 0.2538310266587939790, 0.2377989444530859697, 0.2407655868102560048, 0.2538310266587939790, 0.6434190662949718087, -0.0076953750624687324, 0.0038410294161615116, 0.2377989444530859697, -0.0076953750624687359, 0.6210648085129376605, -0.0123045915781446365,  0.2407655868102560603, 0.0038410294161615238, -0.0123045915781445584, 0.6152349148036252435, 0.3020103779545389999, 0.2681954727853997356,  0.2451387968191722222, 0.2474147888920046889, 0.2681954727853997911, 0.6742242233688346964, -0.0004426798821749525, 0.0096499207486231454,  0.2451387968191721389, -0.0004426798821751676, 0.6383075925391438199, -0.0101362674791587587, 0.2474147888920047444, 0.0096499207486230570, -0.0101362674791586858, 0.6289229646912896099, 0.3222937737118912183, 0.2964300974099762231, 0.2596799150488426910, 0.2609462297076691750,  0.2964300974099762787, 0.7359488412764916276, 0.0114970295156857569, 0.0193066941498921466, 0.2596799150488425245, 0.0114970295156856736,  0.6744521019695188802, -0.0078910213196276141, 0.2609462297076691195, 0.0193066941498921257, -0.0078910213196274944, 0.6583298283696461528,  0.3464177290044320734, 0.3289032727057213945, 0.2750778869201766508, 0.2764941230271240058, 0.3289032727057215055, 0.8081473592089392088,  0.0199952689208318761, 0.0281508182432141790, 0.2750778869201766508, 0.0199952689208317616, 0.7126998375752264803, -0.0093126902119904618,  0.2764941230271240058, 0.0281508182432141513, -0.0093126902119904063, 0.6936878720105823515, 0.3732540533455798171, 0.3631471241604801725,  0.2892096626186252961, 0.2927479572162383081, 0.3631471241604802280, 0.8828793645214826347, 0.0188863266721862252, 0.0330777850194327872,  0.2892096626186252961, 0.0188863266721861559, 0.7464879161711128752, -0.0168600371639652906, 0.2927479572162383081, 0.0330777850194327178, -0.0168600371639652143, 0.7325016673436338666, 0.4099767907787746912, 0.4138685869768973791, 0.3127512159027160954, 0.3167127610763650902,  0.4138685869768973791, 0.9967279156567293574, 0.0335241506429649616, 0.0489625372031610648, 0.3127512159027160954, 0.0335241506429650032,  0.8075387511587012179, -0.0169624250450669534, 0.3167127610763650902, 0.0489625372031610370, -0.0169624250450669395, 0.7872348601417398228,  0.4534452853569672093, 0.4762234689533819676, 0.3430720095012675386, 0.3461045187460613515, 0.4762234689533820231, 1.1376976827446867446,  0.0598381939673059762, 0.0728624792137144706, 0.3430720095012675386, 0.0598381939673059138, 0.8867080628414066856, -0.0114890945021469681,  0.3461045187460613515, 0.0728624792137144150, -0.0114890945021469959, 0.8523252369526406191, 0.5016896134986048583, 0.5481452770235857308,  0.3800921252090103675, 0.3803130627954725007, 0.5481452770235857308, 1.3035918235515895347, 0.1026762888249837663, 0.1073277272100895269,  0.3800921252090103675, 0.1026762888249837663, 0.9868141506544647612, 0.0034550836826023313, 0.3803130627954725007, 0.1073277272100895269,  0.0034550836826023313, 0.9271297171011109173))

  expect_equal(c(res$a_t_d_s),
               c(-0.14982837965567269, -0.14983774711828657, -0.65461104507924173, -0.26673053416885251, 0.06475350319239759, 0.19370426033255764, 0.01251210067089797,  0.22209014456122195, 0.49719766616867506, 0.76782012647376230, 0.91703506535013890, 2.70904041250830518, 2.70901587152738976, 1.25248496988402591,  2.44891567077415617, 3.41952918275879680, 3.78712081168321912, 3.25106042591554756, 3.93815617345065672, 4.80146983688180207, 5.63428914893416710,  6.09332221658085427, 3.20395238393771908, 3.20392266792761315, 1.70343144900002352, 2.88186562691612025, 3.80162335618218972, 4.09496196494998177,  3.54254487914628058, 4.31720047356391845, 5.25803788800513505, 6.16011615763082609, 6.66008640316982614, 2.84220679489414207, 2.84219010044697917,  1.94997917063051784, 2.65270790627474717, 3.20835753521012101, 3.42259424169848891, 3.15501815422684251, 3.61540475757763113, 4.16346112915325151,  4.68626741189212837, 4.96782191572881615))

  expect_equal(c(res$B_s),
               c( 0.98869649600605802, -0.02702171368716887, -0.02418353953265028, -0.01549729997865992, -0.02702171368716887, 0.92225751842546722, -0.06742397296600280, -0.04060421788699525, -0.02418353953265028, -0.06742397296600280, 0.92418271380858330, -0.04004791674154969, -0.01549729997865992, -0.04060421788699525, -0.04004791674154969, 0.96964402677455941, 1.40899347751119985, 1.30981566562727703, 1.38617173094501811, 0.81324917883072656, -0.18249187472161821,  0.43582152078097453, -0.55582978019868667, -0.32921247444755863, -0.17153723130688076, -0.52499095881670232, 0.42824117218272251, -0.32260165998112056, -0.17263438069630788, -0.52775101663927548, -0.55134560579209135, 0.65586140192137288, 1.38484330420890278, 1.27917051832604867, 1.37371058111275457,  0.80511641317650851, -0.18298752507442520, 0.42596085526968741, -0.55108026659065101, -0.32745846285604008, -0.16605246945053423, -0.51205384168206591,  0.42354272830962658, -0.31708532511992271, -0.16746677395024645, -0.51592737752851414, -0.54367159553814937, 0.64852415260889495, 1.32630861446373016,  1.19655368087206138, 1.33100224487388186, 0.77944467541742513, -0.18408862973874113, 0.40429791252077063, -0.53936219384796569, -0.32284317061010143, -0.15515952184605081, -0.48645329319536301, 0.40905816370603504, -0.30610210739344312, -0.15598656837859137, -0.48897895134608960, -0.52555807521697540,  0.63013406569146746, 1.31032598263414002, 1.17576149799274754, 1.31386479093688613, 0.76954533788940349, -0.18229029750613118, 0.40186948341237194, -0.53210905196804270, -0.31891180312654233, -0.15189954971775654, -0.47751349687330319, 0.40770270217548460, -0.30094458845616257, -0.15289764618523294, -0.48044260887879853, -0.51737390815700246, 0.62531811222810463, 1.30898627670757728, 1.17442078711907838, 1.30508716263519586, 0.76509208093247993, -0.17998759471463466, 0.40567756213510109, -0.52700765945268935, -0.31578114714410527, -0.15118985575920646, -0.47418544409578828, 0.41108389834543840, -0.29798517698119220, -0.15268709639188338, -0.47856775543236235, -0.51334966007661043, 0.62536034401636142, 1.31095705948022578, 1.17798143035886316,  1.30066134064303851, 0.76316313742424779, -0.17809015184091109, 0.40969135150723318, -0.52342404411278731, -0.31344906606782363, -0.15180289496663035, -0.47452439533207202, 0.41251264001049381, -0.29728506647068381, -0.15333034262973300, -0.47907752550520466, -0.51186914247687609, 0.62573778730960816,  1.31158036603622241, 1.18547793764472709, 1.30572714054986405, 0.76635406540641227, -0.17827715153519552, 0.40638160391132155, -0.52447556303761933, -0.31407017536106352, -0.15315950269741632, -0.47805857380300021, 0.40678246341009278, -0.29909887569913596, -0.15427549534899282, -0.48137970833432792, -0.51344731048525016, 0.62221482576513321, 1.31181933397523220, 1.18031463858630858, 1.29280424684510375, 0.75905454537573536, -0.17551937553542191,  0.41431607631408351, -0.51837477187134806, -0.31007797835090134, -0.15268779687971429, -0.47526657239923031, 0.41300593468312513, -0.29651747456515631, -0.15364992013610607, -0.47806005013113795, -0.50828064587010569, 0.62632889301997985, 1.31064477665530443, 1.16572249777837800, 1.26898582515555769,  0.74547955514097275, -0.17093402084858184, 0.42916120055873641, -0.50740179182708156, -0.30313282949220999, -0.15071300922916958, -0.46779500024597964,  0.42642724465589060, -0.29092857525483640, -0.15167186894768181, -0.47063010946459860, -0.49861321849274176, 0.63492029235727132))

  expect_equal(c(res$lag_one_cor),
               c( 0.310964063090747977, 0.286520330295324199, 0.243917129994488557, 0.253048784507885705, 0.249479240294716353, 0.703775691151232063, -0.049605694757855534, -0.018091551217721047, 0.203697696478528423, -0.057016881844946188, 0.631769735807028887, -0.051228507242832233, 0.230140345232492050, -0.020128244937716422, -0.049167742382621782, 0.653408688622889589, 0.298491587526983126, 0.263271743151284099, 0.242682266715625317, 0.244704100123347201, 0.262036405099842551,  0.662585135869088626, -0.008123265662441287, 0.003041162337501180, 0.242027085093256988, -0.007192531103841660, 0.632603610576650821, -0.015201158484974830,  0.244516324587946698, 0.004122977671184386, -0.014949892733051987, 0.625923937254551754, 0.278147053942062572, 0.234413126369385022, 0.229653698724972932,  0.231731551724923573, 0.235682369179458784, 0.600723255844425541, -0.010762874977909585, -0.001499554120319907, 0.231090655802928396, -0.011232762187964488,  0.600644835903992536, -0.011071749395374170, 0.232730929971950551, -0.001398401833916194, -0.010934612649993274, 0.595482855280058843, 0.274558226465597299,  0.230156380474956873, 0.227752811024628826, 0.229841128544176487, 0.229573300175160505, 0.588994461191832408, -0.012407653913504287, -0.002652751890702687,  0.227567178300736722, -0.011934955513637893, 0.592951182574339430, -0.010577028739942360, 0.229682288766630355, -0.002408903701124098, -0.010559460583376966,  0.589139246394903671, 0.288930248619384766, 0.249565383747813480, 0.236927090916277949, 0.238946763249950817, 0.248696468606679072, 0.629520730768719172, -0.008326847586800390, 0.002047670080660230, 0.236582735894039220, -0.007437382073046981, 0.614125176820513707, -0.011245070054964834, 0.238509752713913226,  0.002026484214683311, -0.011738179259840543, 0.608693147530690926, 0.310451473466490713, 0.277752022454376690, 0.250143220630954621, 0.252351011878279574,  0.277509758001394435, 0.691164551573619890, -0.002326315309939859, 0.008579895181474173, 0.249912713132567910, -0.002883889192235438, 0.646223053005557047, -0.013919496619581070, 0.252119335478666273, 0.008089700820203624, -0.014051990424011666, 0.639233896196040430, 0.335857101108716416, 0.310899338788697299,  0.265044108637732867, 0.268133844224458184, 0.310978572522384589, 0.764679762677460517, 0.002271714585058556, 0.015478752546781278, 0.264851176710123537,  0.001070488942373949, 0.682844103824201465, -0.018447736269025343, 0.268231352706568227, 0.015486183488128243, -0.017675420086833541, 0.676412458474939915,  0.367172357725767284, 0.352439837217764673, 0.283156417137481187, 0.287812246016451556, 0.352234523816499445, 0.856087888450584589, 0.006497808083524253,  0.024503610586406748, 0.282860257205478194, 0.006137365418147111, 0.727987067074468697, -0.023242845076726706, 0.287723439048004737, 0.024565543704981735, -0.022938975002437717, 0.722239082970881907, 0.405690005379252316, 0.404699290924117494, 0.305921530433144351, 0.312032362355640691, 0.404005745586078990,  0.970188237779448293, 0.013794615990066508, 0.036698063513584844, 0.305126306163764016, 0.013588887593658984, 0.784561717368825517, -0.028290165496394237,  0.311571708677211789, 0.036597397074580262, -0.028264525322047047, 0.777361797317409287, 0.448872574229394139, 0.463842302793060879, 0.331365118463757435,  0.338969146277502242, 0.463281580345203503, 1.099893198949686957, 0.023893828705652154, 0.051448958643070281, 0.330959629807172473, 0.024412703025049776,  0.849315075071405912, -0.032652185679399481, 0.338727341657586334, 0.051742704810023743, -0.032672377689215826, 0.838629343696684959))

  # expect_equal(c(res$n_iter),
  #              c(116))
  #
  # expect_equal(c(res$conv_values),
  #              c(1.456472355033060e+10, 1.039231013300363e+00, 6.641673010687905e-01, 2.113798951615865e-01, 3.179996063638860e-02, 4.955828375764382e-03, 4.007492183836794e-03, 3.582607879797057e-03, 3.298762565177498e-03, 3.070352044538111e-03, 2.865668658706431e-03, 2.677677950486943e-03, 2.504531666187796e-03, 2.345145305613204e-03, 2.198494419121924e-03, 2.063560554740376e-03, 1.939357119086843e-03, 1.824951317649845e-03, 1.719475715252933e-03, 1.622132425762508e-03, 1.532192820823067e-03, 1.448994673330723e-03, 1.371937943283514e-03, 1.300479959615260e-03, 1.234130452444445e-03, 1.172446686743840e-03, 1.115028852017942e-03, 1.061515794327418e-03, 1.011581090614508e-03, 9.649294991766979e-04, 9.212937543573081e-04, 8.804316764443073e-04, 8.421236106348680e-04, 8.061701019584790e-04, 7.723898544698264e-04, 7.406178833182827e-04, 7.107038829002615e-04, 6.825107607092545e-04, 6.559133354630844e-04, 6.307971748573118e-04, 6.070575477300554e-04, 5.845984960403331e-04, 5.633320091918642e-04, 5.431772619726903e-04, 5.240599647598302e-04, 5.059117456148994e-04, 4.886696213050741e-04, 4.722755120321570e-04, 4.566757970596477e-04, 4.418209288513208e-04, 4.276650769423905e-04, 4.141658061983964e-04, 4.012837826695466e-04, 3.889825226304477e-04, 3.772281444258825e-04, 3.659891591569118e-04, 3.552362724516159e-04, 3.449422108189013e-04, 3.350815576093505e-04, 3.256306025691388e-04, 3.165672182642609e-04, 3.078707269772144e-04, 2.995217980207221e-04, 2.915023378376742e-04, 2.837954076532703e-04, 2.763851284691486e-04, 2.692566051861686e-04, 2.623958579744864e-04, 2.557897597802513e-04, 2.494259659424916e-04, 2.432928636701228e-04, 2.373795288800664e-04, 2.316756651670632e-04, 2.261715693323782e-04, 2.208580931383666e-04, 2.157265967945490e-04, 2.107689273756459e-04, 2.059773763158709e-04, 2.013446558064480e-04, 1.968638750480139e-04, 1.925285047559878e-04, 1.883323665043395e-04, 1.842696023845557e-04, 1.803346561260446e-04, 1.765222607934935e-04, 1.728274132204296e-04, 1.692453631009083e-04, 1.657715965984850e-04, 1.624018228158796e-04, 1.591319598409546e-04, 1.559581246008703e-04, 1.528766178237920e-04, 1.498839193962642e-04, 1.469766713716112e-04, 1.441516745959434e-04, 1.414058754046039e-04, 1.387363642189371e-04, 1.361403596673041e-04, 1.336152056289968e-04, 1.311583684442124e-04, 1.287674218384939e-04, 1.264400458657754e-04, 1.241740270277382e-04, 1.219672398345285e-04, 1.198176545411882e-04, 1.177233263498162e-04, 1.156823912151579e-04, 1.136930633102811e-04, 1.117536298873558e-04, 1.098624505674528e-04, 1.080179484561382e-04, 1.062186134111315e-04, 1.044629939925028e-04, 1.027496953035392e-04, 1.010773821270687e-04))

  expect_equal(c(res$Q),
               c(0.1331296767928831, 0.3263881644753573, 0.2970801680736908, 0.1877867890441471, 0.3263881644753573, 0.9335082252697442, 0.8277785356194700, 0.4973316912456622, 0.2970801680736908, 0.8277785356194700, 0.9094535634889274, 0.4903701964862991, 0.1877867890441471, 0.4973316912456622, 0.4903701964862991, 0.3568445046504489))

  expect_equal(c(res$Q_0),
               c(10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10))
  })

# Try with rounding
sims$res$tstart = round(sims$res$tstart, digits = 1)
sims$res$tstop = round(sims$res$tstop, digits = 1)

design_mat <- benssurvutils::get_design_matrix(survival::Surv(tstart, tstop, event) ~ x1 + x2 + x3, sims$res)
rist_sets <- benssurvutils::get_risk_sets(design_mat$Y, by = 1, max_T = 10, id = sims$res$id)

new_res <- ddhazard_fit(X = design_mat$X, Y = design_mat$Y,
                        a_0 = rep(0, ncol(design_mat$X)),
                        Q_0 = diag(10, ncol(design_mat$X)), # something large
                        Q = diag(1, ncol(design_mat$X)), # something large
                        F_= diag(1, ncol(design_mat$X)), # first order random walk
                        risk_sets = rist_sets,
                        eps = 10^-4, n_max = 10^4,
                        order_ = 1,
                        est_Q_0 = F)

par(mfcol = c(2, 2))
plot(new_res$a_t_d_s[, 1], type = "l")
for(i in 1:3){
  plot(new_res$a_t_d_s[, i + 1], type = "l", ylim = range(sims$betas[, i ], res$a_t_d_s[, i + 1]))
  lines(x = seq_len(nrow(sims$betas)), sims$betas[, i], col = "red")
}

test_that("Testing versus previously computed values after rounding", {
  expect_equal(c(new_res$V_t_d_s),
               c( 0.4963704378487712177, 0.7222497275147484741, 0.5987448061039457592, 0.4328160309586401855, 0.7222497275147479190, 1.8689546693617327122,  0.9154821059932829463, 0.4736184502388984252, 0.5987448061039465363, 0.9154821059932830574, 1.4586101012895831275, 0.3783137508208931354,  0.4328160309586399079, 0.4736184502388984252, 0.3783137508208925248, 0.8796053400354324481, 0.3380119887946000379, 0.3225637936742083989,  0.2732058405380607402, 0.2588683646211653588, 0.3225637936742077327, 0.7649551177810591795, 0.0386917393384815372, 0.0223946813598421279,  0.2732058405380615174, 0.0386917393384818425, 0.6662634661834245797, -0.0032234203847561760, 0.2588683646211650258, 0.0223946813598421002, -0.0032234203847570086, 0.6388933023471987660, 0.3092785338876052892, 0.2850673822233550370, 0.2550827819376689787, 0.2451511717501281273,  0.2850673822233545929, 0.6891131691845362450, 0.0278011150352585716, 0.0177084870797616298, 0.2550827819376693117, 0.0278011150352591892,  0.6326367350763510977, -0.0009055695184024409, 0.2451511717501282384, 0.0177084870797620843, -0.0009055695184024271, 0.6085870818222889334,  0.2849240542676497734, 0.2496011354388463499, 0.2336315972234775107, 0.2314490894484185213, 0.2496011354388464332, 0.6200669250479571293,  0.0030602313143437525, 0.0060007793566062553, 0.2336315972234778437, 0.0030602313143439780, 0.5941769699861969567, -0.0072287327680845975,  0.2314490894484188543, 0.0060007793566065979, -0.0072287327680844345, 0.5845085953853619287, 0.2969373066969150932, 0.2671249774119172637,  0.2442519540936369249, 0.2382660267610784977, 0.2671249774119168752, 0.6540144381895983683, 0.0166206735577678275, 0.0127429859232190655,  0.2442519540936367861, 0.0166206735577680634, 0.6120971350075282702, -0.0030590506035563184, 0.2382660267610785532, 0.0127429859232193361, -0.0030590506035563124, 0.5954069942590105580, 0.3218354695613401262, 0.3023238075618699394, 0.2655553256497076298, 0.2525233234511964908,  0.3023238075618698284, 0.7232247749831501871, 0.0411218366980273392, 0.0247472324810154715, 0.2655553256497076853, 0.0411218366980273600,  0.6498702897264669875, 0.0036622234819037882, 0.2525233234511964353, 0.0247472324810155200, 0.0036622234819036160, 0.6201443968344328983,  0.3499960454512289765, 0.3402882385048844327, 0.2868365355311346954, 0.2679506060044467008, 0.3402882385048843772, 0.7987100106909230668,  0.0605993275124909261, 0.0346017087782625118, 0.2868365355311347509, 0.0605993275124909400, 0.6873831223353028541, 0.0068055350931056895,  0.2679506060044467008, 0.0346017087782626714, 0.0068055350931056028, 0.6493056067110920537, 0.3796847299742963644, 0.3770265922534385417,  0.3050804565916046540, 0.2830395781486451101, 0.3770265922534385972, 0.8695873630783913510, 0.0675426963169331596, 0.0390263170902923548,  0.3050804565916046540, 0.0675426963169330069, 0.7184330695683081025, 0.0042611815641696825, 0.2830395781486451101, 0.0390263170902923270,  0.0042611815641696010, 0.6810975026664320975, 0.4241211472478872424, 0.4388373273093688631, 0.3397756480755949604, 0.3078010571932185413,  0.4388373273093689186, 0.9931001476205258971, 0.1030593469501426829, 0.0579704376999328336, 0.3397756480755949604, 0.1030593469501426829,  0.7807438538357377444, 0.0121925281639706212, 0.3078010571932185413, 0.0579704376999329030, 0.0121925281639705257, 0.7266547135148472281,  0.4789041523901632624, 0.5185972947716029902, 0.3861852768721514839, 0.3393426310925435341, 0.5185972947716029902, 1.1539192934317978878,  0.1592889179147633227, 0.0873805018203109435, 0.3861852768721514284, 0.1592889179147632950, 0.8641408676931339183, 0.0276634653813646637,  0.3393426310925435341, 0.0873805018203109435, 0.0276634653813646637, 0.7811910256821694709, 0.5414348785651993401, 0.6135367789714712972,  0.4433243402571632186, 0.3768696378513813339, 0.6135367789714712972, 1.3494198105944745780, 0.2387712297717812515, 0.1288188927526861538,  0.4433243402571632186, 0.2387712297717812515, 0.9694697036129749090, 0.0526275857300152541, 0.3768696378513813339, 0.1288188927526861538,  0.0526275857300152541, 0.8435734991459187260))

  expect_equal(c(new_res$a_t_d_s),
               c(-0.25908191968719940, -0.25911788478664688, -1.18321078597077101, -0.52156113971237816, 0.04719862128689728, 0.22920676147944533, -0.07159204442975087,  0.30896403365102021, 0.78750648196873607, 1.22441123579259759, 1.50296431682128451, 2.46466093255389174, 2.46457638796452017, 0.22987731134918937,  1.90022001624062709, 3.29035526828136371, 3.72640183123446045, 3.00726161388978230, 3.99502922479397071, 5.21088874873351138, 6.31710609424437575,  7.01784967670489479, 2.92826447543937896, 2.92819185051785569, 1.03314264925403654, 2.42060128385687623, 3.54870545524503189, 3.87184264465336891,  3.28383434616787895, 4.16551538198451166, 5.22885987911908767, 6.20014653311724651, 6.81301793522784216, 3.08899770259557860, 3.08896029080209544,  2.10015868099737579, 2.82639237662643916, 3.42153831329944458, 3.61349012269077452, 3.34165839421176347, 3.80751646867399751, 4.35778761104016787,  4.85825907345722019, 5.16634206032578192))

  expect_equal(c(new_res$B_s),
               c( 0.97605862600136017, -0.05396809370453157, -0.04365521102115904, -0.02351319876725211, -0.05396809370453157, 0.86830033803998030, -0.10355747703891277, -0.05389152793787469, -0.04365521102115904, -0.10355747703891277, 0.90758198280741953, -0.04500595802272022, -0.02351319876725211, -0.05389152793787469, -0.04500595802272022, 0.97148195197616571, 1.71206351514346422, 1.83911769130292124, 1.59457011927878445, 0.83047394707728550, -0.30635873937867891,  0.22315540469996631, -0.64616858568656865, -0.33677197263861824, -0.29549585216412200, -0.74213107273948908, 0.34514181759917761, -0.33229792390309654, -0.29316454337097686, -0.73873298585353586, -0.63703589692132601, 0.65268636523815737, 1.67703537717804640, 1.79318586382217537, 1.57477366509216488,  0.82144867387329823, -0.30363431774364619, 0.21993648881083275, -0.64117152032718616, -0.33456018737130955, -0.28681731829431129, -0.72522564233163422,  0.34444115093163136, -0.32769732727527900, -0.28333950281429721, -0.72080195088914301, -0.62802702869954752, 0.64753632603061018, 1.58086743850915279,  1.65130517395387177, 1.49921095954240657, 0.78621665545881525, -0.29585068651947877, 0.21554603441441850, -0.62523111702918721, -0.32734629324923370, -0.26698324706709087, -0.68602532147676076, 0.34071673043028267, -0.31671085408274957, -0.25759540620153087, -0.67134324206733342, -0.60025826638309954,  0.63593767901614839, 1.55934764599092945, 1.62270039815613165, 1.47948618758442896, 0.77639833339207653, -0.29206978087277857, 0.21642217280937803, -0.61729377791272355, -0.32341851563987495, -0.26174729468900765, -0.67412791622096302, 0.34076997305950746, -0.31204402981956858, -0.25227424289200728, -0.65964951392521620, -0.59159817996292496, 0.63157535173678059, 1.56175982023745474, 1.62764660833244434, 1.47600186275334933, 0.77424046004027369, -0.28987115022913390, 0.21961137248098045, -0.61232392527702084, -0.32087898090400585, -0.26124614309256311, -0.67114210361817872, 0.34282068167628094, -0.30959756646065312, -0.25327051970876779, -0.65980286022875612, -0.58904058747485621, 0.63062792935135215, 1.56808342534014655, 1.63835199851336388,  1.47708456604967298, 0.77444315727999058, -0.28856381631956995, 0.22199580302108093, -0.60913838911103735, -0.31921022982737357, -0.26275208192286159, -0.67289006083433789, 0.34228563664039041, -0.30927600207539591, -0.25560802253586223, -0.66304669183710430, -0.58917477162805287, 0.62970138609533155,  1.57060965450379886, 1.64769238530201689, 1.48223924731617918, 0.77697933921866147, -0.28915470864577220, 0.21822025706782758, -0.60997914083464022, -0.31971391708141911, -0.26481111814989061, -0.67719566631438144, 0.33654721167463664, -0.31075277866464596, -0.25720255526174718, -0.66603245586788262, -0.59067356108251612, 0.62640133466963810, 1.57322072954042103, 1.64632735900054161, 1.47338831306837315, 0.77188296508831744, -0.28635927209306156,  0.22562195372194674, -0.60386703998006885, -0.31638186336932994, -0.26436406810361873, -0.67427149558360744, 0.34156298187919876, -0.30836647870727318, -0.25731851333283573, -0.66382652164898448, -0.58638190220366904, 0.62920217977925053, 1.57369810551359590, 1.63513108978260013, 1.45501030417597499,  0.76182789836770382, -0.28114475966488200, 0.24051622862927177, -0.59286325886146385, -0.31049413129232345, -0.26176812908363212, -0.66583986293035236,  0.35329662450886751, -0.30335660317291724, -0.25577306476482298, -0.65727741333560741, -0.57800063935535451, 0.63574677329487361))

  expect_equal(c(new_res$lag_one_cor),
               c( 0.2944976823793490350, 0.2713423371355212499, 0.2355667186292050852, 0.2365803959131896894, 0.2195970691396189611, 0.6415889318077017123, -0.0499711966072646785, -0.0286224497342483786, 0.1881462023630368074, -0.0591903811081742059, 0.5889001133043803016, -0.0452996131956121539,  0.2138588547994452194, -0.0287944367320474848, -0.0416264205030175694, 0.6135246786832206922, 0.2949260746860484783, 0.2635310079544535000,  0.2415247594738948456, 0.2361406651626286601, 0.2620078345704949796, 0.6443378791539819961, 0.0065008213027409195, 0.0059023007818734818,  0.2408343598939512442, 0.0075910331889974328, 0.6077094477521136628, -0.0085363023049840336, 0.2360884084997798560, 0.0069868679980421497, -0.0083379581328883456, 0.5951453483440500847, 0.2694519902332394024, 0.2277383513940764437, 0.2225072029479207569, 0.2227852194148052523,  0.2295536033359695804, 0.5774118382979549491, -0.0060839560216533334, 0.0002785522349768588, 0.2237698100274102819, -0.0072185402045897816,  0.5751535924373012421, -0.0089446673939263532, 0.2238551269596216753, 0.0004677080720577121, -0.0084985378993039165, 0.5689753105274992784,  0.2638019977279950634, 0.2210785822409404577, 0.2185810400944203091, 0.2203395909975426059, 0.2203905282540238042, 0.5621179554902109299, -0.0109434250508686857, -0.0014272528513407101, 0.2183563915217654750, -0.0104196251257038693, 0.5661813991301066773, -0.0091965126023806631,  0.2201797840165827802, -0.0012312985686978649, -0.0092089333943194684, 0.5627679259910493004, 0.2803402153143456643, 0.2431891972513487710,  0.2310569512078821108, 0.2291386959294268166, 0.2420769740315161789, 0.6030569621726338259, -0.0006950782545839260, 0.0035787903126566073,  0.2306294691834653576, 0.0002144133251409559, 0.5867908987839436374, -0.0072998642263230468, 0.2287179579842715249, 0.0036173355586263493, -0.0075980251099745698, 0.5785801148598344046, 0.3051710900783041192, 0.2753305753460808525, 0.2491039484525302550, 0.2422165648862806553,  0.2750983913129729785, 0.6657737323547480157, 0.0143547494539511405, 0.0107466462095638232, 0.2487278993807452432, 0.0135897169025149187,  0.6179052568405116741, -0.0058261383999780592, 0.2419629985179477250, 0.0102350676898223594, -0.0058849806269357001, 0.6037185125837923882,  0.3340733876194436625, 0.3125552782976543931, 0.2690422522181790677, 0.2573544680755648906, 0.3128014943202754861, 0.7394219363997542871,  0.0285715366446450680, 0.0179153844361984796, 0.2688299630460521117, 0.0273266882210543363, 0.6528855245298971210, -0.0055259598061465978,  0.2575698466420932031, 0.0180900733396980387, -0.0048036831647465424, 0.6343106251857564271, 0.3700933013163602570, 0.3598811535797188932,  0.2939692154704482974, 0.2765467209457639908, 0.3594842887052225322, 0.8313819559849342511, 0.0454984114344715376, 0.0275794312980711040,  0.2935079945867410389, 0.0451342658962961898, 0.6963201119636267533, -0.0042383163971776716, 0.2764517341381891868, 0.0277463794619276193, -0.0039317550708077289, 0.6720097267005988861, 0.4155041439841274942, 0.4208376383305464374, 0.3263747074484928956, 0.3005105051516340220,  0.4197815806058402543, 0.9487209686120857688, 0.0706971665687609468, 0.0411560096830747291, 0.3253701850836282494, 0.0704502181151598350,  0.7517487223407609553, -0.0014102021077567802, 0.3000117078996875075, 0.0410779208423944636, -0.0013724518378064243, 0.7172838010552367027,  0.4671211069711272423, 0.4906882572983861102, 0.3632924049703193381, 0.3273226745833941465, 0.4899916365559996989, 1.0841172741829625537,  0.1022192693142251751, 0.0577109439610708208, 0.3628440144840013315, 0.1025805760492784491, 0.8155743894117545301, 0.0029843443894451809,  0.3270889166902027911, 0.0578858692639162564, 0.0029625665148570457, 0.7674464984424655967))
#
#   expect_equal(c(new_res$n_iter),
#                c(119))
#
#   expect_equal(c(new_res$conv_values),
#                c(1.458563047220125e+10, 1.032001467706611e+00, 6.479427357819588e-01, 1.969045953435621e-01, 2.555991301149089e-02, 5.610093527739116e-03, 4.267394300473958e-03, 3.565513497314200e-03, 3.243127894728119e-03, 3.016428293839445e-03, 2.817895656575289e-03, 2.636138514416743e-03, 2.468994218762148e-03, 2.315375504817634e-03, 2.174231930095456e-03, 2.044506256177079e-03, 1.925177185918672e-03, 1.815287532608093e-03, 1.713956852258063e-03, 1.620384612716977e-03, 1.533848077620738e-03, 1.453697483334864e-03, 1.379349977060849e-03, 1.310283213626303e-03, 1.246029076650210e-03, 1.186167808659916e-03, 1.130322619368655e-03, 1.078154859374887e-03, 1.029359704547394e-03, 9.836623485219523e-04, 9.408146404115129e-04, 9.005921261166375e-04, 8.627914553700466e-04, 8.272280950845930e-04, 7.937343183878747e-04, 7.621574400669115e-04, 7.323582514147353e-04, 7.042096501730093e-04, 6.775954190470765e-04, 6.524091416505457e-04, 6.285532532714438e-04, 6.059381846538445e-04, 5.844815970316683e-04, 5.641077167768283e-04, 5.447467246787450e-04, 5.263342082087419e-04, 5.088106828012369e-04, 4.921211537918380e-04, 4.762147240413558e-04, 4.610442351594582e-04, 4.465659539004844e-04, 4.327392863377210e-04, 4.195265065869561e-04, 4.068925300092833e-04, 3.948046942550117e-04, 3.832325679749180e-04, 3.721477720399319e-04, 3.615238158432291e-04, 3.513359578947062e-04, 3.415610651734489e-04, 3.321774952675311e-04, 3.231649777937211e-04, 3.145045263472223e-04, 3.061783279290903e-04, 2.981696693742643e-04, 2.904628540981291e-04, 2.830431299452322e-04, 2.758966238581046e-04, 2.690102775079081e-04, 2.623717956284514e-04, 2.559695925095079e-04, 2.497927430643010e-04, 2.438309365297107e-04, 2.380744434317712e-04, 2.325140682713701e-04, 2.271411194892076e-04, 2.219473789097232e-04, 2.169250684937566e-04, 2.120668225837453e-04, 2.073656630681226e-04, 2.028149776034473e-04, 1.984084916073729e-04, 1.941402543739114e-04, 1.900046136708626e-04, 1.859962045986304e-04, 1.821099232283412e-04, 1.783409192296501e-04, 1.746845838639096e-04, 1.711365205904325e-04, 1.676925534449354e-04, 1.643486970958494e-04, 1.611011582728096e-04, 1.579463172091770e-04, 1.548807242610899e-04, 1.519010862165232e-04, 1.490042582191838e-04, 1.461872386093886e-04, 1.434471578317251e-04, 1.407812763345432e-04, 1.381869709187147e-04, 1.356617349249027e-04, 1.332031687427572e-04, 1.308089755292764e-04, 1.284769570908056e-04, 1.262050048206524e-04, 1.239910983047288e-04, 1.218333089510460e-04, 1.197297717078547e-04, 1.176787143605657e-04, 1.156784228091597e-04, 1.137272581467989e-04, 1.118236499786679e-04, 1.099660797693040e-04, 1.081530995477682e-04, 1.063833090230436e-04, 1.046553668163508e-04, 1.029679820459584e-04, 1.013199108576759e-04))

  expect_equal(c(new_res$Q),
               c(0.3196356074778138, 0.7314523839675096, 0.5955225102364341, 0.3178292905627517, 0.7314523839675096, 1.7748355708222099, 1.4151688559403888, 0.7364664682716771, 0.5955225102364341, 1.4151688559403888, 1.2387347365992625, 0.6138353203121031, 0.3178292905627517, 0.7364664682716771, 0.6138353203121031, 0.3702521757328231))

  expect_equal(c(new_res$Q_0),
               c(10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10, 0, 0, 0, 0, 10))
})
