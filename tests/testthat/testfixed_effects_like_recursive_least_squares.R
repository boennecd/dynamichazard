# Had issues with win builder. Thus, these lines
test_name <- "fixed_effects_like_recursive_least_squares"
cat("\nRunning", test_name, "\n")

if(interactive()){
  library(testthat); library(survival); source("R/test_utils.R")
}



test_that("Works with EKF and logit model and that it work with one fixed and one non-fixed", {
          fit <- ddhazard(survival::Surv(start, stop, event) ~ ddFixed(group),
                          Q_0 = matrix(1), Q = matrix(.1),
                          data = head_neck_cancer,
                          by = 1,
                          control = list(fixed_terms_method = "E_step",
                                         save_risk_set = F, save_data = F))

          # plot(fit)
          # fit$fixed_effects

          # get_expect_equal(fit, file = "tmp.txt")

          expect_equal(c(fit$state_vecs),
                       c(-3.433679924186530, -3.434414048040867, -3.114287156755919, -2.782053525173589, -2.510930729466274, -2.122083757242843, -2.175409321118311, -2.516412833923826, -2.723582723248391, -2.864371716814146, -3.001004060351022, -3.194760615043944, -3.310327753213099, -3.365300219640627, -3.259345670496772, -3.303169375967643, -3.409970477434536, -3.501541168815749, -3.481592382506457, -3.559349423552475, -3.549082380633693, -3.662725980727870, -3.817681114456823, -3.925737344100360, -3.985805504969861, -4.105172876430405, -4.188500503575386, -4.236902139433206, -4.357905632176490, -4.455198946844585, -4.528631703948904, -4.578364620402361, -4.604506253664232, -4.607028261948091, -4.585758667118196, -4.540396914300307, -4.470533272124009, -4.375667125914672, -4.363530815624264, -4.434586557795067, -4.488525485257088, -4.524334065547548, -4.541699556818766, -4.543437100737172, -4.529475020434802, -4.499685844290741, -4.455040443521825, -4.397239273626069, -4.326037828250640, -4.245166771764445, -4.154369910409113, -4.053389638287614, -3.941968181653694, -3.926179927504561, -3.896034871508889, -3.851547073271464, -3.794756706956309, -3.725578499031569, -3.643902883962222, -3.549597815575200 ))

          expect_equal(c(fit$state_vars),
                       c(0.20954649115761625, 0.13742523801660356, 0.12776362434720762, 0.11460004590035977, 0.10061020013431873, 0.08957555787920109, 0.07538528439013892, 0.07710455357325803, 0.08762172775839716, 0.09768212004241301, 0.10629430389449669, 0.11515636902799065, 0.12700264486442819, 0.13767049444951657, 0.14657250276740741, 0.14702590952815880, 0.14979237469721232, 0.15742861871796365, 0.16778261594924057, 0.17472893801293135, 0.18291430862661828, 0.18675540087292891, 0.19481451785127085, 0.20724975299225715, 0.21992102176975756, 0.23034744527981668, 0.24377502364737655, 0.25641598093139284, 0.26662401892078791, 0.28069695282630391, 0.29644093159168150, 0.31266024914022339, 0.32856955037350843, 0.34354594811792738, 0.35700993771317346, 0.36836106135340474, 0.37693864215213219, 0.38199456280700167, 0.38213351716622618, 0.38312869383452752, 0.39414645444278096, 0.41192623623832847, 0.43507778614628223, 0.46024073964185813, 0.48756156155306862, 0.51730156485164358, 0.54883115567863761, 0.58105035340582800, 0.61442181329923451, 0.64636040962164110, 0.67723439573204902, 0.70734959389420859, 0.73696351908628621, 0.76629659855737298, 0.80721931948152237, 0.85944072911634239, 0.92085892375999800, 0.99225996838538788, 1.07465395887804971, 1.16925528963455649 ))

          expect_equal(c(fit$lag_one_cov),
                       c(0.12400565075048453, 0.09060644253579703, 0.08046058786272703, 0.06874744023704357, 0.05843647620670341, 0.04807648886209226, 0.04342823006931706, 0.04768242878265085, 0.05575000709415941, 0.06345688496908417, 0.07085972054588337, 0.07984334137531771, 0.08996836418036058, 0.09892406205862624, 0.10328519339287737, 0.10473852176182261, 0.10951529927043624, 0.11789221446697731, 0.12609019808230282, 0.13324450232606039, 0.13900060424798649, 0.14464939850082592, 0.15442538525099650, 0.16652662379702615, 0.17773775309844728, 0.18928370466383404, 0.20199189179921098, 0.21317521681003060, 0.22500822881876187, 0.23960254533946118, 0.25529734946804794, 0.27111200429101201, 0.28634436266228852, 0.30039263485454692, 0.31266561844604113, 0.32253161746980874, 0.32928545010404198, 0.33185789860815612, 0.33241004470018287, 0.33830408677338741, 0.35249324068786536, 0.37270642279330546, 0.39664409554970748, 0.42266969749819938, 0.45098518109429891, 0.48142126670783247, 0.51312569653061635, 0.54575435362485369, 0.57829173658389010, 0.60958468021061640, 0.63996828926087712, 0.66972252053356240, 0.69908479325619699, 0.73395440627381414, 0.78021944090475692, 0.83673329552832865, 0.90280466957766392, 0.97932928634140426, 1.06741628403776900 ))

          expect_equal(unname(c(fit$fixed_effects)),
                       c(0.4970703129092376  ))

          expect_equal(c(fit$n_iter),
                       c(7 ))

          expect_equal(c(fit$Q),
                       c(0.1102804882254061 ))

          expect_equal(c(fit$Q_0),
                       c(1e+00, 0e+00, 0e+00, 1e+05 ))

          expect_equal(c(fit$n_risk),
                       c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18, 18, 18, 18, 18, 18, 18, 17, 15, 14, 14, 14, 12, 12, 12, 11, 10, 10, 8, 8, 8, 8, 8, 7, 7, 6, 6, 6, 6, 6 ))

          expect_equal(c(fit$times),
                       c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59 ))

          expect_equal(c(fit$risk_set),
                       c(NULL ))

          expect_equal(c(fit$data),
                       c(NULL ))

          expect_equal(c(fit$order),
                       c(1 ))

          expect_equal(c(fit$F_),
                       c(1, 0, 0, 1 ))

          expect_equal(c(fit$method),
                       c("EKF" ))

          expect_equal(c(fit$model),
                       c("logit" ))

          expect_equal(c(fit$est_Q_0),
                       c(FALSE ))

          expect_equal(c(fit$LR),
                       c(1 ))

          expect_true(F)
})

test_that("Works with EKF and continous time model and that it work with one fixed and one non-fixed", {
  fit <- ddhazard(survival::Surv(start, stop, event) ~ ddFixed(group),
                  Q_0 = matrix(1), Q = matrix(.1),
                  data = head_neck_cancer, max_T = 35,
                  by = 1, model = "exponential",
                  control = list(fixed_terms_method = "E_step",
                                 save_risk_set = F, save_data = F))

  # plot(fit)
  # fit$fixed_effects

  # get_expect_equal(fit)

  expect_equal(unname(c(fit$state_vecs)),
               c(-3.615978107132461, -3.616949721022332, -3.305226147013428, -3.002094644915326, -2.787892923820140, -2.427770440674762, -2.833857991084687, -3.306200306429949, -3.316153069349873, -3.354863630395729, -3.457547178648584, -3.669969954646172, -3.739226613732701, -3.753362132936290, -3.646553697720601, -3.686928216108025, -3.804325204864142, -3.888177475024066, -3.873448236383301, -3.943249303930732, -3.940532062015030, -4.056457197382064, -4.198236828220201, -4.291170277256343, -4.350468501311073, -4.441913885860831, -4.508710411566168, -4.556363373888356, -4.637199388779525, -4.702834682086189, -4.755770433319817, -4.797693791905377, -4.829811963264542, -4.853020903112506, -4.868002552637793, -4.875285600284079 ))

  expect_equal(unname(c(fit$state_vars)),
               c(0.3222599561306345, 0.2444618834213499, 0.2433567948914435, 0.2214454134828208, 0.1852327710271381, 0.1564741123847505, 0.1082493037073646, 0.1434296592761057, 0.1809660666349786, 0.1983749797972821, 0.2083287136461371, 0.2218327354564468, 0.2521399911673196, 0.2760686115224757, 0.2924375674355669, 0.2897884772674942, 0.2921989352316637, 0.3109468875738706, 0.3346388267928059, 0.3495887885255296, 0.3674791135830306, 0.3766856604476506, 0.3991800846084057, 0.4344865571481786, 0.4722344879164628, 0.5091564359438742, 0.5534041468672630, 0.6008099587138918, 0.6505629577274422, 0.7119329308321775, 0.7839181475695730, 0.8669932657923654, 0.9624144020146725, 1.0719498340333053, 1.1977622739939440, 1.3423551694705591 ))

  expect_equal(unname(c(fit$lag_one_cov)),
               c(NULL ))

  expect_equal(unname(c(fit$fixed_effects)),
               c(0.3142509016796373))

  expect_equal(unname(c(fit$n_iter)),
               c(9 ))

  expect_equal(unname(c(fit$Q)),
               c(0.1688658474128137 ))

  expect_equal(unname(c(fit$Q_0)),
               c(1e+00, 0e+00, 0e+00, 1e+05 ))

  expect_equal(unname(c(fit$n_risk)),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18, 18, 18, 18, 18, 18 ))

  expect_equal(unname(c(fit$times)),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35 ))

  expect_equal(unname(c(fit$risk_set)),
               c(NULL ))

  expect_equal(unname(c(fit$data)),
               c(NULL ))

  expect_equal(unname(c(fit$order)),
               c(1 ))

  expect_equal(unname(c(fit$F_)),
               c(1, 0, 0, 1 ))

  expect_equal(unname(c(fit$method)),
               c("EKF" ))

  expect_equal(unname(c(fit$model)),
               c("exponential" ))

  expect_equal(unname(c(fit$est_Q_0)),
               c(FALSE ))

  expect_equal(unname(c(fit$LR)),
               c(0.6666666666666666 ))
})

set.seed(8492741)
sims_logit <- test_sim_func_logit(n_series = 4e2, n_vars = 3, x_range = 1, t_max = 10, x_mean = 0.5,
                                  beta_start = 1, intercept_start = -4)
# sum(sims_logit$res$event)
form <- formula(survival::Surv(tstart, tstop, event) ~ ddFixed(1) + ddFixed(x1) + x2 + x3)

test_that("Works with UKF and logit model", {

  # tmp <- file("tmp.txt")
  # sink(tmp)
  # fit <- ddhazard(form, Q_0 = diag(1, 2), Q = diag(.1, 2),
  #                 data = sims_logit$res, id = sims_logit$res$id,
  #                 by = 1,
  #                 control = list(fixed_terms_method = "E_step",
  #                                save_risk_set = F, save_data = F,
  #                                method = "UKF", debug = T))
  # sink()
  # close(tmp)
  #
  # matplot(sims_logit$betas, lty = 1, type = "l")
  # matplot(fit$state_vecs, lty = 2, type = "l", add = T, col = 3:4)
  # abline(h = fit$fixed_effects, col = 1:2, lty = 2)
  # # get_expect_equal(fit)

  expect_true(F)
})

test_that("Works with UKF and continous time model",
          expect_true(F))

test_that("Works with second order random walk and logit model",
          expect_true(F))

test_that("Works with second order random walk and continous time model",
          expect_true(F))

test_that("Works when only one is time varying",
          expect_true(F))

test_that("Works when one is fixed",
          expect_true(F))

# Had issues with win builder. Thus, these lines
cat("\nFinished", test_name, "\n")
