context("Testing print function")

test_that("Print yields the expected results for object returned by ddhazard", {
  result <-  ddhazard(
    formula = survival::Surv(stop, event) ~ group,
    data = head_neck_cancer,
    by = 1,
    control = list(est_Q_0 = F, n_max = 10^4, eps = 1e-1,
                   save_data = F, save_risk_set = F),
    a_0 = rep(0, 2), Q_0 = diag(1, 2),
    max_T = 20, order = 1)

  # print(paste0(capture.output(print(result, digits = 4)), collapse = "\n"), max.print = 1e8)
  expect_that(print(result, digits = 4),
              prints_text("Formula:\nsurvival::Surv(stop, event) ~ group\n\nEstimated with EKF in 2 iterations of the EM algorithm\n\nEstimated time-varying effects and point-wise standard deviation:\n    (Intercept)    sd   group1    sd \nt0       -1.802 0.6527 0.04366 0.7072\nt1       -2.337 0.2933 0.08239 0.3937\nt2       -2.803 0.3769 0.04722 0.4965\nt3       -2.786 0.4343 0.47588 0.5711\nt4       -2.434 0.4577 0.03763 0.5565\nt5       -1.785 0.4261 0.80028 0.5652\nt6       -1.973 0.3738 0.66434 0.4719\nt7       -2.450 0.4073 0.19786 0.5188\nt8       -2.878 0.4576 0.70849 0.6143\nt9       -3.016 0.5184 0.74029 0.6516\nt10      -3.094 0.5524 0.72503 0.6899\nt11      -3.389 0.5742 0.40016 0.7260\nt12      -3.600 0.6127 0.44614 0.8121\nt13      -3.734 0.6424 0.99283 0.8730\nt14      -3.113 0.6846 2.14297 0.8807\nt15      -3.279 0.6211 1.62011 0.7171\nt16      -3.576 0.6459 1.14035 0.7634\nt17      -3.895 0.6823 1.04613 0.8475\nt18      -3.689 0.7507 1.36408 0.9465\nt19      -3.951 0.7803 1.55400 1.0122\nt20      -3.613 0.9415 2.34599 1.2115",
                          fixed = T))

  result <-  ddhazard(
    formula = survival::Surv(stop, event) ~ ddFixed(1) + group,
    data = head_neck_cancer,
    by = 1,
    control = list(est_Q_0 = F, n_max = 10^4, eps = 1e-1,
                   save_data = F, save_risk_set = F,
                   fixed_terms_method = "E_step"),
    a_0 = rep(0, 1), Q_0 = diag(1, 1),
    max_T = 20, order = 1)

  # print(paste0(capture.output(print(result, digits = 4)), collapse = "\n"), max.print = 1e8)
  expect_that(print(result, digits = 4),
              prints_text("Formula:\nsurvival::Surv(stop, event) ~ ddFixed(1) + group\n\nEstimated with EKF in 2 iterations of the EM algorithm\n\nEstimated time-varying effects and point-wise standard deviation:\n      group1    sd \nt0  -0.30363 0.7490\nt1  -0.40003 0.5721\nt2   0.14752 0.6353\nt3   0.89512 0.5788\nt4   0.61924 0.4402\nt5   1.71482 0.5019\nt6   1.52557 0.4088\nt7   0.66129 0.4474\nt8   0.84395 0.5513\nt9   0.69078 0.5495\nt10  0.53181 0.5825\nt11 -0.01786 0.6187\nt12 -0.14110 0.7235\nt13  0.31465 0.7936\nt14  1.52097 0.7866\nt15  1.02346 0.5449\nt16  0.38831 0.6161\nt17  0.16822 0.7148\nt18  0.49660 0.8016\nt19  0.65475 0.8562\nt20  1.53209 1.0514\n\nFixed effects are estimated in the E_step. The estimates are:\n(Intercept) \n     -2.926 ",
                          fixed = T))

  suppressWarnings(result <-  ddhazard(
    formula = survival::Surv(stop, event) ~ ddFixed(1) + ddFixed(as.numeric(group)),
    data = head_neck_cancer,
    by = 1,
    control = list(est_Q_0 = F, n_max = 10^4, eps = 1e-1,
                   save_data = F, save_risk_set = F,
                   fixed_terms_method = "E_step"),
    max_T = 20, order = 1))

  # print(paste0(capture.output(print(result, digits = 4)), collapse = "\n"), max.print = 1e8)
  expect_that(print(result, digits = 4),
              prints_text("Formula:\nsurvival::Surv(stop, event) ~ ddFixed(1) + ddFixed(as.numeric(group))\n\nEstimated with EKF in 3 iterations of the EM algorithm\n\nFixed effects are estimated in the E_step. The estimates are:\n      (Intercept) as.numeric(group) \n          -3.4628            0.5524 ",
                          fixed = T))
})

test_that("print.ddhazard_boot gives the expected output", {
  skip_on_cran()

  sims <- exp_sim_200
  result <- ddhazard(
    survival::Surv(tstart, tstop, event) ~ ddFixed(x1) + ddFixed(x2) + . - id - x1 - x2,
    sims$res,
    by = 1,
    control = list(fixed_terms_method = "E_step"),
    Q_0 = diag(1e5, 9),
    Q = diag(1e-2, 9),
    max_T = 10, model = "exp_clip_time_w_jump",
    id = sims$res$id, order = 1,
    verbose = F)

  set.seed(999)
  boot_out <- ddhazard_boot(result, R = 19)

  # plot(result, ddhazard_boot = boot_out) # needs bigger R
  # print(paste0(capture.output(print(boot_out, digits = 4)), collapse = "\n"), max.print = 1e8)
  expect_that(print(boot_out, digits = 4),
              prints_text("Bootstrap Statistics :\n                 original   bias    bias (truncated)  std. error\n(Intercept):t0  -2.955459 -0.17569          -0.17569      0.3463\n(Intercept):t1  -2.955459 -0.17569          -0.17569      0.3463\n(Intercept):t2  -2.907388  0.20228           0.20228      0.5020\n(Intercept):t3  -2.883626  0.15968           0.15968      0.3280\n(Intercept):t4  -2.755389  0.13102           0.13102      0.2472\n(Intercept):t5  -2.732601  0.01337           0.01337      0.1783\n(Intercept):t6  -2.771540 -0.12503          -0.12503      0.2301\n(Intercept):t7  -2.748779 -0.15173          -0.15173      0.2971\n(Intercept):t8  -2.699006 -0.12655          -0.12655      0.3038\n(Intercept):t9  -2.438868  0.32234           0.32234      0.6276\n(Intercept):t10 -2.334769  0.20809           0.20809      0.4818\nx3:t0            2.579935  0.01827           0.01827      0.4696\nx3:t1            2.579935  0.01827           0.01827      0.4696\nx3:t2            2.370267 -0.13968          -0.13968      0.6902\nx3:t3            2.064832  0.02039           0.02039      0.5237\nx3:t4            1.766160  0.20470           0.20470      0.4085\nx3:t5            1.660887  0.17874           0.17874      0.2559\nx3:t6            1.617659  0.10793           0.10793      0.4281\nx3:t7            1.591543  0.02773           0.02773      0.4465\nx3:t8            1.692212  0.08181           0.08181      0.4021\nx3:t9            1.616586 -0.07586          -0.07586      0.9258\nx3:t10           1.689807  0.40221           0.40221      0.6273\nx4:t0           -0.909969 -0.48664          -0.48664      0.6330\nx4:t1           -0.909969 -0.48664          -0.48664      0.6330\nx4:t2           -0.892410  0.63150           0.63150      1.0724\nx4:t3           -0.976605  0.54016           0.54016      0.7060\nx4:t4           -0.832337  0.67173           0.67173      0.5936\nx4:t5           -0.825588  0.28447           0.28447      0.3633\nx4:t6           -0.945788 -0.28873          -0.28873      0.3766\nx4:t7           -0.918452 -0.52779          -0.52779      0.5467\nx4:t8           -0.771533 -0.56690          -0.56690      0.7200\nx4:t9           -0.248787  0.27038           0.27038      1.2263\nx4:t10           0.009261  0.21232           0.21232      1.0919\nx5:t0            1.565322 -0.09997          -0.09997      0.4608\nx5:t1            1.565322 -0.09997          -0.09997      0.4608\nx5:t2            1.616546 -0.25633          -0.25633      0.7853\nx5:t3            1.726704 -0.19150          -0.19150      0.4808\nx5:t4            1.722680  0.19113           0.19113      0.5039\nx5:t5            1.730232  0.32102           0.32102      0.5958\nx5:t6            1.772548  0.24056           0.24056      0.6331\nx5:t7            1.739234 -0.05314          -0.05314      0.6622\nx5:t8            1.640895 -0.10396          -0.10396      0.7900\nx5:t9            1.404476 -0.40342          -0.40342      1.0786\nx5:t10           1.272458  0.48562           0.48562      2.0873\nx6:t0            0.717436  0.23186           0.23186      0.7938\nx6:t1            0.717437  0.23186           0.23186      0.7938\nx6:t2            0.769134 -0.46280          -0.46280      0.8787\nx6:t3            0.993987 -0.44638          -0.44638      0.5260\nx6:t4            0.856852 -0.34582          -0.34582      0.4627\nx6:t5            0.855117 -0.15016          -0.15016      0.3153\nx6:t6            1.011836  0.10924           0.10924      0.5180\nx6:t7            0.947743  0.07359           0.07359      0.5919\nx6:t8            0.690017  0.05647           0.05647      0.6133\nx6:t9           -0.077617 -0.40021          -0.40021      0.8115\nx6:t10          -0.485124 -0.52170          -0.52170      1.2411\nx7:t0            0.004240 -0.07844          -0.07844      0.5924\nx7:t1            0.004240 -0.07844          -0.07844      0.5924\nx7:t2            0.116837 -0.37421          -0.37421      0.6489\nx7:t3            0.286162 -0.26349          -0.26349      0.5412\nx7:t4            0.489391 -0.16072          -0.16072      0.4324\nx7:t5            0.567927  0.14952           0.14952      0.4097\nx7:t6            0.582318  0.31444           0.31444      0.4748\nx7:t7            0.602913  0.21364           0.21364      0.5482\nx7:t8            0.569594  0.11691           0.11691      0.6110\nx7:t9            0.704047 -0.03900          -0.03900      0.5005\nx7:t10           0.704654 -0.10056          -0.10056      1.0880\nx8:t0            0.571918 -0.37201          -0.37201      0.4701\nx8:t1            0.571918 -0.37201          -0.37201      0.4701\nx8:t2            1.186606 -0.09862          -0.09862      0.8536\nx8:t3            2.110816 -0.18979          -0.18979      0.5496\nx8:t4            2.977719  0.05218           0.05218      0.7250\nx8:t5            3.262139  0.02982           0.02982      0.7364\nx8:t6            3.377457  0.12275           0.12275      0.6074\nx8:t7            3.425351  0.01036           0.01036      0.4882\nx8:t8            3.128757 -0.26101          -0.26101      0.3880\nx8:t9            3.320727 -0.04135          -0.04135      0.8924\nx8:t10           3.111142 -0.51699          -0.51699      1.9059\nx9:t0           -1.221352 -0.14368          -0.14368      0.7751\nx9:t1           -1.221352 -0.14368          -0.14368      0.7751\nx9:t2           -1.404837 -0.17831          -0.17831      0.8481\nx9:t3           -1.987253 -0.04912          -0.04912      0.7877\nx9:t4           -1.635791 -0.21371          -0.21371      0.8311\nx9:t5           -1.573852  0.11002           0.11002      0.5604\nx9:t6           -1.943555  0.04130           0.04130      0.6339\nx9:t7           -1.773867 -0.11382          -0.11382      0.7149\nx9:t8           -1.124244 -0.26280          -0.26280      0.8829\nx9:t9            0.806387  0.61687           0.61687      1.6083\nx9:t10           1.806253 -0.58905          -0.58905      2.0568\nx10:t0           1.341384  0.27800           0.27800      0.7420\nx10:t1           1.341384  0.27800           0.27800      0.7420\nx10:t2           0.664602  0.11211           0.11211      0.5356\nx10:t3          -0.432739  0.22713           0.22713      0.5650\nx10:t4          -1.230083 -0.19644          -0.19644      0.7898\nx10:t5          -1.510221 -0.25489          -0.25489      0.7940\nx10:t6          -1.717965 -0.29200          -0.29200      0.7865\nx10:t7          -1.714250 -0.01627          -0.01627      0.5964\nx10:t8          -1.235233  0.16981           0.16981      0.7501\nx10:t9          -0.931232 -0.12893          -0.12893      0.8493\nx10:t10         -0.455945 -0.27137          -0.27137      0.5818\nx1              -1.913407  0.12096           0.12096      0.4160\nx2               0.199006 -0.01327          -0.01327      0.4145",
                          fixed = T))

  result <- ddhazard(
    survival::Surv(tstart, tstop, event) ~ . - id,
    sims$res,
    by = 1,
    control = list(fixed_terms_method = "E_step"),
    Q_0 = diag(1e5, 11),
    Q = diag(1e-2, 11),
    max_T = 10, model = "exp_clip_time_w_jump",
    id = sims$res$id, order = 1,
    verbose = F)

  set.seed(1992)
  suppressWarnings(boot_out <- ddhazard_boot(result, R = 19))

  # print(paste0(capture.output(print(boot_out, digits = 4)), collapse = "\n"), max.print = 1e8)
  expect_that(print(boot_out, digits = 4),
              prints_text("Bootstrap Statistics :\n                original     bias    bias (truncated)  std. error\n(Intercept):t0  -2.87755 -0.2122104        -0.2122104      0.2632\n(Intercept):t1  -2.87755 -0.2122105        -0.2122105      0.2632\n(Intercept):t2  -2.85040  0.1807806         0.1807806      0.4050\n(Intercept):t3  -2.81591  0.1399346         0.1399346      0.2742\n(Intercept):t4  -2.77409  0.3118805         0.3118805      0.3886\n(Intercept):t5  -2.76466 -0.0061070        -0.0061070      0.2681\n(Intercept):t6  -2.77707 -0.1990084        -0.1990084      0.2975\n(Intercept):t7  -2.77191 -0.2514378        -0.2514378      0.2812\n(Intercept):t8  -2.76913 -0.2323357        -0.2323357      0.2082\n(Intercept):t9  -2.71904  0.0218196         0.0218196      0.3197\n(Intercept):t10 -2.70100  0.3215317         0.3215317      0.4851\nx1:t0           -1.29114  0.1387279         0.1387279      0.4805\nx1:t1           -1.29114  0.1387279         0.1387279      0.4805\nx1:t2           -1.27635  0.4017945         0.4017945      0.5405\nx1:t3           -1.37415  0.3334116         0.3334116      0.4580\nx1:t4           -1.80183  0.0790873         0.0790873      0.5897\nx1:t5           -2.15679  0.1083838         0.1083838      0.4877\nx1:t6           -1.96682  0.0341752         0.0341752      0.5369\nx1:t7           -2.12544 -0.0780015        -0.0780015      0.4293\nx1:t8           -2.39037 -0.0876340        -0.0876340      0.4748\nx1:t9           -3.30494 -0.0607473        -0.0607473      0.6212\nx1:t10          -3.67092  0.2307452         0.2307452      0.9733\nx2:t0            0.14012 -0.0068580        -0.0068580      0.4580\nx2:t1            0.14012 -0.0068580        -0.0068580      0.4580\nx2:t2            0.04935 -0.4723473        -0.4723473      0.4586\nx2:t3           -0.03105 -0.4461245        -0.4461245      0.4203\nx2:t4            0.07957 -0.2952676        -0.2952676      0.4882\nx2:t5            0.22198  0.0268660         0.0268660      0.3666\nx2:t6            0.11815  0.1019726         0.1019726      0.4911\nx2:t7            0.18808  0.1400762         0.1400762      0.5080\nx2:t8            0.36251  0.1399117         0.1399117      0.4734\nx2:t9            0.80689  0.0514494         0.0514494      0.4704\nx2:t10           0.99835 -0.3657774        -0.3657774      0.6157\nx3:t0            2.53829 -0.0546279        -0.0546279      0.6861\nx3:t1            2.53829 -0.0546279        -0.0546279      0.6861\nx3:t2            2.35141 -0.0436293        -0.0436293      0.5280\nx3:t3            2.05590  0.0385077         0.0385077      0.4347\nx3:t4            1.81334  0.0907326         0.0907326      0.5937\nx3:t5            1.70277  0.0256303         0.0256303      0.3129\nx3:t6            1.65702 -0.1732745        -0.1732745      0.3076\nx3:t7            1.63232 -0.3512215        -0.3512215      0.4355\nx3:t8            1.74738 -0.1604517        -0.1604517      0.4031\nx3:t9            1.77181  0.1417191         0.1417191      0.5215\nx3:t10           1.84026  0.3353689         0.3353689      0.6093\nx4:t0           -0.93926 -0.7236673        -0.7236673      0.6422\nx4:t1           -0.93926 -0.7236674        -0.7236674      0.6422\nx4:t2           -0.95983  0.5269127         0.5269127      0.6759\nx4:t3           -0.98410  0.5068759         0.5068759      0.4222\nx4:t4           -0.86018  1.2013520         1.2013520      0.6221\nx4:t5           -0.76991  0.3016258         0.3016258      0.4961\nx4:t6           -0.90166 -0.5067294        -0.5067294      0.6024\nx4:t7           -0.86138 -0.8149955        -0.8149955      0.6011\nx4:t8           -0.72129 -0.8805661        -0.8805661      0.6333\nx4:t9           -0.30050 -0.2256127        -0.2256127      0.6586\nx4:t10          -0.10701  0.8242700         0.8242700      1.5067\nx5:t0            1.56177  0.0873355         0.0873355      0.5383\nx5:t1            1.56177  0.0873356         0.0873356      0.5383\nx5:t2            1.65106  0.1508188         0.1508188      0.4145\nx5:t3            1.75674  0.0163810         0.0163810      0.5043\nx5:t4            1.75026  0.0436802         0.0436802      0.8214\nx5:t5            1.70293  0.2208362         0.2208362      0.6916\nx5:t6            1.76501  0.1101369         0.1101369      0.6654\nx5:t7            1.71586 -0.1702513        -0.1702513      0.5677\nx5:t8            1.58842 -0.2695268        -0.2695268      0.4685\nx5:t9            1.32353 -0.3687366        -0.3687366      0.5765\nx5:t10           1.19779 -0.2273749        -0.2273749      0.6975\nx6:t0            0.65869  0.6316369         0.6316369      0.7908\nx6:t1            0.65869  0.6316370         0.6316370      0.7908\nx6:t2            0.77775 -0.2557612        -0.2557612      0.8239\nx6:t3            0.94063 -0.2779609        -0.2779609      0.6125\nx6:t4            0.88933 -0.8734115        -0.8734115      0.7710\nx6:t5            0.80636 -0.1191225        -0.1191225      0.4797\nx6:t6            0.95336  0.3357644         0.3357644      0.4867\nx6:t7            0.88878  0.3645763         0.3645763      0.6385\nx6:t8            0.66546  0.3625724         0.3625724      0.5205\nx6:t9            0.15049 -0.0918785        -0.0918785      0.8684\nx6:t10          -0.10677 -0.6549614        -0.6549614      0.9780\nx7:t0            0.06301  0.2199485         0.2199485      0.5366\nx7:t1            0.06301  0.2199486         0.2199486      0.5366\nx7:t2            0.13180 -0.3369627        -0.3369627      0.3692\nx7:t3            0.28207 -0.2544589        -0.2544589      0.3182\nx7:t4            0.46716 -0.3220037        -0.3220037      0.2683\nx7:t5            0.59242  0.0216206         0.0216206      0.3897\nx7:t6            0.58289  0.3466768         0.3466768      0.5332\nx7:t7            0.62108  0.3432650         0.3432650      0.5152\nx7:t8            0.61986  0.2790008         0.2790008      0.5443\nx7:t9            0.77728  0.0432911         0.0432911      0.7858\nx7:t10           0.81363 -0.4312429        -0.4312429      0.9624\nx8:t0            0.55543 -0.0771344        -0.0771344      0.7291\nx8:t1            0.55543 -0.0771345        -0.0771345      0.7291\nx8:t2            1.11942 -0.0773433        -0.0773433      0.6476\nx8:t3            2.06112 -0.0789819        -0.0789819      0.7109\nx8:t4            2.90638  0.3006071         0.3006071      0.9831\nx8:t5            3.30517  0.0251324         0.0251324      0.8119\nx8:t6            3.37534  0.3197307         0.3197307      0.6856\nx8:t7            3.46821  0.4028191         0.4028191      0.5465\nx8:t8            3.20235  0.2336725         0.2336725      0.5218\nx8:t9            3.38139 -0.0008814        -0.0008814      0.8962\nx8:t10           3.29486 -0.0407930        -0.0407930      0.8850\nx9:t0           -1.14809  0.2610743         0.2610743      0.6050\nx9:t1           -1.14809  0.2610744         0.2610744      0.6050\nx9:t2           -1.59068 -0.0426584        -0.0426584      0.8026\nx9:t3           -2.09635 -0.0667970        -0.0667970      0.6296\nx9:t4           -1.85951  0.2987762         0.2987762      0.7430\nx9:t5           -1.45945  0.2011906         0.2011906      0.8137\nx9:t6           -1.90706 -0.2544932        -0.2544932      0.6718\nx9:t7           -1.67056 -0.3393453        -0.3393453      0.6223\nx9:t8           -0.93948 -0.1344809        -0.1344809      0.5652\nx9:t9            0.78375  0.4009965         0.4009965      1.1703\nx9:t10           1.59124  0.1338497         0.1338497      1.2456\nx10:t0           1.39583  0.1295007         0.1295007      0.7038\nx10:t1           1.39583  0.1295008         0.1295008      0.7038\nx10:t2           0.70839  0.0237785         0.0237785      0.5836\nx10:t3          -0.38318  0.1059422         0.1059422      0.7184\nx10:t4          -1.20599 -0.2514702        -0.2514702      0.9488\nx10:t5          -1.53071 -0.0653858        -0.0653858      0.7182\nx10:t6          -1.69777 -0.2505584        -0.2505584      0.6619\nx10:t7          -1.72900 -0.2204811        -0.2204811      0.5095\nx10:t8          -1.27779 -0.0396296        -0.0396296      0.5591\nx10:t9          -1.06860  0.1830716         0.1830716      0.5813\nx10:t10         -0.79295  0.1567117         0.1567117      0.6703",
                          fixed = T))
})
