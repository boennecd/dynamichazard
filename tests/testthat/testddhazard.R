library(survival)

test_that("The head_neck_cancer must be defined for the ddhazard tests",
          expect_true(exists("head_neck_cancer")))

# Test on data set that is one of Farhmiers papers
result = ddhazard(
  formula = survival::Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 1, # Use by month intervals
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
  est_Q_0 = T,
  max_T = 45,
  id = head_neck_cancer$id, order_ = 1
)

test_that("Testing previous computed values vs. current on head and neck cancer set assuming that the previous is correct", {
  expect_equal(c(result$a_t_d_s),
               c(-3.5084644693000375, -3.5148844600373153, -3.1891314791814929, -2.8181185126716946, -2.5133150253138181, -2.0686431883814391, -2.1337664829927272, -2.5088816216986980, -2.7261252524003838, -2.8656346839715456, -3.0022690651419150, -3.2103909019454631, -3.3296886621454438, -3.3797024676574670, -3.2387762301797576, -3.2832268974011902, -3.4010378429506498, -3.4996364628495664, -3.4640927580381167, -3.5454306632739097, -3.5193437650355053, -3.6429455602328522, -3.8148529400485618, -3.9315760725295390, -3.9912270162929087, -4.1221212755199144, -4.2111505273306804, -4.2593181086540230, -4.3955501412991156, -4.5056360495292482, -4.5891834181979796, -4.6463491829253352, -4.6772452961075963, -4.6818100380470060, -4.6597979866888570, -4.6108005184078964, -4.5342715329240795, -4.4295511232451679, -4.4288880723551687, -4.5320293776581728, -4.6212298063525905, -4.6940739120459574, -4.7499759978712248, -4.7915369057959181, -4.8188789577153992, -4.8320508432930724, 0.4360755600018228, 0.4376620032308990,  0.4489331535887380, 0.4629877155198045, 0.4717967889720516, 0.4892432325019014, 0.4906015100905337, 0.4811672226212869, 0.4812410655726153, 0.4807008058089728,  0.4795022646846021, 0.4752694673136330, 0.4750540102025831, 0.4782488768524199, 0.4871715112202827, 0.4868843094919623, 0.4843562325887174, 0.4835935130835331,  0.4867226287750569, 0.4863614783282632, 0.4891031221907462, 0.4848002061937289, 0.4802281967614200, 0.4772168219924643, 0.4758176353352087, 0.4735558899381061,  0.4724962572592801, 0.4726240459881104, 0.4714467634180154, 0.4710489177360688, 0.4714390992094060, 0.4726106938155138, 0.4745588596923577, 0.4772841101671843,  0.4807925107278950, 0.4850950220887917, 0.4902067111479924, 0.4961460340659207, 0.4977474633246664, 0.4949782740709857, 0.4925889375015259, 0.4906451477362695,  0.4891628332671372, 0.4880589755764653, 0.4873303205106824, 0.4869755787235325 ))

  expect_equal(c(result$V_t_d_s),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633, 0.0004392322044566420, 0.0682991240249047060, 0.0003834452042018443,  0.0003834452042018442, 0.0029230271218272539, 0.0912395007549733350, -0.0003397914632747466, -0.0003397914632747466, 0.0052119615712443315,  0.0932049749695377378, -0.0016092541197089715, -0.0016092541197089711, 0.0073429567284740965, 0.0849686813506122934, -0.0030571106681653009, -0.0030571106681653005, 0.0093460739808944281, 0.0774928836229536178, -0.0044064881508436658, -0.0044064881508436658, 0.0112576788942480542,  0.0625786071371585012, -0.0058040178177705924, -0.0058040178177705924, 0.0131038581718835520, 0.0663037854506360463, -0.0066152078662832037, -0.0066152078662832037, 0.0149859903532218054, 0.0802636516361565355, -0.0072606054091964422, -0.0072606054091964422, 0.0169064138433351260,  0.0925945303565963995, -0.0077694160284284882, -0.0077694160284284891, 0.0188521666403896025, 0.1028653949187706279, -0.0082893243691400179, -0.0082893243691400196, 0.0208108298970566402, 0.1134521022635953669, -0.0087341231657698665, -0.0087341231657698665, 0.0227878464846351519,  0.1282127482321499812, -0.0091281359070864241, -0.0091281359070864224, 0.0247818173504978020, 0.1412262999503804406, -0.0096021138204995977, -0.0096021138204995960, 0.0267801536095240260, 0.1518039844431364749, -0.0100679733114127437, -0.0100679733114127437, 0.0287860644548110257,  0.1503781552817381462, -0.0107654864975719258, -0.0107654864975719258, 0.0307850681462566306, 0.1529892913432942814, -0.0114268209514253039, -0.0114268209514253039, 0.0328022104304094425, 0.1623989951758836869, -0.0119988254560485837, -0.0119988254560485837, 0.0348470071785677502,  0.1751405465177472420, -0.0124767948762201323, -0.0124767948762201323, 0.0369196593146410082, 0.1826262222670714253, -0.0130763410888457762, -0.0130763410888457762, 0.0390042849193854013, 0.1921213871302026865, -0.0136031573461606395, -0.0136031573461606395, 0.0411148217076838310,  0.1952137792451406062, -0.0142700820537257390, -0.0142700820537257390, 0.0432374522277687856, 0.2045009115946196943, -0.0150037228119862687, -0.0150037228119862670, 0.0453817496599724785, 0.2197992615605408318, -0.0156403530269492337, -0.0156403530269492302, 0.0475580384562985375,  0.2351742387248771660, -0.0163387197002041323, -0.0163387197002041323, 0.0497535112080704153, 0.2471786691448959739, -0.0171983898818672161, -0.0171983898818672196, 0.0519599789846230259, 0.2633406508519972045, -0.0179758501250396573, -0.0179758501250396607, 0.0541928396098181331,  0.2783570585162779554, -0.0187578421049752302, -0.0187578421049752336, 0.0564447233177911220, 0.2898617445280329274, -0.0196256986326030711, -0.0196256986326030711, 0.0587095922537396175, 0.3070089074201384216, -0.0202566671302706752, -0.0202566671302706752, 0.0610078966170546910,  0.3265517822464923947, -0.0207566923998554545, -0.0207566923998554545, 0.0633316746524540397, 0.3468613597848555496, -0.0211777326575118136, -0.0211777326575118136, 0.0656762424587988280, 0.3669330349624608245, -0.0215496836790728778, -0.0215496836790728778, 0.0680384930107222063,  0.3859999570458617635, -0.0218930814893318545, -0.0218930814893318545, 0.0704161786213701735, 0.4033580584084034970, -0.0222249753911356145, -0.0222249753911356145, 0.0728075543038044365, 0.4182756228156945255, -0.0225620115551172298, -0.0225620115551172298, 0.0752111771525787870,  0.4299395711487184468, -0.0229222709068044872, -0.0229222709068044872, 0.0776257813361121429, 0.4374185315654753881, -0.0233265169857653290, -0.0233265169857653290, 0.0800501930267311507, 0.4389396398028437285, -0.0237873509608388274, -0.0237873509608388274, 0.0824839842388029043,  0.4444370473634537966, -0.0241089985969926528, -0.0241089985969926528, 0.0849399776770060483, 0.4705099679725334716, -0.0239711015900734327, -0.0239711015900734327, 0.0874386019174675511, 0.5127677482774826156, -0.0234537793009185619, -0.0234537793009185619, 0.0899729190136854540,  0.5710035270105234817, -0.0225390051857156867, -0.0225390051857156867, 0.0925406272428825755, 0.6422966612793774566, -0.0213827332568293886, -0.0213827332568293886, 0.0951287192064125264, 0.7296350793987446126, -0.0198916154467032036, -0.0198916154467032036, 0.0977389611802057523,  0.8366982297826955906, -0.0179580979280018482, -0.0179580979280018482, 0.1003735699436583140 ))

  expect_equal(c(result$lag_one_cor),
               c( 0.0006319914823851234, -0.0001813450353835426, -0.0002126117899357636, 0.0004231047677557611, 0.0374926594959537965, -0.0005380017294018889, -0.0005485720017780360, 0.0027985731084827336, 0.0481658093802995874, -0.0016000013589881627, -0.0015949751696787691, 0.0050048137282718962,  0.0456878855983472026, -0.0029587363809467785, -0.0029189483751894322, 0.0070703673493283329, 0.0396604087798715019, -0.0043033008270456190, -0.0042589644753056816, 0.0090269214295090917, 0.0312294200116858406, -0.0056445383104769611, -0.0055052058435728288, 0.0109053718415916372,  0.0277604858121243067, -0.0066868592103896726, -0.0065493515470886115, 0.0127664150516888786, 0.0339237983194087267, -0.0074374459108181770, -0.0074140515313897131, 0.0146609784134950454, 0.0440622779829562689, -0.0081876860923845354, -0.0080158162771978795, 0.0165879425442369867,  0.0532613145041970354, -0.0087846810550449832, -0.0085842409359943670, 0.0185356890963747287, 0.0620030758351880484, -0.0093425048092310777, -0.0091025684196418474, 0.0204997891156617623, 0.0728513701255290580, -0.0097823345080032802, -0.0096128728534951753, 0.0224819052110776137,  0.0852163441699832769, -0.0102462632327539986, -0.0101088730406997656, 0.0244754314202132520, 0.0959330788853532263, -0.0107781511795978276, -0.0105860202161019556, 0.0264754322364910526, 0.1002061921916009707, -0.0114127390024465029, -0.0111391949292140822, 0.0284766937737128793,  0.1007636418466745787, -0.0120573912090688583, -0.0118570640836160000, 0.0304836792486671525, 0.1062366995263799574, -0.0126455551196479089, -0.0125325810037256995, 0.0325131894616143557, 0.1164479435890595910, -0.0131968007123752003, -0.0130824399573795571, 0.0345702739070011394,  0.1259739156939710947, -0.0137649784666452300, -0.0136274381705102868, 0.0366477215003125287, 0.1339397670426479281, -0.0143510749271825982, -0.0141996145156178810, 0.0387441154191005901, 0.1399397952275374390, -0.0149739632061277085, -0.0147895226744024933, 0.0408598614778161312,  0.1457693177465160805, -0.0155839512939056103, -0.0155955638120855878, 0.0429925035951635587, 0.1573951226983123508, -0.0162626012661845898, -0.0163227628857992857, 0.0451516935211992362, 0.1720884528462469087, -0.0169267713220890778, -0.0170279042024082637, 0.0473366336214868441,  0.1853207193021612631, -0.0176966192481461081, -0.0178397971217273306, 0.0495369101392598918, 0.1988822844190729910, -0.0185218493681163360, -0.0186795043672042492, 0.0517557651622434362, 0.2140265293846420891, -0.0193324169287155505, -0.0194536391053007109, 0.0539974391987324484,  0.2269743551126637005, -0.0201775348081844191, -0.0202760450098242243, 0.0562552827877792691, 0.2408827346519127055, -0.0209761004349988504, -0.0210013621236798051, 0.0585361402693362204, 0.2587873461391665963, -0.0215840832784766519, -0.0215509137876134238, 0.0608464935722820149,  0.2783108156512931197, -0.0220822328593056443, -0.0219982908028953338, 0.0631800531920647668, 0.2981521380750243311, -0.0225129962129074074, -0.0223819658897505894, 0.0655329263193361600, 0.3174279954979510876, -0.0229027366724126047, -0.0227258619326826256, 0.0679024304099249548,  0.3354014001863034333, -0.0232710946107934427, -0.0230480112171346438, 0.0702865626215162104, 0.3513521643906739600, -0.0236355450370131226, -0.0233647677843556098, 0.0726837231452698296, 0.3645059125021066215, -0.0240139196073090484, -0.0236931428694739724, 0.0750925529047788837,  0.3739890959881940757, -0.0244259932862989082, -0.0240522839920852098, 0.0775118285517998884, 0.3784535347735979438, -0.0249012435710693411, -0.0244462789870596130, 0.0799407418619832999, 0.3819151740934059180, -0.0253026050600785556, -0.0248317275156184590, 0.0823853873046871965,  0.3973498624532323387, -0.0253572058863496402, -0.0249807749061207209, 0.0848621500522364069, 0.4309121681052292541, -0.0250169074096886247, -0.0246995171538831222, 0.0873779395067437042, 0.4804161596009360879, -0.0243022568530614422, -0.0240233709749064703, 0.0899281997898045693,  0.5444877914482062486, -0.0232369005433537522, -0.0230542772574000854, 0.0925054925093105329, 0.6230475261289992739, -0.0218919395921305972, -0.0217917741796725788, 0.0951040211830674886, 0.7194167882990079033, -0.0201652844689610457, -0.0201377013624211842, 0.0977257666720493107 ))

  # expect_equal(c(result$n_iter),
  #              c(274 ))

  expect_equal(c(result$Q),
               c(0.129221898731263357, 0.002475034806031055, 0.002475034806031055, 0.002645631948634509 ))

  expect_equal(c(result$Q_0),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633, 0.0004392322044566420 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18, 18, 18, 18, 18, 18, 18, 17, 15, 14, 14, 14, 12, 12, 12, 11 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45 ))

  # expect_equal(c(result$hazard_func),
  #              c([[1]]function (eta) {    exp_ = exp(eta)    exp_/(1 + exp_)}<environment: 0x000000001fb07d38> ))
  #
  # expect_equal(c(result$hazard_first_deriv),
  #              c([[1]]function (beta, x_) {    exp_ = exp(beta %*% x_)    x_ * exp_/(exp_ + 1)^2}<environment: 0x000000001fb07d38> ))

  expect_equal(c(result$risk_set),
               c(NA ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))
})

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result$Q_0)), rep(c("(Intercept)", "group1"), 2))
})

result_pois = ddhazard(
  formula = Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 1, # Use by month intervals
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
  est_Q_0 = F,
  max_T = 30,
  id = head_neck_cancer$id, order_ = 1,
  model = "poisson"
)

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result$Q_0)), rep(c("(Intercept)", "group1"), 2))
})

# get_expect_equal(result_pois)

test_that("Outcome of poisson model on head neck compares with previous outcome", {
  expect_equal(c(result_pois$a_t_d_s),
               c(-3.4701181072777754, -3.4701341794563310, -3.1217023908477173, -2.7898114418324829, -2.5688470812499427, -2.1240230566681912, -2.1938278220883043, -2.5721366301628161, -2.7585829399507809, -2.8806503014261651, -3.0041675245273431, -3.2143261287217424, -3.3257996424152578, -3.3565606282954543, -3.1802373490021392, -3.2310004476976304, -3.3567156693558284, -3.4522672354157002, -3.4007057939667034, -3.4730612465890904, -3.4248035832745378, -3.5530623891264179, -3.7242334627493885, -3.8357768096275788, -3.8850088978391213, -4.0006937891015957, -4.0690359634420536, -4.0910320638934792, -4.1955690325311972, -4.2659427329741542, -4.3013194024775210, 0.3031719763190028, 0.3031717931760515, 0.3695332485343187, 0.4359425213340221,  0.4702460098248248, 0.5632677412487276, 0.5537377543760621, 0.4811078267440810, 0.4606896929798349, 0.4442561722389854, 0.4252424246830526,  0.3864546225838876, 0.3706550163264269, 0.3743235065514615, 0.4181661852377931, 0.4066277878891139, 0.3800900504388822, 0.3626754086970760,  0.3733322225465123, 0.3596146040767549, 0.3688582131669876, 0.3359197418467298, 0.2977539727459948, 0.2706156909471252, 0.2550914979270306,  0.2301202532881497, 0.2139900882367057, 0.2065941787397264, 0.1868143174685722, 0.1734876434709474, 0.1667855895656106 ))

  expect_equal(c(result_pois$V_t_d_s),
               c( 0.224893774853497042, -0.007285620614944987, -0.007285620614945008, 0.093822967691107872, 0.140676505135883700, -0.025001818347965027, -0.025001818347965055, 0.083620706439021919, 0.131783710502853840, -0.025674885731343494, -0.025674885731343522, 0.078148544952799659,  0.115004545278694026, -0.027367571792274947, -0.027367571792274947, 0.072943494629000460, 0.096517179671591874, -0.030007800344894295, -0.030007800344894309, 0.067992493563941686, 0.087143665106393250, -0.028342729290738389, -0.028342729290738389, 0.065250257899409109,  0.068414724003510063, -0.029971848879824077, -0.029971848879824077, 0.062511623819670806, 0.071254535319350262, -0.028335280865594795, -0.028335280865594798, 0.062325294550843700, 0.085483791343452326, -0.024696880801364271, -0.024696880801364271, 0.064177864247105837,  0.096621115052308387, -0.022622997529368642, -0.022622997529368642, 0.066416984805149709, 0.105576674506906998, -0.021272731195569432, -0.021272731195569432, 0.069071991874224248, 0.114899761138241241, -0.019882678206769470, -0.019882678206769470, 0.072238260427953602,  0.129998688141974850, -0.017575858169206052, -0.017575858169206052, 0.076006510398383256, 0.143001107021360846, -0.016063031626428189, -0.016063031626428189, 0.079818885605842729, 0.152666378567373417, -0.015427980324517095, -0.015427980324517095, 0.083614138687660267,  0.147345992312981872, -0.017906214507962707, -0.017906214507962703, 0.086851257201985818, 0.149333785318678136, -0.019088859519153484, -0.019088859519153484, 0.090655006240901656, 0.159849711638347047, -0.018758975908721432, -0.018758975908721436, 0.095113577890983625,  0.173400540178307472, -0.017969332215490803, -0.017969332215490807, 0.099952517420139067, 0.180137596006722744, -0.018685362726966231, -0.018685362726966231, 0.104664366388788357, 0.189520470697054383, -0.018946634745630866, -0.018946634745630866, 0.109735733447574840,  0.190836954398877212, -0.020898546351320532, -0.020898546351320532, 0.114646351627032850, 0.201444016724936392, -0.021478214453422389, -0.021478214453422392, 0.120108950073181231, 0.219769982312745582, -0.020625665271341916, -0.020625665271341923, 0.126185591235143696,  0.239407703849619014, -0.019698644048777868, -0.019698644048777865, 0.132503283179969122, 0.257503843745158445, -0.019314610818972108, -0.019314610818972101, 0.138879876431728944, 0.284251484342987026, -0.017450302407684349, -0.017450302407684345, 0.145776013828377293,  0.316135545813272467, -0.014646271215804489, -0.014646271215804486, 0.153054546791854540, 0.353835287017992661, -0.010844234648125865, -0.010844234648125861, 0.160685312141492093, 0.415347257993827490, -0.002443738118274508, -0.002443738118274510, 0.169464304561269541,  0.505503871453938713, 0.011395375474632508, 0.011395375474632508, 0.179498705134799541 ))

  expect_equal(c(result_pois$lag_one_cor),
               c( 0.125173234218149326, -0.023709134971813234, -0.027323415838557408, 0.083155693803221298, 0.089023162240673692, -0.031719241617294447, -0.033363259713816096, 0.075786755882751966, 0.077914611249103108, -0.032815186315032469, -0.033893632819459729, 0.070535202576117090,  0.063557818317231202, -0.034152853649203507, -0.035550709999718669, 0.065605103209329829, 0.053189986145996321, -0.035182366267016929, -0.033988273953568862, 0.061932099909581317, 0.042607243992557539, -0.034139774101337728, -0.033676155609672673, 0.059330123738439947,  0.037710620134716454, -0.033617439731799384, -0.033024781672930756, 0.057993397175691484, 0.042341443225708528, -0.032088221998865477, -0.030907955782967188, 0.058656026356354703, 0.051199709000935262, -0.029794336799618942, -0.029051128427350695, 0.060536643457631621,  0.058857565016052271, -0.028572582755016392, -0.027823071874658573, 0.062877480730155436, 0.066117624418493157, -0.027672694820161201, -0.026755694661100032, 0.065701373789100265, 0.076113804189633039, -0.026260570624580232, -0.025368483159774014, 0.069070122886443694,  0.088335278009447946, -0.024591723105703275, -0.023944042138887699, 0.072782350266197532, 0.098486723476171642, -0.023683927152914924, -0.023171494641698220, 0.076534841750937652, 0.100523210455620363, -0.024558797460942361, -0.024193880790992699, 0.080041910912605152,  0.099113974212104911, -0.026349392459243233, -0.025968936993202886, 0.083564915110443561, 0.104703781661649079, -0.026914505108502261, -0.026517646047404590, 0.087663598211235066, 0.115643929722247532, -0.026565884735176914, -0.026173042970635066, 0.092264941480760934,  0.125133262280084756, -0.026606236266767398, -0.026310944951659067, 0.097011759945063586, 0.132634409043895507, -0.027226587993619801, -0.026885910065557225, 0.101877034612574885, 0.137727119319456082, -0.028354688566973818, -0.028069239978412576, 0.106854811074765521,  0.143302379161730636, -0.029580498383597158, -0.029516171624937308, 0.112022941210522683, 0.156854370911617746, -0.029659467826641056, -0.029515761452369241, 0.117753563866697233, 0.174926406042632876, -0.028913912053799402, -0.028828097348827922, 0.123913753847127869,  0.193087524371005903, -0.028327016574015734, -0.028369216102865202, 0.130232745811704187, 0.214578307260425871, -0.027353991449723326, -0.027446806502977927, 0.136831961123929452, 0.242962215425631262, -0.025218103398520722, -0.025271244439001684, 0.143882260530544787,  0.276840663164390655, -0.022074637296623109, -0.022156859056754803, 0.151301323944977834, 0.324811512425026483, -0.016339697819287995, -0.016319489879258894, 0.159442392548736073, 0.398624506610238460, -0.005615670432829711, -0.005581023965348618, 0.168771869942488495 ))

  expect_equal(c(result_pois$n_iter),
               c(141 ))

  expect_equal(c(result_pois$Q),
               c(0.12847791628133629, 0.02107367312826081, 0.02107367312826081, 0.01152127440676856 ))

  expect_equal(c(result_pois$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_pois$order),
               c(1 ))

  expect_equal(c(result_pois$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_pois$method),
               c("EKF" ))

  expect_equal(c(result_pois$model),
               c("poisson" ))
})

test_that("poisson model and logit moels hazzard functions differs", {
  expect_true(result_pois$model != result$model)
  expect_true(toString(body(result_pois$hazard_func)) !=
                toString(body(result$hazard_func)))
  expect_true(toString(body(result_pois$hazard_first_deriv)) !=
                toString(body(result$hazard_first_deriv)))
})

# sim_dat <- test_sim_func_logit(n_series = 1e4, n_vars = 4, t_max = 10, x_range = 1, x_mean = 0,
#                                beta_start = 1, sds = c(.1, rep(1, 4)), intercept_start = -5)
#
# fit <- ddhazard(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
#                 data = sim_dat$res,
#                 by = 1,
#                 a_0 = rep(0, 5),
#                 Q_0 = diag(rep(10, 5)),
#                 id = sim_dat$res$id,
#                 eps = 1e-2, n_max = 1e2,
#                 max_T = 10,
#                 verbose = T,
#                 model = "logit")
#
# matplot(fit$a_t_d_s, lty = 2, type = "l", ylim = range(fit$a_t_d_s, sim_dat$betas))
# matplot(sim_dat$betas, lty = 1, type = "l", add = T)

set.seed(9327)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 0,
                            intercept_start = -4, sds = c(.1, rep(1, 3)))

test_that("Chaning time scale in EKF does no change results when other parems are changed accoridngly",{
  arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                   by = 1,
                   data = sims$res,
                   a_0 = rep(0, ncol(sims$res) + 1 - 4),
                   Q_0 = diag(rep(1e1, ncol(sims$res) + 1 - 4)),
                   Q = diag(rep(1, ncol(sims$res) + 1 - 4)),
                   est_Q_0 = F, method = "EKF",
                   eps = 1e-2, id = sims$res$id,
                   verbose = F,
                   max_T = 10)

  res <- do.call(ddhazard, arg_list)

  sim_tmp <- sims
  t_mult <- 2.5
  sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
  sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
  arg_list$data <- sim_tmp$res
  arg_list$by <- t_mult
  arg_list$max_T <- arg_list$max_T * t_mult
  arg_list$Q <- arg_list$Q / t_mult

  res_new_time <- do.call(ddhazard, arg_list)

  expect_equal(res$a_t_d_s, res_new_time$a_t_d_s)
  expect_equal(res$V_t_d_s, res_new_time$V_t_d_s)
  expect_equal(res$Q, res_new_time$Q * t_mult)
})

