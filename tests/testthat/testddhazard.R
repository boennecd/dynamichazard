library(survival)

test_that("The head_neck_cancer must be defined for the ddhazard tests",
          expect_true(exists("head_neck_cancer")))

# Test on data set that is one of Farhmiers papers
result = ddhazard(
  formula = survival::Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 1, # Use by month intervals
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
  est_Q_0 = T,
  max_T = 45,
  id = head_neck_cancer$id, order_ = 1
)

test_that("Testing previous computed values vs. current on head and neck cancer set assuming that the previous is correct", {
  expect_equal(c(result$a_t_d_s),
               c(-3.5084644693000375, -3.5148844600373153, -3.1891314791814929, -2.8181185126716946, -2.5133150253138181, -2.0686431883814391, -2.1337664829927272, -2.5088816216986980, -2.7261252524003838, -2.8656346839715456, -3.0022690651419150, -3.2103909019454631, -3.3296886621454438, -3.3797024676574670, -3.2387762301797576, -3.2832268974011902, -3.4010378429506498, -3.4996364628495664, -3.4640927580381167, -3.5454306632739097, -3.5193437650355053, -3.6429455602328522, -3.8148529400485618, -3.9315760725295390, -3.9912270162929087, -4.1221212755199144, -4.2111505273306804, -4.2593181086540230, -4.3955501412991156, -4.5056360495292482, -4.5891834181979796, -4.6463491829253352, -4.6772452961075963, -4.6818100380470060, -4.6597979866888570, -4.6108005184078964, -4.5342715329240795, -4.4295511232451679, -4.4288880723551687, -4.5320293776581728, -4.6212298063525905, -4.6940739120459574, -4.7499759978712248, -4.7915369057959181, -4.8188789577153992, -4.8320508432930724, 0.4360755600018228, 0.4376620032308990,  0.4489331535887380, 0.4629877155198045, 0.4717967889720516, 0.4892432325019014, 0.4906015100905337, 0.4811672226212869, 0.4812410655726153, 0.4807008058089728,  0.4795022646846021, 0.4752694673136330, 0.4750540102025831, 0.4782488768524199, 0.4871715112202827, 0.4868843094919623, 0.4843562325887174, 0.4835935130835331,  0.4867226287750569, 0.4863614783282632, 0.4891031221907462, 0.4848002061937289, 0.4802281967614200, 0.4772168219924643, 0.4758176353352087, 0.4735558899381061,  0.4724962572592801, 0.4726240459881104, 0.4714467634180154, 0.4710489177360688, 0.4714390992094060, 0.4726106938155138, 0.4745588596923577, 0.4772841101671843,  0.4807925107278950, 0.4850950220887917, 0.4902067111479924, 0.4961460340659207, 0.4977474633246664, 0.4949782740709857, 0.4925889375015259, 0.4906451477362695,  0.4891628332671372, 0.4880589755764653, 0.4873303205106824, 0.4869755787235325 ))

  expect_equal(c(result$V_t_d_s),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633, 0.0004392322044566420, 0.0682991240249047060, 0.0003834452042018443,  0.0003834452042018442, 0.0029230271218272539, 0.0912395007549733350, -0.0003397914632747466, -0.0003397914632747466, 0.0052119615712443315,  0.0932049749695377378, -0.0016092541197089715, -0.0016092541197089711, 0.0073429567284740965, 0.0849686813506122934, -0.0030571106681653009, -0.0030571106681653005, 0.0093460739808944281, 0.0774928836229536178, -0.0044064881508436658, -0.0044064881508436658, 0.0112576788942480542,  0.0625786071371585012, -0.0058040178177705924, -0.0058040178177705924, 0.0131038581718835520, 0.0663037854506360463, -0.0066152078662832037, -0.0066152078662832037, 0.0149859903532218054, 0.0802636516361565355, -0.0072606054091964422, -0.0072606054091964422, 0.0169064138433351260,  0.0925945303565963995, -0.0077694160284284882, -0.0077694160284284891, 0.0188521666403896025, 0.1028653949187706279, -0.0082893243691400179, -0.0082893243691400196, 0.0208108298970566402, 0.1134521022635953669, -0.0087341231657698665, -0.0087341231657698665, 0.0227878464846351519,  0.1282127482321499812, -0.0091281359070864241, -0.0091281359070864224, 0.0247818173504978020, 0.1412262999503804406, -0.0096021138204995977, -0.0096021138204995960, 0.0267801536095240260, 0.1518039844431364749, -0.0100679733114127437, -0.0100679733114127437, 0.0287860644548110257,  0.1503781552817381462, -0.0107654864975719258, -0.0107654864975719258, 0.0307850681462566306, 0.1529892913432942814, -0.0114268209514253039, -0.0114268209514253039, 0.0328022104304094425, 0.1623989951758836869, -0.0119988254560485837, -0.0119988254560485837, 0.0348470071785677502,  0.1751405465177472420, -0.0124767948762201323, -0.0124767948762201323, 0.0369196593146410082, 0.1826262222670714253, -0.0130763410888457762, -0.0130763410888457762, 0.0390042849193854013, 0.1921213871302026865, -0.0136031573461606395, -0.0136031573461606395, 0.0411148217076838310,  0.1952137792451406062, -0.0142700820537257390, -0.0142700820537257390, 0.0432374522277687856, 0.2045009115946196943, -0.0150037228119862687, -0.0150037228119862670, 0.0453817496599724785, 0.2197992615605408318, -0.0156403530269492337, -0.0156403530269492302, 0.0475580384562985375,  0.2351742387248771660, -0.0163387197002041323, -0.0163387197002041323, 0.0497535112080704153, 0.2471786691448959739, -0.0171983898818672161, -0.0171983898818672196, 0.0519599789846230259, 0.2633406508519972045, -0.0179758501250396573, -0.0179758501250396607, 0.0541928396098181331,  0.2783570585162779554, -0.0187578421049752302, -0.0187578421049752336, 0.0564447233177911220, 0.2898617445280329274, -0.0196256986326030711, -0.0196256986326030711, 0.0587095922537396175, 0.3070089074201384216, -0.0202566671302706752, -0.0202566671302706752, 0.0610078966170546910,  0.3265517822464923947, -0.0207566923998554545, -0.0207566923998554545, 0.0633316746524540397, 0.3468613597848555496, -0.0211777326575118136, -0.0211777326575118136, 0.0656762424587988280, 0.3669330349624608245, -0.0215496836790728778, -0.0215496836790728778, 0.0680384930107222063,  0.3859999570458617635, -0.0218930814893318545, -0.0218930814893318545, 0.0704161786213701735, 0.4033580584084034970, -0.0222249753911356145, -0.0222249753911356145, 0.0728075543038044365, 0.4182756228156945255, -0.0225620115551172298, -0.0225620115551172298, 0.0752111771525787870,  0.4299395711487184468, -0.0229222709068044872, -0.0229222709068044872, 0.0776257813361121429, 0.4374185315654753881, -0.0233265169857653290, -0.0233265169857653290, 0.0800501930267311507, 0.4389396398028437285, -0.0237873509608388274, -0.0237873509608388274, 0.0824839842388029043,  0.4444370473634537966, -0.0241089985969926528, -0.0241089985969926528, 0.0849399776770060483, 0.4705099679725334716, -0.0239711015900734327, -0.0239711015900734327, 0.0874386019174675511, 0.5127677482774826156, -0.0234537793009185619, -0.0234537793009185619, 0.0899729190136854540,  0.5710035270105234817, -0.0225390051857156867, -0.0225390051857156867, 0.0925406272428825755, 0.6422966612793774566, -0.0213827332568293886, -0.0213827332568293886, 0.0951287192064125264, 0.7296350793987446126, -0.0198916154467032036, -0.0198916154467032036, 0.0977389611802057523,  0.8366982297826955906, -0.0179580979280018482, -0.0179580979280018482, 0.1003735699436583140 ))

  expect_equal(c(result$lag_one_cor),
               c( 0.0006319914823851234, -0.0001813450353835426, -0.0002126117899357636, 0.0004231047677557611, 0.0374926594959537965, -0.0005380017294018889, -0.0005485720017780360, 0.0027985731084827336, 0.0481658093802995874, -0.0016000013589881627, -0.0015949751696787691, 0.0050048137282718962,  0.0456878855983472026, -0.0029587363809467785, -0.0029189483751894322, 0.0070703673493283329, 0.0396604087798715019, -0.0043033008270456190, -0.0042589644753056816, 0.0090269214295090917, 0.0312294200116858406, -0.0056445383104769611, -0.0055052058435728288, 0.0109053718415916372,  0.0277604858121243067, -0.0066868592103896726, -0.0065493515470886115, 0.0127664150516888786, 0.0339237983194087267, -0.0074374459108181770, -0.0074140515313897131, 0.0146609784134950454, 0.0440622779829562689, -0.0081876860923845354, -0.0080158162771978795, 0.0165879425442369867,  0.0532613145041970354, -0.0087846810550449832, -0.0085842409359943670, 0.0185356890963747287, 0.0620030758351880484, -0.0093425048092310777, -0.0091025684196418474, 0.0204997891156617623, 0.0728513701255290580, -0.0097823345080032802, -0.0096128728534951753, 0.0224819052110776137,  0.0852163441699832769, -0.0102462632327539986, -0.0101088730406997656, 0.0244754314202132520, 0.0959330788853532263, -0.0107781511795978276, -0.0105860202161019556, 0.0264754322364910526, 0.1002061921916009707, -0.0114127390024465029, -0.0111391949292140822, 0.0284766937737128793,  0.1007636418466745787, -0.0120573912090688583, -0.0118570640836160000, 0.0304836792486671525, 0.1062366995263799574, -0.0126455551196479089, -0.0125325810037256995, 0.0325131894616143557, 0.1164479435890595910, -0.0131968007123752003, -0.0130824399573795571, 0.0345702739070011394,  0.1259739156939710947, -0.0137649784666452300, -0.0136274381705102868, 0.0366477215003125287, 0.1339397670426479281, -0.0143510749271825982, -0.0141996145156178810, 0.0387441154191005901, 0.1399397952275374390, -0.0149739632061277085, -0.0147895226744024933, 0.0408598614778161312,  0.1457693177465160805, -0.0155839512939056103, -0.0155955638120855878, 0.0429925035951635587, 0.1573951226983123508, -0.0162626012661845898, -0.0163227628857992857, 0.0451516935211992362, 0.1720884528462469087, -0.0169267713220890778, -0.0170279042024082637, 0.0473366336214868441,  0.1853207193021612631, -0.0176966192481461081, -0.0178397971217273306, 0.0495369101392598918, 0.1988822844190729910, -0.0185218493681163360, -0.0186795043672042492, 0.0517557651622434362, 0.2140265293846420891, -0.0193324169287155505, -0.0194536391053007109, 0.0539974391987324484,  0.2269743551126637005, -0.0201775348081844191, -0.0202760450098242243, 0.0562552827877792691, 0.2408827346519127055, -0.0209761004349988504, -0.0210013621236798051, 0.0585361402693362204, 0.2587873461391665963, -0.0215840832784766519, -0.0215509137876134238, 0.0608464935722820149,  0.2783108156512931197, -0.0220822328593056443, -0.0219982908028953338, 0.0631800531920647668, 0.2981521380750243311, -0.0225129962129074074, -0.0223819658897505894, 0.0655329263193361600, 0.3174279954979510876, -0.0229027366724126047, -0.0227258619326826256, 0.0679024304099249548,  0.3354014001863034333, -0.0232710946107934427, -0.0230480112171346438, 0.0702865626215162104, 0.3513521643906739600, -0.0236355450370131226, -0.0233647677843556098, 0.0726837231452698296, 0.3645059125021066215, -0.0240139196073090484, -0.0236931428694739724, 0.0750925529047788837,  0.3739890959881940757, -0.0244259932862989082, -0.0240522839920852098, 0.0775118285517998884, 0.3784535347735979438, -0.0249012435710693411, -0.0244462789870596130, 0.0799407418619832999, 0.3819151740934059180, -0.0253026050600785556, -0.0248317275156184590, 0.0823853873046871965,  0.3973498624532323387, -0.0253572058863496402, -0.0249807749061207209, 0.0848621500522364069, 0.4309121681052292541, -0.0250169074096886247, -0.0246995171538831222, 0.0873779395067437042, 0.4804161596009360879, -0.0243022568530614422, -0.0240233709749064703, 0.0899281997898045693,  0.5444877914482062486, -0.0232369005433537522, -0.0230542772574000854, 0.0925054925093105329, 0.6230475261289992739, -0.0218919395921305972, -0.0217917741796725788, 0.0951040211830674886, 0.7194167882990079033, -0.0201652844689610457, -0.0201377013624211842, 0.0977257666720493107 ))

  # expect_equal(c(result$n_iter),
  #              c(274 ))

  expect_equal(c(result$Q),
               c(0.129221898731263357, 0.002475034806031055, 0.002475034806031055, 0.002645631948634509 ))

  expect_equal(c(result$Q_0),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633, 0.0004392322044566420 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18, 18, 18, 18, 18, 18, 18, 17, 15, 14, 14, 14, 12, 12, 12, 11 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45 ))

  # expect_equal(c(result$hazard_func),
  #              c([[1]]function (eta) {    exp_ = exp(eta)    exp_/(1 + exp_)}<environment: 0x000000001fb07d38> ))
  #
  # expect_equal(c(result$hazard_first_deriv),
  #              c([[1]]function (beta, x_) {    exp_ = exp(beta %*% x_)    x_ * exp_/(exp_ + 1)^2}<environment: 0x000000001fb07d38> ))

  expect_equal(c(result$risk_set),
               c(NA ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))
})

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result$Q_0)), rep(c("(Intercept)", "group1"), 2))
})

# tmp_file <- file("exponential.log")
# sink(tmp_file)
result_exp = ddhazard(
  formula = survival::Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = .66, # Use by month intervals
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
  Q = diag(1e-3, 2),
  est_Q_0 = F,
  max_T = 30,
  id = head_neck_cancer$id, order_ = 1,
  verbose = F,
  model = "exponential"
)
# sink()
# close(tmp_file)

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result_exp$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result_exp$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result_exp$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result_exp$Q_0)), rep(c("(Intercept)", "group1"), 2))
})

# get_expect_equal(result_exp)

test_that("Result of exponential model on head_neck_data match previous results", {
  expect_equal(c(result_exp$a_t_d_s),
               c(-3.844021116898306278, -3.844103767363837854, -3.483621861906405215, -3.124772122386196394, -1.851876718600995453, -1.936151354463269358, -2.274548970758221600, -1.884462607344611351, -1.540661114507920537, -1.876137672931669442, -1.116966991333242509, -1.505413979899247634, -1.912329303396071767, -1.866911619991120652, -2.013694963924348880, -2.286096323229251048, -2.033920452288271452, -2.309572790254077024, -2.604423827985097972, -2.681716370272507532, -2.816304430159327410, -2.607417579624707216, -1.729886530597237293, -1.911665628943205908, -2.257589207510624973, -2.422838229762533491, -2.665059597080690956, -2.705069026256280651, -2.342079365652209866, -2.536275345989278396, -2.538460952326691444, -2.108091041249487763, -2.311721316178510843, -2.616156428949731882, -2.870713412152406274, -3.050021971014424516, -3.123421520923820083, -3.045341757964977525, -3.231660148257376353, -3.380541146329874902, -3.464524528918186963, -3.463373985163455071, -3.629316550106130634, -3.776771466214738915, -3.895781890883747600, -3.981063973366055109, -4.027072898271381263, -0.179015855085145059, -0.179047966857549146, -0.038278959843479843,  0.101339921175876424, 0.598034434835927775, 0.565001473730222803, 0.431481321061761847, 0.581889467224503187,  0.716773221675830019, 0.586888428114473948, 0.884799766004433996, 0.734655618065041094, 0.579113273637454795,  0.600451467784416604, 0.545315273493892860, 0.440943251085160859, 0.541464637043109320, 0.435380295843031950,  0.322189574594116346, 0.293915402222104882, 0.243922481623575521, 0.328060418390276165, 0.673324177254078449,  0.602909966217538451, 0.468325468836569614, 0.404169414547845995, 0.310521237169624487, 0.295774485883420368,  0.438360869288288102, 0.363295989912509942, 0.363150118697632363, 0.531886795743325091, 0.451750028902563605,  0.332498709897502576, 0.232635151105134275, 0.162089993171130431, 0.132849400943911955, 0.162713402081432590,  0.089848045642056479, 0.031560051360342969, -0.001416042302106693, -0.001175023689001811, -0.065882120449476278, -0.123393321717625223, -0.169816506607260664, -0.203086232101523434, -0.221036266624119071 ))

  expect_equal(c(result_exp$V_t_d_s),
               c( 0.2952170653002641476, 0.1028390230355075985, 0.1028390230355076262, 0.0643157074130923379, 0.1685400497727645164,  0.0529034575603052337, 0.0529034575603052892, 0.0439552461544453488, 0.1622394668432597942, 0.0502033687344552726,  0.0502033687344553281, 0.0421434597058926164, 0.1360378856089308752, 0.0393272630948497404, 0.0393272630948497404,  0.0369890901138794637, 0.1274910170385418762, 0.0356961347947711283, 0.0356961347947711283, 0.0348123508724652031,  0.0307352009182124547, -0.0027423522064836531, -0.0027423522064836531, 0.0189091260063039557, 0.0350986736598119797, -0.0008920779221640238, -0.0008920779221640238, 0.0191672154197715661, 0.0475431559792763442, 0.0044759167184533315,  0.0044759167184533315, 0.0210227708742115396, 0.0370375130494596805, 0.0009939460287898896, 0.0009939460287898862,  0.0195135907009847884, 0.0299397922575635085, -0.0015430431289572208, -0.0015430431289572243, 0.0183006263453541901,  0.0415579070096424308, 0.0032842518762534016, 0.0032842518762533999, 0.0200941509471810643, 0.0256324254829516512, -0.0030517208598633133, -0.0030517208598633133, 0.0174297225173380838, 0.0349482697301542675, 0.0008032070226064898,  0.0008032070226064924, 0.0190120839054523719, 0.0483376239886030984, 0.0063387887305288984, 0.0063387887305288958,  0.0213677669596312875, 0.0487430749377836120, 0.0066271521584037041, 0.0066271521584037006, 0.0216531080061072648,  0.0563506484963180523, 0.0098232629461524196, 0.0098232629461524196, 0.0231608504403207627, 0.0738023355594305125,  0.0169645725803410953, 0.0169645725803410988, 0.0262887797917126832, 0.0614057009039141941, 0.0120660165647248387,  0.0120660165647248369, 0.0245881100969340231, 0.0769528121851751901, 0.0183543680849518227, 0.0183543680849518193,  0.0274015212850057914, 0.0966124971706693869, 0.0262378691127078574, 0.0262378691127078539, 0.0308583979042933616,  0.1041247558120943495, 0.0291661289006241616, 0.0291661289006241650, 0.0323122563235143101, 0.1231421279131287988,  0.0366003270822057164, 0.0366003270822057303, 0.0355445561730011739, 0.1268629387186792634, 0.0377762768348651398,  0.0377762768348651398, 0.0362294191102085772, 0.0555617222094493407, 0.0090779512346327515, 0.0090779512346327498,  0.0250264853763741690, 0.0664725386211983127, 0.0134146833209079028, 0.0134146833209078976, 0.0271438731832886887,  0.0856204379713345481, 0.0210777293421661530, 0.0210777293421661564, 0.0306431995410065307, 0.0963344863652327160,  0.0252632274940413938, 0.0252632274940413869, 0.0327381553772970596, 0.1175931421605614646, 0.0336431488125347941,  0.0336431488125347941, 0.0365230712831259088, 0.1340868012572931645, 0.0399676050544968894, 0.0399676050544968894,  0.0394437391664325676, 0.1036188211909005591, 0.0275868204254940200, 0.0275868204254940200, 0.0349254595921210526,  0.1212306567553573383, 0.0344441875759452093, 0.0344441875759452093, 0.0381241735144727950, 0.1324965305939337368,  0.0387685694824752083, 0.0387685694824752014, 0.0403277461531386799, 0.0956415849034601973, 0.0240147296398253891,  0.0240147296398253857, 0.0349799227806580557, 0.1090863843268185390, 0.0290165414474629207, 0.0290165414474629207,  0.0374222642184880092, 0.1321252506590064879, 0.0380858964208271866, 0.0380858964208271866, 0.0416013648361392430,  0.1563515425766927036, 0.0476495867777795012, 0.0476495867777795012, 0.0460017866653660776, 0.1789580107714790480,  0.0564981754036308417, 0.0564981754036308348, 0.0501027719208556044, 0.1934737794813350120, 0.0620197680727677253,  0.0620197680727677392, 0.0528482942297732738, 0.1827522462941697512, 0.0574245583557469741, 0.0574245583557469810,  0.0515481994073267724, 0.2028281340312806658, 0.0650277583924524921, 0.0650277583924525060, 0.0550904735646858962,  0.2250734544791093139, 0.0735598525537087683, 0.0735598525537087822, 0.0590358468335579270, 0.2423254961995543466,  0.0801008929735909370, 0.0801008929735909647, 0.0621944109541316334, 0.2447977133340742129, 0.0807488278010899951,  0.0807488278010900090, 0.0630098210253111773, 0.2723663066035525437, 0.0913641862873179195, 0.0913641862873179333,  0.0677904515240403821, 0.3180536466532969397, 0.1090965101624379319, 0.1090965101624379319, 0.0753726430158654925,  0.3934901796374665195, 0.1384258294575079484, 0.1384258294575079484, 0.0874807871483150451, 0.5270412812015025095,  0.1903867291350835600, 0.1903867291350835600, 0.1084067250787822401 ))

  expect_equal(c(result_exp$lag_one_cor),
               c( 1.324102437269882e-01, 3.952995756601393e-02, 3.881006140721208e-02, 3.872118365717792e-02, 8.448410651673283e-02,  2.037299938235956e-02, 1.984504983447752e-02, 3.047211943117678e-02, 7.152761496789176e-02, 1.507273511243365e-02,  1.414438532038120e-02, 2.749234716976273e-02, 5.932660350390642e-02, 9.687041980440403e-03, 9.079222557404260e-03,  2.462202594329616e-02, 1.837037936331908e-02, -6.607281926649777e-03, -7.552465896685998e-03, 1.736928675425381e-02,  1.074612826314534e-02, -1.020466414428582e-02, -1.035843113675750e-02, 1.545275034176803e-02, 1.235787051016246e-02, -9.449733482255022e-03, -9.204455754547619e-03, 1.547243217939741e-02, 1.231340050759884e-02, -8.982152892320766e-03, -8.584779409656608e-03, 1.548853331685335e-02, 9.970672861980383e-03, -9.303912329441544e-03, -9.240638131977629e-03,  1.511148615390240e-02, 1.020938887923293e-02, -9.004030424803848e-03, -8.833638511319138e-03, 1.509201139440790e-02,  9.584716625509186e-03, -8.983073207139626e-03, -9.169190926625069e-03, 1.488981854779090e-02, 9.067413525778497e-03, -9.329474687328095e-03, -9.124234876706310e-03, 1.477496800394601e-02, 1.137253292399331e-02, -8.239181485342976e-03, -7.904281540291139e-03, 1.535876367377579e-02, 1.344806784198510e-02, -7.141979559912506e-03, -6.952303389785938e-03,  1.594045524059705e-02, 1.460320808713370e-02, -6.574428634155132e-03, -6.270044810613395e-03, 1.639907293894916e-02,  1.912490189206533e-02, -4.595569274315890e-03, -4.178323546879218e-03, 1.749073805824978e-02, 2.029686706743410e-02, -3.825500427227746e-03, -3.767291867435313e-03, 1.799642685024425e-02, 2.085494422927447e-02, -3.669945583296180e-03, -3.333309338977117e-03, 1.839528063278857e-02, 2.957367913535427e-02, -5.599112658976387e-05, 2.766358240181201e-04,  2.017197603602937e-02, 3.774416812551048e-02, 3.333617143758672e-03, 3.465757011643880e-03, 2.180008289554490e-02,  4.596701920085952e-02, 6.536510369904219e-03, 6.684177078721048e-03, 2.337292683392209e-02, 5.400453304389671e-02,  9.676629752930769e-03, 9.553282220585515e-03, 2.482383116473767e-02, 2.811490932131411e-02, -7.225616193187816e-04, -1.391391313740854e-03, 2.077270611280272e-02, 1.758029454682468e-02, -5.684536564796372e-03, -5.429363126479069e-03,  1.923039049532111e-02, 2.409071439722204e-02, -3.075631092637056e-03, -2.701143183756850e-03, 2.073585605708007e-02,  3.225409804561058e-02, 2.897938026132545e-04, 4.920861182007453e-04, 2.249915807721161e-02, 4.163635850666145e-02,  3.951404022417358e-03, 4.232652779233008e-03, 2.442979102857729e-02, 5.444553624520830e-02, 9.026866211676036e-03,  9.121960418706146e-03, 2.685683770099793e-02, 4.915468825179490e-02, 6.836875540459942e-03, 6.584378111424190e-03,  2.631818228751725e-02, 4.536994348733105e-02, 4.877383748635750e-03, 5.081849859438867e-03, 2.606017029333710e-02,  5.533791283426352e-02, 8.746242496853223e-03, 8.900954474303651e-03, 2.807867010244706e-02, 4.565210548441307e-02,  4.882793855553277e-03, 4.765512909107284e-03, 2.698156632029525e-02, 3.910848175319573e-02, 1.961818197604375e-03,  1.966116190484242e-03, 2.631595797832788e-02, 5.074889997522882e-02, 6.257078185687600e-03, 6.580376539837384e-03,  2.861758622208237e-02, 6.767638726190957e-02, 1.293851221440002e-02, 1.329134083714574e-02, 3.188324745316437e-02,  8.587743771219986e-02, 2.014808133099991e-02, 2.041923256796997e-02, 3.533795495549404e-02, 1.011692139320595e-01,  2.613800676348026e-02, 2.624670901802116e-02, 3.826283998652524e-02, 1.028139840883510e-01, 2.662907099475350e-02,  2.648753600131389e-02, 3.894804480755983e-02, 1.065844338380236e-01, 2.769220220658213e-02, 2.772305183430374e-02,  3.993034203003462e-02, 1.245458479680033e-01, 3.446962154986404e-02, 3.458123355874412e-02, 4.318583660566165e-02,  1.418815852522939e-01, 4.108347527709655e-02, 4.115609075581685e-02, 4.636985300949065e-02, 1.507618447315611e-01,  4.435285851274891e-02, 4.431000573014448e-02, 4.820754006788263e-02, 1.638726527013820e-01, 4.915615488039436e-02,  4.927690023985115e-02, 5.071366151498975e-02, 1.967480630236385e-01, 6.184424294295539e-02, 6.200495939228123e-02,  5.632250669645381e-02, 2.521827717763679e-01, 8.338242196585247e-02, 8.352415040733188e-02, 6.538583376489804e-02,  3.492475649313038e-01, 1.211551921834700e-01, 1.212407073277518e-01, 8.077045986960214e-02 ))

  expect_equal(c(result_exp$n_iter),
               c(65 ))

  expect_equal(c(result_exp$Q),
               c(0.37132867768945721, 0.14451062823767694, 0.14451062823767694, 0.05731917616207872 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$times),
               c( 0.000000000000000, 0.660000000000000, 1.320000000000000, 1.980000000000000, 2.640000000000000, 3.300000000000000,  3.960000000000000, 4.620000000000000, 5.280000000000000, 5.940000000000000, 6.600000000000001, 7.260000000000001,  7.920000000000000, 8.580000000000000, 9.240000000000000, 9.900000000000000, 10.560000000000000, 11.220000000000001, 11.880000000000001, 12.540000000000001, 13.200000000000001, 13.860000000000001, 14.520000000000001, 15.180000000000001, 15.840000000000000, 16.500000000000000, 17.160000000000000, 17.820000000000000, 18.480000000000000, 19.140000000000001, 19.800000000000001, 20.460000000000001, 21.120000000000001, 21.780000000000001, 22.440000000000001, 23.100000000000001, 23.760000000000002, 24.420000000000002, 25.080000000000002, 25.740000000000002, 26.400000000000002, 27.060000000000002, 27.720000000000002, 28.380000000000003, 29.040000000000003, 29.700000000000003, 30.360000000000003 ))

  expect_equal(c(result_exp$risk_set),
               c(NA ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("EKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))
})

test_that("poisson model and logit moels hazzard functions differs", {
  expect_true(result_exp$model != result$model)
  expect_true(toString(body(result_exp$hazard_func)) !=
                toString(body(result$hazard_func)))
  expect_true(toString(body(result_exp$hazard_first_deriv)) !=
                toString(body(result$hazard_first_deriv)))
})

set.seed(3787)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 0,
                            intercept_start = -4, sds = c(.1, rep(1, 3)))

test_that("Chaning time scale in EKF does no change results when other parems are changed accoridngly",{
  for(m in c("logit")){
    arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                     by = 1,
                     data = sims$res,
                     a_0 = rep(0, ncol(sims$res) + 1 - 4),
                     Q_0 = diag(rep(1e2, ncol(sims$res) + 1 - 4)),
                     Q = diag(rep(1e-3, ncol(sims$res) + 1 - 4)),
                     est_Q_0 = F, method = "EKF",
                     model = m,
                     eps = 1e-2, id = sims$res$id,
                     verbose = F,
                     max_T = 10)

    res <- do.call(ddhazard, arg_list)

    sim_tmp <- sims
    t_mult <- 2.5
    sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
    sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
    arg_list$data <- sim_tmp$res
    arg_list$by <- t_mult
    arg_list$max_T <- arg_list$max_T * t_mult
    arg_list$Q <- arg_list$Q / t_mult

    res_new_time <- do.call(ddhazard, arg_list)

    expect_equal(res$a_t_d_s, res_new_time$a_t_d_s)
    expect_equal(res$V_t_d_s, res_new_time$V_t_d_s)
    expect_equal(res$Q, res_new_time$Q * t_mult)
  }
})

set.seed(93143)
sims <- test_sim_func_poisson(n_series = 1e3, n_vars = 3, t_0 = 0, t_max = 10,
                              x_range = 1, x_mean = -.5, re_draw = T, beta_start = 0,
                              intercept_start = -4, sds = c(.1, rep(1, 3)))

tmp_file <- file("exponential.log")
sink(tmp_file)
result_exp = ddhazard(
  formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
  data = sims$res,
  by = (by_ <- 2),
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 4), Q_0 = diag(10, 4),
  Q = diag(1e-3, 4),
  est_Q_0 = F,
  max_T = 10,
  id = sims$res$id, order_ = 1,
  verbose = F,
  model = "exponential"
)
sink()
close(tmp_file)

matplot(seq_len(nrow(sims$betas)) - 1, sims$betas, type = "l", lty = 1)
matplot(result_exp$times, result_exp$a_t_d_s, result_exp$a_t_d_s, type = "l", lty = 2, add = T)



