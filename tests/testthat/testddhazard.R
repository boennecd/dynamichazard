library(survival)

test_that("The head_neck_cancer must be defined for the ddhazard tests",
          expect_true(exists("head_neck_cancer")))

# Test on data set that is one of Farhmiers papers
result = ddhazard(
  formula = survival::Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 1, # Use by month intervals
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
  est_Q_0 = T,
  max_T = 45,
  id = head_neck_cancer$id, order_ = 1
)

test_that("Testing previous computed values vs. current on head and neck cancer set assuming that the previous is correct", {
  expect_equal(c(result$a_t_d_s),
               c(-3.5084644693000375, -3.5148844600373153, -3.1891314791814929, -2.8181185126716946, -2.5133150253138181, -2.0686431883814391, -2.1337664829927272, -2.5088816216986980, -2.7261252524003838, -2.8656346839715456, -3.0022690651419150, -3.2103909019454631, -3.3296886621454438, -3.3797024676574670, -3.2387762301797576, -3.2832268974011902, -3.4010378429506498, -3.4996364628495664, -3.4640927580381167, -3.5454306632739097, -3.5193437650355053, -3.6429455602328522, -3.8148529400485618, -3.9315760725295390, -3.9912270162929087, -4.1221212755199144, -4.2111505273306804, -4.2593181086540230, -4.3955501412991156, -4.5056360495292482, -4.5891834181979796, -4.6463491829253352, -4.6772452961075963, -4.6818100380470060, -4.6597979866888570, -4.6108005184078964, -4.5342715329240795, -4.4295511232451679, -4.4288880723551687, -4.5320293776581728, -4.6212298063525905, -4.6940739120459574, -4.7499759978712248, -4.7915369057959181, -4.8188789577153992, -4.8320508432930724, 0.4360755600018228, 0.4376620032308990,  0.4489331535887380, 0.4629877155198045, 0.4717967889720516, 0.4892432325019014, 0.4906015100905337, 0.4811672226212869, 0.4812410655726153, 0.4807008058089728,  0.4795022646846021, 0.4752694673136330, 0.4750540102025831, 0.4782488768524199, 0.4871715112202827, 0.4868843094919623, 0.4843562325887174, 0.4835935130835331,  0.4867226287750569, 0.4863614783282632, 0.4891031221907462, 0.4848002061937289, 0.4802281967614200, 0.4772168219924643, 0.4758176353352087, 0.4735558899381061,  0.4724962572592801, 0.4726240459881104, 0.4714467634180154, 0.4710489177360688, 0.4714390992094060, 0.4726106938155138, 0.4745588596923577, 0.4772841101671843,  0.4807925107278950, 0.4850950220887917, 0.4902067111479924, 0.4961460340659207, 0.4977474633246664, 0.4949782740709857, 0.4925889375015259, 0.4906451477362695,  0.4891628332671372, 0.4880589755764653, 0.4873303205106824, 0.4869755787235325 ))

  expect_equal(c(result$V_t_d_s),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633, 0.0004392322044566420, 0.0682991240249047060, 0.0003834452042018443,  0.0003834452042018442, 0.0029230271218272539, 0.0912395007549733350, -0.0003397914632747466, -0.0003397914632747466, 0.0052119615712443315,  0.0932049749695377378, -0.0016092541197089715, -0.0016092541197089711, 0.0073429567284740965, 0.0849686813506122934, -0.0030571106681653009, -0.0030571106681653005, 0.0093460739808944281, 0.0774928836229536178, -0.0044064881508436658, -0.0044064881508436658, 0.0112576788942480542,  0.0625786071371585012, -0.0058040178177705924, -0.0058040178177705924, 0.0131038581718835520, 0.0663037854506360463, -0.0066152078662832037, -0.0066152078662832037, 0.0149859903532218054, 0.0802636516361565355, -0.0072606054091964422, -0.0072606054091964422, 0.0169064138433351260,  0.0925945303565963995, -0.0077694160284284882, -0.0077694160284284891, 0.0188521666403896025, 0.1028653949187706279, -0.0082893243691400179, -0.0082893243691400196, 0.0208108298970566402, 0.1134521022635953669, -0.0087341231657698665, -0.0087341231657698665, 0.0227878464846351519,  0.1282127482321499812, -0.0091281359070864241, -0.0091281359070864224, 0.0247818173504978020, 0.1412262999503804406, -0.0096021138204995977, -0.0096021138204995960, 0.0267801536095240260, 0.1518039844431364749, -0.0100679733114127437, -0.0100679733114127437, 0.0287860644548110257,  0.1503781552817381462, -0.0107654864975719258, -0.0107654864975719258, 0.0307850681462566306, 0.1529892913432942814, -0.0114268209514253039, -0.0114268209514253039, 0.0328022104304094425, 0.1623989951758836869, -0.0119988254560485837, -0.0119988254560485837, 0.0348470071785677502,  0.1751405465177472420, -0.0124767948762201323, -0.0124767948762201323, 0.0369196593146410082, 0.1826262222670714253, -0.0130763410888457762, -0.0130763410888457762, 0.0390042849193854013, 0.1921213871302026865, -0.0136031573461606395, -0.0136031573461606395, 0.0411148217076838310,  0.1952137792451406062, -0.0142700820537257390, -0.0142700820537257390, 0.0432374522277687856, 0.2045009115946196943, -0.0150037228119862687, -0.0150037228119862670, 0.0453817496599724785, 0.2197992615605408318, -0.0156403530269492337, -0.0156403530269492302, 0.0475580384562985375,  0.2351742387248771660, -0.0163387197002041323, -0.0163387197002041323, 0.0497535112080704153, 0.2471786691448959739, -0.0171983898818672161, -0.0171983898818672196, 0.0519599789846230259, 0.2633406508519972045, -0.0179758501250396573, -0.0179758501250396607, 0.0541928396098181331,  0.2783570585162779554, -0.0187578421049752302, -0.0187578421049752336, 0.0564447233177911220, 0.2898617445280329274, -0.0196256986326030711, -0.0196256986326030711, 0.0587095922537396175, 0.3070089074201384216, -0.0202566671302706752, -0.0202566671302706752, 0.0610078966170546910,  0.3265517822464923947, -0.0207566923998554545, -0.0207566923998554545, 0.0633316746524540397, 0.3468613597848555496, -0.0211777326575118136, -0.0211777326575118136, 0.0656762424587988280, 0.3669330349624608245, -0.0215496836790728778, -0.0215496836790728778, 0.0680384930107222063,  0.3859999570458617635, -0.0218930814893318545, -0.0218930814893318545, 0.0704161786213701735, 0.4033580584084034970, -0.0222249753911356145, -0.0222249753911356145, 0.0728075543038044365, 0.4182756228156945255, -0.0225620115551172298, -0.0225620115551172298, 0.0752111771525787870,  0.4299395711487184468, -0.0229222709068044872, -0.0229222709068044872, 0.0776257813361121429, 0.4374185315654753881, -0.0233265169857653290, -0.0233265169857653290, 0.0800501930267311507, 0.4389396398028437285, -0.0237873509608388274, -0.0237873509608388274, 0.0824839842388029043,  0.4444370473634537966, -0.0241089985969926528, -0.0241089985969926528, 0.0849399776770060483, 0.4705099679725334716, -0.0239711015900734327, -0.0239711015900734327, 0.0874386019174675511, 0.5127677482774826156, -0.0234537793009185619, -0.0234537793009185619, 0.0899729190136854540,  0.5710035270105234817, -0.0225390051857156867, -0.0225390051857156867, 0.0925406272428825755, 0.6422966612793774566, -0.0213827332568293886, -0.0213827332568293886, 0.0951287192064125264, 0.7296350793987446126, -0.0198916154467032036, -0.0198916154467032036, 0.0977389611802057523,  0.8366982297826955906, -0.0179580979280018482, -0.0179580979280018482, 0.1003735699436583140 ))

  expect_equal(c(result$lag_one_cor),
               c( 0.0006319914823851234, -0.0001813450353835426, -0.0002126117899357636, 0.0004231047677557611, 0.0374926594959537965, -0.0005380017294018889, -0.0005485720017780360, 0.0027985731084827336, 0.0481658093802995874, -0.0016000013589881627, -0.0015949751696787691, 0.0050048137282718962,  0.0456878855983472026, -0.0029587363809467785, -0.0029189483751894322, 0.0070703673493283329, 0.0396604087798715019, -0.0043033008270456190, -0.0042589644753056816, 0.0090269214295090917, 0.0312294200116858406, -0.0056445383104769611, -0.0055052058435728288, 0.0109053718415916372,  0.0277604858121243067, -0.0066868592103896726, -0.0065493515470886115, 0.0127664150516888786, 0.0339237983194087267, -0.0074374459108181770, -0.0074140515313897131, 0.0146609784134950454, 0.0440622779829562689, -0.0081876860923845354, -0.0080158162771978795, 0.0165879425442369867,  0.0532613145041970354, -0.0087846810550449832, -0.0085842409359943670, 0.0185356890963747287, 0.0620030758351880484, -0.0093425048092310777, -0.0091025684196418474, 0.0204997891156617623, 0.0728513701255290580, -0.0097823345080032802, -0.0096128728534951753, 0.0224819052110776137,  0.0852163441699832769, -0.0102462632327539986, -0.0101088730406997656, 0.0244754314202132520, 0.0959330788853532263, -0.0107781511795978276, -0.0105860202161019556, 0.0264754322364910526, 0.1002061921916009707, -0.0114127390024465029, -0.0111391949292140822, 0.0284766937737128793,  0.1007636418466745787, -0.0120573912090688583, -0.0118570640836160000, 0.0304836792486671525, 0.1062366995263799574, -0.0126455551196479089, -0.0125325810037256995, 0.0325131894616143557, 0.1164479435890595910, -0.0131968007123752003, -0.0130824399573795571, 0.0345702739070011394,  0.1259739156939710947, -0.0137649784666452300, -0.0136274381705102868, 0.0366477215003125287, 0.1339397670426479281, -0.0143510749271825982, -0.0141996145156178810, 0.0387441154191005901, 0.1399397952275374390, -0.0149739632061277085, -0.0147895226744024933, 0.0408598614778161312,  0.1457693177465160805, -0.0155839512939056103, -0.0155955638120855878, 0.0429925035951635587, 0.1573951226983123508, -0.0162626012661845898, -0.0163227628857992857, 0.0451516935211992362, 0.1720884528462469087, -0.0169267713220890778, -0.0170279042024082637, 0.0473366336214868441,  0.1853207193021612631, -0.0176966192481461081, -0.0178397971217273306, 0.0495369101392598918, 0.1988822844190729910, -0.0185218493681163360, -0.0186795043672042492, 0.0517557651622434362, 0.2140265293846420891, -0.0193324169287155505, -0.0194536391053007109, 0.0539974391987324484,  0.2269743551126637005, -0.0201775348081844191, -0.0202760450098242243, 0.0562552827877792691, 0.2408827346519127055, -0.0209761004349988504, -0.0210013621236798051, 0.0585361402693362204, 0.2587873461391665963, -0.0215840832784766519, -0.0215509137876134238, 0.0608464935722820149,  0.2783108156512931197, -0.0220822328593056443, -0.0219982908028953338, 0.0631800531920647668, 0.2981521380750243311, -0.0225129962129074074, -0.0223819658897505894, 0.0655329263193361600, 0.3174279954979510876, -0.0229027366724126047, -0.0227258619326826256, 0.0679024304099249548,  0.3354014001863034333, -0.0232710946107934427, -0.0230480112171346438, 0.0702865626215162104, 0.3513521643906739600, -0.0236355450370131226, -0.0233647677843556098, 0.0726837231452698296, 0.3645059125021066215, -0.0240139196073090484, -0.0236931428694739724, 0.0750925529047788837,  0.3739890959881940757, -0.0244259932862989082, -0.0240522839920852098, 0.0775118285517998884, 0.3784535347735979438, -0.0249012435710693411, -0.0244462789870596130, 0.0799407418619832999, 0.3819151740934059180, -0.0253026050600785556, -0.0248317275156184590, 0.0823853873046871965,  0.3973498624532323387, -0.0253572058863496402, -0.0249807749061207209, 0.0848621500522364069, 0.4309121681052292541, -0.0250169074096886247, -0.0246995171538831222, 0.0873779395067437042, 0.4804161596009360879, -0.0243022568530614422, -0.0240233709749064703, 0.0899281997898045693,  0.5444877914482062486, -0.0232369005433537522, -0.0230542772574000854, 0.0925054925093105329, 0.6230475261289992739, -0.0218919395921305972, -0.0217917741796725788, 0.0951040211830674886, 0.7194167882990079033, -0.0201652844689610457, -0.0201377013624211842, 0.0977257666720493107 ))

  # expect_equal(c(result$n_iter),
  #              c(274 ))

  expect_equal(c(result$Q),
               c(0.129221898731263357, 0.002475034806031055, 0.002475034806031055, 0.002645631948634509 ))

  expect_equal(c(result$Q_0),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633, 0.0004392322044566420 ))

  expect_equal(c(result$n_risk),
               c(96, 95, 91, 84, 78, 65, 53, 49, 46, 43, 39, 37, 36, 36, 33, 31, 30, 30, 25, 25, 23, 21, 21, 21, 20, 19, 19, 18, 18, 18, 18, 18, 18, 18, 18, 18, 17, 15, 14, 14, 14, 12, 12, 12, 11 ))

  expect_equal(c(result$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45 ))

  # expect_equal(c(result$hazard_func),
  #              c([[1]]function (eta) {    exp_ = exp(eta)    exp_/(1 + exp_)}<environment: 0x000000001fb07d38> ))
  #
  # expect_equal(c(result$hazard_first_deriv),
  #              c([[1]]function (beta, x_) {    exp_ = exp(beta %*% x_)    x_ * exp_/(exp_ + 1)^2}<environment: 0x000000001fb07d38> ))

  expect_equal(c(result$risk_set),
               c(NA ))

  expect_equal(c(result$order),
               c(1 ))

  expect_equal(c(result$F_),
               c(1, 0, 0, 1 ))
})

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result$Q_0)), rep(c("(Intercept)", "group1"), 2))
})

result_exp = ddhazard(
  formula = survival::Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 1,
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2),
  Q = diag(1e-3, 2),
  est_Q_0 = F,
  max_T = 30,
  id = head_neck_cancer$id, order_ = 1,
  verbose = F,
  model = "exponential"
)

# matplot(result_exp$a_t_d_s, type = "l")
# get_expect_equal(result_exp)

test_that("Result of exponential model on head_neck_data match previous results", {
  expect_equal(c(result_exp$a_t_d_s),
               c(-3.97670917333694840, -3.97674594528922842, -3.67822723844953225, -3.38186160670887448, -3.20803125783379928, -2.81150733914823459, -2.86991583304613229, -3.19339409542700414, -3.33884572499217747, -3.44488663489353897, -3.55468195135890896, -3.74276473988639058, -3.83879589030475188, -3.85491280083719179, -3.69206869970224005, -3.74688315457354149, -3.86422464743509453, -3.94733561401569233, -3.90529955776537419, -3.96708964150362231, -3.92627936981884496, -4.05352095843694382, -4.21056855197516100, -4.31870528617516136, -4.37554856865496156, -4.48030141196976395, -4.54582342572652021, -4.57305289422576866, -4.66140004517541939, -4.72082090785410191, -4.75069382389330297, 0.23643942429448270, 0.23642538963461671, 0.35119909608991445, 0.46549545046933199, 0.53138482409557175,  0.68486304659599784, 0.66299911692218005, 0.53892413086915458, 0.48510875095794093, 0.44552674674974957, 0.40424312760390879,  0.33246258946182772, 0.29654462841347456, 0.29181540205284756, 0.35597679374548952, 0.33497520088953925, 0.28981802576768462,  0.25819314969811624, 0.27468066357009663, 0.25112029063171620, 0.26699776975209677, 0.21721608197843270, 0.15629576896568312,  0.11412921530635921, 0.09164410510332197, 0.05109346037346890, 0.02559506518920458, 0.01479926108810842, -0.01912463326287420, -0.04194359001789783, -0.05341608209319967 ))

  expect_equal(c(result_exp$V_t_d_s),
               c( 0.1832051868721281673, 0.0278848469490704347, 0.0278848469490704381, 0.0803177213322829875, 0.1132034251783800571, -0.0002825347413270007, -0.0002825347413270007, 0.0681138636429205468, 0.1057893643022574104, -0.0037108490430141639, -0.0037108490430141639, 0.0657813363200184242, 0.0933234388646140278, -0.0089983708866558654, -0.0089983708866558654,  0.0628183664969049760, 0.0788715600332714067, -0.0155162728380365406, -0.0155162728380365128, 0.0592778241516741244,  0.0734428605985888855, -0.0165822472363131579, -0.0165822472363131579, 0.0587135297616458440, 0.0591657019120934505, -0.0217911346933305147, -0.0217911346933305217, 0.0563985065119824158, 0.0614045817202078167, -0.0201269492208758713, -0.0201269492208758713, 0.0571887451287438134, 0.0723425094484046460, -0.0145208873097363092, -0.0145208873097363092,  0.0599501350321204399, 0.0803567973399948177, -0.0104885005098428984, -0.0104885005098429001, 0.0620705206328553000,  0.0869387047105238953, -0.0071134417298352650, -0.0071134417298352659, 0.0640036899753111677, 0.0939937589466598167, -0.0034894844498765754, -0.0034894844498765763, 0.0661485628168010653, 0.1056352965671321503, 0.0018561382382013911,  0.0018561382382013894, 0.0690194618275779270, 0.1154879277980833396, 0.0062299728951861078, 0.0062299728951861026,  0.0714630155033750963, 0.1222252055365240092, 0.0092166054186206374, 0.0092166054186206409, 0.0733443351545733369,  0.1171870821646983502, 0.0074167417118372499, 0.0074167417118372429, 0.0733164859929927581, 0.1186200073373010061,  0.0080962739829031592, 0.0080962739829031558, 0.0742920260983656322, 0.1267252242886504343, 0.0113714342440382615,  0.0113714342440382511, 0.0763302459132520761, 0.1368320431509568169, 0.0154106707763921706, 0.0154106707763921637,  0.0787023904830222026, 0.1418229945213846377, 0.0173294366900338045, 0.0173294366900338011, 0.0802302232935526993,  0.1484277775914494280, 0.0199114476530654755, 0.0199114476530654685, 0.0820632817930946612, 0.1488018943776022174,  0.0200040322972981702, 0.0200040322972981771, 0.0829277355347014244, 0.1570037340272072146, 0.0229661973712110210,  0.0229661973712110210, 0.0848786434078876301, 0.1710859655268716084, 0.0282664666087455024, 0.0282664666087455094,  0.0877901216774502752, 0.1865428085371889089, 0.0340275035065738946, 0.0340275035065738946, 0.0908764893254096623,  0.2014834476666247376, 0.0394535520998959832, 0.0394535520998959902, 0.0938003636583288197, 0.2229019052396607470,  0.0473425660283096975, 0.0473425660283097044, 0.0976811265666991113, 0.2487790398587779450, 0.0569349094050815366,  0.0569349094050815435, 0.1022282780020242754, 0.2799374204675383337, 0.0684956253291079536, 0.0684956253291079675,  0.1075214163665750289, 0.3289519028931106037, 0.0869897747611888261, 0.0869897747611888261, 0.1155225124818885507,  0.3996377264490825754, 0.1138172549902054936, 0.1138172549902054936, 0.1267411842245389220 ))

  expect_equal(c(result_exp$lag_one_cor),
               c( 0.1031151556577854234, -0.0025673007890856248, -0.0041177019347565513, 0.0671738953591519139, 0.0729285502330940805, -0.0153665974737224043, -0.0163223793842787457, 0.0611807158610895852, 0.0644065921154819421, -0.0192288355867880623, -0.0200771554947000441, 0.0587459567274195293, 0.0535427330021189529, -0.0239158942554452691, -0.0251883169614478958,  0.0558824984363825716, 0.0464796572600867930, -0.0275860737664426203, -0.0268684891017166583, 0.0542637414978720672,  0.0392122788902791175, -0.0294064481771485198, -0.0293297471017429506, 0.0532084301672932219, 0.0356480065351482064, -0.0305448770356387816, -0.0298416548856658831, 0.0528117325314924682, 0.0391007556490918923, -0.0284712115615889730, -0.0270759696825927688, 0.0541164525517244047, 0.0455860098549121379, -0.0246247696130386419, -0.0236000239726060282,  0.0561089074393790813, 0.0509999785363083741, -0.0216239631152422562, -0.0206527528940453828, 0.0578530091473455632,  0.0562916820073403254, -0.0187677945664524483, -0.0176931041764787911, 0.0596626970982066657, 0.0638551422142593222, -0.0149661074687492766, -0.0139066474561677852, 0.0619031698774247519, 0.0731667066769392804, -0.0105326229049919270, -0.0097298238679709072, 0.0643460593649873014, 0.0805695408224628151, -0.0071133009784132770, -0.0064778750491979904,  0.0663753078027907867, 0.0813318588316555291, -0.0064375392389208665, -0.0060344261003749443, 0.0672889043995953118,  0.0797084297205427755, -0.0069327416786996027, -0.0065228958987601513, 0.0677886978908447263, 0.0839155137757939540, -0.0051944934955948895, -0.0047410661895154194, 0.0692114369860178241, 0.0921739318284499620, -0.0018678257622304888, -0.0014075992625329978, 0.0712902662011879601, 0.0992140159350134720, 0.0009836567781669348, 0.0013068741186968123,  0.0731646605524272076, 0.1045839525483038546, 0.0030432240366696992, 0.0034174257987806232, 0.0747811495072748106,  0.1078806901256837703, 0.0043465972131570517, 0.0046400514000073771, 0.0761011970976562674, 0.1118466302783495819,  0.0058133786026677743, 0.0059801473520385215, 0.0774610865836157098, 0.1222694919469353436, 0.0096261272420231150,  0.0098751951619719461, 0.0797852602660696492, 0.1363267096938496348, 0.0149120552743186169, 0.0151021452356542747,  0.0826785580752974619, 0.1509511601798297353, 0.0203473430664968327, 0.0204124280247277787, 0.0855987685722870567,  0.1683981812721982996, 0.0267338143382507831, 0.0267771885593782767, 0.0888925354534749884, 0.1913172634181187770,  0.0351973298712989283, 0.0352340798926058796, 0.0929984973894393968, 0.2191117948941448679, 0.0455237478712123000,  0.0455043952847125482, 0.0978116210372377975, 0.2579818125849921984, 0.0600511874735620288, 0.0600949580273164030,  0.1042783059265411510, 0.3163625819533421035, 0.0821479346489345230, 0.0821887053999010020, 0.1136704668433825699 ))

  expect_equal(c(result_exp$n_iter),
               c(66 ))

  expect_equal(c(result_exp$Q),
               c(0.09946932732012863, 0.03783300224988726, 0.03783300224988726, 0.01543663831742442 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("EKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))
})

test_that("poisson model and logit moels hazzard functions differs", {
  expect_true(result_exp$model != result$model)
  expect_true(toString(body(result_exp$hazard_func)) !=
                toString(body(result$hazard_func)))
  expect_true(toString(body(result_exp$hazard_first_deriv)) !=
                toString(body(result$hazard_first_deriv)))
})

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result_exp$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result_exp$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result_exp$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result_exp$Q_0)), rep(c("(Intercept)", "group1"), 2))
})


# Change by argument
result_exp = ddhazard(
  formula = survival::Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 2,
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2),
  Q = diag(1e-3, 2),
  est_Q_0 = F,
  max_T = 30,
  id = head_neck_cancer$id, order_ = 1,
  verbose = F,
  model = "exponential"
)

# matplot(result_exp$a_t_d_s, type = "l")
# get_expect_equal(result_exp)

test_that("Result of exponential model on head_neck_data match previous results with altered by argument", {
  expect_equal(c(result_exp$a_t_d_s),
               c(-3.66470254910492965, -3.66474706370252523, -2.76810021608623336, -2.37016905577829462, -2.88527701004363868, -3.09784986345455149, -3.48266257367868359, -3.53409599869474356, -3.50452999032306378, -3.68733386046285716, -3.75440297910365439, -3.92931420996290637, -4.13536817561038994, -4.31353242824072147, -4.29415086207046315, -4.44742781342733640, 0.14460881063442274, 0.14458966333745016,  0.54220314703993744, 0.71686313456859296, 0.48814165025303158, 0.39660025957471889, 0.22674612731683766, 0.20698865962895394,  0.22015367692421495, 0.13937097843449658, 0.10943794134073426, 0.02931587668643268, -0.06355936873028328, -0.14352365432290462, -0.13606103184196280, -0.20391357029043852 ))

  expect_equal(c(result_exp$V_t_d_s),
               c( 0.2239954769849443750, 0.0655923866343257334, 0.0655923866343257472, 0.0856850342803099352, 0.0701094856476841277, -0.0038922715688509135, -0.0038922715688509135, 0.0523721592627481858, 0.0755056468311222084, -0.0019795481071096244, -0.0019795481071096105, 0.0514742546248752875, 0.0459893287640510268, -0.0168002899428832814, -0.0168002899428832814,  0.0428520247345924449, 0.0395383065657095717, -0.0176668807846101159, -0.0176668807846101159, 0.0427380304585478071,  0.0554849050799214386, -0.0083268844417649975, -0.0083268844417650027, 0.0482405628816991311, 0.0685881166264916964, -0.0008915346260135876, -0.0008915346260135910, 0.0530967481749607603, 0.0917314760624167724, 0.0105768571207504984,  0.0105768571207505019, 0.0598970756325017256, 0.1029505276277184328, 0.0162964559289216979, 0.0162964559289216944,  0.0641352931380022306, 0.1037258639501149188, 0.0164485880804922657, 0.0164485880804922657, 0.0656497098810895630,  0.1265921801941821134, 0.0268701800644146269, 0.0268701800644146269, 0.0721116488290027280, 0.1394313143521199172,  0.0328068306908046725, 0.0328068306908046725, 0.0766830420360093551, 0.1583797329998488101, 0.0408462387555405329,  0.0408462387555405260, 0.0820262021138331576, 0.1897619001198406763, 0.0541928541421161369, 0.0541928541421161369,  0.0897223868891949550, 0.2404909896530670887, 0.0760800199433048219, 0.0760800199433048219, 0.1012582172983322176,  0.3106678049553517895, 0.1062117278334599041, 0.1062117278334599041, 0.1163272984336688326 ))

  expect_equal(c(result_exp$lag_one_cor),
               c( 0.0581028385172765310, -0.0072444734259627663, -0.0091541950837004671, 0.0507854295613683060, 0.0305719789171202405, -0.0205541704126560032, -0.0217954718525925212, 0.0429534684036514680, 0.0256335909301954809, -0.0232916444899874189, -0.0256021168272291474, 0.0396164859822722010, 0.0217562109295342289, -0.0268049576003472970, -0.0251706803089071125,  0.0380668354484768462, 0.0208436994532727946, -0.0254916865534527692, -0.0231220640448812874, 0.0396078590805537395,  0.0243612892264773936, -0.0218239875294321505, -0.0198641722726530523, 0.0425826594850195056, 0.0314033017870680442, -0.0171719045857336335, -0.0155045036084438571, 0.0462019832669743127, 0.0410358093169969629, -0.0117507577680532344, -0.0104671739924645686, 0.0502204627419419736, 0.0447135283650619969, -0.0094214520125273163, -0.0089886987863954937,  0.0526366994782183420, 0.0519460678887981378, -0.0064314589218757625, -0.0054966721024843051, 0.0557115478144272411,  0.0648237411726153845, -0.0004605667099179742, 0.0004626102810896780, 0.0602421445696742427, 0.0767237353479582607,  0.0050357523477366044, 0.0053979315269180438, 0.0644122809169798000, 0.0966036776555502241, 0.0134711383782364705,  0.0136579634961798840, 0.0698906297153868428, 0.1309471159607265567, 0.0281201853999506271, 0.0282851940496364022,  0.0781842396764870357, 0.1847772952660913237, 0.0513669286489622026, 0.0511865485567550155, 0.0901853413511809893 ))

  expect_equal(c(result_exp$n_iter),
               c(24 ))

  expect_equal(c(result_exp$Q),
               c(0.11112544355142200, 0.04881121798770979, 0.04881121798770979, 0.02253873603135799 ))

  expect_equal(c(result_exp$Q_0),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$order),
               c(1 ))

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 1 ))

  expect_equal(c(result_exp$method),
               c("EKF" ))

  expect_equal(c(result_exp$model),
               c("exponential" ))

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE ))
})

set.seed(3787)
sims <- test_sim_func_logit(n_series = 5e2, n_vars = 3, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = -.5, re_draw = T, beta_start = 0,
                            intercept_start = -4, sds = c(.1, rep(1, 3)))

test_that("Chaning time scale in EKF does no change results when other parems are changed accoridngly",{
  for(m in c("logit")){
    arg_list <- list(formula = survival::Surv(tstart, tstop, event) ~ . - tstart - tstop - event - id,
                     by = 1,
                     data = sims$res,
                     a_0 = rep(0, ncol(sims$res) + 1 - 4),
                     Q_0 = diag(rep(1e2, ncol(sims$res) + 1 - 4)),
                     Q = diag(rep(1e-3, ncol(sims$res) + 1 - 4)),
                     est_Q_0 = F, method = "EKF",
                     model = m,
                     eps = 1e-2, id = sims$res$id,
                     verbose = F,
                     max_T = 10)

    res <- do.call(ddhazard, arg_list)

    sim_tmp <- sims
    t_mult <- 2.5
    sim_tmp$res$tstart <- sim_tmp$res$tstart * t_mult
    sim_tmp$res$tstop <- sim_tmp$res$tstop * t_mult
    arg_list$data <- sim_tmp$res
    arg_list$by <- t_mult
    arg_list$max_T <- arg_list$max_T * t_mult
    arg_list$Q <- arg_list$Q / t_mult

    res_new_time <- do.call(ddhazard, arg_list)

    expect_equal(res$a_t_d_s, res_new_time$a_t_d_s)
    expect_equal(res$V_t_d_s, res_new_time$V_t_d_s)
    expect_equal(res$Q, res_new_time$Q * t_mult)
  }
})

set.seed(93143)
sims <- test_sim_func_exp(n_series = 1e4, n_vars = 10, t_0 = 0, t_max = 10,
                          x_range = 1, x_mean = 0, re_draw = T, beta_start = 0,
                          intercept_start = -5, sds = c(.1, rep(1, 10)))
# sum(sims$res$event)

# tmp_file <- file("exponential.log")
# sink(tmp_file)
result_exp = ddhazard(
  formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
  data = sims$res,
  by = (by_ <- 1),
  n_max = 10^4, eps = 10^-2,
  a_0 = rep(0, 11),
  Q_0 = diag(100, 11),
  Q = diag(1e-3, 11),
  est_Q_0 = F,
  max_T = 10,
  id = sims$res$id, order_ = 1,
  verbose = F,
  model = "exponential"
)
# sink()
# close(tmp_file)

# matplot(seq_len(nrow(sims$betas)) - 1, sims$betas, type = "l", lty = 1)
# matplot(result_exp$times, result_exp$a_t_d_s, result_exp$a_t_d_s, type = "l", lty = 2, add = T)

# get_expect_equal(result_exp, eps = 1e-4)

test_that("Result of exponential model on simulated data match previous results", {
  expect_equal(c(result_exp$a_t_d_s),
               c(-4.640329418961689711, -4.640311766860333975, -4.550993716932300259, -4.614838232628359016, -4.590891349476680539, -4.483467751741047280, -4.620637086244515856, -4.769813573994810874, -4.834326602234911618, -4.420605486029085540, -4.522868823865070276, 0.108345857091244557,  0.108472795634152741, -0.574982799530977196,  0.790821791521778006, 0.462522131218285393,  0.741176255970951048, 1.662081263827061450,  1.218647636247403465, 0.520025832615314099,  1.520853548099621477, 1.342364937417941384, -0.980910103461468008, -0.980905079476531161, -1.362996269980152331, -1.943979461581122115, -0.896711188318529251, -0.796535023029323774, -1.112661682941282981, -0.841716141651764782, -0.550477441856325855, -0.642644225601545327, -0.618138368717568998, -0.754224984784127694, -0.754200624900805416, -0.788904437921154722, -0.557114971054176400, 0.415567791391985020,  0.321219270755635944, 1.461815532449772137,  0.484343300960016987, -0.193083044042183183, -0.653738097514472205, -0.382721394921686053,  0.153847106122297267, 0.153984027075844299, -0.445255522796064285, 0.006278680791956918, -0.568872617408898940, -2.274651669695434641, -2.093718712809232496, -2.649177800126587989, -2.805889903759887005, -2.278609668896209417, -2.186761173069662778, -0.410154721889328333, -0.410028359472936754, -1.147912375002044794,  0.438670043333295789, 0.988621714092581039,  1.612682191261204601, 1.853587289512433456,  1.765024528958099248, 1.396795100013246360,  2.527779109710122540, 2.916099556954488747,  0.455369136459581880, 0.455539063500897512, -0.344643233755345502, 0.432820604337723625, -0.851966936021706589, -2.126495377855946334, -1.160812329735334325, -2.030507621363687232, -2.659564983143259731, -1.697804887232084781, -2.300761296983134141, 1.213981211608250899,  1.213739185320517056, 2.785633891804850659,  3.080709470260670102, 3.825089897538360262,  6.857321716868564287, 6.641668733651932222,  7.318533323545573843, 7.225595798536540215,  6.278779949233827651, 6.783357454666566255,  1.054974670603961995, 1.055110910450279826,  1.243016026391027262, 2.275009656606971742,  1.092902596211767996, -2.088097969823934807, -2.179778570732250564, -3.374668222919637195, -3.547010894772613554, -3.417122812824165745, -2.345477652809819347, 1.580097001652849720,  1.580058711082584555, 2.679552462283008474,  3.982926973903154089, 3.297411036836860543,  2.812735434210210883, 2.542557869546920202,  2.202226035718871877, 2.042681301050722542,  1.749984414882722383, 3.033427120112164310,  0.466858693294694205, 0.466911788611974909,  0.478847962429469753, 0.173653352548069406, -0.192344270932538863, -2.241004496826659587, -2.053259957928407875, -2.887074026869891785, -2.926252067962812564, -3.318223550335067440, -3.077882562020491264 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$V_t_d_s),
               c( 5.047976444636504e-02, 5.942096185760885e-02, -5.223214712732005e-03, -9.078723474652278e-03,  1.266231658265813e-02, 5.489765440005432e-02,  5.640344477433554e-02, -3.154764710067853e-02, -3.131431589241730e-02, -4.146554666849281e-02, -3.256353105833033e-02, 5.942096185760886e-02,  4.979812327542419e-01, -8.979724712928039e-02,  2.120135065133363e-01, 1.917236926086087e-01,  4.618185844636104e-01, 4.084232381607681e-01, -1.926353970694745e-01, 1.429560233059880e-01,  3.000265703060580e-02, -4.847806468910389e-02, -5.223214712732001e-03, -8.979724712928039e-02,  1.597035017307178e-01, -2.040893990297709e-02, -9.997936191108597e-02, 1.845121336137295e-02, -1.909167116301572e-01, 6.748490890080355e-02, -2.729710779875338e-01, -1.898270272854460e-01, -1.095220005863721e-01, -9.078723474652281e-03,  2.120135065133362e-01, -2.040893990297709e-02,  4.870326386797643e-01, 5.876783597855331e-02,  1.320482276906168e-01, 1.614385196887380e-01, -2.261386219226088e-03, 1.141456560154707e-01,  3.814379469710372e-02, 1.312530882458422e-01,  1.266231658265812e-02, 1.917236926086087e-01, -9.997936191108601e-02, 5.876783597855328e-02,  5.256318667198769e-01, 7.345873589343040e-02,  5.600437320696918e-01, -8.570694633596697e-01,  8.508739632492931e-01, 1.250938444289149e-01,  4.573233787957925e-01, 5.489765440005430e-02,  4.618185844636104e-01, 1.845121336137294e-02,  1.320482276906168e-01, 7.345873589343038e-02,  6.705982381815261e-01, 1.373236843250485e-01,  6.895992677330283e-02, -1.790454882188923e-02,  1.031466068353063e-01, -2.451062726280972e-01,  5.640344477433554e-02, 4.084232381607680e-01, -1.909167116301572e-01, 1.614385196887380e-01,  5.600437320696919e-01, 1.373236843250485e-01,  8.267809247795697e-01, -9.376877472417783e-01,  7.745236588305584e-01, 7.777609815334900e-03,  4.336885586148986e-01, -3.154764710067853e-02, -1.926353970694745e-01, 6.748490890080357e-02, -2.261386219226110e-03, -8.570694633596697e-01,  6.895992677330287e-02, -9.376877472417784e-01,  1.658260940007182e+00, -1.206333856213852e+00,  1.349318314613122e-01, -7.834079981842947e-01, -3.131431589241728e-02, 1.429560233059879e-01, -2.729710779875336e-01, 1.141456560154707e-01,  8.508739632492931e-01, -1.790454882188924e-02,  7.745236588305583e-01, -1.206333856213851e+00,  1.792118456839944e+00, 6.484736194465113e-01,  9.166943391253495e-01, -4.146554666849281e-02,  3.000265703060581e-02, -1.898270272854460e-01,  3.814379469710374e-02, 1.250938444289148e-01,  1.031466068353062e-01, 7.777609815334867e-03,  1.349318314613122e-01, 6.484736194465112e-01,  6.613112260553748e-01, 1.716240655731736e-01, -3.256353105833034e-02, -4.847806468910395e-02, -1.095220005863721e-01, 1.312530882458422e-01,  4.573233787957925e-01, -2.451062726280973e-01,  4.336885586148986e-01, -7.834079981842945e-01,  9.166943391253495e-01, 1.716240655731737e-01,  6.264803777310277e-01, 5.818727571694549e-03,  1.262438161456028e-04, 3.600061123615382e-03,  1.544004465715114e-03, -2.694623954347131e-04,  1.780995984605714e-03, -1.763963190303177e-04, -3.419081701221544e-03, -4.533237219255594e-03, -6.771287597439619e-03, -1.118990499156932e-03,  1.262438161455995e-04, 2.274151071432750e-02, -6.140951391686788e-03, 6.373292998407138e-03,  2.856359737841881e-03, 1.357075132640078e-02,  1.397134537831622e-02, 3.857378801434785e-04, -3.172829363208935e-03, 7.436122551418740e-04, -6.519806177090011e-03, 3.600061123615382e-03, -6.140951391686775e-03, 1.948346510848866e-02,  3.185184497027486e-03, 2.006727256530956e-03,  8.312244923504278e-03, -1.211684319238674e-02, -6.558656810597922e-03, -1.170460675088519e-03, -8.147540996787538e-03, 4.208732788384436e-04,  1.544004465715113e-03, 6.373292998407162e-03,  3.185184497027499e-03, 4.303636019447936e-02, -1.854622953621046e-03, 1.110810812018847e-03,  1.889562405216926e-03, 5.375135767218158e-03, -5.759933993917739e-04, -2.515464579673798e-03,  1.003964829579445e-02, -2.694623954347143e-04,  2.856359737841842e-03, 2.006727256530934e-03, -1.854622953621060e-03, 1.211187091717125e-02,  4.069370220893716e-03, 4.876906439511650e-03, -1.132975557348766e-02, 9.435344008069715e-03,  2.694425071224308e-04, 2.975823811688751e-03,  1.780995984605716e-03, 1.357075132640077e-02,  8.312244923504275e-03, 1.110810812018863e-03,  4.069370220893671e-03, 3.713165075755478e-02, -2.769526355701791e-03, -1.210747988129526e-03,  2.160193019635335e-03, 3.591625825641818e-03, -9.804859513257581e-03, -1.763963190303155e-04,  1.397134537831622e-02, -1.211684319238672e-02,  1.889562405216931e-03, 4.876906439511620e-03, -2.769526355701797e-03, 2.815231082070524e-02, -7.655436656436176e-03, 5.760001204812564e-04, -5.627501306059248e-03, 1.840945533056586e-03, -3.419081701221546e-03, 3.857378801434510e-04, -6.558656810597914e-03, 5.375135767218135e-03, -1.132975557348764e-02, -1.210747988129494e-03, -7.655436656436154e-03, 3.643622872495084e-02, -7.677998972437951e-03, 1.200073681017258e-02, -6.993576618659705e-03, -4.533237219255595e-03, -3.172829363208914e-03, -1.170460675088472e-03, -5.759933993917915e-04, 9.435344008069713e-03,  2.160193019635321e-03, 5.760001204812613e-04, -7.677998972437909e-03, 3.214829287624230e-02,  1.671854267198206e-02, 1.148131199773626e-02, -6.771287597439616e-03, 7.436122551418915e-04, -8.147540996787564e-03, -2.515464579673779e-03,  2.694425071224324e-04, 3.591625825641802e-03, -5.627501306059282e-03, 1.200073681017256e-02,  1.671854267198206e-02, 3.187824655394818e-02,  1.775689801057896e-04, -1.118990499156930e-03, -6.519806177090057e-03, 4.208732788384020e-04,  1.003964829579445e-02, 2.975823811688740e-03, -9.804859513257540e-03, 1.840945533056601e-03, -6.993576618659765e-03, 1.148131199773619e-02,  1.775689801058490e-04, 1.784634074230639e-02,  4.867520091884474e-03, 2.931852322295813e-04,  2.782232607263124e-03, 9.694566790729146e-04, -2.215119884032467e-04, 1.125020956407128e-03,  2.484404537058639e-04, -2.526968688104035e-03, -3.652285063252378e-03, -5.716716196632591e-03, -1.160623121328822e-03, 2.931852322295758e-04,  2.008113359881302e-02, -4.910539212626836e-03,  5.951876055023292e-03, 2.704175840679183e-03,  1.259927784544745e-02, 1.227604657616855e-02, -2.361920749531710e-05, -2.563108880605941e-03,  2.534325648852608e-04, -5.631465777837545e-03,  2.782232607263117e-03, -4.910539212626836e-03,  1.593673365098888e-02, 2.037001401178432e-03,  1.524699251273278e-03, 7.065953145871664e-03, -9.932594220997366e-03, -5.267048373655530e-03, -1.144758498245893e-03, -6.429227220462998e-03,  6.461217704969421e-05, 9.694566790729170e-04,  5.951876055023305e-03, 2.037001401178439e-03,  3.775327122377364e-02, -1.431569105397356e-03,  1.078555115412519e-03, 2.158589627172442e-03,  5.174148989583011e-03, 5.704761825689761e-04, -1.033015612538175e-03, 9.140157460928659e-03, -2.215119884032591e-04, 2.704175840679167e-03,  1.524699251273258e-03, -1.431569105397363e-03,  1.061307065474743e-02, 3.772317438125509e-03,  4.643085199245575e-03, -1.023000580228942e-02,  8.525592417597143e-03, 3.119993378890696e-04,  2.882150010122053e-03, 1.125020956407130e-03,  1.259927784544741e-02, 7.065953145871660e-03,  1.078555115412530e-03, 3.772317438125472e-03,  3.295139310557337e-02, -2.117219971547685e-03, -7.976030129196094e-04, 1.995030484605571e-03,  3.636494777616651e-03,
                  -9.003897122932052e-03,  2.484404537058641e-04, 1.227604657616856e-02, -9.932594220997360e-03, 2.158589627172440e-03,  4.643085199245568e-03, -2.117219971547713e-03,  2.458318694009202e-02, -7.762317929809138e-03,  5.970050505416023e-04, -5.672928805895467e-03,  1.844243505923207e-03, -2.526968688104042e-03, -2.361920749533310e-05, -5.267048373655520e-03,  5.174148989582995e-03, -1.023000580228938e-02, -7.976030129195915e-04, -7.762317929809126e-03,  3.219188560856599e-02, -6.750364746506870e-03,  1.101542794557540e-02, -6.305185107256436e-03, -3.652285063252377e-03, -2.563108880605946e-03, -1.144758498245839e-03, 5.704761825689629e-04,  8.525592417597240e-03, 1.995030484605566e-03,  5.970050505416307e-04, -6.750364746506820e-03,  2.895269736973003e-02, 1.546828276987066e-02,  1.059954122239887e-02, -5.716716196632592e-03,  2.534325648852832e-04, -6.429227220463017e-03, -1.033015612538179e-03, 3.119993378890431e-04,  3.636494777616643e-03, -5.672928805895481e-03,  1.101542794557541e-02, 1.546828276987065e-02,  2.845624605409663e-02, 6.468518870157899e-04, -1.160623121328831e-03, -5.631465777837572e-03,  6.461217704965995e-05, 9.140157460928659e-03,  2.882150010121991e-03, -9.003897122932021e-03,  1.844243505923190e-03, -6.305185107256497e-03,  1.059954122239883e-02, 6.468518870157945e-04,  1.600617220779430e-02, 4.915916771389655e-03,  1.504643176735653e-03, 2.267186436462472e-03,  5.532007448717613e-04, 1.057525270848222e-03,  2.244022688670431e-03, 2.082403867837502e-03, -5.047553173127212e-03, -2.475863849095017e-03, -5.900170551417653e-03, -6.349550576700764e-04,  1.504643176735650e-03, 1.274964211851494e-02, -3.405034378290580e-03, 3.361589416270198e-03,  1.468356636412900e-03, 7.104695894966350e-03,  7.526942310925273e-03, 3.503579126045738e-04, -1.349076016394272e-03, 5.146710136991322e-04, -3.269033958005918e-03, 2.267186436462471e-03, -3.405034378290577e-03, 1.092858309521149e-02,  1.277367816067912e-03, 9.433254500774337e-04,  4.262370905808248e-03, -6.380382223934012e-03, -3.254651741738546e-03, -3.902434215624480e-04, -3.995906580888275e-03, 2.091405351993442e-04,  5.532007448717617e-04, 3.361589416270208e-03,  1.277367816067916e-03, 2.347046882253401e-02, -1.081935483603735e-03, 5.700352366268655e-04,  8.702494291174714e-04, 3.685546539940436e-03,  3.226564328852394e-04, -3.614432396699175e-04,  5.337616222593435e-03, 1.057525270848217e-03,  1.468356636412875e-03, 9.433254500774335e-04, -1.081935483603757e-03, 7.545593885410927e-03,  2.167018462490014e-03, 2.918633445095581e-03, -6.498802542185966e-03, 5.687503596604044e-03,  3.572042734227329e-04, 1.879661485165897e-03,  2.244022688670432e-03, 7.104695894966347e-03,  4.262370905808267e-03, 5.700352366268732e-04,  2.167018462489987e-03, 2.074958810314191e-02, -1.442035172338567e-03, -3.239542394249771e-04,  1.719236277775055e-03, 2.440286765167557e-03, -5.090239633997934e-03, 2.082403867837504e-03,  7.526942310925298e-03, -6.380382223934016e-03,  8.702494291174743e-04, 2.918633445095567e-03, -1.442035172338594e-03, 1.650330606881262e-02, -5.184852563882368e-03, 5.236014529329792e-04, -3.762408996772056e-03, 1.198083815825637e-03, -5.047553173127213e-03, 3.503579126045540e-04, -3.254651741738558e-03, 3.685546539940423e-03, -6.498802542185959e-03, -3.239542394249641e-04, -5.184852563882360e-03, 2.252565761952155e-02, -4.850534712594798e-03, 7.034946780720955e-03, -4.168791964240825e-03, -2.475863849095018e-03, -1.349076016394274e-03, -3.902434215624474e-04,  3.226564328852380e-04, 5.687503596604102e-03,  1.719236277775043e-03, 5.236014529329742e-04, -4.850534712594769e-03, 1.913498052288909e-02,  9.523640448027552e-03, 6.534761510828735e-03, -5.900170551417653e-03, 5.146710136991484e-04, -3.995906580888286e-03, -3.614432396699183e-04,  3.572042734226731e-04, 2.440286765167564e-03, -3.762408996772061e-03, 7.034946780720934e-03,  9.523640448027546e-03, 1.933521545365383e-02,  2.426220103744389e-04, -6.349550576700778e-04, -3.269033958005949e-03, 2.091405351993437e-04,  5.337616222593447e-03, 1.879661485165854e-03, -5.090239633997913e-03, 1.198083815825655e-03, -4.168791964240861e-03, 6.534761510828731e-03,  2.426220103744290e-04, 1.048292030266827e-02,  5.108583041610280e-03, -9.619322925421885e-04,  2.869093151346226e-03, 2.185797267391859e-04, -3.065382423559301e-05, -4.634078306608441e-04,  3.497192071749009e-04, -4.428129876728065e-03, -3.807943638323504e-03, -7.071366256152093e-03, -1.571967992126945e-04, -9.619322925421917e-04,  9.587335290697600e-03, -2.524796713462719e-03,  2.619180510933472e-03, 1.195173255159028e-03,  4.773153812798031e-03, 5.308567259142000e-03,  1.603628618153916e-04, -8.358577845388991e-04,  5.718918020448930e-04, -2.050730661204755e-03,  2.869093151346226e-03, -2.524796713462704e-03,  9.169857618579975e-03, 1.074813802351219e-03,  6.590019708496509e-04, 3.646742804740755e-03, -4.978403110663396e-03, -2.752571150554949e-03, -7.705453454369051e-04, -3.832009540829671e-03, -4.839950112265262e-05, 2.185797267391859e-04,  2.619180510933477e-03, 1.074813802351218e-03,  1.789191272015759e-02, -6.283241899375360e-04,  2.940266656015616e-04, 7.597846578789359e-04,  2.393959467603159e-03, -8.047210456256836e-05, -7.516854358543163e-04, 3.920114694374846e-03, -3.065382423560030e-05, 1.195173255159026e-03,  6.590019708496528e-04, -6.283241899375567e-04,  6.063262963191578e-03, 1.885205298262910e-03,  1.973162443242304e-03, -4.653783491009490e-03,  4.602476751632494e-03, 7.838505455045597e-04,  1.472012041420437e-03, -4.634078306608432e-04,  4.773153812798009e-03, 3.646742804740756e-03,  2.940266656015666e-04, 1.885205298262891e-03,  1.538933380708564e-02, -1.690925230524547e-03, -7.399867608264840e-04, 1.668709547235864e-03,  1.903259968898524e-03, -3.289864324192730e-03,  3.497192071749021e-04, 5.308567259141994e-03, -4.978403110663396e-03, 7.597846578789394e-04,  1.973162443242304e-03, -1.690925230524550e-03,  1.245794683907869e-02, -3.551230213679256e-03,  1.752680276838608e-04, -2.752906659221839e-03,  1.021334234833998e-03, -4.428129876728070e-03,  1.603628618153643e-04, -2.752571150554939e-03,  2.393959467603170e-03, -4.653783491009494e-03, -7.399867608264775e-04, -3.551230213679243e-03,  1.741811990139091e-02, -3.260102356266601e-03,  5.639083258706670e-03, -2.876806173890462e-03, -3.807943638323505e-03, -8.358577845388965e-04, -7.705453454369019e-04, -8.047210456256008e-05,  4.602476751632518e-03, 1.668709547235866e-03,  1.752680276838598e-04, -3.260102356266599e-03,  1.608758112223290e-02, 9.003045627931548e-03,  5.055314711797342e-03, -7.071366256152089e-03,  5.718918020448994e-04, -3.832009540829668e-03, -7.516854358543133e-04, 7.838505455045434e-04,  1.903259968898497e-03, -2.752906659221833e-03,  5.639083258706635e-03, 9.003045627931557e-03,  1.745928729163508e-02, 5.778266812459106e-04, -1.571967992126937e-04, -2.050730661204776e-03, -4.839950112265614e-05, 3.920114694374841e-03,  1.472012041420385e-03, -3.289864324192711e-03,  1.021334234834006e-03, -2.876806173890425e-03,  5.055314711797359e-03, 5.778266812459204e-04,  7.930325061386910e-03, 5.306697773431113e-03, -4.207950504676769e-04, 1.473199844296815e-03, -1.065960869467364e-03, 1.054634960161757e-03, -1.327393050355871e-03, 2.633608283808650e-03, -6.450369128653577e-03, -2.117054956613472e-03,
                  -6.616429231713152e-03, 5.904910834944888e-04, -4.207950504676787e-04, 1.047163698712043e-02, -2.768305343664087e-03, 2.871332594290260e-03,  1.376931296643471e-03, 5.908353136703008e-03,  6.341573589021028e-03, -6.396631981886626e-05, -8.472556776475732e-04, 3.900509590446765e-04, -2.408204827222355e-03, 1.473199844296816e-03, -2.768305343664057e-03, 9.594588922003211e-03,  1.534365983910977e-03, 6.115178986417234e-04,  4.088194167484060e-03, -5.906168572659317e-03, -3.120732369497139e-03, -1.146778430343214e-03, -4.139110687788120e-03, -6.941946879708827e-05, -1.065960869467363e-03, 2.871332594290264e-03,  1.534365983910968e-03, 1.933880380819483e-02, -6.093745560774463e-04, 5.411841946218186e-04,  6.674821608835819e-04, 2.400321723850110e-03, -9.906206733259707e-05, -1.041682092440952e-03,  4.483951924809145e-03, 1.054634960161758e-03,  1.376931296643451e-03, 6.115178986417116e-04, -6.093745560774553e-04, 5.851552498943461e-03,  2.211667622792266e-03, 2.398566190741737e-03, -5.301378108343343e-03, 4.604709279775138e-03,  4.770002280641050e-04, 1.515955348780120e-03, -1.327393050355870e-03, 5.908353136702976e-03,  4.088194167484064e-03, 5.411841946218171e-04,  2.211667622792237e-03, 1.719016850343427e-02, -1.798270967884503e-03, -9.824488594804613e-04,  1.661604466095464e-03, 2.067495127533269e-03, -4.111383144044353e-03, 2.633608283808652e-03,  6.341573589021033e-03, -5.906168572659313e-03,  6.674821608835874e-04, 2.398566190741727e-03, -1.798270967884507e-03, 1.432705975092105e-02, -4.579798946218511e-03, 4.450464746780343e-04, -3.037127666760524e-03, 1.145029310675893e-03, -6.450369128653575e-03, -6.396631981888366e-05, -3.120732369497160e-03, 2.400321723850132e-03, -5.301378108343321e-03, -9.824488594804544e-04, -4.579798946218508e-03, 1.929903902593924e-02, -3.274351445483045e-03, 6.951923575775612e-03, -3.155676485614452e-03, -2.117054956613479e-03, -8.472556776475621e-04, -1.146778430343209e-03, -9.906206733259055e-05, 4.604709279775195e-03,  1.661604466095456e-03, 4.450464746780456e-04, -3.274351445482976e-03, 1.625393910001056e-02,  9.479092517869651e-03, 5.198353399205903e-03, -6.616429231713145e-03, 3.900509590446937e-04, -4.139110687788110e-03, -1.041682092440954e-03,  4.770002280640591e-04, 2.067495127533263e-03, -3.037127666760535e-03, 6.951923575775528e-03,  9.479092517869662e-03, 1.788958828058750e-02,  4.633164149849722e-04, 5.904910834944882e-04, -2.408204827222385e-03, -6.941946879707167e-05,  4.483951924809132e-03, 1.515955348780075e-03, -4.111383144044344e-03, 1.145029310675904e-03, -3.155676485614442e-03, 5.198353399205897e-03,  4.633164149849902e-04, 8.209868619375803e-03,  3.854656872251399e-03, -5.686799924609559e-04,  6.810351886452549e-04, -3.775574735450057e-04,  1.866486911935148e-03, -1.059779213195093e-03,  2.107395581464912e-03, -6.014022111787653e-03,  1.671695741804107e-03, -2.558292338489411e-03,  1.925385746744143e-03, -5.686799924609597e-04,  4.752469098110489e-03, -1.052892501216991e-03,  8.289910457937276e-04, 2.985237687897542e-04,  1.928876681299119e-03, 1.847147692396287e-03,  5.414550285123032e-04, -5.789672893344097e-04,  3.581235111129937e-04, -1.105440750382808e-03,  6.810351886452549e-04, -1.052892501216980e-03,  4.499992269663437e-03, 4.342875676217290e-04,  4.140137369825925e-04, 1.113709666343750e-03, -1.774517694351680e-03, -1.579268179507670e-03, -1.078540005883329e-04, -1.498594142321282e-03,  2.107077012603930e-04, -3.775574735450062e-04,  8.289910457937313e-04, 4.342875676217315e-04,  7.551996530304495e-03, -3.295623548267038e-04,  3.608047690405791e-05, 1.204739206977637e-04,  1.114544745300803e-03, -1.995040330050154e-04, -2.244478324730912e-04, 1.427261789439171e-03,  1.866486911935154e-03, 2.985237687897072e-04,  4.140137369826068e-04, -3.295623548266914e-04,  3.753061496865770e-03, 3.145117409283806e-04,  1.355658566993869e-03, -3.119502384166738e-03,  1.625659533855448e-03, -7.793907881743520e-04,  8.132450656674420e-04, -1.059779213195094e-03,  1.928876681299104e-03, 1.113709666343752e-03,  3.608047690405618e-05, 3.145117409283793e-04,  7.022065318478474e-03, -8.483669283526686e-04,  5.250794599184539e-04, 2.518535017975238e-04,  9.027798420704477e-04, -1.669348734944285e-03,  2.107395581464915e-03, 1.847147692396287e-03, -1.774517694351670e-03, 1.204739206977681e-04,  1.355658566993844e-03, -8.483669283526862e-04,  6.605293890297114e-03, -2.823226725797710e-03,  6.376495165978657e-04, -1.621977537686798e-03,  8.861651100970925e-04, -6.014022111787656e-03,  5.414550285122730e-04, -1.579268179507666e-03,  1.114544745300790e-03, -3.119502384166703e-03,  5.250794599184685e-04, -2.823226725797678e-03,  1.371616753256162e-02, -2.149358165445565e-03,  4.102055543852206e-03, -2.377236823381624e-03,  1.671695741804107e-03, -5.789672893344030e-04, -1.078540005883375e-04, -1.995040330050138e-04,  1.625659533855504e-03, 2.518535017975271e-04,  6.376495165978683e-04, -2.149358165445533e-03,  6.672636831774940e-03, 1.862312891680486e-03,  2.004508052992314e-03, -2.558292338489407e-03,  3.581235111130108e-04, -1.498594142321278e-03, -2.244478324730864e-04, -7.793907881744023e-04,  9.027798420704312e-04, -1.621977537686820e-03,  4.102055543852173e-03, 1.862312891680498e-03,  7.450473481007346e-03, -7.312801676069236e-04,  1.925385746744138e-03, -1.105440750382820e-03,  2.107077012604092e-04, 1.427261789439162e-03,  8.132450656674411e-04, -1.669348734944292e-03,  8.861651100971199e-04, -2.377236823381646e-03,  2.004508052992320e-03, -7.312801676069026e-04,  4.676169434112422e-03, 4.640626054187414e-03, -1.548184868416825e-03, 1.129419102455862e-03, -1.805156740097674e-03, 2.175028324951794e-03, -1.593957191965641e-03, 1.808027589232426e-03, -7.248190268319484e-03, 2.126621913695327e-03, -3.013929167982338e-03, 2.160854637528191e-03, -1.548184868416831e-03, 6.513508229539861e-03, -1.782057618741881e-03, 1.603564040904003e-03,  3.308635261762909e-04, 3.237882893924944e-03,  2.800504950165895e-03, 1.277140355153625e-03, -8.269462371445182e-04, 1.058199112493015e-03, -1.728768226763433e-03, 1.129419102455861e-03, -1.782057618741877e-03, 5.737015568966784e-03,  4.047906971989444e-04, 5.385026661283133e-04,  1.588633156618858e-03, -2.726935522600882e-03, -2.346487737047739e-03, -2.942104535211615e-04, -2.353053993418799e-03, 3.023714763162004e-04, -1.805156740097669e-03, 1.603564040904007e-03,  4.047906971989474e-04, 1.081300514686891e-02, -8.605617846768523e-04, 4.535006151012073e-04, -3.932615257737435e-05, 2.884073755706814e-03, -4.310783680136490e-04, 4.374325222985203e-04,  1.751463530403868e-03, 2.175028324951810e-03,  3.308635261762661e-04, 5.385026661283194e-04, -8.605617846768345e-04, 4.259076352632293e-03,  6.014677948256423e-04, 1.642338645042141e-03, -4.111646420486926e-03, 2.347286889996432e-03, -7.588927809935744e-04, 1.003338700754288e-03, -1.593957191965644e-03, 3.237882893924945e-03,  1.588633156618865e-03, 4.535006151012086e-04,  6.014677948256592e-04, 9.517730907585632e-03, -1.091065531345275e-03, 8.291693081294042e-04,  1.784975093756245e-04, 1.541910782032139e-03, -2.509059277530218e-03, 1.808027589232428e-03,  2.800504950165900e-03, -2.726935522600876e-03, -3.932615257737430e-05, 1.642338645042128e-03, -1.091065531345280e-03, 8.040298264651200e-03, -3.258463379900165e-03,
                  8.886993833284199e-04, -1.523655658794589e-03, 9.215334677673716e-04, -7.248190268319480e-03, 1.277140355153589e-03, -2.346487737047748e-03, 2.884073755706834e-03, -4.111646420486857e-03, 8.291693081293982e-04, -3.258463379900155e-03, 1.673317973784563e-02, -3.006728335634014e-03, 5.410656137667610e-03, -2.923699032201961e-03, 2.126621913695326e-03, -8.269462371445250e-04, -2.942104535211703e-04, -4.310783680136505e-04, 2.347286889996440e-03,  1.784975093756392e-04, 8.886993833284186e-04, -3.006728335633989e-03, 8.448379395703223e-03,  2.790122419715803e-03, 2.725576499930636e-03, -3.013929167982338e-03, 1.058199112493020e-03, -2.353053993418787e-03, 4.374325222985171e-04, -7.588927809936143e-04, 1.541910782032134e-03, -1.523655658794580e-03, 5.410656137667585e-03,  2.790122419715806e-03, 9.243654311439304e-03, -7.996987142129609e-04, 2.160854637528181e-03, -1.728768226763439e-03, 3.023714763162033e-04,  1.751463530403876e-03, 1.003338700754327e-03, -2.509059277530229e-03, 9.215334677673760e-04, -2.923699032201941e-03, 2.725576499930635e-03, -7.996987142129617e-04, 5.418841189488586e-03,  5.100254692147784e-03, -1.148821174178866e-03,  8.325466627743571e-04, -9.437084804241253e-04,  2.788672561869190e-03, -1.410460664336489e-03,  2.608846243175006e-03, -8.018352557517464e-03,  3.547713190980939e-03, -2.457034048555378e-03,  3.038343783716625e-03, -1.148821174178868e-03,  6.245433638268506e-03, -1.568093743989431e-03,  1.188238074503007e-03, 1.549968756227566e-04,  3.054975842030364e-03, 2.553598851957431e-03,  1.166306371928980e-03, -1.208833042305009e-03,  6.450709155450667e-04, -1.851479696666066e-03,  8.325466627743538e-04, -1.568093743989410e-03,  5.413444716501330e-03, 6.218462958782218e-04,  5.478413094643325e-04, 1.322909869245722e-03, -2.447488412623525e-03, -2.175179327552174e-03, -1.605266988278034e-04, -2.062582060299120e-03,  4.191714585227501e-04, -9.437084804241266e-04,  1.188238074503005e-03, 6.218462958782251e-04,  1.041144800976792e-02, -9.084796335203684e-04,  1.122495616257820e-04, -1.602905779159614e-04,  2.541628698433225e-03, -7.102761736333454e-04, -1.949756177352054e-04, 1.708100083920633e-03,  2.788672561869196e-03, 1.549968756227355e-04,  5.478413094643524e-04, -9.084796335203638e-04,  4.743038102584115e-03, 4.063807031135285e-04,  1.985449934343948e-03, -4.826935970353612e-03,  3.131049141509525e-03, -7.217654672898122e-04,  1.554383887985755e-03, -1.410460664336488e-03,  3.054975842030349e-03, 1.322909869245720e-03,  1.122495616257790e-04, 4.063807031135351e-04,  9.164597905052698e-03, -1.005058861757920e-03,  8.963245631263541e-04, 2.902996862560832e-05,  1.476641321351751e-03, -2.520441063488739e-03,  2.608846243175005e-03, 2.553598851957438e-03, -2.447488412623526e-03, -1.602905779159673e-04,  1.985449934343921e-03, -1.005058861757916e-03,  8.293452715125185e-03, -4.066240053732653e-03,  1.596542761602849e-03, -1.675798756215362e-03,  1.418926516001316e-03, -8.018352557517466e-03,  1.166306371928968e-03, -2.175179327552186e-03,  2.541628698433223e-03, -4.826935970353581e-03,  8.963245631263515e-04, -4.066240053732654e-03,  1.829637626962713e-02, -4.487952271276343e-03,  5.083755184264781e-03, -3.976904937507523e-03,  3.547713190980936e-03, -1.208833042305012e-03, -1.605266988278111e-04, -7.102761736333381e-04,  3.131049141509529e-03, 2.902996862561168e-05,  1.596542761602855e-03, -4.487952271276355e-03,  1.000429118802050e-02, 2.567737295979328e-03,  3.654164922909251e-03, -2.457034048555380e-03,  6.450709155450799e-04, -2.062582060299108e-03, -1.949756177352118e-04, -7.217654672898287e-04,  1.476641321351749e-03, -1.675798756215361e-03,  5.083755184264804e-03, 2.567737295979327e-03,  8.759053034976528e-03, -9.762002953399272e-04,  3.038343783716625e-03, -1.851479696666078e-03,  4.191714585227565e-04, 1.708100083920622e-03,  1.554383887985770e-03, -2.520441063488737e-03,  1.418926516001317e-03, -3.976904937507499e-03,  3.654164922909253e-03, -9.762002953399339e-04,  6.164208342389136e-03, 5.575373720894623e-03, -4.156490357375787e-04, 5.094912173410889e-04, -3.595093524674476e-04, 3.112080442788784e-03, -1.103825053201972e-03, 3.522604295107612e-03, -8.426097587318200e-03, 3.780235994949835e-03, -2.589029751925875e-03, 3.199686739713845e-03, -4.156490357375744e-04, 6.637071819405626e-03, -1.684998233493912e-03, 1.099655437497182e-03,  4.275784015503187e-04, 2.858405302529653e-03,  3.199552771800957e-03, 5.487999313644442e-04, -1.018834676494859e-03, 3.958074583988542e-04, -1.747199782509850e-03, 5.094912173410852e-04, -1.684998233493909e-03, 6.152021836980313e-03,  9.252380389719083e-04, 5.160188224208516e-04,  1.829308144886100e-03, -3.061914234499064e-03, -1.996612652616812e-03, -3.055873402294110e-04, -2.109922451877399e-03, 2.703811404398767e-04, -3.595093524674480e-04, 1.099655437497180e-03,  9.252380389719043e-04, 1.146498911489653e-02, -7.411549178949072e-04, 1.266459393350410e-04, -2.834909892057009e-04, 2.044311299344395e-03, -5.459280332654297e-04, -4.450199354944116e-04,  2.192631420665549e-03, 3.112080442788791e-03,  4.275784015503084e-04, 5.160188224208660e-04, -7.411549178948992e-04, 5.229862467645566e-03,  4.669246749817939e-04, 2.336132661413991e-03, -5.056346418310527e-03, 3.252404757812522e-03, -8.504255472018842e-04, 1.573960457419457e-03, -1.103825053201972e-03, 2.858405302529652e-03,  1.829308144886105e-03, 1.266459393350394e-04,  4.669246749817951e-04, 9.639490112812564e-03, -1.130783492579460e-03, 4.888427188202371e-04,  1.663513120413700e-04, 1.263951978126307e-03, -2.438774629767254e-03, 3.522604295107610e-03,  3.199552771800959e-03, -3.061914234499062e-03, -2.834909892056962e-04, 2.336132661413971e-03, -1.130783492579467e-03, 9.837297182199159e-03, -4.590423940717977e-03, 1.739371047107844e-03, -2.096888130520746e-03, 1.479959428911816e-03, -8.426097587318196e-03, 5.487999313644486e-04, -1.996612652616822e-03, 2.044311299344405e-03, -5.056346418310488e-03, 4.888427188202310e-04, -4.590423940717969e-03, 1.920034886862080e-02, -4.294191257096411e-03, 5.433057084934568e-03, -3.872802153465121e-03, 3.780235994949834e-03, -1.018834676494865e-03, -3.055873402294210e-04, -5.459280332654286e-04, 3.252404757812531e-03,  1.663513120413778e-04, 1.739371047107847e-03, -4.294191257096404e-03, 1.064333204813647e-02,  2.863451777398322e-03, 3.829178104536391e-03, -2.589029751925878e-03, 3.958074583988568e-04, -2.109922451877382e-03, -4.450199354944139e-04, -8.504255472019000e-04, 1.263951978126301e-03, -2.096888130520743e-03, 5.433057084934560e-03,  2.863451777398306e-03, 9.635412571069268e-03, -8.976693184911469e-04, 3.199686739713851e-03, -1.747199782509840e-03, 2.703811404398710e-04,  2.192631420665547e-03, 1.573960457419512e-03, -2.438774629767258e-03, 1.479959428911808e-03, -3.872802153465104e-03, 3.829178104536375e-03, -8.976693184911556e-04, 6.704550356864315e-03,  5.449422612265639e-03, -1.824230825314559e-03,  8.051295655459259e-04, 5.805892344299339e-04,  2.729455580733945e-03, -2.727125501635126e-03,  2.386852623299974e-03, -7.848625539178429e-03,  4.051914467712673e-03, -2.328840349948573e-03,  4.104687518981604e-03, -1.824230825314559e-03,  6.960726850161966e-03, -1.582545674540172e-03,  9.679879809765920e-04, 3.462539136775747e-05,  3.216485101466349e-03, 2.227199008315262e-03,
                  1.608482095627996e-03, -1.612321014077967e-03,  9.808986869143067e-04, -2.421400632640986e-03,  8.051295655459259e-04, -1.582545674540172e-03,  6.474785317900143e-03, 9.779908342550231e-04,  7.811660924183800e-04, 1.716244325600570e-03, -2.661832608364882e-03, -2.094656631699075e-03,  7.626378020123090e-05, -2.193085324502278e-03,  4.849643895843374e-04, 5.805892344299339e-04,  9.679879809765920e-04, 9.779908342550231e-04,  1.147789151712682e-02, -4.427974926304037e-04, -1.682441200593428e-04, 3.203164685303763e-04,  7.733785774212637e-04, 8.010495116930316e-05, -7.523943396937630e-04, 2.611438463590231e-03,  2.729455580733945e-03, 3.462539136775747e-05,  7.811660924183800e-04, -4.427974926304037e-04,  5.680484916410006e-03, -1.549152668677411e-04,  1.850034210885510e-03, -4.745608945108438e-03,  3.253038100923574e-03, -7.548800848713918e-04,  1.674852504143416e-03, -2.727125501635126e-03,  3.216485101466349e-03, 1.716244325600570e-03, -1.682441200593428e-04, -1.549152668677411e-04,  1.102939586600780e-02, -1.704845888352648e-03,  1.852985857483922e-03, -6.516678397686695e-04,  1.548182912192216e-03, -3.204643833607945e-03,  2.386852623299974e-03, 2.227199008315262e-03, -2.661832608364882e-03, 3.203164685303763e-04,  1.850034210885510e-03, -1.704845888352648e-03,  8.780133117964495e-03, -3.277692626865079e-03,  1.561402200542255e-03, -1.578204989341893e-03,  1.574157335064102e-03, -7.848625539178429e-03,  1.608482095627996e-03, -2.094656631699075e-03,  7.733785774212637e-04, -4.745608945108438e-03,  1.852985857483922e-03, -3.277692626865079e-03,  1.893520908555326e-02, -4.643683675506168e-03,  4.356130952034516e-03, -4.517487147793108e-03,  4.051914467712673e-03, -1.612321014077967e-03,  7.626378020123090e-05, 8.010495116930316e-05,  3.253038100923574e-03, -6.516678397686695e-04,  1.561402200542255e-03, -4.643683675506168e-03,  1.124374061373513e-02, 2.384490781500766e-03,  4.476529479464560e-03, -2.328840349948573e-03,  9.808986869143067e-04, -2.193085324502278e-03, -7.523943396937630e-04, -7.548800848713918e-04,  1.548182912192216e-03, -1.578204989341893e-03,  4.356130952034516e-03, 2.384490781500766e-03,  9.397616545584082e-03, -1.140679692327849e-03,  4.104687518981604e-03, -2.421400632640986e-03,  4.849643895843374e-04, 2.611438463590231e-03,  1.674852504143416e-03, -3.204643833607945e-03,  1.574157335064102e-03, -4.517487147793108e-03,  4.476529479464560e-03, -1.140679692327849e-03,  7.979421377264031e-03 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$lag_one_cor),
               c( 5.810831002355591e-03, 9.480012167483061e-05, 3.601466568058545e-03, 1.546611661457090e-03, -2.771632687736942e-04,  1.752703231783361e-03, -2.039423123231928e-04, -3.401188628408184e-03, -4.516262508865667e-03, -6.749421787092624e-03, -1.102927391938871e-03, 1.167770025364212e-04, 2.249595481873643e-02, -6.105765821670547e-03, 6.263375185103155e-03,  2.753491869717329e-03, 1.333576566215608e-02, 1.376978440107797e-02, 5.016407828960468e-04, -3.246577580047811e-03,  7.375203910983516e-04, -6.500203623004969e-03, 3.571874310550751e-03, -6.099975194451922e-03, 1.941889104243911e-02,  3.198652795843436e-03, 2.064352402185733e-03, 8.310308436802820e-03, -1.203304075759172e-02, -6.607066875598872e-03, -1.025369987064359e-03, -8.052070779246131e-03, 4.808058920854482e-04, 1.545519475303523e-03, 6.266160610310634e-03,  3.199543693514024e-03, 4.281945794502288e-02, -1.887708631644401e-03, 1.041234860112375e-03, 1.804038564168894e-03,  5.384432219173887e-03, -6.353721127691830e-04, -2.535811401020473e-03, 9.981095730560573e-03, -2.437985044043426e-04,  2.760172614916442e-03, 2.049675086762764e-03, -1.883634270019078e-03, 1.182820808418172e-02, 4.031634803346909e-03,  4.586384607445576e-03, -1.084838714819665e-02, 8.978960616148392e-03, 2.096553761544529e-04, 2.726595488766686e-03,  1.769691147612747e-03, 1.333627046072657e-02, 8.308107771211881e-03, 1.038516331998704e-03, 4.034460613823549e-03,  3.680772181281394e-02, -2.843243263652494e-03, -1.246324579640438e-03, 2.178889448823248e-03, 3.544524148859425e-03, -9.681609125440386e-03, -1.667704619032506e-04, 1.376997191870573e-02, -1.204352506518038e-02, 1.805572188319628e-03,  4.568842729490616e-03, -2.849671488716345e-03, 2.774132272798011e-02, -7.122136047218027e-03, 1.574241132502122e-04, -5.621544937295947e-03, 1.603299084563089e-03, -3.424173510669263e-03, 4.835588805654827e-04, -6.579625851017785e-03,  5.376871232047383e-03, -1.086087483493636e-02, -1.242561653121670e-03, -7.161577362484456e-03, 3.552208567948270e-02, -7.021756233829802e-03, 1.192139632994469e-02, -6.566997442717411e-03, -4.428037247951662e-03, -3.244753780024182e-03, -1.042885736449996e-03, -6.248659544926198e-04, 8.968835913027964e-03, 2.170349230966262e-03, 1.775332666832192e-04, -6.989021556953414e-03, 3.119737831651457e-02, 1.638464609552152e-02, 1.098982131887642e-02, -6.687330852873898e-03,  7.303683080704902e-04, -8.053431195177423e-03, -2.531909516040059e-03, 2.005430994099494e-04, 3.543246943128656e-03, -5.623483321395012e-03, 1.194180557292170e-02, 1.638306975259565e-02, 3.153704046592509e-02, 8.582404391334743e-05, -1.075889527121952e-03, -6.495933126892161e-03, 4.708847948616698e-04, 9.987134925934808e-03, 2.722653613198464e-03, -9.685284981001690e-03, 1.614442837509405e-03, -6.551661501223766e-03, 1.098800090257378e-02, 8.738069440896920e-05,  1.751950431243102e-02, 9.365591382627173e-04, -4.760339117789333e-04, 1.104813571489127e-03, 8.678948839753782e-04, -7.995336190741095e-05, 1.931626918878389e-04, -8.063865681933581e-04, -7.278186242701474e-04, -4.279174477231965e-04, -9.625739335161188e-04, 9.419303271870254e-05, -3.936177754757685e-04, 3.349958246314731e-03, -7.896584780192196e-04, -5.365916288481713e-04, 6.571651691867600e-05, -1.177412054565617e-03, 1.158197752476210e-04, 1.260472862443350e-04, -1.948554724222104e-04, 7.708516751964240e-04, -3.247114118121825e-04, 1.276040694311509e-03, -7.638687033771521e-04,  5.589722091089027e-03, 8.849560698072131e-04, 6.995769257906488e-04, 9.111796331231540e-04, -1.331770187398763e-03, -2.172077258013739e-04, 5.665475864218622e-04, -8.856031657392895e-04, 2.959038124827300e-04, 8.404297898425576e-04, -5.445534901009105e-04, 8.483697527327729e-04, 4.905858374471606e-03, -1.943910516453835e-04, -3.256570933783904e-04, -9.753984731693878e-04, -5.591110055464307e-04, -3.802609940187443e-04, -4.125202364669640e-04, 3.541629637792603e-04, -2.182847722922689e-05, 8.128109527569521e-05, 6.863134598949132e-04, -2.094379516705695e-04, 4.055722379070571e-03, -2.652513723703405e-04, -4.521145453545549e-04, 9.122969705929115e-04, -2.815679699791542e-04, -5.866117151628208e-05, -6.829955828326567e-04, 1.102229233202652e-04, -1.201603945693624e-03, 8.970916220334062e-04, -2.674092134330262e-04, -2.948129443872021e-04, 3.929497638383662e-03, -9.609592637260308e-04, -4.266109379818640e-04, 4.636134340405631e-04, -5.786188633112848e-04, 7.195891737430925e-04, -7.354903483275583e-04, 1.013207221387015e-04, -1.320441810335635e-03, -9.897297393579002e-04, -4.720034736705107e-04, -9.011107817124555e-04, 4.433125193555305e-03, 1.825004194108022e-03, -3.161229917374555e-04, -1.637075444677798e-05, -2.570096380783114e-04, -6.069272845749077e-04, 2.084769359377862e-04, -3.549979841129527e-04, -6.195403827468780e-04, 9.216319015951336e-04, -3.660706123013434e-04, 1.967221028267828e-03,  4.019681267121929e-03, 1.185785583457134e-03, -1.115328150958939e-03, 7.480397391192105e-04, -2.780126261757137e-04, -1.104196366064002e-04, 4.319778376555396e-04, -5.053197822485651e-04, -3.673978073479422e-04, 5.433096479163400e-04, -1.922231787920615e-04, 1.230192362505331e-03, 2.846239912693770e-03, -8.771004995128655e-04, -5.823199657024178e-04, -1.157655604061909e-03, 7.682571536059942e-04, -9.959820524511618e-04, -5.549341575425312e-04, -1.094167310840095e-04, -5.264753860904200e-04, -3.266444929954284e-05, -1.070819453915007e-03, -8.183423965391458e-04, 4.893376295882408e-03, -8.133499751970712e-04, -4.407936931536132e-05, -3.602853848295360e-04, 3.577924680879409e-04, 3.842734527267607e-04, -6.614260872823627e-04, 6.510769780401111e-04, -2.520675686930041e-04, 6.795880649328465e-04, -4.952103532342433e-04, -8.642606048370198e-04, 3.759684385815719e-03, 7.500009663678673e-04, 1.490320294104789e-05, 7.882503373251172e-04,  4.373111115866317e-04, 1.638335507445699e-04, 2.075354910817489e-04, -9.969471951024998e-05, -7.945786636834955e-04, -8.431151512921039e-05, -9.502376979126238e-04, -9.124119527284785e-05, -3.056429868247490e-04, 2.358018316373663e-03, -3.263023993439666e-04, -3.759595545583824e-04, -6.370909009087943e-05, -1.118775242507408e-03, -4.021317934583685e-04,  2.737936653752390e-04, 1.559686518987785e-05, 5.752074951772385e-04, -7.324038607332242e-05, 7.780659377466367e-04, -1.170120775509371e-04, 3.813181506217203e-03, 3.302251726738541e-04, 5.601815025452105e-04, 4.660463362604879e-04, -1.636688489583603e-04, -2.497167779141757e-04, 4.068406064905762e-04, -4.902642591559331e-04, 2.052995988226332e-04,  6.007169369583380e-04, -2.713582117209736e-04, 3.772434291448671e-04, 2.770083105722603e-03, 6.096802001236238e-05, -4.347845082878854e-05, -3.812035403588370e-04, -8.598958184845035e-04, -2.187257738751882e-04, -3.193063134763164e-04, -4.136980850507049e-05, -6.864330275864025e-05, -7.492459774100630e-06, 3.393439086289021e-04, -7.226727834635052e-05,  3.204801599699283e-03, -3.294332649304832e-04, -3.843259131268357e-04, 1.030610259246125e-03, -3.115591126608714e-04,  9.029986323719010e-05, -4.545293430360858e-04, 1.722096901750326e-04, -9.562117534470736e-04, 3.051957399191846e-04, -2.180804868242966e-04, -3.019143171580568e-04, 2.530650006475341e-03, -3.891502828489924e-04, -1.214686414524207e-04,  2.415589248768962e-04, -4.410152943222876e-04,
                  5.869790764001122e-04, -6.019192580594287e-04, -4.182032456984445e-04, -4.300187308467081e-04, -5.256901525979299e-04, -4.843164037567284e-04, -5.357804998588423e-04, 2.699413038121256e-03,  1.723417520268844e-03, -1.186272383392038e-04, 1.736153189270094e-04, -1.909084751995811e-04, -6.163861183593271e-04, -3.545923354437973e-05, 9.063596575166412e-05, -3.371489757086903e-04, 6.578188767006558e-04, -2.238735617604055e-04,  1.034601568337501e-03, 3.281840807546516e-03, 8.233013749879058e-04, -8.883274075068988e-04, 4.883276443059699e-04, -3.258641966452230e-04, -1.336360957793406e-04, 3.715503850338803e-04, -1.334966746056443e-04, -4.313018316635881e-04,  1.416696267920372e-04, -2.867457753154465e-04, 1.145755675875163e-03, 2.028589144998183e-03, -8.169980053995629e-04, -4.967047650206126e-04, -8.501125998107192e-04, 2.318226949670411e-04, -4.024449917307870e-04, -1.360812988084966e-04, -1.668727673991065e-04, -6.384618101870890e-04, -3.051084663812970e-04, -7.677772477671847e-04, -8.012779705725043e-04,  3.859283331552575e-03, -5.152075708965523e-04, 3.251787336621206e-05, 1.618613491608965e-05, 1.537314245624113e-04, -6.092853418946526e-05, -4.589062141465744e-04, 7.515740998291281e-04, -9.057163069869001e-05, 5.671241574825205e-04, -6.381066291808080e-04, -6.205790444285654e-04, 2.853867890199347e-03, 8.094306240534326e-04, -2.867719266846826e-04,  6.135628188740024e-04, 2.687131886739499e-04, -2.296397185438561e-05, -5.101853293458342e-05, -2.883660961786172e-04, -8.191906858156979e-04, -4.337842405221190e-04, -1.057830280334655e-03, 2.759138398523100e-05, -5.796349413677802e-05,  1.782786839582537e-03, 1.031275988275034e-04, -1.979124813002382e-04, -2.610128305623226e-05, -7.907456111334989e-04, -5.874949605113144e-04, -8.750385353064898e-05, -3.107737945654042e-06, 1.182011024680188e-04, 1.678440053090946e-04,  6.272497458399848e-04, -1.674411131572040e-04, 2.858818410133925e-03, 8.017101901343371e-05, 1.595939238086730e-04, -8.640727048340622e-05, 1.840137117427418e-05, 5.455614120237085e-05, 5.548197005161410e-05, -4.333259543327268e-04,  7.650936933868412e-05, 4.474212212779677e-04, -3.829726021114257e-04, 1.867705068141058e-04, 1.430107735954736e-03,  2.663057041516417e-05, -2.248817667598611e-04, -2.636406613433325e-04, -6.220693986425783e-04, -2.054967037002743e-04, -3.177344530021151e-04, -2.808366920814289e-04, 9.684174488420765e-05, -8.362411854659298e-05, 3.109237335436139e-04,  1.848244202867108e-04, 2.541699695889726e-03, -3.242290525938717e-04, -3.690776780372097e-04, 7.245988670698089e-04, -4.482724658080547e-04, -1.184549410826922e-04, -3.025852723106882e-04, 3.031297141987346e-04, -9.273801899229587e-04,  9.928511740714733e-05, -1.317577742712824e-04, -2.895263099312684e-04, 1.559966078050163e-03, -1.199964992079235e-04, -2.233138718475248e-04, -9.624020307067403e-05, -6.994936472412088e-04, 6.364762259641495e-04, -1.883414891340397e-04, -5.316921021366887e-04, 1.614967817806469e-04, -2.426351306894930e-04, -3.278386637576109e-04, -9.992094328177699e-05,  1.779257569132536e-03, 9.129210000033667e-04, -1.168294778278276e-04, 9.798685970458920e-06, -1.010699833916933e-04, -1.016286247290763e-03, 2.408662364270777e-04, -1.180362959672874e-04, -4.901619064434348e-04, 7.591701285204501e-04,  1.643301188442466e-04, 9.819553391084840e-04, 3.084486223513665e-03, 1.000489187433799e-03, -2.011357320200967e-04,  3.851107948625025e-04, -2.191579558520523e-04, 7.799265223631344e-05, 2.742632907461598e-04, -5.779628522183710e-05, -3.399142648631652e-04, 8.457743187146948e-05, -8.044436660075609e-05, 7.333127196447495e-04, 1.541754424153168e-03, -7.422641220561810e-04, -5.671005943159301e-04, -1.012792170070947e-03, 4.508781235655062e-04, -3.996315590837597e-04, -5.864506485269912e-05, 7.278368003380266e-05, -2.421164910426751e-04, 9.050706548474857e-05, -4.599579610820132e-04, -3.920660172911151e-04, 3.572662818746392e-03, -3.885925108012404e-04, 5.317678808443814e-05, 1.487116426209839e-04,  1.091517781625994e-04, -3.495662546601954e-04, -3.453159609319850e-04, 6.440689989797418e-04, -9.407139807774128e-05,  4.636992370328648e-04, -5.959719086626408e-04, -4.035715452367706e-04, 2.113787904622475e-03, 8.757060177103234e-04, -3.074959282293648e-04, 4.957623859217734e-04, 1.323466842689161e-04, 1.157420962540263e-04, -2.267775200800050e-04, -3.020610779951179e-05, -1.216040126978038e-03, -2.132674538972678e-04, -1.161399252866154e-03, 2.081214065366180e-04, -3.376924135688819e-04, 1.615267574412714e-03, -7.671034143100263e-05, -2.043454397294067e-04, -1.150015850180818e-04, -5.623502980068615e-04, -5.540001581865748e-04, 3.412710378149358e-04, 7.221288655262633e-05, 4.327867186617179e-04,  1.046886512481329e-04, 5.270853435409160e-04, -8.382232792585628e-05, 2.367758453645424e-03, 1.178654588754205e-05,  1.765635601235309e-04, -2.718436269900848e-04, 2.029320112534002e-04, -2.122460472103479e-04, 1.143256522436015e-04, -4.885678154081020e-04, 1.837867719060485e-04, 2.562127450428699e-04, -2.687589355025015e-04, 9.111254361523910e-05,  1.113657645861968e-03, 1.929026826519077e-04, -2.374719638947729e-04, -1.515070486857037e-04, -6.201706712433784e-04, -5.516384014031788e-05, -2.142338882534435e-04, -2.395141716567312e-04, -9.239216306350541e-05, -9.391916024097683e-05,  9.038503202801409e-05, 8.955302989267777e-05, 2.095042001474911e-03, -2.744728295665721e-04, -3.248161193035928e-04,  7.517173974893585e-04, -3.209936479385417e-04, 6.974215093565633e-05, -2.266904728248584e-04, -1.606653778231554e-04, -5.955655328443801e-04, -5.632552947124189e-05, -1.482411557516248e-04, -2.319603764892175e-04, 1.399293406443727e-03, -1.243821871140043e-04, 1.924621280644782e-04, 5.822988986146823e-05, -1.220216062440953e-04, 4.759500705428831e-04, -2.641703989938561e-04, -4.089735556206551e-04, -6.282613373522416e-05, -1.679163644105395e-04, -3.526787417341047e-04, -1.940705736397038e-05, 1.528133750454571e-03, 1.029893590612467e-03, -6.690511015859124e-05, 2.891481897602578e-04, -1.658339338883735e-04, -9.678273357070325e-04, 1.694299362889866e-04, -2.380652273082664e-05, -2.769795320626115e-04,  4.708852470822008e-04, 1.805805596236880e-04, 5.733481948285136e-04, 3.197435199858111e-03, 5.251844032209635e-04,  1.327994032923629e-05, 1.829036976920238e-04, -5.284672678433715e-04, 1.864340952439581e-04, 8.252675656506846e-05, -1.675766764329680e-05, -4.577366265236911e-04, 2.576077489529309e-04, -2.539899721931191e-04, 1.119303378999664e-03,  1.236614070723500e-03, -1.600154807823526e-04, -6.921974640043999e-04, -1.099234299169677e-03, 3.748220019127382e-04, -2.914075262607450e-04, 6.238331878693706e-06, -7.328656448065137e-05, 4.509920066644217e-06, -3.349452037287783e-05,  9.614507574292296e-05, -4.651478037536144e-04, 3.364934923885174e-03, -4.344787467017341e-04, 2.230303353830570e-05,  1.525149249165581e-04, 3.782423098898378e-05, -2.775364397079733e-04, -2.319868164697030e-04, 4.364305801961625e-04, -8.445052768509990e-05, 3.662473667264684e-04, -4.993091794486871e-04, -2.998261998020041e-04, 1.806078534176804e-03,  6.770675040026898e-04, -1.755490846892147e-04, 1.204791784378994e-04, 4.544197963762050e-05, 2.425287280505276e-04, -2.112338069903542e-04, 1.667486112670636e-04, -1.202779344566629e-03, 3.291313582218271e-04,
                  -4.432120406002846e-04,  3.055369741535760e-04, -2.015072218894980e-04, 1.246953315478039e-03, 1.152621356201936e-04, -2.352464135294704e-04, -2.121285574983114e-04, -4.859280712711930e-04, -6.166213089798362e-04, 2.497156582389470e-04, -2.034109790356416e-05,  1.503402503045781e-04, 1.068087835719671e-04, 2.482573783968725e-04, 9.334140210748125e-05, 1.524249901357320e-03, -6.507934613096404e-05, 8.226830639712868e-05, -3.767149619756181e-04, 4.167738099404321e-04, 3.472634708257384e-05,  2.945486908953016e-04, 7.069046067398414e-05, 1.504787782375274e-04, 1.124692228216164e-04, -1.932473936951432e-04, -4.780958484249198e-05, 5.434077386889683e-04, 1.496490623437670e-04, -1.010713718220472e-04, -5.276854728734904e-05, -4.287885018504811e-04, 4.060874956821541e-05, -1.044052511459756e-05, -3.274109763520704e-04, 9.077106835010830e-05, -8.821027464878405e-05, -2.099985164098677e-05, 1.151915770430335e-04, 1.821769035850361e-03, -3.031691004661781e-04, -1.077591701490022e-04, 3.733711286268377e-04, -3.596448867322701e-04, -9.244571052331393e-05, -1.080104474587144e-04, -2.661348620108459e-04, -4.884529518823049e-04, -2.996813907358514e-04, -6.414642995042401e-05, -3.783812293784484e-04,  9.585381203450515e-04, -5.124710958972693e-05, 4.359468512148989e-04, -1.122586950059038e-04, -8.067387749255165e-05,  2.790119672013774e-04, -6.471196895837877e-05, -5.386233780047908e-04, 3.126346973746130e-04, -3.299588332819018e-05, -2.553077585708510e-04, 4.882586829031552e-05, 1.128483828525032e-03, 5.423675951357640e-04, -8.758070196199341e-05,  1.588036710164885e-04, -6.494363747338563e-05, -1.241590490382481e-03, 1.946414172269702e-04, 1.058708291288485e-04, -2.619509880959951e-04, 1.144466234652806e-04, 3.131251737291943e-04, 1.815377164243364e-04, 3.704822471112221e-03, -4.142867477517309e-05, -1.358771996746511e-04, -1.569927206613664e-04, -2.542349537436709e-04, 1.083705702457056e-04,  6.895845997532637e-05, -4.013578897788615e-06, -4.477722120887061e-04, 5.825588454729417e-05, -1.764034937580616e-04,  7.350186154314949e-04, 7.857517756525354e-04, -4.053587723739118e-04, -6.121458211756251e-04, -5.790187225777529e-04,  1.646092556124651e-04, 1.635775110064846e-04, 4.967657590225551e-05, -2.498286628862788e-04, -5.786947536732013e-05, -1.193972203864381e-05, 3.542265163274192e-06, -1.181045330409091e-03, 1.765304013891368e-03, -4.734921113535382e-04,  1.049168313949099e-04, 1.462732838447418e-04, 2.740847794607755e-06, -2.891585735683340e-04, -1.000159578141015e-04,  3.026959038904783e-04, -4.946513457454281e-05, 1.936813804027213e-04, -3.723089925451707e-04, -1.108305827402770e-04,  1.636379256102008e-03, 6.788687792739466e-04, -2.643230461545589e-04, 1.494516162412045e-04, -8.733274417150305e-05,  2.518232088476363e-04, -2.755043887925386e-04, 1.300187115159607e-06, -1.368974129638744e-03, 2.397728844025517e-04, -2.518104440407113e-04, 2.613469918939598e-04, -1.493519706510248e-04, 1.147723239835594e-03, 1.032448111766283e-04, -2.223972628900067e-04, -1.230888230578910e-04, -4.346918162850922e-04, -5.146024566459898e-04, 1.854841906359422e-04,  2.603780713731707e-05, 6.849356741619034e-05, 1.205662328752055e-04, 1.307217167033125e-04, 1.041814481783670e-04,  1.279778130079876e-03, -9.868469336287880e-05, -4.060532941078470e-05, -3.876948616336563e-04, 4.106201158705677e-04,  1.049065756090539e-04, 1.105021834059435e-04, 1.921629417977694e-04, 5.354945258554445e-05, 5.861321130182618e-05, -2.215545035914722e-04, -8.406137142334397e-05, 3.630939879486235e-04, 1.296794964200038e-04, -4.319911854106993e-05,  5.041299289480319e-06, -2.978434720196497e-04, 2.143657030963238e-05, 4.889428174171494e-05, -3.023213999254360e-04,  2.516753505294951e-04, -2.094256694162166e-04, -1.005479890505441e-05, 1.889094514513437e-05, 1.753900427683493e-03, -3.227184578662123e-04, -1.513861211809326e-04, 4.286268456338022e-05, -2.164121525979630e-04, -1.191201915095741e-04, -2.097633932480005e-05, -2.424201858152133e-04, -4.233460799815186e-04, -3.770577952354622e-04, 1.543482683466418e-05, -3.500818097094216e-04, 7.705382271561294e-04, 3.317655046092002e-05, 4.467038799703122e-04, -1.331845021922268e-04, -9.336478814057617e-05, 2.216762319513483e-04, 9.243463930230566e-05, -6.381662921642542e-04, 4.700459830197227e-04,  2.530646993038802e-05, -7.618361677544128e-05, 1.181788890867720e-05, 9.105456277937747e-04, 1.809050472303765e-04, -4.738533668582308e-05, 1.061793022012155e-04, -2.916340737561115e-06, -1.380556792314603e-03, 3.557982712418997e-04,  9.637738270058303e-05, -5.848570066005463e-05, 1.637144975280577e-05, 4.546553141249415e-04, 2.781522872084967e-04,  4.034330665708160e-03, -6.824491259090541e-05, -2.118948876169027e-04, -1.208442669661373e-04, 2.364286061142681e-04, -5.943602484585315e-05, 1.455132444480403e-04, -5.156091555441229e-05, -2.836539656402875e-04, -1.993069560578485e-04, -7.942657252562472e-05, -4.258706779925872e-05, 9.981163774744960e-04, -7.968281037791490e-04, -2.697423188984927e-04, -2.593390807680514e-04, 1.924770851443347e-04, 2.210013007147852e-04, 1.356662573903444e-04, -1.691600362079329e-04, -8.375543968089486e-06, 2.099499968189532e-04, -1.890919385384554e-04, -7.799940663571363e-04, 1.144725990579390e-03, -1.832795467530237e-04, 2.647628524197993e-04, 7.128017484781066e-05, 8.121190371902578e-05, -4.518210341974860e-04, -1.977206414005045e-05, 2.414848603817191e-04, -8.907443023052384e-05, -1.421625316276275e-04, -3.279009405138514e-04, -1.879818556260099e-04, 1.562203262424113e-03, 8.834036236477255e-04, -2.685493646836717e-04, 1.839880336505519e-04, -1.393153091045228e-05, 3.912277237221555e-04, -3.018533314593744e-04, 1.312508188871813e-04, -1.710230684995905e-03,  5.195217142648649e-04, -2.574560928641367e-04, 4.406486049485736e-04, -3.644826833709117e-04, 1.266961471709353e-03,  6.504049398064881e-05, -2.352680788779568e-04, -2.769760016234997e-04, -3.887490800584837e-04, -6.162497029344502e-04,  4.598365175710481e-04, -2.684976289001866e-04, 1.312205857466538e-04, -5.012960987795630e-05, 2.340981970608592e-04,  4.115161207162082e-05, 1.350234068924336e-03, -7.458009010283425e-05, 6.418569532522079e-05, -4.135142059031778e-04,  5.023222357516654e-04, -5.794344197424972e-05, 2.670206650283014e-04, 1.546253603168553e-04, 1.874812851481223e-04, -1.499628659315029e-04, -2.064905262404961e-04, -9.981168139370320e-05, 4.709688795016026e-04, -3.651965820233039e-05,  2.112485132567317e-05, -2.392989252720292e-05, 6.447855135688596e-05, -1.303985009513018e-04, 1.547894554113124e-04, -4.935696972177831e-04, 3.289121028333285e-04, -2.286373895851101e-04, 3.443106589679958e-06, 7.201831492619535e-05,  1.862090391476134e-03, -3.816814168726732e-04, -1.364179731686807e-04, -5.841432828310830e-05, -8.661393601117650e-05, -7.220214679335862e-05, 6.503345642041242e-05, -3.411944350552363e-04, -3.920285017614486e-04, -3.875800092608069e-04, -2.534887496056609e-05, -3.713297473747563e-04, 8.596131838426798e-04, -2.257708297860056e-05, 5.618598951895278e-04, -2.861660833458107e-04, 6.279677168709601e-06, 1.771182991977139e-04, 1.686755671777739e-05, -5.292766551830351e-04,  3.927175460188423e-04, 2.548448665985611e-05, -1.338124707764477e-04, -2.808957178268758e-06, 9.679292179991634e-04,  2.675742871981408e-04,
                  -2.183283406071852e-05, 2.103591713507037e-04, -4.382733053244396e-05, -1.696275710747888e-03,  3.169030546491452e-04, 1.838675988672255e-05, -1.567385708041206e-04, -1.476366480536403e-04, 4.716237954157806e-04,  1.340311430403065e-04, 4.631972889344802e-03, -3.766693157006244e-04, -1.548315959715162e-04, -3.345600526418940e-04,  3.495180389018202e-04, -6.789007524411866e-05, 1.256565719063633e-04, 3.382125230760610e-05, -1.543841542124209e-04, -2.278742739677558e-04, -1.970900839875999e-05, -1.971814619239715e-04, 1.209440086610919e-03, -7.600728736082548e-04, -1.964692640592970e-04, -3.697694976872266e-04, 1.827631544611826e-04, 1.661897627263977e-04, 5.831232927194750e-05, -2.016865811114605e-04, 4.650501381554578e-07, 8.508052784318788e-05, -6.620136559981832e-05, -1.035003269802665e-03,  1.122495815952822e-03, -3.480333547433550e-04, 3.963975338731478e-04, 7.362607439363744e-05, 9.417350214894629e-05, -3.790575935091081e-04, 8.138520669783090e-05, 2.253941265244577e-04, 6.101774456093393e-05, -3.578850561318318e-04, -1.073002712486792e-04, -2.273625083995600e-04, 1.705165173437080e-03, 1.020239225982619e-03, -1.838686218123365e-04,  1.514468665691339e-04, 1.342236588746423e-04, 4.626975835276336e-04, -2.592430069227026e-04, 2.449541981316140e-04, -1.925888531217336e-03, 5.924016282929036e-04, -2.833147466758848e-04, 5.555680064855002e-04, -3.073876193374224e-04,  1.297964073966394e-03, 8.821889187512683e-05, -2.914545434237267e-04, -2.822003052246111e-04, -4.847053168144855e-04, -6.649321576310898e-04, 3.660939556451128e-04, -1.792242237226787e-04, 1.542622401077224e-04, 2.955941238923744e-05,  1.808873201374964e-04, 1.764607548103773e-04, 1.408385872518184e-03, -7.917083381539203e-05, 5.821309443289168e-05, -3.309066703194638e-04, 5.000816440576222e-04, 7.972837560817616e-05, 2.236118651511969e-04, 2.599691249081548e-04,  8.324470896744345e-05, -1.130793094926500e-06, -2.687941440275717e-04, -5.460438498455807e-05, 4.925877212869668e-04,  6.724377802188480e-05, -3.332511630990430e-05, -9.834121454341362e-06, -1.752449841317905e-04, -1.147745795496486e-05,  3.371089842485955e-05, -4.416611549511023e-04, 4.904654364803643e-04, -2.020598287298473e-04, 3.628168562473370e-05,  1.671620869346897e-04, 2.137512576142942e-03, -4.388316930438920e-04, -3.832482910009408e-06, -2.332706670991711e-04,  5.771616547374984e-06, -1.479715041300511e-04, 1.987172431832342e-04, -3.394174946138082e-04, -5.232912234651114e-04, -4.209778648768885e-04, -6.909335657764749e-05, -4.710480209057199e-04, 8.869903276625836e-04, -6.906350455798983e-05,  5.067424458199749e-04, -2.903680891312728e-04, -4.927914836084007e-05, 2.584323369525754e-04, 1.698408349433597e-04, -5.749924554885215e-04, 4.859279379388342e-04, -3.461279427492181e-05, -1.032143006692528e-04, 7.094515112858148e-05,  1.153171049331189e-03, 1.554145085308263e-04, 7.912644524084890e-05, 1.369229942437707e-04, 7.153371723264961e-05, -1.905166722581262e-03, 1.621606027632741e-04, 7.013579190400697e-05, -4.282310712315612e-04, -1.612888001367656e-04,  4.150096329473301e-04, 3.790537697717624e-05, 5.178658107282444e-03, -3.735835027811972e-04, -2.127205598343199e-04, -5.132465489734188e-04, 6.118535383192730e-04, -1.271026584109383e-04, 1.948093095128074e-04, 4.902120387545729e-05,  4.246576498018312e-06, -2.145140493126468e-04, 1.970446596944229e-04, -4.277354843647830e-04, 1.546519175148047e-03, -1.001941508011550e-03, -1.528047848046527e-05, -3.257948403486112e-04, 6.712604672001958e-05, 2.252390969740802e-04,  2.318955498114586e-05, -1.451659564472418e-04, -1.671770194162380e-05, 6.679508919576114e-05, -1.331073412813981e-04, -1.013700086070915e-03, 1.144480056290168e-03, -3.644688292018282e-04, 5.762071553622904e-04, 5.263661428240261e-05,  1.114089928446462e-04, -3.066080550133644e-04, 1.648092217222844e-04, 2.489825344298775e-04, 1.725517063595117e-04, -4.789050081089006e-04, 5.761456192634876e-05, -2.882776269452312e-04, 2.059023608266282e-03, 1.134198567633223e-03, -3.815900118095770e-04, 1.220243092668998e-04, 3.351490217362025e-04, 6.694260196088959e-04, -6.310088876237818e-04,  3.302152042265877e-04, -2.357482979376019e-03, 1.008978086340237e-03, -2.623300754364735e-04, 9.800609229339906e-04, -2.017199168342025e-04, 1.512484319900870e-03, 1.948657130885959e-04, -3.263816632873636e-04, -1.876710424126318e-04, -6.094440725408066e-04, -6.988178736047602e-04, 1.955003155275355e-04, -1.006918680252447e-04, 2.048109559888231e-04,  1.283873558797523e-05, 1.842448243376050e-04, 1.109233120157048e-04, 1.661094934162121e-03, 6.900246883523053e-06,  1.092716020051863e-04, -4.995835043036843e-04, 5.538880409754928e-04, 1.178741273478393e-04, 2.946833954654779e-04,  2.551540832318120e-04, 1.481656722794105e-04, 1.945070348132514e-04, -3.179447549547889e-04, -9.577879470212521e-05,  5.960131717229563e-04, 2.020858798911859e-04, -1.229350366383180e-04, -1.929470095998157e-05, -5.449172062339723e-04,  2.980964254660017e-05, -1.177895594467622e-06, -3.517405244748219e-04, 6.048738718124709e-04, -2.976933659863217e-04,  8.127969896981526e-05, 1.629673347247751e-04, 2.700326502982476e-03, -7.960314189022715e-04, 1.019077087499250e-04, -5.320383666536876e-04, 2.076477555494614e-04, -2.571737511118098e-04, 3.591404315084460e-04, -3.377731099006169e-04, -5.680262683980595e-04, -3.687095750060447e-04, -1.079566083588221e-04, -6.361212902718725e-04, 1.191248638674678e-03,  1.570617590432885e-05, 6.129822734350053e-04, -3.739434256545228e-04, -6.506329048198758e-05, 2.195078557475933e-04,  2.788016871123098e-04, -7.556802147194096e-04, 5.708367948972680e-04, 7.626900275998802e-05, 1.005281480713061e-04, -9.498665314655149e-05, 1.470776368788819e-03, -9.637236946350188e-05, 4.309284871295625e-04, 1.361912152331541e-05,  3.704782341357967e-04, -2.048456470887964e-03, 4.101340694660939e-04, 3.486626200621090e-04, -8.451809409749555e-04, -3.561499553198489e-04, 1.012560859693439e-03, 4.296168375114119e-05, 6.203368742855044e-03, -9.062766450145751e-04, -5.224676070605326e-04, -1.026927828032633e-03, 6.869788152978485e-04, -2.426320909949998e-04, 2.492855493999072e-04,  1.843807214282920e-04, 1.381158536361024e-04, -4.549473935301411e-04, 2.556108616423336e-04, -5.615087977537790e-04,  2.092226180933710e-03, -1.151859097517245e-03, 3.229945496950349e-04, -3.503703329639530e-04, 2.325387146645599e-04,  2.736318415575513e-04, -3.855338869884852e-05, -2.260438451771044e-04, -6.137753835852770e-07, 4.454545769620104e-05, -1.588534015161444e-04, -1.301582223632874e-03, 1.387995621429343e-03, -4.882153124963784e-04, 6.335346827469960e-04, -8.958359082379100e-05, 4.857694776266283e-05, -2.711991387497932e-04, 2.125736161475045e-04, 2.101462501178331e-04,  1.087022606720953e-04, -5.866592507737570e-04, 2.467985604950475e-04, -3.067802082044473e-04, 2.665300420109046e-03 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$n_iter),
               c(10 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$Q),
               c( 0.0370208313167464317, 0.0346841385423950488, -0.0004929104651646699, -0.0208570993559084837,  0.0032854226598369911, 0.0392785234301780833,  0.0300048233899102915, -0.0156116662728580172, -0.0303768203372281297, -0.0311840099798412554, -0.0309083547817222033, 0.0346841385423950488,  0.5712629599319651863, -0.1689343403869119908,  0.1699914560982205836, 0.1983733317153642262,  0.4806196547051954648, 0.4963627829005280989, -0.1729705978254248155, 0.1411367918866995030,  0.0644336160955874954, -0.0831725461743011429, -0.0004929104651646699, -0.1689343403869119908,  0.2115075946595506851, 0.0109238356510654756, -0.1197455718749028120, -0.0231882545551327229, -0.2716547924480197662, 0.0656021077216151771, -0.2844790476474123864, -0.2181303346064001336, -0.0779258954046652963, -0.0208570993559084837,  0.1699914560982205836, 0.0109238356510654756,  0.4761910066070441649, 0.0408497056353600285,  0.1205033594638909439, 0.1023631766451162245,  0.0230600858440459036, 0.0907121797967034293,  0.0289888807148874356, 0.1265561127868692903,  0.0032854226598369911, 0.1983733317153642262, -0.1197455718749028120, 0.0408497056353600285,  0.5039644922472519273, 0.0663979994697856679,  0.5556907566025846013, -0.8218664668394478623,  0.8227520022976404501, 0.1403384208740941774,  0.4366440571840116691, 0.0392785234301780833,  0.4806196547051954648, -0.0231882545551327229,  0.1205033594638909439, 0.0663979994697856679,  0.6282414301609345886, 0.1833564834738904969,  0.0723787460160525697, -0.0429102951511652342,  0.0907191485538196285, -0.2506464386870880245,  0.0300048233899102915, 0.4963627829005280989, -0.2716547924480197662, 0.1023631766451162245,  0.5556907566025846013, 0.1833564834738904969,  0.8898900833008855926, -0.8828763382661020120,  0.7554264243913209054, 0.0672677678739100615,  0.3700242471030621427, -0.0156116662728580172, -0.1729705978254248155, 0.0656021077216151771,  0.0230600858440459036, -0.8218664668394478623,  0.0723787460160525697, -0.8828763382661020120,  1.5895097904477248907, -1.1563571198640349991,  0.1147555903935551791, -0.7513599854593675520, -0.0303768203372281297, 0.1411367918866995030, -0.2844790476474123864, 0.0907121797967034293,  0.8227520022976404501, -0.0429102951511652342,  0.7554264243913209054, -1.1563571198640349991,  1.7257267246945944272, 0.6473135706713051274,  0.8836806896751779883, -0.0311840099798412554,  0.0644336160955874954, -0.2181303346064001336,  0.0289888807148874356, 0.1403384208740941774,  0.0907191485538196285, 0.0672677678739100615,  0.1147555903935551791, 0.6473135706713051274,  0.6423093152893194491, 0.1696617683423707335, -0.0309083547817222033, -0.0831725461743011429, -0.0779258954046652963, 0.1265561127868692903,  0.4366440571840116691, -0.2506464386870880245,  0.3700242471030621427, -0.7513599854593675520,  0.8836806896751779883, 0.1696617683423707335,  0.6093938253081568890 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$Q_0),
               c(100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 100, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 100, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 100 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$n_risk),
               c(20188, 19718, 19208, 18895, 18093, 17286, 16014, 14766, 13487, 12518 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$times),
               c( 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$risk_set),
               c(NA )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$order),
               c(1 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$F_),
               c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$method),
               c("EKF" )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$model),
               c("exponential" )
               , tolerance = 1e-04)

  expect_equal(c(result_exp$est_Q_0),
               c(FALSE )
               , tolerance = 1e-04)
})


test_that("Unmacthed control variable throw error",
          expect_error({
            result = ddhazard(
              formula = survival::Surv(start, stop, event) ~ group,
              data = head_neck_cancer,
              by = 1, # Use by month intervals
              n_max = 10^4, eps = 10^-4,
              a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
              est_Q_0 = T,
              max_T = 45,
              id = head_neck_cancer$id, order_ = 1,
              control = list("None_existing_parem" = 1)
            )}, regexp = "These control parameters are not recognized"))



test_that("Decreasing learning rate in NR can get method to convergece",{
  set.seed(28650)
  sims <- test_sim_func_exp(n_series = 1e4, n_vars = 10, t_0 = 0, t_max = 10,
                            x_range = 1, x_mean = 0, re_draw = T, beta_start = 0,
                            intercept_start = -5, sds = c(.1, rep(1, 10)))
  arg_list <- list(
    formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
    data = sims$res,
    by = (by_ <- 1),
    n_max = 10^4, eps = 10^-2,
    a_0 = rep(0, 11),
    Q_0 = diag(100, 11),
    Q = diag(1e-3, 11),
    est_Q_0 = F,
    max_T = 10,
    id = sims$res$id, order_ = 1,
    model = "exponential")

  expect_error(do.call(ddhazard, arg_list))

  arg_list$control <- list(LR = .75)

  result_exp <- do.call(ddhazard, arg_list)
  expect_equal(mean((result_exp$a_t_d_s - sims$betas)^2), 0.7661225948671551, tolerance  = 1e-6)

  arg_list$control <- c(arg_list$control, list(NR_eps = 1e-2))
  result_exp <- do.call(ddhazard, arg_list)
  expect_equal(mean((result_exp$a_t_d_s - sims$betas)^2), 0.4086950124175361)
})

# for(i in 1:100){
#   n_vars <- 10
#   sims <- test_sim_func_exp(n_series = 1e4, n_vars = n_vars, t_0 = 0, t_max = 10,
#                             x_range = 1, x_mean = 0, re_draw = T, beta_start = 0,
#                             intercept_start = -5, sds = c(.1, rep(1, n_vars)))
#
#   tmp_file <- file("exponential.log")
#   sink(tmp_file)
#   result_exp = ddhazard(
#     formula = survival::Surv(tstart, tstop, event) ~ . - id - tstart - tstop - event,
#     data = sims$res,
#     by = (by_ <- 1),
#     n_max = 10^4, eps = 10^-2,
#     a_0 = rep(0, n_vars + 1),
#     Q_0 = diag(1e4, n_vars + 1),
#     Q = diag(1, n_vars + 1),
#     est_Q_0 = F,
#     max_T = 10,
#     id = sims$res$id, order_ = 1,
#     verbose = F,
#     model = "exponential"
#   )
#   sink()
#   close(tmp_file)
#
#   print(sum(sims$res$event))
#   matplot(seq_len(nrow(sims$betas)) - 1, sims$betas, type = "l", lty = 1)
#   matplot(result_exp$times, result_exp$a_t_d_s, result_exp$a_t_d_s, type = "l", lty = 2, add = T)
# }
