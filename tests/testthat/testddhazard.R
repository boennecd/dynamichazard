library(survival)

test_that("The head_neck_cancer must be defined for the ddhazard tests",
          expect_true(exists("head_neck_cancer")))

# Test on data set that is one of Farhmiers papers
result = ddhazard(
  formula = Surv(start, stop, event) ~ group,
  data = head_neck_cancer,
  by = 1, # Use by month intervals
  n_max = 10^4, eps = 10^-4,
  a_0 = rep(0, 2), Q_0 = diag(1, 2), # Initial value
  est_Q_0 = T,
  max_T = 45
)

# # hint use this regexp '\r\n\s*\[\d+\]\s' and replace with '\r\n,' followed by
# # as search for '(?<=\d)\s+(?=\d)' and replace with ','
# # or be lazy and use this function
# str_func <- function(x){
#   tmp <- capture.output(print(c(x), digits = 16))
#   tmp <- sapply(tmp, gsub, pattern = "\\s*\\[1\\]\\s", replacement = "", USE.NAMES = F)
#   tmp <- sapply(tmp, gsub, pattern = "\\s*\\[\\d+\\]\\s", replacement = "\\\n,\\ ", USE.NAMES = F)
#   tmp <- sapply(tmp, gsub, pattern = "(?<=\\d)\\s+(?=\\d|-)", replacement = ",\\ ", perl = T, USE.NAMES = F)
#   cat(paste0(c("c(", tmp, ")"), collapse = ""))
# }

test_that("Testing previous computed values vs. current on head and neck cancer set assuming that the previous is correct", {
  expect_equal(c(result$a_t_d_s),
               c(-3.5084644693000375, -3.5148844600373153, -3.1891314791814929
                 , -2.8181185126716946, -2.5133150253138181, -2.0686431883814391
                 , -2.1337664829927272, -2.5088816216986980, -2.7261252524003838
                 , -2.8656346839715456, -3.0022690651419150, -3.2103909019454631
                 , -3.3296886621454438, -3.3797024676574670, -3.2387762301797576
                 , -3.2832268974011902, -3.4010378429506498, -3.4996364628495664
                 , -3.4640927580381167, -3.5454306632739097, -3.5193437650355053
                 , -3.6429455602328522, -3.8148529400485618, -3.9315760725295390
                 , -3.9912270162929087, -4.1221212755199144, -4.2111505273306804
                 , -4.2593181086540230, -4.3955501412991156, -4.5056360495292482
                 , -4.5891834181979796, -4.6463491829253352, -4.6772452961075963
                 , -4.6818100380470060, -4.6597979866888570, -4.6108005184078964
                 , -4.5342715329240795, -4.4295511232451679, -4.4288880723551687
                 , -4.5320293776581728, -4.6212298063525905, -4.6940739120459574
                 , -4.7499759978712248, -4.7915369057959181, -4.8188789577153992
                 , -4.8320508432930724, 0.4360755600018228, 0.4376620032308990
                 ,  0.4489331535887380, 0.4629877155198045, 0.4717967889720516
                 ,  0.4892432325019014, 0.4906015100905337, 0.4811672226212869
                 ,  0.4812410655726153, 0.4807008058089728, 0.4795022646846021
                 ,  0.4752694673136330, 0.4750540102025831, 0.4782488768524199
                 ,  0.4871715112202827, 0.4868843094919623, 0.4843562325887174
                 ,  0.4835935130835331, 0.4867226287750569, 0.4863614783282632
                 ,  0.4891031221907462, 0.4848002061937289, 0.4802281967614200
                 ,  0.4772168219924643, 0.4758176353352087, 0.4735558899381061
                 ,  0.4724962572592801, 0.4726240459881104, 0.4714467634180154
                 ,  0.4710489177360688, 0.4714390992094060, 0.4726106938155138
                 ,  0.4745588596923577, 0.4772841101671843, 0.4807925107278950
                 ,  0.4850950220887917, 0.4902067111479924, 0.4961460340659207
                 ,  0.4977474633246664, 0.4949782740709857, 0.4925889375015259
                 ,  0.4906451477362695, 0.4891628332671372, 0.4880589755764653
                 ,  0.4873303205106824, 0.4869755787235325))

  expect_equal(c(result$V_t_d_s),
               c( 0.0011007577913296656, -0.0001733451115550633, -0.0001733451115550633
                  ,  0.0004392322044566420, 0.0682991240249047060, 0.0003834452042018443
                  ,  0.0003834452042018442, 0.0029230271218272539, 0.0912395007549733350
                  , -0.0003397914632747466, -0.0003397914632747466, 0.0052119615712443315
                  ,  0.0932049749695377378, -0.0016092541197089715, -0.0016092541197089711
                  ,  0.0073429567284740965, 0.0849686813506122934, -0.0030571106681653009
                  , -0.0030571106681653005, 0.0093460739808944281, 0.0774928836229536178
                  , -0.0044064881508436658, -0.0044064881508436658, 0.0112576788942480542
                  ,  0.0625786071371585012, -0.0058040178177705924, -0.0058040178177705924
                  ,  0.0131038581718835520, 0.0663037854506360463, -0.0066152078662832037
                  , -0.0066152078662832037, 0.0149859903532218054, 0.0802636516361565355
                  , -0.0072606054091964422, -0.0072606054091964422, 0.0169064138433351260
                  ,  0.0925945303565963995, -0.0077694160284284882, -0.0077694160284284891
                  ,  0.0188521666403896025, 0.1028653949187706279, -0.0082893243691400179
                  , -0.0082893243691400196, 0.0208108298970566402, 0.1134521022635953669
                  , -0.0087341231657698665, -0.0087341231657698665, 0.0227878464846351519
                  ,  0.1282127482321499812, -0.0091281359070864241, -0.0091281359070864224
                  ,  0.0247818173504978020, 0.1412262999503804406, -0.0096021138204995977
                  , -0.0096021138204995960, 0.0267801536095240260, 0.1518039844431364749
                  , -0.0100679733114127437, -0.0100679733114127437, 0.0287860644548110257
                  ,  0.1503781552817381462, -0.0107654864975719258, -0.0107654864975719258
                  ,  0.0307850681462566306, 0.1529892913432942814, -0.0114268209514253039
                  , -0.0114268209514253039, 0.0328022104304094425, 0.1623989951758836869
                  , -0.0119988254560485837, -0.0119988254560485837, 0.0348470071785677502
                  ,  0.1751405465177472420, -0.0124767948762201323, -0.0124767948762201323
                  ,  0.0369196593146410082, 0.1826262222670714253, -0.0130763410888457762
                  , -0.0130763410888457762, 0.0390042849193854013, 0.1921213871302026865
                  , -0.0136031573461606395, -0.0136031573461606395, 0.0411148217076838310
                  ,  0.1952137792451406062, -0.0142700820537257390, -0.0142700820537257390
                  ,  0.0432374522277687856, 0.2045009115946196943, -0.0150037228119862687
                  , -0.0150037228119862670, 0.0453817496599724785, 0.2197992615605408318
                  , -0.0156403530269492337, -0.0156403530269492302, 0.0475580384562985375
                  ,  0.2351742387248771660, -0.0163387197002041323, -0.0163387197002041323
                  ,  0.0497535112080704153, 0.2471786691448959739, -0.0171983898818672161
                  , -0.0171983898818672196, 0.0519599789846230259, 0.2633406508519972045
                  , -0.0179758501250396573, -0.0179758501250396607, 0.0541928396098181331
                  ,  0.2783570585162779554, -0.0187578421049752302, -0.0187578421049752336
                  ,  0.0564447233177911220, 0.2898617445280329274, -0.0196256986326030711
                  , -0.0196256986326030711, 0.0587095922537396175, 0.3070089074201384216
                  , -0.0202566671302706752, -0.0202566671302706752, 0.0610078966170546910
                  ,  0.3265517822464923947, -0.0207566923998554545, -0.0207566923998554545
                  ,  0.0633316746524540397, 0.3468613597848555496, -0.0211777326575118136
                  , -0.0211777326575118136, 0.0656762424587988280, 0.3669330349624608245
                  , -0.0215496836790728778, -0.0215496836790728778, 0.0680384930107222063
                  ,  0.3859999570458617635, -0.0218930814893318545, -0.0218930814893318545
                  ,  0.0704161786213701735, 0.4033580584084034970, -0.0222249753911356145
                  , -0.0222249753911356145, 0.0728075543038044365, 0.4182756228156945255
                  , -0.0225620115551172298, -0.0225620115551172298, 0.0752111771525787870
                  ,  0.4299395711487184468, -0.0229222709068044872, -0.0229222709068044872
                  ,  0.0776257813361121429, 0.4374185315654753881, -0.0233265169857653290
                  , -0.0233265169857653290, 0.0800501930267311507, 0.4389396398028437285
                  , -0.0237873509608388274, -0.0237873509608388274, 0.0824839842388029043
                  ,  0.4444370473634537966, -0.0241089985969926528, -0.0241089985969926528
                  ,  0.0849399776770060483, 0.4705099679725334716, -0.0239711015900734327
                  , -0.0239711015900734327, 0.0874386019174675511, 0.5127677482774826156
                  , -0.0234537793009185619, -0.0234537793009185619, 0.0899729190136854540
                  ,  0.5710035270105234817, -0.0225390051857156867, -0.0225390051857156867
                  ,  0.0925406272428825755, 0.6422966612793774566, -0.0213827332568293886
                  , -0.0213827332568293886, 0.0951287192064125264, 0.7296350793987446126
                  , -0.0198916154467032036, -0.0198916154467032036, 0.0977389611802057523
                  ,  0.8366982297826955906, -0.0179580979280018482, -0.0179580979280018482
                  ,  0.1003735699436583140))
})

test_that("Testing names of output from ddhazard on head and neck cancer dataset", {
  expect_equal(colnames(result$a_t_d_s), c("(Intercept)", "group1"))
  expect_equal(unlist(dimnames(result$V_t_d_s)), unlist(list(c("(Intercept)", "group1"), c("(Intercept)", "group1"), NULL)))
  expect_equal(unlist(dimnames(result$Q)), rep(c("(Intercept)", "group1"), 2))
  expect_equal(unlist(dimnames(result$Q_0)), rep(c("(Intercept)", "group1"), 2))
})
