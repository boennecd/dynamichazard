test_that("The head_neck_cancer must be defined for the gen_kalman_filter tests",
          expect_true(exists("head_neck_cancer")))

# Find the risk sets and design matrix for head and neck cancer set
design_mat = get_design_matrix(survival::Surv(start, stop, event) ~ group, head_neck_cancer)
rist_set= get_risk_obj(design_mat$Y, by = 1, max_T = 40, id = head_neck_cancer$id)

design_mat$Y[, 2] <- rist_set$stop_new
design_mat$Y[, 3] <- rist_set$new_events_flags

# Test for head and neck data set
res <- gen_kalman_filter_cpp(a_0 = rep(0, ncol(design_mat$X)),
                              Q_0 = diag(10, ncol(design_mat$X)), # something large
                              Q = diag(1, ncol(design_mat$X)), # something large
                              F_= diag(1, ncol(design_mat$X)), # first order random walk
                              risk_sets = rist_set$risk_sets,
                              I_len = rist_set$I_len,
                              d = rist_set$d,
                              X = design_mat$X,
                              start = design_mat$Y[, 1],
                              stop = design_mat$Y[, 2],
                              events = design_mat$Y[, 3],
                              order_ = 1)

# get_expect_equal(res)

test_that("Testing kalman filter function versus previous computed values", {
  expect_equal(c(res$V_t_d_s),
               c( 0.97346361844735618, -0.06072289894519619, -0.06072289894519619, 1.02703236076265192, 0.07789097832130269, -0.07347470772368737, -0.07347470772368737, 0.14270915652281119, 0.13434934030663057, -0.10845758643020723, -0.10845758643020723, 0.22774815620625397,  0.19778192635939501, -0.14094799844812117, -0.14094799844812117, 0.32862559772258637, 0.23624150030073207, -0.18099197820977780, -0.18099197820977778, 0.33496707829062955, 0.19858857800616903, -0.13711299224853749, -0.13711299224853749, 0.34372967680227828,  0.14887039156169651, -0.12719122272878985, -0.12719122272878985, 0.23157332855740892, 0.18366195764707374, -0.14612651978259755, -0.14612651978259755, 0.28755858242148619, 0.23780729476941834, -0.15884127384843549, -0.15884127384843549, 0.41173793435498651,  0.31745175613040583, -0.22081791076757967, -0.22081791076757967, 0.46638195787379899, 0.36093754503493614, -0.24796698280815488, -0.24796698280815488, 0.52350502667222520, 0.38701528071142366, -0.26706477926791117, -0.26706477926791117, 0.57705378052639911,  0.44805933285754368, -0.24966727446120118, -0.24966727446120118, 0.73158747504624611, 0.49380712188979037, -0.23056516917691508, -0.23056516917691508, 0.85417362654650397, 0.58079155024924844, -0.23045137725643594, -0.23045137725643597, 0.87425873463124282,  0.40736913548867670, -0.33577275633462028, -0.33577275633462028, 0.54628993502415701, 0.46651433589932523, -0.33836673648327448, -0.33836673648327448, 0.62210862340767759, 0.52104557640284943, -0.32498450976662618, -0.32498450976662618, 0.75592473355761791,  0.62604093950003259, -0.32061704011834019, -0.32061704011834019, 0.88778950544878410, 0.54943564769511011, -0.35162738922600367, -0.35162738922600367, 0.83757239537973915, 0.65764566299126104, -0.35274850428569410, -0.35274850428569404, 0.92339174536597546,  0.60365469351533307, -0.44956958193906632, -0.44956958193906632, 0.79417575330118328, 0.63796656267473240, -0.42405825488074311, -0.42405825488074311, 0.91440875004974564, 0.76957233693166804, -0.42662052805199668, -0.42662052805199663, 1.10923306322496562,  0.85371950197783741, -0.41303404396443150, -0.41303404396443144, 1.29233874242611213, 0.76182860229305382, -0.39037915713895205, -0.39037915713895205, 1.40315749047790206, 0.87445798914999828, -0.37590664757359915, -0.37590664757359915, 1.60488261913114183,  0.91985297415486311, -0.35935675995783145, -0.35935675995783145, 1.78653729781446025, 0.77022878225555491, -0.35067150390061430, -0.35067150390061436, 1.89912355107315101, 0.90474883512557724, -0.35111933325025790, -0.35111933325025796, 2.15883271998436177,  1.07510756212456426, -0.36301353350761784, -0.36301353350761784, 2.44881157165497276, 1.25069623296781085, -0.37982500045663764, -0.37982500045663770, 2.73282259956383733, 1.41933069669130840, -0.39966713807226051, -0.39966713807226056, 2.98866293263210592,  1.56887920499179101, -0.42394179057305642, -0.42394179057305642, 3.19907263295683952, 1.68259360967104898, -0.45678299503413089, -0.45678299503413089, 3.34884355547015211, 1.73635783303003510, -0.50506799030704419, -0.50506799030704430, 3.42356960331706350,  1.69612727295226273, -0.57869923472583429, -0.57869923472583440, 3.40899964744204098, 1.51520038466141571, -0.69102940231226206, -0.69102940231226206, 3.29065000752065373, 1.12208609496995071, -0.85697261235865363, -0.85697261235865363, 3.05353961291215681,  1.70481951075938576, -0.76793417771926253, -0.76793417771926253, 4.00503901760080083, 2.40627247077874262, -0.73571132835094899, -0.73571132835094899, 4.97403524314625312 ))

  expect_equal(c(res$a_t_d_s),
               c(-1.85143878855898403, -2.03658266741488214, -2.68959452622216455, -2.81159065921333617, -2.44338335614783242, -1.72464244763052066, -1.94398613318688418, -2.44420464450582653, -2.91759045912771997, -3.03967779523668336, -3.07963366238006842, -3.40062729157229127, -3.63811121556605155, -3.80560569598474885, -2.88661479286054279, -3.21262888276415781, -3.49961772820207573, -3.83728340486530994, -3.42997494011458848, -3.73993519040233968, -3.25121074786346931, -3.32897515304560088, -3.73168315864924116, -3.83391570853147723, -3.56681047936660445, -3.84823236369903388, -3.88814645515801782, -3.63136277846087641, -4.03145147541248861, -4.40775192196352172, -4.69492030011156469, -4.89697613074029725, -5.01708084411184174, -5.05539507338711314, -5.00980154817717604, -4.87658887025855936, -4.65092564178528800, -4.32717846193244604, -4.90692711186529174, -5.03519796535820774, -5.09832104932785413, 0.10054303301288930,  0.11059733631417823, 0.06433866808149816, 0.48476158930656210, 0.00203820126507720, 0.81938092105743121, 0.66015000045961103,  0.17278590130455662, 0.75113160252026479, 0.76803954461101331, 0.73958495005309710, 0.37622496918608528, 0.40085810684641054,  0.97706860844044452, 2.25837135871389671, 1.47439930117309315, 0.95120047457385626, 0.80031528484914183, 1.05180796435648904,  1.05350141990114521, 1.57695049532495735, 0.99884490399989656, 0.55127069249371041, 0.11325123486386135, -0.25050997562722926, -0.47251061773427588, -0.67904003731557994, -0.82945908071295660, -0.89993754872920950, -0.96786505648777954, -1.02083768518109852, -1.05953476353358811, -1.08428605526606958, -1.09488490133801331, -1.09077151509841741, -1.07116367925340605, -1.03513782279305788, -0.98167950767893242, -1.90971556405120801, -1.91699265507872152, -1.92052701078550148 ))

  expect_equal(c(res$B_s),
               c( 0.90909090909090917, 0.00000000000000000, 0.00000000000000000, 0.90909090909090917, 0.07492974287991278, -0.06902395033765363, -0.06902395033765360, 0.13583322847196000, 0.12496927100532369, -0.09478183287024161, -0.09478183287024158, 0.20644892874968682,  0.17857417348988991, -0.11365937133696852, -0.11365937133696846, 0.28633085437868067, 0.21119663581018136, -0.14854084322277011, -0.14854084322277011, 0.28989104402275673, 0.18487693018029300, -0.11651419789107970, -0.11651419789107967, 0.31022700677553128,  0.13734372195002620, -0.11161205789270696, -0.11161205789270696, 0.20978678270416062, 0.16493718611049621, -0.12025542102108380, -0.12025542102108377, 0.24906341420706637, 0.20746972836660454, -0.11484092751472641, -0.11484092751472644, 0.33736095626488943,  0.26168664868142655, -0.14931016078489767, -0.14931016078489773, 0.36263838351421823, 0.28971790113272738, -0.15764193123988438, -0.15764193123988429, 0.39213538830811590, 0.30296425069247601, -0.15997751470290575, -0.15997751470290578, 0.40991372833761275,  0.35166829734234073, -0.12949101227690596, -0.12949101227690585, 0.48945224488459493, 0.38123097391079441, -0.10521507816770934, -0.10521507816770945, 0.55328318788304531, 0.46284727259791075, -0.08576134511766700, -0.08576134511766700, 0.62320211130097547,  0.29817686102387470, -0.20544724164955205, -0.20544724164955208, 0.38243839924460243, 0.33867233135173519, -0.18795525647317915, -0.18795525647317912, 0.41945756716688148, 0.37440075398113781, -0.15567386443909453, -0.15567386443909462, 0.48423910145246418,  0.45581868419243721, -0.13044236600972892, -0.13044236600972886, 0.56216913151565018, 0.38581200735266463, -0.15742326649981567, -0.15742326649981558, 0.51702093008907413, 0.46186792294573287, -0.12935050090680372, -0.12935050090680386, 0.57934932921648286,  0.39474726375678959, -0.20841699191938096, -0.20841699191938068, 0.47558095199509343, 0.41439278280533798, -0.16898139916618202, -0.16898139916618204, 0.51892128711374652, 0.48669181731340128, -0.13874767110689237, -0.13874767110689243, 0.58442030049367544,  0.55244718195174003, -0.11580033179975033, -0.11580033179975030, 0.64329489763356462, 0.49214520394103728, -0.10688671391836527, -0.10688671391836535, 0.65405608992030217, 0.54951050708526217, -0.08601267436898113, -0.08601267436898119, 0.69420178013959055,  0.60146741804629567, -0.07131999483934290, -0.07131999483934288, 0.73106205892889320, 0.50348736126777704, -0.07310929536140465, -0.07310929536140469, 0.72436119460048798, 0.54898364020099777, -0.05857123354753799, -0.05857123354753806, 0.74910783566844386,  0.59867540528976948, -0.04805753996963791, -0.04805753996963792, 0.77523300228788905, 0.64127510277333066, -0.04060894957934297, -0.04060894957934298, 0.79858343311882785, 0.67673942500346607, -0.03510040074758286, -0.03510040074758289, 0.81860797430464682,  0.70632844307401499, -0.03086296396252575, -0.03086296396252580, 0.83560840655362689, 0.73123983523179570, -0.02750100997744054, -0.02750100997744054, 0.85005673216682043, 0.75243072433532021, -0.02476847262537449, -0.02476847262537449, 0.86240268191339164,  0.77063874490673312, -0.02250430771783168, -0.02250430771783166, 0.87302659072507927, 0.78844720315140415, -0.02065129013057632, -0.02065129013057630, 0.88223840409591581, 0.51894345923808471, -0.11465391427382410, -0.11465391427382413, 0.73543566515163872,  0.64105987414032151, -0.06024689425857133, -0.06024689425857133, 0.79356674514577263 ))

  expect_equal(c(res$lag_one_cor),
               c( 0.07080998029209336, -0.06679518883971580, -0.06679518883971580, 0.12973559683891928, 0.01755293258476213, -0.02384677648806399, -0.02400546631031308, 0.03842193839553213, 0.03807597278746710, -0.04876190509594662, -0.04784469677797774, 0.08120371224185838,  0.06275806512057244, -0.07039264045420528, -0.07867464816437668, 0.11648284417604403, 0.06230811907062558, -0.08001569872165926, -0.06924634330345990, 0.12001103435521208, 0.04234228428169526, -0.05049630343381053, -0.05680366657781443, 0.08665988386244224,  0.04153429842951226, -0.05216456525131774, -0.05115430150254011, 0.07663547143080787, 0.05832479029798607, -0.07571255139297794, -0.06815916633607233, 0.12165037995118680, 0.09122056329828984, -0.09937276858379203, -0.11095179565216025, 0.18269799697740918,  0.13147652661592546, -0.14305426841884306, -0.14381398869291978, 0.22686700670641496, 0.15422586240395386, -0.16834131970743221, -0.16573538719233838, 0.26838381587133275, 0.17568711011590771, -0.19267780477524318, -0.17402146182827294, 0.33982889957225831,  0.20351242692301905, -0.19169026803263700, -0.17679422372889197, 0.44793331618691690, 0.24566268801257332, -0.17984040409358393, -0.18861290101909903, 0.50795961940326362, 0.21734601653862651, -0.20226206413407649, -0.24419081568401341, 0.36924536412665104,  0.20862029297754789, -0.22870363204498270, -0.22524851655877265, 0.30743473876874505, 0.23754626698385833, -0.25214328874610570, -0.23425046678064368, 0.37816089658234808, 0.28430189341211831, -0.25824488468119217, -0.25271351976630518, 0.47981408603769304,  0.29631014258526833, -0.26953325884078821, -0.26934374987373599, 0.51672445469657458, 0.30925841516301050, -0.28145795334359147, -0.28590708824084060, 0.53294368082326848, 0.33696079008665053, -0.31036880052732435, -0.33854087271348415, 0.51825724057131606,  0.34021650086500155, -0.35797415685778150, -0.33463710049537676, 0.52325632974212821, 0.39099615601436288, -0.36422822284649448, -0.35142588378019002, 0.64769558262106486, 0.47280580758141244, -0.38032928026218571, -0.35983707276577204, 0.81257650787621394,  0.46607610039142799, -0.37814996821875568, -0.33934892485005519, 0.94785009012514942, 0.47053973170730634, -0.35654128311652789, -0.33933197300694218, 1.08986267694917949, 0.53637811024827053, -0.35113516623389956, -0.32858511680124319, 1.27112660840511738,  0.48827740681668741, -0.34636296589532573, -0.31129534442485407, 1.41338706325638541, 0.48119969064916457, -0.33461488554947516, -0.32048276949556642, 1.58944473503218653, 0.61147861351475541, -0.34271840554455624, -0.33490665851416801, 1.85568608685429015,  0.76701452930730463, -0.35872461739603362, -0.35455825965372423, 2.13682772372098118, 0.92641150104855829, -0.37766304738332057, -0.37680508392487355, 2.40292676783482939, 1.07660293782880156, -0.39918685502476048, -0.40211041922385571, 2.63366689446099533,  1.20256140175967197, -0.42599405967375559, -0.43362153656011720, 2.81241950429823140, 1.28358389556904040, -0.46347745583226202, -0.47708803945303541, 2.92411826918208195, 1.29055176870599486, -0.51986679880463482, -0.54108225397805620, 2.95426393474945703,  1.18322326102937714, -0.60658783165250163, -0.63738557890206082, 2.88837609564691844, 0.90240323332591510, -0.73873719186298969, -0.77922667537991641, 2.71164750499105889, 0.97275159367021891, -0.85770781884011138, -0.76023041282259207, 3.03349519324767547,  1.58688904986873425, -0.77130518688850758, -0.72880648731065345, 3.99155328074792770 ))
})
