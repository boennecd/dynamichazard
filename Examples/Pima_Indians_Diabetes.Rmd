---
title: "Pima Indians Diabetes"
author: "Benjamin Christoffersen"
date: "7 January 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We will use the Pima Indians Diabetes dataset from https://archive.ics.uci.edu/ml/machine-learning-databases/pima-indians-diabetes/. The outcome in the data set is whether or not the female is having diabetes. The script and results are given below with comments. The data cleaning is included for completeness

```{r}
# We download the data
diabetes <-
  read.table("https://archive.ics.uci.edu/ml/machine-learning-databases/pima-indians-diabetes/pima-indians-diabetes.data",
             sep = ",")
colnames(diabetes) <-
  c("times_pregnant", "glucose_cocen", "blood_pres", "skin_fold",
    "insulin", "BMI", "diabetes_pedigree", "age", "has_diabetes")

head(diabetes)
nrow(diabetes) # Number of samples before cleaning

# Remove observations with invalid values
diabetes <- diabetes[diabetes$BMI > 0, ]
diabetes <- diabetes[diabetes$blood_pres > 0, ]
diabetes <- diabetes[diabetes$skin_fold > 0, ]

nrow(diabetes) # Number of samples after cleaning

# We load the two libraries we will need
library(survival); library(dynamichazard)
min(diabetes$age)                             # Youngest person in study
max(diabetes$age)                             # Oldest person in study
max(diabetes$age[diabetes$has_diabetes == 1]) # Last person with diabetes

# Notice that we have few cases and controls in the end as illustrated below
diabetes$t <- diabetes$age - min(diabetes$age) + 1 # Time scale in study
xtabs(~ has_diabetes + t, diabetes)

# Thus, we set the last time (max_T) slighly lower later
# Fit the model
fit <- ddhazard(
  Surv(t, has_diabetes) ~
    ddFixed_intercept() +                # These effects are time invariant
    ddFixed(diabetes_pedigree) +
    ddFixed(times_pregnant) +
    glucose_cocen + blood_pres +         # The rest are time-varying
    skin_fold + BMI,
  data = diabetes,
  by = 1,                                # time interval lengths
  max_T = 42,                            # last period observed while estimating 
  Q_0 = diag(1e5, 4), Q = diag(1e-4, 4), # Covariances mats for state equation
  control = list(eps = 0.1))

# Plot the effects estimates with 95% point-wise confidence bounds
plot(fit)

# Print time-invariant estimates
fit$fixed_effects

# Bootstrap the estimates
boot_out <- ddhazard_boot(fit, R = 1000) # R is number of bootstrap samples

# Plot bootstrapped estimates (transparent lines) and 2.5% and 97.5% quantiles
# (dashed-lines)
plot(fit, ddhazard_boot = boot_out)

# Make boxplot for the bootstrap estimate of the fixed effect
boxplot(t(tail(t(boot_out$t), 3)))
```

The above is only correct if those who are diagnosed with diabetes did not have the disease shortly prior to diagnosis. This is the case since a person who gets diagnosed at say $t = 40$ is modeled as not having diabetes at $t = 0,1,...,39$ with the same covariates. This further stress that all other covariates are kept fixed such as `BMI` which could change through time. This is particularly an issue with `time_pregant`. It is hard of someone aged 21 ($t=1$) to have been pregant say 11 times
